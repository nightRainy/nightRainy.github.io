

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fox.jpg">
  <link rel="icon" href="/img/fox.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="知世">
  <meta name="keywords" content="">
  
    <meta name="description" content="搬运自Angel Boy师傅的分享  多图预警 content introduction file stream overwrite the file struction   Exploiation of FILE struction FSOP Vtable verfication in FILE  struction Make file struction great again   conc">
<meta property="og:type" content="article">
<meta property="og:title" content="play withe file structure(搬运)">
<meta property="og:url" content="https://nightrainy.github.io/2019/08/07/play-withe-file-structure-%E6%90%AC%E8%BF%90/index.html">
<meta property="og:site_name" content="知世の小屋">
<meta property="og:description" content="搬运自Angel Boy师傅的分享  多图预警 content introduction file stream overwrite the file struction   Exploiation of FILE struction FSOP Vtable verfication in FILE  struction Make file struction great again   conc">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2019/08/07/Wgu1PQtryD5Lhp7.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/E6IPFGurM1w98aD.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/xjKJEV9PaF84Qui.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/4sy1F2oGAUxW6ZD.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/O75gzbIBTGLK8Yl.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/32ZeYbLCdlJzjax.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/bk1qERm2nGzaFNI.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/tU6yW5QRbPdKsNn.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/t1KYJGDBiyMOQhf.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/UyCLlYm2tPbQjpg.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/yxjl74P2MNkhSVD.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/u5Iy7XortxjRhYK.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/AvKskPraWXNJ3Cw.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/RBt8D1ZYbwxeJCE.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/53khYwPgHvEsZWx.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/1D9xyrliMAhOSj8.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/kMBhoFKVpRijl92.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/UiAoXSF6rMnHfuN.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/9uls5ZRUtEHnVAX.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/7oUra8bXzAjHLOi.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/ujZDyNGsdBk6PIn.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/pEnGT8V2ifCBzON.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/ZtecGMz2EKBkLQa.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/lGe673jmzYFWO8w.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/kKSwbXWsZFyI165.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/JVNY5PLUwKTjHRZ.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/FV1G5i4pWrcIPk8.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/lUTnZMRCksQ8VGh.png">
<meta property="og:image" content="https://i.loli.net/2019/08/07/9c6X5mUiuENepBD.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/8ok7EwOfJN245lg.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/nXIPZNF4MzR6uGl.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/kdny7QpgD4P6xXI.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/93OQdt7aJiBPIjp.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/sUuC5cmb4ISfGwy.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/kGxe5zBsM1WrtZD.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/YbSMlH3whjtdUfn.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/VjUcAIbMvC7rhi1.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/YRzkZwgjHDcNnGq.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/2DnsHeMBrxUyK8i.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/aqiNzluRvOKrIfg.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/wbptVNGjaOqIQxY.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/82D6kyg7JljaYHV.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/84nHBUZ63qbIwO2.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/pcnE3VIjNQTJP6b.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/EDWH5YKoTS81jXy.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/YbDm4TfQgrLP7Be.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/jJownXfGrQuUYI2.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/zwK1u2Q6VGosIl7.png">
<meta property="og:image" content="https://i.loli.net/2019/08/09/PhzIgQN6ERDcoGq.png">
<meta property="og:image" content="https://puui.qpic.cn/fans_admin/0/3_155518641_1565412684323/0">
<meta property="og:image" content="https://puui.qpic.cn/fans_admin/0/3_1565779192_1565412774359/0">
<meta property="og:image" content="https://puui.qpic.cn/fans_admin/0/3_1757851795_1565413454773/0">
<meta property="og:image" content="https://puui.qpic.cn/fans_admin/0/3_1757851795_1565413538597/0">
<meta property="og:image" content="https://puui.qpic.cn/fans_admin/0/3_1565779192_1565413567143/0">
<meta property="og:image" content="https://puui.qpic.cn/fans_admin/0/3_155518641_1565413709350/0">
<meta property="og:image" content="https://puui.qpic.cn/fans_admin/0/3_1757851795_1565413798496/0">
<meta property="article:published_time" content="2019-08-07T06:01:32.000Z">
<meta property="article:modified_time" content="2019-08-10T05:14:56.000Z">
<meta property="article:author" content="知世">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://i.loli.net/2019/08/07/Wgu1PQtryD5Lhp7.png">
  
  
  
  <title>play withe file structure(搬运) - 知世の小屋</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"nightrainy.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>知世</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/rick.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="play withe file structure(搬运)"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2019-08-07 14:01" pubdate>
          2019年8月7日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          170 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          2 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">play withe file structure(搬运)</h1>
            
            
              <div class="markdown-body">
                
                <blockquote>
<p>搬运自<a target="_blank" rel="noopener" href="https://www.slideshare.net/AngelBoy1/play-with-file-structure-yet-another-binary-exploit-technique">Angel Boy师傅的分享</a></p>
</blockquote>
<p><strong>多图预警</strong></p>
<h1 id="content"><a href="#content" class="headerlink" title="content"></a>content</h1><ul>
<li>introduction<ul>
<li>file stream</li>
<li>overwrite the file struction</li>
</ul>
</li>
<li>Exploiation of FILE struction<ul>
<li>FSOP</li>
<li>Vtable verfication in FILE  struction</li>
<li>Make file struction great again</li>
</ul>
</li>
<li>conclusion</li>
</ul>
<h1 id="introduction"><a href="#introduction" class="headerlink" title="introduction"></a>introduction</h1><h2 id="what-happen-when-we-use-a-raw-io-function"><a href="#what-happen-when-we-use-a-raw-io-function" class="headerlink" title="what happen when we use a raw io function"></a>what happen when we use a raw io function</h2><p><img src="https://i.loli.net/2019/08/07/Wgu1PQtryD5Lhp7.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2019/08/07/E6IPFGurM1w98aD.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="what-is-file-stream"><a href="#what-is-file-stream" class="headerlink" title="what is file stream?"></a>what is file stream?</h2><ul>
<li>A higher-level interface on the primitive file descriptor facilites</li>
<li>Stream buffering</li>
<li>Portable and High performance</li>
</ul>
<h2 id="what-is-FILE-structure"><a href="#what-is-FILE-structure" class="headerlink" title="what is FILE structure"></a>what is FILE structure</h2><ul>
<li>A file stream descripor</li>
<li>Created by fopen</li>
</ul>
<h2 id="what-happen-when-we-use-stdio-function"><a href="#what-happen-when-we-use-stdio-function" class="headerlink" title="what happen when we use stdio function"></a>what happen when we use stdio function</h2><p><img src="https://i.loli.net/2019/08/07/xjKJEV9PaF84Qui.png" srcset="/img/loading.gif" lazyload alt="image.png"><br><img src="https://i.loli.net/2019/08/07/4sy1F2oGAUxW6ZD.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="overwrite-the-file-struction"><a href="#overwrite-the-file-struction" class="headerlink" title="overwrite the file struction"></a>overwrite the file struction</h2><ul>
<li>File struction<ul>
<li>A complex struction<ul>
<li>Flags</li>
<li>Stream buffer</li>
<li>File descriptor</li>
</ul>
</li>
<li>FILE_PUTS<ul>
<li>virtul function table</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>结构体在我之前的文章有写,师傅们可以看之前的文章即可</p>
<h3 id="flags"><a href="#flags" class="headerlink" title="flags"></a>flags</h3><ul>
<li>Record the attribute of the File stream</li>
<li>Read only</li>
<li>Append</li>
</ul>
<p><img src="https://i.loli.net/2019/08/07/O75gzbIBTGLK8Yl.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="Stream-buffer"><a href="#Stream-buffer" class="headerlink" title="Stream buffer"></a>Stream buffer</h3><ul>
<li>Read buffer</li>
<li>Write buffer</li>
<li>Reserve buffer</li>
</ul>
<p><img src="https://i.loli.net/2019/08/07/32ZeYbLCdlJzjax.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="fileno"><a href="#fileno" class="headerlink" title="_fileno"></a>_fileno</h3><ul>
<li>File descriptor</li>
<li>Return by sys_open<br><img src="https://i.loli.net/2019/08/07/bk1qERm2nGzaFNI.png" srcset="/img/loading.gif" lazyload alt="image.png"></li>
</ul>
<h3 id="file-plus"><a href="#file-plus" class="headerlink" title="file_plus"></a>file_plus</h3><ul>
<li>stdin&#x2F;stdout&#x2F;stderr</li>
<li>fopen also use it</li>
<li>Extra Virtul function table<ul>
<li>Any operation on file is via vtable</li>
</ul>
</li>
</ul>
<p><img src="https://i.loli.net/2019/08/07/tU6yW5QRbPdKsNn.png" srcset="/img/loading.gif" lazyload alt="image.png"><br><img src="https://i.loli.net/2019/08/07/t1KYJGDBiyMOQhf.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="chain"><a href="#chain" class="headerlink" title="chain"></a>chain</h3><p>Every FILE associate with a _chain (linked  list)<br><img src="https://i.loli.net/2019/08/07/UyCLlYm2tPbQjpg.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="fopen-workflow"><a href="#fopen-workflow" class="headerlink" title="fopen workflow"></a>fopen workflow</h2><ul>
<li>Allocate FILE Structure</li>
<li>initial the FILE structure<ul>
<li>Link the FILE structure</li>
</ul>
</li>
<li>open file</li>
</ul>
<p><img src="https://i.loli.net/2019/08/07/yxjl74P2MNkhSVD.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="allocate-file-structure"><a href="#allocate-file-structure" class="headerlink" title="allocate file structure"></a>allocate file structure</h3><p><img src="https://i.loli.net/2019/08/07/u5Iy7XortxjRhYK.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="initial-the-file-structure"><a href="#initial-the-file-structure" class="headerlink" title="initial the file structure"></a>initial the file structure</h3><p><img src="https://i.loli.net/2019/08/07/AvKskPraWXNJ3Cw.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="Link-the-file-structure"><a href="#Link-the-file-structure" class="headerlink" title="Link the file structure"></a>Link the file structure</h3><p><img src="https://i.loli.net/2019/08/07/RBt8D1ZYbwxeJCE.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="open-file"><a href="#open-file" class="headerlink" title="open file"></a>open file</h3><p><img src="https://i.loli.net/2019/08/07/53khYwPgHvEsZWx.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="fread-workflow"><a href="#fread-workflow" class="headerlink" title="fread workflow"></a>fread workflow</h2><ul>
<li>IF stream buffer is NULL<ul>
<li>Allocate buffer</li>
</ul>
</li>
<li>Read data to the stream buffer</li>
<li>copy data from stream buffer to destination</li>
</ul>
<p><img src="https://i.loli.net/2019/08/07/1D9xyrliMAhOSj8.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="If-stream-buffer-is-NULL"><a href="#If-stream-buffer-is-NULL" class="headerlink" title="If stream buffer is NULL"></a>If stream buffer is NULL</h3><p>allocate buffer</p>
<p><img src="https://i.loli.net/2019/08/07/kMBhoFKVpRijl92.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="read-data-to-the-stream-buffer"><a href="#read-data-to-the-stream-buffer" class="headerlink" title="read data to the stream buffer"></a>read data to the stream buffer</h3><p><img src="https://i.loli.net/2019/08/07/UiAoXSF6rMnHfuN.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="copy-data-from-stream-buffer-to-destination"><a href="#copy-data-from-stream-buffer-to-destination" class="headerlink" title="copy data from stream buffer to destination"></a>copy data from stream buffer to destination</h3><p><img src="https://i.loli.net/2019/08/07/9uls5ZRUtEHnVAX.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2019/08/07/7oUra8bXzAjHLOi.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="if-the-stream-is-filled-or-flush-the-stream"><a href="#if-the-stream-is-filled-or-flush-the-stream" class="headerlink" title="if the stream is filled or flush the stream"></a>if the stream is filled or flush the stream</h3><ul>
<li>write data from stream buffer to the file</li>
</ul>
<p><img src="https://i.loli.net/2019/08/07/ujZDyNGsdBk6PIn.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="fclose-workflow"><a href="#fclose-workflow" class="headerlink" title="fclose workflow"></a>fclose workflow</h2><ul>
<li>If stream buffer is NULL<ul>
<li>allocte buffer</li>
</ul>
</li>
<li>copy user data to the stream buffer </li>
<li>if the steram buffer if filled or flush the stream<ul>
<li>write data from stream buffer to the file</li>
</ul>
</li>
</ul>
<p><img src="https://i.loli.net/2019/08/07/pEnGT8V2ifCBzON.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<ul>
<li>unlink the file structure</li>
<li>flush &amp; realease the strean buffer</li>
<li>close the file</li>
<li>release the file structure</li>
</ul>
<p><img src="https://i.loli.net/2019/08/07/ZtecGMz2EKBkLQa.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="Exploitation-of-FILE-structure"><a href="#Exploitation-of-FILE-structure" class="headerlink" title="Exploitation of FILE structure"></a>Exploitation of FILE structure</h1><p>There are a good target in FILE structure</p>
<p>Virtual function table</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">struct</span> _IO_FILE_plus<br>&#123;<br>    _IO_FILE <span class="hljs-keyword">file</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> _IO_jump_t *vtable;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="let’s-overwrite-with-buffer-address"><a href="#let’s-overwrite-with-buffer-address" class="headerlink" title="let’s overwrite with buffer address"></a>let’s overwrite with buffer address</h2><p><img src="https://i.loli.net/2019/08/07/lGe673jmzYFWO8w.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2019/08/07/kKSwbXWsZFyI165.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2019/08/07/JVNY5PLUwKTjHRZ.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="Not-call-vtable-directly"><a href="#Not-call-vtable-directly" class="headerlink" title="Not call vtable directly"></a>Not call vtable directly</h3><ul>
<li>RDX is our input but not call instruction</li>
</ul>
<p><img src="https://i.loli.net/2019/08/07/FV1G5i4pWrcIPk8.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="Let’s-see-what-happened-in-fclose"><a href="#Let’s-see-what-happened-in-fclose" class="headerlink" title="Let’s see what happened in fclose"></a>Let’s see what happened in fclose</h3><ul>
<li>we can get information of segfault in gdb and located it in source code</li>
</ul>
<p><img src="https://i.loli.net/2019/08/07/lUTnZMRCksQ8VGh.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="File-structure"><a href="#File-structure" class="headerlink" title="File structure"></a>File structure</h2><ul>
<li>_lock</li>
<li>prevent race condition in multithread</li>
<li>Very common in stdio related function</li>
<li>Usually need to construct it for Exploitaion</li>
</ul>
<p><img src="https://i.loli.net/2019/08/07/9c6X5mUiuENepBD.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="Let’s-fix-the-lock"><a href="#Let’s-fix-the-lock" class="headerlink" title="Let’s fix the lock"></a>Let’s fix the lock</h2><p><img src="https://i.loli.net/2019/08/09/8ok7EwOfJN245lg.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="we-control-PC"><a href="#we-control-PC" class="headerlink" title="we control PC"></a>we control PC</h2><p><img src="https://i.loli.net/2019/08/09/nXIPZNF4MzR6uGl.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="Another-interesting"><a href="#Another-interesting" class="headerlink" title="Another interesting"></a>Another interesting</h2><ul>
<li>stdin&#x2F;stdout&#x2F;stderr is also a FILE struct in glibc</li>
<li>We can overwrite the global variable in glibc varible in glibc to control the flow</li>
</ul>
<p><img src="https://i.loli.net/2019/08/09/kdny7QpgD4P6xXI.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP"></a>FSOP</h1><ul>
<li>File-Stream Oriented Programing <ul>
<li>Control the linked list of File stream <ul>
<li>_chain </li>
<li>_IO_list_all</li>
</ul>
</li>
<li>Powerful function <ul>
<li>_IO_ﬂush_all_lockp</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="IO-ﬂush-all-lockp"><a href="#IO-ﬂush-all-lockp" class="headerlink" title="_IO_ﬂush_all_lockp"></a>_IO_ﬂush_all_lockp</h2><ul>
<li>flush all file stream</li>
</ul>
<h3 id="We-can-call-it"><a href="#We-can-call-it" class="headerlink" title="We can call it"></a>We can call it</h3><ul>
<li>glibc abort routine</li>
<li>exit function</li>
<li>Main return</li>
</ul>
<p><img src="https://i.loli.net/2019/08/09/93OQdt7aJiBPIjp.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<ul>
<li>It will process all FILE in FILE linked list </li>
<li>We can construct the linked list to do oriented programing</li>
</ul>
<p><img src="https://i.loli.net/2019/08/09/sUuC5cmb4ISfGwy.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="FILE-stream-oriented-programing"><a href="#FILE-stream-oriented-programing" class="headerlink" title="FILE-stream oriented programing"></a>FILE-stream oriented programing</h2><p><img src="https://i.loli.net/2019/08/09/kGxe5zBsM1WrtZD.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2019/08/09/YbSMlH3whjtdUfn.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2019/08/09/VjUcAIbMvC7rhi1.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2019/08/09/YRzkZwgjHDcNnGq.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2019/08/09/2DnsHeMBrxUyK8i.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2019/08/09/aqiNzluRvOKrIfg.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>The we will ge shell!</p>
<h1 id="Vtable-verfication-in-FILE-structure"><a href="#Vtable-verfication-in-FILE-structure" class="headerlink" title="Vtable verfication in FILE structure"></a>Vtable verfication in FILE structure</h1><ul>
<li>Unfortunately, there are a virtual function table in latest libc </li>
<li>Check the address of vtable before all virtual function call </li>
<li>If vtable is invalid, it would abort</li>
</ul>
<h2 id="Vtable-veriﬁcation"><a href="#Vtable-veriﬁcation" class="headerlink" title="Vtable veriﬁcation"></a>Vtable veriﬁcation</h2><ul>
<li>Vtable veriﬁcation in File</li>
<li>The vtable must be in libc _IO_vtable section</li>
<li>If it’s not in _IO_vtable section, it will check if the vtable are permitted</li>
</ul>
<p><img src="https://i.loli.net/2019/08/09/wbptVNGjaOqIQxY.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="IO-vtable-check"><a href="#IO-vtable-check" class="headerlink" title="_IO_vtable_check"></a>_IO_vtable_check</h2><ul>
<li>Check the foreign vtables Vtable veriﬁcation<br><img src="https://i.loli.net/2019/08/09/82D6kyg7JljaYHV.png" srcset="/img/loading.gif" lazyload alt="image.png"></li>
</ul>
<h2 id="BPASS"><a href="#BPASS" class="headerlink" title="BPASS"></a>BPASS</h2><ul>
<li>Overwrite IO_accept_foreign_vtables ?</li>
<li>It’s very diﬃcult because of the pointer guard</li>
</ul>
<p><img src="https://i.loli.net/2019/08/09/84nHBUZ63qbIwO2.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<ul>
<li>Overwrite _dl_open_hook ?</li>
<li>Sounds good, but if you can control the value, you can also control other good target</li>
</ul>
<p><img src="https://i.loli.net/2019/08/09/pcnE3VIjNQTJP6b.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="Summary-of-the-vtable-veriﬁcation"><a href="#Summary-of-the-vtable-veriﬁcation" class="headerlink" title="Summary of the vtable veriﬁcation"></a>Summary of the vtable veriﬁcation</h2><ul>
<li>It very hard to bypass it</li>
<li>Exploitation of FILE structure is died ?</li>
</ul>
<h1 id="Make-file-structure-greate-again"><a href="#Make-file-structure-greate-again" class="headerlink" title="Make file structure greate again"></a>Make file structure greate again</h1><h2 id="how-about-change-the-target-from-vtable-to-other-element"><a href="#how-about-change-the-target-from-vtable-to-other-element" class="headerlink" title="how about change  the target from vtable to other element"></a>how about change  the target from vtable to other element</h2><ul>
<li>stream buffer &amp; File Descripor</li>
</ul>
<p><img src="https://i.loli.net/2019/08/09/EDWH5YKoTS81jXy.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<ul>
<li>If we can overwrite the FILE structure and use fread and fwrite with the FILE structure</li>
<li>We can <ul>
<li>Arbitrary memory reading </li>
<li>Arbitrary memory writing</li>
</ul>
</li>
</ul>
<h3 id="Arbitrary-memory-reading"><a href="#Arbitrary-memory-reading" class="headerlink" title="Arbitrary memory reading"></a>Arbitrary memory reading</h3><ul>
<li>fwrite<ul>
<li>Set the _ﬁleno to the ﬁle descriptor of stdout</li>
<li>Set _ﬂag &amp; ~_IO_NO_WRITES</li>
<li>Set _ﬂag |&#x3D; _IO_CURRENTLY_PUTTING </li>
<li>Set the write_base &amp; write_ptr to memory address which you want to read</li>
<li>_IO_read_end equal to _IO_write_base<br>其中:</li>
</ul>
</li>
<li>Set _ﬂag &amp;~ _IO_NO_WRITES</li>
<li>Set _ﬂag |&#x3D; _IO_CURRENTLY_PUTTING</li>
</ul>
<p><img src="https://i.loli.net/2019/08/09/YbDm4TfQgrLP7Be.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<ul>
<li>Let _IO_read_end equal to _IO_write_base</li>
<li>If it’s not, it would adjust to the current oﬀset</li>
</ul>
<p><img src="https://i.loli.net/2019/08/09/jJownXfGrQuUYI2.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><strong>sample code</strong> </p>
<p><img src="https://i.loli.net/2019/08/09/zwK1u2Q6VGosIl7.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<ul>
<li>fread<ul>
<li>Set the _ﬁleno to ﬁle descriptor of stdin</li>
<li>Set _ﬂag &amp;~ _IO_NO_READS</li>
<li>Set read_base &amp; read_ptr to NULL</li>
<li>Set the buf_base &amp; buf_end to memory address which you want to wirte</li>
<li>buf_end - buf_base &lt; size of fread</li>
</ul>
</li>
</ul>
<p>其中:</p>
<ul>
<li>Set read_base &amp; read_ptr to NULL<br><img src="https://i.loli.net/2019/08/09/PhzIgQN6ERDcoGq.png" srcset="/img/loading.gif" lazyload alt="image.png"></li>
<li>Set _ﬂag &amp;~ _IO_NO_READS<br><img src="https://puui.qpic.cn/fans_admin/0/3_155518641_1565412684323/0" srcset="/img/loading.gif" lazyload alt="image.png"></li>
</ul>
<p><strong>sample code</strong><br><img src="https://puui.qpic.cn/fans_admin/0/3_1565779192_1565412774359/0" srcset="/img/loading.gif" lazyload alt="ima.png"></p>
<ul>
<li><p>If you have arbitrary memory address read and write, you can control the ﬂow very easy</p>
<ul>
<li>GOT hijack</li>
<li>_<em>malloc_hook</em>&#x2F;_<em>free_hook</em>&#x2F;_<em>realloc_hook</em></li>
<li>…</li>
</ul>
</li>
<li><p>By the way, you can not only use fread and fwrite but also use any stdio related function</p>
</li>
<li><p>If we don’t have any ﬁle operation in the program,We can use:</p>
<ul>
<li>stdin&#x2F;stdout&#x2F;stderr</li>
<li>put&#x2F;printf&#x2F;scanf</li>
<li>…</li>
</ul>
</li>
<li><p>Scenario</p>
<ul>
<li>use any stdin related  function <ul>
<li>scanf&#x2F;fgets&#x2F;gets</li>
</ul>
</li>
<li>Stdin in unbuffer<ul>
<li>very  common in normal stdio program</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://puui.qpic.cn/fans_admin/0/3_1757851795_1565413454773/0" srcset="/img/loading.gif" lazyload alt="i.png"></p>
<ul>
<li>Overwrite buf_end with a pointer behind the stdin<ul>
<li>Unsorted bin attack</li>
<li>Very common in heap exploitation</li>
</ul>
</li>
</ul>
<p><img src="https://puui.qpic.cn/fans_admin/0/3_1757851795_1565413538597/0" srcset="/img/loading.gif" lazyload alt="i.png"></p>
<p><img src="https://puui.qpic.cn/fans_admin/0/3_1565779192_1565413567143/0" srcset="/img/loading.gif" lazyload alt="q.png"></p>
<ul>
<li>stdin relatedd function<ul>
<li>scanf(“%d”,&amp;var)<ul>
<li>It will call<ul>
<li>read(0,buf_base,sizeof(stdin buffer))</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://puui.qpic.cn/fans_admin/0/3_155518641_1565413709350/0" srcset="/img/loading.gif" lazyload alt="r.png">  </p>
<ul>
<li>It can overwrite many global variable in glibc </li>
<li>Input :aaa…</li>
</ul>
<p><img src="https://puui.qpic.cn/fans_admin/0/3_1757851795_1565413798496/0" srcset="/img/loading.gif" lazyload alt="q.png"></p>
<p><strong>Control The PC</strong></p>
<ul>
<li>How about Windows ?<ul>
<li>No vtable in FILE</li>
<li>It also has stream buﬀer pointer <ul>
<li>You can corrupt it to achieve arbitrary memory read and write</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><ul>
<li><p>FILE structure is a good target for binary exploit </p>
<ul>
<li>It can be used to <ul>
<li>Arbitrary memory read and write </li>
<li>Control the PC and do oriented programing </li>
<li>Other exploit technology </li>
<li>Arbitrary free&#x2F;unmmap</li>
</ul>
</li>
<li>It’s very powerful in some unexploitable case</li>
<li>Let’s try to ﬁnd more and more exploit technology in FILE structure!</li>
</ul>
<p>  over~</p>
</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>play withe file structure(搬运)</div>
      <div>https://nightrainy.github.io/2019/08/07/play-withe-file-structure-搬运/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>知世</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2019年8月7日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
                  <span class="hint--top hint--rounded" aria-label="NC - 非商业性使用">
                    <i class="iconfont icon-cc-nc"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
                  <span class="hint--top hint--rounded" aria-label="ND - 禁止演绎">
                    <i class="iconfont icon-cc-nd"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2019/10/31/play-with-docker/" title="play_with_docker">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">play_with_docker</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2019/08/06/gitlab%E8%B8%A9%E5%9D%91/" title="&#39;gitlab踩坑&#39;">
                        <span class="hidden-mobile">&#39;gitlab踩坑&#39;</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
